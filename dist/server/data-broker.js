"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.QDataBroker = void 0;

var _arangojs = require("arangojs");

class DataCache {
  async get(key) {
    return null;
  }

  async set(key, value) {}

}

class InMemoryCache extends DataCache {
  constructor() {
    super();
    this.items = new Map();
  }

  async get(key) {
    return this.items.get(key);
  }

  async set(key, value) {
    this.items.set(key, value);
  }

}

class QDataBroker {
  constructor(config) {}

  async query(params) {
    const queryDb = db => {
      return db.query(params.text, params.vars);
    };

    const queryHot = async () => {
      return queryDb(this.hot);
    };

    const queryCold = async () => {
      if (this.cold.length === 0) {
        return [];
      }

      const key = JSON.stringify({
        text: params.text,
        vars: params.vars,
        orderBy: params.orderBy
      });
      let docs = await this.cache.get(key);

      if (isNullOrUndefined(docs)) {
        const results = await Promise.all(this.cold.map(queryDb));
        docs = combineResults(results);
        await this.cache.set(key, docs);
      }

      return docs;
    };

    const results = await Promise.all([queryHot(), queryCold()]);
    return combineResults(results);
  }

}

exports.QDataBroker = QDataBroker;

function combineResults(results, orderBy) {
  const docs = collectDistinctDocs(results);
  docs.sort((a, b) => compareDocs(a, b, orderBy));
  return docs;
}

function collectDistinctDocs(source) {
  const distinctDocs = [];
  const distinctKeys = new Set();
  source.forEach(docs => {
    docs.forEach(doc => {
      if (!distinctKeys.has(doc._key)) {
        distinctDocs.push(doc);
        distinctKeys.add(doc._key);
      }
    });
  });
  return distinctDocs;
}

function compareDocs(a, b, orderBy) {
  for (let i = 0; i < orderBy.length; i += 1) {
    const field = orderBy[i];
    const path = field.path.split('.');
    const aValue = getValue(a, path, 0);
    const bValue = getValue(a, path, 0);
    let comparison = compareValues(aValue, bValue);

    if (comparison !== 0) {
      return field.direction === 'DESC' ? -comparison : comparison;
    }
  }

  return 0;
}

function getValue(value, path, pathIndex) {
  if (isNullOrUndefined(value) || pathIndex >= path.length) {
    return value;
  }

  return getValue(value[path[pathIndex]], path, pathIndex + 1);
}

function compareValues(a, b) {
  const aHasValue = !isNullOrUndefined(a);
  const bHasValue = !isNullOrUndefined(b);

  if (!aHasValue) {
    return bHasValue ? -1 : 0;
  }

  if (!bHasValue) {
    return 1;
  }

  return a === b ? 0 : a < b ? -1 : 0;
}

function isNullOrUndefined(v) {
  return v === null || typeof v === 'undefined';
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9kYXRhLWJyb2tlci5qcyJdLCJuYW1lcyI6WyJEYXRhQ2FjaGUiLCJnZXQiLCJrZXkiLCJzZXQiLCJ2YWx1ZSIsIkluTWVtb3J5Q2FjaGUiLCJjb25zdHJ1Y3RvciIsIml0ZW1zIiwiTWFwIiwiUURhdGFCcm9rZXIiLCJjb25maWciLCJxdWVyeSIsInBhcmFtcyIsInF1ZXJ5RGIiLCJkYiIsInRleHQiLCJ2YXJzIiwicXVlcnlIb3QiLCJob3QiLCJxdWVyeUNvbGQiLCJjb2xkIiwibGVuZ3RoIiwiSlNPTiIsInN0cmluZ2lmeSIsIm9yZGVyQnkiLCJkb2NzIiwiY2FjaGUiLCJpc051bGxPclVuZGVmaW5lZCIsInJlc3VsdHMiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwiY29tYmluZVJlc3VsdHMiLCJjb2xsZWN0RGlzdGluY3REb2NzIiwic29ydCIsImEiLCJiIiwiY29tcGFyZURvY3MiLCJzb3VyY2UiLCJkaXN0aW5jdERvY3MiLCJkaXN0aW5jdEtleXMiLCJTZXQiLCJmb3JFYWNoIiwiZG9jIiwiaGFzIiwiX2tleSIsInB1c2giLCJhZGQiLCJpIiwiZmllbGQiLCJwYXRoIiwic3BsaXQiLCJhVmFsdWUiLCJnZXRWYWx1ZSIsImJWYWx1ZSIsImNvbXBhcmlzb24iLCJjb21wYXJlVmFsdWVzIiwiZGlyZWN0aW9uIiwicGF0aEluZGV4IiwiYUhhc1ZhbHVlIiwiYkhhc1ZhbHVlIiwidiJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUlBLE1BQU1BLFNBQU4sQ0FBZ0I7QUFDWixRQUFNQyxHQUFOLENBQVVDLEdBQVYsRUFBcUM7QUFDakMsV0FBTyxJQUFQO0FBQ0g7O0FBRUQsUUFBTUMsR0FBTixDQUFVRCxHQUFWLEVBQXVCRSxLQUF2QixFQUFrRCxDQUNqRDs7QUFOVzs7QUFTaEIsTUFBTUMsYUFBTixTQUE0QkwsU0FBNUIsQ0FBc0M7QUFHbENNLEVBQUFBLFdBQVcsR0FBRztBQUNWO0FBQ0EsU0FBS0MsS0FBTCxHQUFhLElBQUlD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QUFDOEMsSUFBSSxDQUFDUSxTQUFELENBQUwsQ0FBTixFQUF5QlIsSUFBekIsRUFBK0JRLFNBQVMsR0FBRyxDQUEzQyxDQUFmO0FBQ0g7O0FBR0QsU0FBU0YsYUFBVCxDQUF1QnJCLENBQXZCLEVBQStCQyxDQUEvQixFQUErQztBQUMzQyxRQUFNdUIsU0FBUyxHQUFHLENBQUNoQyxpQkFBaUIsQ0FBQ1EsQ0FBRCxDQUFwQztBQUNBLFFBQU15QixTQUFTLEdBQUcsQ0FBQ2pDLGlCQUFpQixDQUFDUyxDQUFELENBQXBDOztBQUNBLE1BQUksQ0FBQ3VCLFNBQUwsRUFBZ0I7QUFDWixXQUFPQyxTQUFTLEdBQUcsQ0FBQyxDQUFKLEdBQVEsQ0FBeEI7QUFDSDs7QUFDRCxNQUFJLENBQUNBLFNBQUwsRUFBZ0I7QUFDWixXQUFPLENBQVA7QUFDSDs7QUFDRCxTQUFPekIsQ0FBQyxLQUFLQyxDQUFOLEdBQVUsQ0FBVixHQUFlRCxDQUFDLEdBQUdDLENBQUosR0FBUSxDQUFDLENBQVQsR0FBYSxDQUFuQztBQUNIOztBQUdELFNBQVNULGlCQUFULENBQTJCa0MsQ0FBM0IsRUFBbUM7QUFDL0IsU0FBT0EsQ0FBQyxLQUFLLElBQU4sSUFBYyxPQUFPQSxDQUFQLEtBQWEsV0FBbEM7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERhdGFiYXNlIH0gZnJvbSAnYXJhbmdvanMnO1xuaW1wb3J0IHR5cGUgeyBRRGF0YUNvbmZpZyB9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCB0eXBlIHsgT3JkZXJCeSB9IGZyb20gJy4vZGItdHlwZXMnO1xuXG5jbGFzcyBEYXRhQ2FjaGUge1xuICAgIGFzeW5jIGdldChrZXk6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGFzeW5jIHNldChrZXk6IHN0cmluZywgdmFsdWU6IGFueSk6IFByb21pc2U8dm9pZD4ge1xuICAgIH1cbn1cblxuY2xhc3MgSW5NZW1vcnlDYWNoZSBleHRlbmRzIERhdGFDYWNoZSB7XG4gICAgaXRlbXM6IE1hcDxzdHJpbmcsIGFueT47XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5pdGVtcyA9IG5ldyBNYXAoKTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXQoa2V5OiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5pdGVtcy5nZXQoa2V5KTtcbiAgICB9XG5cbiAgICBhc3luYyBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgdGhpcy5pdGVtcy5zZXQoa2V5LCB2YWx1ZSk7XG4gICAgfVxufVxuXG5leHBvcnQgdHlwZSBEYXRhUXVlcnlQYXJhbXMgPSB7XG4gICAgdGV4dDogc3RyaW5nO1xuICAgIHZhcnM6IHsgW3N0cmluZ106IGFueSB9O1xuICAgIG9yZGVyQnk6IE9yZGVyQnlbXTtcbn1cblxudHlwZSBEb2MgPSB7XG4gICAgX2tleTogc3RyaW5nO1xuICAgIFtzdHJpbmddOiBhbnk7XG59O1xuXG5leHBvcnQgY2xhc3MgUURhdGFCcm9rZXIge1xuICAgIGNvbGQ6IERhdGFiYXNlW107XG4gICAgaG90OiBEYXRhYmFzZTtcbiAgICBjYWNoZTogRGF0YUNhY2hlO1xuXG4gICAgY29uc3RydWN0b3IoY29uZmlnOiBRRGF0YUNvbmZpZykge1xuXG4gICAgfVxuXG4gICAgYXN5bmMgcXVlcnkocGFyYW1zOiBEYXRhUXVlcnlQYXJhbXMpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCBxdWVyeURiID0gKGRiOiBEYXRhYmFzZSk6IFByb21pc2U8RG9jPiA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZGIucXVlcnkocGFyYW1zLnRleHQsIHBhcmFtcy52YXJzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHF1ZXJ5SG90ID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHF1ZXJ5RGIodGhpcy5ob3QpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcXVlcnlDb2xkID0gYXN5bmMgKCk6IFByb21pc2U8RG9jW10+ID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLmNvbGQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3Qga2V5ID0gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICAgIHRleHQ6IHBhcmFtcy50ZXh0LFxuICAgICAgICAgICAgICAgIHZhcnM6IHBhcmFtcy52YXJzLFxuICAgICAgICAgICAgICAgIG9yZGVyQnk6IHBhcmFtcy5vcmRlckJ5LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBsZXQgZG9jcyA9IGF3YWl0IHRoaXMuY2FjaGUuZ2V0KGtleSk7XG4gICAgICAgICAgICBpZiAoaXNOdWxsT3JVbmRlZmluZWQoZG9jcykpIHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwodGhpcy5jb2xkLm1hcChxdWVyeURiKSk7XG4gICAgICAgICAgICAgICAgZG9jcyA9IGNvbWJpbmVSZXN1bHRzKHJlc3VsdHMpO1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuY2FjaGUuc2V0KGtleSwgZG9jcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZG9jcztcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChbcXVlcnlIb3QoKSwgcXVlcnlDb2xkKCldKTtcbiAgICAgICAgcmV0dXJuIGNvbWJpbmVSZXN1bHRzKHJlc3VsdHMpO1xuICAgIH1cblxufVxuXG5cbmZ1bmN0aW9uIGNvbWJpbmVSZXN1bHRzKHJlc3VsdHM6IGFueVtdW10sIG9yZGVyQnk6IE9yZGVyQnlbXSk6IGFueVtdIHtcbiAgICBjb25zdCBkb2NzID0gY29sbGVjdERpc3RpbmN0RG9jcyhyZXN1bHRzKTtcbiAgICBkb2NzLnNvcnQoKGE6IERvYywgYjogRG9jKSA9PiBjb21wYXJlRG9jcyhhLCBiLCBvcmRlckJ5KSk7XG4gICAgcmV0dXJuIGRvY3M7XG59XG5cblxuZnVuY3Rpb24gY29sbGVjdERpc3RpbmN0RG9jcyhzb3VyY2U6IERvY1tdW10pOiBEb2NbXSB7XG4gICAgY29uc3QgZGlzdGluY3REb2NzID0gKFtdOiBEb2NbXSk7XG4gICAgY29uc3QgZGlzdGluY3RLZXlzID0gbmV3IFNldCgpO1xuICAgIHNvdXJjZS5mb3JFYWNoKChkb2NzKSA9PiB7XG4gICAgICAgIGRvY3MuZm9yRWFjaCgoZG9jKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWRpc3RpbmN0S2V5cy5oYXMoZG9jLl9rZXkpKSB7XG4gICAgICAgICAgICAgICAgZGlzdGluY3REb2NzLnB1c2goZG9jKTtcbiAgICAgICAgICAgICAgICBkaXN0aW5jdEtleXMuYWRkKGRvYy5fa2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGRpc3RpbmN0RG9jcztcbn1cblxuXG5mdW5jdGlvbiBjb21wYXJlRG9jcyhhOiBEb2MsIGI6IERvYywgb3JkZXJCeTogT3JkZXJCeVtdKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvcmRlckJ5Lmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgIGNvbnN0IGZpZWxkID0gb3JkZXJCeVtpXTtcbiAgICAgICAgY29uc3QgcGF0aCA9IGZpZWxkLnBhdGguc3BsaXQoJy4nKTtcbiAgICAgICAgY29uc3QgYVZhbHVlID0gZ2V0VmFsdWUoYSwgcGF0aCwgMCk7XG4gICAgICAgIGNvbnN0IGJWYWx1ZSA9IGdldFZhbHVlKGEsIHBhdGgsIDApO1xuICAgICAgICBsZXQgY29tcGFyaXNvbiA9IGNvbXBhcmVWYWx1ZXMoYVZhbHVlLCBiVmFsdWUpO1xuICAgICAgICBpZiAoY29tcGFyaXNvbiAhPT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIGZpZWxkLmRpcmVjdGlvbiA9PT0gJ0RFU0MnID8gLWNvbXBhcmlzb24gOiBjb21wYXJpc29uO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiAwO1xufVxuXG5cbmZ1bmN0aW9uIGdldFZhbHVlKHZhbHVlOiBhbnksIHBhdGg6IHN0cmluZ1tdLCBwYXRoSW5kZXg6IG51bWJlcik6IGFueSB7XG4gICAgaWYgKGlzTnVsbE9yVW5kZWZpbmVkKHZhbHVlKSB8fCBwYXRoSW5kZXggPj0gcGF0aC5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgICByZXR1cm4gZ2V0VmFsdWUodmFsdWVbcGF0aFtwYXRoSW5kZXhdXSwgcGF0aCwgcGF0aEluZGV4ICsgMSk7XG59XG5cblxuZnVuY3Rpb24gY29tcGFyZVZhbHVlcyhhOiBhbnksIGI6IGFueSk6IG51bWJlciB7XG4gICAgY29uc3QgYUhhc1ZhbHVlID0gIWlzTnVsbE9yVW5kZWZpbmVkKGEpO1xuICAgIGNvbnN0IGJIYXNWYWx1ZSA9ICFpc051bGxPclVuZGVmaW5lZChiKTtcbiAgICBpZiAoIWFIYXNWYWx1ZSkge1xuICAgICAgICByZXR1cm4gYkhhc1ZhbHVlID8gLTEgOiAwO1xuICAgIH1cbiAgICBpZiAoIWJIYXNWYWx1ZSkge1xuICAgICAgICByZXR1cm4gMTtcbiAgICB9XG4gICAgcmV0dXJuIGEgPT09IGIgPyAwIDogKGEgPCBiID8gLTEgOiAwKTtcbn1cblxuXG5mdW5jdGlvbiBpc051bGxPclVuZGVmaW5lZCh2OiBhbnkpIHtcbiAgICByZXR1cm4gdiA9PT0gbnVsbCB8fCB0eXBlb2YgdiA9PT0gJ3VuZGVmaW5lZCc7XG59XG4iXX0=