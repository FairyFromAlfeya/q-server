"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parseOrderBy = parseOrderBy;
exports.isFastQuery = isFastQuery;

var _dbTypes = require("./db-types");

function parseOrderBy(s) {
  return s.split(',').map(x => x.trim()).filter(x => x).map(s => {
    const parts = s.split(' ').filter(x => x);
    return {
      path: parts[0],
      direction: (parts[1] || '').toLowerCase() === 'desc' ? 'DESC' : 'ASC'
    };
  });
}

function orderByToString(orderBy) {
  return orderBy.map(x => `${x.path}${(x.direction || '') === 'DESC' ? ' desc' : ''}`).join(', ');
}

function indexToString(index) {
  return index.join(', ');
}

function setIs1(s, a) {
  return s.size === 1 && s.has(a);
}

function setIs2(s, a, b) {
  return s.size === 2 && s.has(a) && s.has(b);
}

function canUseIndexedRange(ops) {
  return setIs1(ops, '==') || setIs1(ops, '!=') || setIs1(ops, '>') || setIs2(ops, '>', '<') || setIs2(ops, '>', '<=') || setIs1(ops, '>=') || setIs2(ops, '>=', '<') || setIs2(ops, '>=', '<=') || setIs1(ops, '<') || setIs1(ops, '<=');
}

function canUseConditionsForIndexedRange(fields) {
  for (const explanation of fields.values()) {
    if (!canUseIndexedRange(explanation.operations)) {
      return false;
    }
  }

  return true;
}

function fieldsCanUseIndex(fields, index) {
  if (fields.size > index.length) {
    return false;
  }

  for (let i = 0; i < fields.size; i += 1) {
    if (!fields.has(index[i])) {
      return false;
    }
  }

  return true;
}

function getUsedIndexes(fields, collection) {
  const indexes = collection.indexes.filter(x => fieldsCanUseIndex(fields, x));
  return indexes.length > 0 ? indexes : null;
}

function orderByCanUseIndex(orderBy, fields, index) {
  if (orderBy.length === 0) {
    return true;
  }

  let iOrderBy = 0;

  for (let iIndex = 0; iIndex < index.length; iIndex += 1) {
    const indexField = index[iIndex];

    if (indexField === orderBy[iOrderBy].path) {
      iOrderBy += 1;

      if (iOrderBy >= orderBy.length) {
        return true;
      }
    } else {
      if (iOrderBy > 0) {
        return false;
      }

      const field = fields.get(indexField);

      if (!field) {
        return false;
      }

      if (!setIs1(field.operations, '==')) {
        return false;
      }
    }
  }

  return true;
}

function orderByCanUseAllIndexes(orderBy, fields, indexes) {
  for (let i = 0; i < indexes.length; i += 1) {
    if (!orderByCanUseIndex(orderBy, fields, indexes[i])) {
      return false;
    }
  }

  return indexes.length > 0;
}

function orderByCanUseAnyIndex(orderBy, fields, indexes) {
  for (let i = 0; i < indexes.length; i += 1) {
    if (orderByCanUseIndex(orderBy, fields, indexes[i])) {
      return true;
    }
  }

  return false;
}

function hasKeyEq(fields) {
  const key = fields.get('_key');
  return !!(key && setIs1(key.operations, '=='));
}

function logSlowReason(message, log, filter, orderBy, fields, collection, selectedIndexes) {
  const logFields = [];

  for (const [name, explanation] of fields.entries()) {
    logFields.push(`${name} ${Array.from(explanation.operations).join(' AND ')}`);
  }

  log.debug(message, {
    collection: collection.name,
    filter,
    orderBy: orderByToString(orderBy),
    fields: logFields,
    ...(selectedIndexes ? {
      selectedIndexes: selectedIndexes.map(indexToString)
    } : {}),
    availableIndexes: collection.indexes.map(indexToString)
  });
}

function isFastQuery(collection, type, filter, orderBy, log) {
  const params = new _dbTypes.QParams({
    explain: true
  });
  type.ql(params, '', filter);

  if (!params.explanation) {
    return false;
  }

  const fields = new Map();

  for (const [field, explanation] of params.explanation.fields) {
    if (field !== 'status') {
      fields.set(field, explanation);
    }
  }

  if (hasKeyEq(fields)) {
    return true;
  }

  if (!canUseConditionsForIndexedRange(fields)) {
    if (log) {
      logSlowReason('Filter operations can\'t be used in ranged queries', log, filter, orderBy, fields, collection);
    }

    return false;
  }

  const indexes = getUsedIndexes(fields, collection);

  if (!indexes) {
    if (log) {
      logSlowReason('Available indexes can\'t be used for filter fields', log, filter, orderBy, fields, collection);
    }

    return false;
  }

  if (orderBy.length > 0) {
    if (fields.size === 0) {
      if (!orderByCanUseAnyIndex(orderBy, fields, indexes)) {
        if (log) {
          logSlowReason('Order by can\'t use any selected index', log, filter, orderBy, fields, collection, indexes);
        }

        return false;
      }
    } else {
      if (!orderByCanUseAllIndexes(orderBy, fields, indexes)) {
        if (log) {
          logSlowReason('Order by can\'t use all selected indexes', log, filter, orderBy, fields, collection, indexes);
        }

        return false;
      }
    }
  }

  return true;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9zbG93LWRldGVjdG9yLmpzIl0sIm5hbWVzIjpbInBhcnNlT3JkZXJCeSIsInMiLCJzcGxpdCIsIm1hcCIsIngiLCJ0cmltIiwiZmlsdGVyIiwicGFydHMiLCJwYXRoIiwiZGlyZWN0aW9uIiwidG9Mb3dlckNhc2UiLCJvcmRlckJ5VG9TdHJpbmciLCJvcmRlckJ5Iiwiam9pbiIsImluZGV4VG9TdHJpbmciLCJpbmRleCIsInNldElzMSIsImEiLCJzaXplIiwiaGFzIiwic2V0SXMyIiwiYiIsImNhblVzZUluZGV4ZWRSYW5nZSIsIm9wcyIsImNhblVzZUNvbmRpdGlvbnNGb3JJbmRleGVkUmFuZ2UiLCJmaWVsZHMiLCJleHBsYW5hdGlvbiIsInZhbHVlcyIsIm9wZXJhdGlvbnMiLCJmaWVsZHNDYW5Vc2VJbmRleCIsImxlbmd0aCIsImkiLCJnZXRVc2VkSW5kZXhlcyIsImNvbGxlY3Rpb24iLCJpbmRleGVzIiwib3JkZXJCeUNhblVzZUluZGV4IiwiaU9yZGVyQnkiLCJpSW5kZXgiLCJpbmRleEZpZWxkIiwiZmllbGQiLCJnZXQiLCJvcmRlckJ5Q2FuVXNlQWxsSW5kZXhlcyIsIm9yZGVyQnlDYW5Vc2VBbnlJbmRleCIsImhhc0tleUVxIiwia2V5IiwibG9nU2xvd1JlYXNvbiIsIm1lc3NhZ2UiLCJsb2ciLCJzZWxlY3RlZEluZGV4ZXMiLCJsb2dGaWVsZHMiLCJuYW1lIiwiZW50cmllcyIsInB1c2giLCJBcnJheSIsImZyb20iLCJkZWJ1ZyIsImF2YWlsYWJsZUluZGV4ZXMiLCJpc0Zhc3RRdWVyeSIsInR5cGUiLCJwYXJhbXMiLCJRUGFyYW1zIiwiZXhwbGFpbiIsInFsIiwiTWFwIiwic2V0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUlBOztBQUlPLFNBQVNBLFlBQVQsQ0FBc0JDLENBQXRCLEVBQTRDO0FBQy9DLFNBQU9BLENBQUMsQ0FBQ0MsS0FBRixDQUFRLEdBQVIsRUFDRkMsR0FERSxDQUNFQyxDQUFDLElBQUlBLENBQUMs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YjtBQUlIOztBQUNELFdBQU8sS0FBUDtBQUNIOztBQUVELE1BQUlyQixPQUFPLENBQUNrQixNQUFSLEdBQWlCLENBQXJCLEVBQXdCO0FBQ3BCLFFBQUlMLE1BQU0sQ0FBQ1AsSUFBUCxLQUFnQixDQUFwQixFQUF1QjtBQUNuQixVQUFJLENBQUN3QixxQkFBcUIsQ0FBQzlCLE9BQUQsRUFBVWEsTUFBVixFQUFrQlMsT0FBbEIsQ0FBMUIsRUFBc0Q7QUFDbEQsWUFBSWEsR0FBSixFQUFTO0FBQ0xGLFVBQUFBLGFBQWEsQ0FDVCx3Q0FEUyxFQUVURSxHQUZTLEVBRUp6QyxNQUZJLEVBRUlNLE9BRkosRUFFYWEsTUFGYixFQUVxQlEsVUFGckIsRUFFaUNDLE9BRmpDLENBQWI7QUFJSDs7QUFDRCxlQUFPLEtBQVA7QUFDSDtBQUNKLEtBVkQsTUFVTztBQUNILFVBQUksQ0FBQ08sdUJBQXVCLENBQUM3QixPQUFELEVBQVVhLE1BQVYsRUFBa0JTLE9BQWxCLENBQTVCLEVBQXdEO0FBQ3BELFlBQUlhLEdBQUosRUFBUztBQUNMRixVQUFBQSxhQUFhLENBQ1QsMENBRFMsRUFFVEUsR0FGUyxFQUVKekMsTUFGSSxFQUVJTSxPQUZKLEVBRWFhLE1BRmIsRUFFcUJRLFVBRnJCLEVBRWlDQyxPQUZqQyxDQUFiO0FBSUg7O0FBQ0QsZUFBTyxLQUFQO0FBQ0g7QUFDSjtBQUNKOztBQUVELFNBQU8sSUFBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuXG5pbXBvcnQgdHlwZSB7Q29sbGVjdGlvbkluZm99IGZyb20gXCIuL2NvbmZpZ1wiO1xuaW1wb3J0IHtRUGFyYW1zfSBmcm9tIFwiLi9kYi10eXBlc1wiO1xuaW1wb3J0IHR5cGUge09yZGVyQnksIFFGaWVsZEV4cGxhbmF0aW9uLCBRVHlwZX0gZnJvbSBcIi4vZGItdHlwZXNcIjtcbmltcG9ydCB0eXBlIHtRTG9nfSBmcm9tICcuL2xvZ3MnO1xuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VPcmRlckJ5KHM6IHN0cmluZyk6IE9yZGVyQnlbXSB7XG4gICAgcmV0dXJuIHMuc3BsaXQoJywnKVxuICAgICAgICAubWFwKHggPT4geC50cmltKCkpXG4gICAgICAgIC5maWx0ZXIoeCA9PiB4KVxuICAgICAgICAubWFwKChzKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwYXJ0cyA9IHMuc3BsaXQoJyAnKS5maWx0ZXIoeCA9PiB4KTtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgcGF0aDogcGFydHNbMF0sXG4gICAgICAgICAgICAgICAgZGlyZWN0aW9uOiAocGFydHNbMV0gfHwgJycpLnRvTG93ZXJDYXNlKCkgPT09ICdkZXNjJyA/ICdERVNDJyA6ICdBU0MnLFxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbn1cblxuZnVuY3Rpb24gb3JkZXJCeVRvU3RyaW5nKG9yZGVyQnk6IE9yZGVyQnlbXSk6IHN0cmluZyB7XG4gICAgcmV0dXJuIG9yZGVyQnkubWFwKHggPT4gYCR7eC5wYXRofSR7KHguZGlyZWN0aW9uIHx8ICcnKSA9PT0gJ0RFU0MnID8gJyBkZXNjJyA6ICcnfWApLmpvaW4oJywgJyk7XG59XG5cbmZ1bmN0aW9uIGluZGV4VG9TdHJpbmcoaW5kZXg6IHN0cmluZ1tdKTogc3RyaW5nIHtcbiAgICByZXR1cm4gaW5kZXguam9pbignLCAnKTtcbn1cblxuZnVuY3Rpb24gc2V0SXMxKHM6IFNldDxzdHJpbmc+LCBhOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gcy5zaXplID09PSAxICYmIHMuaGFzKGEpO1xufVxuXG5mdW5jdGlvbiBzZXRJczIoczogU2V0PHN0cmluZz4sIGE6IHN0cmluZywgYjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHMuc2l6ZSA9PT0gMiAmJiBzLmhhcyhhKSAmJiBzLmhhcyhiKTtcbn1cblxuZnVuY3Rpb24gY2FuVXNlSW5kZXhlZFJhbmdlKG9wczogU2V0PHN0cmluZz4pOiBib29sZWFuIHtcbiAgICByZXR1cm4gc2V0SXMxKG9wcywgJz09JylcbiAgICAgICAgfHwgc2V0SXMxKG9wcywgJyE9JylcbiAgICAgICAgfHwgc2V0SXMxKG9wcywgJz4nKVxuICAgICAgICB8fCBzZXRJczIob3BzLCAnPicsICc8JylcbiAgICAgICAgfHwgc2V0SXMyKG9wcywgJz4nLCAnPD0nKVxuICAgICAgICB8fCBzZXRJczEob3BzLCAnPj0nKVxuICAgICAgICB8fCBzZXRJczIob3BzLCAnPj0nLCAnPCcpXG4gICAgICAgIHx8IHNldElzMihvcHMsICc+PScsICc8PScpXG4gICAgICAgIHx8IHNldElzMShvcHMsICc8JylcbiAgICAgICAgfHwgc2V0SXMxKG9wcywgJzw9Jyk7XG59XG5cbmZ1bmN0aW9uIGNhblVzZUNvbmRpdGlvbnNGb3JJbmRleGVkUmFuZ2UoZmllbGRzOiBNYXA8c3RyaW5nLCBRRmllbGRFeHBsYW5hdGlvbj4pOiBib29sZWFuIHtcbiAgICBmb3IgKGNvbnN0IGV4cGxhbmF0aW9uIG9mIGZpZWxkcy52YWx1ZXMoKSkge1xuICAgICAgICBpZiAoIWNhblVzZUluZGV4ZWRSYW5nZShleHBsYW5hdGlvbi5vcGVyYXRpb25zKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xufVxuXG5mdW5jdGlvbiBmaWVsZHNDYW5Vc2VJbmRleChmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPiwgaW5kZXg6IHN0cmluZ1tdKTogYm9vbGVhbiB7XG4gICAgaWYgKGZpZWxkcy5zaXplID4gaW5kZXgubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaWVsZHMuc2l6ZTsgaSArPSAxKSB7XG4gICAgICAgIGlmICghZmllbGRzLmhhcyhpbmRleFtpXSkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbn1cblxuZnVuY3Rpb24gZ2V0VXNlZEluZGV4ZXMoZmllbGRzOiBNYXA8c3RyaW5nLCBRRmllbGRFeHBsYW5hdGlvbj4sIGNvbGxlY3Rpb246IENvbGxlY3Rpb25JbmZvKTogPyhzdHJpbmdbXVtdKSB7XG4gICAgY29uc3QgaW5kZXhlcyA9IGNvbGxlY3Rpb24uaW5kZXhlcy5maWx0ZXIoeCA9PiBmaWVsZHNDYW5Vc2VJbmRleChmaWVsZHMsIHgpKTtcbiAgICByZXR1cm4gaW5kZXhlcy5sZW5ndGggPiAwID8gaW5kZXhlcyA6IG51bGw7XG59XG5cbmZ1bmN0aW9uIG9yZGVyQnlDYW5Vc2VJbmRleChcbiAgICBvcmRlckJ5OiBPcmRlckJ5W10sXG4gICAgZmllbGRzOiBNYXA8c3RyaW5nLCBRRmllbGRFeHBsYW5hdGlvbj4sXG4gICAgaW5kZXg6IHN0cmluZ1tdLFxuKTogYm9vbGVhbiB7XG4gICAgaWYgKG9yZGVyQnkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBsZXQgaU9yZGVyQnkgPSAwO1xuICAgIGZvciAobGV0IGlJbmRleCA9IDA7IGlJbmRleCA8IGluZGV4Lmxlbmd0aDsgaUluZGV4ICs9IDEpIHtcbiAgICAgICAgY29uc3QgaW5kZXhGaWVsZCA9IGluZGV4W2lJbmRleF07XG4gICAgICAgIGlmIChpbmRleEZpZWxkID09PSBvcmRlckJ5W2lPcmRlckJ5XS5wYXRoKSB7XG4gICAgICAgICAgICBpT3JkZXJCeSArPSAxO1xuICAgICAgICAgICAgaWYgKGlPcmRlckJ5ID49IG9yZGVyQnkubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoaU9yZGVyQnkgPiAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgZmllbGQgPSBmaWVsZHMuZ2V0KGluZGV4RmllbGQpO1xuICAgICAgICAgICAgaWYgKCFmaWVsZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghc2V0SXMxKGZpZWxkLm9wZXJhdGlvbnMsICc9PScpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xufVxuXG5mdW5jdGlvbiBvcmRlckJ5Q2FuVXNlQWxsSW5kZXhlcyhcbiAgICBvcmRlckJ5OiBPcmRlckJ5W10sXG4gICAgZmllbGRzOiBNYXA8c3RyaW5nLCBRRmllbGRFeHBsYW5hdGlvbj4sXG4gICAgaW5kZXhlczogc3RyaW5nW11bXSxcbik6IGJvb2xlYW4ge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXhlcy5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICBpZiAoIW9yZGVyQnlDYW5Vc2VJbmRleChvcmRlckJ5LCBmaWVsZHMsIGluZGV4ZXNbaV0pKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGluZGV4ZXMubGVuZ3RoID4gMDtcbn1cblxuZnVuY3Rpb24gb3JkZXJCeUNhblVzZUFueUluZGV4KFxuICAgIG9yZGVyQnk6IE9yZGVyQnlbXSxcbiAgICBmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPixcbiAgICBpbmRleGVzOiBzdHJpbmdbXVtdLFxuKTogYm9vbGVhbiB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRleGVzLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgIGlmIChvcmRlckJ5Q2FuVXNlSW5kZXgob3JkZXJCeSwgZmllbGRzLCBpbmRleGVzW2ldKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuXG5mdW5jdGlvbiBoYXNLZXlFcShmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGtleSA9IGZpZWxkcy5nZXQoJ19rZXknKTtcbiAgICByZXR1cm4gISEoa2V5ICYmIHNldElzMShrZXkub3BlcmF0aW9ucywgJz09JykpO1xufVxuXG5mdW5jdGlvbiBsb2dTbG93UmVhc29uKFxuICAgIG1lc3NhZ2U6IHN0cmluZyxcbiAgICBsb2c6IFFMb2csXG4gICAgZmlsdGVyOiBhbnksXG4gICAgb3JkZXJCeTogT3JkZXJCeVtdLFxuICAgIGZpZWxkczogTWFwPHN0cmluZywgUUZpZWxkRXhwbGFuYXRpb24+LFxuICAgIGNvbGxlY3Rpb246IENvbGxlY3Rpb25JbmZvLFxuICAgIHNlbGVjdGVkSW5kZXhlcz86IHN0cmluZ1tdW10sXG4pIHtcbiAgICBjb25zdCBsb2dGaWVsZHM6IHN0cmluZ1tdID0gW107XG4gICAgZm9yIChjb25zdCBbbmFtZSwgZXhwbGFuYXRpb25dIG9mIGZpZWxkcy5lbnRyaWVzKCkpIHtcbiAgICAgICAgbG9nRmllbGRzLnB1c2goYCR7bmFtZX0gJHtBcnJheS5mcm9tKGV4cGxhbmF0aW9uLm9wZXJhdGlvbnMpLmpvaW4oJyBBTkQgJyl9YCk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhtZXNzYWdlLCB7XG4gICAgICAgIGNvbGxlY3Rpb246IGNvbGxlY3Rpb24ubmFtZSxcbiAgICAgICAgZmlsdGVyLFxuICAgICAgICBvcmRlckJ5OiBvcmRlckJ5VG9TdHJpbmcob3JkZXJCeSksXG4gICAgICAgIGZpZWxkczogbG9nRmllbGRzLFxuICAgICAgICAuLi4oc2VsZWN0ZWRJbmRleGVzID8ge3NlbGVjdGVkSW5kZXhlczogc2VsZWN0ZWRJbmRleGVzLm1hcChpbmRleFRvU3RyaW5nKX0gOiB7fSksXG4gICAgICAgIGF2YWlsYWJsZUluZGV4ZXM6IGNvbGxlY3Rpb24uaW5kZXhlcy5tYXAoaW5kZXhUb1N0cmluZyksXG4gICAgfSk7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRmFzdFF1ZXJ5KFxuICAgIGNvbGxlY3Rpb246IENvbGxlY3Rpb25JbmZvLFxuICAgIHR5cGU6IFFUeXBlLFxuICAgIGZpbHRlcjogYW55LFxuICAgIG9yZGVyQnk6IE9yZGVyQnlbXSxcbiAgICBsb2c6ID9RTG9nLFxuKTogYm9vbGVhbiB7XG4gICAgY29uc3QgcGFyYW1zID0gbmV3IFFQYXJhbXMoe1xuICAgICAgICBleHBsYWluOiB0cnVlLFxuICAgIH0pO1xuICAgIHR5cGUucWwocGFyYW1zLCAnJywgZmlsdGVyKTtcbiAgICBpZiAoIXBhcmFtcy5leHBsYW5hdGlvbikge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IGZpZWxkcyA9IG5ldyBNYXA8c3RyaW5nLCBRRmllbGRFeHBsYW5hdGlvbj4oKTtcbiAgICBmb3IgKGNvbnN0IFtmaWVsZCwgZXhwbGFuYXRpb25dIG9mIHBhcmFtcy5leHBsYW5hdGlvbi5maWVsZHMpIHtcbiAgICAgICAgaWYgKGZpZWxkICE9PSAnc3RhdHVzJykge1xuICAgICAgICAgICAgZmllbGRzLnNldChmaWVsZCwgZXhwbGFuYXRpb24pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChoYXNLZXlFcShmaWVsZHMpKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBpZiAoIWNhblVzZUNvbmRpdGlvbnNGb3JJbmRleGVkUmFuZ2UoZmllbGRzKSkge1xuICAgICAgICBpZiAobG9nKSB7XG4gICAgICAgICAgICBsb2dTbG93UmVhc29uKFxuICAgICAgICAgICAgICAgICdGaWx0ZXIgb3BlcmF0aW9ucyBjYW5cXCd0IGJlIHVzZWQgaW4gcmFuZ2VkIHF1ZXJpZXMnLFxuICAgICAgICAgICAgICAgIGxvZywgZmlsdGVyLCBvcmRlckJ5LCBmaWVsZHMsIGNvbGxlY3Rpb24sXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBpbmRleGVzID0gZ2V0VXNlZEluZGV4ZXMoZmllbGRzLCBjb2xsZWN0aW9uKTtcbiAgICBpZiAoIWluZGV4ZXMpIHtcbiAgICAgICAgaWYgKGxvZykge1xuICAgICAgICAgICAgbG9nU2xvd1JlYXNvbihcbiAgICAgICAgICAgICAgICAnQXZhaWxhYmxlIGluZGV4ZXMgY2FuXFwndCBiZSB1c2VkIGZvciBmaWx0ZXIgZmllbGRzJyxcbiAgICAgICAgICAgICAgICBsb2csIGZpbHRlciwgb3JkZXJCeSwgZmllbGRzLCBjb2xsZWN0aW9uLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKG9yZGVyQnkubGVuZ3RoID4gMCkge1xuICAgICAgICBpZiAoZmllbGRzLnNpemUgPT09IDApIHtcbiAgICAgICAgICAgIGlmICghb3JkZXJCeUNhblVzZUFueUluZGV4KG9yZGVyQnksIGZpZWxkcywgaW5kZXhlcykpIHtcbiAgICAgICAgICAgICAgICBpZiAobG9nKSB7XG4gICAgICAgICAgICAgICAgICAgIGxvZ1Nsb3dSZWFzb24oXG4gICAgICAgICAgICAgICAgICAgICAgICAnT3JkZXIgYnkgY2FuXFwndCB1c2UgYW55IHNlbGVjdGVkIGluZGV4JyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZywgZmlsdGVyLCBvcmRlckJ5LCBmaWVsZHMsIGNvbGxlY3Rpb24sIGluZGV4ZXMsXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICghb3JkZXJCeUNhblVzZUFsbEluZGV4ZXMob3JkZXJCeSwgZmllbGRzLCBpbmRleGVzKSkge1xuICAgICAgICAgICAgICAgIGlmIChsb2cpIHtcbiAgICAgICAgICAgICAgICAgICAgbG9nU2xvd1JlYXNvbihcbiAgICAgICAgICAgICAgICAgICAgICAgICdPcmRlciBieSBjYW5cXCd0IHVzZSBhbGwgc2VsZWN0ZWQgaW5kZXhlcycsXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2csIGZpbHRlciwgb3JkZXJCeSwgZmllbGRzLCBjb2xsZWN0aW9uLCBpbmRleGVzLFxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbn1cbiJdfQ==