"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.resolversMam = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _arango = _interopRequireDefault(require("./arango"));

var _arangoCollection = require("./arango-collection");

var _arangoListeners = require("./arango-listeners");

var _dbTypes = require("./db-types");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Query
function info() {
  const pkg = JSON.parse(_fs.default.readFileSync(_path.default.resolve(__dirname, '..', '..', 'package.json')));
  return {
    version: pkg.version
  };
}

function stat(_parent, args, context) {
  (0, _arangoCollection.mamAccessRequired)(context, args);

  const listenerToStat = listener => {
    return {
      filter: JSON.stringify(listener.filter),
      selection: (0, _dbTypes.selectionToString)(listener.selection),
      queueSize: 0,
      eventCount: listener.getEventCount(),
      secondsActive: (Date.now() - listener.startTime) / 1000
    };
  };

  const isSubscription = listener => {
    return listener instanceof _arangoListeners.SubscriptionListener;
  };

  const db = context.db;
  let totalWaitForCount = 0;
  let totalSubscriptionCount = 0;
  const collections = db.collections.map(collection => {
    const listeners = [...collection.listeners.values()];
    const waitFor = listeners.filter(x => !isSubscription(x));
    const subscriptions = listeners.filter(isSubscription);
    totalWaitForCount += waitFor.length;
    totalSubscriptionCount += subscriptions.length;
    return {
      name: collection.name,
      subscriptionCount: subscriptions.length,
      waitForCount: waitFor.length,
      maxQueueSize: collection.maxQueueSize,
      subscriptions: subscriptions.map(listenerToStat),
      waitFor: waitFor.map(listenerToStat)
    };
  });
  return {
    waitForCount: totalWaitForCount,
    subscriptionCount: totalSubscriptionCount,
    collections
  };
}

async function getCollections(_parent, args, context) {
  (0, _arangoCollection.mamAccessRequired)(context, args);
  const db = context.db;
  const collections = [];

  for (const collection of db.collections) {
    const indexes = [];
    const dbCollection = collection.dbCollection();

    for (const index of await dbCollection.indexes()) {
      indexes.push(index.fields.join(', '));
    }

    collections.push({
      name: collection.name,
      count: (await dbCollection.count()).count,
      indexes
    });
  }

  return collections;
} // Mutation


const resolversMam = {
  Query: {
    info,
    getCollections,
    stat
  }
};
exports.resolversMam = resolversMam;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9yZXNvbHZlcnMtbWFtLmpzIl0sIm5hbWVzIjpbImluZm8iLCJwa2ciLCJKU09OIiwicGFyc2UiLCJmcyIsInJlYWRGaWxlU3luYyIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwidmVyc2lvbiIsInN0YXQiLCJfcGFyZW50IiwiYXJncyIsImNvbnRleHQiLCJsaXN0ZW5lclRvU3RhdCIsImxpc3RlbmVyIiwiZmlsdGVyIiwic3RyaW5naWZ5Iiwic2VsZWN0aW9uIiwicXVldWVTaXplIiwiZXZlbnRDb3VudCIsImdldEV2ZW50Q291bnQiLCJzZWNvbmRzQWN0aXZlIiwiRGF0ZSIsIm5vdyIsInN0YXJ0VGltZSIsImlzU3Vic2NyaXB0aW9uIiwiU3Vic2NyaXB0aW9uTGlzdGVuZXIiLCJkYiIsInRvdGFsV2FpdEZvckNvdW50IiwidG90YWxTdWJzY3JpcHRpb25Db3VudCIsImNvbGxlY3Rpb25zIiwibWFwIiwiY29sbGVjdGlvbiIsImxpc3RlbmVycyIsInZhbHVlcyIsIndhaXRGb3IiLCJ4Iiwic3Vic2NyaXB0aW9ucyIsImxlbmd0aCIsIm5hbWUiLCJzdWJzY3JpcHRpb25Db3VudCIsIndhaXRGb3JDb3VudCIsIm1heFF1ZXVlU2l6ZSIsImdldENvbGxlY3Rpb25zIiwiaW5kZXhlcyIsImRiQ29sbGVjdGlvbiIsImluZGV4IiwicHVzaCIsImZpZWxkcyIsImpvaW4iLCJjb3VudCIsInJlc29sdmVyc01hbSIsIlF1ZXJ5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFrQ0E7QUFFQSxTQUFTQSxJQUFULEdBQXNCO0FBQ2xCLFFBQU1DLEdBQUcsR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVlDLFlBQUdDLFlBQUgsQ0FBZ0JDLGNBQUtDLE9BQUwsQ0FBYUMsU0FBYixFQUF3QixJQUF4QixFQUE4QixJQUE5QixFQUFvQyxjQUFwQyxDQUFoQixDQUFaLENBQVo7QUFD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QUFDRyxJQUFSLENBQWFELEtBQUssQ0FBQ0UsTUFBTixDQUFhQyxJQUFiLENBQWtCLElBQWxCLENBQWI7QUFDSDs7QUFDRG5CLElBQUFBLFdBQVcsQ0FBQ2lCLElBQVosQ0FBaUI7QUFDYlIsTUFBQUEsSUFBSSxFQUFFUCxVQUFVLENBQUNPLElBREo7QUFFYlcsTUFBQUEsS0FBSyxFQUFFLENBQUMsTUFBTUwsWUFBWSxDQUFDSyxLQUFiLEVBQVAsRUFBNkJBLEtBRnZCO0FBR2JOLE1BQUFBO0FBSGEsS0FBakI7QUFLSDs7QUFDRCxTQUFPZCxXQUFQO0FBQ0gsQyxDQUVEOzs7QUFFTyxNQUFNcUIsWUFBWSxHQUFHO0FBQ3hCQyxFQUFBQSxLQUFLLEVBQUU7QUFDSHJELElBQUFBLElBREc7QUFFSDRDLElBQUFBLGNBRkc7QUFHSGxDLElBQUFBO0FBSEc7QUFEaUIsQ0FBckIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBBcmFuZ28gZnJvbSBcIi4vYXJhbmdvXCI7XG5pbXBvcnQgeyBDb2xsZWN0aW9uLCBtYW1BY2Nlc3NSZXF1aXJlZCB9IGZyb20gXCIuL2FyYW5nby1jb2xsZWN0aW9uXCI7XG5pbXBvcnQgeyBDb2xsZWN0aW9uTGlzdGVuZXIsIFN1YnNjcmlwdGlvbkxpc3RlbmVyIH0gZnJvbSBcIi4vYXJhbmdvLWxpc3RlbmVyc1wiO1xuaW1wb3J0IHsgc2VsZWN0aW9uVG9TdHJpbmcgfSBmcm9tIFwiLi9kYi10eXBlc1wiO1xuaW1wb3J0IHR5cGUgeyBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCB9IGZyb20gXCIuL3Jlc29sdmVycy1jdXN0b21cIjtcblxudHlwZSBJbmZvID0ge1xuICAgIHZlcnNpb246IHN0cmluZyxcbn1cblxudHlwZSBMaXN0ZW5lclN0YXQgPSB7XG4gICAgZmlsdGVyOiBzdHJpbmcsXG4gICAgc2VsZWN0aW9uOiBzdHJpbmcsXG4gICAgcXVldWVTaXplOiBudW1iZXIsXG4gICAgZXZlbnRDb3VudDogbnVtYmVyLFxuICAgIHNlY29uZHNBY3RpdmU6IG51bWJlcixcbn1cblxudHlwZSBDb2xsZWN0aW9uU3RhdCA9IHtcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgc3Vic2NyaXB0aW9uQ291bnQ6IG51bWJlcixcbiAgICB3YWl0Rm9yQ291bnQ6IG51bWJlcixcbiAgICBtYXhRdWV1ZVNpemU6IG51bWJlcixcbiAgICBzdWJzY3JpcHRpb25zOiBMaXN0ZW5lclN0YXRbXSxcbiAgICB3YWl0Rm9yOiBMaXN0ZW5lclN0YXRbXSxcbn1cblxudHlwZSBTdGF0ID0ge1xuICAgIGNvbGxlY3Rpb25zOiBDb2xsZWN0aW9uU3RhdFtdXG59XG5cbnR5cGUgQ29sbGVjdGlvblN1bW1hcnkgPSB7XG4gICAgbmFtZTogc3RyaW5nLFxuICAgIGNvdW50OiBudW1iZXIsXG4gICAgaW5kZXhlczogc3RyaW5nW10sXG59XG5cbi8vIFF1ZXJ5XG5cbmZ1bmN0aW9uIGluZm8oKTogSW5mbyB7XG4gICAgY29uc3QgcGtnID0gSlNPTi5wYXJzZSgoZnMucmVhZEZpbGVTeW5jKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdwYWNrYWdlLmpzb24nKSk6IGFueSkpO1xuICAgIHJldHVybiB7XG4gICAgICAgIHZlcnNpb246IHBrZy52ZXJzaW9uLFxuICAgIH07XG59XG5cbmZ1bmN0aW9uIHN0YXQoX3BhcmVudDogYW55LCBhcmdzOiBhbnksIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4KTogU3RhdCB7XG4gICAgbWFtQWNjZXNzUmVxdWlyZWQoY29udGV4dCwgYXJncyk7XG4gICAgY29uc3QgbGlzdGVuZXJUb1N0YXQgPSAobGlzdGVuZXI6IENvbGxlY3Rpb25MaXN0ZW5lciApOiBMaXN0ZW5lclN0YXQgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZmlsdGVyOiBKU09OLnN0cmluZ2lmeShsaXN0ZW5lci5maWx0ZXIpLFxuICAgICAgICAgICAgc2VsZWN0aW9uOiBzZWxlY3Rpb25Ub1N0cmluZyhsaXN0ZW5lci5zZWxlY3Rpb24pLFxuICAgICAgICAgICAgcXVldWVTaXplOiAwLFxuICAgICAgICAgICAgZXZlbnRDb3VudDogbGlzdGVuZXIuZ2V0RXZlbnRDb3VudCgpLFxuICAgICAgICAgICAgc2Vjb25kc0FjdGl2ZTogKERhdGUubm93KCkgLSBsaXN0ZW5lci5zdGFydFRpbWUpIC8gMTAwMCxcbiAgICAgICAgfTtcbiAgICB9O1xuICAgIGNvbnN0IGlzU3Vic2NyaXB0aW9uID0gKGxpc3RlbmVyOiBDb2xsZWN0aW9uTGlzdGVuZXIpOiBib29sID0+IHtcbiAgICAgICAgcmV0dXJuIGxpc3RlbmVyIGluc3RhbmNlb2YgU3Vic2NyaXB0aW9uTGlzdGVuZXI7XG4gICAgfTtcbiAgICBjb25zdCBkYjogQXJhbmdvID0gY29udGV4dC5kYjtcbiAgICBsZXQgdG90YWxXYWl0Rm9yQ291bnQgPSAwO1xuICAgIGxldCB0b3RhbFN1YnNjcmlwdGlvbkNvdW50ID0gMDtcbiAgICBjb25zdCBjb2xsZWN0aW9ucyA9IGRiLmNvbGxlY3Rpb25zLm1hcCgoY29sbGVjdGlvbjogQ29sbGVjdGlvbikgPT4ge1xuICAgICAgICBjb25zdCBsaXN0ZW5lcnMgPSBbLi4uY29sbGVjdGlvbi5saXN0ZW5lcnMudmFsdWVzKCldO1xuICAgICAgICBjb25zdCB3YWl0Rm9yID0gbGlzdGVuZXJzLmZpbHRlcih4ID0+ICFpc1N1YnNjcmlwdGlvbih4KSk7XG4gICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbnMgPSBsaXN0ZW5lcnMuZmlsdGVyKGlzU3Vic2NyaXB0aW9uKTtcbiAgICAgICAgdG90YWxXYWl0Rm9yQ291bnQgKz0gd2FpdEZvci5sZW5ndGg7XG4gICAgICAgIHRvdGFsU3Vic2NyaXB0aW9uQ291bnQgKz0gc3Vic2NyaXB0aW9ucy5sZW5ndGg7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBuYW1lOiBjb2xsZWN0aW9uLm5hbWUsXG4gICAgICAgICAgICBzdWJzY3JpcHRpb25Db3VudDogc3Vic2NyaXB0aW9ucy5sZW5ndGgsXG4gICAgICAgICAgICB3YWl0Rm9yQ291bnQ6IHdhaXRGb3IubGVuZ3RoLFxuICAgICAgICAgICAgbWF4UXVldWVTaXplOiBjb2xsZWN0aW9uLm1heFF1ZXVlU2l6ZSxcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbnM6IHN1YnNjcmlwdGlvbnMubWFwKGxpc3RlbmVyVG9TdGF0KSxcbiAgICAgICAgICAgIHdhaXRGb3I6IHdhaXRGb3IubWFwKGxpc3RlbmVyVG9TdGF0KSxcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiB7XG4gICAgICAgIHdhaXRGb3JDb3VudDogdG90YWxXYWl0Rm9yQ291bnQsXG4gICAgICAgIHN1YnNjcmlwdGlvbkNvdW50OiB0b3RhbFN1YnNjcmlwdGlvbkNvdW50LFxuICAgICAgICBjb2xsZWN0aW9ucyxcbiAgICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRDb2xsZWN0aW9ucyhfcGFyZW50OiBhbnksIGFyZ3M6IGFueSwgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgpOiBQcm9taXNlPENvbGxlY3Rpb25TdW1tYXJ5W10+IHtcbiAgICBtYW1BY2Nlc3NSZXF1aXJlZChjb250ZXh0LCBhcmdzKTtcbiAgICBjb25zdCBkYjogQXJhbmdvID0gY29udGV4dC5kYjtcbiAgICBjb25zdCBjb2xsZWN0aW9uczogQ29sbGVjdGlvblN1bW1hcnlbXSA9IFtdO1xuICAgIGZvciAoY29uc3QgY29sbGVjdGlvbiBvZiBkYi5jb2xsZWN0aW9ucykge1xuICAgICAgICBjb25zdCBpbmRleGVzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICBjb25zdCBkYkNvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLmRiQ29sbGVjdGlvbigpO1xuICAgICAgICBmb3IgKGNvbnN0IGluZGV4IG9mIGF3YWl0IGRiQ29sbGVjdGlvbi5pbmRleGVzKCkpIHtcbiAgICAgICAgICAgIGluZGV4ZXMucHVzaChpbmRleC5maWVsZHMuam9pbignLCAnKSk7XG4gICAgICAgIH1cbiAgICAgICAgY29sbGVjdGlvbnMucHVzaCh7XG4gICAgICAgICAgICBuYW1lOiBjb2xsZWN0aW9uLm5hbWUsXG4gICAgICAgICAgICBjb3VudDogKGF3YWl0IGRiQ29sbGVjdGlvbi5jb3VudCgpKS5jb3VudCxcbiAgICAgICAgICAgIGluZGV4ZXMsXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gY29sbGVjdGlvbnM7XG59XG5cbi8vIE11dGF0aW9uXG5cbmV4cG9ydCBjb25zdCByZXNvbHZlcnNNYW0gPSB7XG4gICAgUXVlcnk6IHtcbiAgICAgICAgaW5mbyxcbiAgICAgICAgZ2V0Q29sbGVjdGlvbnMsXG4gICAgICAgIHN0YXRcbiAgICB9LFxufTtcbiJdfQ==