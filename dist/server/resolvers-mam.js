"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.resolversMam = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _arango = _interopRequireDefault(require("./arango"));

var _arangoCollection = require("./arango-collection");

var _arangoListeners = require("./arango-listeners");

var _dbTypes = require("./db-types");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Query
function info() {
  const pkg = JSON.parse(_fs.default.readFileSync(_path.default.resolve(__dirname, '..', '..', 'package.json')));
  return {
    version: pkg.version
  };
}

function stat(_parent, args, context) {
  (0, _arangoCollection.mamAccessRequired)(context, args);

  const listenerToStat = listener => {
    return {
      filter: JSON.stringify(listener.filter),
      selection: (0, _dbTypes.selectionToString)(listener.selection),
      queueSize: 0,
      eventCount: listener.getEventCount(),
      secondsActive: (Date.now() - listener.startTime) / 1000
    };
  };

  const isSubscription = listener => {
    return listener instanceof _arangoListeners.SubscriptionListener;
  };

  const db = context.db;
  return {
    collections: db.collections.map(collection => {
      const listeners = [...collection.listeners.values()];
      const waitFor = listeners.filter(x => !isSubscription(x));
      const subscriptions = listeners.filter(isSubscription);
      return {
        name: collection.name,
        subscriptionCount: subscriptions.length,
        waitForCount: waitFor.length,
        maxQueueSize: collection.maxQueueSize,
        subscriptions: subscriptions.map(listenerToStat),
        waitFor: waitFor.map(listenerToStat)
      };
    })
  };
}

async function getCollections(_parent, args, context) {
  (0, _arangoCollection.mamAccessRequired)(context, args);
  const db = context.db;
  const collections = [];

  for (const collection of db.collections) {
    const indexes = [];
    const dbCollection = collection.dbCollection();

    for (const index of await dbCollection.indexes()) {
      indexes.push(index.fields.join(', '));
    }

    collections.push({
      name: collection.name,
      count: (await dbCollection.count()).count,
      indexes
    });
  }

  return collections;
} // Mutation


const resolversMam = {
  Query: {
    info,
    getCollections,
    stat
  }
};
exports.resolversMam = resolversMam;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9yZXNvbHZlcnMtbWFtLmpzIl0sIm5hbWVzIjpbImluZm8iLCJwa2ciLCJKU09OIiwicGFyc2UiLCJmcyIsInJlYWRGaWxlU3luYyIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwidmVyc2lvbiIsInN0YXQiLCJfcGFyZW50IiwiYXJncyIsImNvbnRleHQiLCJsaXN0ZW5lclRvU3RhdCIsImxpc3RlbmVyIiwiZmlsdGVyIiwic3RyaW5naWZ5Iiwic2VsZWN0aW9uIiwicXVldWVTaXplIiwiZXZlbnRDb3VudCIsImdldEV2ZW50Q291bnQiLCJzZWNvbmRzQWN0aXZlIiwiRGF0ZSIsIm5vdyIsInN0YXJ0VGltZSIsImlzU3Vic2NyaXB0aW9uIiwiU3Vic2NyaXB0aW9uTGlzdGVuZXIiLCJkYiIsImNvbGxlY3Rpb25zIiwibWFwIiwiY29sbGVjdGlvbiIsImxpc3RlbmVycyIsInZhbHVlcyIsIndhaXRGb3IiLCJ4Iiwic3Vic2NyaXB0aW9ucyIsIm5hbWUiLCJzdWJzY3JpcHRpb25Db3VudCIsImxlbmd0aCIsIndhaXRGb3JDb3VudCIsIm1heFF1ZXVlU2l6ZSIsImdldENvbGxlY3Rpb25zIiwiaW5kZXhlcyIsImRiQ29sbGVjdGlvbiIsImluZGV4IiwicHVzaCIsImZpZWxkcyIsImpvaW4iLCJjb3VudCIsInJlc29sdmVyc01hbSIsIlF1ZXJ5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFrQ0E7QUFFQSxTQUFTQSxJQUFULEdBQXNCO0FBQ2xCLFFBQU1DLEdBQUcsR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVlDLFlBQUdDLFlBQUgsQ0FBZ0JDLGNBQUtDLE9BQUwsQ0FBYUMsU0FBYixFQUF3QixJQUF4QixFQUE4QixJQUE5QixFQUFvQyxjQUFwQyxDQUFoQixDQUFaLENBQVo7QUFDQSxTQUFPO0FBQ0hDLElBQUFBLE9BQU8sRUFBRVIsR0FBRyxDQUFDUTtBQURW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O0FBRU8sTUFBTXFCLFlBQVksR0FBRztBQUN4QkMsRUFBQUEsS0FBSyxFQUFFO0FBQ0huRCxJQUFBQSxJQURHO0FBRUgwQyxJQUFBQSxjQUZHO0FBR0hoQyxJQUFBQTtBQUhHO0FBRGlCLENBQXJCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgQXJhbmdvIGZyb20gXCIuL2FyYW5nb1wiO1xuaW1wb3J0IHsgQ29sbGVjdGlvbiwgbWFtQWNjZXNzUmVxdWlyZWQgfSBmcm9tIFwiLi9hcmFuZ28tY29sbGVjdGlvblwiO1xuaW1wb3J0IHsgQ29sbGVjdGlvbkxpc3RlbmVyLCBTdWJzY3JpcHRpb25MaXN0ZW5lciB9IGZyb20gXCIuL2FyYW5nby1saXN0ZW5lcnNcIjtcbmltcG9ydCB7IHNlbGVjdGlvblRvU3RyaW5nIH0gZnJvbSBcIi4vZGItdHlwZXNcIjtcbmltcG9ydCB0eXBlIHsgR3JhcGhRTFJlcXVlc3RDb250ZXh0RXggfSBmcm9tIFwiLi9yZXNvbHZlcnMtY3VzdG9tXCI7XG5cbnR5cGUgSW5mbyA9IHtcbiAgICB2ZXJzaW9uOiBzdHJpbmcsXG59XG5cbnR5cGUgTGlzdGVuZXJTdGF0ID0ge1xuICAgIGZpbHRlcjogc3RyaW5nLFxuICAgIHNlbGVjdGlvbjogc3RyaW5nLFxuICAgIHF1ZXVlU2l6ZTogbnVtYmVyLFxuICAgIGV2ZW50Q291bnQ6IG51bWJlcixcbiAgICBzZWNvbmRzQWN0aXZlOiBudW1iZXIsXG59XG5cbnR5cGUgQ29sbGVjdGlvblN0YXQgPSB7XG4gICAgbmFtZTogc3RyaW5nLFxuICAgIHN1YnNjcmlwdGlvbkNvdW50OiBudW1iZXIsXG4gICAgd2FpdEZvckNvdW50OiBudW1iZXIsXG4gICAgbWF4UXVldWVTaXplOiBudW1iZXIsXG4gICAgc3Vic2NyaXB0aW9uczogTGlzdGVuZXJTdGF0W10sXG4gICAgd2FpdEZvcjogTGlzdGVuZXJTdGF0W10sXG59XG5cbnR5cGUgU3RhdCA9IHtcbiAgICBjb2xsZWN0aW9uczogQ29sbGVjdGlvblN0YXRbXVxufVxuXG50eXBlIENvbGxlY3Rpb25TdW1tYXJ5ID0ge1xuICAgIG5hbWU6IHN0cmluZyxcbiAgICBjb3VudDogbnVtYmVyLFxuICAgIGluZGV4ZXM6IHN0cmluZ1tdLFxufVxuXG4vLyBRdWVyeVxuXG5mdW5jdGlvbiBpbmZvKCk6IEluZm8ge1xuICAgIGNvbnN0IHBrZyA9IEpTT04ucGFyc2UoKGZzLnJlYWRGaWxlU3luYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAncGFja2FnZS5qc29uJykpOiBhbnkpKTtcbiAgICByZXR1cm4ge1xuICAgICAgICB2ZXJzaW9uOiBwa2cudmVyc2lvbixcbiAgICB9O1xufVxuXG5mdW5jdGlvbiBzdGF0KF9wYXJlbnQ6IGFueSwgYXJnczogYW55LCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCk6IFN0YXQge1xuICAgIG1hbUFjY2Vzc1JlcXVpcmVkKGNvbnRleHQsIGFyZ3MpO1xuICAgIGNvbnN0IGxpc3RlbmVyVG9TdGF0ID0gKGxpc3RlbmVyOiBDb2xsZWN0aW9uTGlzdGVuZXIgKTogTGlzdGVuZXJTdGF0ID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGZpbHRlcjogSlNPTi5zdHJpbmdpZnkobGlzdGVuZXIuZmlsdGVyKSxcbiAgICAgICAgICAgIHNlbGVjdGlvbjogc2VsZWN0aW9uVG9TdHJpbmcobGlzdGVuZXIuc2VsZWN0aW9uKSxcbiAgICAgICAgICAgIHF1ZXVlU2l6ZTogMCxcbiAgICAgICAgICAgIGV2ZW50Q291bnQ6IGxpc3RlbmVyLmdldEV2ZW50Q291bnQoKSxcbiAgICAgICAgICAgIHNlY29uZHNBY3RpdmU6IChEYXRlLm5vdygpIC0gbGlzdGVuZXIuc3RhcnRUaW1lKSAvIDEwMDAsXG4gICAgICAgIH07XG4gICAgfTtcbiAgICBjb25zdCBpc1N1YnNjcmlwdGlvbiA9IChsaXN0ZW5lcjogQ29sbGVjdGlvbkxpc3RlbmVyKTogYm9vbCA9PiB7XG4gICAgICAgIHJldHVybiBsaXN0ZW5lciBpbnN0YW5jZW9mIFN1YnNjcmlwdGlvbkxpc3RlbmVyO1xuICAgIH07XG4gICAgY29uc3QgZGI6IEFyYW5nbyA9IGNvbnRleHQuZGI7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgY29sbGVjdGlvbnM6IGRiLmNvbGxlY3Rpb25zLm1hcCgoY29sbGVjdGlvbjogQ29sbGVjdGlvbikgPT4ge1xuICAgICAgICAgICAgY29uc3QgbGlzdGVuZXJzID0gWy4uLmNvbGxlY3Rpb24ubGlzdGVuZXJzLnZhbHVlcygpXTtcbiAgICAgICAgICAgIGNvbnN0IHdhaXRGb3IgPSBsaXN0ZW5lcnMuZmlsdGVyKHggPT4gIWlzU3Vic2NyaXB0aW9uKHgpKTtcbiAgICAgICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbnMgPSBsaXN0ZW5lcnMuZmlsdGVyKGlzU3Vic2NyaXB0aW9uKTtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgbmFtZTogY29sbGVjdGlvbi5uYW1lLFxuICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvdW50OiBzdWJzY3JpcHRpb25zLmxlbmd0aCxcbiAgICAgICAgICAgICAgICB3YWl0Rm9yQ291bnQ6IHdhaXRGb3IubGVuZ3RoLFxuICAgICAgICAgICAgICAgIG1heFF1ZXVlU2l6ZTogY29sbGVjdGlvbi5tYXhRdWV1ZVNpemUsXG4gICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uczogc3Vic2NyaXB0aW9ucy5tYXAobGlzdGVuZXJUb1N0YXQpLFxuICAgICAgICAgICAgICAgIHdhaXRGb3I6IHdhaXRGb3IubWFwKGxpc3RlbmVyVG9TdGF0KSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRDb2xsZWN0aW9ucyhfcGFyZW50OiBhbnksIGFyZ3M6IGFueSwgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgpOiBQcm9taXNlPENvbGxlY3Rpb25TdW1tYXJ5W10+IHtcbiAgICBtYW1BY2Nlc3NSZXF1aXJlZChjb250ZXh0LCBhcmdzKTtcbiAgICBjb25zdCBkYjogQXJhbmdvID0gY29udGV4dC5kYjtcbiAgICBjb25zdCBjb2xsZWN0aW9uczogQ29sbGVjdGlvblN1bW1hcnlbXSA9IFtdO1xuICAgIGZvciAoY29uc3QgY29sbGVjdGlvbiBvZiBkYi5jb2xsZWN0aW9ucykge1xuICAgICAgICBjb25zdCBpbmRleGVzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICBjb25zdCBkYkNvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLmRiQ29sbGVjdGlvbigpO1xuICAgICAgICBmb3IgKGNvbnN0IGluZGV4IG9mIGF3YWl0IGRiQ29sbGVjdGlvbi5pbmRleGVzKCkpIHtcbiAgICAgICAgICAgIGluZGV4ZXMucHVzaChpbmRleC5maWVsZHMuam9pbignLCAnKSk7XG4gICAgICAgIH1cbiAgICAgICAgY29sbGVjdGlvbnMucHVzaCh7XG4gICAgICAgICAgICBuYW1lOiBjb2xsZWN0aW9uLm5hbWUsXG4gICAgICAgICAgICBjb3VudDogKGF3YWl0IGRiQ29sbGVjdGlvbi5jb3VudCgpKS5jb3VudCxcbiAgICAgICAgICAgIGluZGV4ZXMsXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gY29sbGVjdGlvbnM7XG59XG5cbi8vIE11dGF0aW9uXG5cbmV4cG9ydCBjb25zdCByZXNvbHZlcnNNYW0gPSB7XG4gICAgUXVlcnk6IHtcbiAgICAgICAgaW5mbyxcbiAgICAgICAgZ2V0Q29sbGVjdGlvbnMsXG4gICAgICAgIHN0YXRcbiAgICB9LFxufTtcbiJdfQ==