"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.resolversMam = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _arango = _interopRequireDefault(require("./arango"));

var _arangoCollection = require("./arango-collection");

var _arangoListeners = require("./arango-listeners");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Query
function info() {
  const pkg = JSON.parse(_fs.default.readFileSync(_path.default.resolve(__dirname, '..', '..', 'package.json')));
  return {
    version: pkg.version
  };
}

function stat(_parent, _args, context) {
  const listenerToStat = listener => {
    return {
      filter: JSON.stringify(listener.filter),
      selection: (0, _utils.selectionToString)(listener.selection),
      queueSize: 0,
      eventCount: listener.getEventCount(),
      secondsActive: (Date.now() - listener.startTime) / 1000
    };
  };

  const isSubscription = listener => {
    return listener instanceof _arangoListeners.SubscriptionListener;
  };

  const db = context.db;
  return {
    collections: db.collections.map(collection => {
      const listeners = [...collection.listeners.values()];
      const waitFor = listeners.filter(x => !isSubscription(x));
      const subscriptions = listeners.filter(isSubscription);
      return {
        name: collection.name,
        subscriptionCount: subscriptions.length,
        waitForCount: waitFor.length,
        maxQueueSize: collection.maxQueueSize,
        subscriptions: subscriptions.map(listenerToStat),
        waitFor: waitFor.map(listenerToStat)
      };
    })
  };
}

async function getCollections(_parent, _args, context) {
  const db = context.db;
  const collections = [];

  for (const collection of db.collections) {
    const indexes = [];
    const dbCollection = collection.dbCollection();

    for (const index of await dbCollection.indexes()) {
      indexes.push(index.fields.join(', '));
    }

    collections.push({
      collection: collection.name,
      count: (await dbCollection.count()).count,
      indexes
    });
  }

  return collections;
} // Mutation


const resolversMam = {
  Query: {
    info,
    getCollections,
    stat
  },
  Mutation: {}
};
exports.resolversMam = resolversMam;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9yZXNvbHZlcnMtbWFtLmpzIl0sIm5hbWVzIjpbImluZm8iLCJwa2ciLCJKU09OIiwicGFyc2UiLCJmcyIsInJlYWRGaWxlU3luYyIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwidmVyc2lvbiIsInN0YXQiLCJfcGFyZW50IiwiX2FyZ3MiLCJjb250ZXh0IiwibGlzdGVuZXJUb1N0YXQiLCJsaXN0ZW5lciIsImZpbHRlciIsInN0cmluZ2lmeSIsInNlbGVjdGlvbiIsInF1ZXVlU2l6ZSIsImV2ZW50Q291bnQiLCJnZXRFdmVudENvdW50Iiwic2Vjb25kc0FjdGl2ZSIsIkRhdGUiLCJub3ciLCJzdGFydFRpbWUiLCJpc1N1YnNjcmlwdGlvbiIsIlN1YnNjcmlwdGlvbkxpc3RlbmVyIiwiZGIiLCJjb2xsZWN0aW9ucyIsIm1hcCIsImNvbGxlY3Rpb24iLCJsaXN0ZW5lcnMiLCJ2YWx1ZXMiLCJ3YWl0Rm9yIiwieCIsInN1YnNjcmlwdGlvbnMiLCJuYW1lIiwic3Vic2NyaXB0aW9uQ291bnQiLCJsZW5ndGgiLCJ3YWl0Rm9yQ291bnQiLCJtYXhRdWV1ZVNpemUiLCJnZXRDb2xsZWN0aW9ucyIsImluZGV4ZXMiLCJkYkNvbGxlY3Rpb24iLCJpbmRleCIsInB1c2giLCJmaWVsZHMiLCJqb2luIiwiY291bnQiLCJyZXNvbHZlcnNNYW0iLCJRdWVyeSIsIk11dGF0aW9uIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7QUF1Q0E7QUFFQSxTQUFTQSxJQUFULEdBQXNCO0FBQ2xCLFFBQU1DLEdBQUcsR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVlDLFlBQUdDLFlBQUgsQ0FBZ0JDLGNBQUtDLE9BQUwsQ0FBYUMsU0FBYixFQUF3QixJQUF4QixFQUE4QixJQUE5QixFQUFvQyxjQUFwQyxDQUFoQixDQUFaLENBQVo7QUFDQSxTQUFPO0FBQ0hDLElBQUFBLE9BQU8sRUFBRVIsR0FB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QUFBQSxJQURHO0FBRUgwQyxJQUFBQSxjQUZHO0FBR0hoQyxJQUFBQTtBQUhHLEdBRGlCO0FBTXhCMEMsRUFBQUEsUUFBUSxFQUFFO0FBTmMsQ0FBckIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBBcmFuZ28gZnJvbSBcIi4vYXJhbmdvXCI7XG5pbXBvcnQgeyBDb2xsZWN0aW9ufSBmcm9tIFwiLi9hcmFuZ28tY29sbGVjdGlvblwiO1xuaW1wb3J0IHsgQ29sbGVjdGlvbkxpc3RlbmVyLCBTdWJzY3JpcHRpb25MaXN0ZW5lciB9IGZyb20gXCIuL2FyYW5nby1saXN0ZW5lcnNcIjtcbmltcG9ydCB0eXBlIHsgUUNvbmZpZyB9IGZyb20gXCIuL2NvbmZpZ1wiO1xuaW1wb3J0IHsgc2VsZWN0aW9uVG9TdHJpbmcgfSBmcm9tIFwiLi91dGlsc1wiO1xuXG50eXBlIENvbnRleHQgPSB7XG4gICAgZGI6IEFyYW5nbyxcbiAgICBjb25maWc6IFFDb25maWcsXG4gICAgc2hhcmVkOiBNYXA8c3RyaW5nLCBhbnk+LFxufVxuXG50eXBlIEluZm8gPSB7XG4gICAgdmVyc2lvbjogc3RyaW5nLFxufVxuXG50eXBlIExpc3RlbmVyU3RhdCA9IHtcbiAgICBmaWx0ZXI6IHN0cmluZyxcbiAgICBzZWxlY3Rpb246IHN0cmluZyxcbiAgICBxdWV1ZVNpemU6IG51bWJlcixcbiAgICBldmVudENvdW50OiBudW1iZXIsXG4gICAgc2Vjb25kc0FjdGl2ZTogbnVtYmVyLFxufVxuXG50eXBlIENvbGxlY3Rpb25TdGF0ID0ge1xuICAgIG5hbWU6IHN0cmluZyxcbiAgICBzdWJzY3JpcHRpb25Db3VudDogbnVtYmVyLFxuICAgIHdhaXRGb3JDb3VudDogbnVtYmVyLFxuICAgIG1heFF1ZXVlU2l6ZTogbnVtYmVyLFxuICAgIHN1YnNjcmlwdGlvbnM6IExpc3RlbmVyU3RhdFtdLFxuICAgIHdhaXRGb3I6IExpc3RlbmVyU3RhdFtdLFxufVxuXG50eXBlIFN0YXQgPSB7XG4gICAgY29sbGVjdGlvbnM6IENvbGxlY3Rpb25TdGF0W11cbn1cblxudHlwZSBDb2xsZWN0aW9uU3VtbWFyeSA9IHtcbiAgICBjb2xsZWN0aW9uOiBzdHJpbmcsXG4gICAgY291bnQ6IG51bWJlcixcbiAgICBpbmRleGVzOiBzdHJpbmdbXSxcbn1cblxuLy8gUXVlcnlcblxuZnVuY3Rpb24gaW5mbygpOiBJbmZvIHtcbiAgICBjb25zdCBwa2cgPSBKU09OLnBhcnNlKChmcy5yZWFkRmlsZVN5bmMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ3BhY2thZ2UuanNvbicpKTogYW55KSk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgdmVyc2lvbjogcGtnLnZlcnNpb24sXG4gICAgfTtcbn1cblxuZnVuY3Rpb24gc3RhdChfcGFyZW50OiBhbnksIF9hcmdzOiBhbnksIGNvbnRleHQ6IENvbnRleHQpOiBTdGF0IHtcbiAgICBjb25zdCBsaXN0ZW5lclRvU3RhdCA9IChsaXN0ZW5lcjogQ29sbGVjdGlvbkxpc3RlbmVyICk6IExpc3RlbmVyU3RhdCA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBmaWx0ZXI6IEpTT04uc3RyaW5naWZ5KGxpc3RlbmVyLmZpbHRlciksXG4gICAgICAgICAgICBzZWxlY3Rpb246IHNlbGVjdGlvblRvU3RyaW5nKGxpc3RlbmVyLnNlbGVjdGlvbiksXG4gICAgICAgICAgICBxdWV1ZVNpemU6IDAsXG4gICAgICAgICAgICBldmVudENvdW50OiBsaXN0ZW5lci5nZXRFdmVudENvdW50KCksXG4gICAgICAgICAgICBzZWNvbmRzQWN0aXZlOiAoRGF0ZS5ub3coKSAtIGxpc3RlbmVyLnN0YXJ0VGltZSkgLyAxMDAwLFxuICAgICAgICB9O1xuICAgIH07XG4gICAgY29uc3QgaXNTdWJzY3JpcHRpb24gPSAobGlzdGVuZXI6IENvbGxlY3Rpb25MaXN0ZW5lcik6IGJvb2wgPT4ge1xuICAgICAgICByZXR1cm4gbGlzdGVuZXIgaW5zdGFuY2VvZiBTdWJzY3JpcHRpb25MaXN0ZW5lcjtcbiAgICB9O1xuICAgIGNvbnN0IGRiOiBBcmFuZ28gPSBjb250ZXh0LmRiO1xuICAgIHJldHVybiB7XG4gICAgICAgIGNvbGxlY3Rpb25zOiBkYi5jb2xsZWN0aW9ucy5tYXAoKGNvbGxlY3Rpb246IENvbGxlY3Rpb24pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGxpc3RlbmVycyA9IFsuLi5jb2xsZWN0aW9uLmxpc3RlbmVycy52YWx1ZXMoKV07XG4gICAgICAgICAgICBjb25zdCB3YWl0Rm9yID0gbGlzdGVuZXJzLmZpbHRlcih4ID0+ICFpc1N1YnNjcmlwdGlvbih4KSk7XG4gICAgICAgICAgICBjb25zdCBzdWJzY3JpcHRpb25zID0gbGlzdGVuZXJzLmZpbHRlcihpc1N1YnNjcmlwdGlvbik7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIG5hbWU6IGNvbGxlY3Rpb24ubmFtZSxcbiAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25Db3VudDogc3Vic2NyaXB0aW9ucy5sZW5ndGgsXG4gICAgICAgICAgICAgICAgd2FpdEZvckNvdW50OiB3YWl0Rm9yLmxlbmd0aCxcbiAgICAgICAgICAgICAgICBtYXhRdWV1ZVNpemU6IGNvbGxlY3Rpb24ubWF4UXVldWVTaXplLFxuICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbnM6IHN1YnNjcmlwdGlvbnMubWFwKGxpc3RlbmVyVG9TdGF0KSxcbiAgICAgICAgICAgICAgICB3YWl0Rm9yOiB3YWl0Rm9yLm1hcChsaXN0ZW5lclRvU3RhdCksXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0Q29sbGVjdGlvbnMoX3BhcmVudDogYW55LCBfYXJnczogYW55LCBjb250ZXh0OiBDb250ZXh0KTogUHJvbWlzZTxDb2xsZWN0aW9uU3VtbWFyeVtdPiB7XG4gICAgY29uc3QgZGI6IEFyYW5nbyA9IGNvbnRleHQuZGI7XG4gICAgY29uc3QgY29sbGVjdGlvbnM6IENvbGxlY3Rpb25TdW1tYXJ5W10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IGNvbGxlY3Rpb24gb2YgZGIuY29sbGVjdGlvbnMpIHtcbiAgICAgICAgY29uc3QgaW5kZXhlczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgY29uc3QgZGJDb2xsZWN0aW9uID0gY29sbGVjdGlvbi5kYkNvbGxlY3Rpb24oKTtcbiAgICAgICAgZm9yIChjb25zdCBpbmRleCBvZiBhd2FpdCBkYkNvbGxlY3Rpb24uaW5kZXhlcygpKSB7XG4gICAgICAgICAgICBpbmRleGVzLnB1c2goaW5kZXguZmllbGRzLmpvaW4oJywgJykpO1xuICAgICAgICB9XG4gICAgICAgIGNvbGxlY3Rpb25zLnB1c2goe1xuICAgICAgICAgICAgY29sbGVjdGlvbjogY29sbGVjdGlvbi5uYW1lLFxuICAgICAgICAgICAgY291bnQ6IChhd2FpdCBkYkNvbGxlY3Rpb24uY291bnQoKSkuY291bnQsXG4gICAgICAgICAgICBpbmRleGVzLFxuICAgICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbGxlY3Rpb25zO1xufVxuXG4vLyBNdXRhdGlvblxuXG5leHBvcnQgY29uc3QgcmVzb2x2ZXJzTWFtID0ge1xuICAgIFF1ZXJ5OiB7XG4gICAgICAgIGluZm8sXG4gICAgICAgIGdldENvbGxlY3Rpb25zLFxuICAgICAgICBzdGF0XG4gICAgfSxcbiAgICBNdXRhdGlvbjoge1xuICAgIH0sXG59O1xuIl19