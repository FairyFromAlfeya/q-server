"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.resolversMam = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _arango = _interopRequireDefault(require("./arango"));

var _arangoCollection = require("./arango-collection");

var _arangoListeners = require("./arango-listeners");

var _auth = require("./auth");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Query
function info() {
  const pkg = JSON.parse(_fs.default.readFileSync(_path.default.resolve(__dirname, '..', '..', 'package.json')));
  return {
    version: pkg.version
  };
}

function checkMamAccess(args, context) {
  const accessKey = args.accessKey;

  if (!accessKey || !context.config.mamAccessKeys.has(accessKey)) {
    throw _auth.Auth.unauthorizedError();
  }
}

function stat(_parent, args, context) {
  checkMamAccess(args, context);

  const listenerToStat = listener => {
    return {
      filter: JSON.stringify(listener.filter),
      selection: (0, _utils.selectionToString)(listener.selection),
      queueSize: 0,
      eventCount: listener.getEventCount(),
      secondsActive: (Date.now() - listener.startTime) / 1000
    };
  };

  const isSubscription = listener => {
    return listener instanceof _arangoListeners.SubscriptionListener;
  };

  const db = context.db;
  return {
    collections: db.collections.map(collection => {
      const listeners = [...collection.listeners.values()];
      const waitFor = listeners.filter(x => !isSubscription(x));
      const subscriptions = listeners.filter(isSubscription);
      return {
        name: collection.name,
        subscriptionCount: subscriptions.length,
        waitForCount: waitFor.length,
        maxQueueSize: collection.maxQueueSize,
        subscriptions: subscriptions.map(listenerToStat),
        waitFor: waitFor.map(listenerToStat)
      };
    })
  };
}

async function getCollections(_parent, args, context) {
  checkMamAccess(args, context);
  const db = context.db;
  const collections = [];

  for (const collection of db.collections) {
    const indexes = [];
    const dbCollection = collection.dbCollection();

    for (const index of await dbCollection.indexes()) {
      indexes.push(index.fields.join(', '));
    }

    collections.push({
      name: collection.name,
      count: (await dbCollection.count()).count,
      indexes
    });
  }

  return collections;
} // Mutation


const resolversMam = {
  Query: {
    info,
    getCollections,
    stat
  }
};
exports.resolversMam = resolversMam;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9yZXNvbHZlcnMtbWFtLmpzIl0sIm5hbWVzIjpbImluZm8iLCJwa2ciLCJKU09OIiwicGFyc2UiLCJmcyIsInJlYWRGaWxlU3luYyIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwidmVyc2lvbiIsImNoZWNrTWFtQWNjZXNzIiwiYXJncyIsImNvbnRleHQiLCJhY2Nlc3NLZXkiLCJjb25maWciLCJtYW1BY2Nlc3NLZXlzIiwiaGFzIiwiQXV0aCIsInVuYXV0aG9yaXplZEVycm9yIiwic3RhdCIsIl9wYXJlbnQiLCJsaXN0ZW5lclRvU3RhdCIsImxpc3RlbmVyIiwiZmlsdGVyIiwic3RyaW5naWZ5Iiwic2VsZWN0aW9uIiwicXVldWVTaXplIiwiZXZlbnRDb3VudCIsImdldEV2ZW50Q291bnQiLCJzZWNvbmRzQWN0aXZlIiwiRGF0ZSIsIm5vdyIsInN0YXJ0VGltZSIsImlzU3Vic2NyaXB0aW9uIiwiU3Vic2NyaXB0aW9uTGlzdGVuZXIiLCJkYiIsImNvbGxlY3Rpb25zIiwibWFwIiwiY29sbGVjdGlvbiIsImxpc3RlbmVycyIsInZhbHVlcyIsIndhaXRGb3IiLCJ4Iiwic3Vic2NyaXB0aW9ucyIsIm5hbWUiLCJzdWJzY3JpcHRpb25Db3VudCIsImxlbmd0aCIsIndhaXRGb3JDb3VudCIsIm1heFF1ZXVlU2l6ZSIsImdldENvbGxlY3Rpb25zIiwiaW5kZXhlcyIsImRiQ29sbGVjdGlvbiIsImluZGV4IiwicHVzaCIsImZpZWxkcyIsImpvaW4iLCJjb3VudCIsInJlc29sdmVyc01hbSIsIlF1ZXJ5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7QUF1Q0E7QUFFQSxTQUFTQSxJQUFULEdBQXNCO0FBQ2xCLFFBQU1DLEdBQUcsR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVlDLFlBQUdDLFlBQUgsQ0FBZ0JDLGNBQUtDLE9BQUwsQ0FBYUMsU0FBYixFQUF3QixJ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Qjs7QUFDQSxTQUFLLE1BQU1DLEtBQVgsSUFBb0IsTUFBTUQsWUFBWSxDQUFDRCxPQUFiLEVBQTFCLEVBQWtEO0FBQzlDQSxNQUFBQSxPQUFPLENBQUNHLElBQVIsQ0FBYUQsS0FBSyxDQUFDRSxNQUFOLENBQWFDLElBQWIsQ0FBa0IsSUFBbEIsQ0FBYjtBQUNIOztBQUNEbkIsSUFBQUEsV0FBVyxDQUFDaUIsSUFBWixDQUFpQjtBQUNiVCxNQUFBQSxJQUFJLEVBQUVOLFVBQVUsQ0FBQ00sSUFESjtBQUViWSxNQUFBQSxLQUFLLEVBQUUsQ0FBQyxNQUFNTCxZQUFZLENBQUNLLEtBQWIsRUFBUCxFQUE2QkEsS0FGdkI7QUFHYk4sTUFBQUE7QUFIYSxLQUFqQjtBQUtIOztBQUNELFNBQU9kLFdBQVA7QUFDSCxDLENBRUQ7OztBQUVPLE1BQU1xQixZQUFZLEdBQUc7QUFDeEJDLEVBQUFBLEtBQUssRUFBRTtBQUNIMUQsSUFBQUEsSUFERztBQUVIaUQsSUFBQUEsY0FGRztBQUdIOUIsSUFBQUE7QUFIRztBQURpQixDQUFyQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCBmcyBmcm9tIFwiZnNcIjtcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IEFyYW5nbyBmcm9tIFwiLi9hcmFuZ29cIjtcbmltcG9ydCB7IENvbGxlY3Rpb259IGZyb20gXCIuL2FyYW5nby1jb2xsZWN0aW9uXCI7XG5pbXBvcnQgeyBDb2xsZWN0aW9uTGlzdGVuZXIsIFN1YnNjcmlwdGlvbkxpc3RlbmVyIH0gZnJvbSBcIi4vYXJhbmdvLWxpc3RlbmVyc1wiO1xuaW1wb3J0IHsgQXV0aCB9IGZyb20gXCIuL2F1dGhcIjtcbmltcG9ydCB0eXBlIHsgUUNvbmZpZyB9IGZyb20gXCIuL2NvbmZpZ1wiO1xuaW1wb3J0IHsgc2VsZWN0aW9uVG9TdHJpbmcgfSBmcm9tIFwiLi91dGlsc1wiO1xuXG50eXBlIENvbnRleHQgPSB7XG4gICAgZGI6IEFyYW5nbyxcbiAgICBjb25maWc6IFFDb25maWcsXG4gICAgc2hhcmVkOiBNYXA8c3RyaW5nLCBhbnk+LFxufVxuXG50eXBlIEluZm8gPSB7XG4gICAgdmVyc2lvbjogc3RyaW5nLFxufVxuXG50eXBlIExpc3RlbmVyU3RhdCA9IHtcbiAgICBmaWx0ZXI6IHN0cmluZyxcbiAgICBzZWxlY3Rpb246IHN0cmluZyxcbiAgICBxdWV1ZVNpemU6IG51bWJlcixcbiAgICBldmVudENvdW50OiBudW1iZXIsXG4gICAgc2Vjb25kc0FjdGl2ZTogbnVtYmVyLFxufVxuXG50eXBlIENvbGxlY3Rpb25TdGF0ID0ge1xuICAgIG5hbWU6IHN0cmluZyxcbiAgICBzdWJzY3JpcHRpb25Db3VudDogbnVtYmVyLFxuICAgIHdhaXRGb3JDb3VudDogbnVtYmVyLFxuICAgIG1heFF1ZXVlU2l6ZTogbnVtYmVyLFxuICAgIHN1YnNjcmlwdGlvbnM6IExpc3RlbmVyU3RhdFtdLFxuICAgIHdhaXRGb3I6IExpc3RlbmVyU3RhdFtdLFxufVxuXG50eXBlIFN0YXQgPSB7XG4gICAgY29sbGVjdGlvbnM6IENvbGxlY3Rpb25TdGF0W11cbn1cblxudHlwZSBDb2xsZWN0aW9uU3VtbWFyeSA9IHtcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgY291bnQ6IG51bWJlcixcbiAgICBpbmRleGVzOiBzdHJpbmdbXSxcbn1cblxuLy8gUXVlcnlcblxuZnVuY3Rpb24gaW5mbygpOiBJbmZvIHtcbiAgICBjb25zdCBwa2cgPSBKU09OLnBhcnNlKChmcy5yZWFkRmlsZVN5bmMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ3BhY2thZ2UuanNvbicpKTogYW55KSk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgdmVyc2lvbjogcGtnLnZlcnNpb24sXG4gICAgfTtcbn1cblxuZnVuY3Rpb24gY2hlY2tNYW1BY2Nlc3MoYXJnczogYW55LCBjb250ZXh0OiBDb250ZXh0KSB7XG4gICAgY29uc3QgYWNjZXNzS2V5ID0gYXJncy5hY2Nlc3NLZXk7XG4gICAgaWYgKCFhY2Nlc3NLZXkgfHwgIWNvbnRleHQuY29uZmlnLm1hbUFjY2Vzc0tleXMuaGFzKGFjY2Vzc0tleSkpIHtcbiAgICAgICAgdGhyb3cgQXV0aC51bmF1dGhvcml6ZWRFcnJvcigpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gc3RhdChfcGFyZW50OiBhbnksIGFyZ3M6IGFueSwgY29udGV4dDogQ29udGV4dCk6IFN0YXQge1xuICAgIGNoZWNrTWFtQWNjZXNzKGFyZ3MsIGNvbnRleHQpO1xuICAgIGNvbnN0IGxpc3RlbmVyVG9TdGF0ID0gKGxpc3RlbmVyOiBDb2xsZWN0aW9uTGlzdGVuZXIgKTogTGlzdGVuZXJTdGF0ID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGZpbHRlcjogSlNPTi5zdHJpbmdpZnkobGlzdGVuZXIuZmlsdGVyKSxcbiAgICAgICAgICAgIHNlbGVjdGlvbjogc2VsZWN0aW9uVG9TdHJpbmcobGlzdGVuZXIuc2VsZWN0aW9uKSxcbiAgICAgICAgICAgIHF1ZXVlU2l6ZTogMCxcbiAgICAgICAgICAgIGV2ZW50Q291bnQ6IGxpc3RlbmVyLmdldEV2ZW50Q291bnQoKSxcbiAgICAgICAgICAgIHNlY29uZHNBY3RpdmU6IChEYXRlLm5vdygpIC0gbGlzdGVuZXIuc3RhcnRUaW1lKSAvIDEwMDAsXG4gICAgICAgIH07XG4gICAgfTtcbiAgICBjb25zdCBpc1N1YnNjcmlwdGlvbiA9IChsaXN0ZW5lcjogQ29sbGVjdGlvbkxpc3RlbmVyKTogYm9vbCA9PiB7XG4gICAgICAgIHJldHVybiBsaXN0ZW5lciBpbnN0YW5jZW9mIFN1YnNjcmlwdGlvbkxpc3RlbmVyO1xuICAgIH07XG4gICAgY29uc3QgZGI6IEFyYW5nbyA9IGNvbnRleHQuZGI7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgY29sbGVjdGlvbnM6IGRiLmNvbGxlY3Rpb25zLm1hcCgoY29sbGVjdGlvbjogQ29sbGVjdGlvbikgPT4ge1xuICAgICAgICAgICAgY29uc3QgbGlzdGVuZXJzID0gWy4uLmNvbGxlY3Rpb24ubGlzdGVuZXJzLnZhbHVlcygpXTtcbiAgICAgICAgICAgIGNvbnN0IHdhaXRGb3IgPSBsaXN0ZW5lcnMuZmlsdGVyKHggPT4gIWlzU3Vic2NyaXB0aW9uKHgpKTtcbiAgICAgICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbnMgPSBsaXN0ZW5lcnMuZmlsdGVyKGlzU3Vic2NyaXB0aW9uKTtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgbmFtZTogY29sbGVjdGlvbi5uYW1lLFxuICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvdW50OiBzdWJzY3JpcHRpb25zLmxlbmd0aCxcbiAgICAgICAgICAgICAgICB3YWl0Rm9yQ291bnQ6IHdhaXRGb3IubGVuZ3RoLFxuICAgICAgICAgICAgICAgIG1heFF1ZXVlU2l6ZTogY29sbGVjdGlvbi5tYXhRdWV1ZVNpemUsXG4gICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uczogc3Vic2NyaXB0aW9ucy5tYXAobGlzdGVuZXJUb1N0YXQpLFxuICAgICAgICAgICAgICAgIHdhaXRGb3I6IHdhaXRGb3IubWFwKGxpc3RlbmVyVG9TdGF0KSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRDb2xsZWN0aW9ucyhfcGFyZW50OiBhbnksIGFyZ3M6IGFueSwgY29udGV4dDogQ29udGV4dCk6IFByb21pc2U8Q29sbGVjdGlvblN1bW1hcnlbXT4ge1xuICAgIGNoZWNrTWFtQWNjZXNzKGFyZ3MsIGNvbnRleHQpO1xuICAgIGNvbnN0IGRiOiBBcmFuZ28gPSBjb250ZXh0LmRiO1xuICAgIGNvbnN0IGNvbGxlY3Rpb25zOiBDb2xsZWN0aW9uU3VtbWFyeVtdID0gW107XG4gICAgZm9yIChjb25zdCBjb2xsZWN0aW9uIG9mIGRiLmNvbGxlY3Rpb25zKSB7XG4gICAgICAgIGNvbnN0IGluZGV4ZXM6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGNvbnN0IGRiQ29sbGVjdGlvbiA9IGNvbGxlY3Rpb24uZGJDb2xsZWN0aW9uKCk7XG4gICAgICAgIGZvciAoY29uc3QgaW5kZXggb2YgYXdhaXQgZGJDb2xsZWN0aW9uLmluZGV4ZXMoKSkge1xuICAgICAgICAgICAgaW5kZXhlcy5wdXNoKGluZGV4LmZpZWxkcy5qb2luKCcsICcpKTtcbiAgICAgICAgfVxuICAgICAgICBjb2xsZWN0aW9ucy5wdXNoKHtcbiAgICAgICAgICAgIG5hbWU6IGNvbGxlY3Rpb24ubmFtZSxcbiAgICAgICAgICAgIGNvdW50OiAoYXdhaXQgZGJDb2xsZWN0aW9uLmNvdW50KCkpLmNvdW50LFxuICAgICAgICAgICAgaW5kZXhlcyxcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBjb2xsZWN0aW9ucztcbn1cblxuLy8gTXV0YXRpb25cblxuZXhwb3J0IGNvbnN0IHJlc29sdmVyc01hbSA9IHtcbiAgICBRdWVyeToge1xuICAgICAgICBpbmZvLFxuICAgICAgICBnZXRDb2xsZWN0aW9ucyxcbiAgICAgICAgc3RhdFxuICAgIH0sXG59O1xuIl19