"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _arangochair = _interopRequireDefault(require("arangochair"));

var _arangojs = require("arangojs");

var _arangoCollection = require("./arango-collection");

var _auth = require("./auth");

var _config = require("./config");

var _logs = _interopRequireDefault(require("./logs"));

var _resolversGenerated = require("./resolvers-generated");

var _opentracing = require("opentracing");

var _tracer = require("./tracer");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
class Arango {
  constructor(config, logs, auth, tracer, stats) {
    this.config = config;
    this.log = logs.create('db');
    this.auth = auth;
    this.serverAddress = config.database.server;
    this.databaseName = config.database.name;
    this.tracer = tracer;
    this.statPostCount = new _tracer.StatsCounter(stats, _config.STATS.post.count, []);
    this.statPostFailed = new _tracer.StatsCounter(stats, _config.STATS.post.failed, []);

    const createDb = config => {
      const db = new _arangojs.Database({
        url: `${(0, _config.ensureProtocol)(config.server, 'http')}`,
        agentOptions: {
          maxSockets: config.maxSockets
        }
      });
      db.useDatabase(config.name);

      if (config.auth) {
        const authParts = config.auth.split(':');
        db.useBasicAuth(authParts[0], authParts.slice(1).join(':'));
      }

      return db;
    };

    this.db = createDb(config.database);
    const slowDb = createDb(config.slowDatabase);
    this.collections = [];
    this.collectionsByName = new Map();

    const addCollection = (name, docType) => {
      const collection = new _arangoCollection.Collection(name, docType, logs, this.auth, this.tracer, stats, this.db, slowDb, config.isTests || false);
      this.collections.push(collection);
      this.collectionsByName.set(name, collection);
      return collection;
    };

    this.transactions = addCollection('transactions', _resolversGenerated.Transaction);
    this.messages = addCollection('messages', _resolversGenerated.Message);
    this.accounts = addCollection('accounts', _resolversGenerated.Account);
    this.blocks = addCollection('blocks', _resolversGenerated.Block);
    this.blocks_signatures = addCollection('blocks_signatures', _resolversGenerated.BlockSignatures);
  }

  start() {
    const listenerUrl = `${(0, _config.ensureProtocol)(this.serverAddress, 'http')}/${this.databaseName}`;
    this.listener = new _arangochair.default(listenerUrl);

    if (this.config.database.auth) {
      const userPassword = Buffer.from(this.config.database.auth).toString('base64');
      this.listener.req.opts.headers['Authorization'] = `Basic ${userPassword}`;
    }

    this.collections.forEach(collection => {
      const name = collection.name;
      this.listener.subscribe({
        collection: name
      });
      this.listener.on(name, (docJson, type) => {
        if (type === 'insert/update' || type === 'insert' || type === 'update') {
          this.onDocumentInsertOrUpdate(name, docJson);
        }
      });
    });
    this.listener.start();
    this.log.debug('LISTEN', listenerUrl);
    this.listener.on('error', (err, status, headers, body) => {
      let error = err;

      try {
        error = JSON.parse(body);
      } catch {}

      this.log.error('FAILED', 'LISTEN', `${err}`, error);
      setTimeout(() => this.listener.start(), this.config.listener.restartTimeout);
    });
  }

  onDocumentInsertOrUpdate(name, doc) {
    const collection = this.collectionsByName.get(name);

    if (collection) {
      collection.onDocumentInsertOrUpdate(doc);
    }
  }

  async query(query, bindVars) {
    return (0, _utils.wrap)(this.log, 'QUERY', {
      query,
      bindVars
    }, async () => {
      const cursor = await this.db.query({
        query,
        bindVars
      });
      return cursor.all();
    });
  }

  async finishOperations(operationIds) {
    let count = 0;
    this.collections.forEach(x => count += x.finishOperations(operationIds));
    return count;
  }

}

exports.default = Arango;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hcmFuZ28uanMiXSwibmFtZXMiOlsiQXJhbmdvIiwiY29uc3RydWN0b3IiLCJjb25maWciLCJsb2dzIiwiYXV0aCIsInRyYWNlciIsInN0YXRzIiwibG9nIiwiY3JlYXRlIiwic2VydmVyQWRkcmVzcyIsImRhdGFiYXNlIiwic2VydmVyIiwiZGF0YWJhc2VOYW1lIiwibmFtZSIsInN0YXRQb3N0Q291bnQiLCJTdGF0c0NvdW50ZXIiLCJTVEFUUyIsInBvc3QiLCJjb3VudCIsInN0YXRQb3N0RmFpbGVkIiwiZmFpbGVkIiwiY3JlYXRlRGIiLCJkYiIsIkRhdGFiYXNlIiwidXJsIiwiYWdlbnRPcHRpb25zIiwibWF4U29ja2V0cyIsInVzZURhdGFiYXNlIiwiYXV0aFBhcnRzIiwic3BsaXQiLCJ1c2VCYXNpY0F1dGgiLCJzbGljZSIsImpvaW4iLCJzbG93RGIiLCJzbG93RGF0YWJhc2UiLCJjb2xsZWN0aW9ucyIsImNvbGxlY3Rpb25zQnlOYW1lIiwiTWFwIiwiYWRkQ29sbGVjdGlvbiIsImRvY1R5cGUiLCJjb2xsZWN0aW9uIiwiQ29sbGVjdGlvbiIsImlzVGVzdHMiLCJwdXNoIiwic2V0IiwidHJhbnNhY3Rpb25zIiwiVHJhbnNhY3Rpb24iLCJtZXNzYWdlcyIsIk1lc3NhZ2UiLCJhY2NvdW50cyIsIkFjY291bnQiLCJibG9ja3MiLCJCbG9jayIsImJsb2Nrc19zaWduYXR1cmVzIiwiQmxvY2tTaWduYXR1cmVzIiwic3RhcnQiLCJsaXN0ZW5lclVybCIsImxpc3RlbmVyIiwiYXJhbmdvY2hhaXIiLCJ1c2VyUGFzc3dvcmQiLCJCdWZmZXIiLCJmcm9tIiwidG9TdHJpbmciLCJyZXEiLCJvcHRzIiwiaGVhZGVycyIsImZvckVhY2giLCJzdWJzY3JpYmUiLCJvbiIsImRvY0pzb24iLCJ0eXBlIiwib25Eb2N1bWVudEluc2VydE9yVXBkYXRlIiwiZGVidWciLCJlcnIiLCJzdGF0dXMiLCJib2R5IiwiZXJyb3IiLCJKU09OIiwicGFyc2UiLCJzZXRUaW1lb3V0IiwicmVzdGFydFRpbWVvdXQiLCJkb2MiLCJnZXQiLCJxdWVyeSIsImJpbmRWYXJzIiwiY3Vyc29yIiwiYWxsIiwiZmluaXNoT3BlcmF0aW9ucyIsIm9wZXJhdGlvbklkcyIsIngiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFrQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7QUEvQkE7Ozs7Ozs7Ozs7Ozs7OztBQWtDZSxNQUFNQSxNQUFOLENBQWE7QUF1QnhCQyxFQUFBQSxXQUFXLENBQ1BDLE1BRE8sRUFFUEMsSUFGTyxFQUdQQyxJQUhPLEVBSVBDLE1BSk8sRUFLUEMsS0FMTyxFQU1UO0FBQ0UsU0FBS0osTUFBTCxHQUFjQSxNQUFkO0FBQ0EsU0FBS0ssR0FBTCxHQUFXSixJQUFJLENBQUNLLE1BQUwsQ0FBWSxJQUFaLENBQVg7QUFDQSxTQUFLSixJQUFMLEdBQVlBLElBQVo7QUFDQSxTQUFLSyxhQUFMLEdBQXFCUCxNQUFNLENBQUNRLFFBQVAsQ0FBZ0JDLE1BQXJDO0FBQ0EsU0FBS0MsWUFBTCxHQUFvQlYsTUFBTSxDQUFDUSxRQUFQLENBQWdCRyxJQUFwQztBQUNBLFNBQUtSLE1BQUwsR0FBY0EsTUFBZDtBQUVBLFNBQUtTLGFBQUwsR0FBcUIsSUFBSUMsb0JBQUosQ0FBaUJULEtBQWpCLEVBQXdCVSxjQUFNQyxJQUFOLENBQVdDLEtBQW5DLEVBQTBDLEVBQTFDLENBQXJCO0FBQ0EsU0FBS0MsY0FBTCxHQUFzQixJQUFJSixvQkFBSixDQUFpQlQsS0FBakIsRUFBd0JVLGNBQU1DLElBQU4sQ0FBV0csTUFBbkMsRUFBMkMsRUFBM0MsQ0FBdEI7O0FBRUEsVUFBTUMsUUFBUSxHQUFJbkIsTUFBRCxJQUFpQztBQUM5QyxZQUFNb0IsRUFBRSxHQUFHLElBQUlDLGtCQUFKLENBQWE7QUFDcEJDLFFBQUFBLEdBQUcsRUFBRyxHQUFFLDRCQUFldEIsTUFBTSxDQUFDUyxNQUF0QixFQUE4QixNQUE5QixDQUFzQyxFQUQxQjtB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QUFDK0Isd0JBQVgsQ0FBb0NVLEdBQXBDO0FBQ0g7QUFDSjs7QUFHRCxRQUFNRSxLQUFOLENBQVlBLEtBQVosRUFBd0JDLFFBQXhCLEVBQXVDO0FBQ25DLFdBQU8saUJBQUssS0FBSzdFLEdBQVYsRUFBZSxPQUFmLEVBQXdCO0FBQUU0RSxNQUFBQSxLQUFGO0FBQVNDLE1BQUFBO0FBQVQsS0FBeEIsRUFBNkMsWUFBWTtBQUM1RCxZQUFNQyxNQUFNLEdBQUcsTUFBTSxLQUFLL0QsRUFBTCxDQUFRNkQsS0FBUixDQUFjO0FBQUVBLFFBQUFBLEtBQUY7QUFBU0MsUUFBQUE7QUFBVCxPQUFkLENBQXJCO0FBQ0EsYUFBT0MsTUFBTSxDQUFDQyxHQUFQLEVBQVA7QUFDSCxLQUhNLENBQVA7QUFJSDs7QUFFRCxRQUFNQyxnQkFBTixDQUF1QkMsWUFBdkIsRUFBbUU7QUFDL0QsUUFBSXRFLEtBQUssR0FBRyxDQUFaO0FBQ0EsU0FBS2lCLFdBQUwsQ0FBaUIrQixPQUFqQixDQUF5QnVCLENBQUMsSUFBS3ZFLEtBQUssSUFBSXVFLENBQUMsQ0FBQ0YsZ0JBQUYsQ0FBbUJDLFlBQW5CLENBQXhDO0FBQ0EsV0FBT3RFLEtBQVA7QUFDSDs7QUF2SXVCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE4LTIwMjAgVE9OIERFViBTT0xVVElPTlMgTFRELlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBTT0ZUV0FSRSBFVkFMVUFUSU9OIExpY2Vuc2UgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZVxuICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlXG4gKiBMaWNlbnNlIGF0OlxuICpcbiAqIGh0dHA6Ly93d3cudG9uLmRldi9saWNlbnNlc1xuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgVE9OIERFViBzb2Z0d2FyZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vLyBAZmxvd1xuXG5pbXBvcnQgYXJhbmdvY2hhaXIgZnJvbSAnYXJhbmdvY2hhaXInO1xuaW1wb3J0IHsgRGF0YWJhc2UgfSBmcm9tICdhcmFuZ29qcyc7XG5pbXBvcnQgeyBDb2xsZWN0aW9ufSBmcm9tIFwiLi9hcmFuZ28tY29sbGVjdGlvblwiO1xuaW1wb3J0IHsgQXV0aCB9IGZyb20gXCIuL2F1dGhcIjtcbmltcG9ydCB0eXBlIHsgUUNvbmZpZywgUURiQ29uZmlnIH0gZnJvbSAnLi9jb25maWcnXG5pbXBvcnQgeyBlbnN1cmVQcm90b2NvbCwgU1RBVFMgfSBmcm9tICcuL2NvbmZpZyc7XG5pbXBvcnQgdHlwZSB7IFFMb2cgfSBmcm9tICcuL2xvZ3MnO1xuaW1wb3J0IFFMb2dzIGZyb20gJy4vbG9ncydcbmltcG9ydCB0eXBlIHsgUVR5cGUgfSBmcm9tICcuL2RiLXR5cGVzJztcbmltcG9ydCB7IEFjY291bnQsIEJsb2NrLCBCbG9ja1NpZ25hdHVyZXMsIE1lc3NhZ2UsIFRyYW5zYWN0aW9uIH0gZnJvbSAnLi9yZXNvbHZlcnMtZ2VuZXJhdGVkJztcbmltcG9ydCB7IFRyYWNlciB9IGZyb20gXCJvcGVudHJhY2luZ1wiO1xuaW1wb3J0IHsgU3RhdHNDb3VudGVyIH0gZnJvbSBcIi4vdHJhY2VyXCI7XG5pbXBvcnQgdHlwZSB7SVN0YXRzfSBmcm9tICcuL3RyYWNlcic7XG5pbXBvcnQge3dyYXB9IGZyb20gXCIuL3V0aWxzXCI7XG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXJhbmdvIHtcbiAgICBjb25maWc6IFFDb25maWc7XG4gICAgbG9nOiBRTG9nO1xuICAgIHNlcnZlckFkZHJlc3M6IHN0cmluZztcbiAgICBkYXRhYmFzZU5hbWU6IHN0cmluZztcbiAgICBkYjogRGF0YWJhc2U7XG5cbiAgICBhdXRoOiBBdXRoO1xuICAgIHRyYWNlcjogVHJhY2VyO1xuICAgIHN0YXRQb3N0Q291bnQ6IFN0YXRzQ291bnRlcjtcbiAgICBzdGF0UG9zdEZhaWxlZDogU3RhdHNDb3VudGVyO1xuXG4gICAgdHJhbnNhY3Rpb25zOiBDb2xsZWN0aW9uO1xuICAgIG1lc3NhZ2VzOiBDb2xsZWN0aW9uO1xuICAgIGFjY291bnRzOiBDb2xsZWN0aW9uO1xuICAgIGJsb2NrczogQ29sbGVjdGlvbjtcbiAgICBibG9ja3Nfc2lnbmF0dXJlczogQ29sbGVjdGlvbjtcblxuICAgIGNvbGxlY3Rpb25zOiBDb2xsZWN0aW9uW107XG4gICAgY29sbGVjdGlvbnNCeU5hbWU6IE1hcDxzdHJpbmcsIENvbGxlY3Rpb24+O1xuXG4gICAgbGlzdGVuZXI6IGFueTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBjb25maWc6IFFDb25maWcsXG4gICAgICAgIGxvZ3M6IFFMb2dzLFxuICAgICAgICBhdXRoOiBBdXRoLFxuICAgICAgICB0cmFjZXI6IFRyYWNlcixcbiAgICAgICAgc3RhdHM6IElTdGF0cyxcbiAgICApIHtcbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgICAgIHRoaXMubG9nID0gbG9ncy5jcmVhdGUoJ2RiJyk7XG4gICAgICAgIHRoaXMuYXV0aCA9IGF1dGg7XG4gICAgICAgIHRoaXMuc2VydmVyQWRkcmVzcyA9IGNvbmZpZy5kYXRhYmFzZS5zZXJ2ZXI7XG4gICAgICAgIHRoaXMuZGF0YWJhc2VOYW1lID0gY29uZmlnLmRhdGFiYXNlLm5hbWU7XG4gICAgICAgIHRoaXMudHJhY2VyID0gdHJhY2VyO1xuXG4gICAgICAgIHRoaXMuc3RhdFBvc3RDb3VudCA9IG5ldyBTdGF0c0NvdW50ZXIoc3RhdHMsIFNUQVRTLnBvc3QuY291bnQsIFtdKTtcbiAgICAgICAgdGhpcy5zdGF0UG9zdEZhaWxlZCA9IG5ldyBTdGF0c0NvdW50ZXIoc3RhdHMsIFNUQVRTLnBvc3QuZmFpbGVkLCBbXSk7XG5cbiAgICAgICAgY29uc3QgY3JlYXRlRGIgPSAoY29uZmlnOiBRRGJDb25maWcpOiBEYXRhYmFzZSA9PiB7XG4gICAgICAgICAgICBjb25zdCBkYiA9IG5ldyBEYXRhYmFzZSh7XG4gICAgICAgICAgICAgICAgdXJsOiBgJHtlbnN1cmVQcm90b2NvbChjb25maWcuc2VydmVyLCAnaHR0cCcpfWAsXG4gICAgICAgICAgICAgICAgYWdlbnRPcHRpb25zOiB7XG4gICAgICAgICAgICAgICAgICAgIG1heFNvY2tldHM6IGNvbmZpZy5tYXhTb2NrZXRzLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGRiLnVzZURhdGFiYXNlKGNvbmZpZy5uYW1lKTtcbiAgICAgICAgICAgIGlmIChjb25maWcuYXV0aCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGF1dGhQYXJ0cyA9IGNvbmZpZy5hdXRoLnNwbGl0KCc6Jyk7XG4gICAgICAgICAgICAgICAgZGIudXNlQmFzaWNBdXRoKGF1dGhQYXJ0c1swXSwgYXV0aFBhcnRzLnNsaWNlKDEpLmpvaW4oJzonKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZGI7XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5kYiA9IGNyZWF0ZURiKGNvbmZpZy5kYXRhYmFzZSk7XG4gICAgICAgIGNvbnN0IHNsb3dEYiA9IGNyZWF0ZURiKGNvbmZpZy5zbG93RGF0YWJhc2UpO1xuXG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnMgPSBbXTtcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9uc0J5TmFtZSA9IG5ldyBNYXAoKTtcblxuICAgICAgICBjb25zdCBhZGRDb2xsZWN0aW9uID0gKG5hbWU6IHN0cmluZywgZG9jVHlwZTogUVR5cGUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbGxlY3Rpb24gPSBuZXcgQ29sbGVjdGlvbihcbiAgICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgICAgIGRvY1R5cGUsXG4gICAgICAgICAgICAgICAgbG9ncyxcbiAgICAgICAgICAgICAgICB0aGlzLmF1dGgsXG4gICAgICAgICAgICAgICAgdGhpcy50cmFjZXIsXG4gICAgICAgICAgICAgICAgc3RhdHMsXG4gICAgICAgICAgICAgICAgdGhpcy5kYixcbiAgICAgICAgICAgICAgICBzbG93RGIsXG4gICAgICAgICAgICAgICAgY29uZmlnLmlzVGVzdHMgfHwgZmFsc2UsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgdGhpcy5jb2xsZWN0aW9ucy5wdXNoKGNvbGxlY3Rpb24pO1xuICAgICAgICAgICAgdGhpcy5jb2xsZWN0aW9uc0J5TmFtZS5zZXQobmFtZSwgY29sbGVjdGlvbik7XG4gICAgICAgICAgICByZXR1cm4gY29sbGVjdGlvbjtcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLnRyYW5zYWN0aW9ucyA9IGFkZENvbGxlY3Rpb24oJ3RyYW5zYWN0aW9ucycsIFRyYW5zYWN0aW9uKTtcbiAgICAgICAgdGhpcy5tZXNzYWdlcyA9IGFkZENvbGxlY3Rpb24oJ21lc3NhZ2VzJywgTWVzc2FnZSk7XG4gICAgICAgIHRoaXMuYWNjb3VudHMgPSBhZGRDb2xsZWN0aW9uKCdhY2NvdW50cycsIEFjY291bnQpO1xuICAgICAgICB0aGlzLmJsb2NrcyA9IGFkZENvbGxlY3Rpb24oJ2Jsb2NrcycsIEJsb2NrKTtcbiAgICAgICAgdGhpcy5ibG9ja3Nfc2lnbmF0dXJlcyA9IGFkZENvbGxlY3Rpb24oJ2Jsb2Nrc19zaWduYXR1cmVzJywgQmxvY2tTaWduYXR1cmVzKTtcbiAgICB9XG5cbiAgICBzdGFydCgpIHtcbiAgICAgICAgY29uc3QgbGlzdGVuZXJVcmwgPSBgJHtlbnN1cmVQcm90b2NvbCh0aGlzLnNlcnZlckFkZHJlc3MsICdodHRwJyl9LyR7dGhpcy5kYXRhYmFzZU5hbWV9YDtcbiAgICAgICAgdGhpcy5saXN0ZW5lciA9IG5ldyBhcmFuZ29jaGFpcihsaXN0ZW5lclVybCk7XG5cbiAgICAgICAgaWYgKHRoaXMuY29uZmlnLmRhdGFiYXNlLmF1dGgpIHtcbiAgICAgICAgICAgIGNvbnN0IHVzZXJQYXNzd29yZCA9IEJ1ZmZlci5mcm9tKHRoaXMuY29uZmlnLmRhdGFiYXNlLmF1dGgpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgICAgICAgICAgIHRoaXMubGlzdGVuZXIucmVxLm9wdHMuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddID0gYEJhc2ljICR7dXNlclBhc3N3b3JkfWA7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zLmZvckVhY2goY29sbGVjdGlvbiA9PiB7XG4gICAgICAgICAgICBjb25zdCBuYW1lID0gY29sbGVjdGlvbi5uYW1lO1xuICAgICAgICAgICAgdGhpcy5saXN0ZW5lci5zdWJzY3JpYmUoeyBjb2xsZWN0aW9uOiBuYW1lIH0pO1xuICAgICAgICAgICAgdGhpcy5saXN0ZW5lci5vbihuYW1lLCAoZG9jSnNvbiwgdHlwZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnaW5zZXJ0L3VwZGF0ZScgfHwgdHlwZSA9PT0gJ2luc2VydCcgfHwgdHlwZSA9PT0gJ3VwZGF0ZScpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkRvY3VtZW50SW5zZXJ0T3JVcGRhdGUobmFtZSwgZG9jSnNvbik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmxpc3RlbmVyLnN0YXJ0KCk7XG4gICAgICAgIHRoaXMubG9nLmRlYnVnKCdMSVNURU4nLCBsaXN0ZW5lclVybCk7XG4gICAgICAgIHRoaXMubGlzdGVuZXIub24oJ2Vycm9yJywgKGVyciwgc3RhdHVzLCBoZWFkZXJzLCBib2R5KSA9PiB7XG4gICAgICAgICAgICBsZXQgZXJyb3IgPSBlcnI7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGVycm9yID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICAgICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ0ZBSUxFRCcsICdMSVNURU4nLCBgJHtlcnJ9YCwgZXJyb3IpO1xuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmxpc3RlbmVyLnN0YXJ0KCksIHRoaXMuY29uZmlnLmxpc3RlbmVyLnJlc3RhcnRUaW1lb3V0KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgb25Eb2N1bWVudEluc2VydE9yVXBkYXRlKG5hbWU6IHN0cmluZywgZG9jOiBhbnkpIHtcbiAgICAgICAgY29uc3QgY29sbGVjdGlvbjogKENvbGxlY3Rpb24gfCB0eXBlb2YgdW5kZWZpbmVkKSA9IHRoaXMuY29sbGVjdGlvbnNCeU5hbWUuZ2V0KG5hbWUpO1xuICAgICAgICBpZiAoY29sbGVjdGlvbikge1xuICAgICAgICAgICAgY29sbGVjdGlvbi5vbkRvY3VtZW50SW5zZXJ0T3JVcGRhdGUoZG9jKTtcbiAgICAgICAgfVxuICAgIH1cblxuXG4gICAgYXN5bmMgcXVlcnkocXVlcnk6IGFueSwgYmluZFZhcnM6IGFueSkge1xuICAgICAgICByZXR1cm4gd3JhcCh0aGlzLmxvZywgJ1FVRVJZJywgeyBxdWVyeSwgYmluZFZhcnMgfSwgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY3Vyc29yID0gYXdhaXQgdGhpcy5kYi5xdWVyeSh7IHF1ZXJ5LCBiaW5kVmFycyB9KTtcbiAgICAgICAgICAgIHJldHVybiBjdXJzb3IuYWxsKCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmlzaE9wZXJhdGlvbnMob3BlcmF0aW9uSWRzOiBTZXQ8c3RyaW5nPik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGxldCBjb3VudCA9IDA7XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnMuZm9yRWFjaCh4ID0+IChjb3VudCArPSB4LmZpbmlzaE9wZXJhdGlvbnMob3BlcmF0aW9uSWRzKSkpO1xuICAgICAgICByZXR1cm4gY291bnQ7XG4gICAgfVxufVxuIl19