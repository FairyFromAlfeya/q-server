"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _arangochair = _interopRequireDefault(require("arangochair"));

var _arangojs = require("arangojs");

var _arangoCollection = require("./arango-collection");

var _auth = require("./auth");

var _config = require("./config");

var _logs = _interopRequireDefault(require("./logs"));

var _resolversGenerated = require("./resolvers-generated");

var _opentracing = require("opentracing");

var _tracer = require("./tracer");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
class Arango {
  constructor(config, logs, auth, tracer, stats) {
    this.config = config;
    this.log = logs.create('db');
    this.auth = auth;
    this.serverAddress = config.database.server;
    this.databaseName = config.database.name;
    this.tracer = tracer;
    this.statPostCount = new _tracer.StatsCounter(stats, _config.STATS.post.count, []);
    this.statPostFailed = new _tracer.StatsCounter(stats, _config.STATS.post.failed, []);

    const createDb = config => {
      const db = new _arangojs.Database({
        url: `${(0, _config.ensureProtocol)(config.server, 'http')}`,
        agentOptions: {
          maxSockets: config.maxSockets
        }
      });
      db.useDatabase(config.name);

      if (config.auth) {
        const authParts = config.auth.split(':');
        db.useBasicAuth(authParts[0], authParts.slice(1).join(':'));
      }

      return db;
    };

    this.db = createDb(config.database);
    const slowDb = createDb(config.slowDatabase);
    this.collections = [];
    this.collectionsByName = new Map();

    const addCollection = (name, docType) => {
      const collection = new _arangoCollection.Collection(name, docType, logs, this.auth, this.tracer, stats, this.db, slowDb);
      this.collections.push(collection);
      this.collectionsByName.set(name, collection);
      return collection;
    };

    this.transactions = addCollection('transactions', _resolversGenerated.Transaction);
    this.messages = addCollection('messages', _resolversGenerated.Message);
    this.accounts = addCollection('accounts', _resolversGenerated.Account);
    this.blocks = addCollection('blocks', _resolversGenerated.Block);
    this.blocks_signatures = addCollection('blocks_signatures', _resolversGenerated.BlockSignatures);
  }

  start() {
    const listenerUrl = `${(0, _config.ensureProtocol)(this.serverAddress, 'http')}/${this.databaseName}`;
    this.listener = new _arangochair.default(listenerUrl);

    if (this.config.database.auth) {
      const userPassword = Buffer.from(this.config.database.auth).toString('base64');
      this.listener.req.opts.headers['Authorization'] = `Basic ${userPassword}`;
    }

    this.collections.forEach(collection => {
      const name = collection.name;
      this.listener.subscribe({
        collection: name
      });
      this.listener.on(name, (docJson, type) => {
        if (type === 'insert/update' || type === 'insert' || type === 'update') {
          this.onDocumentInsertOrUpdate(name, docJson);
        }
      });
    });
    this.listener.start();
    this.log.debug('LISTEN', listenerUrl);
    this.listener.on('error', (err, status, headers, body) => {
      let error = err;

      try {
        error = JSON.parse(body);
      } catch {}

      this.log.error('FAILED', 'LISTEN', `${err}`, error);
      setTimeout(() => this.listener.start(), this.config.listener.restartTimeout);
    });
  }

  onDocumentInsertOrUpdate(name, doc) {
    const collection = this.collectionsByName.get(name);

    if (collection) {
      collection.onDocumentInsertOrUpdate(doc);
    }
  }

  async query(query, bindVars) {
    return (0, _utils.wrap)(this.log, 'QUERY', {
      query,
      bindVars
    }, async () => {
      const cursor = await this.db.query({
        query,
        bindVars
      });
      return cursor.all();
    });
  }

  async finishOperations(operationIds) {
    let count = 0;
    this.collections.forEach(x => count += x.finishOperations(operationIds));
    return count;
  }

}

exports.default = Arango;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hcmFuZ28uanMiXSwibmFtZXMiOlsiQXJhbmdvIiwiY29uc3RydWN0b3IiLCJjb25maWciLCJsb2dzIiwiYXV0aCIsInRyYWNlciIsInN0YXRzIiwibG9nIiwiY3JlYXRlIiwic2VydmVyQWRkcmVzcyIsImRhdGFiYXNlIiwic2VydmVyIiwiZGF0YWJhc2VOYW1lIiwibmFtZSIsInN0YXRQb3N0Q291bnQiLCJTdGF0c0NvdW50ZXIiLCJTVEFUUyIsInBvc3QiLCJjb3VudCIsInN0YXRQb3N0RmFpbGVkIiwiZmFpbGVkIiwiY3JlYXRlRGIiLCJkYiIsIkRhdGFiYXNlIiwidXJsIiwiYWdlbnRPcHRpb25zIiwibWF4U29ja2V0cyIsInVzZURhdGFiYXNlIiwiYXV0aFBhcnRzIiwic3BsaXQiLCJ1c2VCYXNpY0F1dGgiLCJzbGljZSIsImpvaW4iLCJzbG93RGIiLCJzbG93RGF0YWJhc2UiLCJjb2xsZWN0aW9ucyIsImNvbGxlY3Rpb25zQnlOYW1lIiwiTWFwIiwiYWRkQ29sbGVjdGlvbiIsImRvY1R5cGUiLCJjb2xsZWN0aW9uIiwiQ29sbGVjdGlvbiIsInB1c2giLCJzZXQiLCJ0cmFuc2FjdGlvbnMiLCJUcmFuc2FjdGlvbiIsIm1lc3NhZ2VzIiwiTWVzc2FnZSIsImFjY291bnRzIiwiQWNjb3VudCIsImJsb2NrcyIsIkJsb2NrIiwiYmxvY2tzX3NpZ25hdHVyZXMiLCJCbG9ja1NpZ25hdHVyZXMiLCJzdGFydCIsImxpc3RlbmVyVXJsIiwibGlzdGVuZXIiLCJhcmFuZ29jaGFpciIsInVzZXJQYXNzd29yZCIsIkJ1ZmZlciIsImZyb20iLCJ0b1N0cmluZyIsInJlcSIsIm9wdHMiLCJoZWFkZXJzIiwiZm9yRWFjaCIsInN1YnNjcmliZSIsIm9uIiwiZG9jSnNvbiIsInR5cGUiLCJvbkRvY3VtZW50SW5zZXJ0T3JVcGRhdGUiLCJkZWJ1ZyIsImVyciIsInN0YXR1cyIsImJvZHkiLCJlcnJvciIsIkpTT04iLCJwYXJzZSIsInNldFRpbWVvdXQiLCJyZXN0YXJ0VGltZW91dCIsImRvYyIsImdldCIsInF1ZXJ5IiwiYmluZFZhcnMiLCJjdXJzb3IiLCJhbGwiLCJmaW5pc2hPcGVyYXRpb25zIiwib3BlcmF0aW9uSWRzIiwieCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQWtCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFFQTs7OztBQS9CQTs7Ozs7Ozs7Ozs7Ozs7O0FBa0NlLE1BQU1BLE1BQU4sQ0FBYTtBQXVCeEJDLEVBQUFBLFdBQVcsQ0FDUEMsTUFETyxFQUVQQyxJQUZPLEVBR1BDLElBSE8sRUFJUEMsTUFKTyxFQUtQQyxLQUxPLEVBTVQ7QUFDRSxTQUFLSixNQUFMLEdBQWNBLE1BQWQ7QUFDQSxTQUFLSyxHQUFMLEdBQVdKLElBQUksQ0FBQ0ssTUFBTCxDQUFZLElBQVosQ0FBWDtBQUNBLFNBQUtKLElBQUwsR0FBWUEsSUFBWjtBQUNBLFNBQUtLLGFBQUwsR0FBcUJQLE1BQU0sQ0FBQ1EsUUFBUCxDQUFnQkMsTUFBckM7QUFDQSxTQUFLQyxZQUFMLEdBQW9CVixNQUFNLENBQUNRLFFBQVAsQ0FBZ0JHLElBQXBDO0FBQ0EsU0FBS1IsTUFBTCxHQUFjQSxNQUFkO0FBRUEsU0FBS1MsYUFBTCxHQUFxQixJQUFJQyxvQkFBSixDQUFpQlQsS0FBakIsRUFBd0JVLGNBQU1DLElBQU4sQ0FBV0MsS0FBbkMsRUFBMEMsRUFBMUMsQ0FBckI7QUFDQSxTQUFLQyxjQUFMLEdBQXNCLElBQUlKLG9CQUFKLENBQWlCVCxLQUFqQixFQUF3QlUsY0FBTUMsSUFBTixDQUFXRyxNQUFuQyxFQUEyQyxFQUEzQyxDQUF0Qjs7QUFFQSxVQUFNQyxRQUFRLEdBQUluQixNQUFELElBQWlDO0FBQzlDLFlBQU1vQixFQUFFLEdBQUcsSUFBSUMsa0JBQUosQ0FBYTtBQUNwQkMsUUFBQUEsR0FBRyxFQUFHLEdBQUUsNEJBQWV0QixNQUFNLENBQUNTLE1BQXRCLEVBQThCLE1BQTlCLENBQXNDLEVBRDFCO0FBRXBCYyxRQUFB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LEtBQU4sQ0FBWUEsS0FBWixFQUF3QkMsUUFBeEIsRUFBdUM7QUFDbkMsV0FBTyxpQkFBSyxLQUFLNUUsR0FBVixFQUFlLE9BQWYsRUFBd0I7QUFBRTJFLE1BQUFBLEtBQUY7QUFBU0MsTUFBQUE7QUFBVCxLQUF4QixFQUE2QyxZQUFZO0FBQzVELFlBQU1DLE1BQU0sR0FBRyxNQUFNLEtBQUs5RCxFQUFMLENBQVE0RCxLQUFSLENBQWM7QUFBRUEsUUFBQUEsS0FBRjtBQUFTQyxRQUFBQTtBQUFULE9BQWQsQ0FBckI7QUFDQSxhQUFPQyxNQUFNLENBQUNDLEdBQVAsRUFBUDtBQUNILEtBSE0sQ0FBUDtBQUlIOztBQUVELFFBQU1DLGdCQUFOLENBQXVCQyxZQUF2QixFQUFtRTtBQUMvRCxRQUFJckUsS0FBSyxHQUFHLENBQVo7QUFDQSxTQUFLaUIsV0FBTCxDQUFpQjhCLE9BQWpCLENBQXlCdUIsQ0FBQyxJQUFLdEUsS0FBSyxJQUFJc0UsQ0FBQyxDQUFDRixnQkFBRixDQUFtQkMsWUFBbkIsQ0FBeEM7QUFDQSxXQUFPckUsS0FBUDtBQUNIOztBQXRJdUIiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTgtMjAyMCBUT04gREVWIFNPTFVUSU9OUyBMVEQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIFNPRlRXQVJFIEVWQUxVQVRJT04gTGljZW5zZSAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlXG4gKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGVcbiAqIExpY2Vuc2UgYXQ6XG4gKlxuICogaHR0cDovL3d3dy50b24uZGV2L2xpY2Vuc2VzXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBUT04gREVWIHNvZnR3YXJlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbi8vIEBmbG93XG5cbmltcG9ydCBhcmFuZ29jaGFpciBmcm9tICdhcmFuZ29jaGFpcic7XG5pbXBvcnQgeyBEYXRhYmFzZSB9IGZyb20gJ2FyYW5nb2pzJztcbmltcG9ydCB7IENvbGxlY3Rpb259IGZyb20gXCIuL2FyYW5nby1jb2xsZWN0aW9uXCI7XG5pbXBvcnQgeyBBdXRoIH0gZnJvbSBcIi4vYXV0aFwiO1xuaW1wb3J0IHR5cGUgeyBRQ29uZmlnLCBRRGJDb25maWcgfSBmcm9tICcuL2NvbmZpZydcbmltcG9ydCB7IGVuc3VyZVByb3RvY29sLCBTVEFUUyB9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCB0eXBlIHsgUUxvZyB9IGZyb20gJy4vbG9ncyc7XG5pbXBvcnQgUUxvZ3MgZnJvbSAnLi9sb2dzJ1xuaW1wb3J0IHR5cGUgeyBRVHlwZSB9IGZyb20gJy4vZGItdHlwZXMnO1xuaW1wb3J0IHsgQWNjb3VudCwgQmxvY2ssIEJsb2NrU2lnbmF0dXJlcywgTWVzc2FnZSwgVHJhbnNhY3Rpb24gfSBmcm9tICcuL3Jlc29sdmVycy1nZW5lcmF0ZWQnO1xuaW1wb3J0IHsgVHJhY2VyIH0gZnJvbSBcIm9wZW50cmFjaW5nXCI7XG5pbXBvcnQgeyBTdGF0c0NvdW50ZXIgfSBmcm9tIFwiLi90cmFjZXJcIjtcbmltcG9ydCB0eXBlIHtJU3RhdHN9IGZyb20gJy4vdHJhY2VyJztcbmltcG9ydCB7d3JhcH0gZnJvbSBcIi4vdXRpbHNcIjtcblxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBcmFuZ28ge1xuICAgIGNvbmZpZzogUUNvbmZpZztcbiAgICBsb2c6IFFMb2c7XG4gICAgc2VydmVyQWRkcmVzczogc3RyaW5nO1xuICAgIGRhdGFiYXNlTmFtZTogc3RyaW5nO1xuICAgIGRiOiBEYXRhYmFzZTtcblxuICAgIGF1dGg6IEF1dGg7XG4gICAgdHJhY2VyOiBUcmFjZXI7XG4gICAgc3RhdFBvc3RDb3VudDogU3RhdHNDb3VudGVyO1xuICAgIHN0YXRQb3N0RmFpbGVkOiBTdGF0c0NvdW50ZXI7XG5cbiAgICB0cmFuc2FjdGlvbnM6IENvbGxlY3Rpb247XG4gICAgbWVzc2FnZXM6IENvbGxlY3Rpb247XG4gICAgYWNjb3VudHM6IENvbGxlY3Rpb247XG4gICAgYmxvY2tzOiBDb2xsZWN0aW9uO1xuICAgIGJsb2Nrc19zaWduYXR1cmVzOiBDb2xsZWN0aW9uO1xuXG4gICAgY29sbGVjdGlvbnM6IENvbGxlY3Rpb25bXTtcbiAgICBjb2xsZWN0aW9uc0J5TmFtZTogTWFwPHN0cmluZywgQ29sbGVjdGlvbj47XG5cbiAgICBsaXN0ZW5lcjogYW55O1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIGNvbmZpZzogUUNvbmZpZyxcbiAgICAgICAgbG9nczogUUxvZ3MsXG4gICAgICAgIGF1dGg6IEF1dGgsXG4gICAgICAgIHRyYWNlcjogVHJhY2VyLFxuICAgICAgICBzdGF0czogSVN0YXRzLFxuICAgICkge1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICAgICAgdGhpcy5sb2cgPSBsb2dzLmNyZWF0ZSgnZGInKTtcbiAgICAgICAgdGhpcy5hdXRoID0gYXV0aDtcbiAgICAgICAgdGhpcy5zZXJ2ZXJBZGRyZXNzID0gY29uZmlnLmRhdGFiYXNlLnNlcnZlcjtcbiAgICAgICAgdGhpcy5kYXRhYmFzZU5hbWUgPSBjb25maWcuZGF0YWJhc2UubmFtZTtcbiAgICAgICAgdGhpcy50cmFjZXIgPSB0cmFjZXI7XG5cbiAgICAgICAgdGhpcy5zdGF0UG9zdENvdW50ID0gbmV3IFN0YXRzQ291bnRlcihzdGF0cywgU1RBVFMucG9zdC5jb3VudCwgW10pO1xuICAgICAgICB0aGlzLnN0YXRQb3N0RmFpbGVkID0gbmV3IFN0YXRzQ291bnRlcihzdGF0cywgU1RBVFMucG9zdC5mYWlsZWQsIFtdKTtcblxuICAgICAgICBjb25zdCBjcmVhdGVEYiA9IChjb25maWc6IFFEYkNvbmZpZyk6IERhdGFiYXNlID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGRiID0gbmV3IERhdGFiYXNlKHtcbiAgICAgICAgICAgICAgICB1cmw6IGAke2Vuc3VyZVByb3RvY29sKGNvbmZpZy5zZXJ2ZXIsICdodHRwJyl9YCxcbiAgICAgICAgICAgICAgICBhZ2VudE9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgICAgICAgbWF4U29ja2V0czogY29uZmlnLm1heFNvY2tldHMsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgZGIudXNlRGF0YWJhc2UoY29uZmlnLm5hbWUpO1xuICAgICAgICAgICAgaWYgKGNvbmZpZy5hdXRoKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYXV0aFBhcnRzID0gY29uZmlnLmF1dGguc3BsaXQoJzonKTtcbiAgICAgICAgICAgICAgICBkYi51c2VCYXNpY0F1dGgoYXV0aFBhcnRzWzBdLCBhdXRoUGFydHMuc2xpY2UoMSkuam9pbignOicpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBkYjtcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLmRiID0gY3JlYXRlRGIoY29uZmlnLmRhdGFiYXNlKTtcbiAgICAgICAgY29uc3Qgc2xvd0RiID0gY3JlYXRlRGIoY29uZmlnLnNsb3dEYXRhYmFzZSk7XG5cbiAgICAgICAgdGhpcy5jb2xsZWN0aW9ucyA9IFtdO1xuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zQnlOYW1lID0gbmV3IE1hcCgpO1xuXG4gICAgICAgIGNvbnN0IGFkZENvbGxlY3Rpb24gPSAobmFtZTogc3RyaW5nLCBkb2NUeXBlOiBRVHlwZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29sbGVjdGlvbiA9IG5ldyBDb2xsZWN0aW9uKFxuICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgZG9jVHlwZSxcbiAgICAgICAgICAgICAgICBsb2dzLFxuICAgICAgICAgICAgICAgIHRoaXMuYXV0aCxcbiAgICAgICAgICAgICAgICB0aGlzLnRyYWNlcixcbiAgICAgICAgICAgICAgICBzdGF0cyxcbiAgICAgICAgICAgICAgICB0aGlzLmRiLFxuICAgICAgICAgICAgICAgIHNsb3dEYixcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICB0aGlzLmNvbGxlY3Rpb25zLnB1c2goY29sbGVjdGlvbik7XG4gICAgICAgICAgICB0aGlzLmNvbGxlY3Rpb25zQnlOYW1lLnNldChuYW1lLCBjb2xsZWN0aW9uKTtcbiAgICAgICAgICAgIHJldHVybiBjb2xsZWN0aW9uO1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMudHJhbnNhY3Rpb25zID0gYWRkQ29sbGVjdGlvbigndHJhbnNhY3Rpb25zJywgVHJhbnNhY3Rpb24pO1xuICAgICAgICB0aGlzLm1lc3NhZ2VzID0gYWRkQ29sbGVjdGlvbignbWVzc2FnZXMnLCBNZXNzYWdlKTtcbiAgICAgICAgdGhpcy5hY2NvdW50cyA9IGFkZENvbGxlY3Rpb24oJ2FjY291bnRzJywgQWNjb3VudCk7XG4gICAgICAgIHRoaXMuYmxvY2tzID0gYWRkQ29sbGVjdGlvbignYmxvY2tzJywgQmxvY2spO1xuICAgICAgICB0aGlzLmJsb2Nrc19zaWduYXR1cmVzID0gYWRkQ29sbGVjdGlvbignYmxvY2tzX3NpZ25hdHVyZXMnLCBCbG9ja1NpZ25hdHVyZXMpO1xuICAgIH1cblxuICAgIHN0YXJ0KCkge1xuICAgICAgICBjb25zdCBsaXN0ZW5lclVybCA9IGAke2Vuc3VyZVByb3RvY29sKHRoaXMuc2VydmVyQWRkcmVzcywgJ2h0dHAnKX0vJHt0aGlzLmRhdGFiYXNlTmFtZX1gO1xuICAgICAgICB0aGlzLmxpc3RlbmVyID0gbmV3IGFyYW5nb2NoYWlyKGxpc3RlbmVyVXJsKTtcblxuICAgICAgICBpZiAodGhpcy5jb25maWcuZGF0YWJhc2UuYXV0aCkge1xuICAgICAgICAgICAgY29uc3QgdXNlclBhc3N3b3JkID0gQnVmZmVyLmZyb20odGhpcy5jb25maWcuZGF0YWJhc2UuYXV0aCkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICAgICAgICAgICAgdGhpcy5saXN0ZW5lci5yZXEub3B0cy5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10gPSBgQmFzaWMgJHt1c2VyUGFzc3dvcmR9YDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnMuZm9yRWFjaChjb2xsZWN0aW9uID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBjb2xsZWN0aW9uLm5hbWU7XG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyLnN1YnNjcmliZSh7IGNvbGxlY3Rpb246IG5hbWUgfSk7XG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyLm9uKG5hbWUsIChkb2NKc29uLCB0eXBlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdpbnNlcnQvdXBkYXRlJyB8fCB0eXBlID09PSAnaW5zZXJ0JyB8fCB0eXBlID09PSAndXBkYXRlJykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uRG9jdW1lbnRJbnNlcnRPclVwZGF0ZShuYW1lLCBkb2NKc29uKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMubGlzdGVuZXIuc3RhcnQoKTtcbiAgICAgICAgdGhpcy5sb2cuZGVidWcoJ0xJU1RFTicsIGxpc3RlbmVyVXJsKTtcbiAgICAgICAgdGhpcy5saXN0ZW5lci5vbignZXJyb3InLCAoZXJyLCBzdGF0dXMsIGhlYWRlcnMsIGJvZHkpID0+IHtcbiAgICAgICAgICAgIGxldCBlcnJvciA9IGVycjtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgZXJyb3IgPSBKU09OLnBhcnNlKGJvZHkpO1xuICAgICAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignRkFJTEVEJywgJ0xJU1RFTicsIGAke2Vycn1gLCBlcnJvcik7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMubGlzdGVuZXIuc3RhcnQoKSwgdGhpcy5jb25maWcubGlzdGVuZXIucmVzdGFydFRpbWVvdXQpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBvbkRvY3VtZW50SW5zZXJ0T3JVcGRhdGUobmFtZTogc3RyaW5nLCBkb2M6IGFueSkge1xuICAgICAgICBjb25zdCBjb2xsZWN0aW9uOiAoQ29sbGVjdGlvbiB8IHR5cGVvZiB1bmRlZmluZWQpID0gdGhpcy5jb2xsZWN0aW9uc0J5TmFtZS5nZXQobmFtZSk7XG4gICAgICAgIGlmIChjb2xsZWN0aW9uKSB7XG4gICAgICAgICAgICBjb2xsZWN0aW9uLm9uRG9jdW1lbnRJbnNlcnRPclVwZGF0ZShkb2MpO1xuICAgICAgICB9XG4gICAgfVxuXG5cbiAgICBhc3luYyBxdWVyeShxdWVyeTogYW55LCBiaW5kVmFyczogYW55KSB7XG4gICAgICAgIHJldHVybiB3cmFwKHRoaXMubG9nLCAnUVVFUlknLCB7IHF1ZXJ5LCBiaW5kVmFycyB9LCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjdXJzb3IgPSBhd2FpdCB0aGlzLmRiLnF1ZXJ5KHsgcXVlcnksIGJpbmRWYXJzIH0pO1xuICAgICAgICAgICAgcmV0dXJuIGN1cnNvci5hbGwoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluaXNoT3BlcmF0aW9ucyhvcGVyYXRpb25JZHM6IFNldDxzdHJpbmc+KTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICAgICAgbGV0IGNvdW50ID0gMDtcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9ucy5mb3JFYWNoKHggPT4gKGNvdW50ICs9IHguZmluaXNoT3BlcmF0aW9ucyhvcGVyYXRpb25JZHMpKSk7XG4gICAgICAgIHJldHVybiBjb3VudDtcbiAgICB9XG59XG4iXX0=