"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _arangochair = _interopRequireDefault(require("arangochair"));

var _arangojs = require("arangojs");

var _arangoCollection = require("./arango-collection");

var _auth = require("./auth");

var _config = require("./config");

var _logs = _interopRequireDefault(require("./logs"));

var _resolversGenerated = require("./resolvers-generated");

var _opentracing = require("opentracing");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
class Arango {
  constructor(config, logs, auth, tracer, stats) {
    this.config = config;
    this.log = logs.create('db');
    this.auth = auth;
    this.serverAddress = config.database.server;
    this.databaseName = config.database.name;
    this.tracer = tracer;

    const createDb = config => {
      const db = new _arangojs.Database({
        url: `${(0, _config.ensureProtocol)(config.server, 'http')}`,
        agentOptions: {
          maxSockets: config.maxSockets
        }
      });
      db.useDatabase(config.name);

      if (config.auth) {
        const authParts = config.auth.split(':');
        db.useBasicAuth(authParts[0], authParts.slice(1).join(':'));
      }

      return db;
    };

    this.db = createDb(config.database);
    const slowDb = createDb(config.slowDatabase);
    this.collections = [];
    this.collectionsByName = new Map();

    const addCollection = (name, docType) => {
      const collection = new _arangoCollection.Collection(name, docType, logs, this.auth, this.tracer, stats, this.db, slowDb);
      this.collections.push(collection);
      this.collectionsByName.set(name, collection);
      return collection;
    };

    this.transactions = addCollection('transactions', _resolversGenerated.Transaction);
    this.messages = addCollection('messages', _resolversGenerated.Message);
    this.accounts = addCollection('accounts', _resolversGenerated.Account);
    this.blocks = addCollection('blocks', _resolversGenerated.Block);
    this.blocks_signatures = addCollection('blocks_signatures', _resolversGenerated.BlockSignatures);
  }

  start() {
    const listenerUrl = `${(0, _config.ensureProtocol)(this.serverAddress, 'http')}/${this.databaseName}`;
    this.listener = new _arangochair.default(listenerUrl);

    if (this.config.database.auth) {
      const userPassword = Buffer.from(this.config.database.auth).toString('base64');
      this.listener.req.opts.headers['Authorization'] = `Basic ${userPassword}`;
    }

    this.collections.forEach(collection => {
      const name = collection.name;
      this.listener.subscribe({
        collection: name
      });
      this.listener.on(name, (docJson, type) => {
        if (type === 'insert/update' || type === 'insert' || type === 'update') {
          this.onDocumentInsertOrUpdate(name, docJson);
        }
      });
    });
    this.listener.start();
    this.log.debug('LISTEN', listenerUrl);
    this.listener.on('error', (err, status, headers, body) => {
      let error = err;

      try {
        error = JSON.parse(body);
      } catch {}

      this.log.error('FAILED', 'LISTEN', `${err}`, error);
      setTimeout(() => this.listener.start(), this.config.listener.restartTimeout);
    });
  }

  onDocumentInsertOrUpdate(name, doc) {
    const collection = this.collectionsByName.get(name);

    if (collection) {
      collection.onDocumentInsertOrUpdate(doc);
    }
  }

  async query(query, bindVars) {
    return (0, _utils.wrap)(this.log, 'QUERY', {
      query,
      bindVars
    }, async () => {
      const cursor = await this.db.query({
        query,
        bindVars
      });
      return cursor.all();
    });
  }

  async finishOperations(operationIds) {
    let count = 0;
    this.collections.forEach(x => count += x.finishOperations(operationIds));
    return count;
  }

}

exports.default = Arango;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hcmFuZ28uanMiXSwibmFtZXMiOlsiQXJhbmdvIiwiY29uc3RydWN0b3IiLCJjb25maWciLCJsb2dzIiwiYXV0aCIsInRyYWNlciIsInN0YXRzIiwibG9nIiwiY3JlYXRlIiwic2VydmVyQWRkcmVzcyIsImRhdGFiYXNlIiwic2VydmVyIiwiZGF0YWJhc2VOYW1lIiwibmFtZSIsImNyZWF0ZURiIiwiZGIiLCJEYXRhYmFzZSIsInVybCIsImFnZW50T3B0aW9ucyIsIm1heFNvY2tldHMiLCJ1c2VEYXRhYmFzZSIsImF1dGhQYXJ0cyIsInNwbGl0IiwidXNlQmFzaWNBdXRoIiwic2xpY2UiLCJqb2luIiwic2xvd0RiIiwic2xvd0RhdGFiYXNlIiwiY29sbGVjdGlvbnMiLCJjb2xsZWN0aW9uc0J5TmFtZSIsIk1hcCIsImFkZENvbGxlY3Rpb24iLCJkb2NUeXBlIiwiY29sbGVjdGlvbiIsIkNvbGxlY3Rpb24iLCJwdXNoIiwic2V0IiwidHJhbnNhY3Rpb25zIiwiVHJhbnNhY3Rpb24iLCJtZXNzYWdlcyIsIk1lc3NhZ2UiLCJhY2NvdW50cyIsIkFjY291bnQiLCJibG9ja3MiLCJCbG9jayIsImJsb2Nrc19zaWduYXR1cmVzIiwiQmxvY2tTaWduYXR1cmVzIiwic3RhcnQiLCJsaXN0ZW5lclVybCIsImxpc3RlbmVyIiwiYXJhbmdvY2hhaXIiLCJ1c2VyUGFzc3dvcmQiLCJCdWZmZXIiLCJmcm9tIiwidG9TdHJpbmciLCJyZXEiLCJvcHRzIiwiaGVhZGVycyIsImZvckVhY2giLCJzdWJzY3JpYmUiLCJvbiIsImRvY0pzb24iLCJ0eXBlIiwib25Eb2N1bWVudEluc2VydE9yVXBkYXRlIiwiZGVidWciLCJlcnIiLCJzdGF0dXMiLCJib2R5IiwiZXJyb3IiLCJKU09OIiwicGFyc2UiLCJzZXRUaW1lb3V0IiwicmVzdGFydFRpbWVvdXQiLCJkb2MiLCJnZXQiLCJxdWVyeSIsImJpbmRWYXJzIiwiY3Vyc29yIiwiYWxsIiwiZmluaXNoT3BlcmF0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TSxDQUFQO0FBSUg7O0FBRUQsUUFBTUMsZ0JBQU4sQ0FBdUJDLFlBQXZCLEVBQW1FO0FBQy9ELFFBQUlDLEtBQUssR0FBRyxDQUFaO0FBQ0EsU0FBS3JELFdBQUwsQ0FBaUI4QixPQUFqQixDQUF5QndCLENBQUMsSUFBS0QsS0FBSyxJQUFJQyxDQUFDLENBQUNILGdCQUFGLENBQW1CQyxZQUFuQixDQUF4QztBQUNBLFdBQU9DLEtBQVA7QUFDSDs7QUFqSXVCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE4LTIwMjAgVE9OIERFViBTT0xVVElPTlMgTFRELlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBTT0ZUV0FSRSBFVkFMVUFUSU9OIExpY2Vuc2UgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZVxuICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlXG4gKiBMaWNlbnNlIGF0OlxuICpcbiAqIGh0dHA6Ly93d3cudG9uLmRldi9saWNlbnNlc1xuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgVE9OIERFViBzb2Z0d2FyZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vLyBAZmxvd1xuXG5pbXBvcnQgYXJhbmdvY2hhaXIgZnJvbSAnYXJhbmdvY2hhaXInO1xuaW1wb3J0IHsgRGF0YWJhc2UgfSBmcm9tICdhcmFuZ29qcyc7XG5pbXBvcnQgeyBDb2xsZWN0aW9ufSBmcm9tIFwiLi9hcmFuZ28tY29sbGVjdGlvblwiO1xuaW1wb3J0IHsgQXV0aCB9IGZyb20gXCIuL2F1dGhcIjtcbmltcG9ydCB0eXBlIHsgUUNvbmZpZywgUURiQ29uZmlnIH0gZnJvbSAnLi9jb25maWcnXG5pbXBvcnQgeyBlbnN1cmVQcm90b2NvbCB9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCB0eXBlIHsgUUxvZyB9IGZyb20gJy4vbG9ncyc7XG5pbXBvcnQgUUxvZ3MgZnJvbSAnLi9sb2dzJ1xuaW1wb3J0IHR5cGUgeyBRVHlwZSB9IGZyb20gJy4vZGItdHlwZXMnO1xuaW1wb3J0IHsgQWNjb3VudCwgQmxvY2ssIEJsb2NrU2lnbmF0dXJlcywgTWVzc2FnZSwgVHJhbnNhY3Rpb24gfSBmcm9tICcuL3Jlc29sdmVycy1nZW5lcmF0ZWQnO1xuaW1wb3J0IHsgVHJhY2VyIH0gZnJvbSBcIm9wZW50cmFjaW5nXCI7XG5pbXBvcnQgdHlwZSB7SVN0YXRzfSBmcm9tICcuL3RyYWNlcic7XG5pbXBvcnQge3dyYXB9IGZyb20gXCIuL3V0aWxzXCI7XG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXJhbmdvIHtcbiAgICBjb25maWc6IFFDb25maWc7XG4gICAgbG9nOiBRTG9nO1xuICAgIHNlcnZlckFkZHJlc3M6IHN0cmluZztcbiAgICBkYXRhYmFzZU5hbWU6IHN0cmluZztcbiAgICBkYjogRGF0YWJhc2U7XG5cbiAgICBhdXRoOiBBdXRoO1xuICAgIHRyYWNlcjogVHJhY2VyO1xuXG4gICAgdHJhbnNhY3Rpb25zOiBDb2xsZWN0aW9uO1xuICAgIG1lc3NhZ2VzOiBDb2xsZWN0aW9uO1xuICAgIGFjY291bnRzOiBDb2xsZWN0aW9uO1xuICAgIGJsb2NrczogQ29sbGVjdGlvbjtcbiAgICBibG9ja3Nfc2lnbmF0dXJlczogQ29sbGVjdGlvbjtcblxuICAgIGNvbGxlY3Rpb25zOiBDb2xsZWN0aW9uW107XG4gICAgY29sbGVjdGlvbnNCeU5hbWU6IE1hcDxzdHJpbmcsIENvbGxlY3Rpb24+O1xuXG4gICAgbGlzdGVuZXI6IGFueTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBjb25maWc6IFFDb25maWcsXG4gICAgICAgIGxvZ3M6IFFMb2dzLFxuICAgICAgICBhdXRoOiBBdXRoLFxuICAgICAgICB0cmFjZXI6IFRyYWNlcixcbiAgICAgICAgc3RhdHM6IElTdGF0cyxcbiAgICApIHtcbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgICAgIHRoaXMubG9nID0gbG9ncy5jcmVhdGUoJ2RiJyk7XG4gICAgICAgIHRoaXMuYXV0aCA9IGF1dGg7XG4gICAgICAgIHRoaXMuc2VydmVyQWRkcmVzcyA9IGNvbmZpZy5kYXRhYmFzZS5zZXJ2ZXI7XG4gICAgICAgIHRoaXMuZGF0YWJhc2VOYW1lID0gY29uZmlnLmRhdGFiYXNlLm5hbWU7XG4gICAgICAgIHRoaXMudHJhY2VyID0gdHJhY2VyO1xuXG4gICAgICAgIGNvbnN0IGNyZWF0ZURiID0gKGNvbmZpZzogUURiQ29uZmlnKTogRGF0YWJhc2UgPT4ge1xuICAgICAgICAgICAgY29uc3QgZGIgPSBuZXcgRGF0YWJhc2Uoe1xuICAgICAgICAgICAgICAgIHVybDogYCR7ZW5zdXJlUHJvdG9jb2woY29uZmlnLnNlcnZlciwgJ2h0dHAnKX1gLFxuICAgICAgICAgICAgICAgIGFnZW50T3B0aW9uczoge1xuICAgICAgICAgICAgICAgICAgICBtYXhTb2NrZXRzOiBjb25maWcubWF4U29ja2V0cyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBkYi51c2VEYXRhYmFzZShjb25maWcubmFtZSk7XG4gICAgICAgICAgICBpZiAoY29uZmlnLmF1dGgpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBhdXRoUGFydHMgPSBjb25maWcuYXV0aC5zcGxpdCgnOicpO1xuICAgICAgICAgICAgICAgIGRiLnVzZUJhc2ljQXV0aChhdXRoUGFydHNbMF0sIGF1dGhQYXJ0cy5zbGljZSgxKS5qb2luKCc6JykpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGRiO1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuZGIgPSBjcmVhdGVEYihjb25maWcuZGF0YWJhc2UpO1xuICAgICAgICBjb25zdCBzbG93RGIgPSBjcmVhdGVEYihjb25maWcuc2xvd0RhdGFiYXNlKTtcblxuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zID0gW107XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnNCeU5hbWUgPSBuZXcgTWFwKCk7XG5cbiAgICAgICAgY29uc3QgYWRkQ29sbGVjdGlvbiA9IChuYW1lOiBzdHJpbmcsIGRvY1R5cGU6IFFUeXBlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb2xsZWN0aW9uID0gbmV3IENvbGxlY3Rpb24oXG4gICAgICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgICAgICBkb2NUeXBlLFxuICAgICAgICAgICAgICAgIGxvZ3MsXG4gICAgICAgICAgICAgICAgdGhpcy5hdXRoLFxuICAgICAgICAgICAgICAgIHRoaXMudHJhY2VyLFxuICAgICAgICAgICAgICAgIHN0YXRzLFxuICAgICAgICAgICAgICAgIHRoaXMuZGIsXG4gICAgICAgICAgICAgICAgc2xvd0RiLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHRoaXMuY29sbGVjdGlvbnMucHVzaChjb2xsZWN0aW9uKTtcbiAgICAgICAgICAgIHRoaXMuY29sbGVjdGlvbnNCeU5hbWUuc2V0KG5hbWUsIGNvbGxlY3Rpb24pO1xuICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3Rpb247XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy50cmFuc2FjdGlvbnMgPSBhZGRDb2xsZWN0aW9uKCd0cmFuc2FjdGlvbnMnLCBUcmFuc2FjdGlvbik7XG4gICAgICAgIHRoaXMubWVzc2FnZXMgPSBhZGRDb2xsZWN0aW9uKCdtZXNzYWdlcycsIE1lc3NhZ2UpO1xuICAgICAgICB0aGlzLmFjY291bnRzID0gYWRkQ29sbGVjdGlvbignYWNjb3VudHMnLCBBY2NvdW50KTtcbiAgICAgICAgdGhpcy5ibG9ja3MgPSBhZGRDb2xsZWN0aW9uKCdibG9ja3MnLCBCbG9jayk7XG4gICAgICAgIHRoaXMuYmxvY2tzX3NpZ25hdHVyZXMgPSBhZGRDb2xsZWN0aW9uKCdibG9ja3Nfc2lnbmF0dXJlcycsIEJsb2NrU2lnbmF0dXJlcyk7XG4gICAgfVxuXG4gICAgc3RhcnQoKSB7XG4gICAgICAgIGNvbnN0IGxpc3RlbmVyVXJsID0gYCR7ZW5zdXJlUHJvdG9jb2wodGhpcy5zZXJ2ZXJBZGRyZXNzLCAnaHR0cCcpfS8ke3RoaXMuZGF0YWJhc2VOYW1lfWA7XG4gICAgICAgIHRoaXMubGlzdGVuZXIgPSBuZXcgYXJhbmdvY2hhaXIobGlzdGVuZXJVcmwpO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5kYXRhYmFzZS5hdXRoKSB7XG4gICAgICAgICAgICBjb25zdCB1c2VyUGFzc3dvcmQgPSBCdWZmZXIuZnJvbSh0aGlzLmNvbmZpZy5kYXRhYmFzZS5hdXRoKS50b1N0cmluZygnYmFzZTY0Jyk7XG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyLnJlcS5vcHRzLmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXSA9IGBCYXNpYyAke3VzZXJQYXNzd29yZH1gO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jb2xsZWN0aW9ucy5mb3JFYWNoKGNvbGxlY3Rpb24gPT4ge1xuICAgICAgICAgICAgY29uc3QgbmFtZSA9IGNvbGxlY3Rpb24ubmFtZTtcbiAgICAgICAgICAgIHRoaXMubGlzdGVuZXIuc3Vic2NyaWJlKHsgY29sbGVjdGlvbjogbmFtZSB9KTtcbiAgICAgICAgICAgIHRoaXMubGlzdGVuZXIub24obmFtZSwgKGRvY0pzb24sIHR5cGUpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2luc2VydC91cGRhdGUnIHx8IHR5cGUgPT09ICdpbnNlcnQnIHx8IHR5cGUgPT09ICd1cGRhdGUnKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25Eb2N1bWVudEluc2VydE9yVXBkYXRlKG5hbWUsIGRvY0pzb24pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5saXN0ZW5lci5zdGFydCgpO1xuICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnTElTVEVOJywgbGlzdGVuZXJVcmwpO1xuICAgICAgICB0aGlzLmxpc3RlbmVyLm9uKCdlcnJvcicsIChlcnIsIHN0YXR1cywgaGVhZGVycywgYm9keSkgPT4ge1xuICAgICAgICAgICAgbGV0IGVycm9yID0gZXJyO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBlcnJvciA9IEpTT04ucGFyc2UoYm9keSk7XG4gICAgICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdGQUlMRUQnLCAnTElTVEVOJywgYCR7ZXJyfWAsIGVycm9yKTtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5saXN0ZW5lci5zdGFydCgpLCB0aGlzLmNvbmZpZy5saXN0ZW5lci5yZXN0YXJ0VGltZW91dCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIG9uRG9jdW1lbnRJbnNlcnRPclVwZGF0ZShuYW1lOiBzdHJpbmcsIGRvYzogYW55KSB7XG4gICAgICAgIGNvbnN0IGNvbGxlY3Rpb246IChDb2xsZWN0aW9uIHwgdHlwZW9mIHVuZGVmaW5lZCkgPSB0aGlzLmNvbGxlY3Rpb25zQnlOYW1lLmdldChuYW1lKTtcbiAgICAgICAgaWYgKGNvbGxlY3Rpb24pIHtcbiAgICAgICAgICAgIGNvbGxlY3Rpb24ub25Eb2N1bWVudEluc2VydE9yVXBkYXRlKGRvYyk7XG4gICAgICAgIH1cbiAgICB9XG5cblxuICAgIGFzeW5jIHF1ZXJ5KHF1ZXJ5OiBhbnksIGJpbmRWYXJzOiBhbnkpIHtcbiAgICAgICAgcmV0dXJuIHdyYXAodGhpcy5sb2csICdRVUVSWScsIHsgcXVlcnksIGJpbmRWYXJzIH0sIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGN1cnNvciA9IGF3YWl0IHRoaXMuZGIucXVlcnkoeyBxdWVyeSwgYmluZFZhcnMgfSk7XG4gICAgICAgICAgICByZXR1cm4gY3Vyc29yLmFsbCgpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5pc2hPcGVyYXRpb25zKG9wZXJhdGlvbklkczogU2V0PHN0cmluZz4pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICBsZXQgY291bnQgPSAwO1xuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zLmZvckVhY2goeCA9PiAoY291bnQgKz0geC5maW5pc2hPcGVyYXRpb25zKG9wZXJhdGlvbklkcykpKTtcbiAgICAgICAgcmV0dXJuIGNvdW50O1xuICAgIH1cbn1cbiJdfQ==