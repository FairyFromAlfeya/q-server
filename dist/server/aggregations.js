"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.AggregationHelperFactory = exports.AggregationFn = void 0;

var _resolversGenerated = require("./resolvers-generated");

const AggregationFn = {
  COUNT: 'COUNT',
  MIN: 'MIN',
  MAX: 'MAX',
  SUM: 'SUM',
  AVERAGE: 'AVERAGE'
};
exports.AggregationFn = AggregationFn;

// Query Builders

/**
 * Returns query parts in form of:
 * { collect: 'a<i> = <exprs0>', result: 'a<i>'} if exprs.length === 1
 * or
 * { collect: 'a<i> = <exprs0>, b<i> = <exprs1>, ..'., result: '{ a: a<i>, b: b<i>, ... }'}
 * if exprs.length > 1
 *
 * @param exprs
 * @param context
 * @return {{result: string, collects: string}}
 */
function queryParts(context, ...exprs) {
  const n = 'abcdef';

  const v = i => `${n[i]}${context.index}`; // 'a0' | 'b0' | ...


  const collectExpr = (x, i) => `${v(i)} = ${x}`; // 'a0 = expr[0]' | 'b0 = expr[1]' | ...


  const returnExpr = (x, i) => `${n[i]}: ${v(i)}`; // 'a: a0' | 'b: b0' | ...


  return {
    collect: exprs.map(collectExpr).join(', '),
    // 'a0 = expr[0], b0 = expr[1], ...'
    result: exprs.length === 1 ? `${v(0)}` // 'a0'
    : `{ ${exprs.map(returnExpr).join(', ')} }` // '{ a: a0, b: b0, ... }'

  };
}

const countField = {
  type: 'string',
  path: ''
};

function count(context) {
  return queryParts(context, 'COUNT(doc)');
}

function simple(context) {
  const fn = context.fn;
  return queryParts(context, context.isArray ? `${fn}(${fn}(${context.field.path}))` : `${fn}(${context.field.path})`);
}

function bigIntToNum(hex) {
  return `TO_NUMBER(CONCAT("0x", ${hex}))`;
}

function bigIntHiPart(path, prefix) {
  return bigIntToNum(`SUBSTRING(${path}, ${prefix}, LENGTH(${path}) - ${prefix + 8})`);
}

function bigIntLoPart(path, prefix) {
  return bigIntToNum(`RIGHT(SUBSTRING(${path}, ${prefix}), 8)`);
}

function bigIntSumExpr(part, context) {
  const path = context.field.path;
  const prefix = context.bigIntPrefix;
  return context.isArray ? `SUM(SUM((${path})[* RETURN ${part('CURRENT', prefix)}]))` : `SUM(${part(path, prefix)})`;
}

function bigIntSum(context) {
  return queryParts(context, bigIntSumExpr(bigIntHiPart, context), bigIntSumExpr(bigIntLoPart, context));
}

function bigIntAvg(context) {
  return queryParts(context, bigIntSumExpr(bigIntHiPart, context), bigIntSumExpr(bigIntLoPart, context), context.isArray ? `SUM(COUNT(${context.field.path}))` : `COUNT(doc)`);
} // Result converters


function convertNone(context, value) {
  return value;
}

function bigIntString(context, value) {
  //$FlowFixMe
  return BigInt(`0x${value.substr(context.bigIntPrefix)}`).toString();
} //$FlowFixMe


function bigIntFromParts(parts) {
  const h = BigInt(`0x${Math.round(parts.a).toString(16)}00000000`);
  const l = BigInt(Math.round(parts.b));
  return h + l;
}

function bigIntParts(context, value) {
  return bigIntFromParts(value).toString();
}

function bigIntPartsAvg(context, value) {
  const sum = bigIntFromParts(value);
  const count = Number(value.c || 0);
  const avg = count > 0 ? sum / BigInt(Math.round(count)) : sum;
  return avg.toString();
}

class AggregationHelperFactory {
  static create(collection, index, aggregation) {
    const field = _resolversGenerated.scalarFields.get(`${collection}.${aggregation.field || 'id'}`) || countField;
    const fn = aggregation.fn || AggregationFn.COUNT;
    const context = {
      index,
      field,
      fn,
      bigIntPrefix: field.type === 'uint1024' ? 2 : field.type === 'uint64' ? 1 : 0,
      isArray: field.path.includes('[*]')
    };

    if (context.fn === AggregationFn.COUNT) {
      return {
        context,
        buildQuery: count,
        convertResult: convertNone
      };
    }

    if (context.field.path === '') {
      throw new Error(`[${aggregation.field}] can't be aggregated`);
    }

    if (fn === AggregationFn.MIN || fn === AggregationFn.MAX) {
      return {
        context,
        buildQuery: simple,
        convertResult: context.bigIntPrefix > 0 ? bigIntString : convertNone
      };
    }

    if (field.type === 'number') {
      return {
        context,
        buildQuery: simple,
        convertResult: convertNone
      };
    }

    if (context.bigIntPrefix > 0) {
      return context.fn === AggregationFn.AVERAGE ? {
        context,
        buildQuery: bigIntAvg,
        convertResult: bigIntPartsAvg
      } : {
        context,
        buildQuery: bigIntSum,
        convertResult: bigIntParts
      };
    }

    throw new Error(`[${aggregation.field}] can't be used with [${fn}]`);
  }

  static createQuery(collection, filter, fields) {
    const filterSection = filter ? `FILTER ${filter}` : '';
    const helpers = fields.map((aggregation, i) => {
      return AggregationHelperFactory.create(collection, i, aggregation);
    });
    let text;
    const isSingleCount = fields.length === 1 && fields[0].fn === AggregationFn.COUNT;

    if (isSingleCount) {
      text = `
                FOR doc IN ${this.name}
                ${filterSection}
                COLLECT WITH COUNT INTO a0
                RETURN [a0]`;
    } else {
      const queries = helpers.map(x => x.buildQuery(x.context));
      text = `
                FOR doc IN ${this.name}
                ${filterSection}
                COLLECT AGGREGATE ${queries.map(x => x.collect).join(', ')}
                RETURN [${queries.map(x => x.result).join(', ')}]`;
    }

    return {
      text,
      helpers
    };
  }

  static convertResults(results, helpers) {
    return results[0].map((x, i) => {
      if (x === undefined || x === null) {
        return x;
      }

      const helper = helpers[i];
      return helper.convertResult(helper.context, x);
    });
  }

}

exports.AggregationHelperFactory = AggregationHelperFactory;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hZ2dyZWdhdGlvbnMuanMiXSwibmFtZXMiOlsiQWdncmVnYXRpb25GbiIsIkNPVU5UIiwiTUlOIiwiTUFYIiwiU1VNIiwiQVZFUkFHRSIsInF1ZXJ5UGFydHMiLCJjb250ZXh0IiwiZXhwcnMiLCJuIiwidiIsImkiLCJpbmRleCIsImNvbGxlY3RFeHByIiwieCIsInJldHVybkV4cHIiLCJjb2xsZWN0IiwibWFwIiwiam9pbiIsInJlc3VsdCIsImxlbmd0aCIsImNvdW50RmllbGQiLCJ0eXBlIiwicGF0aCIsImNvdW50Iiwic2ltcGxlIiwiZm4iLCJpc0FycmF5IiwiZmllbGQiLCJiaWdJbnRUb051bSIsImhleCIsImJpZ0ludEhpUGFydCIsInByZWZpeCIsImJpZ0ludExvUGFydCIsImJpZ0ludFN1bUV4cHIiLCJwYXJ0IiwiYmlnSW50UHJlZml4IiwiYmlnSW50U3VtIiwiYmlnSW50QXZnIiwiY29udmVydE5vbmUiLCJ2YWx1ZSIsImJpZ0ludFN0cmluZyIsIkJpZ0ludCIsInN1YnN0ciIsInRvU3RyaW5nIiwiYmlnSW50RnJvbVBhcnRzIiwicGFydHMiLCJoIiwiTWF0aCIsInJvdW5kIiwiYSIsImwiLCJiIiwiYmlnSW50UGFydHMiLCJiaWdJbnRQYXJ0c0F2ZyIsInN1bSIsIk51bWJlciIsImMiLCJhdmciLCJBZ2dyZWdhdGlvbkhlbHBlckZhY3RvcnkiLCJjcmVhdGUiLCJjb2xsZWN0aW9uIiwiYWdncmVnYXRpb24iLCJzY2FsYXJGaWVsZHMiLCJnZXQiLCJpbmNsdWRlcyIsImJ1aWxkUXVlcnkiLCJjb252ZXJ0UmVzdWx0IiwiRXJyb3IiLCJjcmVhdGVRdWVyeSIsImZpbHRlciIsImZpZWxkcyIsImZpbHRlclNlY3Rpb24iLCJoZWxwZXJzIiwidGV4dCIsImlzU2luZ2xlQ291bnQiLCJuYW1lIiwicXVlcmllcyIsImNvbnZlcnRSZXN1bHRzIiwicmVzdWx0cyIsInVuZGVmaW5lZCIsImhlbHBlciJdLCJtYXBwaW5ncyI6Ijs7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R0osT0FBTyxDQUFDeEQsR0FBUixDQUFZSCxDQUFDLElBQUlBLENBQUMsQ0FBQ29ELFVBQUYsQ0FBYXBELENBQUMsQ0FBQ1AsT0FBZixDQUFqQixDQUFoQjtBQUNBbUUsTUFBQUEsSUFBSSxHQUFJOzZCQUNTLEtBQUtFLElBQUs7a0JBQ3JCSixhQUFjO29DQUNJSyxPQUFPLENBQUM1RCxHQUFSLENBQVlILENBQUMsSUFBSUEsQ0FBQyxDQUFDRSxPQUFuQixFQUE0QkUsSUFBNUIsQ0FBaUMsSUFBakMsQ0FBdUM7MEJBQ2pEMkQsT0FBTyxDQUFDNUQsR0FBUixDQUFZSCxDQUFDLElBQUlBLENBQUMsQ0FBQ0ssTUFBbkIsRUFBMkJELElBQTNCLENBQWdDLElBQWhDLENBQXNDLEdBSnBEO0FBS0g7O0FBQ0QsV0FBTztBQUNId0QsTUFBQUEsSUFERztBQUVIRCxNQUFBQTtBQUZHLEtBQVA7QUFJSDs7QUFFRCxTQUFPSyxjQUFQLENBQXNCQyxPQUF0QixFQUFzQ04sT0FBdEMsRUFBMkU7QUFDdkUsV0FBT00sT0FBTyxDQUFDLENBQUQsQ0FBUCxDQUFXOUQsR0FBWCxDQUFlLENBQUNILENBQUQsRUFBSUgsQ0FBSixLQUFVO0FBQzVCLFVBQUlHLENBQUMsS0FBS2tFLFNBQU4sSUFBbUJsRSxDQUFDLEtBQUssSUFBN0IsRUFBbUM7QUFDL0IsZUFBT0EsQ0FBUDtBQUNIOztBQUNELFlBQU1tRSxNQUFNLEdBQUdSLE9BQU8sQ0FBQzlELENBQUQsQ0FBdEI7QUFDQSxhQUFPc0UsTUFBTSxDQUFDZCxhQUFQLENBQXFCYyxNQUFNLENBQUMxRSxPQUE1QixFQUFxQ08sQ0FBckMsQ0FBUDtBQUNILEtBTk0sQ0FBUDtBQVFIOztBQXZHaUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgdHlwZSB7IFNjYWxhckZpZWxkIH0gZnJvbSBcIi4vZGItdHlwZXNcIjtcbmltcG9ydCB7IHNjYWxhckZpZWxkcyB9IGZyb20gXCIuL3Jlc29sdmVycy1nZW5lcmF0ZWRcIjtcblxuZXhwb3J0IGNvbnN0IEFnZ3JlZ2F0aW9uRm4gPSB7XG4gICAgQ09VTlQ6ICdDT1VOVCcsXG4gICAgTUlOOiAnTUlOJyxcbiAgICBNQVg6ICdNQVgnLFxuICAgIFNVTTogJ1NVTScsXG4gICAgQVZFUkFHRTogJ0FWRVJBR0UnLFxufVxuXG5leHBvcnQgdHlwZSBBZ2dyZWdhdGlvbkZuVHlwZSA9ICRLZXlzPHR5cGVvZiBBZ2dyZWdhdGlvbkZuPjtcblxuZXhwb3J0IHR5cGUgRmllbGRBZ2dyZWdhdGlvbiA9IHtcbiAgICBmaWVsZDogc3RyaW5nLFxuICAgIGZuOiBBZ2dyZWdhdGlvbkZuVHlwZSxcbn1cblxudHlwZSBBZ2dyZWdhdGlvbkNvbnRleHQgPSB7XG4gICAgaW5kZXg6IG51bWJlcixcbiAgICBmaWVsZDogU2NhbGFyRmllbGQsXG4gICAgZm46IEFnZ3JlZ2F0aW9uRm5UeXBlLFxuICAgIGJpZ0ludFByZWZpeDogbnVtYmVyLFxuICAgIGlzQXJyYXk6IGJvb2xlYW4sXG59XG5cbnR5cGUgQWdncmVnYXRpb25RdWVyeVBhcnRzID0ge1xuICAgIGNvbGxlY3Q6IHN0cmluZyxcbiAgICByZXN1bHQ6IHN0cmluZyxcbn1cblxuZXhwb3J0IHR5cGUgQWdncmVnYXRpb25IZWxwZXIgPSB7XG4gICAgY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LFxuICAgIGJ1aWxkUXVlcnk6IChjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQpID0+IEFnZ3JlZ2F0aW9uUXVlcnlQYXJ0cyxcbiAgICBjb252ZXJ0UmVzdWx0OiAoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZTogYW55KSA9PiBhbnksXG59XG5cbi8vIFF1ZXJ5IEJ1aWxkZXJzXG5cbi8qKlxuICogUmV0dXJucyBxdWVyeSBwYXJ0cyBpbiBmb3JtIG9mOlxuICogeyBjb2xsZWN0OiAnYTxpPiA9IDxleHByczA+JywgcmVzdWx0OiAnYTxpPid9IGlmIGV4cHJzLmxlbmd0aCA9PT0gMVxuICogb3JcbiAqIHsgY29sbGVjdDogJ2E8aT4gPSA8ZXhwcnMwPiwgYjxpPiA9IDxleHByczE+LCAuLicuLCByZXN1bHQ6ICd7IGE6IGE8aT4sIGI6IGI8aT4sIC4uLiB9J31cbiAqIGlmIGV4cHJzLmxlbmd0aCA+IDFcbiAqXG4gKiBAcGFyYW0gZXhwcnNcbiAqIEBwYXJhbSBjb250ZXh0XG4gKiBAcmV0dXJuIHt7cmVzdWx0OiBzdHJpbmcsIGNvbGxlY3RzOiBzdHJpbmd9fVxuICovXG5mdW5jdGlvbiBxdWVyeVBhcnRzKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgLi4uZXhwcnM6IHN0cmluZ1tdKTogQWdncmVnYXRpb25RdWVyeVBhcnRzIHtcbiAgICBjb25zdCBuID0gJ2FiY2RlZic7XG4gICAgY29uc3QgdiA9IChpKSA9PiBgJHtuW2ldfSR7Y29udGV4dC5pbmRleH1gOyAvLyAnYTAnIHwgJ2IwJyB8IC4uLlxuICAgIGNvbnN0IGNvbGxlY3RFeHByID0gKHgsIGkpID0+IGAke3YoaSl9ID0gJHt4fWA7IC8vICdhMCA9IGV4cHJbMF0nIHwgJ2IwID0gZXhwclsxXScgfCAuLi5cbiAgICBjb25zdCByZXR1cm5FeHByID0gKHgsIGkpID0+IGAke25baV19OiAke3YoaSl9YDsgLy8gJ2E6IGEwJyB8ICdiOiBiMCcgfCAuLi5cbiAgICByZXR1cm4ge1xuICAgICAgICBjb2xsZWN0OiBleHBycy5tYXAoY29sbGVjdEV4cHIpLmpvaW4oJywgJyksIC8vICdhMCA9IGV4cHJbMF0sIGIwID0gZXhwclsxXSwgLi4uJ1xuICAgICAgICByZXN1bHQ6IGV4cHJzLmxlbmd0aCA9PT0gMVxuICAgICAgICAgICAgPyBgJHt2KDApfWAgLy8gJ2EwJ1xuICAgICAgICAgICAgOiBgeyAke2V4cHJzLm1hcChyZXR1cm5FeHByKS5qb2luKCcsICcpfSB9YCwgLy8gJ3sgYTogYTAsIGI6IGIwLCAuLi4gfSdcbiAgICB9XG59XG5cbmNvbnN0IGNvdW50RmllbGQ6IFNjYWxhckZpZWxkID0ge1xuICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgIHBhdGg6ICcnLFxufTtcblxuZnVuY3Rpb24gY291bnQoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0KTogQWdncmVnYXRpb25RdWVyeVBhcnRzIHtcbiAgICByZXR1cm4gcXVlcnlQYXJ0cyhjb250ZXh0LCAnQ09VTlQoZG9jKScpO1xufVxuXG5mdW5jdGlvbiBzaW1wbGUoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0KTogQWdncmVnYXRpb25RdWVyeVBhcnRzIHtcbiAgICBjb25zdCBmbiA9IGNvbnRleHQuZm47XG4gICAgcmV0dXJuIHF1ZXJ5UGFydHMoY29udGV4dCwgY29udGV4dC5pc0FycmF5XG4gICAgICAgID8gYCR7Zm59KCR7Zm59KCR7Y29udGV4dC5maWVsZC5wYXRofSkpYFxuICAgICAgICA6IGAke2ZufSgke2NvbnRleHQuZmllbGQucGF0aH0pYFxuICAgICk7XG59XG5cbmZ1bmN0aW9uIGJpZ0ludFRvTnVtKGhleDogYW55KTogc3RyaW5nIHtcbiAgICByZXR1cm4gYFRPX05VTUJFUihDT05DQVQoXCIweFwiLCAkeyhoZXg6IGFueSl9KSlgXG59XG5cbmZ1bmN0aW9uIGJpZ0ludEhpUGFydChwYXRoOiBzdHJpbmcsIHByZWZpeDogbnVtYmVyKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYmlnSW50VG9OdW0oYFNVQlNUUklORygke3BhdGh9LCAke3ByZWZpeH0sIExFTkdUSCgke3BhdGh9KSAtICR7cHJlZml4ICsgOH0pYCk7XG59XG5cbmZ1bmN0aW9uIGJpZ0ludExvUGFydChwYXRoOiBzdHJpbmcsIHByZWZpeDogbnVtYmVyKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYmlnSW50VG9OdW0oYFJJR0hUKFNVQlNUUklORygke3BhdGh9LCAke3ByZWZpeH0pLCA4KWApO1xufVxuXG5mdW5jdGlvbiBiaWdJbnRTdW1FeHByKHBhcnQ6IChwYXRoOiBzdHJpbmcsIHByZWZpeDogbnVtYmVyKSA9PiBzdHJpbmcsIGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCkge1xuICAgIGNvbnN0IHBhdGggPSBjb250ZXh0LmZpZWxkLnBhdGg7XG4gICAgY29uc3QgcHJlZml4ID0gY29udGV4dC5iaWdJbnRQcmVmaXg7XG4gICAgcmV0dXJuIGNvbnRleHQuaXNBcnJheVxuICAgICAgICA/IGBTVU0oU1VNKCgke3BhdGh9KVsqIFJFVFVSTiAke3BhcnQoJ0NVUlJFTlQnLCBwcmVmaXgpfV0pKWBcbiAgICAgICAgOiBgU1VNKCR7cGFydChwYXRoLCBwcmVmaXgpfSlgO1xufVxuXG5mdW5jdGlvbiBiaWdJbnRTdW0oY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0KTogQWdncmVnYXRpb25RdWVyeVBhcnRzIHtcbiAgICByZXR1cm4gcXVlcnlQYXJ0cyhcbiAgICAgICAgY29udGV4dCxcbiAgICAgICAgYmlnSW50U3VtRXhwcihiaWdJbnRIaVBhcnQsIGNvbnRleHQpLFxuICAgICAgICBiaWdJbnRTdW1FeHByKGJpZ0ludExvUGFydCwgY29udGV4dCksXG4gICAgKTtcbn1cblxuZnVuY3Rpb24gYmlnSW50QXZnKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCk6IEFnZ3JlZ2F0aW9uUXVlcnlQYXJ0cyB7XG4gICAgcmV0dXJuIHF1ZXJ5UGFydHMoXG4gICAgICAgIGNvbnRleHQsXG4gICAgICAgIGJpZ0ludFN1bUV4cHIoYmlnSW50SGlQYXJ0LCBjb250ZXh0KSxcbiAgICAgICAgYmlnSW50U3VtRXhwcihiaWdJbnRMb1BhcnQsIGNvbnRleHQpLFxuICAgICAgICBjb250ZXh0LmlzQXJyYXlcbiAgICAgICAgICAgID8gYFNVTShDT1VOVCgke2NvbnRleHQuZmllbGQucGF0aH0pKWBcbiAgICAgICAgICAgIDogYENPVU5UKGRvYylgLFxuICAgICk7XG59XG5cbi8vIFJlc3VsdCBjb252ZXJ0ZXJzXG5cbmZ1bmN0aW9uIGNvbnZlcnROb25lKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgdmFsdWU6IGFueSk6IGFueSB7XG4gICAgcmV0dXJuIHZhbHVlO1xufVxuXG5mdW5jdGlvbiBiaWdJbnRTdHJpbmcoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZTogYW55KTogYW55IHtcbiAgICAvLyRGbG93Rml4TWVcbiAgICByZXR1cm4gQmlnSW50KGAweCR7dmFsdWUuc3Vic3RyKGNvbnRleHQuYmlnSW50UHJlZml4KX1gKS50b1N0cmluZygpO1xufVxuXG4vLyRGbG93Rml4TWVcbmZ1bmN0aW9uIGJpZ0ludEZyb21QYXJ0cyhwYXJ0czogeyBhOiBudW1iZXIsIGI6IG51bWJlciB9KTogQmlnSW50IHtcbiAgICBjb25zdCBoID0gQmlnSW50KGAweCR7TWF0aC5yb3VuZChwYXJ0cy5hKS50b1N0cmluZygxNil9MDAwMDAwMDBgKTtcbiAgICBjb25zdCBsID0gQmlnSW50KE1hdGgucm91bmQocGFydHMuYikpO1xuICAgIHJldHVybiBoICsgbDtcbn1cblxuZnVuY3Rpb24gYmlnSW50UGFydHMoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZTogYW55KTogYW55IHtcbiAgICByZXR1cm4gYmlnSW50RnJvbVBhcnRzKHZhbHVlKS50b1N0cmluZygpO1xufVxuXG5mdW5jdGlvbiBiaWdJbnRQYXJ0c0F2Zyhjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlOiBhbnkpOiBhbnkge1xuICAgIGNvbnN0IHN1bSA9IGJpZ0ludEZyb21QYXJ0cyh2YWx1ZSk7XG4gICAgY29uc3QgY291bnQgPSBOdW1iZXIodmFsdWUuYyB8fCAwKTtcbiAgICBjb25zdCBhdmcgPSBjb3VudCA+IDAgPyAoc3VtIC8gQmlnSW50KE1hdGgucm91bmQoY291bnQpKSkgOiBzdW07XG4gICAgcmV0dXJuIGF2Zy50b1N0cmluZygpO1xufVxuXG5leHBvcnQgY2xhc3MgQWdncmVnYXRpb25IZWxwZXJGYWN0b3J5IHtcbiAgICBzdGF0aWMgY3JlYXRlKGNvbGxlY3Rpb246IHN0cmluZywgaW5kZXg6IG51bWJlciwgYWdncmVnYXRpb246IEZpZWxkQWdncmVnYXRpb24pOiBBZ2dyZWdhdGlvbkhlbHBlciB7XG4gICAgICAgIGNvbnN0IGZpZWxkID0gc2NhbGFyRmllbGRzLmdldChgJHtjb2xsZWN0aW9ufS4ke2FnZ3JlZ2F0aW9uLmZpZWxkIHx8ICdpZCd9YCkgfHwgY291bnRGaWVsZDtcbiAgICAgICAgY29uc3QgZm4gPSBhZ2dyZWdhdGlvbi5mbiB8fCBBZ2dyZWdhdGlvbkZuLkNPVU5UO1xuICAgICAgICBjb25zdCBjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQgPSB7XG4gICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgIGZpZWxkLFxuICAgICAgICAgICAgZm4sXG4gICAgICAgICAgICBiaWdJbnRQcmVmaXg6IChmaWVsZC50eXBlID09PSAndWludDEwMjQnKSA/IDIgOiAoZmllbGQudHlwZSA9PT0gJ3VpbnQ2NCcgPyAxIDogMCksXG4gICAgICAgICAgICBpc0FycmF5OiBmaWVsZC5wYXRoLmluY2x1ZGVzKCdbKl0nKSxcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoY29udGV4dC5mbiA9PT0gQWdncmVnYXRpb25Gbi5DT1VOVCkge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICAgIGJ1aWxkUXVlcnk6IGNvdW50LFxuICAgICAgICAgICAgICAgIGNvbnZlcnRSZXN1bHQ6IGNvbnZlcnROb25lLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb250ZXh0LmZpZWxkLnBhdGggPT09ICcnKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske2FnZ3JlZ2F0aW9uLmZpZWxkfV0gY2FuJ3QgYmUgYWdncmVnYXRlZGApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZuID09PSBBZ2dyZWdhdGlvbkZuLk1JTiB8fCBmbiA9PT0gQWdncmVnYXRpb25Gbi5NQVgpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgICBidWlsZFF1ZXJ5OiBzaW1wbGUsXG4gICAgICAgICAgICAgICAgY29udmVydFJlc3VsdDogY29udGV4dC5iaWdJbnRQcmVmaXggPiAwXG4gICAgICAgICAgICAgICAgICAgID8gYmlnSW50U3RyaW5nXG4gICAgICAgICAgICAgICAgICAgIDogY29udmVydE5vbmUsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZpZWxkLnR5cGUgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgICAgYnVpbGRRdWVyeTogc2ltcGxlLFxuICAgICAgICAgICAgICAgIGNvbnZlcnRSZXN1bHQ6IGNvbnZlcnROb25lLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb250ZXh0LmJpZ0ludFByZWZpeCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiAoY29udGV4dC5mbiA9PT0gQWdncmVnYXRpb25Gbi5BVkVSQUdFKVxuICAgICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICBidWlsZFF1ZXJ5OiBiaWdJbnRBdmcsXG4gICAgICAgICAgICAgICAgICAgIGNvbnZlcnRSZXN1bHQ6IGJpZ0ludFBhcnRzQXZnLFxuICAgICAgICAgICAgICAgIH0gOiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgICAgICAgIGJ1aWxkUXVlcnk6IGJpZ0ludFN1bSxcbiAgICAgICAgICAgICAgICAgICAgY29udmVydFJlc3VsdDogYmlnSW50UGFydHMsXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske2FnZ3JlZ2F0aW9uLmZpZWxkfV0gY2FuJ3QgYmUgdXNlZCB3aXRoIFske2ZufV1gKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgY3JlYXRlUXVlcnkoXG4gICAgICAgIGNvbGxlY3Rpb246IHN0cmluZyxcbiAgICAgICAgZmlsdGVyOiBzdHJpbmcsXG4gICAgICAgIGZpZWxkczogRmllbGRBZ2dyZWdhdGlvbltdLFxuICAgICk6IHtcbiAgICAgICAgdGV4dDogc3RyaW5nLFxuICAgICAgICBoZWxwZXJzOiBBZ2dyZWdhdGlvbkhlbHBlcltdLFxuICAgIH0ge1xuICAgICAgICBjb25zdCBmaWx0ZXJTZWN0aW9uID0gZmlsdGVyID8gYEZJTFRFUiAke2ZpbHRlcn1gIDogJyc7XG4gICAgICAgIGNvbnN0IGhlbHBlcnM6IEFnZ3JlZ2F0aW9uSGVscGVyW10gPSBmaWVsZHMubWFwKChhZ2dyZWdhdGlvbiwgaSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIEFnZ3JlZ2F0aW9uSGVscGVyRmFjdG9yeS5jcmVhdGUoY29sbGVjdGlvbiwgaSwgYWdncmVnYXRpb24pO1xuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgdGV4dDtcbiAgICAgICAgY29uc3QgaXNTaW5nbGVDb3VudCA9IChmaWVsZHMubGVuZ3RoID09PSAxKSAmJiAoZmllbGRzWzBdLmZuID09PSBBZ2dyZWdhdGlvbkZuLkNPVU5UKTtcbiAgICAgICAgaWYgKGlzU2luZ2xlQ291bnQpIHtcbiAgICAgICAgICAgIHRleHQgPSBgXG4gICAgICAgICAgICAgICAgRk9SIGRvYyBJTiAke3RoaXMubmFtZX1cbiAgICAgICAgICAgICAgICAke2ZpbHRlclNlY3Rpb259XG4gICAgICAgICAgICAgICAgQ09MTEVDVCBXSVRIIENPVU5UIElOVE8gYTBcbiAgICAgICAgICAgICAgICBSRVRVUk4gW2EwXWA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBxdWVyaWVzID0gaGVscGVycy5tYXAoeCA9PiB4LmJ1aWxkUXVlcnkoeC5jb250ZXh0KSk7XG4gICAgICAgICAgICB0ZXh0ID0gYFxuICAgICAgICAgICAgICAgIEZPUiBkb2MgSU4gJHt0aGlzLm5hbWV9XG4gICAgICAgICAgICAgICAgJHtmaWx0ZXJTZWN0aW9ufVxuICAgICAgICAgICAgICAgIENPTExFQ1QgQUdHUkVHQVRFICR7cXVlcmllcy5tYXAoeCA9PiB4LmNvbGxlY3QpLmpvaW4oJywgJyl9XG4gICAgICAgICAgICAgICAgUkVUVVJOIFske3F1ZXJpZXMubWFwKHggPT4geC5yZXN1bHQpLmpvaW4oJywgJyl9XWA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRleHQsXG4gICAgICAgICAgICBoZWxwZXJzLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHN0YXRpYyBjb252ZXJ0UmVzdWx0cyhyZXN1bHRzOiBhbnlbXSwgaGVscGVyczogQWdncmVnYXRpb25IZWxwZXJbXSk6IGFueVtdIHtcbiAgICAgICAgcmV0dXJuIHJlc3VsdHNbMF0ubWFwKCh4LCBpKSA9PiB7XG4gICAgICAgICAgICBpZiAoeCA9PT0gdW5kZWZpbmVkIHx8IHggPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGhlbHBlciA9IGhlbHBlcnNbaV07XG4gICAgICAgICAgICByZXR1cm4gaGVscGVyLmNvbnZlcnRSZXN1bHQoaGVscGVyLmNvbnRleHQsIHgpO1xuICAgICAgICB9KTtcblxuICAgIH1cbn1cblxuIl19