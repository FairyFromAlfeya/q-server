"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.AggregationHelperFactory = exports.AggregationFn = void 0;

var _resolversGenerated = require("./resolvers-generated");

const AggregationFn = {
  COUNT: 'COUNT',
  MIN: 'MIN',
  MAX: 'MAX',
  SUM: 'SUM',
  AVERAGE: 'AVERAGE'
};
exports.AggregationFn = AggregationFn;

// Query Builders

/**
 * Returns query parts in form of:
 * { collect: 'a<i> = <exprs0>', result: 'a<i>'} if exprs.length === 1
 * or
 * { collect: 'a<i> = <exprs0>, b<i> = <exprs1>, ..'., result: '{ a: a<i>, b: b<i>, ... }'}
 * if exprs.length > 1
 *
 * @param exprs
 * @param context
 * @return {{result: string, collects: string}}
 */
function queryParts(context, ...exprs) {
  const n = 'abcdef';

  const v = i => `${n[i]}${context.index}`; // 'a0' | 'b0' | ...


  const collectExpr = (x, i) => `${v(i)} = ${x}`; // 'a0 = expr[0]' | 'b0 = expr[1]' | ...


  const returnExpr = (x, i) => `${n[i]}: ${v(i)}`; // 'a: a0' | 'b: b0' | ...


  return {
    collect: exprs.map(collectExpr).join(', '),
    // 'a0 = expr[0], b0 = expr[1], ...'
    result: exprs.length === 1 ? `${v(0)}` // 'a0'
    : `{ ${exprs.map(returnExpr).join(', ')} }` // '{ a: a0, b: b0, ... }'

  };
}

const countField = {
  type: 'string',
  path: ''
};

function count(context) {
  return queryParts(context, 'COUNT(doc)');
}

function simple(context) {
  const fn = context.fn;
  return queryParts(context, context.isArray ? `${fn}(${fn}(${context.field.path}))` : `${fn}(${context.field.path})`);
}

function bigIntToNum(hex) {
  return `TO_NUMBER(CONCAT("0x", ${hex}))`;
}

function bigIntHiPart(path, prefix) {
  return bigIntToNum(`SUBSTRING(${path}, ${prefix}, LENGTH(${path}) - ${prefix + 8})`);
}

function bigIntLoPart(path, prefix) {
  return bigIntToNum(`RIGHT(SUBSTRING(${path}, ${prefix}), 8)`);
}

function bigIntSumExpr(part, context) {
  const path = context.field.path;
  const prefix = context.bigIntPrefix;
  return context.isArray ? `SUM(SUM((${path})[* RETURN ${part('CURRENT', prefix)}]))` : `SUM(${part(path, prefix)})`;
}

function bigIntSum(context) {
  return queryParts(context, bigIntSumExpr(bigIntHiPart, context), bigIntSumExpr(bigIntLoPart, context));
}

function bigIntAvg(context) {
  return queryParts(context, bigIntSumExpr(bigIntHiPart, context), bigIntSumExpr(bigIntLoPart, context), context.isArray ? `SUM(COUNT(${context.field.path}))` : `COUNT(doc)`);
} // Result converters


function convertNone(context, value) {
  return value;
}

function bigIntString(context, value) {
  if (typeof value === 'number') {
    return value.toString();
  } //$FlowFixMe


  return BigInt(`0x${value.substr(context.bigIntPrefix)}`).toString();
} //$FlowFixMe


function bigIntFromParts(parts) {
  const h = BigInt(`0x${Math.round(parts.a).toString(16)}00000000`);
  const l = BigInt(Math.round(parts.b));
  return h + l;
}

function bigIntParts(context, value) {
  return bigIntFromParts(value).toString();
}

function bigIntPartsAvg(context, value) {
  const sum = bigIntFromParts(value);
  const count = Number(value.c || 0);
  const avg = count > 0 ? sum / BigInt(Math.round(count)) : sum;
  return avg.toString();
}

class AggregationHelperFactory {
  static create(collection, index, aggregation) {
    const field = _resolversGenerated.scalarFields.get(`${collection}.${aggregation.field || 'id'}`) || countField;
    const fn = aggregation.fn || AggregationFn.COUNT;
    const context = {
      index,
      field,
      fn,
      bigIntPrefix: field.type === 'uint1024' ? 2 : field.type === 'uint64' ? 1 : 0,
      isArray: field.path.includes('[*]')
    };

    if (context.fn === AggregationFn.COUNT) {
      return {
        context,
        buildQuery: count,
        convertResult: convertNone
      };
    }

    if (context.field.path === '') {
      throw new Error(`[${aggregation.field}] can't be aggregated`);
    }

    if (fn === AggregationFn.MIN || fn === AggregationFn.MAX) {
      return {
        context,
        buildQuery: simple,
        convertResult: context.bigIntPrefix > 0 ? bigIntString : convertNone
      };
    }

    if (field.type === 'number') {
      return {
        context,
        buildQuery: simple,
        convertResult: convertNone
      };
    }

    if (context.bigIntPrefix > 0) {
      return context.fn === AggregationFn.AVERAGE ? {
        context,
        buildQuery: bigIntAvg,
        convertResult: bigIntPartsAvg
      } : {
        context,
        buildQuery: bigIntSum,
        convertResult: bigIntParts
      };
    }

    throw new Error(`[${aggregation.field}] can't be used with [${fn}]`);
  }

  static createQuery(collection, filter, argFields) {
    const filterSection = filter ? `FILTER ${filter}` : '';
    const fields = Array.isArray(argFields) && argFields.length > 0 ? argFields : [{
      field: '',
      fn: AggregationFn.COUNT
    }];
    const helpers = fields.map((aggregation, i) => {
      return AggregationHelperFactory.create(collection, i, aggregation);
    });
    let text;
    const isSingleCount = fields.length === 1 && fields[0].fn === AggregationFn.COUNT;

    if (isSingleCount) {
      if (filterSection !== '') {
        text = `
                    FOR doc IN ${collection}
                    ${filterSection}
                    COLLECT WITH COUNT INTO a0
                    RETURN [a0]`;
      } else {
        text = `RETURN [LENGTH(${collection})]`;
      }
    } else {
      const queries = helpers.map(x => x.buildQuery(x.context));
      text = `
                FOR doc IN ${collection}
                ${filterSection}
                COLLECT AGGREGATE ${queries.map(x => x.collect).join(', ')}
                RETURN [${queries.map(x => x.result).join(', ')}]`;
    }

    return {
      text,
      helpers
    };
  }

  static convertResults(results, helpers) {
    return results.map((x, i) => {
      if (x === undefined || x === null) {
        return x;
      }

      const helper = helpers[i];
      return helper.convertResult(helper.context, x);
    });
  }

}

exports.AggregationHelperFactory = AggregationHelperFactory;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hZ2dyZWdhdGlvbnMuanMiXSwibmFtZXMiOlsiQWdncmVnYXRpb25GbiIsIkNPVU5UIiwiTUlOIiwiTUFYIiwiU1VNIiwiQVZFUkFHRSIsInF1ZXJ5UGFydHMiLCJjb250ZXh0IiwiZXhwcnMiLCJuIiwidiIsImkiLCJpbmRleCIsImNvbGxlY3RFeHByIiwieCIsInJldHVybkV4cHIiLCJjb2xsZWN0IiwibWFwIiwiam9pbiIsInJlc3VsdCIsImxlbmd0aCIsImNvdW50RmllbGQiLCJ0eXBlIiwicGF0aCIsImNvdW50Iiwic2ltcGxlIiwiZm4iLCJpc0FycmF5IiwiZmllbGQiLCJiaWdJbnRUb051bSIsImhleCIsImJpZ0ludEhpUGFydCIsInByZWZpeCIsImJpZ0ludExvUGFydCIsImJpZ0ludFN1bUV4cHIiLCJwYXJ0IiwiYmlnSW50UHJlZml4IiwiYmlnSW50U3VtIiwiYmlnSW50QXZnIiwiY29udmVydE5vbmUiLCJ2YWx1ZSIsImJpZ0ludFN0cmluZyIsInRvU3RyaW5nIiwiQmlnSW50Iiwic3Vic3RyIiwiYmlnSW50RnJvbVBhcnRzIiwicGFydHMiLCJoIiwiTWF0aCIsInJvdW5kIiwiYSIsImwiLCJiIiwiYmlnSW50UGFydHMiLCJiaWdJbnRQYXJ0c0F2ZyIsInN1bSIsIk51bWJlciIsImMiLCJhdmciLCJBZ2dyZWdhdGlvbkhlbHBlckZhY3RvcnkiLCJjcmVhdGUiLCJjb2xsZWN0aW9uIiwiYWdncmVnYXRpb24iLCJzY2FsYXJGaWVsZHMiLCJnZXQiLCJpbmNsdWRlcyIsImJ1aWxkUXVlcnkiLCJjb252ZXJ0UmVzdWx0IiwiRXJyb3IiLCJjcmVhdGVRdWVyeSIsImZpbHRlciIsImFyZ0ZpZWxkcyIsImZpbHRlclNlY3Rpb24iLCJmaWVsZHMiLCJBcnJheSIsImhlbHBlcnMiLCJ0ZXh0IiwiaXNTaW5nbGVDb3VudCIsInF1ZXJpZXMiLCJjb252ZXJ0UmVzdWx0cyIsInJlc3VsdHMiLCJ1bmRlZmluZWQiLCJoZWxwZXIiXSwi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bUUsU0FBTixJQUFtQm5FLENBQUMsS0FBSyxJQUE3QixFQUFtQztBQUMvQixlQUFPQSxDQUFQO0FBQ0g7O0FBQ0QsWUFBTW9FLE1BQU0sR0FBR1AsT0FBTyxDQUFDaEUsQ0FBRCxDQUF0QjtBQUNBLGFBQU91RSxNQUFNLENBQUNmLGFBQVAsQ0FBcUJlLE1BQU0sQ0FBQzNFLE9BQTVCLEVBQXFDTyxDQUFyQyxDQUFQO0FBQ0gsS0FOTSxDQUFQO0FBUUg7O0FBOUdpQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB0eXBlIHsgU2NhbGFyRmllbGQgfSBmcm9tIFwiLi9kYi10eXBlc1wiO1xuaW1wb3J0IHsgc2NhbGFyRmllbGRzIH0gZnJvbSBcIi4vcmVzb2x2ZXJzLWdlbmVyYXRlZFwiO1xuXG5leHBvcnQgY29uc3QgQWdncmVnYXRpb25GbiA9IHtcbiAgICBDT1VOVDogJ0NPVU5UJyxcbiAgICBNSU46ICdNSU4nLFxuICAgIE1BWDogJ01BWCcsXG4gICAgU1VNOiAnU1VNJyxcbiAgICBBVkVSQUdFOiAnQVZFUkFHRScsXG59XG5cbmV4cG9ydCB0eXBlIEFnZ3JlZ2F0aW9uRm5UeXBlID0gJEtleXM8dHlwZW9mIEFnZ3JlZ2F0aW9uRm4+O1xuXG5leHBvcnQgdHlwZSBGaWVsZEFnZ3JlZ2F0aW9uID0ge1xuICAgIGZpZWxkOiBzdHJpbmcsXG4gICAgZm46IEFnZ3JlZ2F0aW9uRm5UeXBlLFxufVxuXG50eXBlIEFnZ3JlZ2F0aW9uQ29udGV4dCA9IHtcbiAgICBpbmRleDogbnVtYmVyLFxuICAgIGZpZWxkOiBTY2FsYXJGaWVsZCxcbiAgICBmbjogQWdncmVnYXRpb25GblR5cGUsXG4gICAgYmlnSW50UHJlZml4OiBudW1iZXIsXG4gICAgaXNBcnJheTogYm9vbGVhbixcbn1cblxudHlwZSBBZ2dyZWdhdGlvblF1ZXJ5UGFydHMgPSB7XG4gICAgY29sbGVjdDogc3RyaW5nLFxuICAgIHJlc3VsdDogc3RyaW5nLFxufVxuXG5leHBvcnQgdHlwZSBBZ2dyZWdhdGlvbkhlbHBlciA9IHtcbiAgICBjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsXG4gICAgYnVpbGRRdWVyeTogKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCkgPT4gQWdncmVnYXRpb25RdWVyeVBhcnRzLFxuICAgIGNvbnZlcnRSZXN1bHQ6IChjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlOiBhbnkpID0+IGFueSxcbn1cblxuLy8gUXVlcnkgQnVpbGRlcnNcblxuLyoqXG4gKiBSZXR1cm5zIHF1ZXJ5IHBhcnRzIGluIGZvcm0gb2Y6XG4gKiB7IGNvbGxlY3Q6ICdhPGk+ID0gPGV4cHJzMD4nLCByZXN1bHQ6ICdhPGk+J30gaWYgZXhwcnMubGVuZ3RoID09PSAxXG4gKiBvclxuICogeyBjb2xsZWN0OiAnYTxpPiA9IDxleHByczA+LCBiPGk+ID0gPGV4cHJzMT4sIC4uJy4sIHJlc3VsdDogJ3sgYTogYTxpPiwgYjogYjxpPiwgLi4uIH0nfVxuICogaWYgZXhwcnMubGVuZ3RoID4gMVxuICpcbiAqIEBwYXJhbSBleHByc1xuICogQHBhcmFtIGNvbnRleHRcbiAqIEByZXR1cm4ge3tyZXN1bHQ6IHN0cmluZywgY29sbGVjdHM6IHN0cmluZ319XG4gKi9cbmZ1bmN0aW9uIHF1ZXJ5UGFydHMoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCAuLi5leHByczogc3RyaW5nW10pOiBBZ2dyZWdhdGlvblF1ZXJ5UGFydHMge1xuICAgIGNvbnN0IG4gPSAnYWJjZGVmJztcbiAgICBjb25zdCB2ID0gKGkpID0+IGAke25baV19JHtjb250ZXh0LmluZGV4fWA7IC8vICdhMCcgfCAnYjAnIHwgLi4uXG4gICAgY29uc3QgY29sbGVjdEV4cHIgPSAoeCwgaSkgPT4gYCR7dihpKX0gPSAke3h9YDsgLy8gJ2EwID0gZXhwclswXScgfCAnYjAgPSBleHByWzFdJyB8IC4uLlxuICAgIGNvbnN0IHJldHVybkV4cHIgPSAoeCwgaSkgPT4gYCR7bltpXX06ICR7dihpKX1gOyAvLyAnYTogYTAnIHwgJ2I6IGIwJyB8IC4uLlxuICAgIHJldHVybiB7XG4gICAgICAgIGNvbGxlY3Q6IGV4cHJzLm1hcChjb2xsZWN0RXhwcikuam9pbignLCAnKSwgLy8gJ2EwID0gZXhwclswXSwgYjAgPSBleHByWzFdLCAuLi4nXG4gICAgICAgIHJlc3VsdDogZXhwcnMubGVuZ3RoID09PSAxXG4gICAgICAgICAgICA/IGAke3YoMCl9YCAvLyAnYTAnXG4gICAgICAgICAgICA6IGB7ICR7ZXhwcnMubWFwKHJldHVybkV4cHIpLmpvaW4oJywgJyl9IH1gLCAvLyAneyBhOiBhMCwgYjogYjAsIC4uLiB9J1xuICAgIH1cbn1cblxuY29uc3QgY291bnRGaWVsZDogU2NhbGFyRmllbGQgPSB7XG4gICAgdHlwZTogJ3N0cmluZycsXG4gICAgcGF0aDogJycsXG59O1xuXG5mdW5jdGlvbiBjb3VudChjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQpOiBBZ2dyZWdhdGlvblF1ZXJ5UGFydHMge1xuICAgIHJldHVybiBxdWVyeVBhcnRzKGNvbnRleHQsICdDT1VOVChkb2MpJyk7XG59XG5cbmZ1bmN0aW9uIHNpbXBsZShjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQpOiBBZ2dyZWdhdGlvblF1ZXJ5UGFydHMge1xuICAgIGNvbnN0IGZuID0gY29udGV4dC5mbjtcbiAgICByZXR1cm4gcXVlcnlQYXJ0cyhjb250ZXh0LCBjb250ZXh0LmlzQXJyYXlcbiAgICAgICAgPyBgJHtmbn0oJHtmbn0oJHtjb250ZXh0LmZpZWxkLnBhdGh9KSlgXG4gICAgICAgIDogYCR7Zm59KCR7Y29udGV4dC5maWVsZC5wYXRofSlgXG4gICAgKTtcbn1cblxuZnVuY3Rpb24gYmlnSW50VG9OdW0oaGV4OiBhbnkpOiBzdHJpbmcge1xuICAgIHJldHVybiBgVE9fTlVNQkVSKENPTkNBVChcIjB4XCIsICR7KGhleDogYW55KX0pKWBcbn1cblxuZnVuY3Rpb24gYmlnSW50SGlQYXJ0KHBhdGg6IHN0cmluZywgcHJlZml4OiBudW1iZXIpOiBzdHJpbmcge1xuICAgIHJldHVybiBiaWdJbnRUb051bShgU1VCU1RSSU5HKCR7cGF0aH0sICR7cHJlZml4fSwgTEVOR1RIKCR7cGF0aH0pIC0gJHtwcmVmaXggKyA4fSlgKTtcbn1cblxuZnVuY3Rpb24gYmlnSW50TG9QYXJ0KHBhdGg6IHN0cmluZywgcHJlZml4OiBudW1iZXIpOiBzdHJpbmcge1xuICAgIHJldHVybiBiaWdJbnRUb051bShgUklHSFQoU1VCU1RSSU5HKCR7cGF0aH0sICR7cHJlZml4fSksIDgpYCk7XG59XG5cbmZ1bmN0aW9uIGJpZ0ludFN1bUV4cHIocGFydDogKHBhdGg6IHN0cmluZywgcHJlZml4OiBudW1iZXIpID0+IHN0cmluZywgY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0KSB7XG4gICAgY29uc3QgcGF0aCA9IGNvbnRleHQuZmllbGQucGF0aDtcbiAgICBjb25zdCBwcmVmaXggPSBjb250ZXh0LmJpZ0ludFByZWZpeDtcbiAgICByZXR1cm4gY29udGV4dC5pc0FycmF5XG4gICAgICAgID8gYFNVTShTVU0oKCR7cGF0aH0pWyogUkVUVVJOICR7cGFydCgnQ1VSUkVOVCcsIHByZWZpeCl9XSkpYFxuICAgICAgICA6IGBTVU0oJHtwYXJ0KHBhdGgsIHByZWZpeCl9KWA7XG59XG5cbmZ1bmN0aW9uIGJpZ0ludFN1bShjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQpOiBBZ2dyZWdhdGlvblF1ZXJ5UGFydHMge1xuICAgIHJldHVybiBxdWVyeVBhcnRzKFxuICAgICAgICBjb250ZXh0LFxuICAgICAgICBiaWdJbnRTdW1FeHByKGJpZ0ludEhpUGFydCwgY29udGV4dCksXG4gICAgICAgIGJpZ0ludFN1bUV4cHIoYmlnSW50TG9QYXJ0LCBjb250ZXh0KSxcbiAgICApO1xufVxuXG5mdW5jdGlvbiBiaWdJbnRBdmcoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0KTogQWdncmVnYXRpb25RdWVyeVBhcnRzIHtcbiAgICByZXR1cm4gcXVlcnlQYXJ0cyhcbiAgICAgICAgY29udGV4dCxcbiAgICAgICAgYmlnSW50U3VtRXhwcihiaWdJbnRIaVBhcnQsIGNvbnRleHQpLFxuICAgICAgICBiaWdJbnRTdW1FeHByKGJpZ0ludExvUGFydCwgY29udGV4dCksXG4gICAgICAgIGNvbnRleHQuaXNBcnJheVxuICAgICAgICAgICAgPyBgU1VNKENPVU5UKCR7Y29udGV4dC5maWVsZC5wYXRofSkpYFxuICAgICAgICAgICAgOiBgQ09VTlQoZG9jKWAsXG4gICAgKTtcbn1cblxuLy8gUmVzdWx0IGNvbnZlcnRlcnNcblxuZnVuY3Rpb24gY29udmVydE5vbmUoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZTogYW55KTogYW55IHtcbiAgICByZXR1cm4gdmFsdWU7XG59XG5cbmZ1bmN0aW9uIGJpZ0ludFN0cmluZyhjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlOiBhbnkpOiBhbnkge1xuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZS50b1N0cmluZygpO1xuICAgIH1cbiAgICAvLyRGbG93Rml4TWVcbiAgICByZXR1cm4gQmlnSW50KGAweCR7dmFsdWUuc3Vic3RyKGNvbnRleHQuYmlnSW50UHJlZml4KX1gKS50b1N0cmluZygpO1xufVxuXG4vLyRGbG93Rml4TWVcbmZ1bmN0aW9uIGJpZ0ludEZyb21QYXJ0cyhwYXJ0czogeyBhOiBudW1iZXIsIGI6IG51bWJlciB9KTogQmlnSW50IHtcbiAgICBjb25zdCBoID0gQmlnSW50KGAweCR7TWF0aC5yb3VuZChwYXJ0cy5hKS50b1N0cmluZygxNil9MDAwMDAwMDBgKTtcbiAgICBjb25zdCBsID0gQmlnSW50KE1hdGgucm91bmQocGFydHMuYikpO1xuICAgIHJldHVybiBoICsgbDtcbn1cblxuZnVuY3Rpb24gYmlnSW50UGFydHMoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZTogYW55KTogYW55IHtcbiAgICByZXR1cm4gYmlnSW50RnJvbVBhcnRzKHZhbHVlKS50b1N0cmluZygpO1xufVxuXG5mdW5jdGlvbiBiaWdJbnRQYXJ0c0F2Zyhjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlOiBhbnkpOiBhbnkge1xuICAgIGNvbnN0IHN1bSA9IGJpZ0ludEZyb21QYXJ0cyh2YWx1ZSk7XG4gICAgY29uc3QgY291bnQgPSBOdW1iZXIodmFsdWUuYyB8fCAwKTtcbiAgICBjb25zdCBhdmcgPSBjb3VudCA+IDAgPyAoc3VtIC8gQmlnSW50KE1hdGgucm91bmQoY291bnQpKSkgOiBzdW07XG4gICAgcmV0dXJuIGF2Zy50b1N0cmluZygpO1xufVxuXG5leHBvcnQgY2xhc3MgQWdncmVnYXRpb25IZWxwZXJGYWN0b3J5IHtcbiAgICBzdGF0aWMgY3JlYXRlKGNvbGxlY3Rpb246IHN0cmluZywgaW5kZXg6IG51bWJlciwgYWdncmVnYXRpb246IEZpZWxkQWdncmVnYXRpb24pOiBBZ2dyZWdhdGlvbkhlbHBlciB7XG4gICAgICAgIGNvbnN0IGZpZWxkID0gc2NhbGFyRmllbGRzLmdldChgJHtjb2xsZWN0aW9ufS4ke2FnZ3JlZ2F0aW9uLmZpZWxkIHx8ICdpZCd9YCkgfHwgY291bnRGaWVsZDtcbiAgICAgICAgY29uc3QgZm4gPSBhZ2dyZWdhdGlvbi5mbiB8fCBBZ2dyZWdhdGlvbkZuLkNPVU5UO1xuICAgICAgICBjb25zdCBjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQgPSB7XG4gICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgIGZpZWxkLFxuICAgICAgICAgICAgZm4sXG4gICAgICAgICAgICBiaWdJbnRQcmVmaXg6IChmaWVsZC50eXBlID09PSAndWludDEwMjQnKSA/IDIgOiAoZmllbGQudHlwZSA9PT0gJ3VpbnQ2NCcgPyAxIDogMCksXG4gICAgICAgICAgICBpc0FycmF5OiBmaWVsZC5wYXRoLmluY2x1ZGVzKCdbKl0nKSxcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoY29udGV4dC5mbiA9PT0gQWdncmVnYXRpb25Gbi5DT1VOVCkge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICAgIGJ1aWxkUXVlcnk6IGNvdW50LFxuICAgICAgICAgICAgICAgIGNvbnZlcnRSZXN1bHQ6IGNvbnZlcnROb25lLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb250ZXh0LmZpZWxkLnBhdGggPT09ICcnKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske2FnZ3JlZ2F0aW9uLmZpZWxkfV0gY2FuJ3QgYmUgYWdncmVnYXRlZGApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZuID09PSBBZ2dyZWdhdGlvbkZuLk1JTiB8fCBmbiA9PT0gQWdncmVnYXRpb25Gbi5NQVgpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgICBidWlsZFF1ZXJ5OiBzaW1wbGUsXG4gICAgICAgICAgICAgICAgY29udmVydFJlc3VsdDogY29udGV4dC5iaWdJbnRQcmVmaXggPiAwXG4gICAgICAgICAgICAgICAgICAgID8gYmlnSW50U3RyaW5nXG4gICAgICAgICAgICAgICAgICAgIDogY29udmVydE5vbmUsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZpZWxkLnR5cGUgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgICAgYnVpbGRRdWVyeTogc2ltcGxlLFxuICAgICAgICAgICAgICAgIGNvbnZlcnRSZXN1bHQ6IGNvbnZlcnROb25lLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb250ZXh0LmJpZ0ludFByZWZpeCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiAoY29udGV4dC5mbiA9PT0gQWdncmVnYXRpb25Gbi5BVkVSQUdFKVxuICAgICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICBidWlsZFF1ZXJ5OiBiaWdJbnRBdmcsXG4gICAgICAgICAgICAgICAgICAgIGNvbnZlcnRSZXN1bHQ6IGJpZ0ludFBhcnRzQXZnLFxuICAgICAgICAgICAgICAgIH0gOiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgICAgICAgIGJ1aWxkUXVlcnk6IGJpZ0ludFN1bSxcbiAgICAgICAgICAgICAgICAgICAgY29udmVydFJlc3VsdDogYmlnSW50UGFydHMsXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske2FnZ3JlZ2F0aW9uLmZpZWxkfV0gY2FuJ3QgYmUgdXNlZCB3aXRoIFske2ZufV1gKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgY3JlYXRlUXVlcnkoXG4gICAgICAgIGNvbGxlY3Rpb246IHN0cmluZyxcbiAgICAgICAgZmlsdGVyOiBzdHJpbmcsXG4gICAgICAgIGFyZ0ZpZWxkczogRmllbGRBZ2dyZWdhdGlvbltdIHwgdHlwZW9mIHVuZGVmaW5lZCxcbiAgICApOiB7XG4gICAgICAgIHRleHQ6IHN0cmluZyxcbiAgICAgICAgaGVscGVyczogQWdncmVnYXRpb25IZWxwZXJbXSxcbiAgICB9IHtcbiAgICAgICAgY29uc3QgZmlsdGVyU2VjdGlvbiA9IGZpbHRlciA/IGBGSUxURVIgJHtmaWx0ZXJ9YCA6ICcnO1xuICAgICAgICBjb25zdCBmaWVsZHM6IEZpZWxkQWdncmVnYXRpb25bXSA9IChBcnJheS5pc0FycmF5KGFyZ0ZpZWxkcykgJiYgYXJnRmllbGRzLmxlbmd0aCA+IDApXG4gICAgICAgICAgICA/IGFyZ0ZpZWxkc1xuICAgICAgICAgICAgOiBbeyBmaWVsZDogJycsIGZuOiBBZ2dyZWdhdGlvbkZuLkNPVU5UIH1dO1xuICAgICAgICBjb25zdCBoZWxwZXJzOiBBZ2dyZWdhdGlvbkhlbHBlcltdID0gZmllbGRzLm1hcCgoYWdncmVnYXRpb24sIGkpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBBZ2dyZWdhdGlvbkhlbHBlckZhY3RvcnkuY3JlYXRlKGNvbGxlY3Rpb24sIGksIGFnZ3JlZ2F0aW9uKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IHRleHQ7XG4gICAgICAgIGNvbnN0IGlzU2luZ2xlQ291bnQgPSAoZmllbGRzLmxlbmd0aCA9PT0gMSkgJiYgKGZpZWxkc1swXS5mbiA9PT0gQWdncmVnYXRpb25Gbi5DT1VOVCk7XG4gICAgICAgIGlmIChpc1NpbmdsZUNvdW50KSB7XG4gICAgICAgICAgICBpZiAoZmlsdGVyU2VjdGlvbiAhPT0gJycpIHtcbiAgICAgICAgICAgICAgICB0ZXh0ID0gYFxuICAgICAgICAgICAgICAgICAgICBGT1IgZG9jIElOICR7Y29sbGVjdGlvbn1cbiAgICAgICAgICAgICAgICAgICAgJHtmaWx0ZXJTZWN0aW9ufVxuICAgICAgICAgICAgICAgICAgICBDT0xMRUNUIFdJVEggQ09VTlQgSU5UTyBhMFxuICAgICAgICAgICAgICAgICAgICBSRVRVUk4gW2EwXWA7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRleHQgPSBgUkVUVVJOIFtMRU5HVEgoJHtjb2xsZWN0aW9ufSldYDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHF1ZXJpZXMgPSBoZWxwZXJzLm1hcCh4ID0+IHguYnVpbGRRdWVyeSh4LmNvbnRleHQpKTtcbiAgICAgICAgICAgIHRleHQgPSBgXG4gICAgICAgICAgICAgICAgRk9SIGRvYyBJTiAke2NvbGxlY3Rpb259XG4gICAgICAgICAgICAgICAgJHtmaWx0ZXJTZWN0aW9ufVxuICAgICAgICAgICAgICAgIENPTExFQ1QgQUdHUkVHQVRFICR7cXVlcmllcy5tYXAoeCA9PiB4LmNvbGxlY3QpLmpvaW4oJywgJyl9XG4gICAgICAgICAgICAgICAgUkVUVVJOIFske3F1ZXJpZXMubWFwKHggPT4geC5yZXN1bHQpLmpvaW4oJywgJyl9XWA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRleHQsXG4gICAgICAgICAgICBoZWxwZXJzLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHN0YXRpYyBjb252ZXJ0UmVzdWx0cyhyZXN1bHRzOiBhbnlbXSwgaGVscGVyczogQWdncmVnYXRpb25IZWxwZXJbXSk6IGFueVtdIHtcbiAgICAgICAgcmV0dXJuIHJlc3VsdHMubWFwKCh4LCBpKSA9PiB7XG4gICAgICAgICAgICBpZiAoeCA9PT0gdW5kZWZpbmVkIHx8IHggPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGhlbHBlciA9IGhlbHBlcnNbaV07XG4gICAgICAgICAgICByZXR1cm4gaGVscGVyLmNvbnZlcnRSZXN1bHQoaGVscGVyLmNvbnRleHQsIHgpO1xuICAgICAgICB9KTtcblxuICAgIH1cbn1cblxuIl19