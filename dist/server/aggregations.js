"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.AggregationHelperFactory = exports.AggregationFn = void 0;

var _resolversGenerated = require("./resolvers-generated");

const AggregationFn = {
  COUNT: 'COUNT',
  MIN: 'MIN',
  MAX: 'MAX',
  SUM: 'SUM',
  AVERAGE: 'AVERAGE'
};
exports.AggregationFn = AggregationFn;

// Query Builders

/**
 * Returns query parts in form of:
 * { collect: 'a<i> = <exprs0>', result: 'a<i>'} if exprs.length === 1
 * or
 * { collect: 'a<i> = <exprs0>, b<i> = <exprs1>, ..'., result: '{ a: a<i>, b: b<i>, ... }'}
 * if exprs.length > 1
 *
 * @param exprs
 * @param context
 * @return {{result: string, collects: string}}
 */
function queryParts(context, ...exprs) {
  const n = 'abcdef';

  const v = i => `${n[i]}${context.index}`; // 'a0' | 'b0' | ...


  const collectExpr = (x, i) => `${v(i)} = ${x}`; // 'a0 = expr[0]' | 'b0 = expr[1]' | ...


  const returnExpr = (x, i) => `${n[i]}: ${v(i)}`; // 'a: a0' | 'b: b0' | ...


  return {
    collect: exprs.map(collectExpr).join(', '),
    // 'a0 = expr[0], b0 = expr[1], ...'
    result: exprs.length === 1 ? `${v(0)}` // 'a0'
    : `{ ${exprs.map(returnExpr).join(', ')} }` // '{ a: a0, b: b0, ... }'

  };
}

const countField = {
  type: 'string',
  path: ''
};

function count(context) {
  return queryParts(context, 'COUNT(doc)');
}

function simple(context) {
  const fn = context.fn;
  return queryParts(context, context.isArray ? `${fn}(${fn}(${context.field.path}))` : `${fn}(${context.field.path})`);
}

function bigIntToNum(hex) {
  return `TO_NUMBER(CONCAT("0x", ${hex}))`;
}

function bigIntHiPart(path, prefix) {
  return bigIntToNum(`SUBSTRING(${path}, ${prefix}, LENGTH(${path}) - ${prefix + 8})`);
}

function bigIntLoPart(path, prefix) {
  return bigIntToNum(`RIGHT(SUBSTRING(${path}, ${prefix}), 8)`);
}

function bigIntSumExpr(part, context) {
  const path = context.field.path;
  const prefix = context.bigIntPrefix;
  return context.isArray ? `SUM(SUM((${path})[* RETURN ${part('CURRENT', prefix)}]))` : `SUM(${part(path, prefix)})`;
}

function bigIntSum(context) {
  return queryParts(context, bigIntSumExpr(bigIntHiPart, context), bigIntSumExpr(bigIntLoPart, context));
}

function bigIntAvg(context) {
  return queryParts(context, bigIntSumExpr(bigIntHiPart, context), bigIntSumExpr(bigIntLoPart, context), context.isArray ? `SUM(COUNT(${context.field.path}))` : `COUNT(doc)`);
} // Result converters


function convertNone(context, value) {
  return value;
}

function bigIntString(context, value) {
  //$FlowFixMe
  return BigInt(`0x${value.substr(context.bigIntPrefix)}`).toString();
} //$FlowFixMe


function bigIntFromParts(parts) {
  const h = BigInt(`0x${Math.round(parts.a).toString(16)}00000000`);
  const l = BigInt(Math.round(parts.b));
  return h + l;
}

function bigIntParts(context, value) {
  return bigIntFromParts(value).toString();
}

function bigIntPartsAvg(context, value) {
  const sum = bigIntFromParts(value);
  const count = Number(value.c || 0);
  const avg = count > 0 ? sum / BigInt(Math.round(count)) : sum;
  return avg.toString();
}

class AggregationHelperFactory {
  static create(collection, index, aggregation) {
    const field = _resolversGenerated.scalarFields.get(`${collection}.${aggregation.field || 'id'}`) || countField;
    const fn = aggregation.fn || AggregationFn.COUNT;
    const context = {
      index,
      field,
      fn,
      bigIntPrefix: field.type === 'uint1024' ? 2 : field.type === 'uint64' ? 1 : 0,
      isArray: field.path.includes('[*]')
    };

    if (context.fn === AggregationFn.COUNT) {
      return {
        context,
        buildQuery: count,
        convertResult: convertNone
      };
    }

    if (context.field.path === '') {
      throw new Error(`[${aggregation.field}] can't be aggregated`);
    }

    if (fn === AggregationFn.MIN || fn === AggregationFn.MAX) {
      return {
        context,
        buildQuery: simple,
        convertResult: context.bigIntPrefix > 0 ? bigIntString : convertNone
      };
    }

    if (field.type === 'number') {
      return {
        context,
        buildQuery: simple,
        convertResult: convertNone
      };
    }

    if (context.bigIntPrefix > 0) {
      return context.fn === AggregationFn.AVERAGE ? {
        context,
        buildQuery: bigIntAvg,
        convertResult: bigIntPartsAvg
      } : {
        context,
        buildQuery: bigIntSum,
        convertResult: bigIntParts
      };
    }

    throw new Error(`[${aggregation.field}] can't be used with [${fn}]`);
  }

  static createQuery(collection, filter, argFields) {
    const filterSection = filter ? `FILTER ${filter}` : '';
    const fields = Array.isArray(argFields) && argFields.length > 0 ? argFields : [{
      field: '',
      fn: AggregationFn.COUNT
    }];
    const helpers = fields.map((aggregation, i) => {
      return AggregationHelperFactory.create(collection, i, aggregation);
    });
    let text;
    const isSingleCount = fields.length === 1 && fields[0].fn === AggregationFn.COUNT;

    if (isSingleCount) {
      if (filterSection !== '') {
        text = `
                    FOR doc IN ${collection}
                    ${filterSection}
                    COLLECT WITH COUNT INTO a0
                    RETURN [a0]`;
      } else {
        text = `RETURN [LENGTH(${collection})]`;
      }
    } else {
      const queries = helpers.map(x => x.buildQuery(x.context));
      text = `
                FOR doc IN ${collection}
                ${filterSection}
                COLLECT AGGREGATE ${queries.map(x => x.collect).join(', ')}
                RETURN [${queries.map(x => x.result).join(', ')}]`;
    }

    return {
      text,
      helpers
    };
  }

  static convertResults(results, helpers) {
    return results.map((x, i) => {
      if (x === undefined || x === null) {
        return x;
      }

      const helper = helpers[i];
      return helper.convertResult(helper.context, x);
    });
  }

}

exports.AggregationHelperFactory = AggregationHelperFactory;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hZ2dyZWdhdGlvbnMuanMiXSwibmFtZXMiOlsiQWdncmVnYXRpb25GbiIsIkNPVU5UIiwiTUlOIiwiTUFYIiwiU1VNIiwiQVZFUkFHRSIsInF1ZXJ5UGFydHMiLCJjb250ZXh0IiwiZXhwcnMiLCJuIiwidiIsImkiLCJpbmRleCIsImNvbGxlY3RFeHByIiwieCIsInJldHVybkV4cHIiLCJjb2xsZWN0IiwibWFwIiwiam9pbiIsInJlc3VsdCIsImxlbmd0aCIsImNvdW50RmllbGQiLCJ0eXBlIiwicGF0aCIsImNvdW50Iiwic2ltcGxlIiwiZm4iLCJpc0FycmF5IiwiZmllbGQiLCJiaWdJbnRUb051bSIsImhleCIsImJpZ0ludEhpUGFydCIsInByZWZpeCIsImJpZ0ludExvUGFydCIsImJpZ0ludFN1bUV4cHIiLCJwYXJ0IiwiYmlnSW50UHJlZml4IiwiYmlnSW50U3VtIiwiYmlnSW50QXZnIiwiY29udmVydE5vbmUiLCJ2YWx1ZSIsImJpZ0ludFN0cmluZyIsIkJpZ0ludCIsInN1YnN0ciIsInRvU3RyaW5nIiwiYmlnSW50RnJvbVBhcnRzIiwicGFydHMiLCJoIiwiTWF0aCIsInJvdW5kIiwiYSIsImwiLCJiIiwiYmlnSW50UGFydHMiLCJiaWdJbnRQYXJ0c0F2ZyIsInN1bSIsIk51bWJlciIsImMiLCJhdmciLCJBZ2dyZWdhdGlvbkhlbHBlckZhY3RvcnkiLCJjcmVhdGUiLCJjb2xsZWN0aW9uIiwiYWdncmVnYXRpb24iLCJzY2FsYXJGaWVsZHMiLCJnZXQiLCJpbmNsdWRlcyIsImJ1aWxkUXVlcnkiLCJjb252ZXJ0UmVzdWx0IiwiRXJyb3IiLCJjcmVhdGVRdWVyeSIsImZpbHRlciIsImFyZ0ZpZWxkcyIsImZpbHRlclNlY3Rpb24iLCJmaWVsZHMiLCJBcnJheSIsImhlbHBlcnMiLCJ0ZXh0IiwiaXNTaW5nbGVDb3VudCIsInF1ZXJpZXMiLCJjb252ZXJ0UmVzdWx0cyIsInJlc3VsdHMiLCJ1bmRlZmluZWQiLCJoZWxwZXIiXSwi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LENBQUNoRSxDQUFELENBQXRCO0FBQ0EsYUFBT3VFLE1BQU0sQ0FBQ2YsYUFBUCxDQUFxQmUsTUFBTSxDQUFDM0UsT0FBNUIsRUFBcUNPLENBQXJDLENBQVA7QUFDSCxLQU5NLENBQVA7QUFRSDs7QUE5R2lDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHR5cGUgeyBTY2FsYXJGaWVsZCB9IGZyb20gXCIuL2RiLXR5cGVzXCI7XG5pbXBvcnQgeyBzY2FsYXJGaWVsZHMgfSBmcm9tIFwiLi9yZXNvbHZlcnMtZ2VuZXJhdGVkXCI7XG5cbmV4cG9ydCBjb25zdCBBZ2dyZWdhdGlvbkZuID0ge1xuICAgIENPVU5UOiAnQ09VTlQnLFxuICAgIE1JTjogJ01JTicsXG4gICAgTUFYOiAnTUFYJyxcbiAgICBTVU06ICdTVU0nLFxuICAgIEFWRVJBR0U6ICdBVkVSQUdFJyxcbn1cblxuZXhwb3J0IHR5cGUgQWdncmVnYXRpb25GblR5cGUgPSAkS2V5czx0eXBlb2YgQWdncmVnYXRpb25Gbj47XG5cbmV4cG9ydCB0eXBlIEZpZWxkQWdncmVnYXRpb24gPSB7XG4gICAgZmllbGQ6IHN0cmluZyxcbiAgICBmbjogQWdncmVnYXRpb25GblR5cGUsXG59XG5cbnR5cGUgQWdncmVnYXRpb25Db250ZXh0ID0ge1xuICAgIGluZGV4OiBudW1iZXIsXG4gICAgZmllbGQ6IFNjYWxhckZpZWxkLFxuICAgIGZuOiBBZ2dyZWdhdGlvbkZuVHlwZSxcbiAgICBiaWdJbnRQcmVmaXg6IG51bWJlcixcbiAgICBpc0FycmF5OiBib29sZWFuLFxufVxuXG50eXBlIEFnZ3JlZ2F0aW9uUXVlcnlQYXJ0cyA9IHtcbiAgICBjb2xsZWN0OiBzdHJpbmcsXG4gICAgcmVzdWx0OiBzdHJpbmcsXG59XG5cbmV4cG9ydCB0eXBlIEFnZ3JlZ2F0aW9uSGVscGVyID0ge1xuICAgIGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCxcbiAgICBidWlsZFF1ZXJ5OiAoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0KSA9PiBBZ2dyZWdhdGlvblF1ZXJ5UGFydHMsXG4gICAgY29udmVydFJlc3VsdDogKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgdmFsdWU6IGFueSkgPT4gYW55LFxufVxuXG4vLyBRdWVyeSBCdWlsZGVyc1xuXG4vKipcbiAqIFJldHVybnMgcXVlcnkgcGFydHMgaW4gZm9ybSBvZjpcbiAqIHsgY29sbGVjdDogJ2E8aT4gPSA8ZXhwcnMwPicsIHJlc3VsdDogJ2E8aT4nfSBpZiBleHBycy5sZW5ndGggPT09IDFcbiAqIG9yXG4gKiB7IGNvbGxlY3Q6ICdhPGk+ID0gPGV4cHJzMD4sIGI8aT4gPSA8ZXhwcnMxPiwgLi4nLiwgcmVzdWx0OiAneyBhOiBhPGk+LCBiOiBiPGk+LCAuLi4gfSd9XG4gKiBpZiBleHBycy5sZW5ndGggPiAxXG4gKlxuICogQHBhcmFtIGV4cHJzXG4gKiBAcGFyYW0gY29udGV4dFxuICogQHJldHVybiB7e3Jlc3VsdDogc3RyaW5nLCBjb2xsZWN0czogc3RyaW5nfX1cbiAqL1xuZnVuY3Rpb24gcXVlcnlQYXJ0cyhjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIC4uLmV4cHJzOiBzdHJpbmdbXSk6IEFnZ3JlZ2F0aW9uUXVlcnlQYXJ0cyB7XG4gICAgY29uc3QgbiA9ICdhYmNkZWYnO1xuICAgIGNvbnN0IHYgPSAoaSkgPT4gYCR7bltpXX0ke2NvbnRleHQuaW5kZXh9YDsgLy8gJ2EwJyB8ICdiMCcgfCAuLi5cbiAgICBjb25zdCBjb2xsZWN0RXhwciA9ICh4LCBpKSA9PiBgJHt2KGkpfSA9ICR7eH1gOyAvLyAnYTAgPSBleHByWzBdJyB8ICdiMCA9IGV4cHJbMV0nIHwgLi4uXG4gICAgY29uc3QgcmV0dXJuRXhwciA9ICh4LCBpKSA9PiBgJHtuW2ldfTogJHt2KGkpfWA7IC8vICdhOiBhMCcgfCAnYjogYjAnIHwgLi4uXG4gICAgcmV0dXJuIHtcbiAgICAgICAgY29sbGVjdDogZXhwcnMubWFwKGNvbGxlY3RFeHByKS5qb2luKCcsICcpLCAvLyAnYTAgPSBleHByWzBdLCBiMCA9IGV4cHJbMV0sIC4uLidcbiAgICAgICAgcmVzdWx0OiBleHBycy5sZW5ndGggPT09IDFcbiAgICAgICAgICAgID8gYCR7digwKX1gIC8vICdhMCdcbiAgICAgICAgICAgIDogYHsgJHtleHBycy5tYXAocmV0dXJuRXhwcikuam9pbignLCAnKX0gfWAsIC8vICd7IGE6IGEwLCBiOiBiMCwgLi4uIH0nXG4gICAgfVxufVxuXG5jb25zdCBjb3VudEZpZWxkOiBTY2FsYXJGaWVsZCA9IHtcbiAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICBwYXRoOiAnJyxcbn07XG5cbmZ1bmN0aW9uIGNvdW50KGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCk6IEFnZ3JlZ2F0aW9uUXVlcnlQYXJ0cyB7XG4gICAgcmV0dXJuIHF1ZXJ5UGFydHMoY29udGV4dCwgJ0NPVU5UKGRvYyknKTtcbn1cblxuZnVuY3Rpb24gc2ltcGxlKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCk6IEFnZ3JlZ2F0aW9uUXVlcnlQYXJ0cyB7XG4gICAgY29uc3QgZm4gPSBjb250ZXh0LmZuO1xuICAgIHJldHVybiBxdWVyeVBhcnRzKGNvbnRleHQsIGNvbnRleHQuaXNBcnJheVxuICAgICAgICA/IGAke2ZufSgke2ZufSgke2NvbnRleHQuZmllbGQucGF0aH0pKWBcbiAgICAgICAgOiBgJHtmbn0oJHtjb250ZXh0LmZpZWxkLnBhdGh9KWBcbiAgICApO1xufVxuXG5mdW5jdGlvbiBiaWdJbnRUb051bShoZXg6IGFueSk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBUT19OVU1CRVIoQ09OQ0FUKFwiMHhcIiwgJHsoaGV4OiBhbnkpfSkpYFxufVxuXG5mdW5jdGlvbiBiaWdJbnRIaVBhcnQocGF0aDogc3RyaW5nLCBwcmVmaXg6IG51bWJlcik6IHN0cmluZyB7XG4gICAgcmV0dXJuIGJpZ0ludFRvTnVtKGBTVUJTVFJJTkcoJHtwYXRofSwgJHtwcmVmaXh9LCBMRU5HVEgoJHtwYXRofSkgLSAke3ByZWZpeCArIDh9KWApO1xufVxuXG5mdW5jdGlvbiBiaWdJbnRMb1BhcnQocGF0aDogc3RyaW5nLCBwcmVmaXg6IG51bWJlcik6IHN0cmluZyB7XG4gICAgcmV0dXJuIGJpZ0ludFRvTnVtKGBSSUdIVChTVUJTVFJJTkcoJHtwYXRofSwgJHtwcmVmaXh9KSwgOClgKTtcbn1cblxuZnVuY3Rpb24gYmlnSW50U3VtRXhwcihwYXJ0OiAocGF0aDogc3RyaW5nLCBwcmVmaXg6IG51bWJlcikgPT4gc3RyaW5nLCBjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQpIHtcbiAgICBjb25zdCBwYXRoID0gY29udGV4dC5maWVsZC5wYXRoO1xuICAgIGNvbnN0IHByZWZpeCA9IGNvbnRleHQuYmlnSW50UHJlZml4O1xuICAgIHJldHVybiBjb250ZXh0LmlzQXJyYXlcbiAgICAgICAgPyBgU1VNKFNVTSgoJHtwYXRofSlbKiBSRVRVUk4gJHtwYXJ0KCdDVVJSRU5UJywgcHJlZml4KX1dKSlgXG4gICAgICAgIDogYFNVTSgke3BhcnQocGF0aCwgcHJlZml4KX0pYDtcbn1cblxuZnVuY3Rpb24gYmlnSW50U3VtKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCk6IEFnZ3JlZ2F0aW9uUXVlcnlQYXJ0cyB7XG4gICAgcmV0dXJuIHF1ZXJ5UGFydHMoXG4gICAgICAgIGNvbnRleHQsXG4gICAgICAgIGJpZ0ludFN1bUV4cHIoYmlnSW50SGlQYXJ0LCBjb250ZXh0KSxcbiAgICAgICAgYmlnSW50U3VtRXhwcihiaWdJbnRMb1BhcnQsIGNvbnRleHQpLFxuICAgICk7XG59XG5cbmZ1bmN0aW9uIGJpZ0ludEF2Zyhjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQpOiBBZ2dyZWdhdGlvblF1ZXJ5UGFydHMge1xuICAgIHJldHVybiBxdWVyeVBhcnRzKFxuICAgICAgICBjb250ZXh0LFxuICAgICAgICBiaWdJbnRTdW1FeHByKGJpZ0ludEhpUGFydCwgY29udGV4dCksXG4gICAgICAgIGJpZ0ludFN1bUV4cHIoYmlnSW50TG9QYXJ0LCBjb250ZXh0KSxcbiAgICAgICAgY29udGV4dC5pc0FycmF5XG4gICAgICAgICAgICA/IGBTVU0oQ09VTlQoJHtjb250ZXh0LmZpZWxkLnBhdGh9KSlgXG4gICAgICAgICAgICA6IGBDT1VOVChkb2MpYCxcbiAgICApO1xufVxuXG4vLyBSZXN1bHQgY29udmVydGVyc1xuXG5mdW5jdGlvbiBjb252ZXJ0Tm9uZShjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlOiBhbnkpOiBhbnkge1xuICAgIHJldHVybiB2YWx1ZTtcbn1cblxuZnVuY3Rpb24gYmlnSW50U3RyaW5nKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgdmFsdWU6IGFueSk6IGFueSB7XG4gICAgLy8kRmxvd0ZpeE1lXG4gICAgcmV0dXJuIEJpZ0ludChgMHgke3ZhbHVlLnN1YnN0cihjb250ZXh0LmJpZ0ludFByZWZpeCl9YCkudG9TdHJpbmcoKTtcbn1cblxuLy8kRmxvd0ZpeE1lXG5mdW5jdGlvbiBiaWdJbnRGcm9tUGFydHMocGFydHM6IHsgYTogbnVtYmVyLCBiOiBudW1iZXIgfSk6IEJpZ0ludCB7XG4gICAgY29uc3QgaCA9IEJpZ0ludChgMHgke01hdGgucm91bmQocGFydHMuYSkudG9TdHJpbmcoMTYpfTAwMDAwMDAwYCk7XG4gICAgY29uc3QgbCA9IEJpZ0ludChNYXRoLnJvdW5kKHBhcnRzLmIpKTtcbiAgICByZXR1cm4gaCArIGw7XG59XG5cbmZ1bmN0aW9uIGJpZ0ludFBhcnRzKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgdmFsdWU6IGFueSk6IGFueSB7XG4gICAgcmV0dXJuIGJpZ0ludEZyb21QYXJ0cyh2YWx1ZSkudG9TdHJpbmcoKTtcbn1cblxuZnVuY3Rpb24gYmlnSW50UGFydHNBdmcoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZTogYW55KTogYW55IHtcbiAgICBjb25zdCBzdW0gPSBiaWdJbnRGcm9tUGFydHModmFsdWUpO1xuICAgIGNvbnN0IGNvdW50ID0gTnVtYmVyKHZhbHVlLmMgfHwgMCk7XG4gICAgY29uc3QgYXZnID0gY291bnQgPiAwID8gKHN1bSAvIEJpZ0ludChNYXRoLnJvdW5kKGNvdW50KSkpIDogc3VtO1xuICAgIHJldHVybiBhdmcudG9TdHJpbmcoKTtcbn1cblxuZXhwb3J0IGNsYXNzIEFnZ3JlZ2F0aW9uSGVscGVyRmFjdG9yeSB7XG4gICAgc3RhdGljIGNyZWF0ZShjb2xsZWN0aW9uOiBzdHJpbmcsIGluZGV4OiBudW1iZXIsIGFnZ3JlZ2F0aW9uOiBGaWVsZEFnZ3JlZ2F0aW9uKTogQWdncmVnYXRpb25IZWxwZXIge1xuICAgICAgICBjb25zdCBmaWVsZCA9IHNjYWxhckZpZWxkcy5nZXQoYCR7Y29sbGVjdGlvbn0uJHthZ2dyZWdhdGlvbi5maWVsZCB8fCAnaWQnfWApIHx8IGNvdW50RmllbGQ7XG4gICAgICAgIGNvbnN0IGZuID0gYWdncmVnYXRpb24uZm4gfHwgQWdncmVnYXRpb25Gbi5DT1VOVDtcbiAgICAgICAgY29uc3QgY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0ID0ge1xuICAgICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgICBmaWVsZCxcbiAgICAgICAgICAgIGZuLFxuICAgICAgICAgICAgYmlnSW50UHJlZml4OiAoZmllbGQudHlwZSA9PT0gJ3VpbnQxMDI0JykgPyAyIDogKGZpZWxkLnR5cGUgPT09ICd1aW50NjQnID8gMSA6IDApLFxuICAgICAgICAgICAgaXNBcnJheTogZmllbGQucGF0aC5pbmNsdWRlcygnWypdJyksXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGNvbnRleHQuZm4gPT09IEFnZ3JlZ2F0aW9uRm4uQ09VTlQpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgICBidWlsZFF1ZXJ5OiBjb3VudCxcbiAgICAgICAgICAgICAgICBjb252ZXJ0UmVzdWx0OiBjb252ZXJ0Tm9uZSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29udGV4dC5maWVsZC5wYXRoID09PSAnJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBbJHthZ2dyZWdhdGlvbi5maWVsZH1dIGNhbid0IGJlIGFnZ3JlZ2F0ZWRgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChmbiA9PT0gQWdncmVnYXRpb25Gbi5NSU4gfHwgZm4gPT09IEFnZ3JlZ2F0aW9uRm4uTUFYKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgICAgYnVpbGRRdWVyeTogc2ltcGxlLFxuICAgICAgICAgICAgICAgIGNvbnZlcnRSZXN1bHQ6IGNvbnRleHQuYmlnSW50UHJlZml4ID4gMFxuICAgICAgICAgICAgICAgICAgICA/IGJpZ0ludFN0cmluZ1xuICAgICAgICAgICAgICAgICAgICA6IGNvbnZlcnROb25lLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChmaWVsZC50eXBlID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICAgIGJ1aWxkUXVlcnk6IHNpbXBsZSxcbiAgICAgICAgICAgICAgICBjb252ZXJ0UmVzdWx0OiBjb252ZXJ0Tm9uZSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29udGV4dC5iaWdJbnRQcmVmaXggPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4gKGNvbnRleHQuZm4gPT09IEFnZ3JlZ2F0aW9uRm4uQVZFUkFHRSlcbiAgICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgICAgICAgYnVpbGRRdWVyeTogYmlnSW50QXZnLFxuICAgICAgICAgICAgICAgICAgICBjb252ZXJ0UmVzdWx0OiBiaWdJbnRQYXJ0c0F2ZyxcbiAgICAgICAgICAgICAgICB9IDoge1xuICAgICAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICBidWlsZFF1ZXJ5OiBiaWdJbnRTdW0sXG4gICAgICAgICAgICAgICAgICAgIGNvbnZlcnRSZXN1bHQ6IGJpZ0ludFBhcnRzLFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICB9XG5cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBbJHthZ2dyZWdhdGlvbi5maWVsZH1dIGNhbid0IGJlIHVzZWQgd2l0aCBbJHtmbn1dYCk7XG4gICAgfVxuXG4gICAgc3RhdGljIGNyZWF0ZVF1ZXJ5KFxuICAgICAgICBjb2xsZWN0aW9uOiBzdHJpbmcsXG4gICAgICAgIGZpbHRlcjogc3RyaW5nLFxuICAgICAgICBhcmdGaWVsZHM6IEZpZWxkQWdncmVnYXRpb25bXSB8IHR5cGVvZiB1bmRlZmluZWQsXG4gICAgKToge1xuICAgICAgICB0ZXh0OiBzdHJpbmcsXG4gICAgICAgIGhlbHBlcnM6IEFnZ3JlZ2F0aW9uSGVscGVyW10sXG4gICAgfSB7XG4gICAgICAgIGNvbnN0IGZpbHRlclNlY3Rpb24gPSBmaWx0ZXIgPyBgRklMVEVSICR7ZmlsdGVyfWAgOiAnJztcbiAgICAgICAgY29uc3QgZmllbGRzOiBGaWVsZEFnZ3JlZ2F0aW9uW10gPSAoQXJyYXkuaXNBcnJheShhcmdGaWVsZHMpICYmIGFyZ0ZpZWxkcy5sZW5ndGggPiAwKVxuICAgICAgICAgICAgPyBhcmdGaWVsZHNcbiAgICAgICAgICAgIDogW3sgZmllbGQ6ICcnLCBmbjogQWdncmVnYXRpb25Gbi5DT1VOVCB9XTtcbiAgICAgICAgY29uc3QgaGVscGVyczogQWdncmVnYXRpb25IZWxwZXJbXSA9IGZpZWxkcy5tYXAoKGFnZ3JlZ2F0aW9uLCBpKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gQWdncmVnYXRpb25IZWxwZXJGYWN0b3J5LmNyZWF0ZShjb2xsZWN0aW9uLCBpLCBhZ2dyZWdhdGlvbik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCB0ZXh0O1xuICAgICAgICBjb25zdCBpc1NpbmdsZUNvdW50ID0gKGZpZWxkcy5sZW5ndGggPT09IDEpICYmIChmaWVsZHNbMF0uZm4gPT09IEFnZ3JlZ2F0aW9uRm4uQ09VTlQpO1xuICAgICAgICBpZiAoaXNTaW5nbGVDb3VudCkge1xuICAgICAgICAgICAgaWYgKGZpbHRlclNlY3Rpb24gIT09ICcnKSB7XG4gICAgICAgICAgICAgICAgdGV4dCA9IGBcbiAgICAgICAgICAgICAgICAgICAgRk9SIGRvYyBJTiAke2NvbGxlY3Rpb259XG4gICAgICAgICAgICAgICAgICAgICR7ZmlsdGVyU2VjdGlvbn1cbiAgICAgICAgICAgICAgICAgICAgQ09MTEVDVCBXSVRIIENPVU5UIElOVE8gYTBcbiAgICAgICAgICAgICAgICAgICAgUkVUVVJOIFthMF1gO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0ZXh0ID0gYFJFVFVSTiBbTEVOR1RIKCR7Y29sbGVjdGlvbn0pXWA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBxdWVyaWVzID0gaGVscGVycy5tYXAoeCA9PiB4LmJ1aWxkUXVlcnkoeC5jb250ZXh0KSk7XG4gICAgICAgICAgICB0ZXh0ID0gYFxuICAgICAgICAgICAgICAgIEZPUiBkb2MgSU4gJHtjb2xsZWN0aW9ufVxuICAgICAgICAgICAgICAgICR7ZmlsdGVyU2VjdGlvbn1cbiAgICAgICAgICAgICAgICBDT0xMRUNUIEFHR1JFR0FURSAke3F1ZXJpZXMubWFwKHggPT4geC5jb2xsZWN0KS5qb2luKCcsICcpfVxuICAgICAgICAgICAgICAgIFJFVFVSTiBbJHtxdWVyaWVzLm1hcCh4ID0+IHgucmVzdWx0KS5qb2luKCcsICcpfV1gO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0ZXh0LFxuICAgICAgICAgICAgaGVscGVycyxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBzdGF0aWMgY29udmVydFJlc3VsdHMocmVzdWx0czogYW55W10sIGhlbHBlcnM6IEFnZ3JlZ2F0aW9uSGVscGVyW10pOiBhbnlbXSB7XG4gICAgICAgIHJldHVybiByZXN1bHRzLm1hcCgoeCwgaSkgPT4ge1xuICAgICAgICAgICAgaWYgKHggPT09IHVuZGVmaW5lZCB8fCB4ID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBoZWxwZXIgPSBoZWxwZXJzW2ldO1xuICAgICAgICAgICAgcmV0dXJuIGhlbHBlci5jb252ZXJ0UmVzdWx0KGhlbHBlci5jb250ZXh0LCB4KTtcbiAgICAgICAgfSk7XG5cbiAgICB9XG59XG5cbiJdfQ==