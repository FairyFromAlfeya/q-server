"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.QRpcServer = void 0;

var _ws = _interopRequireDefault(require("ws"));

var _arango = _interopRequireDefault(require("./arango"));

var _arangoCollection = require("./arango-collection");

var _auth = require("./auth");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class QRpcServer {
  constructor(options) {
    this.db = options.db;
    this.auth = options.auth;
    this.resolvers = new Map();
    this.db.collections.forEach(c => {
      this.resolvers.set(c.name, c.queryResolver());
    });
    this.port = options.port || 8084;
  }

  start() {
    this.wss = new _ws.default.Server({
      port: this.port
    });
    this.wss.on('connection', (ws, req) => {
      const connection = {
        socket: ws,
        remoteAddress: req.connection.remoteAddress
      };
      ws.on('close', () => {});
      ws.on('message', data => {
        (async () => {
          try {
            await this.rpc(connection, data);
          } catch (error) {
            console.error(error);
          }
        })();
      });
    });
  }

  async rpc(connection, data) {
    const request = JSON.parse(data);
    let response;

    try {
      response = {
        jsonrpc: '2.0',
        id: request.id,
        result: await this.dispatch(connection, request.method, request.params)
      };
    } catch (error) {
      response = {
        jsonrpc: '2.0',
        id: request.id,
        error: {
          code: error.code || 500,
          message: error.message
        }
      };
    }

    connection.socket.send(JSON.stringify(response));
  }

  async dispatch(connection, method, params) {
    switch (method) {
      case 'transactions':
      case 'accounts':
      case 'blocks':
      case 'messages':
      case 'block_signatures':
        return this.query(connection, this.db.collectionsByName.get(method), params);

      default:
        throw new Error(`Unknown method [${method}]`);
    }
  }

  async query(connection, collection, params) {
    const resolver = this.resolvers.get(collection.name);
    const docs = await resolver(null, params, {
      auth: this.auth,
      remoteAddress: connection.remoteAddress
    }, {
      operation: {
        selectionSet: params.selection
      }
    });
    return docs;
  }

}

exports.QRpcServer = QRpcServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9xLXJwYy1zZXJ2ZXIuanMiXSwibmFtZXMiOlsiUVJwY1NlcnZlciIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImRiIiwiYXV0aCIsInJlc29sdmVycyIsIk1hcCIsImNvbGxlY3Rpb25zIiwiZm9yRWFjaCIsImMiLCJzZXQiLCJuYW1lIiwicXVlcnlSZXNvbHZlciIsInBvcnQiLCJzdGFydCIsIndzcyIsIldlYlNvY2tldCIsIlNlcnZlciIsIm9uIiwid3MiLCJyZXEiLCJjb25uZWN0aW9uIiwic29ja2V0IiwicmVtb3RlQWRkcmVzcyIsImRhdGEiLCJycGMiLCJlcnJvciIsImNvbnNvbGUiLCJyZXF1ZXN0IiwiSlNPTiIsInBhcnNlIiwicmVzcG9uc2UiLCJqc29ucnBjIiwiaWQiLCJyZXN1bHQiLCJkaXNwYXRjaCIsIm1ldGhvZCIsInBhcmFtcyIsImNvZGUiLCJtZXNzYWdlIiwic2VuZCIsInN0cmluZ2lmeSIsInF1ZXJ5IiwiY29sbGVjdGlvbnNCeU5hbWUiLCJnZXQiLCJFcnJvciIsImNvbGxlY3Rpb24iLCJyZXNvbHZlciIsImRvY3MiLCJvcGVyYXRpb24iLCJzZWxlY3Rpb25TZXQiLCJzZWxlY3Rpb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFDQTs7OztBQTBDTyxNQUFNQSxVQUFOLENBQWlCO0FBTXBCQyxFQUFBQSxXQUFXLENBQUNDLE9BQUQsRUFJUjtBQUNDLFNBQUtDLEVBQUwsR0FBVUQsT0FBTyxDQUFDQyxFQUFsQjtBQUNBLFNBQUtDLElBQUwsR0FBWUYsT0FBTyxDQUFDRSxJQUFwQjtBQUNBLFNBQUtDLFNBQUwsR0FBaUIsSUFBSUMsR0FBSixFQUFqQjtBQUNBLFNBQUtILEVBQUwsQ0FBUUksV0FBUixDQUFvQkMsT0FBcEIsQ0FBNkJDLENBQUQsSUFBTztBQUMvQixXQUFLSixTQUFMLENBQWVLLEdBQWYsQ0FBbUJELENBQUMsQ0FBQ0UsSUFBckIsRUFBMkJGLENBQUMsQ0FBQ0cs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QjtBQU1BLFVBQU1xQyxJQUFJLEdBQUcsTUFBTUQsUUFBUSxDQUN2QixJQUR1QixFQUV2QlYsTUFGdUIsRUFHdkI7QUFDSWpDLE1BQUFBLElBQUksRUFBRSxLQUFLQSxJQURmO0FBRUltQixNQUFBQSxhQUFhLEVBQUVGLFVBQVUsQ0FBQ0U7QUFGOUIsS0FIdUIsRUFPdkI7QUFDSTBCLE1BQUFBLFNBQVMsRUFBRTtBQUNQQyxRQUFBQSxZQUFZLEVBQUViLE1BQU0sQ0FBQ2M7QUFEZDtBQURmLEtBUHVCLENBQTNCO0FBWUEsV0FBT0gsSUFBUDtBQUNIOztBQWhHbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgV2ViU29ja2V0IGZyb20gJ3dzJztcbmltcG9ydCBBcmFuZ28gZnJvbSAnLi9hcmFuZ28nO1xuaW1wb3J0IHR5cGUge0dyYXBoUUxSZXF1ZXN0Q29udGV4dH0gZnJvbSAnLi9hcmFuZ28tY29sbGVjdGlvbic7XG5pbXBvcnQge0NvbGxlY3Rpb259IGZyb20gJy4vYXJhbmdvLWNvbGxlY3Rpb24nO1xuaW1wb3J0IHtBdXRofSBmcm9tICcuL2F1dGgnO1xuaW1wb3J0IHR5cGUge0ZpZWxkU2VsZWN0aW9uLCBPcmRlckJ5fSBmcm9tICcuL2RiLXR5cGVzJztcblxudHlwZSBScGNSZXF1ZXN0ID0ge1xuICAgIGpzb25ycGM6ICcyLjAnLFxuICAgIG1ldGhvZDogc3RyaW5nLFxuICAgIHBhcmFtcz86IGFueSxcbiAgICBpZD86IHN0cmluZyB8IG51bWJlciB8IG51bGwsXG59XG5cbnR5cGUgUnBjUmVzdWx0ID0ge1xuICAgIHJlc3VsdDogYW55XG59XG5cbnR5cGUgUnBjRXJyb3IgPSB7XG4gICAgZXJyb3I6IHtcbiAgICAgICAgY29kZTogbnVtYmVyLFxuICAgICAgICBtZXNzYWdlOiBzdHJpbmcsXG4gICAgICAgIGRhdGE/OiBhbnlcbiAgICB9XG59XG5cbnR5cGUgUnBjUmVzcG9uc2UgPSB7XG4gICAganNvbnJwYzogJzIuMCcsXG4gICAgaWQ6IHN0cmluZyB8IG51bWJlciB8IG51bGwsXG59ICYgKFJwY1Jlc3VsdCB8IFJwY0Vycm9yKVxuXG50eXBlIFF1ZXJ5UGFyYW1zID0ge1xuICAgIGZpbHRlcjogYW55LFxuICAgIHNlbGVjdGlvbjogRmllbGRTZWxlY3Rpb25bXSxcbiAgICBvcmRlckJ5PzogT3JkZXJCeVtdLFxuICAgIGxpbWl0PzogbnVtYmVyLFxuICAgIHRpbWVvdXQ/OiBudW1iZXIsXG4gICAgYWNjZXNzS2V5Pzogc3RyaW5nLFxuICAgIG9wZXJhdGlvbklkPzogc3RyaW5nLFxufVxuXG50eXBlIFJwY0Nvbm5lY3Rpb24gPSB7XG4gICAgc29ja2V0OiBXZWJTb2NrZXQsXG4gICAgcmVtb3RlQWRkcmVzczogc3RyaW5nLFxufVxuXG5leHBvcnQgY2xhc3MgUVJwY1NlcnZlciB7XG4gICAgZGI6IEFyYW5nbztcbiAgICBhdXRoOiBBdXRoO1xuICAgIHJlc29sdmVyczogTWFwPHN0cmluZywgKCkgPT4gUHJvbWlzZT47XG4gICAgcG9ydDogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczoge1xuICAgICAgICBkYjogQXJhbmdvLFxuICAgICAgICBhdXRoOiBBdXRoLFxuICAgICAgICBwb3J0PzogbnVtYmVyLFxuICAgIH0pIHtcbiAgICAgICAgdGhpcy5kYiA9IG9wdGlvbnMuZGI7XG4gICAgICAgIHRoaXMuYXV0aCA9IG9wdGlvbnMuYXV0aDtcbiAgICAgICAgdGhpcy5yZXNvbHZlcnMgPSBuZXcgTWFwKCk7XG4gICAgICAgIHRoaXMuZGIuY29sbGVjdGlvbnMuZm9yRWFjaCgoYykgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZXNvbHZlcnMuc2V0KGMubmFtZSwgYy5xdWVyeVJlc29sdmVyKCkpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5wb3J0ID0gb3B0aW9ucy5wb3J0IHx8IDgwODQ7XG4gICAgfVxuXG4gICAgc3RhcnQoKSB7XG4gICAgICAgIHRoaXMud3NzID0gbmV3IFdlYlNvY2tldC5TZXJ2ZXIoe3BvcnQ6IHRoaXMucG9ydH0pO1xuICAgICAgICB0aGlzLndzcy5vbignY29ubmVjdGlvbicsICh3cywgcmVxKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb25uZWN0aW9uOiBScGNDb25uZWN0aW9uID0ge1xuICAgICAgICAgICAgICAgIHNvY2tldDogd3MsXG4gICAgICAgICAgICAgICAgcmVtb3RlQWRkcmVzczogcmVxLmNvbm5lY3Rpb24ucmVtb3RlQWRkcmVzcyxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB3cy5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHdzLm9uKCdtZXNzYWdlJywgKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5ycGMoY29ubmVjdGlvbiwgZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcnBjKGNvbm5lY3Rpb246IFJwY0Nvbm5lY3Rpb24sIGRhdGE6IGFueSkge1xuICAgICAgICBjb25zdCByZXF1ZXN0OiBScGNSZXF1ZXN0ID0gSlNPTi5wYXJzZShkYXRhKTtcbiAgICAgICAgbGV0IHJlc3BvbnNlOiBScGNSZXNwb25zZTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJlc3BvbnNlID0ge1xuICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgIGlkOiByZXF1ZXN0LmlkLFxuICAgICAgICAgICAgICAgIHJlc3VsdDogYXdhaXQgdGhpcy5kaXNwYXRjaChjb25uZWN0aW9uLCByZXF1ZXN0Lm1ldGhvZCwgcmVxdWVzdC5wYXJhbXMpLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJlc3BvbnNlID0ge1xuICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgIGlkOiByZXF1ZXN0LmlkLFxuICAgICAgICAgICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgICAgICAgICAgIGNvZGU6IGVycm9yLmNvZGUgfHwgNTAwLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29ubmVjdGlvbi5zb2NrZXQuc2VuZChKU09OLnN0cmluZ2lmeShyZXNwb25zZSkpO1xuICAgIH1cblxuICAgIGFzeW5jIGRpc3BhdGNoKGNvbm5lY3Rpb246IFJwY0Nvbm5lY3Rpb24sIG1ldGhvZDogc3RyaW5nLCBwYXJhbXM6IGFueSkge1xuICAgICAgICBzd2l0Y2ggKG1ldGhvZCkge1xuICAgICAgICBjYXNlICd0cmFuc2FjdGlvbnMnOlxuICAgICAgICBjYXNlICdhY2NvdW50cyc6XG4gICAgICAgIGNhc2UgJ2Jsb2Nrcyc6XG4gICAgICAgIGNhc2UgJ21lc3NhZ2VzJzpcbiAgICAgICAgY2FzZSAnYmxvY2tfc2lnbmF0dXJlcyc6XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5xdWVyeShjb25uZWN0aW9uLCB0aGlzLmRiLmNvbGxlY3Rpb25zQnlOYW1lLmdldChtZXRob2QpLCBwYXJhbXMpO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIG1ldGhvZCBbJHttZXRob2R9XWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgcXVlcnkoY29ubmVjdGlvbjogUnBjQ29ubmVjdGlvbiwgY29sbGVjdGlvbjogQ29sbGVjdGlvbiwgcGFyYW1zOiBRdWVyeVBhcmFtcykge1xuICAgICAgICBjb25zdCByZXNvbHZlcjogKFxuICAgICAgICAgICAgcGFyZW50OiBhbnksXG4gICAgICAgICAgICBhcmdzOiBhbnksXG4gICAgICAgICAgICBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHQsXG4gICAgICAgICAgICBpbmZvOiBhbnksXG4gICAgICAgICkgPT4gUHJvbWlzZTxbXT4gPSB0aGlzLnJlc29sdmVycy5nZXQoY29sbGVjdGlvbi5uYW1lKTtcbiAgICAgICAgY29uc3QgZG9jcyA9IGF3YWl0IHJlc29sdmVyKFxuICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgIHBhcmFtcyxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBhdXRoOiB0aGlzLmF1dGgsXG4gICAgICAgICAgICAgICAgcmVtb3RlQWRkcmVzczogY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBvcGVyYXRpb246IHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uU2V0OiBwYXJhbXMuc2VsZWN0aW9uLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZG9jcztcbiAgICB9XG59XG4iXX0=