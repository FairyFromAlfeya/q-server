"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.QRpcServer = void 0;

var _ws = _interopRequireDefault(require("ws"));

var _database = _interopRequireDefault(require("./database"));

var _collection = require("./collection");

var _auth = require("./auth");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class QRpcServer {
  constructor(options) {
    this.db = options.db;
    this.auth = options.auth;
    this.resolvers = new Map();
    this.db.collections.forEach(c => {
      this.resolvers.set(c.name, c.queryResolver());
    });
    this.port = options.port || 0;
  }

  start() {
    if (this.port === 0) {
      throw new Error('QRpcServer port hasn\'t specified');
    }

    this.wss = new _ws.default.Server({
      port: this.port
    });
    this.wss.on('connection', (ws, req) => {
      const connection = {
        socket: ws,
        remoteAddress: req.connection.remoteAddress
      };
      ws.on('close', () => {});
      ws.on('message', data => {
        (async () => {
          try {
            await this.rpc(connection, data);
          } catch (error) {
            console.error(error);
          }
        })();
      });
    });
  }

  async rpc(connection, data) {
    const request = JSON.parse(data);
    let response;

    try {
      response = {
        jsonrpc: '2.0',
        id: request.id,
        result: await this.dispatch(connection, request.method, request.params)
      };
    } catch (error) {
      response = {
        jsonrpc: '2.0',
        id: request.id,
        error: {
          code: error.code || 500,
          message: error.message
        }
      };
    }

    connection.socket.send(JSON.stringify(response));
  }

  async dispatch(connection, method, params) {
    switch (method) {
      case 'transactions':
      case 'accounts':
      case 'blocks':
      case 'messages':
      case 'block_signatures':
        return this.query(connection, this.db.collectionsByName.get(method), params);

      default:
        throw new Error(`Unknown method [${method}]`);
    }
  }

  async query(connection, collection, params) {
    const resolver = this.resolvers.get(collection.name);
    const docs = await resolver(null, params, {
      auth: this.auth,
      remoteAddress: connection.remoteAddress
    }, {
      operation: {
        selectionSet: params.selection
      }
    });
    return docs;
  }

}

exports.QRpcServer = QRpcServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9xLXJwYy1zZXJ2ZXIuanMiXSwibmFtZXMiOlsiUVJwY1NlcnZlciIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImRiIiwiYXV0aCIsInJlc29sdmVycyIsIk1hcCIsImNvbGxlY3Rpb25zIiwiZm9yRWFjaCIsImMiLCJzZXQiLCJuYW1lIiwicXVlcnlSZXNvbHZlciIsInBvcnQiLCJzdGFydCIsIkVycm9yIiwid3NzIiwiV2ViU29ja2V0IiwiU2VydmVyIiwib24iLCJ3cyIsInJlcSIsImNvbm5lY3Rpb24iLCJzb2NrZXQiLCJyZW1vdGVBZGRyZXNzIiwiZGF0YSIsInJwYyIsImVycm9yIiwiY29uc29sZSIsInJlcXVlc3QiLCJKU09OIiwicGFyc2UiLCJyZXNwb25zZSIsImpzb25ycGMiLCJpZCIsInJlc3VsdCIsImRpc3BhdGNoIiwibWV0aG9kIiwicGFyYW1zIiwiY29kZSIsIm1lc3NhZ2UiLCJzZW5kIiwic3RyaW5naWZ5IiwicXVlcnkiLCJjb2xsZWN0aW9uc0J5TmFtZSIsImdldCIsImNvbGxlY3Rpb24iLCJyZXNvbHZlciIsImRvY3MiLCJvcGVyYXRpb24iLCJzZWxlY3Rpb25TZXQiLCJzZWxlY3Rpb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFDQTs7OztBQTBDTyxNQUFNQSxVQUFOLENBQWlCO0FBTXBCQyxFQUFBQSxXQUFXLENBQUNDLE9BQUQsRUFJUjtBQUNDLFNBQUtDLEVBQUwsR0FBVUQsT0FBTyxDQUFDQyxFQUFsQjtBQUNBLFNBQUtDLElBQUwsR0FBWUYsT0FBTyxDQUFDRSxJQUFwQjtBQUNBLFNBQUtDLFNBQUwsR0FBaUIsSUFBSUMsR0FBSixFQUFqQjtBQUNBLFNBQUtILEVBQUwsQ0FBUUksV0FBUixDQUFvQkMsT0FBcEIsQ0FBNkJDLENBQUQsSUFBTztBQUMvQixXQUFLSixTQUFMLENBQWVLLEdBQWYsQ0FBbUJELENBQUMsQ0FBQ0UsSUFBckIsRUFBMkJGLENBQUMsQ0FBQ0csYUFBRixFQUEzQjtBQUNILEtBRkQ7QUFHQSxTQUFLQyxJQUFMLEdBQVlYLE9BQU8sQ0FBQ1csSUFBUixJQUFnQixDQUE1QjtBQUNIOztBQUVEQyxFQUFBQSxLQUFLLEdBQUc7QUFDSixRQUFJLEtBQUtELElBQUwsS0FBYyxDQUFsQixFQUFxQjtBQUNqQixZQUFNLElBQUlFLEtBQUosQ0FBVSxtQ0FBVixDQUFOO0FBQ0g7O0FBQ0QsU0FBS0MsR0FBTCxHQUFXLElBQUlDLFlBQVVDLE1BQWQsQ0FBcUI7QUFBQ0wsTUFBQUEsSUFBSSxFQUFFLEtBQUtBO0FBQVosS0FBckIsQ0FBWDtBQUNBLFNBQUtHLEdBQUwsQ0FBU0csRUFBVCxDQUFZLFlBQVosRUFBMEIsQ0FBQ0MsRUFBRCxFQUFLQyxHQUFMLEtBQWE7QUFDbkMsWUFBTUMsVUFBeUIsR0FBRztBQUM5QkMsUUFBQUEsTUFBTSxFQUFFSCxFQURzQjtBQUU5QkksUUFBQUEsYUFBYSxFQUFFSCxHQUFHLENBQUNDLFVBQUosQ0FBZUU7QUFGQSxPQUFsQztBQUlBSixNQUFBQSxFQUFFLENBQUNELEVBQUgsQ0FBTSxPQUFOLEVBQWUsTUFBTSxDQUNwQixDQUREO0FBRUFDLE1BQUFBLEVBQUUsQ0FBQ0QsRUFBSCxDQUFNLFNBQU4sRUFBa0JNLElBQUQsSUFBVTtBQUN2QixTQUFDLFlBQVk7QUFDVCxjQUFJO0FBQ0Esa0JBQU0sS0FBS0MsR0FBTCxDQUFTSixVQUFULEVBQXFCRyxJQUFyQixDQUFOO0FBQ0gsV0FGRCxDQUVFLE9BQU9FLEtBQVAsRUFBYztBQUNaQyxZQUFBQSxPQUFPLENBQUNELEtBQVIsQ0FBY0EsS0FBZDtBQUNIO0FBQ0osU0FORDtBQU9ILE9BUkQ7QUFTSCxLQWhCRDtBQWlCSDs7QUFFRCxRQUFNRCxHQUFOLENBQVVKLFVBQVYsRUFBcUNHLElBQXJDLEVBQWdEO0FBQzVDLFVBQU1JLE9BQW1CLEdBQUdDLElBQUksQ0FBQ0MsS0FBTCxDQUFXTixJQUFYLENBQTVCO0FBQ0EsUUFBSU8sUUFBSjs7QUFDQSxRQUFJO0FBQ0FBLE1BQUFBLFFBQVEsR0FBRztBQUNQQyxRQUFBQSxPQUFPLEVBQUUsS0FERjtBQUVQQyxRQUFBQSxFQUFFLEVBQUVMLE9BQU8sQ0FBQ0ssRUFGTDtBQUdQQyxRQUFBQSxNQUFNLEVBQUUsTUFBTSxLQUFLQyxRQUFMLENBQWNkLFVBQWQsRUFBMEJPLE9BQU8sQ0FBQ1EsTUFBbEMsRUFBMENSLE9BQU8sQ0FBQ1MsTUFBbEQ7QUFIUCxPQUFYO0FBS0gsS0FORCxDQU1FLE9BQU9YLEtBQVAsRUFBYztBQUNaSyxNQUFBQSxRQUFRLEdBQUc7QUFDUEMsUUFBQUEsT0FBTyxFQUFFLEtBREY7QUFFUEMsUUFBQUEsRUFBRSxFQUFFTCxPQUFPLENBQUNLLEVBRkw7QUFHUFAsUUFBQUEsS0FBSyxFQUFFO0FBQ0hZLFVBQUFBLElBQUksRUFBRVosS0FBSyxDQUFDWSxJQUFOLElBQWMsR0FEakI7QUFFSEMsVUFBQUEsT0FBTyxFQUFFYixLQUFLLENBQUNhO0FBRlo7QUFIQSxPQUFYO0FBUUg7O0FBQ0RsQixJQUFBQSxVQUFVLENBQUNDLE1BQVgsQ0FBa0JrQixJQUFsQixDQUF1QlgsSUFBSSxDQUFDWSxTQUFMLENBQWVWLFFBQWYsQ0FBdkI7QUFDSDs7QUFFRCxRQUFNSSxRQUFOLENBQWVkLFVBQWYsRUFBMENlLE1BQTFDLEVBQTBEQyxNQUExRCxFQUF1RTtBQUNuRSxZQUFRRCxNQUFSO0FBQ0EsV0FBSyxjQUFMO0FBQ0EsV0FBSyxVQUFMO0FBQ0EsV0FBSyxRQUFMO0FBQ0EsV0FBSyxVQUFMO0FBQ0EsV0FBSyxrQkFBTDtBQUNJLGVBQU8sS0FBS00sS0FBTCxDQUFXckIsVUFBWCxFQUF1QixLQUFLbkIsRUFBTCxDQUFReUMsaUJBQVIsQ0FBMEJDLEdBQTFCLENBQThCUixNQUE5QixDQUF2QixFQUE4REMsTUFBOUQsQ0FBUDs7QUFDSjtBQUNJLGNBQU0sSUFBSXZCLEtBQUosQ0FBVyxtQkFBa0JzQixNQUFPLEdBQXBDLENBQU47QUFSSjtBQVVIOztBQUVELFFBQU1NLEtBQU4sQ0FBWXJCLFVBQVosRUFBdUN3QixVQUF2QyxFQUFnRVIsTUFBaEUsRUFBcUY7QUFDakYsVUFBTVMsUUFLVSxHQUFHLEtBQUsxQyxTQUFMLENBQWV3QyxHQUFmLENBQW1CQyxVQUFVLENBQUNuQyxJQUE5QixDQUxuQjtBQU1BLFVBQU1xQyxJQUFJLEdBQUcsTUFBTUQsUUFBUSxDQUN2QixJQUR1QixFQUV2QlQsTUFGdUIsRUFHdkI7QUFDSWxDLE1BQUFBLElBQUksRUFBRSxLQUFLQSxJQURmO0FBRUlvQixNQUFBQSxhQUFhLEVBQUVGLFVBQVUsQ0FBQ0U7QUFGOUIsS0FIdUIsRUFPdkI7QUFDSXlCLE1BQUFBLFNBQVMsRUFBRTtBQUNQQyxRQUFBQSxZQUFZLEVBQUVaLE1BQU0sQ0FBQ2E7QUFEZDtBQURmLEtBUHVCLENBQTNCO0FBWUEsV0FBT0gsSUFBUDtBQUNIOztBQW5HbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgV2ViU29ja2V0IGZyb20gJ3dzJztcbmltcG9ydCBRRGF0YWJhc2UgZnJvbSAnLi9kYXRhYmFzZSc7XG5pbXBvcnQgdHlwZSB7R3JhcGhRTFJlcXVlc3RDb250ZXh0fSBmcm9tICcuL2NvbGxlY3Rpb24nO1xuaW1wb3J0IHtRQ29sbGVjdGlvbn0gZnJvbSAnLi9jb2xsZWN0aW9uJztcbmltcG9ydCB7QXV0aH0gZnJvbSAnLi9hdXRoJztcbmltcG9ydCB0eXBlIHtGaWVsZFNlbGVjdGlvbiwgT3JkZXJCeX0gZnJvbSAnLi9kYi10eXBlcyc7XG5cbnR5cGUgUnBjUmVxdWVzdCA9IHtcbiAgICBqc29ucnBjOiAnMi4wJyxcbiAgICBtZXRob2Q6IHN0cmluZyxcbiAgICBwYXJhbXM/OiBhbnksXG4gICAgaWQ/OiBzdHJpbmcgfCBudW1iZXIgfCBudWxsLFxufVxuXG50eXBlIFJwY1Jlc3VsdCA9IHtcbiAgICByZXN1bHQ6IGFueVxufVxuXG50eXBlIFJwY0Vycm9yID0ge1xuICAgIGVycm9yOiB7XG4gICAgICAgIGNvZGU6IG51bWJlcixcbiAgICAgICAgbWVzc2FnZTogc3RyaW5nLFxuICAgICAgICBkYXRhPzogYW55XG4gICAgfVxufVxuXG50eXBlIFJwY1Jlc3BvbnNlID0ge1xuICAgIGpzb25ycGM6ICcyLjAnLFxuICAgIGlkOiBzdHJpbmcgfCBudW1iZXIgfCBudWxsLFxufSAmIChScGNSZXN1bHQgfCBScGNFcnJvcilcblxudHlwZSBRdWVyeVBhcmFtcyA9IHtcbiAgICBmaWx0ZXI6IGFueSxcbiAgICBzZWxlY3Rpb246IEZpZWxkU2VsZWN0aW9uW10sXG4gICAgb3JkZXJCeT86IE9yZGVyQnlbXSxcbiAgICBsaW1pdD86IG51bWJlcixcbiAgICB0aW1lb3V0PzogbnVtYmVyLFxuICAgIGFjY2Vzc0tleT86IHN0cmluZyxcbiAgICBvcGVyYXRpb25JZD86IHN0cmluZyxcbn1cblxudHlwZSBScGNDb25uZWN0aW9uID0ge1xuICAgIHNvY2tldDogV2ViU29ja2V0LFxuICAgIHJlbW90ZUFkZHJlc3M6IHN0cmluZyxcbn1cblxuZXhwb3J0IGNsYXNzIFFScGNTZXJ2ZXIge1xuICAgIGRiOiBRRGF0YWJhc2U7XG4gICAgYXV0aDogQXV0aDtcbiAgICByZXNvbHZlcnM6IE1hcDxzdHJpbmcsICgpID0+IFByb21pc2U+O1xuICAgIHBvcnQ6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IHtcbiAgICAgICAgZGI6IFFEYXRhYmFzZSxcbiAgICAgICAgYXV0aDogQXV0aCxcbiAgICAgICAgcG9ydD86IG51bWJlcixcbiAgICB9KSB7XG4gICAgICAgIHRoaXMuZGIgPSBvcHRpb25zLmRiO1xuICAgICAgICB0aGlzLmF1dGggPSBvcHRpb25zLmF1dGg7XG4gICAgICAgIHRoaXMucmVzb2x2ZXJzID0gbmV3IE1hcCgpO1xuICAgICAgICB0aGlzLmRiLmNvbGxlY3Rpb25zLmZvckVhY2goKGMpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVzb2x2ZXJzLnNldChjLm5hbWUsIGMucXVlcnlSZXNvbHZlcigpKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucG9ydCA9IG9wdGlvbnMucG9ydCB8fCAwO1xuICAgIH1cblxuICAgIHN0YXJ0KCkge1xuICAgICAgICBpZiAodGhpcy5wb3J0ID09PSAwKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1FScGNTZXJ2ZXIgcG9ydCBoYXNuXFwndCBzcGVjaWZpZWQnKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLndzcyA9IG5ldyBXZWJTb2NrZXQuU2VydmVyKHtwb3J0OiB0aGlzLnBvcnR9KTtcbiAgICAgICAgdGhpcy53c3Mub24oJ2Nvbm5lY3Rpb24nLCAod3MsIHJlcSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29ubmVjdGlvbjogUnBjQ29ubmVjdGlvbiA9IHtcbiAgICAgICAgICAgICAgICBzb2NrZXQ6IHdzLFxuICAgICAgICAgICAgICAgIHJlbW90ZUFkZHJlc3M6IHJlcS5jb25uZWN0aW9uLnJlbW90ZUFkZHJlc3MsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgd3Mub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB3cy5vbignbWVzc2FnZScsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucnBjKGNvbm5lY3Rpb24sIGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIHJwYyhjb25uZWN0aW9uOiBScGNDb25uZWN0aW9uLCBkYXRhOiBhbnkpIHtcbiAgICAgICAgY29uc3QgcmVxdWVzdDogUnBjUmVxdWVzdCA9IEpTT04ucGFyc2UoZGF0YSk7XG4gICAgICAgIGxldCByZXNwb25zZTogUnBjUmVzcG9uc2U7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXNwb25zZSA9IHtcbiAgICAgICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcbiAgICAgICAgICAgICAgICBpZDogcmVxdWVzdC5pZCxcbiAgICAgICAgICAgICAgICByZXN1bHQ6IGF3YWl0IHRoaXMuZGlzcGF0Y2goY29ubmVjdGlvbiwgcmVxdWVzdC5tZXRob2QsIHJlcXVlc3QucGFyYW1zKSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZXNwb25zZSA9IHtcbiAgICAgICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcbiAgICAgICAgICAgICAgICBpZDogcmVxdWVzdC5pZCxcbiAgICAgICAgICAgICAgICBlcnJvcjoge1xuICAgICAgICAgICAgICAgICAgICBjb2RlOiBlcnJvci5jb2RlIHx8IDUwMCxcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbm5lY3Rpb24uc29ja2V0LnNlbmQoSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpKTtcbiAgICB9XG5cbiAgICBhc3luYyBkaXNwYXRjaChjb25uZWN0aW9uOiBScGNDb25uZWN0aW9uLCBtZXRob2Q6IHN0cmluZywgcGFyYW1zOiBhbnkpIHtcbiAgICAgICAgc3dpdGNoIChtZXRob2QpIHtcbiAgICAgICAgY2FzZSAndHJhbnNhY3Rpb25zJzpcbiAgICAgICAgY2FzZSAnYWNjb3VudHMnOlxuICAgICAgICBjYXNlICdibG9ja3MnOlxuICAgICAgICBjYXNlICdtZXNzYWdlcyc6XG4gICAgICAgIGNhc2UgJ2Jsb2NrX3NpZ25hdHVyZXMnOlxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucXVlcnkoY29ubmVjdGlvbiwgdGhpcy5kYi5jb2xsZWN0aW9uc0J5TmFtZS5nZXQobWV0aG9kKSwgcGFyYW1zKTtcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBtZXRob2QgWyR7bWV0aG9kfV1gKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIHF1ZXJ5KGNvbm5lY3Rpb246IFJwY0Nvbm5lY3Rpb24sIGNvbGxlY3Rpb246IFFDb2xsZWN0aW9uLCBwYXJhbXM6IFF1ZXJ5UGFyYW1zKSB7XG4gICAgICAgIGNvbnN0IHJlc29sdmVyOiAoXG4gICAgICAgICAgICBwYXJlbnQ6IGFueSxcbiAgICAgICAgICAgIGFyZ3M6IGFueSxcbiAgICAgICAgICAgIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dCxcbiAgICAgICAgICAgIGluZm86IGFueSxcbiAgICAgICAgKSA9PiBQcm9taXNlPFtdPiA9IHRoaXMucmVzb2x2ZXJzLmdldChjb2xsZWN0aW9uLm5hbWUpO1xuICAgICAgICBjb25zdCBkb2NzID0gYXdhaXQgcmVzb2x2ZXIoXG4gICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgcGFyYW1zLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGF1dGg6IHRoaXMuYXV0aCxcbiAgICAgICAgICAgICAgICByZW1vdGVBZGRyZXNzOiBjb25uZWN0aW9uLnJlbW90ZUFkZHJlc3MsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG9wZXJhdGlvbjoge1xuICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb25TZXQ6IHBhcmFtcy5zZWxlY3Rpb24sXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBkb2NzO1xuICAgIH1cbn1cbiJdfQ==