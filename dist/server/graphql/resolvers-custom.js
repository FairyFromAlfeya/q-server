"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.attachCustomResolvers = attachCustomResolvers;

var _kafkajs = require("kafkajs");

var _opentracing = require("opentracing");

var _blockchain = _interopRequireDefault(require("../data/blockchain"));

var _collection = require("../data/collection");

var _auth = require("../auth");

var _config = require("../config");

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _tracer = require("../tracer");

var _utils = require("../utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const {
  version
} = (0, _utils.packageJson)();

function isObject(test) {
  return typeof test === 'object' && test !== null;
}

function overrideObject(original, overrides) {
  Object.entries(overrides).forEach(([name, overrideValue]) => {
    if (name in original && isObject(overrideValue) && isObject(original[name])) {
      overrideObject(original[name], overrideValue);
    } else {
      original[name] = overrideValue;
    }
  });
}

//------------------------------------------------------------- Query
function info(_parent, _args, context) {
  return {
    version,
    time: Date.now(),
    endpoints: context.config.endpoints
  };
}

async function getAccountsCount(_parent, args, context) {
  const tracer = context.tracer;
  return _tracer.QTracer.trace(tracer, 'getAccountsCount', async () => {
    await (0, _collection.requireGrantedAccess)(context, args);
    const result = await context.data.query(context.data.accounts.provider, `RETURN LENGTH(accounts)`, {}, []);
    const counts = result;
    return counts.length > 0 ? counts[0] : 0;
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getTransactionsCount(_parent, args, context) {
  const tracer = context.tracer;
  return _tracer.QTracer.trace(tracer, 'getTransactionsCount', async () => {
    await (0, _collection.requireGrantedAccess)(context, args);
    const result = await context.data.query(context.data.transactions.provider, `RETURN LENGTH(transactions)`, {}, []);
    const counts = result;
    return counts.length > 0 ? counts[0] : 0;
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getAccountsTotalBalance(_parent, args, context) {
  const tracer = context.tracer;
  return _tracer.QTracer.trace(tracer, 'getAccountsTotalBalance', async () => {
    await (0, _collection.requireGrantedAccess)(context, args);
    /*
    Because arango can not sum BigInt's we need to sum separately:
    hs = SUM of high bits (from 24-bit and higher)
    ls = SUM of lower 24 bits
    And the total result is (hs << 24) + ls
     */

    const result = await context.data.query(context.data.accounts.provider, `
            LET d = 16777216
            FOR a in accounts
            LET b = TO_NUMBER(CONCAT("0x", SUBSTRING(a.balance, 2)))
            COLLECT AGGREGATE
                hs = SUM(FLOOR(b / d)),
                ls = SUM(b % (d - 1))
            RETURN { hs, ls }
        `, {}, []);
    const parts = result[0]; //$FlowFixMe

    return (BigInt(parts.hs) * BigInt(0x1000000) + BigInt(parts.ls)).toString();
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getManagementAccessKey(_parent, args, context) {
  return context.auth.getManagementAccessKey();
} //------------------------------------------------------------- Mutation


async function postRequestsUsingRest(requests, context, _span) {
  const config = context.config.requests;
  const url = `${(0, _config.ensureProtocol)(config.server, 'http')}/topics/${config.topic}`;
  const response = await (0, _nodeFetch.default)(url, {
    method: 'POST',
    mode: 'cors',
    cache: 'no-cache',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json'
    },
    redirect: 'follow',
    referrer: 'no-referrer',
    body: JSON.stringify({
      records: requests.map(request => ({
        key: request.id,
        value: request.body
      }))
    })
  });

  if (response.status !== 200) {
    const message = `Post requests failed: ${await response.text()}`;
    throw new Error(message);
  }
}

async function postRequestsUsingKafka(requests, context, span) {
  const ensureShared = async (name, createValue) => {
    if (context.shared.has(name)) {
      return context.shared.get(name);
    }

    const value = await createValue();
    context.shared.set(name, value);
    return value;
  };

  const config = context.config.requests;
  const producer = await ensureShared('producer', async () => {
    const kafka = await ensureShared('kafka', async () => new _kafkajs.Kafka({
      clientId: 'q-server',
      brokers: [config.server]
    }));
    const newProducer = kafka.producer();
    await newProducer.connect();
    return newProducer;
  });
  const messages = requests.map(request => {
    const traceInfo = {};
    context.data.tracer.inject(span, _opentracing.FORMAT_TEXT_MAP, traceInfo);
    const keyBuffer = Buffer.from(request.id, 'base64');
    const traceBuffer = Object.keys(traceInfo).length > 0 ? Buffer.from(JSON.stringify(traceInfo), 'utf8') : Buffer.from([]);
    const key = Buffer.concat([keyBuffer, traceBuffer]);
    const value = Buffer.from(request.body, 'base64');
    return {
      key,
      value
    };
  });
  await producer.send({
    topic: config.topic,
    messages
  });
}

async function checkPostRestrictions(contracts, requests, accessRights) {
  requests.forEach(request => {
    const size = Math.ceil(request.body.length * 3 / 4);

    if (size > 60000) {
      throw new Error(`Message size ${size} is too large`);
    }
  });

  if (accessRights.restrictToAccounts.length === 0) {
    return;
  }

  const accounts = new Set(accessRights.restrictToAccounts);

  for (const request of requests) {
    const message = await contracts.parseMessage({
      bocBase64: request.body
    });

    if (!accounts.has(message.dst)) {
      throw _auth.Auth.unauthorizedError();
    }
  }
}

async function postRequests(_, args, context) {
  const requests = args.requests;

  if (!requests) {
    return [];
  }

  const tracer = context.tracer;
  return _tracer.QTracer.trace(tracer, 'postRequests', async span => {
    span.setTag('params', requests);
    const accessRights = await (0, _collection.requireGrantedAccess)(context, args);
    await checkPostRestrictions(context.client.contracts, requests, accessRights);
    const expired = requests.find(x => x.expireAt && Date.now() > x.expireAt);

    if (expired) {
      throw _utils.QError.messageExpired(expired.id, expired.expireAt);
    }

    const messageTraceSpans = requests.map(request => {
      const messageId = Buffer.from(request.id, 'base64').toString('hex');
      const postSpan = tracer.startSpan('postRequest', {
        childOf: _tracer.QTracer.messageRootSpanContext(messageId)
      });
      postSpan.addTags({
        messageId,
        messageSize: Math.ceil(request.body.length * 3 / 4)
      });
      return postSpan;
    });

    try {
      if (context.config.requests.mode === 'rest') {
        await postRequestsUsingRest(requests, context, span);
      } else {
        await postRequestsUsingKafka(requests, context, span);
      }

      context.data.statPostCount.increment();
      context.data.log.debug('postRequests', 'POSTED', args, context.remoteAddress);
    } catch (error) {
      context.data.statPostFailed.increment();
      context.data.log.debug('postRequests', 'FAILED', args, context.remoteAddress);
      throw error;
    } finally {
      messageTraceSpans.forEach(x => x.finish());
    }

    return requests.map(x => x.id);
  }, context.parentSpan);
} //------------------------------------------------------------- Access Management


async function registerAccessKeys(_, args, context) {
  return context.auth.registerAccessKeys(args.account || '', args.keys || [], args.signedManagementAccessKey || '');
}

async function revokeAccessKeys(_, args, context) {
  return context.auth.revokeAccessKeys(args.account || '', args.keys || [], args.signedManagementAccessKey || '');
}

async function finishOperations(_, args, context) {
  const operationIds = new Set(args.operationIds || []);

  if (operationIds.size === 0) {
    return 0;
  }

  return context.data.finishOperations(operationIds);
}

function attachCustomResolvers(data, original) {
  overrideObject(original, {
    Query: {
      info,
      getAccountsCount,
      getTransactionsCount,
      getAccountsTotalBalance,
      getManagementAccessKey,
      aggregateBlockSignatures: data.blocks_signatures.aggregationResolver(),
      aggregateBlocks: data.blocks.aggregationResolver(),
      aggregateTransactions: data.transactions.aggregationResolver(),
      aggregateMessages: data.messages.aggregationResolver(),
      aggregateAccounts: data.accounts.aggregationResolver(),
      explainQueryBlockSignatures: data.blocks_signatures.explainQueryResolver(),
      explainQueryBlocks: data.blocks.explainQueryResolver(),
      explainQueryTransactions: data.transactions.explainQueryResolver(),
      explainQueryMessages: data.messages.explainQueryResolver(),
      explainQueryAccounts: data.accounts.explainQueryResolver()
    },
    Mutation: {
      postRequests,
      registerAccessKeys,
      revokeAccessKeys,
      finishOperations
    }
  });
  return original;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZ3JhcGhxbC9yZXNvbHZlcnMtY3VzdG9tLmpzIl0sIm5hbWVzIjpbInZlcnNpb24iLCJpc09iamVjdCIsInRlc3QiLCJvdmVycmlkZU9iamVjdCIsIm9yaWdpbmFsIiwib3ZlcnJpZGVzIiwiT2JqZWN0IiwiZW50cmllcyIsImZvckVhY2giLCJuYW1lIiwib3ZlcnJpZGVWYWx1ZSIsImluZm8iLCJfcGFyZW50IiwiX2FyZ3MiLCJjb250ZXh0IiwidGltZSIsIkRhdGUiLCJub3ciLCJlbmRwb2ludHMiLCJjb25maWciLCJnZXRBY2NvdW50c0NvdW50IiwiYXJncyIsInRyYWNlciIsIlFUcmFjZXIiLCJ0cmFjZSIsInJlc3VsdCIsImRhdGEiLCJxdWVyeSIsImFjY291bnRzIiwicHJvdmlkZXIiLCJjb3VudHMiLCJsZW5ndGgiLCJnZXRQYXJlbnRTcGFuIiwiZ2V0VHJhbnNhY3Rpb25zQ291bnQiLCJ0cmFuc2FjdGlvbnMiLCJnZXRBY2NvdW50c1RvdGFsQmFsYW5jZSIsInBhcnRzIiwiQmlnSW50IiwiaHMiLCJscyIsInRvU3RyaW5nIiwiZ2V0TWFuYWdlbWVudEFjY2Vzc0tleSIsImF1dGgiLCJwb3N0UmVxdWVzdHNVc2luZ1Jlc3QiLCJyZXF1ZXN0cyIsIl9zcGFuIiwidXJsIiwic2VydmVyIiwidG9waWMiLCJyZXNwb25zZSIsIm1ldGhvZCIsIm1vZGUiLCJjYWNoZSIsImNyZWRlbnRpYWxzIiwiaGVhZGVycyIsInJlZGlyZWN0IiwicmVmZXJyZXIiLCJib2R5IiwiSlNPTiIsInN0cmluZ2lmeSIsInJlY29yZHMiLCJtYXAiLCJyZXF1ZXN0Iiwia2V5IiwiaWQiLCJ2YWx1ZSIsInN0YXR1cyIsIm1lc3NhZ2UiLCJ0ZXh0IiwiRXJyb3IiLCJwb3N0UmVxdWVzdHNVc2luZ0thZmthIiwic3BhbiIsImVuc3VyZVNoYXJlZCIsImNyZWF0ZVZhbHVlIiwic2hhcmVkIiwiaGFzIiwiZ2V0Iiwic2V0IiwicHJvZHVjZXIiLCJrYWZrYSIsIkthZmthIiwiY2xpZW50SWQiLCJicm9rZXJzIiwibmV3UHJvZHVjZXIiLCJjb25uZWN0IiwibWVzc2FnZXMiLCJ0cmFjZUluZm8iLCJpbmplY3QiLCJGT1JNQVRfVEVYVF9NQVAiLCJrZXlCdWZmZXIiLCJCdWZmZXIiLCJmcm9tIiwidHJhY2VCdWZmZXIiLCJrZXlzIiwiY29uY2F0Iiwic2VuZCIsImNoZWNrUG9zdFJlc3RyaWN0aW9ucyIsImNvbnRyYWN0cyIsImFjY2Vzc1JpZ2h0cyIsInNpemUiLCJNYXRoIiwiY2VpbCIsInJlc3RyaWN0VG9BY2NvdW50cyIsIlNldCIsInBhcnNlTWVzc2FnZSIsImJvY0Jhc2U2NCIsImRzdCIsIkF1dGgiLCJ1bmF1dGhvcml6ZWRFcnJvciIsInBvc3RSZXF1ZXN0cyIsIl8iLCJzZXRUYWciLCJjbGllbnQiLCJleHBpcmVkIiwiZmluZCIsIngiLCJleHBpcmVBdCIsIlFFcnJvciIsIm1lc3NhZ2VFeHBpcmVkIiwibWVzc2FnZVRyYWNlU3BhbnMiLCJtZXNzYWdlSWQiLCJwb3N0U3BhbiIsInN0YXJ0U3BhbiIsImNoaWxkT2YiLCJtZXNzYWdlUm9vdFNwYW5Db250ZXh0IiwiYWRkVGFncyIsIm1lc3NhZ2VTaXplIiwic3RhdFBvc3RDb3VudCIsImluY3JlbWVudCIsImxvZyIsImRlYnVnIiwicmVtb3RlQWRkcmVzcyIsImVycm9yIiwic3RhdFBvc3RGYWlsZWQiLCJmaW5pc2giLCJwYXJlbnRTcGFuIiwicmVnaXN0ZXJBY2Nlc3NLZXlzIiwiYWNjb3VudCIsInNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXkiLCJyZXZva2VBY2Nlc3NLZXlzIiwiZmluaXNoT3BlcmF0aW9ucyIsIm9wZXJhdGlvbklkcyIsImF0dGFjaEN1c3RvbVJlc29sdmVycyIsIlF1ZXJ5IiwiYWdncmVnYXRlQmxvY2tTaWduYXR1cmVzIiwiYmxvY2tzX3NpZ25hdHVyZXMiLCJhZ2dyZWdhdGlvblJlc29sdmVyIiwiYWdncmVnYXRlQmxvY2tzIiwiYmxvY2tzIiwiYWdncmVnYXRlVHJhbnNhY3Rpb25zIiwiYWdncmVnYXRlTWVzc2FnZXMiLCJhZ2dyZWdhdGVBY2NvdW50cyIsImV4cGxhaW5RdWVyeUJsb2NrU2lnbmF0dXJlcyIsImV4cGxhaW5RdWVyeVJlc29sdmVyIiwiZXhwbGFpblF1ZXJ5QmxvY2tzIiwiZXhwbGFpblF1ZXJ5VHJhbnNhY3Rpb25zIiwiZXhwbGFpblF1ZXJ5TWVzc2FnZXMiLCJleHBsYWluUXVlcnlBY2NvdW50cyIsIk11dGF0aW9uIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBSUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7Ozs7QUFFQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBYyx5QkFBcEI7O0FBRUEsU0FBU0MsUUFBVCxDQUFrQkMsSUFBbEIsRUFBc0M7QUFDbEMsU0FBTyxPQUFPQSxJQUFQLEtBQWdCLFFBQWhCLElBQTRCQSxJQUFJLEtBQUssSUFBNUM7QUFDSDs7QUFFRCxTQUFTQyxjQUFULENBQXdCQyxRQUF4QixFQUF1Q0MsU0FBdkMsRUFBdUQ7QUFDbkRDLEVBQUFBLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlRixTQUFmLEVBQTBCRyxPQUExQixDQUFrQyxDQUFDLENBQUNDLElBQUQsRUFBT0MsYUFBUCxDQUFELEtBQTJCO0FBQ3pELFFBQUtELElBQUksSUFBSUwsUUFBVCxJQUFzQkgsUUFBUSxDQUFDUyxhQUFELENBQTlCLElBQWlEVCxRQUFRLENBQUNHLFFBQVEsQ0FBQ0ssSUFBRCxDQUFULENBQTdELEVBQStFO0FBQzNFTixNQUFBQSxjQUFjLENBQUNDLFFBQVEsQ0FBQ0ssSUFBRCxDQUFULEVBQWlCQyxhQUFqQixDQUFkO0FBQ0gsS0FGRCxNQUVPO0FBQ0hOLE1BQUFBLFFBQVEsQ0FBQ0ssSUFBRCxDQUFSLEdBQWlCQyxhQUFqQjtBQUNIO0FBQ0osR0FORDtBQU9IOztBQWtCRDtBQUVBLFNBQVNDLElBQVQsQ0FBY0MsT0FBZCxFQUF1QkMsS0FBdkIsRUFBOEJDLE9BQTlCLEVBQXNFO0FBQ2xFLFNBQU87QUFD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O0FBUUhHLE1BQUFBLHFCQUFxQixFQUFFM0gsSUFBSSxDQUFDUSxZQUFMLENBQWtCZ0gsbUJBQWxCLEVBUnBCO0FBU0hJLE1BQUFBLGlCQUFpQixFQUFFNUgsSUFBSSxDQUFDMkQsUUFBTCxDQUFjNkQsbUJBQWQsRUFUaEI7QUFVSEssTUFBQUEsaUJBQWlCLEVBQUU3SCxJQUFJLENBQUNFLFFBQUwsQ0FBY3NILG1CQUFkLEVBVmhCO0FBV0hNLE1BQUFBLDJCQUEyQixFQUFFOUgsSUFBSSxDQUFDdUgsaUJBQUwsQ0FBdUJRLG9CQUF2QixFQVgxQjtBQVlIQyxNQUFBQSxrQkFBa0IsRUFBRWhJLElBQUksQ0FBQzBILE1BQUwsQ0FBWUssb0JBQVosRUFaakI7QUFhSEUsTUFBQUEsd0JBQXdCLEVBQUVqSSxJQUFJLENBQUNRLFlBQUwsQ0FBa0J1SCxvQkFBbEIsRUFidkI7QUFjSEcsTUFBQUEsb0JBQW9CLEVBQUVsSSxJQUFJLENBQUMyRCxRQUFMLENBQWNvRSxvQkFBZCxFQWRuQjtBQWVISSxNQUFBQSxvQkFBb0IsRUFBRW5JLElBQUksQ0FBQ0UsUUFBTCxDQUFjNkgsb0JBQWQ7QUFmbkIsS0FEYztBQWtCckJLLElBQUFBLFFBQVEsRUFBRTtBQUNOakQsTUFBQUEsWUFETTtBQUVOMkIsTUFBQUEsa0JBRk07QUFHTkcsTUFBQUEsZ0JBSE07QUFJTkMsTUFBQUE7QUFKTTtBQWxCVyxHQUFYLENBQWQ7QUF5QkEsU0FBT3hJLFFBQVA7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB7IEthZmthLCBQcm9kdWNlciB9IGZyb20gJ2thZmthanMnO1xuaW1wb3J0IHsgU3BhbiwgRk9STUFUX1RFWFRfTUFQIH0gZnJvbSAnb3BlbnRyYWNpbmcnO1xuaW1wb3J0IHR5cGUgeyBUT05Db250cmFjdHMgfSBmcm9tICd0b24tY2xpZW50LWpzL3R5cGVzJztcbmltcG9ydCBRQmxvY2tjaGFpbkRhdGEgZnJvbSAnLi4vZGF0YS9ibG9ja2NoYWluJztcbmltcG9ydCB7IHJlcXVpcmVHcmFudGVkQWNjZXNzIH0gZnJvbSAnLi4vZGF0YS9jb2xsZWN0aW9uJztcbmltcG9ydCB0eXBlIHtcbiAgICBHcmFwaFFMUmVxdWVzdENvbnRleHQsXG59IGZyb20gJy4uL2RhdGEvY29sbGVjdGlvbic7XG5pbXBvcnQgeyBBdXRoIH0gZnJvbSAnLi4vYXV0aCc7XG5pbXBvcnQgeyBlbnN1cmVQcm90b2NvbCB9IGZyb20gJy4uL2NvbmZpZyc7XG5pbXBvcnQgZmV0Y2ggZnJvbSAnbm9kZS1mZXRjaCc7XG5pbXBvcnQgdHlwZSB7IEFjY2Vzc0tleSwgQWNjZXNzUmlnaHRzIH0gZnJvbSAnLi4vYXV0aCc7XG5pbXBvcnQgeyBRVHJhY2VyIH0gZnJvbSAnLi4vdHJhY2VyJztcbmltcG9ydCB7IHBhY2thZ2VKc29uLCBRRXJyb3IgfSBmcm9tICcuLi91dGlscyc7XG5cbmNvbnN0IHsgdmVyc2lvbiB9ID0gcGFja2FnZUpzb24oKTtcblxuZnVuY3Rpb24gaXNPYmplY3QodGVzdDogYW55KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHR5cGVvZiB0ZXN0ID09PSAnb2JqZWN0JyAmJiB0ZXN0ICE9PSBudWxsO1xufVxuXG5mdW5jdGlvbiBvdmVycmlkZU9iamVjdChvcmlnaW5hbDogYW55LCBvdmVycmlkZXM6IGFueSkge1xuICAgIE9iamVjdC5lbnRyaWVzKG92ZXJyaWRlcykuZm9yRWFjaCgoW25hbWUsIG92ZXJyaWRlVmFsdWVdKSA9PiB7XG4gICAgICAgIGlmICgobmFtZSBpbiBvcmlnaW5hbCkgJiYgaXNPYmplY3Qob3ZlcnJpZGVWYWx1ZSkgJiYgaXNPYmplY3Qob3JpZ2luYWxbbmFtZV0pKSB7XG4gICAgICAgICAgICBvdmVycmlkZU9iamVjdChvcmlnaW5hbFtuYW1lXSwgb3ZlcnJpZGVWYWx1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvcmlnaW5hbFtuYW1lXSA9IG92ZXJyaWRlVmFsdWU7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxudHlwZSBJbmZvID0ge1xuICAgIHZlcnNpb246IHN0cmluZyxcbiAgICB0aW1lOiBudW1iZXIsXG4gICAgZW5kcG9pbnRzOiBzdHJpbmdbXSxcbn1cblxudHlwZSBSZXF1ZXN0ID0ge1xuICAgIGlkOiBzdHJpbmcsXG4gICAgYm9keTogc3RyaW5nLFxuICAgIGV4cGlyZUF0OiBudW1iZXIsXG59XG5cbmV4cG9ydCB0eXBlIEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4ID0gR3JhcGhRTFJlcXVlc3RDb250ZXh0ICYge1xuICAgIGRhdGE6IFFCbG9ja2NoYWluRGF0YSxcbn1cblxuLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIFF1ZXJ5XG5cbmZ1bmN0aW9uIGluZm8oX3BhcmVudCwgX2FyZ3MsIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4KTogSW5mbyB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgdmVyc2lvbixcbiAgICAgICAgdGltZTogRGF0ZS5ub3coKSxcbiAgICAgICAgZW5kcG9pbnRzOiBjb250ZXh0LmNvbmZpZy5lbmRwb2ludHMsXG4gICAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0QWNjb3VudHNDb3VudChfcGFyZW50LCBhcmdzLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgdHJhY2VyID0gY29udGV4dC50cmFjZXI7XG4gICAgcmV0dXJuIFFUcmFjZXIudHJhY2UodHJhY2VyLCAnZ2V0QWNjb3VudHNDb3VudCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgcmVxdWlyZUdyYW50ZWRBY2Nlc3MoY29udGV4dCwgYXJncyk7XG4gICAgICAgIGNvbnN0IHJlc3VsdDogYW55ID0gYXdhaXQgY29udGV4dC5kYXRhLnF1ZXJ5KFxuICAgICAgICAgICAgY29udGV4dC5kYXRhLmFjY291bnRzLnByb3ZpZGVyLFxuICAgICAgICAgICAgYFJFVFVSTiBMRU5HVEgoYWNjb3VudHMpYCxcbiAgICAgICAgICAgIHt9LFxuICAgICAgICAgICAgW10sXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGNvdW50cyA9IChyZXN1bHQ6IG51bWJlcltdKTtcbiAgICAgICAgcmV0dXJuIGNvdW50cy5sZW5ndGggPiAwID8gY291bnRzWzBdIDogMDtcbiAgICB9LCBRVHJhY2VyLmdldFBhcmVudFNwYW4odHJhY2VyLCBjb250ZXh0KSlcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0VHJhbnNhY3Rpb25zQ291bnQoX3BhcmVudCwgYXJncywgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IHRyYWNlciA9IGNvbnRleHQudHJhY2VyO1xuICAgIHJldHVybiBRVHJhY2VyLnRyYWNlKHRyYWNlciwgJ2dldFRyYW5zYWN0aW9uc0NvdW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCByZXF1aXJlR3JhbnRlZEFjY2Vzcyhjb250ZXh0LCBhcmdzKTtcbiAgICAgICAgY29uc3QgcmVzdWx0OiBhbnkgPSBhd2FpdCBjb250ZXh0LmRhdGEucXVlcnkoXG4gICAgICAgICAgICBjb250ZXh0LmRhdGEudHJhbnNhY3Rpb25zLnByb3ZpZGVyLFxuICAgICAgICAgICAgYFJFVFVSTiBMRU5HVEgodHJhbnNhY3Rpb25zKWAsXG4gICAgICAgICAgICB7fSxcbiAgICAgICAgICAgIFtdLFxuICAgICAgICApO1xuICAgICAgICBjb25zdCBjb3VudHMgPSAocmVzdWx0OiBudW1iZXJbXSk7XG4gICAgICAgIHJldHVybiBjb3VudHMubGVuZ3RoID4gMCA/IGNvdW50c1swXSA6IDA7XG4gICAgfSwgUVRyYWNlci5nZXRQYXJlbnRTcGFuKHRyYWNlciwgY29udGV4dCkpXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFjY291bnRzVG90YWxCYWxhbmNlKF9wYXJlbnQsIGFyZ3MsIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4KTogUHJvbWlzZTxTdHJpbmc+IHtcbiAgICBjb25zdCB0cmFjZXIgPSBjb250ZXh0LnRyYWNlcjtcbiAgICByZXR1cm4gUVRyYWNlci50cmFjZSh0cmFjZXIsICdnZXRBY2NvdW50c1RvdGFsQmFsYW5jZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgcmVxdWlyZUdyYW50ZWRBY2Nlc3MoY29udGV4dCwgYXJncyk7XG4gICAgICAgIC8qXG4gICAgICAgIEJlY2F1c2UgYXJhbmdvIGNhbiBub3Qgc3VtIEJpZ0ludCdzIHdlIG5lZWQgdG8gc3VtIHNlcGFyYXRlbHk6XG4gICAgICAgIGhzID0gU1VNIG9mIGhpZ2ggYml0cyAoZnJvbSAyNC1iaXQgYW5kIGhpZ2hlcilcbiAgICAgICAgbHMgPSBTVU0gb2YgbG93ZXIgMjQgYml0c1xuICAgICAgICBBbmQgdGhlIHRvdGFsIHJlc3VsdCBpcyAoaHMgPDwgMjQpICsgbHNcbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IHJlc3VsdDogYW55ID0gYXdhaXQgY29udGV4dC5kYXRhLnF1ZXJ5KFxuICAgICAgICAgICAgY29udGV4dC5kYXRhLmFjY291bnRzLnByb3ZpZGVyLFxuICAgICAgICAgICAgYFxuICAgICAgICAgICAgTEVUIGQgPSAxNjc3NzIxNlxuICAgICAgICAgICAgRk9SIGEgaW4gYWNjb3VudHNcbiAgICAgICAgICAgIExFVCBiID0gVE9fTlVNQkVSKENPTkNBVChcIjB4XCIsIFNVQlNUUklORyhhLmJhbGFuY2UsIDIpKSlcbiAgICAgICAgICAgIENPTExFQ1QgQUdHUkVHQVRFXG4gICAgICAgICAgICAgICAgaHMgPSBTVU0oRkxPT1IoYiAvIGQpKSxcbiAgICAgICAgICAgICAgICBscyA9IFNVTShiICUgKGQgLSAxKSlcbiAgICAgICAgICAgIFJFVFVSTiB7IGhzLCBscyB9XG4gICAgICAgIGAsXG4gICAgICAgICAgICB7fSxcbiAgICAgICAgICAgIFtdKTtcbiAgICAgICAgY29uc3QgcGFydHMgPSAocmVzdWx0OiB7IGhzOiBudW1iZXIsIGxzOiBudW1iZXIgfVtdKVswXTtcbiAgICAgICAgLy8kRmxvd0ZpeE1lXG4gICAgICAgIHJldHVybiAoQmlnSW50KHBhcnRzLmhzKSAqIEJpZ0ludCgweDEwMDAwMDApICsgQmlnSW50KHBhcnRzLmxzKSkudG9TdHJpbmcoKTtcbiAgICB9LCBRVHJhY2VyLmdldFBhcmVudFNwYW4odHJhY2VyLCBjb250ZXh0KSlcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0TWFuYWdlbWVudEFjY2Vzc0tleShfcGFyZW50LCBhcmdzLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIGNvbnRleHQuYXV0aC5nZXRNYW5hZ2VtZW50QWNjZXNzS2V5KCk7XG59XG5cblxuLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIE11dGF0aW9uXG5cblxuYXN5bmMgZnVuY3Rpb24gcG9zdFJlcXVlc3RzVXNpbmdSZXN0KHJlcXVlc3RzOiBSZXF1ZXN0W10sIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4LCBfc3BhbjogU3Bhbik6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGNvbmZpZyA9IGNvbnRleHQuY29uZmlnLnJlcXVlc3RzO1xuICAgIGNvbnN0IHVybCA9IGAke2Vuc3VyZVByb3RvY29sKGNvbmZpZy5zZXJ2ZXIsICdodHRwJyl9L3RvcGljcy8ke2NvbmZpZy50b3BpY31gO1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsLCB7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBtb2RlOiAnY29ycycsXG4gICAgICAgIGNhY2hlOiAnbm8tY2FjaGUnLFxuICAgICAgICBjcmVkZW50aWFsczogJ3NhbWUtb3JpZ2luJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgfSxcbiAgICAgICAgcmVkaXJlY3Q6ICdmb2xsb3cnLFxuICAgICAgICByZWZlcnJlcjogJ25vLXJlZmVycmVyJyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgcmVjb3JkczogcmVxdWVzdHMubWFwKChyZXF1ZXN0KSA9PiAoe1xuICAgICAgICAgICAgICAgIGtleTogcmVxdWVzdC5pZCxcbiAgICAgICAgICAgICAgICB2YWx1ZTogcmVxdWVzdC5ib2R5LFxuICAgICAgICAgICAgfSkpLFxuICAgICAgICB9KSxcbiAgICB9KTtcbiAgICBpZiAocmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IGBQb3N0IHJlcXVlc3RzIGZhaWxlZDogJHthd2FpdCByZXNwb25zZS50ZXh0KCl9YDtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1lc3NhZ2UpO1xuICAgIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcG9zdFJlcXVlc3RzVXNpbmdLYWZrYShyZXF1ZXN0czogUmVxdWVzdFtdLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCwgc3BhbjogU3Bhbik6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGVuc3VyZVNoYXJlZCA9IGFzeW5jIChuYW1lLCBjcmVhdGVWYWx1ZTogKCkgPT4gUHJvbWlzZTxhbnk+KSA9PiB7XG4gICAgICAgIGlmIChjb250ZXh0LnNoYXJlZC5oYXMobmFtZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBjb250ZXh0LnNoYXJlZC5nZXQobmFtZSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdmFsdWUgPSBhd2FpdCBjcmVhdGVWYWx1ZSgpO1xuICAgICAgICBjb250ZXh0LnNoYXJlZC5zZXQobmFtZSwgdmFsdWUpO1xuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfTtcblxuICAgIGNvbnN0IGNvbmZpZyA9IGNvbnRleHQuY29uZmlnLnJlcXVlc3RzO1xuICAgIGNvbnN0IHByb2R1Y2VyOiBQcm9kdWNlciA9IGF3YWl0IGVuc3VyZVNoYXJlZCgncHJvZHVjZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGthZmthOiBLYWZrYSA9IGF3YWl0IGVuc3VyZVNoYXJlZCgna2Fma2EnLCBhc3luYyAoKSA9PiBuZXcgS2Fma2Eoe1xuICAgICAgICAgICAgY2xpZW50SWQ6ICdxLXNlcnZlcicsXG4gICAgICAgICAgICBicm9rZXJzOiBbY29uZmlnLnNlcnZlcl0sXG4gICAgICAgIH0pKTtcbiAgICAgICAgY29uc3QgbmV3UHJvZHVjZXIgPSBrYWZrYS5wcm9kdWNlcigpO1xuICAgICAgICBhd2FpdCBuZXdQcm9kdWNlci5jb25uZWN0KCk7XG4gICAgICAgIHJldHVybiBuZXdQcm9kdWNlcjtcblxuICAgIH0pO1xuXG4gICAgY29uc3QgbWVzc2FnZXMgPSByZXF1ZXN0cy5tYXAoKHJlcXVlc3QpID0+IHtcbiAgICAgICAgY29uc3QgdHJhY2VJbmZvID0ge307XG4gICAgICAgIGNvbnRleHQuZGF0YS50cmFjZXIuaW5qZWN0KHNwYW4sIEZPUk1BVF9URVhUX01BUCwgdHJhY2VJbmZvKTtcbiAgICAgICAgY29uc3Qga2V5QnVmZmVyID0gQnVmZmVyLmZyb20ocmVxdWVzdC5pZCwgJ2Jhc2U2NCcpO1xuICAgICAgICBjb25zdCB0cmFjZUJ1ZmZlciA9IChPYmplY3Qua2V5cyh0cmFjZUluZm8pLmxlbmd0aCA+IDApXG4gICAgICAgICAgICA/IEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KHRyYWNlSW5mbyksICd1dGY4JylcbiAgICAgICAgICAgIDogQnVmZmVyLmZyb20oW10pO1xuICAgICAgICBjb25zdCBrZXkgPSBCdWZmZXIuY29uY2F0KFtrZXlCdWZmZXIsIHRyYWNlQnVmZmVyXSk7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gQnVmZmVyLmZyb20ocmVxdWVzdC5ib2R5LCAnYmFzZTY0Jyk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBrZXksXG4gICAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgfTtcbiAgICB9KTtcbiAgICBhd2FpdCBwcm9kdWNlci5zZW5kKHtcbiAgICAgICAgdG9waWM6IGNvbmZpZy50b3BpYyxcbiAgICAgICAgbWVzc2FnZXMsXG4gICAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNoZWNrUG9zdFJlc3RyaWN0aW9ucyhcbiAgICBjb250cmFjdHM6IFRPTkNvbnRyYWN0cyxcbiAgICByZXF1ZXN0czogUmVxdWVzdFtdLFxuICAgIGFjY2Vzc1JpZ2h0czogQWNjZXNzUmlnaHRzLFxuKSB7XG4gICAgcmVxdWVzdHMuZm9yRWFjaCgocmVxdWVzdCkgPT4ge1xuICAgICAgICBjb25zdCBzaXplID0gTWF0aC5jZWlsKHJlcXVlc3QuYm9keS5sZW5ndGggKiAzIC8gNCk7XG4gICAgICAgIGlmIChzaXplID4gNjAwMDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgTWVzc2FnZSBzaXplICR7c2l6ZX0gaXMgdG9vIGxhcmdlYCk7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmIChhY2Nlc3NSaWdodHMucmVzdHJpY3RUb0FjY291bnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGFjY291bnRzID0gbmV3IFNldChhY2Nlc3NSaWdodHMucmVzdHJpY3RUb0FjY291bnRzKTtcbiAgICBmb3IgKGNvbnN0IHJlcXVlc3Q6IFJlcXVlc3Qgb2YgcmVxdWVzdHMpIHtcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IGF3YWl0IGNvbnRyYWN0cy5wYXJzZU1lc3NhZ2Uoe1xuICAgICAgICAgICAgYm9jQmFzZTY0OiByZXF1ZXN0LmJvZHksXG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoIWFjY291bnRzLmhhcyhtZXNzYWdlLmRzdCkpIHtcbiAgICAgICAgICAgIHRocm93IEF1dGgudW5hdXRob3JpemVkRXJyb3IoKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcG9zdFJlcXVlc3RzKFxuICAgIF8sXG4gICAgYXJnczogeyByZXF1ZXN0czogUmVxdWVzdFtdLCBhY2Nlc3NLZXk/OiBzdHJpbmcgfSxcbiAgICBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCxcbik6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCByZXF1ZXN0czogPyhSZXF1ZXN0W10pID0gYXJncy5yZXF1ZXN0cztcbiAgICBpZiAoIXJlcXVlc3RzKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBjb25zdCB0cmFjZXIgPSBjb250ZXh0LnRyYWNlcjtcbiAgICByZXR1cm4gUVRyYWNlci50cmFjZSh0cmFjZXIsICdwb3N0UmVxdWVzdHMnLCBhc3luYyAoc3BhbjogU3BhbikgPT4ge1xuICAgICAgICBzcGFuLnNldFRhZygncGFyYW1zJywgcmVxdWVzdHMpO1xuICAgICAgICBjb25zdCBhY2Nlc3NSaWdodHMgPSBhd2FpdCByZXF1aXJlR3JhbnRlZEFjY2Vzcyhjb250ZXh0LCBhcmdzKTtcbiAgICAgICAgYXdhaXQgY2hlY2tQb3N0UmVzdHJpY3Rpb25zKGNvbnRleHQuY2xpZW50LmNvbnRyYWN0cywgcmVxdWVzdHMsIGFjY2Vzc1JpZ2h0cyk7XG5cbiAgICAgICAgY29uc3QgZXhwaXJlZDogP1JlcXVlc3QgPSByZXF1ZXN0cy5maW5kKHggPT4geC5leHBpcmVBdCAmJiAoRGF0ZS5ub3coKSA+IHguZXhwaXJlQXQpKTtcbiAgICAgICAgaWYgKGV4cGlyZWQpIHtcbiAgICAgICAgICAgIHRocm93IFFFcnJvci5tZXNzYWdlRXhwaXJlZChleHBpcmVkLmlkLCBleHBpcmVkLmV4cGlyZUF0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG1lc3NhZ2VUcmFjZVNwYW5zID0gcmVxdWVzdHMubWFwKChyZXF1ZXN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlSWQgPSBCdWZmZXIuZnJvbShyZXF1ZXN0LmlkLCAnYmFzZTY0JykudG9TdHJpbmcoJ2hleCcpO1xuICAgICAgICAgICAgY29uc3QgcG9zdFNwYW4gPSB0cmFjZXIuc3RhcnRTcGFuKCdwb3N0UmVxdWVzdCcsIHtcbiAgICAgICAgICAgICAgICBjaGlsZE9mOiBRVHJhY2VyLm1lc3NhZ2VSb290U3BhbkNvbnRleHQobWVzc2FnZUlkKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcG9zdFNwYW4uYWRkVGFncyh7XG4gICAgICAgICAgICAgICAgbWVzc2FnZUlkLFxuICAgICAgICAgICAgICAgIG1lc3NhZ2VTaXplOiBNYXRoLmNlaWwocmVxdWVzdC5ib2R5Lmxlbmd0aCAqIDMgLyA0KSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICByZXR1cm4gcG9zdFNwYW47XG4gICAgICAgIH0pO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKGNvbnRleHQuY29uZmlnLnJlcXVlc3RzLm1vZGUgPT09ICdyZXN0Jykge1xuICAgICAgICAgICAgICAgIGF3YWl0IHBvc3RSZXF1ZXN0c1VzaW5nUmVzdChyZXF1ZXN0cywgY29udGV4dCwgc3Bhbik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGF3YWl0IHBvc3RSZXF1ZXN0c1VzaW5nS2Fma2EocmVxdWVzdHMsIGNvbnRleHQsIHNwYW4pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29udGV4dC5kYXRhLnN0YXRQb3N0Q291bnQuaW5jcmVtZW50KCk7XG4gICAgICAgICAgICBjb250ZXh0LmRhdGEubG9nLmRlYnVnKCdwb3N0UmVxdWVzdHMnLCAnUE9TVEVEJywgYXJncywgY29udGV4dC5yZW1vdGVBZGRyZXNzKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnRleHQuZGF0YS5zdGF0UG9zdEZhaWxlZC5pbmNyZW1lbnQoKTtcbiAgICAgICAgICAgIGNvbnRleHQuZGF0YS5sb2cuZGVidWcoJ3Bvc3RSZXF1ZXN0cycsICdGQUlMRUQnLCBhcmdzLCBjb250ZXh0LnJlbW90ZUFkZHJlc3MpO1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBtZXNzYWdlVHJhY2VTcGFucy5mb3JFYWNoKHggPT4geC5maW5pc2goKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlcXVlc3RzLm1hcCh4ID0+IHguaWQpO1xuICAgIH0sIGNvbnRleHQucGFyZW50U3Bhbik7XG59XG5cbi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBBY2Nlc3MgTWFuYWdlbWVudFxuXG50eXBlIE1hbmFnZW1lbnRBcmdzID0ge1xuICAgIGFjY291bnQ/OiBzdHJpbmcsXG4gICAgc2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleT86IHN0cmluZyxcbn1cblxudHlwZSBSZWdpc3RlckFjY2Vzc0tleXNBcmdzID0gTWFuYWdlbWVudEFyZ3MgJiB7XG4gICAga2V5czogQWNjZXNzS2V5W10sXG59XG5cbnR5cGUgUmV2b2tlQWNjZXNzS2V5c0FyZ3MgPSBNYW5hZ2VtZW50QXJncyAmIHtcbiAgICBrZXlzOiBzdHJpbmdbXSxcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVnaXN0ZXJBY2Nlc3NLZXlzKFxuICAgIF8sXG4gICAgYXJnczogUmVnaXN0ZXJBY2Nlc3NLZXlzQXJncyxcbiAgICBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCxcbik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgcmV0dXJuIGNvbnRleHQuYXV0aC5yZWdpc3RlckFjY2Vzc0tleXMoXG4gICAgICAgIGFyZ3MuYWNjb3VudCB8fCAnJyxcbiAgICAgICAgYXJncy5rZXlzIHx8IFtdLFxuICAgICAgICBhcmdzLnNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXkgfHwgJycpO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZXZva2VBY2Nlc3NLZXlzKFxuICAgIF8sXG4gICAgYXJnczogUmV2b2tlQWNjZXNzS2V5c0FyZ3MsXG4gICAgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsXG4pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIHJldHVybiBjb250ZXh0LmF1dGgucmV2b2tlQWNjZXNzS2V5cyhcbiAgICAgICAgYXJncy5hY2NvdW50IHx8ICcnLFxuICAgICAgICBhcmdzLmtleXMgfHwgW10sXG4gICAgICAgIGFyZ3Muc2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleSB8fCAnJyk7XG59XG5cbnR5cGUgRmluaXNoT3BlcmF0aW9uc0FyZ3MgPSB7XG4gICAgb3BlcmF0aW9uSWRzPzogc3RyaW5nW10sXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpbmlzaE9wZXJhdGlvbnMoXG4gICAgXyxcbiAgICBhcmdzOiBGaW5pc2hPcGVyYXRpb25zQXJncyxcbiAgICBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCxcbik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3Qgb3BlcmF0aW9uSWRzID0gbmV3IFNldChhcmdzLm9wZXJhdGlvbklkcyB8fCBbXSk7XG4gICAgaWYgKG9wZXJhdGlvbklkcy5zaXplID09PSAwKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgICByZXR1cm4gY29udGV4dC5kYXRhLmZpbmlzaE9wZXJhdGlvbnMob3BlcmF0aW9uSWRzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGF0dGFjaEN1c3RvbVJlc29sdmVycyhkYXRhOiBRQmxvY2tjaGFpbkRhdGEsIG9yaWdpbmFsOiBhbnkpOiBhbnkge1xuICAgIG92ZXJyaWRlT2JqZWN0KG9yaWdpbmFsLCB7XG4gICAgICAgIFF1ZXJ5OiB7XG4gICAgICAgICAgICBpbmZvLFxuICAgICAgICAgICAgZ2V0QWNjb3VudHNDb3VudCxcbiAgICAgICAgICAgIGdldFRyYW5zYWN0aW9uc0NvdW50LFxuICAgICAgICAgICAgZ2V0QWNjb3VudHNUb3RhbEJhbGFuY2UsXG4gICAgICAgICAgICBnZXRNYW5hZ2VtZW50QWNjZXNzS2V5LFxuICAgICAgICAgICAgYWdncmVnYXRlQmxvY2tTaWduYXR1cmVzOiBkYXRhLmJsb2Nrc19zaWduYXR1cmVzLmFnZ3JlZ2F0aW9uUmVzb2x2ZXIoKSxcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZUJsb2NrczogZGF0YS5ibG9ja3MuYWdncmVnYXRpb25SZXNvbHZlcigpLFxuICAgICAgICAgICAgYWdncmVnYXRlVHJhbnNhY3Rpb25zOiBkYXRhLnRyYW5zYWN0aW9ucy5hZ2dyZWdhdGlvblJlc29sdmVyKCksXG4gICAgICAgICAgICBhZ2dyZWdhdGVNZXNzYWdlczogZGF0YS5tZXNzYWdlcy5hZ2dyZWdhdGlvblJlc29sdmVyKCksXG4gICAgICAgICAgICBhZ2dyZWdhdGVBY2NvdW50czogZGF0YS5hY2NvdW50cy5hZ2dyZWdhdGlvblJlc29sdmVyKCksXG4gICAgICAgICAgICBleHBsYWluUXVlcnlCbG9ja1NpZ25hdHVyZXM6IGRhdGEuYmxvY2tzX3NpZ25hdHVyZXMuZXhwbGFpblF1ZXJ5UmVzb2x2ZXIoKSxcbiAgICAgICAgICAgIGV4cGxhaW5RdWVyeUJsb2NrczogZGF0YS5ibG9ja3MuZXhwbGFpblF1ZXJ5UmVzb2x2ZXIoKSxcbiAgICAgICAgICAgIGV4cGxhaW5RdWVyeVRyYW5zYWN0aW9uczogZGF0YS50cmFuc2FjdGlvbnMuZXhwbGFpblF1ZXJ5UmVzb2x2ZXIoKSxcbiAgICAgICAgICAgIGV4cGxhaW5RdWVyeU1lc3NhZ2VzOiBkYXRhLm1lc3NhZ2VzLmV4cGxhaW5RdWVyeVJlc29sdmVyKCksXG4gICAgICAgICAgICBleHBsYWluUXVlcnlBY2NvdW50czogZGF0YS5hY2NvdW50cy5leHBsYWluUXVlcnlSZXNvbHZlcigpLFxuICAgICAgICB9LFxuICAgICAgICBNdXRhdGlvbjoge1xuICAgICAgICAgICAgcG9zdFJlcXVlc3RzLFxuICAgICAgICAgICAgcmVnaXN0ZXJBY2Nlc3NLZXlzLFxuICAgICAgICAgICAgcmV2b2tlQWNjZXNzS2V5cyxcbiAgICAgICAgICAgIGZpbmlzaE9wZXJhdGlvbnMsXG4gICAgICAgIH0sXG4gICAgfSk7XG4gICAgcmV0dXJuIG9yaWdpbmFsO1xufVxuIl19