"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.attachCustomResolvers = attachCustomResolvers;

var _core = require("@tonclient/core");

var _kafkajs = require("kafkajs");

var _opentracing = require("opentracing");

var _blockchain = _interopRequireDefault(require("../data/blockchain"));

var _collection = require("../data/collection");

var _auth = require("../auth");

var _config = require("../config");

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _tracer = require("../tracer");

var _utils = require("../utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const {
  version
} = (0, _utils.packageJson)();

function isObject(test) {
  return typeof test === 'object' && test !== null;
}

function overrideObject(original, overrides) {
  Object.entries(overrides).forEach(([name, overrideValue]) => {
    if (name in original && isObject(overrideValue) && isObject(original[name])) {
      overrideObject(original[name], overrideValue);
    } else {
      original[name] = overrideValue;
    }
  });
}

//------------------------------------------------------------- Query
function info(_parent, _args, context) {
  return {
    version,
    time: Date.now(),
    endpoints: context.config.endpoints
  };
}

async function getAccountsCount(_parent, args, context) {
  const tracer = context.tracer;
  return _tracer.QTracer.trace(tracer, 'getAccountsCount', async () => {
    await (0, _collection.requireGrantedAccess)(context, args);
    const result = await context.data.query(context.data.accounts.provider, `RETURN LENGTH(accounts)`, {}, []);
    const counts = result;
    return counts.length > 0 ? counts[0] : 0;
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getTransactionsCount(_parent, args, context) {
  const tracer = context.tracer;
  return _tracer.QTracer.trace(tracer, 'getTransactionsCount', async () => {
    await (0, _collection.requireGrantedAccess)(context, args);
    const result = await context.data.query(context.data.transactions.provider, `RETURN LENGTH(transactions)`, {}, []);
    const counts = result;
    return counts.length > 0 ? counts[0] : 0;
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getAccountsTotalBalance(_parent, args, context) {
  const tracer = context.tracer;
  return _tracer.QTracer.trace(tracer, 'getAccountsTotalBalance', async () => {
    await (0, _collection.requireGrantedAccess)(context, args);
    /*
    Because arango can not sum BigInt's we need to sum separately:
    hs = SUM of high bits (from 24-bit and higher)
    ls = SUM of lower 24 bits
    And the total result is (hs << 24) + ls
     */

    const result = await context.data.query(context.data.accounts.provider, `
            LET d = 16777216
            FOR a in accounts
            LET b = TO_NUMBER(CONCAT("0x", SUBSTRING(a.balance, 2)))
            COLLECT AGGREGATE
                hs = SUM(FLOOR(b / d)),
                ls = SUM(b % (d - 1))
            RETURN { hs, ls }
        `, {}, []);
    const parts = result[0];
    return (BigInt(parts.hs) * BigInt(0x1000000) + BigInt(parts.ls)).toString();
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getManagementAccessKey(_parent, args, context) {
  return context.auth.getManagementAccessKey();
} //------------------------------------------------------------- Mutation


async function postRequestsUsingRest(requests, context, _span) {
  const config = context.config.requests;
  const url = `${(0, _config.ensureProtocol)(config.server, 'http')}/topics/${config.topic}`;
  const response = await (0, _nodeFetch.default)(url, {
    method: 'POST',
    mode: 'cors',
    cache: 'no-cache',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json'
    },
    redirect: 'follow',
    referrer: 'no-referrer',
    body: JSON.stringify({
      records: requests.map(request => ({
        key: request.id,
        value: request.body
      }))
    })
  });

  if (response.status !== 200) {
    const message = `Post requests failed: ${await response.text()}`;
    throw new Error(message);
  }
}

async function postRequestsUsingKafka(requests, context, span) {
  const ensureShared = async (name, createValue) => {
    if (context.shared.has(name)) {
      return context.shared.get(name);
    }

    const value = await createValue();
    context.shared.set(name, value);
    return value;
  };

  const config = context.config.requests;
  const producer = await ensureShared('producer', async () => {
    const kafka = await ensureShared('kafka', async () => new _kafkajs.Kafka({
      clientId: 'q-server',
      brokers: [config.server]
    }));
    const newProducer = kafka.producer();
    await newProducer.connect();
    return newProducer;
  });
  const messages = requests.map(request => {
    const traceInfo = {};
    context.data.tracer.inject(span, _opentracing.FORMAT_TEXT_MAP, traceInfo);
    const keyBuffer = Buffer.from(request.id, 'base64');
    const traceBuffer = Object.keys(traceInfo).length > 0 ? Buffer.from(JSON.stringify(traceInfo), 'utf8') : Buffer.from([]);
    const key = Buffer.concat([keyBuffer, traceBuffer]);
    const value = Buffer.from(request.body, 'base64');
    return {
      key,
      value
    };
  });
  await producer.send({
    topic: config.topic,
    messages
  });
}

async function checkPostRestrictions(config, client, requests, accessRights) {
  requests.forEach(request => {
    const size = Math.ceil(request.body.length * 3 / 4);

    if (size > config.requests.maxSize) {
      throw new Error(`Message size ${size} is too large. Maximum size is ${config.requests.maxSize} bytes.`);
    }
  });

  if (accessRights.restrictToAccounts.length === 0) {
    return;
  }

  const accounts = new Set(accessRights.restrictToAccounts);

  for (const request of requests) {
    const message = (await client.boc.parse_message({
      boc: request.body
    })).parsed;

    if (!accounts.has(message.dst)) {
      throw _auth.Auth.unauthorizedError();
    }
  }
}

async function postRequests(_, args, context) {
  const requests = args.requests;

  if (!requests) {
    return [];
  }

  const tracer = context.tracer;
  return _tracer.QTracer.trace(tracer, 'postRequests', async span => {
    span.setTag('params', requests);
    const accessRights = await (0, _collection.requireGrantedAccess)(context, args);
    await checkPostRestrictions(context.config, context.client, requests, accessRights);
    const expired = requests.find(x => x.expireAt && Date.now() > x.expireAt);

    if (expired) {
      throw _utils.QError.messageExpired(expired.id, expired.expireAt);
    }

    const messageTraceSpans = requests.map(request => {
      const messageId = Buffer.from(request.id, 'base64').toString('hex');
      const postSpan = tracer.startSpan('postRequest', {
        childOf: _tracer.QTracer.messageRootSpanContext(messageId)
      });
      postSpan.addTags({
        messageId,
        messageSize: Math.ceil(request.body.length * 3 / 4)
      });
      return postSpan;
    });

    try {
      if (context.config.requests.mode === 'rest') {
        await postRequestsUsingRest(requests, context, span);
      } else {
        await postRequestsUsingKafka(requests, context, span);
      }

      context.data.statPostCount.increment();
      context.data.log.debug('postRequests', 'POSTED', args, context.remoteAddress);
    } catch (error) {
      context.data.statPostFailed.increment();
      context.data.log.debug('postRequests', 'FAILED', args, context.remoteAddress);
      throw error;
    } finally {
      messageTraceSpans.forEach(x => x.finish());
    }

    return requests.map(x => x.id);
  }, context.parentSpan);
} //------------------------------------------------------------- Access Management


async function registerAccessKeys(_, args, context) {
  return context.auth.registerAccessKeys(args.account || '', args.keys || [], args.signedManagementAccessKey || '');
}

async function revokeAccessKeys(_, args, context) {
  return context.auth.revokeAccessKeys(args.account || '', args.keys || [], args.signedManagementAccessKey || '');
}

async function finishOperations(_, args, context) {
  const operationIds = new Set(args.operationIds || []);

  if (operationIds.size === 0) {
    return 0;
  }

  return context.data.finishOperations(operationIds);
}

function attachCustomResolvers(data, original) {
  overrideObject(original, {
    Query: {
      info,
      getAccountsCount,
      getTransactionsCount,
      getAccountsTotalBalance,
      getManagementAccessKey,
      aggregateBlockSignatures: data.blocks_signatures.aggregationResolver(),
      aggregateBlocks: data.blocks.aggregationResolver(),
      aggregateTransactions: data.transactions.aggregationResolver(),
      aggregateMessages: data.messages.aggregationResolver(),
      aggregateAccounts: data.accounts.aggregationResolver(),
      explainQueryBlockSignatures: data.blocks_signatures.explainQueryResolver(),
      explainQueryBlocks: data.blocks.explainQueryResolver(),
      explainQueryTransactions: data.transactions.explainQueryResolver(),
      explainQueryMessages: data.messages.explainQueryResolver(),
      explainQueryAccounts: data.accounts.explainQueryResolver()
    },
    Mutation: {
      postRequests,
      registerAccessKeys,
      revokeAccessKeys,
      finishOperations
    }
  });
  return original;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZ3JhcGhxbC9yZXNvbHZlcnMtY3VzdG9tLmpzIl0sIm5hbWVzIjpbInZlcnNpb24iLCJpc09iamVjdCIsInRlc3QiLCJvdmVycmlkZU9iamVjdCIsIm9yaWdpbmFsIiwib3ZlcnJpZGVzIiwiT2JqZWN0IiwiZW50cmllcyIsImZvckVhY2giLCJuYW1lIiwib3ZlcnJpZGVWYWx1ZSIsImluZm8iLCJfcGFyZW50IiwiX2FyZ3MiLCJjb250ZXh0IiwidGltZSIsIkRhdGUiLCJub3ciLCJlbmRwb2ludHMiLCJjb25maWciLCJnZXRBY2NvdW50c0NvdW50IiwiYXJncyIsInRyYWNlciIsIlFUcmFjZXIiLCJ0cmFjZSIsInJlc3VsdCIsImRhdGEiLCJxdWVyeSIsImFjY291bnRzIiwicHJvdmlkZXIiLCJjb3VudHMiLCJsZW5ndGgiLCJnZXRQYXJlbnRTcGFuIiwiZ2V0VHJhbnNhY3Rpb25zQ291bnQiLCJ0cmFuc2FjdGlvbnMiLCJnZXRBY2NvdW50c1RvdGFsQmFsYW5jZSIsInBhcnRzIiwiQmlnSW50IiwiaHMiLCJscyIsInRvU3RyaW5nIiwiZ2V0TWFuYWdlbWVudEFjY2Vzc0tleSIsImF1dGgiLCJwb3N0UmVxdWVzdHNVc2luZ1Jlc3QiLCJyZXF1ZXN0cyIsIl9zcGFuIiwidXJsIiwic2VydmVyIiwidG9waWMiLCJyZXNwb25zZSIsIm1ldGhvZCIsIm1vZGUiLCJjYWNoZSIsImNyZWRlbnRpYWxzIiwiaGVhZGVycyIsInJlZGlyZWN0IiwicmVmZXJyZXIiLCJib2R5IiwiSlNPTiIsInN0cmluZ2lmeSIsInJlY29yZHMiLCJtYXAiLCJyZXF1ZXN0Iiwia2V5IiwiaWQiLCJ2YWx1ZSIsInN0YXR1cyIsIm1lc3NhZ2UiLCJ0ZXh0IiwiRXJyb3IiLCJwb3N0UmVxdWVzdHNVc2luZ0thZmthIiwic3BhbiIsImVuc3VyZVNoYXJlZCIsImNyZWF0ZVZhbHVlIiwic2hhcmVkIiwiaGFzIiwiZ2V0Iiwic2V0IiwicHJvZHVjZXIiLCJrYWZrYSIsIkthZmthIiwiY2xpZW50SWQiLCJicm9rZXJzIiwibmV3UHJvZHVjZXIiLCJjb25uZWN0IiwibWVzc2FnZXMiLCJ0cmFjZUluZm8iLCJpbmplY3QiLCJGT1JNQVRfVEVYVF9NQVAiLCJrZXlCdWZmZXIiLCJCdWZmZXIiLCJmcm9tIiwidHJhY2VCdWZmZXIiLCJrZXlzIiwiY29uY2F0Iiwic2VuZCIsImNoZWNrUG9zdFJlc3RyaWN0aW9ucyIsImNsaWVudCIsImFjY2Vzc1JpZ2h0cyIsInNpemUiLCJNYXRoIiwiY2VpbCIsIm1heFNpemUiLCJyZXN0cmljdFRvQWNjb3VudHMiLCJTZXQiLCJib2MiLCJwYXJzZV9tZXNzYWdlIiwicGFyc2VkIiwiZHN0IiwiQXV0aCIsInVuYXV0aG9yaXplZEVycm9yIiwicG9zdFJlcXVlc3RzIiwiXyIsInNldFRhZyIsImV4cGlyZWQiLCJmaW5kIiwieCIsImV4cGlyZUF0IiwiUUVycm9yIiwibWVzc2FnZUV4cGlyZWQiLCJtZXNzYWdlVHJhY2VTcGFucyIsIm1lc3NhZ2VJZCIsInBvc3RTcGFuIiwic3RhcnRTcGFuIiwiY2hpbGRPZiIsIm1lc3NhZ2VSb290U3BhbkNvbnRleHQiLCJhZGRUYWdzIiwibWVzc2FnZVNpemUiLCJzdGF0UG9zdENvdW50IiwiaW5jcmVtZW50IiwibG9nIiwiZGVidWciLCJyZW1vdGVBZGRyZXNzIiwiZXJyb3IiLCJzdGF0UG9zdEZhaWxlZCIsImZpbmlzaCIsInBhcmVudFNwYW4iLCJyZWdpc3RlckFjY2Vzc0tleXMiLCJhY2NvdW50Iiwic2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleSIsInJldm9rZUFjY2Vzc0tleXMiLCJmaW5pc2hPcGVyYXRpb25zIiwib3BlcmF0aW9uSWRzIiwiYXR0YWNoQ3VzdG9tUmVzb2x2ZXJzIiwiUXVlcnkiLCJhZ2dyZWdhdGVCbG9ja1NpZ25hdHVyZXMiLCJibG9ja3Nfc2lnbmF0dXJlcyIsImFnZ3JlZ2F0aW9uUmVzb2x2ZXIiLCJhZ2dyZWdhdGVCbG9ja3MiLCJibG9ja3MiLCJhZ2dyZWdhdGVUcmFuc2FjdGlvbnMiLCJhZ2dyZWdhdGVNZXNzYWdlcyIsImFnZ3JlZ2F0ZUFjY291bnRzIiwiZXhwbGFpblF1ZXJ5QmxvY2tTaWduYXR1cmVzIiwiZXhwbGFpblF1ZXJ5UmVzb2x2ZXIiLCJleHBsYWluUXVlcnlCbG9ja3MiLCJleHBsYWluUXVlcnlUcmFuc2FjdGlvbnMiLCJleHBsYWluUXVlcnlNZXNzYWdlcyIsImV4cGxhaW5RdWVyeUFjY291bnRzIiwiTXV0YXRpb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFJQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFjLHlCQUFwQjs7QUFJQSxTQUFTQyxRQUFULENBQWtCQyxJQUFsQixFQUFzQztBQUNsQyxTQUFPLE9BQU9BLElBQVAsS0FBZ0IsUUFBaEIsSUFBNEJBLElBQUksS0FBSyxJQUE1QztBQUNIOztBQUVELFNBQVNDLGNBQVQsQ0FBd0JDLFFBQXhCLEVBQXVDQyxTQUF2QyxFQUF1RDtBQUNuREMsRUFBQUEsTUFBTSxDQUFDQyxPQUFQLENBQWVGLFNBQWYsRUFBMEJHLE9BQTFCLENBQWtDLENBQUMsQ0FBQ0MsSUFBRCxFQUFPQyxhQUFQLENBQUQsS0FBMkI7QUFDekQsUUFBS0QsSUFBSSxJQUFJTCxRQUFULElBQXNCSCxRQUFRLENBQUNTLGFBQUQsQ0FBOUIsSUFBaURULFFBQVEsQ0FBQ0csUUFBUSxDQUFDSyxJQUFELENBQVQsQ0FBN0QsRUFBK0U7QUFDM0VOLE1BQUFBLGNBQWMsQ0FBQ0MsUUFBUSxDQUFDSyxJQUFELENBQVQsRUFBaUJDLGFBQWpCLENBQWQ7QUFDSCxLQUZELE1BRU87QUFDSE4sTUFBQUEsUUFBUSxDQUFDSyxJQUFELENBQVIsR0FBaUJDLGFBQWpCO0FBQ0g7QUFDSixHQU5EO0FBT0g7O0FBa0JEO0FBRUEsU0FBU0MsSUFBVCxDQUFjQyxPQUFkLEVBQXVCQyxLQUF2QixFQUE4QkMsT0FBOUIsRUFBc0U7QUFDbEUs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QUEsb0JBSEc7QUFJSEUsTUFBQUEsdUJBSkc7QUFLSE0sTUFBQUEsc0JBTEc7QUFNSHdHLE1BQUFBLHdCQUF3QixFQUFFdkgsSUFBSSxDQUFDd0gsaUJBQUwsQ0FBdUJDLG1CQUF2QixFQU52QjtBQU9IQyxNQUFBQSxlQUFlLEVBQUUxSCxJQUFJLENBQUMySCxNQUFMLENBQVlGLG1CQUFaLEVBUGQ7QUFRSEcsTUFBQUEscUJBQXFCLEVBQUU1SCxJQUFJLENBQUNRLFlBQUwsQ0FBa0JpSCxtQkFBbEIsRUFScEI7QUFTSEksTUFBQUEsaUJBQWlCLEVBQUU3SCxJQUFJLENBQUMyRCxRQUFMLENBQWM4RCxtQkFBZCxFQVRoQjtBQVVISyxNQUFBQSxpQkFBaUIsRUFBRTlILElBQUksQ0FBQ0UsUUFBTCxDQUFjdUgsbUJBQWQsRUFWaEI7QUFXSE0sTUFBQUEsMkJBQTJCLEVBQUUvSCxJQUFJLENBQUN3SCxpQkFBTCxDQUF1QlEsb0JBQXZCLEVBWDFCO0FBWUhDLE1BQUFBLGtCQUFrQixFQUFFakksSUFBSSxDQUFDMkgsTUFBTCxDQUFZSyxvQkFBWixFQVpqQjtBQWFIRSxNQUFBQSx3QkFBd0IsRUFBRWxJLElBQUksQ0FBQ1EsWUFBTCxDQUFrQndILG9CQUFsQixFQWJ2QjtBQWNIRyxNQUFBQSxvQkFBb0IsRUFBRW5JLElBQUksQ0FBQzJELFFBQUwsQ0FBY3FFLG9CQUFkLEVBZG5CO0FBZUhJLE1BQUFBLG9CQUFvQixFQUFFcEksSUFBSSxDQUFDRSxRQUFMLENBQWM4SCxvQkFBZDtBQWZuQixLQURjO0FBa0JyQkssSUFBQUEsUUFBUSxFQUFFO0FBQ05oRCxNQUFBQSxZQURNO0FBRU4wQixNQUFBQSxrQkFGTTtBQUdORyxNQUFBQSxnQkFITTtBQUlOQyxNQUFBQTtBQUpNO0FBbEJXLEdBQVgsQ0FBZDtBQXlCQSxTQUFPekksUUFBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHsgVG9uQ2xpZW50IH0gZnJvbSBcIkB0b25jbGllbnQvY29yZVwiO1xuaW1wb3J0IHsgS2Fma2EsIFByb2R1Y2VyIH0gZnJvbSAna2Fma2Fqcyc7XG5pbXBvcnQgeyBTcGFuLCBGT1JNQVRfVEVYVF9NQVAgfSBmcm9tICdvcGVudHJhY2luZyc7XG5pbXBvcnQgdHlwZSB7IFFDb25maWcgfSBmcm9tIFwiLi4vY29uZmlnXCI7XG5pbXBvcnQgUUJsb2NrY2hhaW5EYXRhIGZyb20gJy4uL2RhdGEvYmxvY2tjaGFpbic7XG5pbXBvcnQgeyByZXF1aXJlR3JhbnRlZEFjY2VzcyB9IGZyb20gJy4uL2RhdGEvY29sbGVjdGlvbic7XG5pbXBvcnQgdHlwZSB7XG4gICAgR3JhcGhRTFJlcXVlc3RDb250ZXh0LFxufSBmcm9tICcuLi9kYXRhL2NvbGxlY3Rpb24nO1xuaW1wb3J0IHsgQXV0aCB9IGZyb20gJy4uL2F1dGgnO1xuaW1wb3J0IHsgZW5zdXJlUHJvdG9jb2wgfSBmcm9tICcuLi9jb25maWcnO1xuaW1wb3J0IGZldGNoIGZyb20gJ25vZGUtZmV0Y2gnO1xuaW1wb3J0IHR5cGUgeyBBY2Nlc3NLZXksIEFjY2Vzc1JpZ2h0cyB9IGZyb20gJy4uL2F1dGgnO1xuaW1wb3J0IHsgUVRyYWNlciB9IGZyb20gJy4uL3RyYWNlcic7XG5pbXBvcnQgeyBwYWNrYWdlSnNvbiwgUUVycm9yIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG5jb25zdCB7IHZlcnNpb24gfSA9IHBhY2thZ2VKc29uKCk7XG5cbmRlY2xhcmUgZnVuY3Rpb24gQmlnSW50KGE6IGFueSk6IGFueTtcblxuZnVuY3Rpb24gaXNPYmplY3QodGVzdDogYW55KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHR5cGVvZiB0ZXN0ID09PSAnb2JqZWN0JyAmJiB0ZXN0ICE9PSBudWxsO1xufVxuXG5mdW5jdGlvbiBvdmVycmlkZU9iamVjdChvcmlnaW5hbDogYW55LCBvdmVycmlkZXM6IGFueSkge1xuICAgIE9iamVjdC5lbnRyaWVzKG92ZXJyaWRlcykuZm9yRWFjaCgoW25hbWUsIG92ZXJyaWRlVmFsdWVdKSA9PiB7XG4gICAgICAgIGlmICgobmFtZSBpbiBvcmlnaW5hbCkgJiYgaXNPYmplY3Qob3ZlcnJpZGVWYWx1ZSkgJiYgaXNPYmplY3Qob3JpZ2luYWxbbmFtZV0pKSB7XG4gICAgICAgICAgICBvdmVycmlkZU9iamVjdChvcmlnaW5hbFtuYW1lXSwgb3ZlcnJpZGVWYWx1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvcmlnaW5hbFtuYW1lXSA9IG92ZXJyaWRlVmFsdWU7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxudHlwZSBJbmZvID0ge1xuICAgIHZlcnNpb246IHN0cmluZyxcbiAgICB0aW1lOiBudW1iZXIsXG4gICAgZW5kcG9pbnRzOiBzdHJpbmdbXSxcbn1cblxudHlwZSBSZXF1ZXN0ID0ge1xuICAgIGlkOiBzdHJpbmcsXG4gICAgYm9keTogc3RyaW5nLFxuICAgIGV4cGlyZUF0OiBudW1iZXIsXG59XG5cbmV4cG9ydCB0eXBlIEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4ID0gR3JhcGhRTFJlcXVlc3RDb250ZXh0ICYge1xuICAgIGRhdGE6IFFCbG9ja2NoYWluRGF0YSxcbn1cblxuLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIFF1ZXJ5XG5cbmZ1bmN0aW9uIGluZm8oX3BhcmVudCwgX2FyZ3MsIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4KTogSW5mbyB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgdmVyc2lvbixcbiAgICAgICAgdGltZTogRGF0ZS5ub3coKSxcbiAgICAgICAgZW5kcG9pbnRzOiBjb250ZXh0LmNvbmZpZy5lbmRwb2ludHMsXG4gICAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0QWNjb3VudHNDb3VudChfcGFyZW50LCBhcmdzLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgdHJhY2VyID0gY29udGV4dC50cmFjZXI7XG4gICAgcmV0dXJuIFFUcmFjZXIudHJhY2UodHJhY2VyLCAnZ2V0QWNjb3VudHNDb3VudCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgcmVxdWlyZUdyYW50ZWRBY2Nlc3MoY29udGV4dCwgYXJncyk7XG4gICAgICAgIGNvbnN0IHJlc3VsdDogYW55ID0gYXdhaXQgY29udGV4dC5kYXRhLnF1ZXJ5KFxuICAgICAgICAgICAgY29udGV4dC5kYXRhLmFjY291bnRzLnByb3ZpZGVyLFxuICAgICAgICAgICAgYFJFVFVSTiBMRU5HVEgoYWNjb3VudHMpYCxcbiAgICAgICAgICAgIHt9LFxuICAgICAgICAgICAgW10sXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGNvdW50cyA9IChyZXN1bHQ6IG51bWJlcltdKTtcbiAgICAgICAgcmV0dXJuIGNvdW50cy5sZW5ndGggPiAwID8gY291bnRzWzBdIDogMDtcbiAgICB9LCBRVHJhY2VyLmdldFBhcmVudFNwYW4odHJhY2VyLCBjb250ZXh0KSlcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0VHJhbnNhY3Rpb25zQ291bnQoX3BhcmVudCwgYXJncywgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IHRyYWNlciA9IGNvbnRleHQudHJhY2VyO1xuICAgIHJldHVybiBRVHJhY2VyLnRyYWNlKHRyYWNlciwgJ2dldFRyYW5zYWN0aW9uc0NvdW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCByZXF1aXJlR3JhbnRlZEFjY2Vzcyhjb250ZXh0LCBhcmdzKTtcbiAgICAgICAgY29uc3QgcmVzdWx0OiBhbnkgPSBhd2FpdCBjb250ZXh0LmRhdGEucXVlcnkoXG4gICAgICAgICAgICBjb250ZXh0LmRhdGEudHJhbnNhY3Rpb25zLnByb3ZpZGVyLFxuICAgICAgICAgICAgYFJFVFVSTiBMRU5HVEgodHJhbnNhY3Rpb25zKWAsXG4gICAgICAgICAgICB7fSxcbiAgICAgICAgICAgIFtdLFxuICAgICAgICApO1xuICAgICAgICBjb25zdCBjb3VudHMgPSAocmVzdWx0OiBudW1iZXJbXSk7XG4gICAgICAgIHJldHVybiBjb3VudHMubGVuZ3RoID4gMCA/IGNvdW50c1swXSA6IDA7XG4gICAgfSwgUVRyYWNlci5nZXRQYXJlbnRTcGFuKHRyYWNlciwgY29udGV4dCkpXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFjY291bnRzVG90YWxCYWxhbmNlKF9wYXJlbnQsIGFyZ3MsIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4KTogUHJvbWlzZTxTdHJpbmc+IHtcbiAgICBjb25zdCB0cmFjZXIgPSBjb250ZXh0LnRyYWNlcjtcbiAgICByZXR1cm4gUVRyYWNlci50cmFjZSh0cmFjZXIsICdnZXRBY2NvdW50c1RvdGFsQmFsYW5jZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgcmVxdWlyZUdyYW50ZWRBY2Nlc3MoY29udGV4dCwgYXJncyk7XG4gICAgICAgIC8qXG4gICAgICAgIEJlY2F1c2UgYXJhbmdvIGNhbiBub3Qgc3VtIEJpZ0ludCdzIHdlIG5lZWQgdG8gc3VtIHNlcGFyYXRlbHk6XG4gICAgICAgIGhzID0gU1VNIG9mIGhpZ2ggYml0cyAoZnJvbSAyNC1iaXQgYW5kIGhpZ2hlcilcbiAgICAgICAgbHMgPSBTVU0gb2YgbG93ZXIgMjQgYml0c1xuICAgICAgICBBbmQgdGhlIHRvdGFsIHJlc3VsdCBpcyAoaHMgPDwgMjQpICsgbHNcbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IHJlc3VsdDogYW55ID0gYXdhaXQgY29udGV4dC5kYXRhLnF1ZXJ5KFxuICAgICAgICAgICAgY29udGV4dC5kYXRhLmFjY291bnRzLnByb3ZpZGVyLFxuICAgICAgICAgICAgYFxuICAgICAgICAgICAgTEVUIGQgPSAxNjc3NzIxNlxuICAgICAgICAgICAgRk9SIGEgaW4gYWNjb3VudHNcbiAgICAgICAgICAgIExFVCBiID0gVE9fTlVNQkVSKENPTkNBVChcIjB4XCIsIFNVQlNUUklORyhhLmJhbGFuY2UsIDIpKSlcbiAgICAgICAgICAgIENPTExFQ1QgQUdHUkVHQVRFXG4gICAgICAgICAgICAgICAgaHMgPSBTVU0oRkxPT1IoYiAvIGQpKSxcbiAgICAgICAgICAgICAgICBscyA9IFNVTShiICUgKGQgLSAxKSlcbiAgICAgICAgICAgIFJFVFVSTiB7IGhzLCBscyB9XG4gICAgICAgIGAsXG4gICAgICAgICAgICB7fSxcbiAgICAgICAgICAgIFtdKTtcbiAgICAgICAgY29uc3QgcGFydHMgPSAocmVzdWx0OiB7IGhzOiBudW1iZXIsIGxzOiBudW1iZXIgfVtdKVswXTtcbiAgICAgICAgcmV0dXJuIChCaWdJbnQocGFydHMuaHMpICogQmlnSW50KDB4MTAwMDAwMCkgKyBCaWdJbnQocGFydHMubHMpKS50b1N0cmluZygpO1xuICAgIH0sIFFUcmFjZXIuZ2V0UGFyZW50U3Bhbih0cmFjZXIsIGNvbnRleHQpKVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRNYW5hZ2VtZW50QWNjZXNzS2V5KF9wYXJlbnQsIGFyZ3MsIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4KTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gY29udGV4dC5hdXRoLmdldE1hbmFnZW1lbnRBY2Nlc3NLZXkoKTtcbn1cblxuXG4vLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gTXV0YXRpb25cblxuXG5hc3luYyBmdW5jdGlvbiBwb3N0UmVxdWVzdHNVc2luZ1Jlc3QocmVxdWVzdHM6IFJlcXVlc3RbXSwgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsIF9zcGFuOiBTcGFuKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY29uZmlnID0gY29udGV4dC5jb25maWcucmVxdWVzdHM7XG4gICAgY29uc3QgdXJsID0gYCR7ZW5zdXJlUHJvdG9jb2woY29uZmlnLnNlcnZlciwgJ2h0dHAnKX0vdG9waWNzLyR7Y29uZmlnLnRvcGljfWA7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHtcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIG1vZGU6ICdjb3JzJyxcbiAgICAgICAgY2FjaGU6ICduby1jYWNoZScsXG4gICAgICAgIGNyZWRlbnRpYWxzOiAnc2FtZS1vcmlnaW4nLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICB9LFxuICAgICAgICByZWRpcmVjdDogJ2ZvbGxvdycsXG4gICAgICAgIHJlZmVycmVyOiAnbm8tcmVmZXJyZXInLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICByZWNvcmRzOiByZXF1ZXN0cy5tYXAoKHJlcXVlc3QpID0+ICh7XG4gICAgICAgICAgICAgICAga2V5OiByZXF1ZXN0LmlkLFxuICAgICAgICAgICAgICAgIHZhbHVlOiByZXF1ZXN0LmJvZHksXG4gICAgICAgICAgICB9KSksXG4gICAgICAgIH0pLFxuICAgIH0pO1xuICAgIGlmIChyZXNwb25zZS5zdGF0dXMgIT09IDIwMCkge1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gYFBvc3QgcmVxdWVzdHMgZmFpbGVkOiAke2F3YWl0IHJlc3BvbnNlLnRleHQoKX1gO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IobWVzc2FnZSk7XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBwb3N0UmVxdWVzdHNVc2luZ0thZmthKHJlcXVlc3RzOiBSZXF1ZXN0W10sIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4LCBzcGFuOiBTcGFuKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZW5zdXJlU2hhcmVkID0gYXN5bmMgKG5hbWUsIGNyZWF0ZVZhbHVlOiAoKSA9PiBQcm9taXNlPGFueT4pID0+IHtcbiAgICAgICAgaWYgKGNvbnRleHQuc2hhcmVkLmhhcyhuYW1lKSkge1xuICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuc2hhcmVkLmdldChuYW1lKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IGNyZWF0ZVZhbHVlKCk7XG4gICAgICAgIGNvbnRleHQuc2hhcmVkLnNldChuYW1lLCB2YWx1ZSk7XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9O1xuXG4gICAgY29uc3QgY29uZmlnID0gY29udGV4dC5jb25maWcucmVxdWVzdHM7XG4gICAgY29uc3QgcHJvZHVjZXI6IFByb2R1Y2VyID0gYXdhaXQgZW5zdXJlU2hhcmVkKCdwcm9kdWNlcicsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3Qga2Fma2E6IEthZmthID0gYXdhaXQgZW5zdXJlU2hhcmVkKCdrYWZrYScsIGFzeW5jICgpID0+IG5ldyBLYWZrYSh7XG4gICAgICAgICAgICBjbGllbnRJZDogJ3Etc2VydmVyJyxcbiAgICAgICAgICAgIGJyb2tlcnM6IFtjb25maWcuc2VydmVyXSxcbiAgICAgICAgfSkpO1xuICAgICAgICBjb25zdCBuZXdQcm9kdWNlciA9IGthZmthLnByb2R1Y2VyKCk7XG4gICAgICAgIGF3YWl0IG5ld1Byb2R1Y2VyLmNvbm5lY3QoKTtcbiAgICAgICAgcmV0dXJuIG5ld1Byb2R1Y2VyO1xuXG4gICAgfSk7XG5cbiAgICBjb25zdCBtZXNzYWdlcyA9IHJlcXVlc3RzLm1hcCgocmVxdWVzdCkgPT4ge1xuICAgICAgICBjb25zdCB0cmFjZUluZm8gPSB7fTtcbiAgICAgICAgY29udGV4dC5kYXRhLnRyYWNlci5pbmplY3Qoc3BhbiwgRk9STUFUX1RFWFRfTUFQLCB0cmFjZUluZm8pO1xuICAgICAgICBjb25zdCBrZXlCdWZmZXIgPSBCdWZmZXIuZnJvbShyZXF1ZXN0LmlkLCAnYmFzZTY0Jyk7XG4gICAgICAgIGNvbnN0IHRyYWNlQnVmZmVyID0gKE9iamVjdC5rZXlzKHRyYWNlSW5mbykubGVuZ3RoID4gMClcbiAgICAgICAgICAgID8gQnVmZmVyLmZyb20oSlNPTi5zdHJpbmdpZnkodHJhY2VJbmZvKSwgJ3V0ZjgnKVxuICAgICAgICAgICAgOiBCdWZmZXIuZnJvbShbXSk7XG4gICAgICAgIGNvbnN0IGtleSA9IEJ1ZmZlci5jb25jYXQoW2tleUJ1ZmZlciwgdHJhY2VCdWZmZXJdKTtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBCdWZmZXIuZnJvbShyZXF1ZXN0LmJvZHksICdiYXNlNjQnKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGtleSxcbiAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICB9O1xuICAgIH0pO1xuICAgIGF3YWl0IHByb2R1Y2VyLnNlbmQoe1xuICAgICAgICB0b3BpYzogY29uZmlnLnRvcGljLFxuICAgICAgICBtZXNzYWdlcyxcbiAgICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tQb3N0UmVzdHJpY3Rpb25zKFxuICAgIGNvbmZpZzogUUNvbmZpZyxcbiAgICBjbGllbnQ6IFRvbkNsaWVudCxcbiAgICByZXF1ZXN0czogUmVxdWVzdFtdLFxuICAgIGFjY2Vzc1JpZ2h0czogQWNjZXNzUmlnaHRzLFxuKSB7XG4gICAgcmVxdWVzdHMuZm9yRWFjaCgocmVxdWVzdCkgPT4ge1xuICAgICAgICBjb25zdCBzaXplID0gTWF0aC5jZWlsKHJlcXVlc3QuYm9keS5sZW5ndGggKiAzIC8gNCk7XG4gICAgICAgIGlmIChzaXplID4gY29uZmlnLnJlcXVlc3RzLm1heFNpemUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgTWVzc2FnZSBzaXplICR7c2l6ZX0gaXMgdG9vIGxhcmdlLiBNYXhpbXVtIHNpemUgaXMgJHtjb25maWcucmVxdWVzdHMubWF4U2l6ZX0gYnl0ZXMuYCk7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmIChhY2Nlc3NSaWdodHMucmVzdHJpY3RUb0FjY291bnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGFjY291bnRzID0gbmV3IFNldChhY2Nlc3NSaWdodHMucmVzdHJpY3RUb0FjY291bnRzKTtcbiAgICBmb3IgKGNvbnN0IHJlcXVlc3Q6IFJlcXVlc3Qgb2YgcmVxdWVzdHMpIHtcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IChhd2FpdCBjbGllbnQuYm9jLnBhcnNlX21lc3NhZ2Uoe1xuICAgICAgICAgICAgYm9jOiByZXF1ZXN0LmJvZHksXG4gICAgICAgIH0pKS5wYXJzZWQ7XG4gICAgICAgIGlmICghYWNjb3VudHMuaGFzKG1lc3NhZ2UuZHN0KSkge1xuICAgICAgICAgICAgdGhyb3cgQXV0aC51bmF1dGhvcml6ZWRFcnJvcigpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBwb3N0UmVxdWVzdHMoXG4gICAgXyxcbiAgICBhcmdzOiB7IHJlcXVlc3RzOiBSZXF1ZXN0W10sIGFjY2Vzc0tleT86IHN0cmluZyB9LFxuICAgIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4LFxuKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IHJlcXVlc3RzOiA/KFJlcXVlc3RbXSkgPSBhcmdzLnJlcXVlc3RzO1xuICAgIGlmICghcmVxdWVzdHMpIHtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIGNvbnN0IHRyYWNlciA9IGNvbnRleHQudHJhY2VyO1xuICAgIHJldHVybiBRVHJhY2VyLnRyYWNlKHRyYWNlciwgJ3Bvc3RSZXF1ZXN0cycsIGFzeW5jIChzcGFuOiBTcGFuKSA9PiB7XG4gICAgICAgIHNwYW4uc2V0VGFnKCdwYXJhbXMnLCByZXF1ZXN0cyk7XG4gICAgICAgIGNvbnN0IGFjY2Vzc1JpZ2h0cyA9IGF3YWl0IHJlcXVpcmVHcmFudGVkQWNjZXNzKGNvbnRleHQsIGFyZ3MpO1xuICAgICAgICBhd2FpdCBjaGVja1Bvc3RSZXN0cmljdGlvbnMoY29udGV4dC5jb25maWcsIGNvbnRleHQuY2xpZW50LCByZXF1ZXN0cywgYWNjZXNzUmlnaHRzKTtcblxuICAgICAgICBjb25zdCBleHBpcmVkOiA/UmVxdWVzdCA9IHJlcXVlc3RzLmZpbmQoeCA9PiB4LmV4cGlyZUF0ICYmIChEYXRlLm5vdygpID4geC5leHBpcmVBdCkpO1xuICAgICAgICBpZiAoZXhwaXJlZCkge1xuICAgICAgICAgICAgdGhyb3cgUUVycm9yLm1lc3NhZ2VFeHBpcmVkKGV4cGlyZWQuaWQsIGV4cGlyZWQuZXhwaXJlQXQpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbWVzc2FnZVRyYWNlU3BhbnMgPSByZXF1ZXN0cy5tYXAoKHJlcXVlc3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2VJZCA9IEJ1ZmZlci5mcm9tKHJlcXVlc3QuaWQsICdiYXNlNjQnKS50b1N0cmluZygnaGV4Jyk7XG4gICAgICAgICAgICBjb25zdCBwb3N0U3BhbiA9IHRyYWNlci5zdGFydFNwYW4oJ3Bvc3RSZXF1ZXN0Jywge1xuICAgICAgICAgICAgICAgIGNoaWxkT2Y6IFFUcmFjZXIubWVzc2FnZVJvb3RTcGFuQ29udGV4dChtZXNzYWdlSWQpLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBwb3N0U3Bhbi5hZGRUYWdzKHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlSWQsXG4gICAgICAgICAgICAgICAgbWVzc2FnZVNpemU6IE1hdGguY2VpbChyZXF1ZXN0LmJvZHkubGVuZ3RoICogMyAvIDQpLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIHJldHVybiBwb3N0U3BhbjtcbiAgICAgICAgfSk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoY29udGV4dC5jb25maWcucmVxdWVzdHMubW9kZSA9PT0gJ3Jlc3QnKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgcG9zdFJlcXVlc3RzVXNpbmdSZXN0KHJlcXVlc3RzLCBjb250ZXh0LCBzcGFuKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgcG9zdFJlcXVlc3RzVXNpbmdLYWZrYShyZXF1ZXN0cywgY29udGV4dCwgc3Bhbik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb250ZXh0LmRhdGEuc3RhdFBvc3RDb3VudC5pbmNyZW1lbnQoKTtcbiAgICAgICAgICAgIGNvbnRleHQuZGF0YS5sb2cuZGVidWcoJ3Bvc3RSZXF1ZXN0cycsICdQT1NURUQnLCBhcmdzLCBjb250ZXh0LnJlbW90ZUFkZHJlc3MpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29udGV4dC5kYXRhLnN0YXRQb3N0RmFpbGVkLmluY3JlbWVudCgpO1xuICAgICAgICAgICAgY29udGV4dC5kYXRhLmxvZy5kZWJ1ZygncG9zdFJlcXVlc3RzJywgJ0ZBSUxFRCcsIGFyZ3MsIGNvbnRleHQucmVtb3RlQWRkcmVzcyk7XG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIG1lc3NhZ2VUcmFjZVNwYW5zLmZvckVhY2goeCA9PiB4LmZpbmlzaCgpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVxdWVzdHMubWFwKHggPT4geC5pZCk7XG4gICAgfSwgY29udGV4dC5wYXJlbnRTcGFuKTtcbn1cblxuLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIEFjY2VzcyBNYW5hZ2VtZW50XG5cbnR5cGUgTWFuYWdlbWVudEFyZ3MgPSB7XG4gICAgYWNjb3VudD86IHN0cmluZyxcbiAgICBzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5Pzogc3RyaW5nLFxufVxuXG50eXBlIFJlZ2lzdGVyQWNjZXNzS2V5c0FyZ3MgPSBNYW5hZ2VtZW50QXJncyAmIHtcbiAgICBrZXlzOiBBY2Nlc3NLZXlbXSxcbn1cblxudHlwZSBSZXZva2VBY2Nlc3NLZXlzQXJncyA9IE1hbmFnZW1lbnRBcmdzICYge1xuICAgIGtleXM6IHN0cmluZ1tdLFxufVxuXG5hc3luYyBmdW5jdGlvbiByZWdpc3RlckFjY2Vzc0tleXMoXG4gICAgXyxcbiAgICBhcmdzOiBSZWdpc3RlckFjY2Vzc0tleXNBcmdzLFxuICAgIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4LFxuKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICByZXR1cm4gY29udGV4dC5hdXRoLnJlZ2lzdGVyQWNjZXNzS2V5cyhcbiAgICAgICAgYXJncy5hY2NvdW50IHx8ICcnLFxuICAgICAgICBhcmdzLmtleXMgfHwgW10sXG4gICAgICAgIGFyZ3Muc2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleSB8fCAnJyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJldm9rZUFjY2Vzc0tleXMoXG4gICAgXyxcbiAgICBhcmdzOiBSZXZva2VBY2Nlc3NLZXlzQXJncyxcbiAgICBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCxcbik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgcmV0dXJuIGNvbnRleHQuYXV0aC5yZXZva2VBY2Nlc3NLZXlzKFxuICAgICAgICBhcmdzLmFjY291bnQgfHwgJycsXG4gICAgICAgIGFyZ3Mua2V5cyB8fCBbXSxcbiAgICAgICAgYXJncy5zaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5IHx8ICcnKTtcbn1cblxudHlwZSBGaW5pc2hPcGVyYXRpb25zQXJncyA9IHtcbiAgICBvcGVyYXRpb25JZHM/OiBzdHJpbmdbXSxcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmluaXNoT3BlcmF0aW9ucyhcbiAgICBfLFxuICAgIGFyZ3M6IEZpbmlzaE9wZXJhdGlvbnNBcmdzLFxuICAgIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4LFxuKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBjb25zdCBvcGVyYXRpb25JZHMgPSBuZXcgU2V0KGFyZ3Mub3BlcmF0aW9uSWRzIHx8IFtdKTtcbiAgICBpZiAob3BlcmF0aW9uSWRzLnNpemUgPT09IDApIHtcbiAgICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICAgIHJldHVybiBjb250ZXh0LmRhdGEuZmluaXNoT3BlcmF0aW9ucyhvcGVyYXRpb25JZHMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYXR0YWNoQ3VzdG9tUmVzb2x2ZXJzKGRhdGE6IFFCbG9ja2NoYWluRGF0YSwgb3JpZ2luYWw6IGFueSk6IGFueSB7XG4gICAgb3ZlcnJpZGVPYmplY3Qob3JpZ2luYWwsIHtcbiAgICAgICAgUXVlcnk6IHtcbiAgICAgICAgICAgIGluZm8sXG4gICAgICAgICAgICBnZXRBY2NvdW50c0NvdW50LFxuICAgICAgICAgICAgZ2V0VHJhbnNhY3Rpb25zQ291bnQsXG4gICAgICAgICAgICBnZXRBY2NvdW50c1RvdGFsQmFsYW5jZSxcbiAgICAgICAgICAgIGdldE1hbmFnZW1lbnRBY2Nlc3NLZXksXG4gICAgICAgICAgICBhZ2dyZWdhdGVCbG9ja1NpZ25hdHVyZXM6IGRhdGEuYmxvY2tzX3NpZ25hdHVyZXMuYWdncmVnYXRpb25SZXNvbHZlcigpLFxuICAgICAgICAgICAgYWdncmVnYXRlQmxvY2tzOiBkYXRhLmJsb2Nrcy5hZ2dyZWdhdGlvblJlc29sdmVyKCksXG4gICAgICAgICAgICBhZ2dyZWdhdGVUcmFuc2FjdGlvbnM6IGRhdGEudHJhbnNhY3Rpb25zLmFnZ3JlZ2F0aW9uUmVzb2x2ZXIoKSxcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZU1lc3NhZ2VzOiBkYXRhLm1lc3NhZ2VzLmFnZ3JlZ2F0aW9uUmVzb2x2ZXIoKSxcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZUFjY291bnRzOiBkYXRhLmFjY291bnRzLmFnZ3JlZ2F0aW9uUmVzb2x2ZXIoKSxcbiAgICAgICAgICAgIGV4cGxhaW5RdWVyeUJsb2NrU2lnbmF0dXJlczogZGF0YS5ibG9ja3Nfc2lnbmF0dXJlcy5leHBsYWluUXVlcnlSZXNvbHZlcigpLFxuICAgICAgICAgICAgZXhwbGFpblF1ZXJ5QmxvY2tzOiBkYXRhLmJsb2Nrcy5leHBsYWluUXVlcnlSZXNvbHZlcigpLFxuICAgICAgICAgICAgZXhwbGFpblF1ZXJ5VHJhbnNhY3Rpb25zOiBkYXRhLnRyYW5zYWN0aW9ucy5leHBsYWluUXVlcnlSZXNvbHZlcigpLFxuICAgICAgICAgICAgZXhwbGFpblF1ZXJ5TWVzc2FnZXM6IGRhdGEubWVzc2FnZXMuZXhwbGFpblF1ZXJ5UmVzb2x2ZXIoKSxcbiAgICAgICAgICAgIGV4cGxhaW5RdWVyeUFjY291bnRzOiBkYXRhLmFjY291bnRzLmV4cGxhaW5RdWVyeVJlc29sdmVyKCksXG4gICAgICAgIH0sXG4gICAgICAgIE11dGF0aW9uOiB7XG4gICAgICAgICAgICBwb3N0UmVxdWVzdHMsXG4gICAgICAgICAgICByZWdpc3RlckFjY2Vzc0tleXMsXG4gICAgICAgICAgICByZXZva2VBY2Nlc3NLZXlzLFxuICAgICAgICAgICAgZmluaXNoT3BlcmF0aW9ucyxcbiAgICAgICAgfSxcbiAgICB9KTtcbiAgICByZXR1cm4gb3JpZ2luYWw7XG59XG4iXX0=