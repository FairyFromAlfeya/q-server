"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.attachCustomResolvers = attachCustomResolvers;

var _kafkajs = require("kafkajs");

var _opentracing = require("opentracing");

var _blockchain = _interopRequireDefault(require("../data/blockchain"));

var _collection = require("../data/collection");

var _auth = require("../auth");

var _config = require("../config");

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _tracer = require("../tracer");

var _utils = require("../utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const {
  version
} = (0, _utils.packageJson)();

function isObject(test) {
  return typeof test === 'object' && test !== null;
}

function overrideObject(original, overrides) {
  Object.entries(overrides).forEach(([name, overrideValue]) => {
    if (name in original && isObject(overrideValue) && isObject(original[name])) {
      overrideObject(original[name], overrideValue);
    } else {
      original[name] = overrideValue;
    }
  });
}

//------------------------------------------------------------- Query
function info() {
  return {
    version,
    time: Date.now()
  };
}

async function getAccountsCount(_parent, args, context) {
  const tracer = context.tracer;
  return _tracer.QTracer.trace(tracer, 'getAccountsCount', async () => {
    await (0, _collection.requireGrantedAccess)(context, args);
    const result = await context.data.query(context.data.accounts.provider, `RETURN LENGTH(accounts)`, {}, []);
    const counts = result;
    return counts.length > 0 ? counts[0] : 0;
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getTransactionsCount(_parent, args, context) {
  const tracer = context.tracer;
  return _tracer.QTracer.trace(tracer, 'getTransactionsCount', async () => {
    await (0, _collection.requireGrantedAccess)(context, args);
    const result = await context.data.query(context.data.transactions.provider, `RETURN LENGTH(transactions)`, {}, []);
    const counts = result;
    return counts.length > 0 ? counts[0] : 0;
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getAccountsTotalBalance(_parent, args, context) {
  const tracer = context.tracer;
  return _tracer.QTracer.trace(tracer, 'getAccountsTotalBalance', async () => {
    await (0, _collection.requireGrantedAccess)(context, args);
    /*
    Because arango can not sum BigInt's we need to sum separately:
    hs = SUM of high bits (from 24-bit and higher)
    ls = SUM of lower 24 bits
    And the total result is (hs << 24) + ls
     */

    const result = await context.data.query(context.data.accounts.provider, `
            LET d = 16777216
            FOR a in accounts
            LET b = TO_NUMBER(CONCAT("0x", SUBSTRING(a.balance, 2)))
            COLLECT AGGREGATE
                hs = SUM(FLOOR(b / d)),
                ls = SUM(b % (d - 1))
            RETURN { hs, ls }
        `, {}, []);
    const parts = result[0]; //$FlowFixMe

    return (BigInt(parts.hs) * BigInt(0x1000000) + BigInt(parts.ls)).toString();
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getManagementAccessKey(_parent, args, context) {
  return context.auth.getManagementAccessKey();
} //------------------------------------------------------------- Mutation


async function postRequestsUsingRest(requests, context, _span) {
  const config = context.config.requests;
  const url = `${(0, _config.ensureProtocol)(config.server, 'http')}/topics/${config.topic}`;
  const response = await (0, _nodeFetch.default)(url, {
    method: 'POST',
    mode: 'cors',
    cache: 'no-cache',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json'
    },
    redirect: 'follow',
    referrer: 'no-referrer',
    body: JSON.stringify({
      records: requests.map(request => ({
        key: request.id,
        value: request.body
      }))
    })
  });

  if (response.status !== 200) {
    const message = `Post requests failed: ${await response.text()}`;
    throw new Error(message);
  }
}

async function postRequestsUsingKafka(requests, context, span) {
  const ensureShared = async (name, createValue) => {
    if (context.shared.has(name)) {
      return context.shared.get(name);
    }

    const value = await createValue();
    context.shared.set(name, value);
    return value;
  };

  const config = context.config.requests;
  const producer = await ensureShared('producer', async () => {
    const kafka = await ensureShared('kafka', async () => new _kafkajs.Kafka({
      clientId: 'q-server',
      brokers: [config.server]
    }));
    const newProducer = kafka.producer();
    await newProducer.connect();
    return newProducer;
  });
  const messages = requests.map(request => {
    const traceInfo = {};
    context.data.tracer.inject(span, _opentracing.FORMAT_TEXT_MAP, traceInfo);
    const keyBuffer = Buffer.from(request.id, 'base64');
    const traceBuffer = Object.keys(traceInfo).length > 0 ? Buffer.from(JSON.stringify(traceInfo), 'utf8') : Buffer.from([]);
    const key = Buffer.concat([keyBuffer, traceBuffer]);
    const value = Buffer.from(request.body, 'base64');
    return {
      key,
      value
    };
  });
  await producer.send({
    topic: config.topic,
    messages
  });
}

async function checkPostRestrictions(contracts, requests, accessRights) {
  requests.forEach(request => {
    const size = Math.ceil(request.body.length * 3 / 4);

    if (size > 60000) {
      throw new Error(`Message size ${size} is too large`);
    }
  });

  if (accessRights.restrictToAccounts.length === 0) {
    return;
  }

  const accounts = new Set(accessRights.restrictToAccounts);

  for (const request of requests) {
    const message = await contracts.parseMessage({
      bocBase64: request.body
    });

    if (!accounts.has(message.dst)) {
      throw _auth.Auth.unauthorizedError();
    }
  }
}

async function postRequests(_, args, context) {
  const requests = args.requests;

  if (!requests) {
    return [];
  }

  const tracer = context.tracer;
  return _tracer.QTracer.trace(tracer, 'postRequests', async span => {
    span.setTag('params', requests);
    const accessRights = await (0, _collection.requireGrantedAccess)(context, args);
    await checkPostRestrictions(context.client.contracts, requests, accessRights);
    const expired = requests.find(x => x.expireAt && Date.now() > x.expireAt);

    if (expired) {
      throw _utils.QError.messageExpired(expired.id, expired.expireAt);
    }

    const messageTraceSpans = requests.map(request => {
      const messageId = Buffer.from(request.id, 'base64').toString('hex');
      const postSpan = tracer.startSpan('postRequest', {
        childOf: _tracer.QTracer.messageRootSpanContext(messageId)
      });
      postSpan.addTags({
        messageId,
        messageSize: Math.ceil(request.body.length * 3 / 4)
      });
      return postSpan;
    });

    try {
      if (context.config.requests.mode === 'rest') {
        await postRequestsUsingRest(requests, context, span);
      } else {
        await postRequestsUsingKafka(requests, context, span);
      }

      context.data.statPostCount.increment();
      context.data.log.debug('postRequests', 'POSTED', args, context.remoteAddress);
    } catch (error) {
      context.data.statPostFailed.increment();
      context.data.log.debug('postRequests', 'FAILED', args, context.remoteAddress);
      throw error;
    } finally {
      messageTraceSpans.forEach(x => x.finish());
    }

    return requests.map(x => x.id);
  }, context.parentSpan);
} //------------------------------------------------------------- Access Management


async function registerAccessKeys(_, args, context) {
  return context.auth.registerAccessKeys(args.account || '', args.keys || [], args.signedManagementAccessKey || '');
}

async function revokeAccessKeys(_, args, context) {
  return context.auth.revokeAccessKeys(args.account || '', args.keys || [], args.signedManagementAccessKey || '');
}

async function finishOperations(_, args, context) {
  const operationIds = new Set(args.operationIds || []);

  if (operationIds.size === 0) {
    return 0;
  }

  return context.data.finishOperations(operationIds);
}

function attachCustomResolvers(data, original) {
  overrideObject(original, {
    Query: {
      info,
      getAccountsCount,
      getTransactionsCount,
      getAccountsTotalBalance,
      getManagementAccessKey,
      aggregateBlockSignatures: data.blocks_signatures.aggregationResolver(),
      aggregateBlocks: data.blocks.aggregationResolver(),
      aggregateTransactions: data.transactions.aggregationResolver(),
      aggregateMessages: data.messages.aggregationResolver(),
      aggregateAccounts: data.accounts.aggregationResolver()
    },
    Mutation: {
      postRequests,
      registerAccessKeys,
      revokeAccessKeys,
      finishOperations
    }
  });
  return original;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZ3JhcGhxbC9yZXNvbHZlcnMtY3VzdG9tLmpzIl0sIm5hbWVzIjpbInZlcnNpb24iLCJpc09iamVjdCIsInRlc3QiLCJvdmVycmlkZU9iamVjdCIsIm9yaWdpbmFsIiwib3ZlcnJpZGVzIiwiT2JqZWN0IiwiZW50cmllcyIsImZvckVhY2giLCJuYW1lIiwib3ZlcnJpZGVWYWx1ZSIsImluZm8iLCJ0aW1lIiwiRGF0ZSIsIm5vdyIsImdldEFjY291bnRzQ291bnQiLCJfcGFyZW50IiwiYXJncyIsImNvbnRleHQiLCJ0cmFjZXIiLCJRVHJhY2VyIiwidHJhY2UiLCJyZXN1bHQiLCJkYXRhIiwicXVlcnkiLCJhY2NvdW50cyIsInByb3ZpZGVyIiwiY291bnRzIiwibGVuZ3RoIiwiZ2V0UGFyZW50U3BhbiIsImdldFRyYW5zYWN0aW9uc0NvdW50IiwidHJhbnNhY3Rpb25zIiwiZ2V0QWNjb3VudHNUb3RhbEJhbGFuY2UiLCJwYXJ0cyIsIkJpZ0ludCIsImhzIiwibHMiLCJ0b1N0cmluZyIsImdldE1hbmFnZW1lbnRBY2Nlc3NLZXkiLCJhdXRoIiwicG9zdFJlcXVlc3RzVXNpbmdSZXN0IiwicmVxdWVzdHMiLCJfc3BhbiIsImNvbmZpZyIsInVybCIsInNlcnZlciIsInRvcGljIiwicmVzcG9uc2UiLCJtZXRob2QiLCJtb2RlIiwiY2FjaGUiLCJjcmVkZW50aWFscyIsImhlYWRlcnMiLCJyZWRpcmVjdCIsInJlZmVycmVyIiwiYm9keSIsIkpTT04iLCJzdHJpbmdpZnkiLCJyZWNvcmRzIiwibWFwIiwicmVxdWVzdCIsImtleSIsImlkIiwidmFsdWUiLCJzdGF0dXMiLCJtZXNzYWdlIiwidGV4dCIsIkVycm9yIiwicG9zdFJlcXVlc3RzVXNpbmdLYWZrYSIsInNwYW4iLCJlbnN1cmVTaGFyZWQiLCJjcmVhdGVWYWx1ZSIsInNoYXJlZCIsImhhcyIsImdldCIsInNldCIsInByb2R1Y2VyIiwia2Fma2EiLCJLYWZrYSIsImNsaWVudElkIiwiYnJva2VycyIsIm5ld1Byb2R1Y2VyIiwiY29ubmVjdCIsIm1lc3NhZ2VzIiwidHJhY2VJbmZvIiwiaW5qZWN0IiwiRk9STUFUX1RFWFRfTUFQIiwia2V5QnVmZmVyIiwiQnVmZmVyIiwiZnJvbSIsInRyYWNlQnVmZmVyIiwia2V5cyIsImNvbmNhdCIsInNlbmQiLCJjaGVja1Bvc3RSZXN0cmljdGlvbnMiLCJjb250cmFjdHMiLCJhY2Nlc3NSaWdodHMiLCJzaXplIiwiTWF0aCIsImNlaWwiLCJyZXN0cmljdFRvQWNjb3VudHMiLCJTZXQiLCJwYXJzZU1lc3NhZ2UiLCJib2NCYXNlNjQiLCJkc3QiLCJBdXRoIiwidW5hdXRob3JpemVkRXJyb3IiLCJwb3N0UmVxdWVzdHMiLCJfIiwic2V0VGFnIiwiY2xpZW50IiwiZXhwaXJlZCIsImZpbmQiLCJ4IiwiZXhwaXJlQXQiLCJRRXJyb3IiLCJtZXNzYWdlRXhwaXJlZCIsIm1lc3NhZ2VUcmFjZVNwYW5zIiwibWVzc2FnZUlkIiwicG9zdFNwYW4iLCJzdGFydFNwYW4iLCJjaGlsZE9mIiwibWVzc2FnZVJvb3RTcGFuQ29udGV4dCIsImFkZFRhZ3MiLCJtZXNzYWdlU2l6ZSIsInN0YXRQb3N0Q291bnQiLCJpbmNyZW1lbnQiLCJsb2ciLCJkZWJ1ZyIsInJlbW90ZUFkZHJlc3MiLCJlcnJvciIsInN0YXRQb3N0RmFpbGVkIiwiZmluaXNoIiwicGFyZW50U3BhbiIsInJlZ2lzdGVyQWNjZXNzS2V5cyIsImFjY291bnQiLCJzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5IiwicmV2b2tlQWNjZXNzS2V5cyIsImZpbmlzaE9wZXJhdGlvbnMiLCJvcGVyYXRpb25JZHMiLCJhdHRhY2hDdXN0b21SZXNvbHZlcnMiLCJRdWVyeSIsImFnZ3JlZ2F0ZUJsb2NrU2lnbmF0dXJlcyIsImJsb2Nrc19zaWduYXR1cmVzIiwiYWdncmVnYXRpb25SZXNvbHZlciIsImFnZ3JlZ2F0ZUJsb2NrcyIsImJsb2NrcyIsImFnZ3JlZ2F0ZVRyYW5zYWN0aW9ucyIsImFnZ3JlZ2F0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Z0JBSE07QUFJTkMsTUFBQUE7QUFKTTtBQWJXLEdBQVgsQ0FBZDtBQW9CQSxTQUFPdEksUUFBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHsgS2Fma2EsIFByb2R1Y2VyIH0gZnJvbSAna2Fma2Fqcyc7XG5pbXBvcnQgeyBTcGFuLCBGT1JNQVRfVEVYVF9NQVAgfSBmcm9tICdvcGVudHJhY2luZyc7XG5pbXBvcnQgdHlwZSB7IFRPTkNvbnRyYWN0cyB9IGZyb20gJ3Rvbi1jbGllbnQtanMvdHlwZXMnO1xuaW1wb3J0IFFCbG9ja2NoYWluRGF0YSBmcm9tICcuLi9kYXRhL2Jsb2NrY2hhaW4nO1xuaW1wb3J0IHsgcmVxdWlyZUdyYW50ZWRBY2Nlc3MgfSBmcm9tICcuLi9kYXRhL2NvbGxlY3Rpb24nO1xuaW1wb3J0IHR5cGUge1xuICAgIEdyYXBoUUxSZXF1ZXN0Q29udGV4dCxcbn0gZnJvbSAnLi4vZGF0YS9jb2xsZWN0aW9uJztcbmltcG9ydCB7IEF1dGggfSBmcm9tICcuLi9hdXRoJztcbmltcG9ydCB7IGVuc3VyZVByb3RvY29sIH0gZnJvbSAnLi4vY29uZmlnJztcbmltcG9ydCBmZXRjaCBmcm9tICdub2RlLWZldGNoJztcbmltcG9ydCB0eXBlIHsgQWNjZXNzS2V5LCBBY2Nlc3NSaWdodHMgfSBmcm9tICcuLi9hdXRoJztcbmltcG9ydCB7IFFUcmFjZXIgfSBmcm9tICcuLi90cmFjZXInO1xuaW1wb3J0IHsgcGFja2FnZUpzb24sIFFFcnJvciB9IGZyb20gJy4uL3V0aWxzJztcblxuY29uc3QgeyB2ZXJzaW9uIH0gPSBwYWNrYWdlSnNvbigpO1xuXG5mdW5jdGlvbiBpc09iamVjdCh0ZXN0OiBhbnkpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdHlwZW9mIHRlc3QgPT09ICdvYmplY3QnICYmIHRlc3QgIT09IG51bGw7XG59XG5cbmZ1bmN0aW9uIG92ZXJyaWRlT2JqZWN0KG9yaWdpbmFsOiBhbnksIG92ZXJyaWRlczogYW55KSB7XG4gICAgT2JqZWN0LmVudHJpZXMob3ZlcnJpZGVzKS5mb3JFYWNoKChbbmFtZSwgb3ZlcnJpZGVWYWx1ZV0pID0+IHtcbiAgICAgICAgaWYgKChuYW1lIGluIG9yaWdpbmFsKSAmJiBpc09iamVjdChvdmVycmlkZVZhbHVlKSAmJiBpc09iamVjdChvcmlnaW5hbFtuYW1lXSkpIHtcbiAgICAgICAgICAgIG92ZXJyaWRlT2JqZWN0KG9yaWdpbmFsW25hbWVdLCBvdmVycmlkZVZhbHVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG9yaWdpbmFsW25hbWVdID0gb3ZlcnJpZGVWYWx1ZTtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuXG50eXBlIEluZm8gPSB7XG4gICAgdmVyc2lvbjogc3RyaW5nLFxufVxuXG50eXBlIFJlcXVlc3QgPSB7XG4gICAgaWQ6IHN0cmluZyxcbiAgICBib2R5OiBzdHJpbmcsXG4gICAgZXhwaXJlQXQ6IG51bWJlcixcbn1cblxuZXhwb3J0IHR5cGUgR3JhcGhRTFJlcXVlc3RDb250ZXh0RXggPSBHcmFwaFFMUmVxdWVzdENvbnRleHQgJiB7XG4gICAgZGF0YTogUUJsb2NrY2hhaW5EYXRhLFxufVxuXG4vLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gUXVlcnlcblxuZnVuY3Rpb24gaW5mbygpOiBJbmZvIHtcbiAgICByZXR1cm4ge1xuICAgICAgICB2ZXJzaW9uLFxuICAgICAgICB0aW1lOiBEYXRlLm5vdygpLFxuICAgIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFjY291bnRzQ291bnQoX3BhcmVudCwgYXJncywgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IHRyYWNlciA9IGNvbnRleHQudHJhY2VyO1xuICAgIHJldHVybiBRVHJhY2VyLnRyYWNlKHRyYWNlciwgJ2dldEFjY291bnRzQ291bnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IHJlcXVpcmVHcmFudGVkQWNjZXNzKGNvbnRleHQsIGFyZ3MpO1xuICAgICAgICBjb25zdCByZXN1bHQ6IGFueSA9IGF3YWl0IGNvbnRleHQuZGF0YS5xdWVyeShcbiAgICAgICAgICAgIGNvbnRleHQuZGF0YS5hY2NvdW50cy5wcm92aWRlcixcbiAgICAgICAgICAgIGBSRVRVUk4gTEVOR1RIKGFjY291bnRzKWAsXG4gICAgICAgICAgICB7fSxcbiAgICAgICAgICAgIFtdLFxuICAgICAgICApO1xuICAgICAgICBjb25zdCBjb3VudHMgPSAocmVzdWx0OiBudW1iZXJbXSk7XG4gICAgICAgIHJldHVybiBjb3VudHMubGVuZ3RoID4gMCA/IGNvdW50c1swXSA6IDA7XG4gICAgfSwgUVRyYWNlci5nZXRQYXJlbnRTcGFuKHRyYWNlciwgY29udGV4dCkpXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFRyYW5zYWN0aW9uc0NvdW50KF9wYXJlbnQsIGFyZ3MsIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4KTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBjb25zdCB0cmFjZXIgPSBjb250ZXh0LnRyYWNlcjtcbiAgICByZXR1cm4gUVRyYWNlci50cmFjZSh0cmFjZXIsICdnZXRUcmFuc2FjdGlvbnNDb3VudCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgcmVxdWlyZUdyYW50ZWRBY2Nlc3MoY29udGV4dCwgYXJncyk7XG4gICAgICAgIGNvbnN0IHJlc3VsdDogYW55ID0gYXdhaXQgY29udGV4dC5kYXRhLnF1ZXJ5KFxuICAgICAgICAgICAgY29udGV4dC5kYXRhLnRyYW5zYWN0aW9ucy5wcm92aWRlcixcbiAgICAgICAgICAgIGBSRVRVUk4gTEVOR1RIKHRyYW5zYWN0aW9ucylgLFxuICAgICAgICAgICAge30sXG4gICAgICAgICAgICBbXSxcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3QgY291bnRzID0gKHJlc3VsdDogbnVtYmVyW10pO1xuICAgICAgICByZXR1cm4gY291bnRzLmxlbmd0aCA+IDAgPyBjb3VudHNbMF0gOiAwO1xuICAgIH0sIFFUcmFjZXIuZ2V0UGFyZW50U3Bhbih0cmFjZXIsIGNvbnRleHQpKVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBY2NvdW50c1RvdGFsQmFsYW5jZShfcGFyZW50LCBhcmdzLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCk6IFByb21pc2U8U3RyaW5nPiB7XG4gICAgY29uc3QgdHJhY2VyID0gY29udGV4dC50cmFjZXI7XG4gICAgcmV0dXJuIFFUcmFjZXIudHJhY2UodHJhY2VyLCAnZ2V0QWNjb3VudHNUb3RhbEJhbGFuY2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IHJlcXVpcmVHcmFudGVkQWNjZXNzKGNvbnRleHQsIGFyZ3MpO1xuICAgICAgICAvKlxuICAgICAgICBCZWNhdXNlIGFyYW5nbyBjYW4gbm90IHN1bSBCaWdJbnQncyB3ZSBuZWVkIHRvIHN1bSBzZXBhcmF0ZWx5OlxuICAgICAgICBocyA9IFNVTSBvZiBoaWdoIGJpdHMgKGZyb20gMjQtYml0IGFuZCBoaWdoZXIpXG4gICAgICAgIGxzID0gU1VNIG9mIGxvd2VyIDI0IGJpdHNcbiAgICAgICAgQW5kIHRoZSB0b3RhbCByZXN1bHQgaXMgKGhzIDw8IDI0KSArIGxzXG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCByZXN1bHQ6IGFueSA9IGF3YWl0IGNvbnRleHQuZGF0YS5xdWVyeShcbiAgICAgICAgICAgIGNvbnRleHQuZGF0YS5hY2NvdW50cy5wcm92aWRlcixcbiAgICAgICAgICAgIGBcbiAgICAgICAgICAgIExFVCBkID0gMTY3NzcyMTZcbiAgICAgICAgICAgIEZPUiBhIGluIGFjY291bnRzXG4gICAgICAgICAgICBMRVQgYiA9IFRPX05VTUJFUihDT05DQVQoXCIweFwiLCBTVUJTVFJJTkcoYS5iYWxhbmNlLCAyKSkpXG4gICAgICAgICAgICBDT0xMRUNUIEFHR1JFR0FURVxuICAgICAgICAgICAgICAgIGhzID0gU1VNKEZMT09SKGIgLyBkKSksXG4gICAgICAgICAgICAgICAgbHMgPSBTVU0oYiAlIChkIC0gMSkpXG4gICAgICAgICAgICBSRVRVUk4geyBocywgbHMgfVxuICAgICAgICBgLFxuICAgICAgICAgICAge30sXG4gICAgICAgICAgICBbXSk7XG4gICAgICAgIGNvbnN0IHBhcnRzID0gKHJlc3VsdDogeyBoczogbnVtYmVyLCBsczogbnVtYmVyIH1bXSlbMF07XG4gICAgICAgIC8vJEZsb3dGaXhNZVxuICAgICAgICByZXR1cm4gKEJpZ0ludChwYXJ0cy5ocykgKiBCaWdJbnQoMHgxMDAwMDAwKSArIEJpZ0ludChwYXJ0cy5scykpLnRvU3RyaW5nKCk7XG4gICAgfSwgUVRyYWNlci5nZXRQYXJlbnRTcGFuKHRyYWNlciwgY29udGV4dCkpXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldE1hbmFnZW1lbnRBY2Nlc3NLZXkoX3BhcmVudCwgYXJncywgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiBjb250ZXh0LmF1dGguZ2V0TWFuYWdlbWVudEFjY2Vzc0tleSgpO1xufVxuXG5cbi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBNdXRhdGlvblxuXG5cbmFzeW5jIGZ1bmN0aW9uIHBvc3RSZXF1ZXN0c1VzaW5nUmVzdChyZXF1ZXN0czogUmVxdWVzdFtdLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCwgX3NwYW46IFNwYW4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBjb25maWcgPSBjb250ZXh0LmNvbmZpZy5yZXF1ZXN0cztcbiAgICBjb25zdCB1cmwgPSBgJHtlbnN1cmVQcm90b2NvbChjb25maWcuc2VydmVyLCAnaHR0cCcpfS90b3BpY3MvJHtjb25maWcudG9waWN9YDtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCwge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgbW9kZTogJ2NvcnMnLFxuICAgICAgICBjYWNoZTogJ25vLWNhY2hlJyxcbiAgICAgICAgY3JlZGVudGlhbHM6ICdzYW1lLW9yaWdpbicsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgIH0sXG4gICAgICAgIHJlZGlyZWN0OiAnZm9sbG93JyxcbiAgICAgICAgcmVmZXJyZXI6ICduby1yZWZlcnJlcicsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIHJlY29yZHM6IHJlcXVlc3RzLm1hcCgocmVxdWVzdCkgPT4gKHtcbiAgICAgICAgICAgICAgICBrZXk6IHJlcXVlc3QuaWQsXG4gICAgICAgICAgICAgICAgdmFsdWU6IHJlcXVlc3QuYm9keSxcbiAgICAgICAgICAgIH0pKSxcbiAgICAgICAgfSksXG4gICAgfSk7XG4gICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgUG9zdCByZXF1ZXN0cyBmYWlsZWQ6ICR7YXdhaXQgcmVzcG9uc2UudGV4dCgpfWA7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBvc3RSZXF1ZXN0c1VzaW5nS2Fma2EocmVxdWVzdHM6IFJlcXVlc3RbXSwgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsIHNwYW46IFNwYW4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBlbnN1cmVTaGFyZWQgPSBhc3luYyAobmFtZSwgY3JlYXRlVmFsdWU6ICgpID0+IFByb21pc2U8YW55PikgPT4ge1xuICAgICAgICBpZiAoY29udGV4dC5zaGFyZWQuaGFzKG5hbWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gY29udGV4dC5zaGFyZWQuZ2V0KG5hbWUpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgY3JlYXRlVmFsdWUoKTtcbiAgICAgICAgY29udGV4dC5zaGFyZWQuc2V0KG5hbWUsIHZhbHVlKTtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH07XG5cbiAgICBjb25zdCBjb25maWcgPSBjb250ZXh0LmNvbmZpZy5yZXF1ZXN0cztcbiAgICBjb25zdCBwcm9kdWNlcjogUHJvZHVjZXIgPSBhd2FpdCBlbnN1cmVTaGFyZWQoJ3Byb2R1Y2VyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBrYWZrYTogS2Fma2EgPSBhd2FpdCBlbnN1cmVTaGFyZWQoJ2thZmthJywgYXN5bmMgKCkgPT4gbmV3IEthZmthKHtcbiAgICAgICAgICAgIGNsaWVudElkOiAncS1zZXJ2ZXInLFxuICAgICAgICAgICAgYnJva2VyczogW2NvbmZpZy5zZXJ2ZXJdLFxuICAgICAgICB9KSk7XG4gICAgICAgIGNvbnN0IG5ld1Byb2R1Y2VyID0ga2Fma2EucHJvZHVjZXIoKTtcbiAgICAgICAgYXdhaXQgbmV3UHJvZHVjZXIuY29ubmVjdCgpO1xuICAgICAgICByZXR1cm4gbmV3UHJvZHVjZXI7XG5cbiAgICB9KTtcblxuICAgIGNvbnN0IG1lc3NhZ2VzID0gcmVxdWVzdHMubWFwKChyZXF1ZXN0KSA9PiB7XG4gICAgICAgIGNvbnN0IHRyYWNlSW5mbyA9IHt9O1xuICAgICAgICBjb250ZXh0LmRhdGEudHJhY2VyLmluamVjdChzcGFuLCBGT1JNQVRfVEVYVF9NQVAsIHRyYWNlSW5mbyk7XG4gICAgICAgIGNvbnN0IGtleUJ1ZmZlciA9IEJ1ZmZlci5mcm9tKHJlcXVlc3QuaWQsICdiYXNlNjQnKTtcbiAgICAgICAgY29uc3QgdHJhY2VCdWZmZXIgPSAoT2JqZWN0LmtleXModHJhY2VJbmZvKS5sZW5ndGggPiAwKVxuICAgICAgICAgICAgPyBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeSh0cmFjZUluZm8pLCAndXRmOCcpXG4gICAgICAgICAgICA6IEJ1ZmZlci5mcm9tKFtdKTtcbiAgICAgICAgY29uc3Qga2V5ID0gQnVmZmVyLmNvbmNhdChba2V5QnVmZmVyLCB0cmFjZUJ1ZmZlcl0pO1xuICAgICAgICBjb25zdCB2YWx1ZSA9IEJ1ZmZlci5mcm9tKHJlcXVlc3QuYm9keSwgJ2Jhc2U2NCcpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgdmFsdWUsXG4gICAgICAgIH07XG4gICAgfSk7XG4gICAgYXdhaXQgcHJvZHVjZXIuc2VuZCh7XG4gICAgICAgIHRvcGljOiBjb25maWcudG9waWMsXG4gICAgICAgIG1lc3NhZ2VzLFxuICAgIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjaGVja1Bvc3RSZXN0cmljdGlvbnMoXG4gICAgY29udHJhY3RzOiBUT05Db250cmFjdHMsXG4gICAgcmVxdWVzdHM6IFJlcXVlc3RbXSxcbiAgICBhY2Nlc3NSaWdodHM6IEFjY2Vzc1JpZ2h0cyxcbikge1xuICAgIHJlcXVlc3RzLmZvckVhY2goKHJlcXVlc3QpID0+IHtcbiAgICAgICAgY29uc3Qgc2l6ZSA9IE1hdGguY2VpbChyZXF1ZXN0LmJvZHkubGVuZ3RoICogMyAvIDQpO1xuICAgICAgICBpZiAoc2l6ZSA+IDYwMDAwKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1lc3NhZ2Ugc2l6ZSAke3NpemV9IGlzIHRvbyBsYXJnZWApO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICBpZiAoYWNjZXNzUmlnaHRzLnJlc3RyaWN0VG9BY2NvdW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBhY2NvdW50cyA9IG5ldyBTZXQoYWNjZXNzUmlnaHRzLnJlc3RyaWN0VG9BY2NvdW50cyk7XG4gICAgZm9yIChjb25zdCByZXF1ZXN0OiBSZXF1ZXN0IG9mIHJlcXVlc3RzKSB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBhd2FpdCBjb250cmFjdHMucGFyc2VNZXNzYWdlKHtcbiAgICAgICAgICAgIGJvY0Jhc2U2NDogcmVxdWVzdC5ib2R5LFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKCFhY2NvdW50cy5oYXMobWVzc2FnZS5kc3QpKSB7XG4gICAgICAgICAgICB0aHJvdyBBdXRoLnVuYXV0aG9yaXplZEVycm9yKCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBvc3RSZXF1ZXN0cyhcbiAgICBfLFxuICAgIGFyZ3M6IHsgcmVxdWVzdHM6IFJlcXVlc3RbXSwgYWNjZXNzS2V5Pzogc3RyaW5nIH0sXG4gICAgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsXG4pOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgcmVxdWVzdHM6ID8oUmVxdWVzdFtdKSA9IGFyZ3MucmVxdWVzdHM7XG4gICAgaWYgKCFyZXF1ZXN0cykge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgY29uc3QgdHJhY2VyID0gY29udGV4dC50cmFjZXI7XG4gICAgcmV0dXJuIFFUcmFjZXIudHJhY2UodHJhY2VyLCAncG9zdFJlcXVlc3RzJywgYXN5bmMgKHNwYW46IFNwYW4pID0+IHtcbiAgICAgICAgc3Bhbi5zZXRUYWcoJ3BhcmFtcycsIHJlcXVlc3RzKTtcbiAgICAgICAgY29uc3QgYWNjZXNzUmlnaHRzID0gYXdhaXQgcmVxdWlyZUdyYW50ZWRBY2Nlc3MoY29udGV4dCwgYXJncyk7XG4gICAgICAgIGF3YWl0IGNoZWNrUG9zdFJlc3RyaWN0aW9ucyhjb250ZXh0LmNsaWVudC5jb250cmFjdHMsIHJlcXVlc3RzLCBhY2Nlc3NSaWdodHMpO1xuXG4gICAgICAgIGNvbnN0IGV4cGlyZWQ6ID9SZXF1ZXN0ID0gcmVxdWVzdHMuZmluZCh4ID0+IHguZXhwaXJlQXQgJiYgKERhdGUubm93KCkgPiB4LmV4cGlyZUF0KSk7XG4gICAgICAgIGlmIChleHBpcmVkKSB7XG4gICAgICAgICAgICB0aHJvdyBRRXJyb3IubWVzc2FnZUV4cGlyZWQoZXhwaXJlZC5pZCwgZXhwaXJlZC5leHBpcmVBdCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBtZXNzYWdlVHJhY2VTcGFucyA9IHJlcXVlc3RzLm1hcCgocmVxdWVzdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZUlkID0gQnVmZmVyLmZyb20ocmVxdWVzdC5pZCwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCdoZXgnKTtcbiAgICAgICAgICAgIGNvbnN0IHBvc3RTcGFuID0gdHJhY2VyLnN0YXJ0U3BhbigncG9zdFJlcXVlc3QnLCB7XG4gICAgICAgICAgICAgICAgY2hpbGRPZjogUVRyYWNlci5tZXNzYWdlUm9vdFNwYW5Db250ZXh0KG1lc3NhZ2VJZCksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHBvc3RTcGFuLmFkZFRhZ3Moe1xuICAgICAgICAgICAgICAgIG1lc3NhZ2VJZCxcbiAgICAgICAgICAgICAgICBtZXNzYWdlU2l6ZTogTWF0aC5jZWlsKHJlcXVlc3QuYm9keS5sZW5ndGggKiAzIC8gNCksXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgcmV0dXJuIHBvc3RTcGFuO1xuICAgICAgICB9KTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmIChjb250ZXh0LmNvbmZpZy5yZXF1ZXN0cy5tb2RlID09PSAncmVzdCcpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBwb3N0UmVxdWVzdHNVc2luZ1Jlc3QocmVxdWVzdHMsIGNvbnRleHQsIHNwYW4pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBwb3N0UmVxdWVzdHNVc2luZ0thZmthKHJlcXVlc3RzLCBjb250ZXh0LCBzcGFuKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnRleHQuZGF0YS5zdGF0UG9zdENvdW50LmluY3JlbWVudCgpO1xuICAgICAgICAgICAgY29udGV4dC5kYXRhLmxvZy5kZWJ1ZygncG9zdFJlcXVlc3RzJywgJ1BPU1RFRCcsIGFyZ3MsIGNvbnRleHQucmVtb3RlQWRkcmVzcyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb250ZXh0LmRhdGEuc3RhdFBvc3RGYWlsZWQuaW5jcmVtZW50KCk7XG4gICAgICAgICAgICBjb250ZXh0LmRhdGEubG9nLmRlYnVnKCdwb3N0UmVxdWVzdHMnLCAnRkFJTEVEJywgYXJncywgY29udGV4dC5yZW1vdGVBZGRyZXNzKTtcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgbWVzc2FnZVRyYWNlU3BhbnMuZm9yRWFjaCh4ID0+IHguZmluaXNoKCkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXF1ZXN0cy5tYXAoeCA9PiB4LmlkKTtcbiAgICB9LCBjb250ZXh0LnBhcmVudFNwYW4pO1xufVxuXG4vLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gQWNjZXNzIE1hbmFnZW1lbnRcblxudHlwZSBNYW5hZ2VtZW50QXJncyA9IHtcbiAgICBhY2NvdW50Pzogc3RyaW5nLFxuICAgIHNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXk/OiBzdHJpbmcsXG59XG5cbnR5cGUgUmVnaXN0ZXJBY2Nlc3NLZXlzQXJncyA9IE1hbmFnZW1lbnRBcmdzICYge1xuICAgIGtleXM6IEFjY2Vzc0tleVtdLFxufVxuXG50eXBlIFJldm9rZUFjY2Vzc0tleXNBcmdzID0gTWFuYWdlbWVudEFyZ3MgJiB7XG4gICAga2V5czogc3RyaW5nW10sXG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlZ2lzdGVyQWNjZXNzS2V5cyhcbiAgICBfLFxuICAgIGFyZ3M6IFJlZ2lzdGVyQWNjZXNzS2V5c0FyZ3MsXG4gICAgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsXG4pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIHJldHVybiBjb250ZXh0LmF1dGgucmVnaXN0ZXJBY2Nlc3NLZXlzKFxuICAgICAgICBhcmdzLmFjY291bnQgfHwgJycsXG4gICAgICAgIGFyZ3Mua2V5cyB8fCBbXSxcbiAgICAgICAgYXJncy5zaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5IHx8ICcnKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmV2b2tlQWNjZXNzS2V5cyhcbiAgICBfLFxuICAgIGFyZ3M6IFJldm9rZUFjY2Vzc0tleXNBcmdzLFxuICAgIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4LFxuKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICByZXR1cm4gY29udGV4dC5hdXRoLnJldm9rZUFjY2Vzc0tleXMoXG4gICAgICAgIGFyZ3MuYWNjb3VudCB8fCAnJyxcbiAgICAgICAgYXJncy5rZXlzIHx8IFtdLFxuICAgICAgICBhcmdzLnNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXkgfHwgJycpO1xufVxuXG50eXBlIEZpbmlzaE9wZXJhdGlvbnNBcmdzID0ge1xuICAgIG9wZXJhdGlvbklkcz86IHN0cmluZ1tdLFxufVxuXG5hc3luYyBmdW5jdGlvbiBmaW5pc2hPcGVyYXRpb25zKFxuICAgIF8sXG4gICAgYXJnczogRmluaXNoT3BlcmF0aW9uc0FyZ3MsXG4gICAgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsXG4pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IG9wZXJhdGlvbklkcyA9IG5ldyBTZXQoYXJncy5vcGVyYXRpb25JZHMgfHwgW10pO1xuICAgIGlmIChvcGVyYXRpb25JZHMuc2l6ZSA9PT0gMCkge1xuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnRleHQuZGF0YS5maW5pc2hPcGVyYXRpb25zKG9wZXJhdGlvbklkcyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhdHRhY2hDdXN0b21SZXNvbHZlcnMoZGF0YTogUUJsb2NrY2hhaW5EYXRhLCBvcmlnaW5hbDogYW55KTogYW55IHtcbiAgICBvdmVycmlkZU9iamVjdChvcmlnaW5hbCwge1xuICAgICAgICBRdWVyeToge1xuICAgICAgICAgICAgaW5mbyxcbiAgICAgICAgICAgIGdldEFjY291bnRzQ291bnQsXG4gICAgICAgICAgICBnZXRUcmFuc2FjdGlvbnNDb3VudCxcbiAgICAgICAgICAgIGdldEFjY291bnRzVG90YWxCYWxhbmNlLFxuICAgICAgICAgICAgZ2V0TWFuYWdlbWVudEFjY2Vzc0tleSxcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZUJsb2NrU2lnbmF0dXJlczogZGF0YS5ibG9ja3Nfc2lnbmF0dXJlcy5hZ2dyZWdhdGlvblJlc29sdmVyKCksXG4gICAgICAgICAgICBhZ2dyZWdhdGVCbG9ja3M6IGRhdGEuYmxvY2tzLmFnZ3JlZ2F0aW9uUmVzb2x2ZXIoKSxcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZVRyYW5zYWN0aW9uczogZGF0YS50cmFuc2FjdGlvbnMuYWdncmVnYXRpb25SZXNvbHZlcigpLFxuICAgICAgICAgICAgYWdncmVnYXRlTWVzc2FnZXM6IGRhdGEubWVzc2FnZXMuYWdncmVnYXRpb25SZXNvbHZlcigpLFxuICAgICAgICAgICAgYWdncmVnYXRlQWNjb3VudHM6IGRhdGEuYWNjb3VudHMuYWdncmVnYXRpb25SZXNvbHZlcigpLFxuICAgICAgICB9LFxuICAgICAgICBNdXRhdGlvbjoge1xuICAgICAgICAgICAgcG9zdFJlcXVlc3RzLFxuICAgICAgICAgICAgcmVnaXN0ZXJBY2Nlc3NLZXlzLFxuICAgICAgICAgICAgcmV2b2tlQWNjZXNzS2V5cyxcbiAgICAgICAgICAgIGZpbmlzaE9wZXJhdGlvbnMsXG4gICAgICAgIH0sXG4gICAgfSk7XG4gICAgcmV0dXJuIG9yaWdpbmFsO1xufVxuIl19