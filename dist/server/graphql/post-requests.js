"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.postRequestsResolvers = void 0;

var _core = require("@tonclient/core");

var _kafkajs = require("kafkajs");

var _opentracing = require("opentracing");

var _collection = require("../data/collection");

var _auth = require("../auth");

var _config = require("../config");

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _tracer = require("../tracer");

var _utils = require("../utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

async function postRequestsUsingRest(requests, context, _span) {
  const config = context.config.requests;
  const url = `${(0, _config.ensureProtocol)(config.server, 'http')}/topics/${config.topic}`;
  const response = await (0, _nodeFetch.default)(url, {
    method: 'POST',
    mode: 'cors',
    cache: 'no-cache',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json'
    },
    redirect: 'follow',
    referrer: 'no-referrer',
    body: JSON.stringify({
      records: requests.map(request => ({
        key: request.id,
        value: request.body
      }))
    })
  });

  if (response.status !== 200) {
    const message = `Post requests failed: ${await response.text()}`;
    throw new Error(message);
  }
}

async function postRequestsUsingKafka(requests, context, span) {
  const ensureShared = async (name, createValue) => {
    if (context.shared.has(name)) {
      return context.shared.get(name);
    }

    const value = await createValue();
    context.shared.set(name, value);
    return value;
  };

  const config = context.config.requests;
  const producer = await ensureShared('producer', async () => {
    const kafka = await ensureShared('kafka', async () => new _kafkajs.Kafka({
      clientId: 'q-server',
      brokers: [config.server]
    }));
    const newProducer = kafka.producer();
    await newProducer.connect();
    return newProducer;
  });
  const messages = requests.map(request => {
    const traceInfo = {};
    context.data.tracer.inject(span, _opentracing.FORMAT_TEXT_MAP, traceInfo);
    const keyBuffer = Buffer.from(request.id, 'base64');
    const traceBuffer = Object.keys(traceInfo).length > 0 ? Buffer.from(JSON.stringify(traceInfo), 'utf8') : Buffer.from([]);
    const key = Buffer.concat([keyBuffer, traceBuffer]);
    const value = Buffer.from(request.body, 'base64');
    return {
      key,
      value
    };
  });
  await producer.send({
    topic: config.topic,
    messages
  });
}

async function checkPostRestrictions(config, client, requests, accessRights) {
  requests.forEach(request => {
    const size = Math.ceil(request.body.length * 3 / 4);

    if (size > config.requests.maxSize) {
      throw new Error(`Message size ${size} is too large. Maximum size is ${config.requests.maxSize} bytes.`);
    }
  });

  if (accessRights.restrictToAccounts.length === 0) {
    return;
  }

  const accounts = new Set(accessRights.restrictToAccounts);

  for (const request of requests) {
    const message = (await client.boc.parse_message({
      boc: request.body
    })).parsed;

    if (!accounts.has(message.dst)) {
      throw _auth.Auth.unauthorizedError();
    }
  }
}

async function postRequests(_parent, args, context) {
  const requests = args.requests;

  if (!requests) {
    return [];
  }

  const tracer = context.tracer;
  return _tracer.QTracer.trace(tracer, 'postRequests', async span => {
    span.setTag('params', requests);
    const accessRights = await (0, _collection.requireGrantedAccess)(context, args);
    await checkPostRestrictions(context.config, context.client, requests, accessRights);
    const expired = requests.find(x => x.expireAt && Date.now() > x.expireAt);

    if (expired) {
      throw _utils.QError.messageExpired(expired.id, expired.expireAt);
    }

    const messageTraceSpans = requests.map(request => {
      const messageId = Buffer.from(request.id, 'base64').toString('hex');
      const postSpan = tracer.startSpan('postRequest', {
        childOf: _tracer.QTracer.messageRootSpanContext(messageId)
      });
      postSpan.addTags({
        messageId,
        messageSize: Math.ceil(request.body.length * 3 / 4)
      });
      return postSpan;
    });

    try {
      if (context.config.requests.mode === 'rest') {
        await postRequestsUsingRest(requests, context, span);
      } else {
        await postRequestsUsingKafka(requests, context, span);
      }

      await context.data.statPostCount.increment();
      context.data.log.debug('postRequests', 'POSTED', args, context.remoteAddress);
    } catch (error) {
      await context.data.statPostFailed.increment();
      context.data.log.debug('postRequests', 'FAILED', args, context.remoteAddress);
      throw error;
    } finally {
      messageTraceSpans.forEach(x => x.finish());
    }

    return requests.map(x => x.id);
  }, context.parentSpan);
}

const postRequestsResolvers = {
  Mutation: {
    postRequests
  }
};
exports.postRequestsResolvers = postRequestsResolvers;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZ3JhcGhxbC9wb3N0LXJlcXVlc3RzLmpzIl0sIm5hbWVzIjpbInBvc3RSZXF1ZXN0c1VzaW5nUmVzdCIsInJlcXVlc3RzIiwiY29udGV4dCIsIl9zcGFuIiwiY29uZmlnIiwidXJsIiwic2VydmVyIiwidG9waWMiLCJyZXNwb25zZSIsIm1ldGhvZCIsIm1vZGUiLCJjYWNoZSIsImNyZWRlbnRpYWxzIiwiaGVhZGVycyIsInJlZGlyZWN0IiwicmVmZXJyZXIiLCJib2R5IiwiSlNPTiIsInN0cmluZ2lmeSIsInJlY29yZHMiLCJtYXAiLCJyZXF1ZXN0Iiwia2V5IiwiaWQiLCJ2YWx1ZSIsInN0YXR1cyIsIm1lc3NhZ2UiLCJ0ZXh0IiwiRXJyb3IiLCJwb3N0UmVxdWVzdHNVc2luZ0thZmthIiwic3BhbiIsImVuc3VyZVNoYXJlZCIsIm5hbWUiLCJjcmVhdGVWYWx1ZSIsInNoYXJlZCIsImhhcyIsImdldCIsInNldCIsInByb2R1Y2VyIiwia2Fma2EiLCJLYWZrYSIsImNsaWVudElkIiwiYnJva2VycyIsIm5ld1Byb2R1Y2VyIiwiY29ubmVjdCIsIm1lc3NhZ2VzIiwidHJhY2VJbmZvIiwiZGF0YSIsInRyYWNlciIsImluamVjdCIsIkZPUk1BVF9URVhUX01BUCIsImtleUJ1ZmZlciIsIkJ1ZmZlciIsImZyb20iLCJ0cmFjZUJ1ZmZlciIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJjb25jYXQiLCJzZW5kIiwiY2hlY2tQb3N0UmVzdHJpY3Rpb25zIiwiY2xpZW50IiwiYWNjZXNzUmlnaHRzIiwiZm9yRWFjaCIsInNpemUiLCJNYXRoIiwiY2VpbCIsIm1heFNpemUiLCJyZXN0cmljdFRvQWNjb3VudHMiLCJhY2NvdW50cyIsIlNldCIsImJvYyIsInBhcnNlX21lc3NhZ2UiLCJwYXJzZWQiLCJkc3QiLCJBdXRoIiwidW5hdXRob3JpemVkRXJyb3IiLCJwb3N0UmVxdWVzdHMiLCJfcGFyZW50IiwiYXJncyIsIlFUcmFjZXIiLCJ0cmFjZSIsInNldFRhZyIsImV4cGlyZWQiLCJmaW5kIiwieCIsImV4cGlyZUF0IiwiRGF0ZSIsIm5vdyIsIlFFcnJvciIsIm1lc3NhZ2VFeHBpcmVkIiwibWVzc2FnZVRyYWNlU3BhbnMiLCJtZXNzYWdlSWQiLCJ0b1N0cmluZyIsInBvc3RTcGFuIiwic3RhcnRTcGFuIiwiY2hpbGRPZiIsIm1lc3NhZ2VSb290U3BhbkNvbnRleHQiLCJhZGRUYWdzIiwibWVzc2FnZVNpemUiLCJzdGF0UG9zdENvdW50IiwiaW5jcmVtZW50IiwibG9nIiwiZGVidWciLCJyZW1vdGVBZGRyZXNzIiwiZXJyb3IiLCJzdGF0UG9zdEZhaWxlZCIsImZpbmlzaCIsInBhcmVudFNwYW4iLCJwb3N0UmVxdWVzdHNSZXNvbHZlcnMiLCJNdXRhdGlvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOzs7O0FBU0EsZUFBZUEscUJBQWYsQ0FBcUNDLFFBQXJDLEVBQTBEQyxPQUExRCxFQUE0RkMsS0FBNUYsRUFBd0g7QUFDcEgsUUFBTUMsTUFBTSxHQUFHRixPQUFPLENBQUNFLE1BQVIsQ0FBZUgsUUFBOUI7QUFDQSxRQUFNSSxHQUFHLEdBQUksR0FBRSw0QkFBZUQsTUFBTSxDQUFDRSxNQUF0QixFQUE4QixNQUE5QixDQUFzQyxXQUFVRixNQUFNLENBQUNHLEtBQU0sRUFBNUU7QUFDQSxRQUFNQyxRQUFRLEdBQUcsTUFBTSx3QkFBTUgsR0FBTixFQUFXO0FBQzlCSSxJQUFBQSxNQUFNLEVBQUUsTUFEc0I7QUFFOUJDLElBQUFBLElBQUksRUFBRSxNQUZ3QjtBQUc5QkMsSUFBQUEsS0FBSyxFQUFFLFVBSHVCO0FBSTlCQyxJQUFBQSxXQUFXLEVBQUUsYUFKaUI7QUFLOUJDLElBQUFBLE9BQU8sRUFBRTtBQUNMLHNCQUFnQjtBQURYLEtBTHFCO0FBUTlCQyxJQUFBQSxRQUFRLEVBQUUsUUFSb0I7QUFTOUJDLElBQUFBLFFBQVEsRUFBRSxhQVRv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QXVDLFFBQXZDLEVBQWlEeEIsSUFBakQsRUFBdUQ3RSxPQUFPLENBQUNzRyxhQUEvRDtBQUNBLFlBQU1DLEtBQU47QUFDSCxLQVpELFNBWVU7QUFDTmQsTUFBQUEsaUJBQWlCLENBQUM1QixPQUFsQixDQUEwQnNCLENBQUMsSUFBSUEsQ0FBQyxDQUFDc0IsTUFBRixFQUEvQjtBQUNIOztBQUNELFdBQU8xRyxRQUFRLENBQUNtQixHQUFULENBQWFpRSxDQUFDLElBQUlBLENBQUMsQ0FBQzlELEVBQXBCLENBQVA7QUFDSCxHQXJDTSxFQXFDSnJCLE9BQU8sQ0FBQzBHLFVBckNKLENBQVA7QUFzQ0g7O0FBRU0sTUFBTUMscUJBQXFCLEdBQUc7QUFDakNDLEVBQUFBLFFBQVEsRUFBRTtBQUNOakMsSUFBQUE7QUFETTtBQUR1QixDQUE5QiIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB7IFRvbkNsaWVudCB9IGZyb20gXCJAdG9uY2xpZW50L2NvcmVcIjtcbmltcG9ydCB7IEthZmthLCBQcm9kdWNlciB9IGZyb20gJ2thZmthanMnO1xuaW1wb3J0IHsgU3BhbiwgRk9STUFUX1RFWFRfTUFQIH0gZnJvbSAnb3BlbnRyYWNpbmcnO1xuaW1wb3J0IHR5cGUgeyBRQ29uZmlnIH0gZnJvbSBcIi4uL2NvbmZpZ1wiO1xuaW1wb3J0IHsgcmVxdWlyZUdyYW50ZWRBY2Nlc3MgfSBmcm9tICcuLi9kYXRhL2NvbGxlY3Rpb24nO1xuaW1wb3J0IHsgQXV0aCB9IGZyb20gJy4uL2F1dGgnO1xuaW1wb3J0IHsgZW5zdXJlUHJvdG9jb2wgfSBmcm9tICcuLi9jb25maWcnO1xuaW1wb3J0IGZldGNoIGZyb20gJ25vZGUtZmV0Y2gnO1xuaW1wb3J0IHR5cGUgeyBBY2Nlc3NSaWdodHMgfSBmcm9tICcuLi9hdXRoJztcbmltcG9ydCB7IFFUcmFjZXIgfSBmcm9tICcuLi90cmFjZXInO1xuaW1wb3J0IHsgUUVycm9yIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHR5cGUgeyBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCB9IGZyb20gXCIuL2NvbnRleHRcIjtcblxudHlwZSBSZXF1ZXN0ID0ge1xuICAgIGlkOiBzdHJpbmcsXG4gICAgYm9keTogc3RyaW5nLFxuICAgIGV4cGlyZUF0OiBudW1iZXIsXG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBvc3RSZXF1ZXN0c1VzaW5nUmVzdChyZXF1ZXN0czogUmVxdWVzdFtdLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCwgX3NwYW46IFNwYW4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBjb25maWcgPSBjb250ZXh0LmNvbmZpZy5yZXF1ZXN0cztcbiAgICBjb25zdCB1cmwgPSBgJHtlbnN1cmVQcm90b2NvbChjb25maWcuc2VydmVyLCAnaHR0cCcpfS90b3BpY3MvJHtjb25maWcudG9waWN9YDtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCwge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgbW9kZTogJ2NvcnMnLFxuICAgICAgICBjYWNoZTogJ25vLWNhY2hlJyxcbiAgICAgICAgY3JlZGVudGlhbHM6ICdzYW1lLW9yaWdpbicsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgIH0sXG4gICAgICAgIHJlZGlyZWN0OiAnZm9sbG93JyxcbiAgICAgICAgcmVmZXJyZXI6ICduby1yZWZlcnJlcicsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIHJlY29yZHM6IHJlcXVlc3RzLm1hcCgocmVxdWVzdCkgPT4gKHtcbiAgICAgICAgICAgICAgICBrZXk6IHJlcXVlc3QuaWQsXG4gICAgICAgICAgICAgICAgdmFsdWU6IHJlcXVlc3QuYm9keSxcbiAgICAgICAgICAgIH0pKSxcbiAgICAgICAgfSksXG4gICAgfSk7XG4gICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgUG9zdCByZXF1ZXN0cyBmYWlsZWQ6ICR7YXdhaXQgcmVzcG9uc2UudGV4dCgpfWA7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBvc3RSZXF1ZXN0c1VzaW5nS2Fma2EocmVxdWVzdHM6IFJlcXVlc3RbXSwgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsIHNwYW46IFNwYW4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBlbnN1cmVTaGFyZWQgPSBhc3luYyAobmFtZSwgY3JlYXRlVmFsdWU6ICgpID0+IFByb21pc2U8YW55PikgPT4ge1xuICAgICAgICBpZiAoY29udGV4dC5zaGFyZWQuaGFzKG5hbWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gY29udGV4dC5zaGFyZWQuZ2V0KG5hbWUpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgY3JlYXRlVmFsdWUoKTtcbiAgICAgICAgY29udGV4dC5zaGFyZWQuc2V0KG5hbWUsIHZhbHVlKTtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH07XG5cbiAgICBjb25zdCBjb25maWcgPSBjb250ZXh0LmNvbmZpZy5yZXF1ZXN0cztcbiAgICBjb25zdCBwcm9kdWNlcjogUHJvZHVjZXIgPSBhd2FpdCBlbnN1cmVTaGFyZWQoJ3Byb2R1Y2VyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBrYWZrYTogS2Fma2EgPSBhd2FpdCBlbnN1cmVTaGFyZWQoJ2thZmthJywgYXN5bmMgKCkgPT4gbmV3IEthZmthKHtcbiAgICAgICAgICAgIGNsaWVudElkOiAncS1zZXJ2ZXInLFxuICAgICAgICAgICAgYnJva2VyczogW2NvbmZpZy5zZXJ2ZXJdLFxuICAgICAgICB9KSk7XG4gICAgICAgIGNvbnN0IG5ld1Byb2R1Y2VyID0ga2Fma2EucHJvZHVjZXIoKTtcbiAgICAgICAgYXdhaXQgbmV3UHJvZHVjZXIuY29ubmVjdCgpO1xuICAgICAgICByZXR1cm4gbmV3UHJvZHVjZXI7XG5cbiAgICB9KTtcblxuICAgIGNvbnN0IG1lc3NhZ2VzID0gcmVxdWVzdHMubWFwKChyZXF1ZXN0KSA9PiB7XG4gICAgICAgIGNvbnN0IHRyYWNlSW5mbyA9IHt9O1xuICAgICAgICBjb250ZXh0LmRhdGEudHJhY2VyLmluamVjdChzcGFuLCBGT1JNQVRfVEVYVF9NQVAsIHRyYWNlSW5mbyk7XG4gICAgICAgIGNvbnN0IGtleUJ1ZmZlciA9IEJ1ZmZlci5mcm9tKHJlcXVlc3QuaWQsICdiYXNlNjQnKTtcbiAgICAgICAgY29uc3QgdHJhY2VCdWZmZXIgPSAoT2JqZWN0LmtleXModHJhY2VJbmZvKS5sZW5ndGggPiAwKVxuICAgICAgICAgICAgPyBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeSh0cmFjZUluZm8pLCAndXRmOCcpXG4gICAgICAgICAgICA6IEJ1ZmZlci5mcm9tKFtdKTtcbiAgICAgICAgY29uc3Qga2V5ID0gQnVmZmVyLmNvbmNhdChba2V5QnVmZmVyLCB0cmFjZUJ1ZmZlcl0pO1xuICAgICAgICBjb25zdCB2YWx1ZSA9IEJ1ZmZlci5mcm9tKHJlcXVlc3QuYm9keSwgJ2Jhc2U2NCcpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgdmFsdWUsXG4gICAgICAgIH07XG4gICAgfSk7XG4gICAgYXdhaXQgcHJvZHVjZXIuc2VuZCh7XG4gICAgICAgIHRvcGljOiBjb25maWcudG9waWMsXG4gICAgICAgIG1lc3NhZ2VzLFxuICAgIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjaGVja1Bvc3RSZXN0cmljdGlvbnMoXG4gICAgY29uZmlnOiBRQ29uZmlnLFxuICAgIGNsaWVudDogVG9uQ2xpZW50LFxuICAgIHJlcXVlc3RzOiBSZXF1ZXN0W10sXG4gICAgYWNjZXNzUmlnaHRzOiBBY2Nlc3NSaWdodHMsXG4pIHtcbiAgICByZXF1ZXN0cy5mb3JFYWNoKChyZXF1ZXN0KSA9PiB7XG4gICAgICAgIGNvbnN0IHNpemUgPSBNYXRoLmNlaWwocmVxdWVzdC5ib2R5Lmxlbmd0aCAqIDMgLyA0KTtcbiAgICAgICAgaWYgKHNpemUgPiBjb25maWcucmVxdWVzdHMubWF4U2l6ZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNZXNzYWdlIHNpemUgJHtzaXplfSBpcyB0b28gbGFyZ2UuIE1heGltdW0gc2l6ZSBpcyAke2NvbmZpZy5yZXF1ZXN0cy5tYXhTaXplfSBieXRlcy5gKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKGFjY2Vzc1JpZ2h0cy5yZXN0cmljdFRvQWNjb3VudHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgYWNjb3VudHMgPSBuZXcgU2V0KGFjY2Vzc1JpZ2h0cy5yZXN0cmljdFRvQWNjb3VudHMpO1xuICAgIGZvciAoY29uc3QgcmVxdWVzdDogUmVxdWVzdCBvZiByZXF1ZXN0cykge1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gKGF3YWl0IGNsaWVudC5ib2MucGFyc2VfbWVzc2FnZSh7XG4gICAgICAgICAgICBib2M6IHJlcXVlc3QuYm9keSxcbiAgICAgICAgfSkpLnBhcnNlZDtcbiAgICAgICAgaWYgKCFhY2NvdW50cy5oYXMobWVzc2FnZS5kc3QpKSB7XG4gICAgICAgICAgICB0aHJvdyBBdXRoLnVuYXV0aG9yaXplZEVycm9yKCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBvc3RSZXF1ZXN0cyhcbiAgICBfcGFyZW50OiBhbnksXG4gICAgYXJnczogeyByZXF1ZXN0czogUmVxdWVzdFtdLCBhY2Nlc3NLZXk/OiBzdHJpbmcgfSxcbiAgICBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCxcbik6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCByZXF1ZXN0czogPyhSZXF1ZXN0W10pID0gYXJncy5yZXF1ZXN0cztcbiAgICBpZiAoIXJlcXVlc3RzKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBjb25zdCB0cmFjZXIgPSBjb250ZXh0LnRyYWNlcjtcbiAgICByZXR1cm4gUVRyYWNlci50cmFjZSh0cmFjZXIsICdwb3N0UmVxdWVzdHMnLCBhc3luYyAoc3BhbjogU3BhbikgPT4ge1xuICAgICAgICBzcGFuLnNldFRhZygncGFyYW1zJywgcmVxdWVzdHMpO1xuICAgICAgICBjb25zdCBhY2Nlc3NSaWdodHMgPSBhd2FpdCByZXF1aXJlR3JhbnRlZEFjY2Vzcyhjb250ZXh0LCBhcmdzKTtcbiAgICAgICAgYXdhaXQgY2hlY2tQb3N0UmVzdHJpY3Rpb25zKGNvbnRleHQuY29uZmlnLCBjb250ZXh0LmNsaWVudCwgcmVxdWVzdHMsIGFjY2Vzc1JpZ2h0cyk7XG5cbiAgICAgICAgY29uc3QgZXhwaXJlZDogP1JlcXVlc3QgPSByZXF1ZXN0cy5maW5kKHggPT4geC5leHBpcmVBdCAmJiAoRGF0ZS5ub3coKSA+IHguZXhwaXJlQXQpKTtcbiAgICAgICAgaWYgKGV4cGlyZWQpIHtcbiAgICAgICAgICAgIHRocm93IFFFcnJvci5tZXNzYWdlRXhwaXJlZChleHBpcmVkLmlkLCBleHBpcmVkLmV4cGlyZUF0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG1lc3NhZ2VUcmFjZVNwYW5zID0gcmVxdWVzdHMubWFwKChyZXF1ZXN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlSWQgPSBCdWZmZXIuZnJvbShyZXF1ZXN0LmlkLCAnYmFzZTY0JykudG9TdHJpbmcoJ2hleCcpO1xuICAgICAgICAgICAgY29uc3QgcG9zdFNwYW4gPSB0cmFjZXIuc3RhcnRTcGFuKCdwb3N0UmVxdWVzdCcsIHtcbiAgICAgICAgICAgICAgICBjaGlsZE9mOiBRVHJhY2VyLm1lc3NhZ2VSb290U3BhbkNvbnRleHQobWVzc2FnZUlkKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcG9zdFNwYW4uYWRkVGFncyh7XG4gICAgICAgICAgICAgICAgbWVzc2FnZUlkLFxuICAgICAgICAgICAgICAgIG1lc3NhZ2VTaXplOiBNYXRoLmNlaWwocmVxdWVzdC5ib2R5Lmxlbmd0aCAqIDMgLyA0KSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICByZXR1cm4gcG9zdFNwYW47XG4gICAgICAgIH0pO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKGNvbnRleHQuY29uZmlnLnJlcXVlc3RzLm1vZGUgPT09ICdyZXN0Jykge1xuICAgICAgICAgICAgICAgIGF3YWl0IHBvc3RSZXF1ZXN0c1VzaW5nUmVzdChyZXF1ZXN0cywgY29udGV4dCwgc3Bhbik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGF3YWl0IHBvc3RSZXF1ZXN0c1VzaW5nS2Fma2EocmVxdWVzdHMsIGNvbnRleHQsIHNwYW4pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXdhaXQgY29udGV4dC5kYXRhLnN0YXRQb3N0Q291bnQuaW5jcmVtZW50KCk7XG4gICAgICAgICAgICBjb250ZXh0LmRhdGEubG9nLmRlYnVnKCdwb3N0UmVxdWVzdHMnLCAnUE9TVEVEJywgYXJncywgY29udGV4dC5yZW1vdGVBZGRyZXNzKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGF3YWl0IGNvbnRleHQuZGF0YS5zdGF0UG9zdEZhaWxlZC5pbmNyZW1lbnQoKTtcbiAgICAgICAgICAgIGNvbnRleHQuZGF0YS5sb2cuZGVidWcoJ3Bvc3RSZXF1ZXN0cycsICdGQUlMRUQnLCBhcmdzLCBjb250ZXh0LnJlbW90ZUFkZHJlc3MpO1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBtZXNzYWdlVHJhY2VTcGFucy5mb3JFYWNoKHggPT4geC5maW5pc2goKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlcXVlc3RzLm1hcCh4ID0+IHguaWQpO1xuICAgIH0sIGNvbnRleHQucGFyZW50U3Bhbik7XG59XG5cbmV4cG9ydCBjb25zdCBwb3N0UmVxdWVzdHNSZXNvbHZlcnMgPSB7XG4gICAgTXV0YXRpb246IHtcbiAgICAgICAgcG9zdFJlcXVlc3RzLFxuICAgIH0sXG59O1xuIl19