"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.QTracer = exports.StatsTiming = exports.StatsGauge = exports.StatsCounter = exports.QStats = void 0;

var _config = require("./config");

var _noop = require("opentracing/lib/noop");

var _nodeStatsd = _interopRequireDefault(require("node-statsd"));

var _opentracing = require("opentracing");

var _jaegerClient = require("jaeger-client");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function dummy(stat, value, sampleRate, tags) {}

const dummyStats = {
  increment: dummy,
  decrement: dummy,
  histogram: dummy,
  gauge: dummy,
  set: dummy,
  timing: dummy
};

class QStats {
  static create(server) {
    if (!server) {
      return dummyStats;
    }

    const hostPort = server.split(':');
    return new _nodeStatsd.default(hostPort[0], hostPort[1], _config.STATS.prefix);
  }

}

exports.QStats = QStats;

class StatsCounter {
  constructor(stats, name, tags) {
    this.stats = stats;
    this.name = name;
    this.tags = tags;
  }

  increment() {
    this.stats.increment(this.name, 1, this.tags);
  }

}

exports.StatsCounter = StatsCounter;

class StatsGauge {
  constructor(stats, name, tags) {
    this.stats = stats;
    this.name = name;
    this.tags = tags;
    this.value = 0;
  }

  set(value) {
    this.value = value;
    this.stats.gauge(this.name, this.value, this.tags);
  }

  increment(delta = 1) {
    this.set(this.value + delta);
  }

  decrement(delta = 1) {
    this.set(this.value - delta);
  }

}

exports.StatsGauge = StatsGauge;

class StatsTiming {
  constructor(stats, name, tags) {
    this.stats = stats;
    this.name = name;
    this.tags = tags;
  }

  report(value) {
    this.stats.timing(this.name, value, this.tags);
  }

  start() {
    const start = Date.now();
    return () => {
      this.report(Date.now() - start);
    };
  }

}

exports.StatsTiming = StatsTiming;

function parseUrl(url) {
  const protocolSeparatorPos = url.indexOf('://');
  const protocolEnd = protocolSeparatorPos >= 0 ? protocolSeparatorPos + 3 : 0;
  const questionPos = url.indexOf('?', protocolEnd);
  const queryStart = questionPos >= 0 ? questionPos + 1 : url.length;
  const pathEnd = questionPos >= 0 ? questionPos : url.length;
  const pathSeparatorPos = url.indexOf('/', protocolEnd); // eslint-disable-next-line no-nested-ternary

  const pathStart = pathSeparatorPos >= 0 ? pathSeparatorPos < pathEnd ? pathSeparatorPos : pathEnd : questionPos >= 0 ? questionPos : url.length;
  const hostPort = url.substring(protocolEnd, pathStart).split(':');
  return {
    protocol: url.substring(0, protocolEnd),
    host: hostPort[0],
    port: hostPort[1] || '',
    path: url.substring(pathStart, pathEnd),
    query: url.substring(queryStart)
  };
}

class QTracer {
  static getJaegerConfig(config) {
    const endpoint = config.endpoint;

    if (!endpoint) {
      return null;
    }

    const parts = parseUrl(endpoint);
    return parts.protocol === '' ? {
      serviceName: config.service,
      sampler: {
        type: 'const',
        param: 1
      },
      reporter: {
        logSpans: true,
        agentHost: parts.host,
        agentPort: Number(parts.port)
      }
    } : {
      serviceName: config.service,
      sampler: {
        type: 'const',
        param: 1
      },
      reporter: {
        logSpans: true,
        collectorEndpoint: endpoint
      }
    };
  }

  static create(config) {
    QTracer.config = config;
    const jaegerConfig = QTracer.getJaegerConfig(config.jaeger);

    if (!jaegerConfig) {
      return _noop.tracer;
    }

    return (0, _jaegerClient.initTracerFromEnv)(jaegerConfig, {
      logger: {
        info(msg) {
          console.log('INFO ', msg);
        },

        error(msg) {
          console.log('ERROR', msg);
        }

      }
    });
  }

  static extractParentSpan(tracer, req) {
    let ctx_src, ctx_frm;

    if (req.headers) {
      ctx_src = req.headers;
      ctx_frm = _opentracing.FORMAT_TEXT_MAP;
    } else {
      ctx_src = req.context;
      ctx_frm = _opentracing.FORMAT_BINARY;
    }

    return tracer.extract(ctx_frm, ctx_src);
  }

  static getParentSpan(tracer, context) {
    return context.tracerParentSpan;
  }

  static failed(tracer, span, error) {
    span.log({
      event: 'failed',
      payload: (0, _utils.toLog)(error)
    });
  }

  static async trace(tracer, name, f, parentSpan) {
    const span = tracer.startSpan(name, {
      childOf: parentSpan
    });

    try {
      span.setTag(_opentracing.Tags.SPAN_KIND, 'server');
      Object.entries(QTracer.config.jaeger.tags).forEach(([name, value]) => {
        if (name) {
          span.setTag(name, value);
        }
      });
      const result = await f(span);

      if (result !== undefined) {
        span.setTag('result', (0, _utils.toLog)(result));
      }

      span.finish();
      return result;
    } catch (error) {
      const cleaned = (0, _utils.cleanError)(error);
      QTracer.failed(tracer, span, cleaned);
      span.finish();
      throw cleaned;
    }
  }

}

exports.QTracer = QTracer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci90cmFjZXIuanMiXSwibmFtZXMiOlsiZHVtbXkiLCJzdGF0IiwidmFsdWUiLCJzYW1wbGVSYXRlIiwidGFncyIsImR1bW15U3RhdHMiLCJpbmNyZW1lbnQiLCJkZWNyZW1lbnQiLCJoaXN0b2dyYW0iLCJnYXVnZSIsInNldCIsInRpbWluZyIsIlFTdGF0cyIsImNyZWF0ZSIsInNlcnZlciIsImhvc3RQb3J0Iiwic3BsaXQiLCJTdGF0c0QiLCJTVEFUUyIsInByZWZpeCIsIlN0YXRzQ291bnRlciIsImNvbnN0cnVjdG9yIiwic3RhdHMiLCJuYW1lIiwiU3RhdHNHYXVnZSIsImRlbHRhIiwiU3RhdHNUaW1pbmciLCJyZXBvcnQiLCJzdGFydCIsIkRhdGUiLCJub3ciLCJwYXJzZVVybCIsInVybCIsInByb3RvY29sU2VwYXJhdG9yUG9zIiwiaW5kZXhPZiIsInByb3RvY29sRW5kIiwicXVlc3Rpb25Qb3MiLCJxdWVyeVN0YXJ0IiwibGVuZ3RoIiwicGF0aEVuZCIsInBhdGhTZXBhcmF0b3JQb3MiLCJwYXRoU3RhcnQiLCJzdWJzdHJpbmciLCJwcm90b2NvbCIsImhvc3QiLCJwb3J0IiwicGF0aCIsInF1ZXJ5IiwiUVRyYWNlciIsImdldEphZWdlckNvbmZpZyIsImNvbmZpZyIsImVuZHBvaW50IiwicGFydHMiLCJzZXJ2aWNlTmFtZSIsInNlcnZpY2UiLCJzYW1wbGVyIiwidHlwZSIsInBhcmFtIiwicmVwb3J0ZXIiLCJsb2dTcGFucyIsImFnZW50SG9zdCIsImFnZW50UG9ydCIsIk51bWJlciIsImNvbGxlY3RvckVuZHBvaW50IiwiamFlZ2VyQ29uZmlnIiwiamFlZ2VyIiwibm9vcFRyYWNlciIsImxvZ2dlciIsImluZm8iLCJtc2ciLCJjb25zb2xlIiwibG9nIiwiZXJyb3IiLCJleHRyYWN0UGFyZW50U3BhbiIsInRyYWNlciIsInJlcSIsImN0eF9zcmMiLCJjdHhfZnJtIiwiaGVhZGVycyIsIkZPUk1BVF9URVhUX01BUCIsImNvbnRleHQiLCJGT1JNQVRfQklOQVJZIiwiZXh0cmFjdCIsImdldFBhcmVudFNwYW4iLCJ0cmFjZXJQYXJlbnRTcGFuIiwiZmFpbGVkIiwic3BhbiIsImV2ZW50IiwicGF5bG9hZCIsInRyYWNlIiwiZiIsInBhcmVudFNwYW4iLCJzdGFydFNwYW4iLCJjaGlsZE9mIiwic2V0VGFnIiwiVGFncyIsIlNQQU5fS0lORCIsIk9iamVjdCIsImVudHJpZXMiLCJmb3JFYWNoIiwicmVzdWx0IiwidW5kZWZpbmVkIiwiZmluaXNoIiwiY2xlYW5lZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUVBOztBQUVBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOzs7O0FBZ0JBLFNBQVNBLEtBQVQsQ0FBZUMsSUFBZixFQUE2QkMsS0FBN0IsRUFBNkNDLFVBQTdDLEVBQTZFQyxJQUE3RSxFQUE4RixDQUM3Rjs7QUFFRCxNQUFNQyxVQUFrQixHQUFHO0FBQ3ZCQyxFQUFBQSxTQUFTLEVBQUVOLEtBRFk7QUFFdkJPLEVBQUFBLFNBQVMsRUFBRVAsS0FGWTtBQUd2QlEsRUFBQUEsU0FBUyxFQUFFUixLQUhZO0FBSXZCUyxFQUFBQSxLQUFLLEVBQUVULEtBSmdCO0FBS3ZCVSxFQUFBQSxHQUFHLEVBQUVWLEtBTGtCO0FBTXZCVyxFQUFBQSxNQUFNLEVBQUVYO0FBTmUsQ0FBM0I7O0FBU08sTUFBTVksTUFBTixDQUFhO0FBQ2hCLFNBQU9DLE1BQVAsQ0FBY0MsTUFBZCxFQUFzQztBQUNsQyxRQUFJLENBQUNBLE1BQUwsRUFBYTtBQUNULGFBQU9ULFVBQVA7QUFDSDs7QUFDRCxVQUFNVSxRQUFRLEdBQUdELE1BQU0sQ0FBQ0UsS0FBUCxDQUFhLEdBQWIsQ0FBakI7QUFDQSxXQUFPLElBQUlDLG1CQUFKLENBQVdGLFFBQVEsQ0FBQyxDQUFELENBQW5CLEVBQXdCQSxRQUFRLENBQUMsQ0FBRCxDQUFoQyxFQUFxQ0csY0FBTUMsTUFBM0MsQ0FBUDtBQUNIOztBQVBlOzs7O0FBVWIsTUFBTUMsWUFBTixDQUFtQjtBQUt0QkMsRUFBQUEsV0FBVyxD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LENBQVl2RSxJQUFaLEVBQWtCckIsS0FBbEI7QUFDSDtBQUNKLE9BSkQ7QUFLQSxZQUFNa0csTUFBTSxHQUFHLE1BQU1WLENBQUMsQ0FBQ0osSUFBRCxDQUF0Qjs7QUFDQSxVQUFJYyxNQUFNLEtBQUtDLFNBQWYsRUFBMEI7QUFDdEJmLFFBQUFBLElBQUksQ0FBQ1EsTUFBTCxDQUFZLFFBQVosRUFBc0Isa0JBQU1NLE1BQU4sQ0FBdEI7QUFDSDs7QUFDRGQsTUFBQUEsSUFBSSxDQUFDZ0IsTUFBTDtBQUNBLGFBQU9GLE1BQVA7QUFDSCxLQWJELENBYUUsT0FBTzVCLEtBQVAsRUFBYztBQUNaLFlBQU0rQixPQUFPLEdBQUcsdUJBQVcvQixLQUFYLENBQWhCO0FBQ0F4QixNQUFBQSxPQUFPLENBQUNxQyxNQUFSLENBQWVYLE1BQWYsRUFBdUJZLElBQXZCLEVBQTZCaUIsT0FBN0I7QUFDQWpCLE1BQUFBLElBQUksQ0FBQ2dCLE1BQUw7QUFDQSxZQUFNQyxPQUFOO0FBQ0g7QUFDSjs7QUE1R2dCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHsgU1RBVFMgfSBmcm9tICcuL2NvbmZpZyc7XG5pbXBvcnQgdHlwZSB7IFFDb25maWcgfSBmcm9tIFwiLi9jb25maWdcIjtcbmltcG9ydCB7IHRyYWNlciBhcyBub29wVHJhY2VyIH0gZnJvbSBcIm9wZW50cmFjaW5nL2xpYi9ub29wXCI7XG5pbXBvcnQgU3RhdHNEIGZyb20gJ25vZGUtc3RhdHNkJztcbmltcG9ydCB7IFRyYWNlciwgVGFncywgRk9STUFUX1RFWFRfTUFQLCBGT1JNQVRfQklOQVJZLCBTcGFuLCBTcGFuQ29udGV4dCB9IGZyb20gXCJvcGVudHJhY2luZ1wiO1xuXG5pbXBvcnQgeyBpbml0VHJhY2VyRnJvbUVudiBhcyBpbml0SmFlZ2VyVHJhY2VyIH0gZnJvbSAnamFlZ2VyLWNsaWVudCc7XG5pbXBvcnQgeyBjbGVhbkVycm9yLCB0b0xvZyB9IGZyb20gXCIuL3V0aWxzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVN0YXRzIHtcbiAgICBpbmNyZW1lbnQoc3RhdDogc3RyaW5nLCB2YWx1ZT86IG51bWJlciwgc2FtcGxlUmF0ZT86IG51bWJlciB8IHN0cmluZ1tdLCB0YWdzPzogc3RyaW5nW10pOiB2b2lkLFxuXG4gICAgZGVjcmVtZW50KHN0YXQ6IHN0cmluZywgdmFsdWU/OiBudW1iZXIsIHNhbXBsZVJhdGU/OiBudW1iZXIgfCBzdHJpbmdbXSwgdGFncz86IHN0cmluZ1tdKTogdm9pZCxcblxuICAgIGhpc3RvZ3JhbShzdGF0OiBzdHJpbmcsIHZhbHVlOiBudW1iZXIsIHNhbXBsZVJhdGU/OiBudW1iZXIgfCBzdHJpbmdbXSwgdGFncz86IHN0cmluZ1tdKTogdm9pZCxcblxuICAgIGdhdWdlKHN0YXQ6IHN0cmluZywgdmFsdWU6IG51bWJlciwgc2FtcGxlUmF0ZT86IG51bWJlciB8IHN0cmluZ1tdLCB0YWdzPzogc3RyaW5nW10pOiB2b2lkLFxuXG4gICAgc2V0KHN0YXQ6IHN0cmluZywgdmFsdWU6IG51bWJlciwgc2FtcGxlUmF0ZT86IG51bWJlciB8IHN0cmluZ1tdLCB0YWdzPzogc3RyaW5nW10pOiB2b2lkLFxuXG4gICAgdGltaW5nKHN0YXQ6IHN0cmluZywgdmFsdWU6IG51bWJlciwgc2FtcGxlUmF0ZT86IG51bWJlciB8IHN0cmluZ1tdLCB0YWdzPzogc3RyaW5nW10pOiB2b2lkLFxufVxuXG5mdW5jdGlvbiBkdW1teShzdGF0OiBzdHJpbmcsIHZhbHVlPzogbnVtYmVyLCBzYW1wbGVSYXRlPzogbnVtYmVyIHwgc3RyaW5nW10sIHRhZ3M/OiBzdHJpbmdbXSkge1xufVxuXG5jb25zdCBkdW1teVN0YXRzOiBJU3RhdHMgPSB7XG4gICAgaW5jcmVtZW50OiBkdW1teSxcbiAgICBkZWNyZW1lbnQ6IGR1bW15LFxuICAgIGhpc3RvZ3JhbTogZHVtbXksXG4gICAgZ2F1Z2U6IGR1bW15LFxuICAgIHNldDogZHVtbXksXG4gICAgdGltaW5nOiBkdW1teSxcbn07XG5cbmV4cG9ydCBjbGFzcyBRU3RhdHMge1xuICAgIHN0YXRpYyBjcmVhdGUoc2VydmVyOiBzdHJpbmcpOiBJU3RhdHMge1xuICAgICAgICBpZiAoIXNlcnZlcikge1xuICAgICAgICAgICAgcmV0dXJuIGR1bW15U3RhdHM7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgaG9zdFBvcnQgPSBzZXJ2ZXIuc3BsaXQoJzonKTtcbiAgICAgICAgcmV0dXJuIG5ldyBTdGF0c0QoaG9zdFBvcnRbMF0sIGhvc3RQb3J0WzFdLCBTVEFUUy5wcmVmaXgpO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFN0YXRzQ291bnRlciB7XG4gICAgc3RhdHM6IElTdGF0cztcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgdGFnczogc3RyaW5nW107XG5cbiAgICBjb25zdHJ1Y3RvcihzdGF0czogSVN0YXRzLCBuYW1lOiBzdHJpbmcsIHRhZ3M6IHN0cmluZ1tdKSB7XG4gICAgICAgIHRoaXMuc3RhdHMgPSBzdGF0cztcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgdGhpcy50YWdzID0gdGFncztcbiAgICB9XG5cbiAgICBpbmNyZW1lbnQoKSB7XG4gICAgICAgIHRoaXMuc3RhdHMuaW5jcmVtZW50KHRoaXMubmFtZSwgMSwgdGhpcy50YWdzKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBTdGF0c0dhdWdlIHtcbiAgICBzdGF0czogSVN0YXRzO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB0YWdzOiBzdHJpbmdbXTtcbiAgICB2YWx1ZTogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3Ioc3RhdHM6IElTdGF0cywgbmFtZTogc3RyaW5nLCB0YWdzOiBzdHJpbmdbXSkge1xuICAgICAgICB0aGlzLnN0YXRzID0gc3RhdHM7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHRoaXMudGFncyA9IHRhZ3M7XG4gICAgICAgIHRoaXMudmFsdWUgPSAwO1xuICAgIH1cblxuICAgIHNldCh2YWx1ZTogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcbiAgICAgICAgdGhpcy5zdGF0cy5nYXVnZSh0aGlzLm5hbWUsIHRoaXMudmFsdWUsIHRoaXMudGFncyk7XG4gICAgfVxuXG4gICAgaW5jcmVtZW50KGRlbHRhOiBudW1iZXIgPSAxKSB7XG4gICAgICAgIHRoaXMuc2V0KHRoaXMudmFsdWUgKyBkZWx0YSk7XG4gICAgfVxuXG4gICAgZGVjcmVtZW50KGRlbHRhOiBudW1iZXIgPSAxKSB7XG4gICAgICAgIHRoaXMuc2V0KHRoaXMudmFsdWUgLSBkZWx0YSk7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgU3RhdHNUaW1pbmcge1xuICAgIHN0YXRzOiBJU3RhdHM7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIHRhZ3M6IHN0cmluZ1tdO1xuXG4gICAgY29uc3RydWN0b3Ioc3RhdHM6IElTdGF0cywgbmFtZTogc3RyaW5nLCB0YWdzOiBzdHJpbmdbXSkge1xuICAgICAgICB0aGlzLnN0YXRzID0gc3RhdHM7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHRoaXMudGFncyA9IHRhZ3M7XG4gICAgfVxuXG4gICAgcmVwb3J0KHZhbHVlOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5zdGF0cy50aW1pbmcodGhpcy5uYW1lLCB2YWx1ZSwgdGhpcy50YWdzKTtcbiAgICB9XG5cbiAgICBzdGFydCgpOiAoKSA9PiB2b2lkIHtcbiAgICAgICAgY29uc3Qgc3RhcnQgPSBEYXRlLm5vdygpO1xuICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZXBvcnQoRGF0ZS5ub3coKSAtIHN0YXJ0KTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VVcmwodXJsOiBzdHJpbmcpOiB7XG4gICAgcHJvdG9jb2w6IHN0cmluZyxcbiAgICBob3N0OiBzdHJpbmcsXG4gICAgcG9ydDogc3RyaW5nLFxuICAgIHBhdGg6IHN0cmluZyxcbiAgICBxdWVyeTogc3RyaW5nLFxufSB7XG4gICAgY29uc3QgcHJvdG9jb2xTZXBhcmF0b3JQb3MgPSB1cmwuaW5kZXhPZignOi8vJyk7XG4gICAgY29uc3QgcHJvdG9jb2xFbmQgPSBwcm90b2NvbFNlcGFyYXRvclBvcyA+PSAwID8gcHJvdG9jb2xTZXBhcmF0b3JQb3MgKyAzIDogMDtcbiAgICBjb25zdCBxdWVzdGlvblBvcyA9IHVybC5pbmRleE9mKCc/JywgcHJvdG9jb2xFbmQpO1xuICAgIGNvbnN0IHF1ZXJ5U3RhcnQgPSBxdWVzdGlvblBvcyA+PSAwID8gcXVlc3Rpb25Qb3MgKyAxIDogdXJsLmxlbmd0aDtcbiAgICBjb25zdCBwYXRoRW5kID0gcXVlc3Rpb25Qb3MgPj0gMCA/IHF1ZXN0aW9uUG9zIDogdXJsLmxlbmd0aDtcbiAgICBjb25zdCBwYXRoU2VwYXJhdG9yUG9zID0gdXJsLmluZGV4T2YoJy8nLCBwcm90b2NvbEVuZCk7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLW5lc3RlZC10ZXJuYXJ5XG4gICAgY29uc3QgcGF0aFN0YXJ0ID0gcGF0aFNlcGFyYXRvclBvcyA+PSAwXG4gICAgICAgID8gKHBhdGhTZXBhcmF0b3JQb3MgPCBwYXRoRW5kID8gcGF0aFNlcGFyYXRvclBvcyA6IHBhdGhFbmQpXG4gICAgICAgIDogKHF1ZXN0aW9uUG9zID49IDAgPyBxdWVzdGlvblBvcyA6IHVybC5sZW5ndGgpO1xuICAgIGNvbnN0IGhvc3RQb3J0ID0gdXJsLnN1YnN0cmluZyhwcm90b2NvbEVuZCwgcGF0aFN0YXJ0KS5zcGxpdCgnOicpO1xuICAgIHJldHVybiB7XG4gICAgICAgIHByb3RvY29sOiB1cmwuc3Vic3RyaW5nKDAsIHByb3RvY29sRW5kKSxcbiAgICAgICAgaG9zdDogaG9zdFBvcnRbMF0sXG4gICAgICAgIHBvcnQ6IGhvc3RQb3J0WzFdIHx8ICcnLFxuICAgICAgICBwYXRoOiB1cmwuc3Vic3RyaW5nKHBhdGhTdGFydCwgcGF0aEVuZCksXG4gICAgICAgIHF1ZXJ5OiB1cmwuc3Vic3RyaW5nKHF1ZXJ5U3RhcnQpLFxuICAgIH07XG59XG5cbnR5cGUgSmFlZ2VyQ29uZmlnID0ge1xuICAgIHNlcnZpY2VOYW1lOiBzdHJpbmcsXG4gICAgZGlzYWJsZT86IGJvb2xlYW4sXG4gICAgc2FtcGxlcjoge1xuICAgICAgICB0eXBlOiBzdHJpbmcsXG4gICAgICAgIHBhcmFtOiBudW1iZXIsXG4gICAgICAgIGhvc3RQb3J0Pzogc3RyaW5nLFxuICAgICAgICBob3N0Pzogc3RyaW5nLFxuICAgICAgICBwb3J0PzogbnVtYmVyLFxuICAgICAgICByZWZyZXNoSW50ZXJ2YWxNcz86IG51bWJlcixcbiAgICB9LFxuICAgIHJlcG9ydGVyOiB7XG4gICAgICAgIGxvZ1NwYW5zOiBib29sZWFuLFxuICAgICAgICBhZ2VudEhvc3Q/OiBzdHJpbmcsXG4gICAgICAgIGFnZW50UG9ydD86IG51bWJlcixcbiAgICAgICAgYWdlbnRTb2NrZXRUeXBlPzogc3RyaW5nLFxuICAgICAgICBjb2xsZWN0b3JFbmRwb2ludD86IHN0cmluZyxcbiAgICAgICAgdXNlcm5hbWU/OiBzdHJpbmcsXG4gICAgICAgIHBhc3N3b3JkPzogc3RyaW5nLFxuICAgICAgICBmbHVzaEludGVydmFsTXM/OiBudW1iZXIsXG4gICAgfSxcbiAgICB0aHJvdHRsZXI/OiB7XG4gICAgICAgIGhvc3Q6IHN0cmluZyxcbiAgICAgICAgcG9ydDogbnVtYmVyLFxuICAgICAgICByZWZyZXNoSW50ZXJ2YWxNczogbnVtYmVyLFxuICAgIH0sXG59XG5cbmV4cG9ydCBjbGFzcyBRVHJhY2VyIHtcbiAgICBzdGF0aWMgY29uZmlnOiBRQ29uZmlnO1xuXG4gICAgc3RhdGljIGdldEphZWdlckNvbmZpZyhjb25maWc6IHtcbiAgICAgICAgZW5kcG9pbnQ6IHN0cmluZyxcbiAgICAgICAgc2VydmljZTogc3RyaW5nLFxuICAgICAgICB0YWdzOiB7IFtzdHJpbmddOiBzdHJpbmcgfVxuICAgIH0pOiA/SmFlZ2VyQ29uZmlnIHtcbiAgICAgICAgY29uc3QgZW5kcG9pbnQgPSBjb25maWcuZW5kcG9pbnQ7XG4gICAgICAgIGlmICghZW5kcG9pbnQpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBhcnRzID0gcGFyc2VVcmwoZW5kcG9pbnQpO1xuICAgICAgICByZXR1cm4gKHBhcnRzLnByb3RvY29sID09PSAnJylcbiAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgIHNlcnZpY2VOYW1lOiBjb25maWcuc2VydmljZSxcbiAgICAgICAgICAgICAgICBzYW1wbGVyOiB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdjb25zdCcsXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtOiAxLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcmVwb3J0ZXI6IHtcbiAgICAgICAgICAgICAgICAgICAgbG9nU3BhbnM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGFnZW50SG9zdDogcGFydHMuaG9zdCxcbiAgICAgICAgICAgICAgICAgICAgYWdlbnRQb3J0OiBOdW1iZXIocGFydHMucG9ydClcbiAgICAgICAgICAgICAgICAgICAgLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICA6IHtcbiAgICAgICAgICAgICAgICBzZXJ2aWNlTmFtZTogY29uZmlnLnNlcnZpY2UsXG4gICAgICAgICAgICAgICAgc2FtcGxlcjoge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnY29uc3QnLFxuICAgICAgICAgICAgICAgICAgICBwYXJhbTogMSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHJlcG9ydGVyOiB7XG4gICAgICAgICAgICAgICAgICAgIGxvZ1NwYW5zOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBjb2xsZWN0b3JFbmRwb2ludDogZW5kcG9pbnQsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH07XG4gICAgfVxuXG4gICAgc3RhdGljIGNyZWF0ZShjb25maWc6IFFDb25maWcpOiBUcmFjZXIge1xuICAgICAgICBRVHJhY2VyLmNvbmZpZyA9IGNvbmZpZztcbiAgICAgICAgY29uc3QgamFlZ2VyQ29uZmlnID0gUVRyYWNlci5nZXRKYWVnZXJDb25maWcoY29uZmlnLmphZWdlcik7XG4gICAgICAgIGlmICghamFlZ2VyQ29uZmlnKSB7XG4gICAgICAgICAgICByZXR1cm4gbm9vcFRyYWNlcjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaW5pdEphZWdlclRyYWNlcihqYWVnZXJDb25maWcsIHtcbiAgICAgICAgICAgIGxvZ2dlcjoge1xuICAgICAgICAgICAgICAgIGluZm8obXNnKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdJTkZPICcsIG1zZyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBlcnJvcihtc2cpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VSUk9SJywgbXNnKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGV4dHJhY3RQYXJlbnRTcGFuKHRyYWNlcjogVHJhY2VyLCByZXE6IGFueSk6IGFueSB7XG4gICAgICAgIGxldCBjdHhfc3JjLFxuICAgICAgICAgICAgY3R4X2ZybTtcbiAgICAgICAgaWYgKHJlcS5oZWFkZXJzKSB7XG4gICAgICAgICAgICBjdHhfc3JjID0gcmVxLmhlYWRlcnM7XG4gICAgICAgICAgICBjdHhfZnJtID0gRk9STUFUX1RFWFRfTUFQO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY3R4X3NyYyA9IHJlcS5jb250ZXh0O1xuICAgICAgICAgICAgY3R4X2ZybSA9IEZPUk1BVF9CSU5BUlk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRyYWNlci5leHRyYWN0KGN0eF9mcm0sIGN0eF9zcmMpO1xuICAgIH1cblxuICAgIHN0YXRpYyBnZXRQYXJlbnRTcGFuKHRyYWNlcjogVHJhY2VyLCBjb250ZXh0OiBhbnkpOiAoU3BhbkNvbnRleHQgfCB0eXBlb2YgdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiBjb250ZXh0LnRyYWNlclBhcmVudFNwYW47XG4gICAgfVxuXG4gICAgc3RhdGljIGZhaWxlZCh0cmFjZXI6IFRyYWNlciwgc3BhbjogU3BhbiwgZXJyb3I6IGFueSkge1xuICAgICAgICBzcGFuLmxvZyh7XG4gICAgICAgICAgICBldmVudDogJ2ZhaWxlZCcsXG4gICAgICAgICAgICBwYXlsb2FkOiB0b0xvZyhlcnJvciksXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyB0cmFjZTxUPihcbiAgICAgICAgdHJhY2VyOiBUcmFjZXIsXG4gICAgICAgIG5hbWU6IHN0cmluZyxcbiAgICAgICAgZjogKHNwYW46IFNwYW4pID0+IFByb21pc2U8VD4sXG4gICAgICAgIHBhcmVudFNwYW4/OiAoU3BhbiB8IFNwYW5Db250ZXh0KSxcbiAgICApOiBQcm9taXNlPFQ+IHtcbiAgICAgICAgY29uc3Qgc3BhbiA9IHRyYWNlci5zdGFydFNwYW4obmFtZSwgeyBjaGlsZE9mOiBwYXJlbnRTcGFuIH0pO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgc3Bhbi5zZXRUYWcoVGFncy5TUEFOX0tJTkQsICdzZXJ2ZXInKTtcbiAgICAgICAgICAgIE9iamVjdC5lbnRyaWVzKFFUcmFjZXIuY29uZmlnLmphZWdlci50YWdzKS5mb3JFYWNoKChbbmFtZSwgdmFsdWVdKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKG5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgc3Bhbi5zZXRUYWcobmFtZSwgdmFsdWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZihzcGFuKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHNwYW4uc2V0VGFnKCdyZXN1bHQnLCB0b0xvZyhyZXN1bHQpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNwYW4uZmluaXNoKCk7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc3QgY2xlYW5lZCA9IGNsZWFuRXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgUVRyYWNlci5mYWlsZWQodHJhY2VyLCBzcGFuLCBjbGVhbmVkKTtcbiAgICAgICAgICAgIHNwYW4uZmluaXNoKCk7XG4gICAgICAgICAgICB0aHJvdyBjbGVhbmVkO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19