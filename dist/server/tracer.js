"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.QTracer = exports.StatsTiming = exports.StatsGauge = exports.StatsCounter = exports.QStats = void 0;

var _config = require("./config");

var _noop = require("opentracing/lib/noop");

var _nodeStatsd = _interopRequireDefault(require("node-statsd"));

var _opentracing = require("opentracing");

var _jaegerClient = require("jaeger-client");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function logStatsError(error) {
  console.log(`StatsD send failed: ${error.message}`);
}

const dummyStats = {
  configuredTags: [],

  increment(_stat, _value, _tags) {
    return Promise.resolve();
  },

  gauge(_stat, _value, _tags) {
    return Promise.resolve();
  },

  timing(_stat, _value, _tags) {
    return Promise.resolve();
  },

  close() {}

};

class QStats {
  static create(server, configuredTags, resetInterval) {
    return server ? new QStats(server, configuredTags, resetInterval) : dummyStats;
  }

  constructor(server, configuredTags, resetInterval) {
    const hostPort = server.split(':');
    this.host = hostPort[0];
    this.port = hostPort[1];
    this.configuredTags = configuredTags;
    this.resetInterval = resetInterval;
    this.impl = null;
    this.resetTime = resetInterval > 0 ? Date.now() + resetInterval : 0;
  }

  ensureImpl() {
    const impl = this.impl;

    if (impl) {
      return impl;
    }

    const newImpl = new _nodeStatsd.default(this.host, this.port, _config.STATS.prefix);
    newImpl.socket.on("error", err => {
      logStatsError(err);
      this.dropImpl();
    });
    this.impl = newImpl;
    return newImpl;
  }

  dropImpl(error) {
    if (error) {
      logStatsError(error);
    }

    if (this.impl) {
      this.impl.close();
      this.impl = null;
    }
  }

  withImpl(f) {
    return new Promise((resolve, _) => {
      try {
        if (this.resetTime > 0) {
          const now = Date.now();

          if (now > this.resetTime) {
            this.dropImpl();
            this.resetTime = now + this.resetInterval;
          }
        }

        f(this.ensureImpl(), (error, _) => {
          if (error) {
            this.dropImpl(error);
          }

          resolve();
        });
      } catch (error) {
        this.dropImpl(error);
        resolve();
      }
    });
  }

  increment(stat, value, tags) {
    return this.withImpl((stats, callback) => stats.increment(stat, value, tags, callback));
  }

  gauge(stat, value, tags) {
    return this.withImpl((stats, callback) => stats.gauge(stat, value, tags, callback));
  }

  timing(stat, value, tags) {
    return this.withImpl((stats, callback) => stats.timing(stat, value, tags, callback));
  }

  close() {
    this.dropImpl();
  }

  static combineTags(stats, tags) {
    return stats && stats.configuredTags && stats.configuredTags.length > 0 ? stats.configuredTags.concat(tags) : tags;
  }

}

exports.QStats = QStats;

class StatsCounter {
  constructor(stats, name, tags) {
    this.stats = stats;
    this.name = name;
    this.tags = QStats.combineTags(stats, tags);
  }

  increment() {
    return this.stats.increment(this.name, 1, this.tags);
  }

}

exports.StatsCounter = StatsCounter;

class StatsGauge {
  constructor(stats, name, tags) {
    this.stats = stats;
    this.name = name;
    this.tags = QStats.combineTags(stats, tags);
    this.value = 0;
  }

  set(value) {
    this.value = value;
    return this.stats.gauge(this.name, this.value, this.tags);
  }

  increment(delta = 1) {
    return this.set(this.value + delta);
  }

  decrement(delta = 1) {
    return this.set(this.value - delta);
  }

}

exports.StatsGauge = StatsGauge;

class StatsTiming {
  constructor(stats, name, tags) {
    this.stats = stats;
    this.name = name;
    this.tags = QStats.combineTags(stats, tags);
  }

  report(value) {
    return this.stats.timing(this.name, value, this.tags);
  }

  start() {
    const start = Date.now();
    return () => {
      return this.report(Date.now() - start);
    };
  }

}

exports.StatsTiming = StatsTiming;

function parseUrl(url) {
  const protocolSeparatorPos = url.indexOf('://');
  const protocolEnd = protocolSeparatorPos >= 0 ? protocolSeparatorPos + 3 : 0;
  const questionPos = url.indexOf('?', protocolEnd);
  const queryStart = questionPos >= 0 ? questionPos + 1 : url.length;
  const pathEnd = questionPos >= 0 ? questionPos : url.length;
  const pathSeparatorPos = url.indexOf('/', protocolEnd); // eslint-disable-next-line no-nested-ternary

  const pathStart = pathSeparatorPos >= 0 ? pathSeparatorPos < pathEnd ? pathSeparatorPos : pathEnd : questionPos >= 0 ? questionPos : url.length;
  const hostPort = url.substring(protocolEnd, pathStart).split(':');
  return {
    protocol: url.substring(0, protocolEnd),
    host: hostPort[0],
    port: hostPort[1] || '',
    path: url.substring(pathStart, pathEnd),
    query: url.substring(queryStart)
  };
}

class QTracer {
  static getJaegerConfig(config) {
    const endpoint = config.endpoint;

    if (!endpoint) {
      return null;
    }

    const parts = parseUrl(endpoint);
    return parts.protocol === '' ? {
      serviceName: config.service,
      sampler: {
        type: 'const',
        param: 1
      },
      reporter: {
        logSpans: true,
        agentHost: parts.host,
        agentPort: Number(parts.port)
      }
    } : {
      serviceName: config.service,
      sampler: {
        type: 'const',
        param: 1
      },
      reporter: {
        logSpans: true,
        collectorEndpoint: endpoint
      }
    };
  }

  static create(config) {
    QTracer.config = config;
    const jaegerConfig = QTracer.getJaegerConfig(config.jaeger);

    if (!jaegerConfig) {
      return _noop.tracer;
    }

    return (0, _jaegerClient.initTracerFromEnv)(jaegerConfig, {
      logger: {
        info(msg) {
          console.log('INFO ', msg);
        },

        error(msg) {
          console.log('ERROR', msg);
        }

      }
    });
  }

  static messageRootSpanContext(messageId) {
    if (!messageId) {
      return null;
    }

    const traceId = messageId.substr(0, 16);
    const spanId = messageId.substr(16, 16);
    return _jaegerClient.SpanContext.fromString(`${traceId}:${spanId}:0:1`);
  }

  static extractParentSpan(tracer, req) {
    let ctx_src, ctx_frm;

    if (req.headers) {
      ctx_src = req.headers;
      ctx_frm = _opentracing.FORMAT_TEXT_MAP;
    } else {
      ctx_src = req.context;
      ctx_frm = _opentracing.FORMAT_BINARY;
    }

    return tracer.extract(ctx_frm, ctx_src);
  }

  static getParentSpan(tracer, context) {
    return context.tracerParentSpan;
  }

  static failed(tracer, span, error) {
    span.log({
      event: 'failed',
      payload: (0, _utils.toLog)(error)
    });
  }

  static async trace(tracer, name, f, parentSpan) {
    const span = tracer.startSpan(name, {
      childOf: parentSpan
    });

    try {
      span.setTag(_opentracing.Tags.SPAN_KIND, 'server');
      Object.entries(QTracer.config.jaeger.tags).forEach(([name, value]) => {
        if (name) {
          span.setTag(name, value);
        }
      });
      const result = await f(span);

      if (result !== undefined) {
        span.setTag('result', (0, _utils.toLog)(result));
      }

      span.finish();
      return result;
    } catch (error) {
      const cleaned = (0, _utils.cleanError)(error);
      QTracer.failed(tracer, span, cleaned);
      span.finish();
      throw cleaned;
    }
  }

}

exports.QTracer = QTracer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvdHJhY2VyLmpzIl0sIm5hbWVzIjpbImxvZ1N0YXRzRXJyb3IiLCJlcnJvciIsImNvbnNvbGUiLCJsb2ciLCJtZXNzYWdlIiwiZHVtbXlTdGF0cyIsImNvbmZpZ3VyZWRUYWdzIiwiaW5jcmVtZW50IiwiX3N0YXQiLCJfdmFsdWUiLCJfdGFncyIsIlByb21pc2UiLCJyZXNvbHZlIiwiZ2F1Z2UiLCJ0aW1pbmciLCJjbG9zZSIsIlFTdGF0cyIsImNyZWF0ZSIsInNlcnZlciIsInJlc2V0SW50ZXJ2YWwiLCJjb25zdHJ1Y3RvciIsImhvc3RQb3J0Iiwic3BsaXQiLCJob3N0IiwicG9ydCIsImltcGwiLCJyZXNldFRpbWUiLCJEYXRlIiwibm93IiwiZW5zdXJlSW1wbCIsIm5ld0ltcGwiLCJTdGF0c0QiLCJTVEFUUyIsInByZWZpeCIsInNvY2tldCIsIm9uIiwiZXJyIiwiZHJvcEltcGwiLCJ3aXRoSW1wbCIsImYiLCJfIiwic3RhdCIsInZhbHVlIiwidGFncyIsInN0YXRzIiwiY2FsbGJhY2siLCJjb21iaW5lVGFncyIsImxlbmd0aCIsImNvbmNhdCIsIlN0YXRzQ291bnRlciIsIm5hbWUiLCJTdGF0c0dhdWdlIiwic2V0IiwiZGVsdGEiLCJkZWNyZW1lbnQiLCJTdGF0c1RpbWluZyIsInJlcG9ydCIsInN0YXJ0IiwicGFyc2VVcmwiLCJ1cmwiLCJwcm90b2NvbFNlcGFyYXRvclBvcyIsImluZGV4T2YiLCJwcm90b2NvbEVuZCIsInF1ZXN0aW9uUG9zIiwicXVlcnlTdGFydCIsInBhdGhFbmQiLCJwYXRoU2VwYXJhdG9yUG9zIiwicGF0aFN0YXJ0Iiwic3Vic3RyaW5nIiwicHJvdG9jb2wiLCJwYXRoIiwicXVlcnkiLCJRVHJhY2VyIiwiZ2V0SmFlZ2VyQ29uZmlnIiwiY29uZmlnIiwiZW5kcG9pbnQiLCJwYXJ0cyIsInNlcnZpY2VOYW1lIiwic2VydmljZSIsInNhbXBsZXIiLCJ0eXBlIiwicGFyYW0iLCJyZXBvcnRlciIsImxvZ1NwYW5zIiwiYWdlbnRIb3N0IiwiYWdlbnRQb3J0IiwiTnVtYmVyIiwiY29sbGVjdG9yRW5kcG9pbnQiLCJqYWVnZXJDb25maWciLCJqYWVnZXIiLCJub29wVHJhY2VyIiwibG9nZ2VyIiwiaW5mbyIsIm1zZyIsIm1lc3NhZ2VSb290U3BhbkNvbnRleHQiLCJtZXNzYWdlSWQiLCJ0cmFjZUlkIiwic3Vic3RyIiwic3BhbklkIiwiSmFlZ2VyU3BhbkNvbnRleHQiLCJmcm9tU3RyaW5nIiwiZXh0cmFjdFBhcmVudFNwYW4iLCJ0cmFjZXIiLCJyZXEiLCJjdHhfc3JjIiwiY3R4X2ZybSIsImhlYWRlcnMiLCJGT1JNQVRfVEVYVF9NQVAiLCJjb250ZXh0IiwiRk9STUFUX0JJTkFSWSIsImV4dHJhY3QiLCJnZXRQYXJlbnRTcGFuIiwidHJhY2VyUGFyZW50U3BhbiIsImZhaWxlZCIsInNwYW4iLCJldmVudCIsInBheWxvYWQiLCJ0cmFjZSIsInBhcmVudFNwYW4iLCJzdGFydFNwYW4iLCJjaGlsZE9mIiwic2V0VGFnIiwiVGFncyIsIlNQQU5fS0lORCIsIk9iamVjdCIsImVudHJpZXMiLCJmb3JFYWNoIiwicmVzdWx0IiwidW5kZWZpbmVkIiwiZmluaXNoIiwiY2xlYW5lZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUVBOztBQUVBOztBQUNBOztBQUNBOztBQUVBOztBQUlBOzs7O0FBMEJBLFNBQVNBLGFBQVQsQ0FBdUJDLEtBQXZCLEVBQW1DO0FBQy9CQyxFQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBYSx1QkFBc0JGLEtBQUssQ0FBQ0csT0FBUSxFQUFqRDtBQUNIOztBQUVELE1BQU1DLFVBQWtCLEdBQUc7QUFDdkJDLEVBQUFBLGNBQWMsRUFBRSxFQURPOztBQUV2QkMsRUFBQUEsU0FBUyxDQUFDQyxLQUFELEVBQWdCQyxNQUFoQixFQUFnQ0MsS0FBaEMsRUFBK0Q7QUFDcEUsV0FBT0MsT0FBTyxDQUFDQyxPQUFSLEVBQVA7QUFDSCxHQUpzQjs7QUFLdkJDLEVBQUFBLEtBQUssQ0FBQ0wsS0FBRCxFQUFn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aEI7QUFDQXVFLE1BQUFBLE9BQU8sQ0FBQ3lDLE1BQVIsQ0FBZVgsTUFBZixFQUF1QlksSUFBdkIsRUFBNkJnQixPQUE3QjtBQUNBaEIsTUFBQUEsSUFBSSxDQUFDZSxNQUFMO0FBQ0EsWUFBTUMsT0FBTjtBQUNIO0FBQ0o7O0FBckhnQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB7IFNUQVRTIH0gZnJvbSAnLi9jb25maWcnO1xuaW1wb3J0IHR5cGUgeyBRQ29uZmlnIH0gZnJvbSBcIi4vY29uZmlnXCI7XG5pbXBvcnQgeyB0cmFjZXIgYXMgbm9vcFRyYWNlciB9IGZyb20gXCJvcGVudHJhY2luZy9saWIvbm9vcFwiO1xuaW1wb3J0IFN0YXRzRCBmcm9tICdub2RlLXN0YXRzZCc7XG5pbXBvcnQgeyBUcmFjZXIsIFRhZ3MsIEZPUk1BVF9URVhUX01BUCwgRk9STUFUX0JJTkFSWSwgU3BhbiwgU3BhbkNvbnRleHQgfSBmcm9tIFwib3BlbnRyYWNpbmdcIjtcblxuaW1wb3J0IHtcbiAgICBpbml0VHJhY2VyRnJvbUVudiBhcyBpbml0SmFlZ2VyVHJhY2VyLFxuICAgIFNwYW5Db250ZXh0IGFzIEphZWdlclNwYW5Db250ZXh0LFxufSBmcm9tICdqYWVnZXItY2xpZW50JztcbmltcG9ydCB7IGNsZWFuRXJyb3IsIHRvTG9nIH0gZnJvbSBcIi4vdXRpbHNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBJU3RhdHMge1xuICAgIGNvbmZpZ3VyZWRUYWdzOiBzdHJpbmdbXSxcblxuICAgIGluY3JlbWVudChzdGF0OiBzdHJpbmcsIHZhbHVlOiBudW1iZXIsIHRhZ3M6IHN0cmluZ1tdKTogUHJvbWlzZTx2b2lkPixcblxuICAgIGdhdWdlKHN0YXQ6IHN0cmluZywgdmFsdWU6IG51bWJlciwgdGFnczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+LFxuXG4gICAgdGltaW5nKHN0YXQ6IHN0cmluZywgdmFsdWU6IG51bWJlciwgdGFnczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+LFxuXG4gICAgY2xvc2UoKTogdm9pZCxcbn1cblxudHlwZSBTdGF0c0NhbGxiYWNrID0gKGVycm9yOiBhbnksIGJ5dGVzOiBhbnkpID0+IHZvaWQ7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVN0YXRzSW1wbCB7XG4gICAgaW5jcmVtZW50KHN0YXQ6IHN0cmluZywgdmFsdWU6IG51bWJlciwgdGFnczogc3RyaW5nW10sIGNhbGxiYWNrOiBTdGF0c0NhbGxiYWNrKTogdm9pZCxcblxuICAgIGdhdWdlKHN0YXQ6IHN0cmluZywgdmFsdWU6IG51bWJlciwgdGFnczogc3RyaW5nW10sIGNhbGxiYWNrOiBTdGF0c0NhbGxiYWNrKTogdm9pZCxcblxuICAgIHRpbWluZyhzdGF0OiBzdHJpbmcsIHZhbHVlOiBudW1iZXIsIHRhZ3M6IHN0cmluZ1tdLCBjYWxsYmFjazogU3RhdHNDYWxsYmFjayk6IHZvaWQsXG5cbiAgICBjbG9zZSgpOiB2b2lkLFxufVxuXG5mdW5jdGlvbiBsb2dTdGF0c0Vycm9yKGVycm9yOiBhbnkpIHtcbiAgICBjb25zb2xlLmxvZyhgU3RhdHNEIHNlbmQgZmFpbGVkOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG59XG5cbmNvbnN0IGR1bW15U3RhdHM6IElTdGF0cyA9IHtcbiAgICBjb25maWd1cmVkVGFnczogW10sXG4gICAgaW5jcmVtZW50KF9zdGF0OiBzdHJpbmcsIF92YWx1ZTogbnVtYmVyLCBfdGFnczogc3RyaW5nW10pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfSxcbiAgICBnYXVnZShfc3RhdDogc3RyaW5nLCBfdmFsdWU6IG51bWJlciwgX3RhZ3M6IHN0cmluZ1tdKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH0sXG4gICAgdGltaW5nKF9zdGF0OiBzdHJpbmcsIF92YWx1ZTogbnVtYmVyLCBfdGFnczogc3RyaW5nW10pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfSxcbiAgICBjbG9zZSgpIHtcbiAgICB9XG59O1xuXG5leHBvcnQgY2xhc3MgUVN0YXRzIHtcbiAgICBzdGF0aWMgY3JlYXRlKFxuICAgICAgICBzZXJ2ZXI6IHN0cmluZyxcbiAgICAgICAgY29uZmlndXJlZFRhZ3M6IHN0cmluZ1tdLFxuICAgICAgICByZXNldEludGVydmFsOiBudW1iZXIsXG4gICAgKTogSVN0YXRzIHtcbiAgICAgICAgcmV0dXJuIHNlcnZlciA/IG5ldyBRU3RhdHMoc2VydmVyLCBjb25maWd1cmVkVGFncywgcmVzZXRJbnRlcnZhbCkgOiBkdW1teVN0YXRzO1xuICAgIH1cblxuICAgIGhvc3Q6IHN0cmluZztcbiAgICBwb3J0OiBzdHJpbmcgfCB0eXBlb2YgdW5kZWZpbmVkO1xuICAgIGltcGw6ID9JU3RhdHNJbXBsO1xuICAgIHJlc2V0SW50ZXJ2YWw6IG51bWJlcjtcbiAgICByZXNldFRpbWU6IG51bWJlcjtcbiAgICBjb25maWd1cmVkVGFnczogc3RyaW5nW107XG5cbiAgICBjb25zdHJ1Y3RvcihzZXJ2ZXI6IHN0cmluZywgY29uZmlndXJlZFRhZ3M6IHN0cmluZ1tdLCByZXNldEludGVydmFsOiBudW1iZXIpIHtcbiAgICAgICAgY29uc3QgaG9zdFBvcnQgPSBzZXJ2ZXIuc3BsaXQoJzonKTtcbiAgICAgICAgdGhpcy5ob3N0ID0gaG9zdFBvcnRbMF07XG4gICAgICAgIHRoaXMucG9ydCA9IGhvc3RQb3J0WzFdO1xuICAgICAgICB0aGlzLmNvbmZpZ3VyZWRUYWdzID0gY29uZmlndXJlZFRhZ3M7XG4gICAgICAgIHRoaXMucmVzZXRJbnRlcnZhbCA9IHJlc2V0SW50ZXJ2YWw7XG5cbiAgICAgICAgdGhpcy5pbXBsID0gbnVsbDtcbiAgICAgICAgdGhpcy5yZXNldFRpbWUgPSByZXNldEludGVydmFsID4gMCA/IERhdGUubm93KCkgKyByZXNldEludGVydmFsIDogMDtcbiAgICB9XG5cbiAgICBlbnN1cmVJbXBsKCkge1xuICAgICAgICBjb25zdCBpbXBsID0gdGhpcy5pbXBsO1xuICAgICAgICBpZiAoaW1wbCkge1xuICAgICAgICAgICAgcmV0dXJuIGltcGw7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbmV3SW1wbCA9IG5ldyBTdGF0c0QodGhpcy5ob3N0LCB0aGlzLnBvcnQsIFNUQVRTLnByZWZpeCk7XG4gICAgICAgIG5ld0ltcGwuc29ja2V0Lm9uKFwiZXJyb3JcIiwgKGVycikgPT4ge1xuICAgICAgICAgICAgbG9nU3RhdHNFcnJvcihlcnIpO1xuICAgICAgICAgICAgdGhpcy5kcm9wSW1wbCgpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5pbXBsID0gbmV3SW1wbDtcbiAgICAgICAgcmV0dXJuIG5ld0ltcGw7XG4gICAgfVxuXG4gICAgZHJvcEltcGwoZXJyb3I/OiBFcnJvcikge1xuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgIGxvZ1N0YXRzRXJyb3IoZXJyb3IpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmltcGwpIHtcbiAgICAgICAgICAgIHRoaXMuaW1wbC5jbG9zZSgpO1xuICAgICAgICAgICAgdGhpcy5pbXBsID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHdpdGhJbXBsKGY6IChpbXBsOiBJU3RhdHNJbXBsLCBjYWxsYmFjazogYW55KSA9PiB2b2lkKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgXykgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5yZXNldFRpbWUgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChub3cgPiB0aGlzLnJlc2V0VGltZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wSW1wbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNldFRpbWUgPSBub3cgKyB0aGlzLnJlc2V0SW50ZXJ2YWw7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZih0aGlzLmVuc3VyZUltcGwoKSwgKGVycm9yLCBfKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wSW1wbChlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRyb3BJbXBsKGVycm9yKTtcbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBpbmNyZW1lbnQoc3RhdDogc3RyaW5nLCB2YWx1ZTogbnVtYmVyLCB0YWdzOiBzdHJpbmdbXSk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy53aXRoSW1wbCgoc3RhdHMsIGNhbGxiYWNrKSA9PiBzdGF0cy5pbmNyZW1lbnQoc3RhdCwgdmFsdWUsIHRhZ3MsIGNhbGxiYWNrKSk7XG4gICAgfVxuXG4gICAgZ2F1Z2Uoc3RhdDogc3RyaW5nLCB2YWx1ZTogbnVtYmVyLCB0YWdzOiBzdHJpbmdbXSk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy53aXRoSW1wbCgoc3RhdHMsIGNhbGxiYWNrKSA9PiBzdGF0cy5nYXVnZShzdGF0LCB2YWx1ZSwgdGFncywgY2FsbGJhY2spKTtcbiAgICB9XG5cbiAgICB0aW1pbmcoc3RhdDogc3RyaW5nLCB2YWx1ZTogbnVtYmVyLCB0YWdzOiBzdHJpbmdbXSk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy53aXRoSW1wbCgoc3RhdHMsIGNhbGxiYWNrKSA9PiBzdGF0cy50aW1pbmcoc3RhdCwgdmFsdWUsIHRhZ3MsIGNhbGxiYWNrKSk7XG4gICAgfVxuXG4gICAgY2xvc2UoKSB7XG4gICAgICAgIHRoaXMuZHJvcEltcGwoKTtcbiAgICB9XG5cblxuICAgIHN0YXRpYyBjb21iaW5lVGFncyhzdGF0czogSVN0YXRzLCB0YWdzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcbiAgICAgICAgcmV0dXJuIChzdGF0cyAmJiBzdGF0cy5jb25maWd1cmVkVGFncyAmJiBzdGF0cy5jb25maWd1cmVkVGFncy5sZW5ndGggPiAwKVxuICAgICAgICAgICAgPyBzdGF0cy5jb25maWd1cmVkVGFncy5jb25jYXQodGFncylcbiAgICAgICAgICAgIDogdGFncztcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBTdGF0c0NvdW50ZXIge1xuICAgIHN0YXRzOiBJU3RhdHM7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIHRhZ3M6IHN0cmluZ1tdO1xuXG4gICAgY29uc3RydWN0b3Ioc3RhdHM6IElTdGF0cywgbmFtZTogc3RyaW5nLCB0YWdzOiBzdHJpbmdbXSkge1xuICAgICAgICB0aGlzLnN0YXRzID0gc3RhdHM7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHRoaXMudGFncyA9IFFTdGF0cy5jb21iaW5lVGFncyhzdGF0cywgdGFncyk7XG4gICAgfVxuXG4gICAgaW5jcmVtZW50KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0cy5pbmNyZW1lbnQodGhpcy5uYW1lLCAxLCB0aGlzLnRhZ3MpO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFN0YXRzR2F1Z2Uge1xuICAgIHN0YXRzOiBJU3RhdHM7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIHRhZ3M6IHN0cmluZ1tdO1xuICAgIHZhbHVlOiBudW1iZXI7XG5cbiAgICBjb25zdHJ1Y3RvcihzdGF0czogSVN0YXRzLCBuYW1lOiBzdHJpbmcsIHRhZ3M6IHN0cmluZ1tdKSB7XG4gICAgICAgIHRoaXMuc3RhdHMgPSBzdGF0cztcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgdGhpcy50YWdzID0gUVN0YXRzLmNvbWJpbmVUYWdzKHN0YXRzLCB0YWdzKTtcbiAgICAgICAgdGhpcy52YWx1ZSA9IDA7XG4gICAgfVxuXG4gICAgc2V0KHZhbHVlOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlO1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0cy5nYXVnZSh0aGlzLm5hbWUsIHRoaXMudmFsdWUsIHRoaXMudGFncyk7XG4gICAgfVxuXG4gICAgaW5jcmVtZW50KGRlbHRhOiBudW1iZXIgPSAxKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNldCh0aGlzLnZhbHVlICsgZGVsdGEpO1xuICAgIH1cblxuICAgIGRlY3JlbWVudChkZWx0YTogbnVtYmVyID0gMSkge1xuICAgICAgICByZXR1cm4gdGhpcy5zZXQodGhpcy52YWx1ZSAtIGRlbHRhKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBTdGF0c1RpbWluZyB7XG4gICAgc3RhdHM6IElTdGF0cztcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgdGFnczogc3RyaW5nW107XG5cbiAgICBjb25zdHJ1Y3RvcihzdGF0czogSVN0YXRzLCBuYW1lOiBzdHJpbmcsIHRhZ3M6IHN0cmluZ1tdKSB7XG4gICAgICAgIHRoaXMuc3RhdHMgPSBzdGF0cztcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgdGhpcy50YWdzID0gUVN0YXRzLmNvbWJpbmVUYWdzKHN0YXRzLCB0YWdzKTtcbiAgICB9XG5cbiAgICByZXBvcnQodmFsdWU6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0cy50aW1pbmcodGhpcy5uYW1lLCB2YWx1ZSwgdGhpcy50YWdzKTtcbiAgICB9XG5cbiAgICBzdGFydCgpOiAoKSA9PiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3Qgc3RhcnQgPSBEYXRlLm5vdygpO1xuICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVwb3J0KERhdGUubm93KCkgLSBzdGFydCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmZ1bmN0aW9uIHBhcnNlVXJsKHVybDogc3RyaW5nKToge1xuICAgIHByb3RvY29sOiBzdHJpbmcsXG4gICAgaG9zdDogc3RyaW5nLFxuICAgIHBvcnQ6IHN0cmluZyxcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgcXVlcnk6IHN0cmluZyxcbn0ge1xuICAgIGNvbnN0IHByb3RvY29sU2VwYXJhdG9yUG9zID0gdXJsLmluZGV4T2YoJzovLycpO1xuICAgIGNvbnN0IHByb3RvY29sRW5kID0gcHJvdG9jb2xTZXBhcmF0b3JQb3MgPj0gMCA/IHByb3RvY29sU2VwYXJhdG9yUG9zICsgMyA6IDA7XG4gICAgY29uc3QgcXVlc3Rpb25Qb3MgPSB1cmwuaW5kZXhPZignPycsIHByb3RvY29sRW5kKTtcbiAgICBjb25zdCBxdWVyeVN0YXJ0ID0gcXVlc3Rpb25Qb3MgPj0gMCA/IHF1ZXN0aW9uUG9zICsgMSA6IHVybC5sZW5ndGg7XG4gICAgY29uc3QgcGF0aEVuZCA9IHF1ZXN0aW9uUG9zID49IDAgPyBxdWVzdGlvblBvcyA6IHVybC5sZW5ndGg7XG4gICAgY29uc3QgcGF0aFNlcGFyYXRvclBvcyA9IHVybC5pbmRleE9mKCcvJywgcHJvdG9jb2xFbmQpO1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1uZXN0ZWQtdGVybmFyeVxuICAgIGNvbnN0IHBhdGhTdGFydCA9IHBhdGhTZXBhcmF0b3JQb3MgPj0gMFxuICAgICAgICA/IChwYXRoU2VwYXJhdG9yUG9zIDwgcGF0aEVuZCA/IHBhdGhTZXBhcmF0b3JQb3MgOiBwYXRoRW5kKVxuICAgICAgICA6IChxdWVzdGlvblBvcyA+PSAwID8gcXVlc3Rpb25Qb3MgOiB1cmwubGVuZ3RoKTtcbiAgICBjb25zdCBob3N0UG9ydCA9IHVybC5zdWJzdHJpbmcocHJvdG9jb2xFbmQsIHBhdGhTdGFydCkuc3BsaXQoJzonKTtcbiAgICByZXR1cm4ge1xuICAgICAgICBwcm90b2NvbDogdXJsLnN1YnN0cmluZygwLCBwcm90b2NvbEVuZCksXG4gICAgICAgIGhvc3Q6IGhvc3RQb3J0WzBdLFxuICAgICAgICBwb3J0OiBob3N0UG9ydFsxXSB8fCAnJyxcbiAgICAgICAgcGF0aDogdXJsLnN1YnN0cmluZyhwYXRoU3RhcnQsIHBhdGhFbmQpLFxuICAgICAgICBxdWVyeTogdXJsLnN1YnN0cmluZyhxdWVyeVN0YXJ0KSxcbiAgICB9O1xufVxuXG50eXBlIEphZWdlckNvbmZpZyA9IHtcbiAgICBzZXJ2aWNlTmFtZTogc3RyaW5nLFxuICAgIGRpc2FibGU/OiBib29sZWFuLFxuICAgIHNhbXBsZXI6IHtcbiAgICAgICAgdHlwZTogc3RyaW5nLFxuICAgICAgICBwYXJhbTogbnVtYmVyLFxuICAgICAgICBob3N0UG9ydD86IHN0cmluZyxcbiAgICAgICAgaG9zdD86IHN0cmluZyxcbiAgICAgICAgcG9ydD86IG51bWJlcixcbiAgICAgICAgcmVmcmVzaEludGVydmFsTXM/OiBudW1iZXIsXG4gICAgfSxcbiAgICByZXBvcnRlcjoge1xuICAgICAgICBsb2dTcGFuczogYm9vbGVhbixcbiAgICAgICAgYWdlbnRIb3N0Pzogc3RyaW5nLFxuICAgICAgICBhZ2VudFBvcnQ/OiBudW1iZXIsXG4gICAgICAgIGFnZW50U29ja2V0VHlwZT86IHN0cmluZyxcbiAgICAgICAgY29sbGVjdG9yRW5kcG9pbnQ/OiBzdHJpbmcsXG4gICAgICAgIHVzZXJuYW1lPzogc3RyaW5nLFxuICAgICAgICBwYXNzd29yZD86IHN0cmluZyxcbiAgICAgICAgZmx1c2hJbnRlcnZhbE1zPzogbnVtYmVyLFxuICAgIH0sXG4gICAgdGhyb3R0bGVyPzoge1xuICAgICAgICBob3N0OiBzdHJpbmcsXG4gICAgICAgIHBvcnQ6IG51bWJlcixcbiAgICAgICAgcmVmcmVzaEludGVydmFsTXM6IG51bWJlcixcbiAgICB9LFxufVxuXG5leHBvcnQgY2xhc3MgUVRyYWNlciB7XG4gICAgc3RhdGljIGNvbmZpZzogUUNvbmZpZztcblxuICAgIHN0YXRpYyBnZXRKYWVnZXJDb25maWcoY29uZmlnOiB7XG4gICAgICAgIGVuZHBvaW50OiBzdHJpbmcsXG4gICAgICAgIHNlcnZpY2U6IHN0cmluZyxcbiAgICAgICAgdGFnczogeyBbc3RyaW5nXTogc3RyaW5nIH1cbiAgICB9KTogP0phZWdlckNvbmZpZyB7XG4gICAgICAgIGNvbnN0IGVuZHBvaW50ID0gY29uZmlnLmVuZHBvaW50O1xuICAgICAgICBpZiAoIWVuZHBvaW50KSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBwYXJ0cyA9IHBhcnNlVXJsKGVuZHBvaW50KTtcbiAgICAgICAgcmV0dXJuIChwYXJ0cy5wcm90b2NvbCA9PT0gJycpXG4gICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICBzZXJ2aWNlTmFtZTogY29uZmlnLnNlcnZpY2UsXG4gICAgICAgICAgICAgICAgc2FtcGxlcjoge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnY29uc3QnLFxuICAgICAgICAgICAgICAgICAgICBwYXJhbTogMSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHJlcG9ydGVyOiB7XG4gICAgICAgICAgICAgICAgICAgIGxvZ1NwYW5zOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBhZ2VudEhvc3Q6IHBhcnRzLmhvc3QsXG4gICAgICAgICAgICAgICAgICAgIGFnZW50UG9ydDogTnVtYmVyKHBhcnRzLnBvcnQpXG4gICAgICAgICAgICAgICAgICAgICxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgOiB7XG4gICAgICAgICAgICAgICAgc2VydmljZU5hbWU6IGNvbmZpZy5zZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHNhbXBsZXI6IHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2NvbnN0JyxcbiAgICAgICAgICAgICAgICAgICAgcGFyYW06IDEsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICByZXBvcnRlcjoge1xuICAgICAgICAgICAgICAgICAgICBsb2dTcGFuczogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgY29sbGVjdG9yRW5kcG9pbnQ6IGVuZHBvaW50LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9O1xuICAgIH1cblxuICAgIHN0YXRpYyBjcmVhdGUoY29uZmlnOiBRQ29uZmlnKTogVHJhY2VyIHtcbiAgICAgICAgUVRyYWNlci5jb25maWcgPSBjb25maWc7XG4gICAgICAgIGNvbnN0IGphZWdlckNvbmZpZyA9IFFUcmFjZXIuZ2V0SmFlZ2VyQ29uZmlnKGNvbmZpZy5qYWVnZXIpO1xuICAgICAgICBpZiAoIWphZWdlckNvbmZpZykge1xuICAgICAgICAgICAgcmV0dXJuIG5vb3BUcmFjZXI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGluaXRKYWVnZXJUcmFjZXIoamFlZ2VyQ29uZmlnLCB7XG4gICAgICAgICAgICBsb2dnZXI6IHtcbiAgICAgICAgICAgICAgICBpbmZvKG1zZykge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnSU5GTyAnLCBtc2cpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZXJyb3IobXNnKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFUlJPUicsIG1zZyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHN0YXRpYyBtZXNzYWdlUm9vdFNwYW5Db250ZXh0KG1lc3NhZ2VJZDogc3RyaW5nKTogP1NwYW5Db250ZXh0IHtcbiAgICAgICAgaWYgKCFtZXNzYWdlSWQpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHRyYWNlSWQgPSBtZXNzYWdlSWQuc3Vic3RyKDAsIDE2KTtcbiAgICAgICAgY29uc3Qgc3BhbklkID0gbWVzc2FnZUlkLnN1YnN0cigxNiwgMTYpO1xuICAgICAgICByZXR1cm4gSmFlZ2VyU3BhbkNvbnRleHQuZnJvbVN0cmluZyhgJHt0cmFjZUlkfToke3NwYW5JZH06MDoxYCk7XG4gICAgfVxuXG4gICAgc3RhdGljIGV4dHJhY3RQYXJlbnRTcGFuKHRyYWNlcjogVHJhY2VyLCByZXE6IGFueSk6IGFueSB7XG4gICAgICAgIGxldCBjdHhfc3JjLFxuICAgICAgICAgICAgY3R4X2ZybTtcbiAgICAgICAgaWYgKHJlcS5oZWFkZXJzKSB7XG4gICAgICAgICAgICBjdHhfc3JjID0gcmVxLmhlYWRlcnM7XG4gICAgICAgICAgICBjdHhfZnJtID0gRk9STUFUX1RFWFRfTUFQO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY3R4X3NyYyA9IHJlcS5jb250ZXh0O1xuICAgICAgICAgICAgY3R4X2ZybSA9IEZPUk1BVF9CSU5BUlk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRyYWNlci5leHRyYWN0KGN0eF9mcm0sIGN0eF9zcmMpO1xuICAgIH1cblxuICAgIHN0YXRpYyBnZXRQYXJlbnRTcGFuKHRyYWNlcjogVHJhY2VyLCBjb250ZXh0OiBhbnkpOiAoU3BhbkNvbnRleHQgfCB0eXBlb2YgdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiBjb250ZXh0LnRyYWNlclBhcmVudFNwYW47XG4gICAgfVxuXG4gICAgc3RhdGljIGZhaWxlZCh0cmFjZXI6IFRyYWNlciwgc3BhbjogU3BhbiwgZXJyb3I6IGFueSkge1xuICAgICAgICBzcGFuLmxvZyh7XG4gICAgICAgICAgICBldmVudDogJ2ZhaWxlZCcsXG4gICAgICAgICAgICBwYXlsb2FkOiB0b0xvZyhlcnJvciksXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyB0cmFjZTxUPihcbiAgICAgICAgdHJhY2VyOiBUcmFjZXIsXG4gICAgICAgIG5hbWU6IHN0cmluZyxcbiAgICAgICAgZjogKHNwYW46IFNwYW4pID0+IFByb21pc2U8VD4sXG4gICAgICAgIHBhcmVudFNwYW4/OiAoU3BhbiB8IFNwYW5Db250ZXh0KSxcbiAgICApOiBQcm9taXNlPFQ+IHtcbiAgICAgICAgY29uc3Qgc3BhbiA9IHRyYWNlci5zdGFydFNwYW4obmFtZSwgeyBjaGlsZE9mOiBwYXJlbnRTcGFuIH0pO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgc3Bhbi5zZXRUYWcoVGFncy5TUEFOX0tJTkQsICdzZXJ2ZXInKTtcbiAgICAgICAgICAgIE9iamVjdC5lbnRyaWVzKFFUcmFjZXIuY29uZmlnLmphZWdlci50YWdzKS5mb3JFYWNoKChbbmFtZSwgdmFsdWVdKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKG5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgc3Bhbi5zZXRUYWcobmFtZSwgdmFsdWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZihzcGFuKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHNwYW4uc2V0VGFnKCdyZXN1bHQnLCB0b0xvZyhyZXN1bHQpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNwYW4uZmluaXNoKCk7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc3QgY2xlYW5lZCA9IGNsZWFuRXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgUVRyYWNlci5mYWlsZWQodHJhY2VyLCBzcGFuLCBjbGVhbmVkKTtcbiAgICAgICAgICAgIHNwYW4uZmluaXNoKCk7XG4gICAgICAgICAgICB0aHJvdyBjbGVhbmVkO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19