"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.QTracer = exports.StatsTiming = exports.StatsGauge = exports.StatsCounter = exports.QStats = void 0;

var _config = require("./config");

var _noop = require("opentracing/lib/noop");

var _nodeStatsd = _interopRequireDefault(require("node-statsd"));

var _opentracing = require("opentracing");

var _jaegerClient = require("jaeger-client");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function dummy(stat, value, sampleRate, tags) {}

const dummyStats = {
  increment: dummy,
  decrement: dummy,
  histogram: dummy,
  gauge: dummy,
  set: dummy,
  timing: dummy
};

class QStats {
  static create(server) {
    if (!server) {
      return dummyStats;
    }

    const hostPort = server.split(':');
    return new _nodeStatsd.default(hostPort[0], hostPort[1], _config.STATS.prefix);
  }

}

exports.QStats = QStats;

class StatsCounter {
  constructor(stats, name, tags) {
    this.stats = stats;
    this.name = name;
    this.tags = tags;
  }

  increment() {
    this.stats.increment(this.name, 1, this.tags);
  }

}

exports.StatsCounter = StatsCounter;

class StatsGauge {
  constructor(stats, name, tags) {
    this.stats = stats;
    this.name = name;
    this.tags = tags;
    this.value = 0;
  }

  set(value) {
    this.value = value;
    this.stats.gauge(this.name, this.value, this.tags);
  }

  increment(delta = 1) {
    this.set(this.value + delta);
  }

  decrement(delta = 1) {
    this.set(this.value - delta);
  }

}

exports.StatsGauge = StatsGauge;

class StatsTiming {
  constructor(stats, name, tags) {
    this.stats = stats;
    this.name = name;
    this.tags = tags;
  }

  report(value) {
    this.stats.timing(this.name, value, this.tags);
  }

  start() {
    const start = Date.now();
    return () => {
      this.report(Date.now() - start);
    };
  }

}

exports.StatsTiming = StatsTiming;

class QTracer {
  static create(config) {
    QTracer.config = config;
    const endpoint = config.jaeger.endpoint;

    if (!endpoint) {
      return _noop.tracer;
    }

    return (0, _jaegerClient.initTracerFromEnv)({
      serviceName: config.jaeger.service,
      sampler: {
        type: 'const',
        param: 1
      },
      reporter: {
        collectorEndpoint: endpoint,
        logSpans: true
      }
    }, {
      logger: {
        info(msg) {
          console.log('INFO ', msg);
        },

        error(msg) {
          console.log('ERROR', msg);
        }

      }
    });
  }

  static extractParentSpan(tracer, req) {
    let ctx_src, ctx_frm;

    if (req.headers) {
      ctx_src = req.headers;
      ctx_frm = _opentracing.FORMAT_TEXT_MAP;
    } else {
      ctx_src = req.context;
      ctx_frm = _opentracing.FORMAT_BINARY;
    }

    return tracer.extract(ctx_frm, ctx_src);
  }

  static getParentSpan(tracer, context) {
    return context.tracerParentSpan;
  }

  static failed(tracer, span, error) {
    span.log({
      event: 'failed',
      payload: (0, _utils.toLog)(error)
    });
  }

  static async trace(tracer, name, f, parentSpan) {
    const span = tracer.startSpan(name, {
      childOf: parentSpan
    });

    try {
      span.setTag(_opentracing.Tags.SPAN_KIND, 'server');
      Object.entries(QTracer.config.jaeger.tags).forEach(([name, value]) => {
        if (name) {
          span.setTag(name, value);
        }
      });
      const result = await f(span);

      if (result !== undefined) {
        span.setTag('result', (0, _utils.toLog)(result));
      }

      span.finish();
      return result;
    } catch (error) {
      const cleaned = (0, _utils.cleanError)(error);
      QTracer.failed(tracer, span, cleaned);
      span.finish();
      throw cleaned;
    }
  }

}

exports.QTracer = QTracer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci90cmFjZXIuanMiXSwibmFtZXMiOlsiZHVtbXkiLCJzdGF0IiwidmFsdWUiLCJzYW1wbGVSYXRlIiwidGFncyIsImR1bW15U3RhdHMiLCJpbmNyZW1lbnQiLCJkZWNyZW1lbnQiLCJoaXN0b2dyYW0iLCJnYXVnZSIsInNldCIsInRpbWluZyIsIlFTdGF0cyIsImNyZWF0ZSIsInNlcnZlciIsImhvc3RQb3J0Iiwic3BsaXQiLCJTdGF0c0QiLCJTVEFUUyIsInByZWZpeCIsIlN0YXRzQ291bnRlciIsImNvbnN0cnVjdG9yIiwic3RhdHMiLCJuYW1lIiwiU3RhdHNHYXVnZSIsImRlbHRhIiwiU3RhdHNUaW1pbmciLCJyZXBvcnQiLCJzdGFydCIsIkRhdGUiLCJub3ciLCJRVHJhY2VyIiwiY29uZmlnIiwiZW5kcG9pbnQiLCJqYWVnZXIiLCJub29wVHJhY2VyIiwic2VydmljZU5hbWUiLCJzZXJ2aWNlIiwic2FtcGxlciIsInR5cGUiLCJwYXJhbSIsInJlcG9ydGVyIiwiY29sbGVjdG9yRW5kcG9pbnQiLCJsb2dTcGFucyIsImxvZ2dlciIsImluZm8iLCJtc2ciLCJjb25zb2xlIiwibG9nIiwiZXJyb3IiLCJleHRyYWN0UGFyZW50U3BhbiIsInRyYWNlciIsInJlcSIsImN0eF9zcmMiLCJjdHhfZnJtIiwiaGVhZGVycyIsIkZPUk1BVF9URVhUX01BUCIsImNvbnRleHQiLCJGT1JNQVRfQklOQVJZIiwiZXh0cmFjdCIsImdldFBhcmVudFNwYW4iLCJ0cmFjZXJQYXJlbnRTcGFuIiwiZmFpbGVkIiwic3BhbiIsImV2ZW50IiwicGF5bG9hZCIsInRyYWNlIiwiZiIsInBhcmVudFNwYW4iLCJzdGFydFNwYW4iLCJjaGlsZE9mIiwic2V0VGFnIiwiVGFncyIsIlNQQU5fS0lORCIsIk9iamVjdCIsImVudHJpZXMiLCJmb3JFYWNoIiwicmVzdWx0IiwidW5kZWZpbmVkIiwiZmluaXNoIiwiY2xlYW5lZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUVB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QUFrQnJCLEtBQWxCO0FBQ0g7QUFDSixPQUpEO0FBS0EsWUFBTTJFLE1BQU0sR0FBRyxNQUFNVixDQUFDLENBQUNKLElBQUQsQ0FBdEI7O0FBQ0EsVUFBSWMsTUFBTSxLQUFLQyxTQUFmLEVBQTBCO0FBQ3RCZixRQUFBQSxJQUFJLENBQUNRLE1BQUwsQ0FBWSxRQUFaLEVBQXNCLGtCQUFNTSxNQUFOLENBQXRCO0FBQ0g7O0FBQ0RkLE1BQUFBLElBQUksQ0FBQ2dCLE1BQUw7QUFDQSxhQUFPRixNQUFQO0FBQ0gsS0FiRCxDQWFFLE9BQU81QixLQUFQLEVBQWM7QUFDWixZQUFNK0IsT0FBTyxHQUFHLHVCQUFXL0IsS0FBWCxDQUFoQjtBQUNBbEIsTUFBQUEsT0FBTyxDQUFDK0IsTUFBUixDQUFlWCxNQUFmLEVBQXVCWSxJQUF2QixFQUE2QmlCLE9BQTdCO0FBQ0FqQixNQUFBQSxJQUFJLENBQUNnQixNQUFMO0FBQ0EsWUFBTUMsT0FBTjtBQUNIO0FBQ0o7O0FBakZnQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB7U1RBVFN9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCB0eXBlIHtRQ29uZmlnfSBmcm9tIFwiLi9jb25maWdcIjtcbmltcG9ydCB7dHJhY2VyIGFzIG5vb3BUcmFjZXJ9IGZyb20gXCJvcGVudHJhY2luZy9saWIvbm9vcFwiO1xuaW1wb3J0IFN0YXRzRCBmcm9tICdub2RlLXN0YXRzZCc7XG5pbXBvcnQge1RyYWNlciwgVGFncywgRk9STUFUX1RFWFRfTUFQLCBGT1JNQVRfQklOQVJZLCBTcGFuLCBTcGFuQ29udGV4dH0gZnJvbSBcIm9wZW50cmFjaW5nXCI7XG5cbmltcG9ydCB7aW5pdFRyYWNlckZyb21FbnYgYXMgaW5pdEphZWdlclRyYWNlcn0gZnJvbSAnamFlZ2VyLWNsaWVudCc7XG5pbXBvcnQge2NsZWFuRXJyb3IsIHRvTG9nfSBmcm9tIFwiLi91dGlsc1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIElTdGF0cyB7XG4gICAgaW5jcmVtZW50KHN0YXQ6IHN0cmluZywgdmFsdWU/OiBudW1iZXIsIHNhbXBsZVJhdGU/OiBudW1iZXIgfCBzdHJpbmdbXSwgdGFncz86IHN0cmluZ1tdKTogdm9pZCxcblxuICAgIGRlY3JlbWVudChzdGF0OiBzdHJpbmcsIHZhbHVlPzogbnVtYmVyLCBzYW1wbGVSYXRlPzogbnVtYmVyIHwgc3RyaW5nW10sIHRhZ3M/OiBzdHJpbmdbXSk6IHZvaWQsXG5cbiAgICBoaXN0b2dyYW0oc3RhdDogc3RyaW5nLCB2YWx1ZTogbnVtYmVyLCBzYW1wbGVSYXRlPzogbnVtYmVyIHwgc3RyaW5nW10sIHRhZ3M/OiBzdHJpbmdbXSk6IHZvaWQsXG5cbiAgICBnYXVnZShzdGF0OiBzdHJpbmcsIHZhbHVlOiBudW1iZXIsIHNhbXBsZVJhdGU/OiBudW1iZXIgfCBzdHJpbmdbXSwgdGFncz86IHN0cmluZ1tdKTogdm9pZCxcblxuICAgIHNldChzdGF0OiBzdHJpbmcsIHZhbHVlOiBudW1iZXIsIHNhbXBsZVJhdGU/OiBudW1iZXIgfCBzdHJpbmdbXSwgdGFncz86IHN0cmluZ1tdKTogdm9pZCxcblxuICAgIHRpbWluZyhzdGF0OiBzdHJpbmcsIHZhbHVlOiBudW1iZXIsIHNhbXBsZVJhdGU/OiBudW1iZXIgfCBzdHJpbmdbXSwgdGFncz86IHN0cmluZ1tdKTogdm9pZCxcbn1cblxuZnVuY3Rpb24gZHVtbXkoc3RhdDogc3RyaW5nLCB2YWx1ZT86IG51bWJlciwgc2FtcGxlUmF0ZT86IG51bWJlciB8IHN0cmluZ1tdLCB0YWdzPzogc3RyaW5nW10pIHtcbn1cblxuY29uc3QgZHVtbXlTdGF0czogSVN0YXRzID0ge1xuICAgIGluY3JlbWVudDogZHVtbXksXG4gICAgZGVjcmVtZW50OiBkdW1teSxcbiAgICBoaXN0b2dyYW06IGR1bW15LFxuICAgIGdhdWdlOiBkdW1teSxcbiAgICBzZXQ6IGR1bW15LFxuICAgIHRpbWluZzogZHVtbXksXG59O1xuXG5leHBvcnQgY2xhc3MgUVN0YXRzIHtcbiAgICBzdGF0aWMgY3JlYXRlKHNlcnZlcjogc3RyaW5nKTogSVN0YXRzIHtcbiAgICAgICAgaWYgKCFzZXJ2ZXIpIHtcbiAgICAgICAgICAgIHJldHVybiBkdW1teVN0YXRzO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGhvc3RQb3J0ID0gc2VydmVyLnNwbGl0KCc6Jyk7XG4gICAgICAgIHJldHVybiBuZXcgU3RhdHNEKGhvc3RQb3J0WzBdLCBob3N0UG9ydFsxXSwgU1RBVFMucHJlZml4KTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBTdGF0c0NvdW50ZXIge1xuICAgIHN0YXRzOiBJU3RhdHM7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIHRhZ3M6IHN0cmluZ1tdO1xuXG4gICAgY29uc3RydWN0b3Ioc3RhdHM6IElTdGF0cywgbmFtZTogc3RyaW5nLCB0YWdzOiBzdHJpbmdbXSkge1xuICAgICAgICB0aGlzLnN0YXRzID0gc3RhdHM7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHRoaXMudGFncyA9IHRhZ3M7XG4gICAgfVxuXG4gICAgaW5jcmVtZW50KCkge1xuICAgICAgICB0aGlzLnN0YXRzLmluY3JlbWVudCh0aGlzLm5hbWUsIDEsIHRoaXMudGFncyk7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgU3RhdHNHYXVnZSB7XG4gICAgc3RhdHM6IElTdGF0cztcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgdGFnczogc3RyaW5nW107XG4gICAgdmFsdWU6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKHN0YXRzOiBJU3RhdHMsIG5hbWU6IHN0cmluZywgdGFnczogc3RyaW5nW10pIHtcbiAgICAgICAgdGhpcy5zdGF0cyA9IHN0YXRzO1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICB0aGlzLnRhZ3MgPSB0YWdzO1xuICAgICAgICB0aGlzLnZhbHVlID0gMDtcbiAgICB9XG5cbiAgICBzZXQodmFsdWU6IG51bWJlcikge1xuICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7XG4gICAgICAgIHRoaXMuc3RhdHMuZ2F1Z2UodGhpcy5uYW1lLCB0aGlzLnZhbHVlLCB0aGlzLnRhZ3MpO1xuICAgIH1cblxuICAgIGluY3JlbWVudChkZWx0YTogbnVtYmVyID0gMSkge1xuICAgICAgICB0aGlzLnNldCh0aGlzLnZhbHVlICsgZGVsdGEpO1xuICAgIH1cblxuICAgIGRlY3JlbWVudChkZWx0YTogbnVtYmVyID0gMSkge1xuICAgICAgICB0aGlzLnNldCh0aGlzLnZhbHVlIC0gZGVsdGEpO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFN0YXRzVGltaW5nIHtcbiAgICBzdGF0czogSVN0YXRzO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB0YWdzOiBzdHJpbmdbXTtcblxuICAgIGNvbnN0cnVjdG9yKHN0YXRzOiBJU3RhdHMsIG5hbWU6IHN0cmluZywgdGFnczogc3RyaW5nW10pIHtcbiAgICAgICAgdGhpcy5zdGF0cyA9IHN0YXRzO1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICB0aGlzLnRhZ3MgPSB0YWdzO1xuICAgIH1cblxuICAgIHJlcG9ydCh2YWx1ZTogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMuc3RhdHMudGltaW5nKHRoaXMubmFtZSwgdmFsdWUsIHRoaXMudGFncyk7XG4gICAgfVxuXG4gICAgc3RhcnQoKTogKCkgPT4gdm9pZCB7XG4gICAgICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVwb3J0KERhdGUubm93KCkgLSBzdGFydCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBRVHJhY2VyIHtcbiAgICBzdGF0aWMgY29uZmlnOiBRQ29uZmlnO1xuXG4gICAgc3RhdGljIGNyZWF0ZShjb25maWc6IFFDb25maWcpOiBUcmFjZXIge1xuICAgICAgICBRVHJhY2VyLmNvbmZpZyA9IGNvbmZpZztcbiAgICAgICAgY29uc3QgZW5kcG9pbnQgPSBjb25maWcuamFlZ2VyLmVuZHBvaW50O1xuICAgICAgICBpZiAoIWVuZHBvaW50KSB7XG4gICAgICAgICAgICByZXR1cm4gbm9vcFRyYWNlcjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaW5pdEphZWdlclRyYWNlcih7XG4gICAgICAgICAgICBzZXJ2aWNlTmFtZTogY29uZmlnLmphZWdlci5zZXJ2aWNlLFxuICAgICAgICAgICAgc2FtcGxlcjoge1xuICAgICAgICAgICAgICAgIHR5cGU6ICdjb25zdCcsXG4gICAgICAgICAgICAgICAgcGFyYW06IDEsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcmVwb3J0ZXI6IHtcbiAgICAgICAgICAgICAgICBjb2xsZWN0b3JFbmRwb2ludDogZW5kcG9pbnQsXG4gICAgICAgICAgICAgICAgbG9nU3BhbnM6IHRydWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICB9LCB7XG4gICAgICAgICAgICBsb2dnZXI6IHtcbiAgICAgICAgICAgICAgICBpbmZvKG1zZykge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnSU5GTyAnLCBtc2cpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZXJyb3IobXNnKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFUlJPUicsIG1zZyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHN0YXRpYyBleHRyYWN0UGFyZW50U3Bhbih0cmFjZXI6IFRyYWNlciwgcmVxOiBhbnkpOiBhbnkge1xuICAgICAgICBsZXQgY3R4X3NyYyxcbiAgICAgICAgICAgIGN0eF9mcm07XG4gICAgICAgIGlmIChyZXEuaGVhZGVycykge1xuICAgICAgICAgICAgY3R4X3NyYyA9IHJlcS5oZWFkZXJzO1xuICAgICAgICAgICAgY3R4X2ZybSA9IEZPUk1BVF9URVhUX01BUDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGN0eF9zcmMgPSByZXEuY29udGV4dDtcbiAgICAgICAgICAgIGN0eF9mcm0gPSBGT1JNQVRfQklOQVJZO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cmFjZXIuZXh0cmFjdChjdHhfZnJtLCBjdHhfc3JjKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZ2V0UGFyZW50U3Bhbih0cmFjZXI6IFRyYWNlciwgY29udGV4dDogYW55KTogKFNwYW5Db250ZXh0IHwgdHlwZW9mIHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm4gY29udGV4dC50cmFjZXJQYXJlbnRTcGFuO1xuICAgIH1cblxuICAgIHN0YXRpYyBmYWlsZWQodHJhY2VyOiBUcmFjZXIsIHNwYW46IFNwYW4sIGVycm9yOiBhbnkpIHtcbiAgICAgICAgc3Bhbi5sb2coe1xuICAgICAgICAgICAgZXZlbnQ6ICdmYWlsZWQnLFxuICAgICAgICAgICAgcGF5bG9hZDogdG9Mb2coZXJyb3IpLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgdHJhY2U8VD4oXG4gICAgICAgIHRyYWNlcjogVHJhY2VyLFxuICAgICAgICBuYW1lOiBzdHJpbmcsXG4gICAgICAgIGY6IChzcGFuOiBTcGFuKSA9PiBQcm9taXNlPFQ+LFxuICAgICAgICBwYXJlbnRTcGFuPzogKFNwYW4gfCBTcGFuQ29udGV4dCksXG4gICAgKTogUHJvbWlzZTxUPiB7XG4gICAgICAgIGNvbnN0IHNwYW4gPSB0cmFjZXIuc3RhcnRTcGFuKG5hbWUsIHtjaGlsZE9mOiBwYXJlbnRTcGFufSk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBzcGFuLnNldFRhZyhUYWdzLlNQQU5fS0lORCwgJ3NlcnZlcicpO1xuICAgICAgICAgICAgT2JqZWN0LmVudHJpZXMoUVRyYWNlci5jb25maWcuamFlZ2VyLnRhZ3MpLmZvckVhY2goKFtuYW1lLCB2YWx1ZV0pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAobmFtZSkge1xuICAgICAgICAgICAgICAgICAgICBzcGFuLnNldFRhZyhuYW1lLCB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmKHNwYW4pO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgc3Bhbi5zZXRUYWcoJ3Jlc3VsdCcsIHRvTG9nKHJlc3VsdCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3Bhbi5maW5pc2goKTtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zdCBjbGVhbmVkID0gY2xlYW5FcnJvcihlcnJvcik7XG4gICAgICAgICAgICBRVHJhY2VyLmZhaWxlZCh0cmFjZXIsIHNwYW4sIGNsZWFuZWQpO1xuICAgICAgICAgICAgc3Bhbi5maW5pc2goKTtcbiAgICAgICAgICAgIHRocm93IGNsZWFuZWQ7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=