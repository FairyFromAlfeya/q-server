"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.QTracer = exports.StatsTiming = exports.StatsGauge = exports.StatsCounter = exports.QStats = void 0;

var _config = require("./config");

var _noop = require("opentracing/lib/noop");

var _nodeStatsd = _interopRequireDefault(require("node-statsd"));

var _opentracing = require("opentracing");

var _jaegerClient = require("jaeger-client");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function logStatsError(error) {
  console.log(`StatsD send failed: ${error.message}`);
}

const dummyStats = {
  configuredTags: [],

  increment(_stat, _value, _tags) {
    return Promise.resolve();
  },

  gauge(_stat, _value, _tags) {
    return Promise.resolve();
  },

  timing(_stat, _value, _tags) {
    return Promise.resolve();
  },

  close() {}

};

class QStats {
  static create(server, configuredTags, resetInterval) {
    return server ? new QStats(server, configuredTags, resetInterval) : dummyStats;
  }

  constructor(server, configuredTags, resetInterval) {
    const hostPort = server.split(':');
    this.host = hostPort[0];
    this.port = hostPort[1];
    this.configuredTags = configuredTags;
    this.resetInterval = resetInterval;
    this.impl = null;
    this.resetTime = resetInterval > 0 ? Date.now() + resetInterval : 0;
  }

  ensureImpl() {
    const impl = this.impl;

    if (impl) {
      return impl;
    }

    const newImpl = new _nodeStatsd.default(this.host, this.port, _config.STATS.prefix);
    newImpl.socket.on("error", err => {
      logStatsError(err);
      this.dropImpl();
    });
    this.impl = newImpl;
    return newImpl;
  }

  dropImpl(error) {
    if (error) {
      logStatsError(error);
    }

    if (this.impl) {
      this.impl.close();
      this.impl = null;
    }
  }

  withImpl(f) {
    return new Promise((resolve, _) => {
      try {
        if (this.resetTime > 0) {
          const now = Date.now();

          if (now > this.resetTime) {
            this.dropImpl();
            this.resetTime = now + this.resetInterval;
          }
        }

        f(this.ensureImpl(), (error, _) => {
          if (error) {
            this.dropImpl(error);
          }

          resolve();
        });
      } catch (error) {
        this.dropImpl(error);
        resolve();
      }
    });
  }

  increment(stat, value, tags) {
    return this.withImpl((stats, callback) => stats.increment(stat, value, tags, callback));
  }

  gauge(stat, value, tags) {
    return this.withImpl((stats, callback) => stats.gauge(stat, value, tags, callback));
  }

  timing(stat, value, tags) {
    return this.withImpl((stats, callback) => stats.timing(stat, value, tags, callback));
  }

  close() {
    this.dropImpl();
  }

  static combineTags(stats, tags) {
    return stats && stats.configuredTags && stats.configuredTags.length > 0 ? stats.configuredTags.concat(tags) : tags;
  }

}

exports.QStats = QStats;

class StatsCounter {
  constructor(stats, name, tags) {
    this.stats = stats;
    this.name = name;
    this.tags = QStats.combineTags(stats, tags);
  }

  increment() {
    return this.stats.increment(this.name, 1, this.tags);
  }

}

exports.StatsCounter = StatsCounter;

class StatsGauge {
  constructor(stats, name, tags) {
    this.stats = stats;
    this.name = name;
    this.tags = QStats.combineTags(stats, tags);
    this.value = 0;
  }

  set(value) {
    this.value = value;
    return this.stats.gauge(this.name, this.value, this.tags);
  }

  increment(delta = 1) {
    return this.set(this.value + delta);
  }

  decrement(delta = 1) {
    return this.set(this.value - delta);
  }

}

exports.StatsGauge = StatsGauge;

class StatsTiming {
  constructor(stats, name, tags) {
    this.stats = stats;
    this.name = name;
    this.tags = QStats.combineTags(stats, tags);
  }

  report(value) {
    return this.stats.timing(this.name, value, this.tags);
  }

  start() {
    const start = Date.now();
    return () => {
      return this.report(Date.now() - start);
    };
  }

}

exports.StatsTiming = StatsTiming;

function parseUrl(url) {
  const protocolSeparatorPos = url.indexOf('://');
  const protocolEnd = protocolSeparatorPos >= 0 ? protocolSeparatorPos + 3 : 0;
  const questionPos = url.indexOf('?', protocolEnd);
  const queryStart = questionPos >= 0 ? questionPos + 1 : url.length;
  const pathEnd = questionPos >= 0 ? questionPos : url.length;
  const pathSeparatorPos = url.indexOf('/', protocolEnd); // eslint-disable-next-line no-nested-ternary

  const pathStart = pathSeparatorPos >= 0 ? pathSeparatorPos < pathEnd ? pathSeparatorPos : pathEnd : questionPos >= 0 ? questionPos : url.length;
  const hostPort = url.substring(protocolEnd, pathStart).split(':');
  return {
    protocol: url.substring(0, protocolEnd),
    host: hostPort[0],
    port: hostPort[1] || '',
    path: url.substring(pathStart, pathEnd),
    query: url.substring(queryStart)
  };
}

class QTracer {
  static getJaegerConfig(config) {
    const endpoint = config.endpoint;

    if (!endpoint) {
      return null;
    }

    const parts = parseUrl(endpoint);
    return parts.protocol === '' ? {
      serviceName: config.service,
      sampler: {
        type: 'const',
        param: 1
      },
      reporter: {
        logSpans: true,
        agentHost: parts.host,
        agentPort: Number(parts.port)
      }
    } : {
      serviceName: config.service,
      sampler: {
        type: 'const',
        param: 1
      },
      reporter: {
        logSpans: true,
        collectorEndpoint: endpoint
      }
    };
  }

  static create(config) {
    QTracer.config = config;
    const jaegerConfig = QTracer.getJaegerConfig(config.jaeger);

    if (!jaegerConfig) {
      return _noop.tracer;
    }

    return (0, _jaegerClient.initTracerFromEnv)(jaegerConfig, {
      logger: {
        info(msg) {
          console.log('INFO ', msg);
        },

        error(msg) {
          console.log('ERROR', msg);
        }

      }
    });
  }

  static messageRootSpanContext(messageId) {
    if (!messageId) {
      return null;
    }

    const traceId = messageId.substr(0, 16);
    const spanId = messageId.substr(16, 16);
    return _jaegerClient.SpanContext.fromString(`${traceId}:${spanId}:0:1`);
  }

  static extractParentSpan(tracer, req) {
    let ctx_src, ctx_frm;

    if (req.headers) {
      ctx_src = req.headers;
      ctx_frm = _opentracing.FORMAT_TEXT_MAP;
    } else {
      ctx_src = req.context;
      ctx_frm = _opentracing.FORMAT_BINARY;
    }

    return tracer.extract(ctx_frm, ctx_src);
  }

  static getParentSpan(tracer, context) {
    return context.tracerParentSpan;
  }

  static failed(tracer, span, error) {
    span.log({
      event: 'failed',
      payload: (0, _utils.toLog)(error)
    });
  }

  static async trace(tracer, name, f, parentSpan) {
    const span = tracer.startSpan(name, {
      childOf: parentSpan
    });

    try {
      span.setTag(_opentracing.Tags.SPAN_KIND, 'server');
      Object.entries(QTracer.config.jaeger.tags).forEach(([name, value]) => {
        if (name) {
          span.setTag(name, value);
        }
      });
      const result = await f(span);

      if (result !== undefined) {
        span.setTag('result', (0, _utils.toLog)(result));
      }

      span.finish();
      return result;
    } catch (error) {
      const cleaned = (0, _utils.cleanError)(error);
      QTracer.failed(tracer, span, cleaned);
      span.finish();
      throw cleaned;
    }
  }

}

exports.QTracer = QTracer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvdHJhY2VyLmpzIl0sIm5hbWVzIjpbImxvZ1N0YXRzRXJyb3IiLCJlcnJvciIsImNvbnNvbGUiLCJsb2ciLCJtZXNzYWdlIiwiZHVtbXlTdGF0cyIsImNvbmZpZ3VyZWRUYWdzIiwiaW5jcmVtZW50IiwiX3N0YXQiLCJfdmFsdWUiLCJfdGFncyIsIlByb21pc2UiLCJyZXNvbHZlIiwiZ2F1Z2UiLCJ0aW1pbmciLCJjbG9zZSIsIlFTdGF0cyIsImNyZWF0ZSIsInNlcnZlciIsInJlc2V0SW50ZXJ2YWwiLCJjb25zdHJ1Y3RvciIsImhvc3RQb3J0Iiwic3BsaXQiLCJob3N0IiwicG9ydCIsImltcGwiLCJyZXNldFRpbWUiLCJEYXRlIiwibm93IiwiZW5zdXJlSW1wbCIsIm5ld0ltcGwiLCJTdGF0c0QiLCJTVEFUUyIsInByZWZpeCIsInNvY2tldCIsIm9uIiwiZXJyIiwiZHJvcEltcGwiLCJ3aXRoSW1wbCIsImYiLCJfIiwic3RhdCIsInZhbHVlIiwidGFncyIsInN0YXRzIiwiY2FsbGJhY2siLCJjb21iaW5lVGFncyIsImxlbmd0aCIsImNvbmNhdCIsIlN0YXRzQ291bnRlciIsIm5hbWUiLCJTdGF0c0dhdWdlIiwic2V0IiwiZGVsdGEiLCJkZWNyZW1lbnQiLCJTdGF0c1RpbWluZyIsInJlcG9ydCIsInN0YXJ0IiwicGFyc2VVcmwiLCJ1cmwiLCJwcm90b2NvbFNlcGFyYXRvclBvcyIsImluZGV4T2YiLCJwcm90b2NvbEVuZCIsInF1ZXN0aW9uUG9zIiwicXVlcnlTdGFydCIsInBhdGhFbmQiLCJwYXRoU2VwYXJhdG9yUG9zIiwicGF0aFN0YXJ0Iiwic3Vic3RyaW5nIiwicHJvdG9jb2wiLCJwYXRoIiwicXVlcnkiLCJRVHJhY2VyIiwiZ2V0SmFlZ2VyQ29uZmlnIiwiY29uZmlnIiwiZW5kcG9pbnQiLCJwYXJ0cyIsInNlcnZpY2VOYW1lIiwic2VydmljZSIsInNhbXBsZXIiLCJ0eXBlIiwicGFyYW0iLCJyZXBvcnRlciIsImxvZ1NwYW5zIiwiYWdlbnRIb3N0IiwiYWdlbnRQb3J0IiwiTnVtYmVyIiwiY29sbGVjdG9yRW5kcG9pbnQiLCJqYWVnZXJDb25maWciLCJqYWVnZXIiLCJub29wVHJhY2VyIiwibG9nZ2VyIiwiaW5mbyIsIm1zZyIsIm1lc3NhZ2VSb290U3BhbkNvbnRleHQiLCJtZXNzYWdlSWQiLCJ0cmFjZUlkIiwic3Vic3RyIiwic3BhbklkIiwiSmFlZ2VyU3BhbkNvbnRleHQiLCJmcm9tU3RyaW5nIiwiZXh0cmFjdFBhcmVudFNwYW4iLCJ0cmFjZXIiLCJyZXEiLCJjdHhfc3JjIiwiY3R4X2ZybSIsImhlYWRlcnMiLCJGT1JNQVRfVEVYVF9NQVAiLCJjb250ZXh0IiwiRk9STUFUX0JJTkFSWSIsImV4dHJhY3QiLCJnZXRQYXJlbnRTcGFuIiwidHJhY2VyUGFyZW50U3BhbiIsImZhaWxlZCIsInNwYW4iLCJldmVudCIsInBheWxvYWQiLCJ0cmFjZSIsInBhcmVudFNwYW4iLCJzdGFydFNwYW4iLCJjaGlsZE9mIiwic2V0VGFnIiwiVGFncyIsIlNQQU5fS0lORCIsIk9iamVjdCIsImVudHJpZXMiLCJmb3JFYWNoIiwicmVzdWx0IiwidW5kZWZpbmVkIiwiZmluaXNoIiwiY2xlYW5lZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUVBOztBQUVBOztBQUNBOztBQUNBOztBQUVBOztBQUlBOzs7O0FBMEJBLFNBQVNBLGFBQVQsQ0FBdUJDLEtBQXZCLEVBQW1DO0FBQy9CQyxFQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBYSx1QkFBc0JGLEtBQUssQ0FBQ0csT0FBUSxFQUFqRDtBQUNIOztBQUVELE1BQU1DLFVBQWtCLEdBQUc7QUFDdkJDLEVBQUFBLGNBQWMsRUFBRSxFQURPOztBQUV2QkMsRUFBQUEsU0FBUyxDQUFDQyxLQUFELEVBQWdCQyxNQUFoQixFQUFnQ0MsS0FBaEMsRUFBK0Q7QUFDcEUsV0FBT0MsT0FBTyxDQUFDQyxPQUFSLEVBQVA7QUFDSCxHQUpzQjs7QUFLdkJDLEVBQUFBLEtBQUssQ0FBQ0wsS0FBRCxFQUFn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LENBQWhCO0FBQ0F1RSxNQUFBQSxPQUFPLENBQUN5QyxNQUFSLENBQWVYLE1BQWYsRUFBdUJZLElBQXZCLEVBQTZCZ0IsT0FBN0I7QUFDQWhCLE1BQUFBLElBQUksQ0FBQ2UsTUFBTDtBQUNBLFlBQU1DLE9BQU47QUFDSDtBQUNKOztBQXJIZ0IiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgeyBTVEFUUyB9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCB0eXBlIHsgUUNvbmZpZyB9IGZyb20gXCIuL2NvbmZpZ1wiO1xuaW1wb3J0IHsgdHJhY2VyIGFzIG5vb3BUcmFjZXIgfSBmcm9tIFwib3BlbnRyYWNpbmcvbGliL25vb3BcIjtcbmltcG9ydCBTdGF0c0QgZnJvbSAnbm9kZS1zdGF0c2QnO1xuaW1wb3J0IHsgVHJhY2VyLCBUYWdzLCBGT1JNQVRfVEVYVF9NQVAsIEZPUk1BVF9CSU5BUlksIFNwYW4sIFNwYW5Db250ZXh0IH0gZnJvbSBcIm9wZW50cmFjaW5nXCI7XG5cbmltcG9ydCB7XG4gICAgaW5pdFRyYWNlckZyb21FbnYgYXMgaW5pdEphZWdlclRyYWNlcixcbiAgICBTcGFuQ29udGV4dCBhcyBKYWVnZXJTcGFuQ29udGV4dCxcbn0gZnJvbSAnamFlZ2VyLWNsaWVudCc7XG5pbXBvcnQgeyBjbGVhbkVycm9yLCB0b0xvZyB9IGZyb20gXCIuL3V0aWxzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVN0YXRzIHtcbiAgICBjb25maWd1cmVkVGFnczogc3RyaW5nW10sXG5cbiAgICBpbmNyZW1lbnQoc3RhdDogc3RyaW5nLCB2YWx1ZTogbnVtYmVyLCB0YWdzOiBzdHJpbmdbXSk6IFByb21pc2U8dm9pZD4sXG5cbiAgICBnYXVnZShzdGF0OiBzdHJpbmcsIHZhbHVlOiBudW1iZXIsIHRhZ3M6IHN0cmluZ1tdKTogUHJvbWlzZTx2b2lkPixcblxuICAgIHRpbWluZyhzdGF0OiBzdHJpbmcsIHZhbHVlOiBudW1iZXIsIHRhZ3M6IHN0cmluZ1tdKTogUHJvbWlzZTx2b2lkPixcblxuICAgIGNsb3NlKCk6IHZvaWQsXG59XG5cbnR5cGUgU3RhdHNDYWxsYmFjayA9IChlcnJvcjogYW55LCBieXRlczogYW55KSA9PiB2b2lkO1xuXG5leHBvcnQgaW50ZXJmYWNlIElTdGF0c0ltcGwge1xuICAgIGluY3JlbWVudChzdGF0OiBzdHJpbmcsIHZhbHVlOiBudW1iZXIsIHRhZ3M6IHN0cmluZ1tdLCBjYWxsYmFjazogU3RhdHNDYWxsYmFjayk6IHZvaWQsXG5cbiAgICBnYXVnZShzdGF0OiBzdHJpbmcsIHZhbHVlOiBudW1iZXIsIHRhZ3M6IHN0cmluZ1tdLCBjYWxsYmFjazogU3RhdHNDYWxsYmFjayk6IHZvaWQsXG5cbiAgICB0aW1pbmcoc3RhdDogc3RyaW5nLCB2YWx1ZTogbnVtYmVyLCB0YWdzOiBzdHJpbmdbXSwgY2FsbGJhY2s6IFN0YXRzQ2FsbGJhY2spOiB2b2lkLFxuXG4gICAgY2xvc2UoKTogdm9pZCxcbn1cblxuZnVuY3Rpb24gbG9nU3RhdHNFcnJvcihlcnJvcjogYW55KSB7XG4gICAgY29uc29sZS5sb2coYFN0YXRzRCBzZW5kIGZhaWxlZDogJHtlcnJvci5tZXNzYWdlfWApO1xufVxuXG5jb25zdCBkdW1teVN0YXRzOiBJU3RhdHMgPSB7XG4gICAgY29uZmlndXJlZFRhZ3M6IFtdLFxuICAgIGluY3JlbWVudChfc3RhdDogc3RyaW5nLCBfdmFsdWU6IG51bWJlciwgX3RhZ3M6IHN0cmluZ1tdKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH0sXG4gICAgZ2F1Z2UoX3N0YXQ6IHN0cmluZywgX3ZhbHVlOiBudW1iZXIsIF90YWdzOiBzdHJpbmdbXSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9LFxuICAgIHRpbWluZyhfc3RhdDogc3RyaW5nLCBfdmFsdWU6IG51bWJlciwgX3RhZ3M6IHN0cmluZ1tdKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH0sXG4gICAgY2xvc2UoKSB7XG4gICAgfVxufTtcblxuZXhwb3J0IGNsYXNzIFFTdGF0cyB7XG4gICAgc3RhdGljIGNyZWF0ZShcbiAgICAgICAgc2VydmVyOiBzdHJpbmcsXG4gICAgICAgIGNvbmZpZ3VyZWRUYWdzOiBzdHJpbmdbXSxcbiAgICAgICAgcmVzZXRJbnRlcnZhbDogbnVtYmVyLFxuICAgICk6IElTdGF0cyB7XG4gICAgICAgIHJldHVybiBzZXJ2ZXIgPyBuZXcgUVN0YXRzKHNlcnZlciwgY29uZmlndXJlZFRhZ3MsIHJlc2V0SW50ZXJ2YWwpIDogZHVtbXlTdGF0cztcbiAgICB9XG5cbiAgICBob3N0OiBzdHJpbmc7XG4gICAgcG9ydDogc3RyaW5nIHwgdHlwZW9mIHVuZGVmaW5lZDtcbiAgICBpbXBsOiA/SVN0YXRzSW1wbDtcbiAgICByZXNldEludGVydmFsOiBudW1iZXI7XG4gICAgcmVzZXRUaW1lOiBudW1iZXI7XG4gICAgY29uZmlndXJlZFRhZ3M6IHN0cmluZ1tdO1xuXG4gICAgY29uc3RydWN0b3Ioc2VydmVyOiBzdHJpbmcsIGNvbmZpZ3VyZWRUYWdzOiBzdHJpbmdbXSwgcmVzZXRJbnRlcnZhbDogbnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IGhvc3RQb3J0ID0gc2VydmVyLnNwbGl0KCc6Jyk7XG4gICAgICAgIHRoaXMuaG9zdCA9IGhvc3RQb3J0WzBdO1xuICAgICAgICB0aGlzLnBvcnQgPSBob3N0UG9ydFsxXTtcbiAgICAgICAgdGhpcy5jb25maWd1cmVkVGFncyA9IGNvbmZpZ3VyZWRUYWdzO1xuICAgICAgICB0aGlzLnJlc2V0SW50ZXJ2YWwgPSByZXNldEludGVydmFsO1xuXG4gICAgICAgIHRoaXMuaW1wbCA9IG51bGw7XG4gICAgICAgIHRoaXMucmVzZXRUaW1lID0gcmVzZXRJbnRlcnZhbCA+IDAgPyBEYXRlLm5vdygpICsgcmVzZXRJbnRlcnZhbCA6IDA7XG4gICAgfVxuXG4gICAgZW5zdXJlSW1wbCgpIHtcbiAgICAgICAgY29uc3QgaW1wbCA9IHRoaXMuaW1wbDtcbiAgICAgICAgaWYgKGltcGwpIHtcbiAgICAgICAgICAgIHJldHVybiBpbXBsO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG5ld0ltcGwgPSBuZXcgU3RhdHNEKHRoaXMuaG9zdCwgdGhpcy5wb3J0LCBTVEFUUy5wcmVmaXgpO1xuICAgICAgICBuZXdJbXBsLnNvY2tldC5vbihcImVycm9yXCIsIChlcnIpID0+IHtcbiAgICAgICAgICAgIGxvZ1N0YXRzRXJyb3IoZXJyKTtcbiAgICAgICAgICAgIHRoaXMuZHJvcEltcGwoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuaW1wbCA9IG5ld0ltcGw7XG4gICAgICAgIHJldHVybiBuZXdJbXBsO1xuICAgIH1cblxuICAgIGRyb3BJbXBsKGVycm9yPzogRXJyb3IpIHtcbiAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICBsb2dTdGF0c0Vycm9yKGVycm9yKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5pbXBsKSB7XG4gICAgICAgICAgICB0aGlzLmltcGwuY2xvc2UoKTtcbiAgICAgICAgICAgIHRoaXMuaW1wbCA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB3aXRoSW1wbChmOiAoaW1wbDogSVN0YXRzSW1wbCwgY2FsbGJhY2s6IGFueSkgPT4gdm9pZCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIF8pID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucmVzZXRUaW1lID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgICAgICAgICBpZiAobm93ID4gdGhpcy5yZXNldFRpbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZHJvcEltcGwoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVzZXRUaW1lID0gbm93ICsgdGhpcy5yZXNldEludGVydmFsO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGYodGhpcy5lbnN1cmVJbXBsKCksIChlcnJvciwgXykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZHJvcEltcGwoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kcm9wSW1wbChlcnJvcik7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgaW5jcmVtZW50KHN0YXQ6IHN0cmluZywgdmFsdWU6IG51bWJlciwgdGFnczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMud2l0aEltcGwoKHN0YXRzLCBjYWxsYmFjaykgPT4gc3RhdHMuaW5jcmVtZW50KHN0YXQsIHZhbHVlLCB0YWdzLCBjYWxsYmFjaykpO1xuICAgIH1cblxuICAgIGdhdWdlKHN0YXQ6IHN0cmluZywgdmFsdWU6IG51bWJlciwgdGFnczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMud2l0aEltcGwoKHN0YXRzLCBjYWxsYmFjaykgPT4gc3RhdHMuZ2F1Z2Uoc3RhdCwgdmFsdWUsIHRhZ3MsIGNhbGxiYWNrKSk7XG4gICAgfVxuXG4gICAgdGltaW5nKHN0YXQ6IHN0cmluZywgdmFsdWU6IG51bWJlciwgdGFnczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMud2l0aEltcGwoKHN0YXRzLCBjYWxsYmFjaykgPT4gc3RhdHMudGltaW5nKHN0YXQsIHZhbHVlLCB0YWdzLCBjYWxsYmFjaykpO1xuICAgIH1cblxuICAgIGNsb3NlKCkge1xuICAgICAgICB0aGlzLmRyb3BJbXBsKCk7XG4gICAgfVxuXG5cbiAgICBzdGF0aWMgY29tYmluZVRhZ3Moc3RhdHM6IElTdGF0cywgdGFnczogc3RyaW5nW10pOiBzdHJpbmdbXSB7XG4gICAgICAgIHJldHVybiAoc3RhdHMgJiYgc3RhdHMuY29uZmlndXJlZFRhZ3MgJiYgc3RhdHMuY29uZmlndXJlZFRhZ3MubGVuZ3RoID4gMClcbiAgICAgICAgICAgID8gc3RhdHMuY29uZmlndXJlZFRhZ3MuY29uY2F0KHRhZ3MpXG4gICAgICAgICAgICA6IHRhZ3M7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgU3RhdHNDb3VudGVyIHtcbiAgICBzdGF0czogSVN0YXRzO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB0YWdzOiBzdHJpbmdbXTtcblxuICAgIGNvbnN0cnVjdG9yKHN0YXRzOiBJU3RhdHMsIG5hbWU6IHN0cmluZywgdGFnczogc3RyaW5nW10pIHtcbiAgICAgICAgdGhpcy5zdGF0cyA9IHN0YXRzO1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICB0aGlzLnRhZ3MgPSBRU3RhdHMuY29tYmluZVRhZ3Moc3RhdHMsIHRhZ3MpO1xuICAgIH1cblxuICAgIGluY3JlbWVudCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdHMuaW5jcmVtZW50KHRoaXMubmFtZSwgMSwgdGhpcy50YWdzKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBTdGF0c0dhdWdlIHtcbiAgICBzdGF0czogSVN0YXRzO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB0YWdzOiBzdHJpbmdbXTtcbiAgICB2YWx1ZTogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3Ioc3RhdHM6IElTdGF0cywgbmFtZTogc3RyaW5nLCB0YWdzOiBzdHJpbmdbXSkge1xuICAgICAgICB0aGlzLnN0YXRzID0gc3RhdHM7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHRoaXMudGFncyA9IFFTdGF0cy5jb21iaW5lVGFncyhzdGF0cywgdGFncyk7XG4gICAgICAgIHRoaXMudmFsdWUgPSAwO1xuICAgIH1cblxuICAgIHNldCh2YWx1ZTogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdHMuZ2F1Z2UodGhpcy5uYW1lLCB0aGlzLnZhbHVlLCB0aGlzLnRhZ3MpO1xuICAgIH1cblxuICAgIGluY3JlbWVudChkZWx0YTogbnVtYmVyID0gMSkge1xuICAgICAgICByZXR1cm4gdGhpcy5zZXQodGhpcy52YWx1ZSArIGRlbHRhKTtcbiAgICB9XG5cbiAgICBkZWNyZW1lbnQoZGVsdGE6IG51bWJlciA9IDEpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0KHRoaXMudmFsdWUgLSBkZWx0YSk7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgU3RhdHNUaW1pbmcge1xuICAgIHN0YXRzOiBJU3RhdHM7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIHRhZ3M6IHN0cmluZ1tdO1xuXG4gICAgY29uc3RydWN0b3Ioc3RhdHM6IElTdGF0cywgbmFtZTogc3RyaW5nLCB0YWdzOiBzdHJpbmdbXSkge1xuICAgICAgICB0aGlzLnN0YXRzID0gc3RhdHM7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHRoaXMudGFncyA9IFFTdGF0cy5jb21iaW5lVGFncyhzdGF0cywgdGFncyk7XG4gICAgfVxuXG4gICAgcmVwb3J0KHZhbHVlOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdHMudGltaW5nKHRoaXMubmFtZSwgdmFsdWUsIHRoaXMudGFncyk7XG4gICAgfVxuXG4gICAgc3RhcnQoKTogKCkgPT4gUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlcG9ydChEYXRlLm5vdygpIC0gc3RhcnQpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZVVybCh1cmw6IHN0cmluZyk6IHtcbiAgICBwcm90b2NvbDogc3RyaW5nLFxuICAgIGhvc3Q6IHN0cmluZyxcbiAgICBwb3J0OiBzdHJpbmcsXG4gICAgcGF0aDogc3RyaW5nLFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG59IHtcbiAgICBjb25zdCBwcm90b2NvbFNlcGFyYXRvclBvcyA9IHVybC5pbmRleE9mKCc6Ly8nKTtcbiAgICBjb25zdCBwcm90b2NvbEVuZCA9IHByb3RvY29sU2VwYXJhdG9yUG9zID49IDAgPyBwcm90b2NvbFNlcGFyYXRvclBvcyArIDMgOiAwO1xuICAgIGNvbnN0IHF1ZXN0aW9uUG9zID0gdXJsLmluZGV4T2YoJz8nLCBwcm90b2NvbEVuZCk7XG4gICAgY29uc3QgcXVlcnlTdGFydCA9IHF1ZXN0aW9uUG9zID49IDAgPyBxdWVzdGlvblBvcyArIDEgOiB1cmwubGVuZ3RoO1xuICAgIGNvbnN0IHBhdGhFbmQgPSBxdWVzdGlvblBvcyA+PSAwID8gcXVlc3Rpb25Qb3MgOiB1cmwubGVuZ3RoO1xuICAgIGNvbnN0IHBhdGhTZXBhcmF0b3JQb3MgPSB1cmwuaW5kZXhPZignLycsIHByb3RvY29sRW5kKTtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tbmVzdGVkLXRlcm5hcnlcbiAgICBjb25zdCBwYXRoU3RhcnQgPSBwYXRoU2VwYXJhdG9yUG9zID49IDBcbiAgICAgICAgPyAocGF0aFNlcGFyYXRvclBvcyA8IHBhdGhFbmQgPyBwYXRoU2VwYXJhdG9yUG9zIDogcGF0aEVuZClcbiAgICAgICAgOiAocXVlc3Rpb25Qb3MgPj0gMCA/IHF1ZXN0aW9uUG9zIDogdXJsLmxlbmd0aCk7XG4gICAgY29uc3QgaG9zdFBvcnQgPSB1cmwuc3Vic3RyaW5nKHByb3RvY29sRW5kLCBwYXRoU3RhcnQpLnNwbGl0KCc6Jyk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgcHJvdG9jb2w6IHVybC5zdWJzdHJpbmcoMCwgcHJvdG9jb2xFbmQpLFxuICAgICAgICBob3N0OiBob3N0UG9ydFswXSxcbiAgICAgICAgcG9ydDogaG9zdFBvcnRbMV0gfHwgJycsXG4gICAgICAgIHBhdGg6IHVybC5zdWJzdHJpbmcocGF0aFN0YXJ0LCBwYXRoRW5kKSxcbiAgICAgICAgcXVlcnk6IHVybC5zdWJzdHJpbmcocXVlcnlTdGFydCksXG4gICAgfTtcbn1cblxudHlwZSBKYWVnZXJDb25maWcgPSB7XG4gICAgc2VydmljZU5hbWU6IHN0cmluZyxcbiAgICBkaXNhYmxlPzogYm9vbGVhbixcbiAgICBzYW1wbGVyOiB7XG4gICAgICAgIHR5cGU6IHN0cmluZyxcbiAgICAgICAgcGFyYW06IG51bWJlcixcbiAgICAgICAgaG9zdFBvcnQ/OiBzdHJpbmcsXG4gICAgICAgIGhvc3Q/OiBzdHJpbmcsXG4gICAgICAgIHBvcnQ/OiBudW1iZXIsXG4gICAgICAgIHJlZnJlc2hJbnRlcnZhbE1zPzogbnVtYmVyLFxuICAgIH0sXG4gICAgcmVwb3J0ZXI6IHtcbiAgICAgICAgbG9nU3BhbnM6IGJvb2xlYW4sXG4gICAgICAgIGFnZW50SG9zdD86IHN0cmluZyxcbiAgICAgICAgYWdlbnRQb3J0PzogbnVtYmVyLFxuICAgICAgICBhZ2VudFNvY2tldFR5cGU/OiBzdHJpbmcsXG4gICAgICAgIGNvbGxlY3RvckVuZHBvaW50Pzogc3RyaW5nLFxuICAgICAgICB1c2VybmFtZT86IHN0cmluZyxcbiAgICAgICAgcGFzc3dvcmQ/OiBzdHJpbmcsXG4gICAgICAgIGZsdXNoSW50ZXJ2YWxNcz86IG51bWJlcixcbiAgICB9LFxuICAgIHRocm90dGxlcj86IHtcbiAgICAgICAgaG9zdDogc3RyaW5nLFxuICAgICAgICBwb3J0OiBudW1iZXIsXG4gICAgICAgIHJlZnJlc2hJbnRlcnZhbE1zOiBudW1iZXIsXG4gICAgfSxcbn1cblxuZXhwb3J0IGNsYXNzIFFUcmFjZXIge1xuICAgIHN0YXRpYyBjb25maWc6IFFDb25maWc7XG5cbiAgICBzdGF0aWMgZ2V0SmFlZ2VyQ29uZmlnKGNvbmZpZzoge1xuICAgICAgICBlbmRwb2ludDogc3RyaW5nLFxuICAgICAgICBzZXJ2aWNlOiBzdHJpbmcsXG4gICAgICAgIHRhZ3M6IHsgW3N0cmluZ106IHN0cmluZyB9XG4gICAgfSk6ID9KYWVnZXJDb25maWcge1xuICAgICAgICBjb25zdCBlbmRwb2ludCA9IGNvbmZpZy5lbmRwb2ludDtcbiAgICAgICAgaWYgKCFlbmRwb2ludCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcGFydHMgPSBwYXJzZVVybChlbmRwb2ludCk7XG4gICAgICAgIHJldHVybiAocGFydHMucHJvdG9jb2wgPT09ICcnKVxuICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgc2VydmljZU5hbWU6IGNvbmZpZy5zZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHNhbXBsZXI6IHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2NvbnN0JyxcbiAgICAgICAgICAgICAgICAgICAgcGFyYW06IDEsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICByZXBvcnRlcjoge1xuICAgICAgICAgICAgICAgICAgICBsb2dTcGFuczogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgYWdlbnRIb3N0OiBwYXJ0cy5ob3N0LFxuICAgICAgICAgICAgICAgICAgICBhZ2VudFBvcnQ6IE51bWJlcihwYXJ0cy5wb3J0KVxuICAgICAgICAgICAgICAgICAgICAsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIDoge1xuICAgICAgICAgICAgICAgIHNlcnZpY2VOYW1lOiBjb25maWcuc2VydmljZSxcbiAgICAgICAgICAgICAgICBzYW1wbGVyOiB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdjb25zdCcsXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtOiAxLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcmVwb3J0ZXI6IHtcbiAgICAgICAgICAgICAgICAgICAgbG9nU3BhbnM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGNvbGxlY3RvckVuZHBvaW50OiBlbmRwb2ludCxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfTtcbiAgICB9XG5cbiAgICBzdGF0aWMgY3JlYXRlKGNvbmZpZzogUUNvbmZpZyk6IFRyYWNlciB7XG4gICAgICAgIFFUcmFjZXIuY29uZmlnID0gY29uZmlnO1xuICAgICAgICBjb25zdCBqYWVnZXJDb25maWcgPSBRVHJhY2VyLmdldEphZWdlckNvbmZpZyhjb25maWcuamFlZ2VyKTtcbiAgICAgICAgaWYgKCFqYWVnZXJDb25maWcpIHtcbiAgICAgICAgICAgIHJldHVybiBub29wVHJhY2VyO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpbml0SmFlZ2VyVHJhY2VyKGphZWdlckNvbmZpZywge1xuICAgICAgICAgICAgbG9nZ2VyOiB7XG4gICAgICAgICAgICAgICAgaW5mbyhtc2cpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0lORk8gJywgbXNnKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGVycm9yKG1zZykge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRVJST1InLCBtc2cpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgbWVzc2FnZVJvb3RTcGFuQ29udGV4dChtZXNzYWdlSWQ6IHN0cmluZyk6ID9TcGFuQ29udGV4dCB7XG4gICAgICAgIGlmICghbWVzc2FnZUlkKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB0cmFjZUlkID0gbWVzc2FnZUlkLnN1YnN0cigwLCAxNik7XG4gICAgICAgIGNvbnN0IHNwYW5JZCA9IG1lc3NhZ2VJZC5zdWJzdHIoMTYsIDE2KTtcbiAgICAgICAgcmV0dXJuIEphZWdlclNwYW5Db250ZXh0LmZyb21TdHJpbmcoYCR7dHJhY2VJZH06JHtzcGFuSWR9OjA6MWApO1xuICAgIH1cblxuICAgIHN0YXRpYyBleHRyYWN0UGFyZW50U3Bhbih0cmFjZXI6IFRyYWNlciwgcmVxOiBhbnkpOiBhbnkge1xuICAgICAgICBsZXQgY3R4X3NyYyxcbiAgICAgICAgICAgIGN0eF9mcm07XG4gICAgICAgIGlmIChyZXEuaGVhZGVycykge1xuICAgICAgICAgICAgY3R4X3NyYyA9IHJlcS5oZWFkZXJzO1xuICAgICAgICAgICAgY3R4X2ZybSA9IEZPUk1BVF9URVhUX01BUDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGN0eF9zcmMgPSByZXEuY29udGV4dDtcbiAgICAgICAgICAgIGN0eF9mcm0gPSBGT1JNQVRfQklOQVJZO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cmFjZXIuZXh0cmFjdChjdHhfZnJtLCBjdHhfc3JjKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZ2V0UGFyZW50U3Bhbih0cmFjZXI6IFRyYWNlciwgY29udGV4dDogYW55KTogKFNwYW5Db250ZXh0IHwgdHlwZW9mIHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm4gY29udGV4dC50cmFjZXJQYXJlbnRTcGFuO1xuICAgIH1cblxuICAgIHN0YXRpYyBmYWlsZWQodHJhY2VyOiBUcmFjZXIsIHNwYW46IFNwYW4sIGVycm9yOiBhbnkpIHtcbiAgICAgICAgc3Bhbi5sb2coe1xuICAgICAgICAgICAgZXZlbnQ6ICdmYWlsZWQnLFxuICAgICAgICAgICAgcGF5bG9hZDogdG9Mb2coZXJyb3IpLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgdHJhY2U8VD4oXG4gICAgICAgIHRyYWNlcjogVHJhY2VyLFxuICAgICAgICBuYW1lOiBzdHJpbmcsXG4gICAgICAgIGY6IChzcGFuOiBTcGFuKSA9PiBQcm9taXNlPFQ+LFxuICAgICAgICBwYXJlbnRTcGFuPzogKFNwYW4gfCBTcGFuQ29udGV4dCksXG4gICAgKTogUHJvbWlzZTxUPiB7XG4gICAgICAgIGNvbnN0IHNwYW4gPSB0cmFjZXIuc3RhcnRTcGFuKG5hbWUsIHsgY2hpbGRPZjogcGFyZW50U3BhbiB9KTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHNwYW4uc2V0VGFnKFRhZ3MuU1BBTl9LSU5ELCAnc2VydmVyJyk7XG4gICAgICAgICAgICBPYmplY3QuZW50cmllcyhRVHJhY2VyLmNvbmZpZy5qYWVnZXIudGFncykuZm9yRWFjaCgoW25hbWUsIHZhbHVlXSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChuYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIHNwYW4uc2V0VGFnKG5hbWUsIHZhbHVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGYoc3Bhbik7XG4gICAgICAgICAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBzcGFuLnNldFRhZygncmVzdWx0JywgdG9Mb2cocmVzdWx0KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzcGFuLmZpbmlzaCgpO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnN0IGNsZWFuZWQgPSBjbGVhbkVycm9yKGVycm9yKTtcbiAgICAgICAgICAgIFFUcmFjZXIuZmFpbGVkKHRyYWNlciwgc3BhbiwgY2xlYW5lZCk7XG4gICAgICAgICAgICBzcGFuLmZpbmlzaCgpO1xuICAgICAgICAgICAgdGhyb3cgY2xlYW5lZDtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==