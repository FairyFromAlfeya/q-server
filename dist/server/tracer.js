"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.QTracer = exports.StatsTiming = exports.StatsGauge = exports.StatsCounter = exports.QStats = void 0;

var _config = require("./config");

var _noop = require("opentracing/lib/noop");

var _nodeStatsd = _interopRequireDefault(require("node-statsd"));

var _opentracing = require("opentracing");

var _jaegerClient = require("jaeger-client");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function dummy(stat, value, sampleRate, tags) {}

function logStatsError(error) {
  console.log(`StatsD send failed: ${error.message}`);
}

const dummyStats = {
  configuredTags: [],
  increment: dummy,
  decrement: dummy,
  histogram: dummy,
  gauge: dummy,
  set: dummy,
  timing: dummy
};

class QStats {
  static create(server, configuredTags) {
    if (!server) {
      return dummyStats;
    }

    const hostPort = server.split(':');
    let stats = null;

    const withStats = f => {
      try {
        f(stats || (() => {
          const newStats = new _nodeStatsd.default(hostPort[0], hostPort[1], _config.STATS.prefix);
          newStats.socket.on("error", err => {
            logStatsError(err);
            stats = null;
          });
          stats = newStats;
          return newStats;
        })());
      } catch (e) {
        logStatsError(e);
        stats = null;
      }
    };

    return {
      increment(stat, value, sampleRate, tags) {
        withStats(stats => stats.increment(stat, value, sampleRate, tags));
      },

      decrement(stat, value, sampleRate, tags) {
        withStats(stats => stats.decrement(stat, value, sampleRate, tags));
      },

      histogram(stat, value, sampleRate, tags) {
        withStats(stats => stats.histogram(stat, value, sampleRate, tags));
      },

      gauge(stat, value, sampleRate, tags) {
        withStats(stats => stats.gauge(stat, value, sampleRate, tags));
      },

      set(stat, value, sampleRate, tags) {
        withStats(stats => stats.set(stat, value, sampleRate, tags));
      },

      timing(stat, value, sampleRate, tags) {
        withStats(stats => stats.timing(stat, value, sampleRate, tags));
      },

      configuredTags
    };
  }

  static combineTags(stats, tags) {
    return stats && stats.configuredTags && stats.configuredTags.length > 0 ? stats.configuredTags.concat(tags) : tags;
  }

}

exports.QStats = QStats;

class StatsCounter {
  constructor(stats, name, tags) {
    this.stats = stats;
    this.name = name;
    this.tags = QStats.combineTags(stats, tags);
  }

  increment() {
    this.stats.increment(this.name, 1, this.tags);
  }

}

exports.StatsCounter = StatsCounter;

class StatsGauge {
  constructor(stats, name, tags) {
    this.stats = stats;
    this.name = name;
    this.tags = QStats.combineTags(stats, tags);
    this.value = 0;
  }

  set(value) {
    this.value = value;
    this.stats.gauge(this.name, this.value, this.tags);
  }

  increment(delta = 1) {
    this.set(this.value + delta);
  }

  decrement(delta = 1) {
    this.set(this.value - delta);
  }

}

exports.StatsGauge = StatsGauge;

class StatsTiming {
  constructor(stats, name, tags) {
    this.stats = stats;
    this.name = name;
    this.tags = QStats.combineTags(stats, tags);
  }

  report(value) {
    this.stats.timing(this.name, value, this.tags);
  }

  start() {
    const start = Date.now();
    return () => {
      this.report(Date.now() - start);
    };
  }

}

exports.StatsTiming = StatsTiming;

function parseUrl(url) {
  const protocolSeparatorPos = url.indexOf('://');
  const protocolEnd = protocolSeparatorPos >= 0 ? protocolSeparatorPos + 3 : 0;
  const questionPos = url.indexOf('?', protocolEnd);
  const queryStart = questionPos >= 0 ? questionPos + 1 : url.length;
  const pathEnd = questionPos >= 0 ? questionPos : url.length;
  const pathSeparatorPos = url.indexOf('/', protocolEnd); // eslint-disable-next-line no-nested-ternary

  const pathStart = pathSeparatorPos >= 0 ? pathSeparatorPos < pathEnd ? pathSeparatorPos : pathEnd : questionPos >= 0 ? questionPos : url.length;
  const hostPort = url.substring(protocolEnd, pathStart).split(':');
  return {
    protocol: url.substring(0, protocolEnd),
    host: hostPort[0],
    port: hostPort[1] || '',
    path: url.substring(pathStart, pathEnd),
    query: url.substring(queryStart)
  };
}

class QTracer {
  static getJaegerConfig(config) {
    const endpoint = config.endpoint;

    if (!endpoint) {
      return null;
    }

    const parts = parseUrl(endpoint);
    return parts.protocol === '' ? {
      serviceName: config.service,
      sampler: {
        type: 'const',
        param: 1
      },
      reporter: {
        logSpans: true,
        agentHost: parts.host,
        agentPort: Number(parts.port)
      }
    } : {
      serviceName: config.service,
      sampler: {
        type: 'const',
        param: 1
      },
      reporter: {
        logSpans: true,
        collectorEndpoint: endpoint
      }
    };
  }

  static create(config) {
    QTracer.config = config;
    const jaegerConfig = QTracer.getJaegerConfig(config.jaeger);

    if (!jaegerConfig) {
      return _noop.tracer;
    }

    return (0, _jaegerClient.initTracerFromEnv)(jaegerConfig, {
      logger: {
        info(msg) {
          console.log('INFO ', msg);
        },

        error(msg) {
          console.log('ERROR', msg);
        }

      }
    });
  }

  static messageRootSpanContext(messageId) {
    if (!messageId) {
      return null;
    }

    const traceId = messageId.substr(0, 16);
    const spanId = messageId.substr(16, 16);
    return _jaegerClient.SpanContext.fromString(`${traceId}:${spanId}:0:1`);
  }

  static extractParentSpan(tracer, req) {
    let ctx_src, ctx_frm;

    if (req.headers) {
      ctx_src = req.headers;
      ctx_frm = _opentracing.FORMAT_TEXT_MAP;
    } else {
      ctx_src = req.context;
      ctx_frm = _opentracing.FORMAT_BINARY;
    }

    return tracer.extract(ctx_frm, ctx_src);
  }

  static getParentSpan(tracer, context) {
    return context.tracerParentSpan;
  }

  static failed(tracer, span, error) {
    span.log({
      event: 'failed',
      payload: (0, _utils.toLog)(error)
    });
  }

  static async trace(tracer, name, f, parentSpan) {
    const span = tracer.startSpan(name, {
      childOf: parentSpan
    });

    try {
      span.setTag(_opentracing.Tags.SPAN_KIND, 'server');
      Object.entries(QTracer.config.jaeger.tags).forEach(([name, value]) => {
        if (name) {
          span.setTag(name, value);
        }
      });
      const result = await f(span);

      if (result !== undefined) {
        span.setTag('result', (0, _utils.toLog)(result));
      }

      span.finish();
      return result;
    } catch (error) {
      const cleaned = (0, _utils.cleanError)(error);
      QTracer.failed(tracer, span, cleaned);
      span.finish();
      throw cleaned;
    }
  }

}

exports.QTracer = QTracer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvdHJhY2VyLmpzIl0sIm5hbWVzIjpbImR1bW15Iiwic3RhdCIsInZhbHVlIiwic2FtcGxlUmF0ZSIsInRhZ3MiLCJsb2dTdGF0c0Vycm9yIiwiZXJyb3IiLCJjb25zb2xlIiwibG9nIiwibWVzc2FnZSIsImR1bW15U3RhdHMiLCJjb25maWd1cmVkVGFncyIsImluY3JlbWVudCIsImRlY3JlbWVudCIsImhpc3RvZ3JhbSIsImdhdWdlIiwic2V0IiwidGltaW5nIiwiUVN0YXRzIiwiY3JlYXRlIiwic2VydmVyIiwiaG9zdFBvcnQiLCJzcGxpdCIsInN0YXRzIiwid2l0aFN0YXRzIiwiZiIsIm5ld1N0YXRzIiwiU3RhdHNEIiwiU1RBVFMiLCJwcmVmaXgiLCJzb2NrZXQiLCJvbiIsImVyciIsImUiLCJjb21iaW5lVGFncyIsImxlbmd0aCIsImNvbmNhdCIsIlN0YXRzQ291bnRlciIsImNvbnN0cnVjdG9yIiwibmFtZSIsIlN0YXRzR2F1Z2UiLCJkZWx0YSIsIlN0YXRzVGltaW5nIiwicmVwb3J0Iiwic3RhcnQiLCJEYXRlIiwibm93IiwicGFyc2VVcmwiLCJ1cmwiLCJwcm90b2NvbFNlcGFyYXRvclBvcyIsImluZGV4T2YiLCJwcm90b2NvbEVuZCIsInF1ZXN0aW9uUG9zIiwicXVlcnlTdGFydCIsInBhdGhFbmQiLCJwYXRoU2VwYXJhdG9yUG9zIiwicGF0aFN0YXJ0Iiwic3Vic3RyaW5nIiwicHJvdG9jb2wiLCJob3N0IiwicG9ydCIsInBhdGgiLCJxdWVyeSIsIlFUcmFjZXIiLCJnZXRKYWVnZXJDb25maWciLCJjb25maWciLCJlbmRwb2ludCIsInBhcnRzIiwic2VydmljZU5hbWUiLCJzZXJ2aWNlIiwic2FtcGxlciIsInR5cGUiLCJwYXJhbSIsInJlcG9ydGVyIiwibG9nU3BhbnMiLCJhZ2VudEhvc3QiLCJhZ2VudFBvcnQiLCJOdW1iZXIiLCJjb2xsZWN0b3JFbmRwb2ludCIsImphZWdlckNvbmZpZyIsImphZWdlciIsIm5vb3BUcmFjZXIiLCJsb2dnZXIiLCJpbmZvIiwibXNnIiwibWVzc2FnZVJvb3RTcGFuQ29udGV4dCIsIm1lc3NhZ2VJZCIsInRyYWNlSWQiLCJzdWJzdHIiLCJzcGFuSWQiLCJKYWVnZXJTcGFuQ29udGV4dCIsImZyb21TdHJpbmciLCJleHRyYWN0UGFyZW50U3BhbiIsInRyYWNlciIsInJlcSIsImN0eF9zcmMiLCJjdHhfZnJtIiwiaGVhZGVycyIsIkZPUk1BVF9URVhUX01BUCIsImNvbnRleHQiLCJGT1JNQVRfQklOQVJZIiwiZXh0cmFjdCIsImdldFBhcmVudFNwYW4iLCJ0cmFjZXJQYXJlbnRTcGFuIiwiZmFpbGVkIiwic3BhbiIsImV2ZW50IiwicGF5bG9hZCIsInRyYWNlIiwicGFyZW50U3BhbiIsInN0YXJ0U3BhbiIsImNoaWxkT2YiLCJzZXRUYWciLCJUYWdzIiwiU1BBTl9LSU5EIiwiT2JqZWN0IiwiZW50cmllcyIsImZvckVhY2giLCJyZXN1bHQiLCJ1bmRlZmluZWQiLCJmaW5pc2giLCJjbGVhbmVkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBSUE7Ozs7QUFrQkEsU0FBU0EsS0FBVCxDQUFlQyxJQUFmLEVBQTZCQyxLQUE3QixFQUE2Q0MsVUFBN0MsRUFBNkVDLElBQTdFLEVBQThGLENBQzdGOztBQUVELFNBQVNDLGFBQVQsQ0FBdUJDLEtBQXZCLEVBQW1DO0FBQy9CQyxFQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBYSx1QkFBc0JGLEtBQUssQ0FBQ0csT0FBUSxFQUFqRDtBQUNIOztBQUVELE1BQU1DLFVBQWtCLEdBQUc7QUFDdkJDLEVBQUFBLGNBQWMsRUFBRSxFQURPO0FBRXZCQyxFQUFBQSxTQUFTLEVBQUVaLEtBRlk7QUFHdkJhLEVBQUFBLFNBQVMsRUFBRWIsS0FIWTtBQUl2QmMsRUFBQUEsU0FBUyxFQUFFZCxLQUpZO0FBS3ZCZSxFQUFBQSxLQUFLLEVBQUVmLEtBTGdCO0FBTXZCZ0IsRUFBQUEsR0FBRyxFQUFFaEIsS0FOa0I7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O0FBQ0g7QUFDSixPQUpEO0FBS0EsWUFBTW9ILE1BQU0sR0FBRyxNQUFNN0YsQ0FBQyxDQUFDZ0YsSUFBRCxDQUF0Qjs7QUFDQSxVQUFJYSxNQUFNLEtBQUtDLFNBQWYsRUFBMEI7QUFDdEJkLFFBQUFBLElBQUksQ0FBQ08sTUFBTCxDQUFZLFFBQVosRUFBc0Isa0JBQU1NLE1BQU4sQ0FBdEI7QUFDSDs7QUFDRGIsTUFBQUEsSUFBSSxDQUFDZSxNQUFMO0FBQ0EsYUFBT0YsTUFBUDtBQUNILEtBYkQsQ0FhRSxPQUFPaEgsS0FBUCxFQUFjO0FBQ1osWUFBTW1ILE9BQU8sR0FBRyx1QkFBV25ILEtBQVgsQ0FBaEI7QUFDQXlELE1BQUFBLE9BQU8sQ0FBQ3lDLE1BQVIsQ0FBZVgsTUFBZixFQUF1QlksSUFBdkIsRUFBNkJnQixPQUE3QjtBQUNBaEIsTUFBQUEsSUFBSSxDQUFDZSxNQUFMO0FBQ0EsWUFBTUMsT0FBTjtBQUNIO0FBQ0o7O0FBckhnQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB7IFNUQVRTIH0gZnJvbSAnLi9jb25maWcnO1xuaW1wb3J0IHR5cGUgeyBRQ29uZmlnIH0gZnJvbSBcIi4vY29uZmlnXCI7XG5pbXBvcnQgeyB0cmFjZXIgYXMgbm9vcFRyYWNlciB9IGZyb20gXCJvcGVudHJhY2luZy9saWIvbm9vcFwiO1xuaW1wb3J0IFN0YXRzRCBmcm9tICdub2RlLXN0YXRzZCc7XG5pbXBvcnQgeyBUcmFjZXIsIFRhZ3MsIEZPUk1BVF9URVhUX01BUCwgRk9STUFUX0JJTkFSWSwgU3BhbiwgU3BhbkNvbnRleHQgfSBmcm9tIFwib3BlbnRyYWNpbmdcIjtcblxuaW1wb3J0IHtcbiAgICBpbml0VHJhY2VyRnJvbUVudiBhcyBpbml0SmFlZ2VyVHJhY2VyLFxuICAgIFNwYW5Db250ZXh0IGFzIEphZWdlclNwYW5Db250ZXh0LFxufSBmcm9tICdqYWVnZXItY2xpZW50JztcbmltcG9ydCB7IGNsZWFuRXJyb3IsIHRvTG9nIH0gZnJvbSBcIi4vdXRpbHNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBJU3RhdHMge1xuICAgIGNvbmZpZ3VyZWRUYWdzOiBzdHJpbmdbXSxcblxuICAgIGluY3JlbWVudChzdGF0OiBzdHJpbmcsIHZhbHVlPzogbnVtYmVyLCBzYW1wbGVSYXRlPzogbnVtYmVyIHwgc3RyaW5nW10sIHRhZ3M/OiBzdHJpbmdbXSk6IHZvaWQsXG5cbiAgICBkZWNyZW1lbnQoc3RhdDogc3RyaW5nLCB2YWx1ZT86IG51bWJlciwgc2FtcGxlUmF0ZT86IG51bWJlciB8IHN0cmluZ1tdLCB0YWdzPzogc3RyaW5nW10pOiB2b2lkLFxuXG4gICAgaGlzdG9ncmFtKHN0YXQ6IHN0cmluZywgdmFsdWU6IG51bWJlciwgc2FtcGxlUmF0ZT86IG51bWJlciB8IHN0cmluZ1tdLCB0YWdzPzogc3RyaW5nW10pOiB2b2lkLFxuXG4gICAgZ2F1Z2Uoc3RhdDogc3RyaW5nLCB2YWx1ZTogbnVtYmVyLCBzYW1wbGVSYXRlPzogbnVtYmVyIHwgc3RyaW5nW10sIHRhZ3M/OiBzdHJpbmdbXSk6IHZvaWQsXG5cbiAgICBzZXQoc3RhdDogc3RyaW5nLCB2YWx1ZTogbnVtYmVyLCBzYW1wbGVSYXRlPzogbnVtYmVyIHwgc3RyaW5nW10sIHRhZ3M/OiBzdHJpbmdbXSk6IHZvaWQsXG5cbiAgICB0aW1pbmcoc3RhdDogc3RyaW5nLCB2YWx1ZTogbnVtYmVyLCBzYW1wbGVSYXRlPzogbnVtYmVyIHwgc3RyaW5nW10sIHRhZ3M/OiBzdHJpbmdbXSk6IHZvaWQsXG59XG5cbmZ1bmN0aW9uIGR1bW15KHN0YXQ6IHN0cmluZywgdmFsdWU/OiBudW1iZXIsIHNhbXBsZVJhdGU/OiBudW1iZXIgfCBzdHJpbmdbXSwgdGFncz86IHN0cmluZ1tdKSB7XG59XG5cbmZ1bmN0aW9uIGxvZ1N0YXRzRXJyb3IoZXJyb3I6IGFueSkge1xuICAgIGNvbnNvbGUubG9nKGBTdGF0c0Qgc2VuZCBmYWlsZWQ6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbn1cblxuY29uc3QgZHVtbXlTdGF0czogSVN0YXRzID0ge1xuICAgIGNvbmZpZ3VyZWRUYWdzOiBbXSxcbiAgICBpbmNyZW1lbnQ6IGR1bW15LFxuICAgIGRlY3JlbWVudDogZHVtbXksXG4gICAgaGlzdG9ncmFtOiBkdW1teSxcbiAgICBnYXVnZTogZHVtbXksXG4gICAgc2V0OiBkdW1teSxcbiAgICB0aW1pbmc6IGR1bW15LFxufTtcblxuZXhwb3J0IGNsYXNzIFFTdGF0cyB7XG4gICAgc3RhdGljIGNyZWF0ZShzZXJ2ZXI6IHN0cmluZywgY29uZmlndXJlZFRhZ3M6IHN0cmluZ1tdKTogSVN0YXRzIHtcbiAgICAgICAgaWYgKCFzZXJ2ZXIpIHtcbiAgICAgICAgICAgIHJldHVybiBkdW1teVN0YXRzO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGhvc3RQb3J0ID0gc2VydmVyLnNwbGl0KCc6Jyk7XG4gICAgICAgIGxldCBzdGF0czogP0lTdGF0cyA9IG51bGw7XG4gICAgICAgIGNvbnN0IHdpdGhTdGF0cyA9IChmOiAoc3RhdHM6IElTdGF0cykgPT4gdm9pZCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBmKHN0YXRzIHx8ICgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld1N0YXRzID0gbmV3IFN0YXRzRChob3N0UG9ydFswXSwgaG9zdFBvcnRbMV0sIFNUQVRTLnByZWZpeCk7XG4gICAgICAgICAgICAgICAgICAgIG5ld1N0YXRzLnNvY2tldC5vbihcImVycm9yXCIsIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1N0YXRzRXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRzID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRzID0gbmV3U3RhdHM7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXdTdGF0cztcbiAgICAgICAgICAgICAgICB9KSgpKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBsb2dTdGF0c0Vycm9yKGUpO1xuICAgICAgICAgICAgICAgIHN0YXRzID0gbnVsbDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBpbmNyZW1lbnQoc3RhdDogc3RyaW5nLCB2YWx1ZT86IG51bWJlciwgc2FtcGxlUmF0ZT86IG51bWJlciB8IHN0cmluZ1tdLCB0YWdzPzogc3RyaW5nW10pOiB2b2lkIHtcbiAgICAgICAgICAgICAgICB3aXRoU3RhdHMoc3RhdHMgPT4gc3RhdHMuaW5jcmVtZW50KHN0YXQsIHZhbHVlLCBzYW1wbGVSYXRlLCB0YWdzKSk7XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBkZWNyZW1lbnQoc3RhdDogc3RyaW5nLCB2YWx1ZT86IG51bWJlciwgc2FtcGxlUmF0ZT86IG51bWJlciB8IHN0cmluZ1tdLCB0YWdzPzogc3RyaW5nW10pOiB2b2lkIHtcbiAgICAgICAgICAgICAgICB3aXRoU3RhdHMoc3RhdHMgPT4gc3RhdHMuZGVjcmVtZW50KHN0YXQsIHZhbHVlLCBzYW1wbGVSYXRlLCB0YWdzKSk7XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBoaXN0b2dyYW0oc3RhdDogc3RyaW5nLCB2YWx1ZTogbnVtYmVyLCBzYW1wbGVSYXRlPzogbnVtYmVyIHwgc3RyaW5nW10sIHRhZ3M/OiBzdHJpbmdbXSk6IHZvaWQge1xuICAgICAgICAgICAgICAgIHdpdGhTdGF0cyhzdGF0cyA9PiBzdGF0cy5oaXN0b2dyYW0oc3RhdCwgdmFsdWUsIHNhbXBsZVJhdGUsIHRhZ3MpKTtcbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgIGdhdWdlKHN0YXQ6IHN0cmluZywgdmFsdWU6IG51bWJlciwgc2FtcGxlUmF0ZT86IG51bWJlciB8IHN0cmluZ1tdLCB0YWdzPzogc3RyaW5nW10pOiB2b2lkIHtcbiAgICAgICAgICAgICAgICB3aXRoU3RhdHMoc3RhdHMgPT4gc3RhdHMuZ2F1Z2Uoc3RhdCwgdmFsdWUsIHNhbXBsZVJhdGUsIHRhZ3MpKTtcbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgIHNldChzdGF0OiBzdHJpbmcsIHZhbHVlOiBudW1iZXIsIHNhbXBsZVJhdGU/OiBudW1iZXIgfCBzdHJpbmdbXSwgdGFncz86IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgICAgICAgICAgICAgd2l0aFN0YXRzKHN0YXRzID0+IHN0YXRzLnNldChzdGF0LCB2YWx1ZSwgc2FtcGxlUmF0ZSwgdGFncykpO1xuICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgdGltaW5nKHN0YXQ6IHN0cmluZywgdmFsdWU6IG51bWJlciwgc2FtcGxlUmF0ZT86IG51bWJlciB8IHN0cmluZ1tdLCB0YWdzPzogc3RyaW5nW10pOiB2b2lkIHtcbiAgICAgICAgICAgICAgICB3aXRoU3RhdHMoc3RhdHMgPT4gc3RhdHMudGltaW5nKHN0YXQsIHZhbHVlLCBzYW1wbGVSYXRlLCB0YWdzKSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgY29uZmlndXJlZFRhZ3MsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgc3RhdGljIGNvbWJpbmVUYWdzKHN0YXRzOiBJU3RhdHMsIHRhZ3M6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xuICAgICAgICByZXR1cm4gKHN0YXRzICYmIHN0YXRzLmNvbmZpZ3VyZWRUYWdzICYmIHN0YXRzLmNvbmZpZ3VyZWRUYWdzLmxlbmd0aCA+IDApXG4gICAgICAgICAgICA/IHN0YXRzLmNvbmZpZ3VyZWRUYWdzLmNvbmNhdCh0YWdzKVxuICAgICAgICAgICAgOiB0YWdzO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFN0YXRzQ291bnRlciB7XG4gICAgc3RhdHM6IElTdGF0cztcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgdGFnczogc3RyaW5nW107XG5cbiAgICBjb25zdHJ1Y3RvcihzdGF0czogSVN0YXRzLCBuYW1lOiBzdHJpbmcsIHRhZ3M6IHN0cmluZ1tdKSB7XG4gICAgICAgIHRoaXMuc3RhdHMgPSBzdGF0cztcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgdGhpcy50YWdzID0gUVN0YXRzLmNvbWJpbmVUYWdzKHN0YXRzLCB0YWdzKTtcbiAgICB9XG5cbiAgICBpbmNyZW1lbnQoKSB7XG4gICAgICAgIHRoaXMuc3RhdHMuaW5jcmVtZW50KHRoaXMubmFtZSwgMSwgdGhpcy50YWdzKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBTdGF0c0dhdWdlIHtcbiAgICBzdGF0czogSVN0YXRzO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB0YWdzOiBzdHJpbmdbXTtcbiAgICB2YWx1ZTogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3Ioc3RhdHM6IElTdGF0cywgbmFtZTogc3RyaW5nLCB0YWdzOiBzdHJpbmdbXSkge1xuICAgICAgICB0aGlzLnN0YXRzID0gc3RhdHM7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHRoaXMudGFncyA9IFFTdGF0cy5jb21iaW5lVGFncyhzdGF0cywgdGFncyk7XG4gICAgICAgIHRoaXMudmFsdWUgPSAwO1xuICAgIH1cblxuICAgIHNldCh2YWx1ZTogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcbiAgICAgICAgdGhpcy5zdGF0cy5nYXVnZSh0aGlzLm5hbWUsIHRoaXMudmFsdWUsIHRoaXMudGFncyk7XG4gICAgfVxuXG4gICAgaW5jcmVtZW50KGRlbHRhOiBudW1iZXIgPSAxKSB7XG4gICAgICAgIHRoaXMuc2V0KHRoaXMudmFsdWUgKyBkZWx0YSk7XG4gICAgfVxuXG4gICAgZGVjcmVtZW50KGRlbHRhOiBudW1iZXIgPSAxKSB7XG4gICAgICAgIHRoaXMuc2V0KHRoaXMudmFsdWUgLSBkZWx0YSk7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgU3RhdHNUaW1pbmcge1xuICAgIHN0YXRzOiBJU3RhdHM7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIHRhZ3M6IHN0cmluZ1tdO1xuXG4gICAgY29uc3RydWN0b3Ioc3RhdHM6IElTdGF0cywgbmFtZTogc3RyaW5nLCB0YWdzOiBzdHJpbmdbXSkge1xuICAgICAgICB0aGlzLnN0YXRzID0gc3RhdHM7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHRoaXMudGFncyA9IFFTdGF0cy5jb21iaW5lVGFncyhzdGF0cywgdGFncyk7XG4gICAgfVxuXG4gICAgcmVwb3J0KHZhbHVlOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5zdGF0cy50aW1pbmcodGhpcy5uYW1lLCB2YWx1ZSwgdGhpcy50YWdzKTtcbiAgICB9XG5cbiAgICBzdGFydCgpOiAoKSA9PiB2b2lkIHtcbiAgICAgICAgY29uc3Qgc3RhcnQgPSBEYXRlLm5vdygpO1xuICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZXBvcnQoRGF0ZS5ub3coKSAtIHN0YXJ0KTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VVcmwodXJsOiBzdHJpbmcpOiB7XG4gICAgcHJvdG9jb2w6IHN0cmluZyxcbiAgICBob3N0OiBzdHJpbmcsXG4gICAgcG9ydDogc3RyaW5nLFxuICAgIHBhdGg6IHN0cmluZyxcbiAgICBxdWVyeTogc3RyaW5nLFxufSB7XG4gICAgY29uc3QgcHJvdG9jb2xTZXBhcmF0b3JQb3MgPSB1cmwuaW5kZXhPZignOi8vJyk7XG4gICAgY29uc3QgcHJvdG9jb2xFbmQgPSBwcm90b2NvbFNlcGFyYXRvclBvcyA+PSAwID8gcHJvdG9jb2xTZXBhcmF0b3JQb3MgKyAzIDogMDtcbiAgICBjb25zdCBxdWVzdGlvblBvcyA9IHVybC5pbmRleE9mKCc/JywgcHJvdG9jb2xFbmQpO1xuICAgIGNvbnN0IHF1ZXJ5U3RhcnQgPSBxdWVzdGlvblBvcyA+PSAwID8gcXVlc3Rpb25Qb3MgKyAxIDogdXJsLmxlbmd0aDtcbiAgICBjb25zdCBwYXRoRW5kID0gcXVlc3Rpb25Qb3MgPj0gMCA/IHF1ZXN0aW9uUG9zIDogdXJsLmxlbmd0aDtcbiAgICBjb25zdCBwYXRoU2VwYXJhdG9yUG9zID0gdXJsLmluZGV4T2YoJy8nLCBwcm90b2NvbEVuZCk7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLW5lc3RlZC10ZXJuYXJ5XG4gICAgY29uc3QgcGF0aFN0YXJ0ID0gcGF0aFNlcGFyYXRvclBvcyA+PSAwXG4gICAgICAgID8gKHBhdGhTZXBhcmF0b3JQb3MgPCBwYXRoRW5kID8gcGF0aFNlcGFyYXRvclBvcyA6IHBhdGhFbmQpXG4gICAgICAgIDogKHF1ZXN0aW9uUG9zID49IDAgPyBxdWVzdGlvblBvcyA6IHVybC5sZW5ndGgpO1xuICAgIGNvbnN0IGhvc3RQb3J0ID0gdXJsLnN1YnN0cmluZyhwcm90b2NvbEVuZCwgcGF0aFN0YXJ0KS5zcGxpdCgnOicpO1xuICAgIHJldHVybiB7XG4gICAgICAgIHByb3RvY29sOiB1cmwuc3Vic3RyaW5nKDAsIHByb3RvY29sRW5kKSxcbiAgICAgICAgaG9zdDogaG9zdFBvcnRbMF0sXG4gICAgICAgIHBvcnQ6IGhvc3RQb3J0WzFdIHx8ICcnLFxuICAgICAgICBwYXRoOiB1cmwuc3Vic3RyaW5nKHBhdGhTdGFydCwgcGF0aEVuZCksXG4gICAgICAgIHF1ZXJ5OiB1cmwuc3Vic3RyaW5nKHF1ZXJ5U3RhcnQpLFxuICAgIH07XG59XG5cbnR5cGUgSmFlZ2VyQ29uZmlnID0ge1xuICAgIHNlcnZpY2VOYW1lOiBzdHJpbmcsXG4gICAgZGlzYWJsZT86IGJvb2xlYW4sXG4gICAgc2FtcGxlcjoge1xuICAgICAgICB0eXBlOiBzdHJpbmcsXG4gICAgICAgIHBhcmFtOiBudW1iZXIsXG4gICAgICAgIGhvc3RQb3J0Pzogc3RyaW5nLFxuICAgICAgICBob3N0Pzogc3RyaW5nLFxuICAgICAgICBwb3J0PzogbnVtYmVyLFxuICAgICAgICByZWZyZXNoSW50ZXJ2YWxNcz86IG51bWJlcixcbiAgICB9LFxuICAgIHJlcG9ydGVyOiB7XG4gICAgICAgIGxvZ1NwYW5zOiBib29sZWFuLFxuICAgICAgICBhZ2VudEhvc3Q/OiBzdHJpbmcsXG4gICAgICAgIGFnZW50UG9ydD86IG51bWJlcixcbiAgICAgICAgYWdlbnRTb2NrZXRUeXBlPzogc3RyaW5nLFxuICAgICAgICBjb2xsZWN0b3JFbmRwb2ludD86IHN0cmluZyxcbiAgICAgICAgdXNlcm5hbWU/OiBzdHJpbmcsXG4gICAgICAgIHBhc3N3b3JkPzogc3RyaW5nLFxuICAgICAgICBmbHVzaEludGVydmFsTXM/OiBudW1iZXIsXG4gICAgfSxcbiAgICB0aHJvdHRsZXI/OiB7XG4gICAgICAgIGhvc3Q6IHN0cmluZyxcbiAgICAgICAgcG9ydDogbnVtYmVyLFxuICAgICAgICByZWZyZXNoSW50ZXJ2YWxNczogbnVtYmVyLFxuICAgIH0sXG59XG5cbmV4cG9ydCBjbGFzcyBRVHJhY2VyIHtcbiAgICBzdGF0aWMgY29uZmlnOiBRQ29uZmlnO1xuXG4gICAgc3RhdGljIGdldEphZWdlckNvbmZpZyhjb25maWc6IHtcbiAgICAgICAgZW5kcG9pbnQ6IHN0cmluZyxcbiAgICAgICAgc2VydmljZTogc3RyaW5nLFxuICAgICAgICB0YWdzOiB7IFtzdHJpbmddOiBzdHJpbmcgfVxuICAgIH0pOiA/SmFlZ2VyQ29uZmlnIHtcbiAgICAgICAgY29uc3QgZW5kcG9pbnQgPSBjb25maWcuZW5kcG9pbnQ7XG4gICAgICAgIGlmICghZW5kcG9pbnQpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBhcnRzID0gcGFyc2VVcmwoZW5kcG9pbnQpO1xuICAgICAgICByZXR1cm4gKHBhcnRzLnByb3RvY29sID09PSAnJylcbiAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgIHNlcnZpY2VOYW1lOiBjb25maWcuc2VydmljZSxcbiAgICAgICAgICAgICAgICBzYW1wbGVyOiB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdjb25zdCcsXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtOiAxLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcmVwb3J0ZXI6IHtcbiAgICAgICAgICAgICAgICAgICAgbG9nU3BhbnM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGFnZW50SG9zdDogcGFydHMuaG9zdCxcbiAgICAgICAgICAgICAgICAgICAgYWdlbnRQb3J0OiBOdW1iZXIocGFydHMucG9ydClcbiAgICAgICAgICAgICAgICAgICAgLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICA6IHtcbiAgICAgICAgICAgICAgICBzZXJ2aWNlTmFtZTogY29uZmlnLnNlcnZpY2UsXG4gICAgICAgICAgICAgICAgc2FtcGxlcjoge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnY29uc3QnLFxuICAgICAgICAgICAgICAgICAgICBwYXJhbTogMSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHJlcG9ydGVyOiB7XG4gICAgICAgICAgICAgICAgICAgIGxvZ1NwYW5zOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBjb2xsZWN0b3JFbmRwb2ludDogZW5kcG9pbnQsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH07XG4gICAgfVxuXG4gICAgc3RhdGljIGNyZWF0ZShjb25maWc6IFFDb25maWcpOiBUcmFjZXIge1xuICAgICAgICBRVHJhY2VyLmNvbmZpZyA9IGNvbmZpZztcbiAgICAgICAgY29uc3QgamFlZ2VyQ29uZmlnID0gUVRyYWNlci5nZXRKYWVnZXJDb25maWcoY29uZmlnLmphZWdlcik7XG4gICAgICAgIGlmICghamFlZ2VyQ29uZmlnKSB7XG4gICAgICAgICAgICByZXR1cm4gbm9vcFRyYWNlcjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaW5pdEphZWdlclRyYWNlcihqYWVnZXJDb25maWcsIHtcbiAgICAgICAgICAgIGxvZ2dlcjoge1xuICAgICAgICAgICAgICAgIGluZm8obXNnKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdJTkZPICcsIG1zZyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBlcnJvcihtc2cpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VSUk9SJywgbXNnKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3RhdGljIG1lc3NhZ2VSb290U3BhbkNvbnRleHQobWVzc2FnZUlkOiBzdHJpbmcpOiA/U3BhbkNvbnRleHQge1xuICAgICAgICBpZiAoIW1lc3NhZ2VJZCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdHJhY2VJZCA9IG1lc3NhZ2VJZC5zdWJzdHIoMCwgMTYpO1xuICAgICAgICBjb25zdCBzcGFuSWQgPSBtZXNzYWdlSWQuc3Vic3RyKDE2LCAxNik7XG4gICAgICAgIHJldHVybiBKYWVnZXJTcGFuQ29udGV4dC5mcm9tU3RyaW5nKGAke3RyYWNlSWR9OiR7c3BhbklkfTowOjFgKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZXh0cmFjdFBhcmVudFNwYW4odHJhY2VyOiBUcmFjZXIsIHJlcTogYW55KTogYW55IHtcbiAgICAgICAgbGV0IGN0eF9zcmMsXG4gICAgICAgICAgICBjdHhfZnJtO1xuICAgICAgICBpZiAocmVxLmhlYWRlcnMpIHtcbiAgICAgICAgICAgIGN0eF9zcmMgPSByZXEuaGVhZGVycztcbiAgICAgICAgICAgIGN0eF9mcm0gPSBGT1JNQVRfVEVYVF9NQVA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjdHhfc3JjID0gcmVxLmNvbnRleHQ7XG4gICAgICAgICAgICBjdHhfZnJtID0gRk9STUFUX0JJTkFSWTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJhY2VyLmV4dHJhY3QoY3R4X2ZybSwgY3R4X3NyYyk7XG4gICAgfVxuXG4gICAgc3RhdGljIGdldFBhcmVudFNwYW4odHJhY2VyOiBUcmFjZXIsIGNvbnRleHQ6IGFueSk6IChTcGFuQ29udGV4dCB8IHR5cGVvZiB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIGNvbnRleHQudHJhY2VyUGFyZW50U3BhbjtcbiAgICB9XG5cbiAgICBzdGF0aWMgZmFpbGVkKHRyYWNlcjogVHJhY2VyLCBzcGFuOiBTcGFuLCBlcnJvcjogYW55KSB7XG4gICAgICAgIHNwYW4ubG9nKHtcbiAgICAgICAgICAgIGV2ZW50OiAnZmFpbGVkJyxcbiAgICAgICAgICAgIHBheWxvYWQ6IHRvTG9nKGVycm9yKSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIHRyYWNlPFQ+KFxuICAgICAgICB0cmFjZXI6IFRyYWNlcixcbiAgICAgICAgbmFtZTogc3RyaW5nLFxuICAgICAgICBmOiAoc3BhbjogU3BhbikgPT4gUHJvbWlzZTxUPixcbiAgICAgICAgcGFyZW50U3Bhbj86IChTcGFuIHwgU3BhbkNvbnRleHQpLFxuICAgICk6IFByb21pc2U8VD4ge1xuICAgICAgICBjb25zdCBzcGFuID0gdHJhY2VyLnN0YXJ0U3BhbihuYW1lLCB7IGNoaWxkT2Y6IHBhcmVudFNwYW4gfSk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBzcGFuLnNldFRhZyhUYWdzLlNQQU5fS0lORCwgJ3NlcnZlcicpO1xuICAgICAgICAgICAgT2JqZWN0LmVudHJpZXMoUVRyYWNlci5jb25maWcuamFlZ2VyLnRhZ3MpLmZvckVhY2goKFtuYW1lLCB2YWx1ZV0pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAobmFtZSkge1xuICAgICAgICAgICAgICAgICAgICBzcGFuLnNldFRhZyhuYW1lLCB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmKHNwYW4pO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgc3Bhbi5zZXRUYWcoJ3Jlc3VsdCcsIHRvTG9nKHJlc3VsdCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3Bhbi5maW5pc2goKTtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zdCBjbGVhbmVkID0gY2xlYW5FcnJvcihlcnJvcik7XG4gICAgICAgICAgICBRVHJhY2VyLmZhaWxlZCh0cmFjZXIsIHNwYW4sIGNsZWFuZWQpO1xuICAgICAgICAgICAgc3Bhbi5maW5pc2goKTtcbiAgICAgICAgICAgIHRocm93IGNsZWFuZWQ7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=