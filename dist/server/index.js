"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.main = main;

var _server = _interopRequireDefault(require("./server"));

var _logs = _interopRequireDefault(require("./logs"));

var _os = _interopRequireDefault(require("os"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const program = require('commander');

function getIp() {
  const ipv4 = Object.values(_os.default.networkInterfaces()).flatMap(x => x).find(x => x.family === 'IPv4' && !x.internal);
  return ipv4 && ipv4.address;
}

program.option('-h, --host <host>', 'listening address', process.env.Q_SERVER_HOST || getIp()).option('-p, --port <port>', 'listening port', process.env.Q_SERVER_PORT || '4000').option('--rpc-port <port>', 'listening rpc port', process.env.Q_SERVER_RPC_PORT || '').option('-m, --requests-mode <mode>', 'Requests mode (kafka | rest)', process.env.Q_REQUESTS_MODE || 'kafka').option('-r, --requests-server <url>', 'Requests server url', process.env.Q_REQUESTS_SERVER || 'kafka:9092').option('-t, --requests-topic <name>', 'Requests topic name', process.env.Q_REQUESTS_TOPIC || 'requests').option('-d, --db-server <address>', 'database server:port', process.env.Q_DATABASE_SERVER || 'arangodb:8529').option('-n, --db-name <name>', 'database name', process.env.Q_DATABASE_NAME || 'blockchain').option('-a, --db-auth <name>', 'database auth in form "user:password', process.env.Q_DATABASE_AUTH || '').option('--db-max-sockets <number>', 'database max sockets', process.env.Q_DATABASE_MAX_SOCKETS || '100').option('--slow-db-server <address>', 'slow queries database server:port', process.env.Q_SLOW_DATABASE_SERVER || '').option('--slow-db-name <name>', 'slow database name', process.env.Q_SLOW_DATABASE_NAME || '').option('--slow-db-auth <name>', 'slow database auth in form "user:password', process.env.Q_SLOW_DATABASE_AUTH || '').option('--slow-db-max-sockets <number>', 'slow database max sockets', process.env.Q_SLOW_DATABASE_MAX_SOCKETS || '3').option('--auth-endpoint <url>', 'auth endpoint', process.env.Q_AUTH_ENDPOINT || '').option('--mam-access-keys <keys>', 'Access keys used to authorize mam endpoint access', process.env.Q_MAM_ACCESS_KEYS || '').option('-j, --jaeger-endpoint <url>', 'jaeger endpoint', process.env.Q_JAEGER_ENDPOINT || '').option('--trace-service <name>', 'trace service name', process.env.Q_TRACE_SERVICE || 'Q Server').option('--trace-tags <tags>', 'additional trace tags (comma separated name=value pairs)', process.env.Q_TRACE_TAGS || '').option('-s, --statsd-server <url>', 'statsd server (host:port)', process.env.Q_STATSD_SERVER || '').option('--statsd-tags <tags>', 'additional statsd tags (comma separated name=value pairs)', process.env.Q_STATSD_TAGS || '').option('--keep-alive <ms>', 'additional statsd tags (comma separated name=value pairs)', process.env.Q_KEEP_ALIVE || '60000').parse(process.argv);
const options = program;

function parseTags(s) {
  const tags = {};
  s.split(',').forEach(t => {
    const i = t.indexOf('=');

    if (i >= 0) {
      tags[t.substr(0, i)] = t.substr(i + 1);
    } else {
      tags[t] = '';
    }
  });
  return tags;
}

const config = {
  server: {
    host: options.host,
    port: Number.parseInt(options.port),
    rpcPort: options.rpcPort,
    keepAlive: Number.parseInt(options.keepAlive)
  },
  requests: {
    mode: options.requestsMode,
    server: options.requestsServer,
    topic: options.requestsTopic
  },
  database: {
    server: options.dbServer,
    name: options.dbName,
    auth: options.dbAuth,
    maxSockets: Number(options.dbMaxSockets)
  },
  slowDatabase: {
    server: options.slowDbServer || options.dbServer,
    name: options.slowDbName || options.dbName,
    auth: options.slowDbAuth || options.dbAuth,
    maxSockets: Number(options.slowDbMaxSockets)
  },
  listener: {
    restartTimeout: 1000
  },
  authorization: {
    endpoint: options.authEndpoint
  },
  jaeger: {
    endpoint: options.jaegerEndpoint,
    service: options.traceService,
    tags: parseTags(options.traceTags)
  },
  statsd: {
    server: options.statsdServer,
    tags: (options.statsdTags || '').split(',').map(x => x.trim()).filter(x => x)
  },
  mamAccessKeys: new Set((options.mamAccessKeys || '').split(','))
};
const logs = new _logs.default();
const configLog = logs.create('config');
configLog.debug('USE', config);
const server = new _server.default({
  config,
  logs
});

function main() {
  (async () => {
    try {
      await server.start();
    } catch (error) {
      server.log.error('FAILED', 'START', error);
      process.exit(1);
    }
  })();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJwcm9ncmFtIiwicmVxdWlyZSIsImdldElwIiwiaXB2NCIsIk9iamVjdCIsInZhbHVlcyIsIm9zIiwibmV0d29ya0ludGVyZmFjZXMiLCJmbGF0TWFwIiwieCIsImZpbmQiLCJmYW1pbHkiLCJpbnRlcm5hbCIsImFkZHJlc3MiLCJvcHRpb24iLCJwcm9jZXNzIiwiZW52IiwiUV9TRVJWRVJfSE9TVCIsIlFfU0VSVkVSX1BPUlQiLCJRX1NFUlZFUl9SUENfUE9SVCIsIlFfUkVRVUVTVFNfTU9ERSIsIlFfUkVRVUVTVFNfU0VSVkVSIiwiUV9SRVFVRVNUU19UT1BJQyIsIlFfREFUQUJBU0VfU0VSVkVSIiwiUV9EQVRBQkFTRV9OQU1FIiwiUV9EQVRBQkFTRV9BVVRIIiwiUV9EQVRBQkFTRV9NQVhfU09DS0VUUyIsIlFfU0xPV19EQVRBQkFTRV9TRVJWRVIiLCJRX1NMT1dfREFUQUJBU0VfTkFNRSIsIlFfU0xPV19EQVRBQkFTRV9BVVRIIiwiUV9TTE9XX0RBVEFCQVNFX01BWF9TT0NLRVRTIiwiUV9BVVRIX0VORFBPSU5UIiwiUV9NQU1fQUNDRVNTX0tFWVMiLCJRX0pBRUdFUl9FTkRQT0lOVCIsIlFfVFJBQ0VfU0VSVklDRSIsIlFfVFJBQ0VfVEFHUyIsIlFfU1RBVFNEX1NFUlZFUiIsIlFfU1RBVFNEX1RBR1MiLCJRX0tFRVBfQUxJVkUiLCJwYXJzZSIsImFyZ3YiLCJvcHRpb25zIiwicGFyc2VUYWdzIiwicyIsInRhZ3MiLCJzcGxpdCIsImZvckVhY2giLCJ0IiwiaSIsImluZGV4T2YiLCJzdWJzdHIiLCJjb25maWciLCJzZXJ2ZXIiLCJob3N0IiwicG9ydCIsIk51bWJlciIsInBhcnNlSW50IiwicnBjUG9ydCIsImtlZXBBbGl2ZSIsInJlcXVlc3RzIiwibW9kZSIsInJlcXVlc3RzTW9kZSIsInJlcXVlc3RzU2VydmVyIiwidG9waWMiLCJyZXF1ZXN0c1RvcGljIiwiZGF0YWJhc2UiLCJkYlNlcnZlciIsIm5hbWUiLCJkYk5hbWUiLCJhdXRoIiwiZGJBdXRoIiwibWF4U29ja2V0cyIsImRiTWF4U29ja2V0cyIsInNsb3dEYXRhYmFzZSIsInNsb3dEYlNlcnZlciIsInNsb3dEYk5hbWUiLCJzbG93RGJBdXRoIiwic2xvd0RiTWF4U29ja2V0cyIsImxpc3RlbmVyIiwicmVzdGFydFRpbWVvdXQiLCJhdXRob3JpemF0aW9uIiwiZW5kcG9pbnQiLCJhdXRoRW5kcG9pbnQiLCJqYWVnZXIiLCJqYWVnZXJFbmRwb2ludCIsInNlcnZpY2UiLCJ0cmFjZVNlcnZpY2UiLCJ0cmFjZVRhZ3MiLCJzdGF0c2QiLCJzdGF0c2RTZXJ2ZXIiLCJzdGF0c2RUYWdzIiwibWFwIiwidHJpbSIsImZpbHRlciIsIm1hbUFjY2Vzc0tleXMiLCJTZXQiLCJsb2dzIiwiUUxvZ3MiLCJjb25maWdMb2ciLCJjcmVhdGUiLCJkZWJ1ZyIsIlRPTlFTZXJ2ZXIiLCJtYWluIiwic3RhcnQiLCJlcnJvciIsImxvZyIsImV4aXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFtQkE7O0FBQ0E7O0FBRUE7Ozs7QUF0QkE7Ozs7Ozs7Ozs7Ozs7OztBQXdCQSxNQUFNQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxXQUFELENBQXZCOztBQUVBLFNBQVNDLEtBQVQsR0FBeUI7QUFDckIsUUFBTUMsSUFBSSxHQUFJQyxNQUFNLENBQUNDLE1BQVAsQ0FBY0MsWUFBR0MsaUJBQUgsRUFBZCxDQUFELENBQ1JDLE9BRFEsQ0FDQUMsQ0FBQyxJQUFJQSxDQURMLEVBRVJDLElBRlEsQ0FFSEQsQ0FBQyxJQUFJQSxDQUFDLENBQUNFLE1BQUYsS0FBYSxNQUFiLElBQXVCLENBQUNGLENBQUMsQ0FBQ0csUUFGNUIsQ0FBYjtBQUdBLFNBQU9ULElBQUksSUFBSUEsSUFBSSxDQUFDVSxPQUFwQjtBQUNIOztBQTJCRGIsT0FBTyxDQUNGYyxNQURMLENBQ1ksbUJBRFosRUFDaUMsbUJBRGpDLEVBRVFDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxhQUFaLElBQTZCZixLQUFL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QUFDZ0QsWUFEWjtBQUVKN0MsSUFBQUEsSUFBSSxFQUFFLENBQUNILE9BQU8sQ0FBQ2lELFVBQVIsSUFBc0IsRUFBdkIsRUFBMkI3QyxLQUEzQixDQUFpQyxHQUFqQyxFQUFzQzhDLEdBQXRDLENBQTBDbEYsQ0FBQyxJQUFJQSxDQUFDLENBQUNtRixJQUFGLEVBQS9DLEVBQXlEQyxNQUF6RCxDQUFnRXBGLENBQUMsSUFBSUEsQ0FBckU7QUFGRixHQW5DWTtBQXVDcEJxRixFQUFBQSxhQUFhLEVBQUUsSUFBSUMsR0FBSixDQUFRLENBQUN0RCxPQUFPLENBQUNxRCxhQUFSLElBQXlCLEVBQTFCLEVBQThCakQsS0FBOUIsQ0FBb0MsR0FBcEMsQ0FBUjtBQXZDSyxDQUF4QjtBQTBDQSxNQUFNbUQsSUFBSSxHQUFHLElBQUlDLGFBQUosRUFBYjtBQUNBLE1BQU1DLFNBQVMsR0FBR0YsSUFBSSxDQUFDRyxNQUFMLENBQVksUUFBWixDQUFsQjtBQUNBRCxTQUFTLENBQUNFLEtBQVYsQ0FBZ0IsS0FBaEIsRUFBdUJqRCxNQUF2QjtBQUVBLE1BQU1DLE1BQU0sR0FBRyxJQUFJaUQsZUFBSixDQUFlO0FBQzFCbEQsRUFBQUEsTUFEMEI7QUFFMUI2QyxFQUFBQTtBQUYwQixDQUFmLENBQWY7O0FBS08sU0FBU00sSUFBVCxHQUFnQjtBQUNuQixHQUFDLFlBQVk7QUFDVCxRQUFJO0FBQ0EsWUFBTWxELE1BQU0sQ0FBQ21ELEtBQVAsRUFBTjtBQUNILEtBRkQsQ0FFRSxPQUFPQyxLQUFQLEVBQWM7QUFDWnBELE1BQUFBLE1BQU0sQ0FBQ3FELEdBQVAsQ0FBV0QsS0FBWCxDQUFpQixRQUFqQixFQUEyQixPQUEzQixFQUFvQ0EsS0FBcEM7QUFDQXpGLE1BQUFBLE9BQU8sQ0FBQzJGLElBQVIsQ0FBYSxDQUFiO0FBQ0g7QUFDSixHQVBEO0FBUUgiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTgtMjAyMCBUT04gREVWIFNPTFVUSU9OUyBMVEQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIFNPRlRXQVJFIEVWQUxVQVRJT04gTGljZW5zZSAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlXG4gKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGVcbiAqIExpY2Vuc2UgYXQ6XG4gKlxuICogaHR0cDovL3d3dy50b24uZGV2L2xpY2Vuc2VzXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBUT04gREVWIHNvZnR3YXJlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbi8vIEBmbG93XG5cbmltcG9ydCB0eXBlIHsgUUNvbmZpZyB9IGZyb20gXCIuL2NvbmZpZ1wiO1xuaW1wb3J0IFRPTlFTZXJ2ZXIgZnJvbSAnLi9zZXJ2ZXInO1xuaW1wb3J0IFFMb2dzIGZyb20gJy4vbG9ncyc7XG5cbmltcG9ydCBvcyBmcm9tICdvcyc7XG5cbmNvbnN0IHByb2dyYW0gPSByZXF1aXJlKCdjb21tYW5kZXInKTtcblxuZnVuY3Rpb24gZ2V0SXAoKTogc3RyaW5nIHtcbiAgICBjb25zdCBpcHY0ID0gKE9iamVjdC52YWx1ZXMob3MubmV0d29ya0ludGVyZmFjZXMoKSk6IGFueSlcbiAgICAgICAgLmZsYXRNYXAoeCA9PiB4KVxuICAgICAgICAuZmluZCh4ID0+IHguZmFtaWx5ID09PSAnSVB2NCcgJiYgIXguaW50ZXJuYWwpO1xuICAgIHJldHVybiBpcHY0ICYmIGlwdjQuYWRkcmVzcztcbn1cblxudHlwZSBQcm9ncmFtT3B0aW9ucyA9IHtcbiAgICByZXF1ZXN0c01vZGU6ICdrYWZrYScgfCAncmVzdCcsXG4gICAgcmVxdWVzdHNTZXJ2ZXI6IHN0cmluZyxcbiAgICByZXF1ZXN0c1RvcGljOiBzdHJpbmcsXG4gICAgZGJTZXJ2ZXI6IHN0cmluZyxcbiAgICBkYk5hbWU6IHN0cmluZyxcbiAgICBkYkF1dGg6IHN0cmluZyxcbiAgICBkYk1heFNvY2tldHM6IHN0cmluZyxcbiAgICBzbG93RGJTZXJ2ZXI6IHN0cmluZyxcbiAgICBzbG93RGJOYW1lOiBzdHJpbmcsXG4gICAgc2xvd0RiQXV0aDogc3RyaW5nLFxuICAgIHNsb3dEYk1heFNvY2tldHM6IHN0cmluZyxcbiAgICBob3N0OiBzdHJpbmcsXG4gICAgcG9ydDogc3RyaW5nLFxuICAgIHJwY1BvcnQ6IHN0cmluZyxcbiAgICBqYWVnZXJFbmRwb2ludDogc3RyaW5nLFxuICAgIHRyYWNlU2VydmljZTogc3RyaW5nLFxuICAgIHRyYWNlVGFnczogc3RyaW5nLFxuICAgIGF1dGhFbmRwb2ludDogc3RyaW5nLFxuICAgIHN0YXRzZFNlcnZlcjogc3RyaW5nLFxuICAgIHN0YXRzZFRhZ3M6IHN0cmluZyxcbiAgICBtYW1BY2Nlc3NLZXlzOiBzdHJpbmcsXG4gICAga2VlcEFsaXZlOiBzdHJpbmcsXG59XG5cbnByb2dyYW1cbiAgICAub3B0aW9uKCctaCwgLS1ob3N0IDxob3N0PicsICdsaXN0ZW5pbmcgYWRkcmVzcycsXG4gICAgICAgIHByb2Nlc3MuZW52LlFfU0VSVkVSX0hPU1QgfHwgZ2V0SXAoKSlcbiAgICAub3B0aW9uKCctcCwgLS1wb3J0IDxwb3J0PicsICdsaXN0ZW5pbmcgcG9ydCcsXG4gICAgICAgIHByb2Nlc3MuZW52LlFfU0VSVkVSX1BPUlQgfHwgJzQwMDAnKVxuICAgIC5vcHRpb24oJy0tcnBjLXBvcnQgPHBvcnQ+JywgJ2xpc3RlbmluZyBycGMgcG9ydCcsXG4gICAgICAgIHByb2Nlc3MuZW52LlFfU0VSVkVSX1JQQ19QT1JUIHx8ICcnKVxuXG4gICAgLm9wdGlvbignLW0sIC0tcmVxdWVzdHMtbW9kZSA8bW9kZT4nLCAnUmVxdWVzdHMgbW9kZSAoa2Fma2EgfCByZXN0KScsXG4gICAgICAgIHByb2Nlc3MuZW52LlFfUkVRVUVTVFNfTU9ERSB8fCAna2Fma2EnKVxuICAgIC5vcHRpb24oJy1yLCAtLXJlcXVlc3RzLXNlcnZlciA8dXJsPicsICdSZXF1ZXN0cyBzZXJ2ZXIgdXJsJyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9SRVFVRVNUU19TRVJWRVIgfHwgJ2thZmthOjkwOTInKVxuICAgIC5vcHRpb24oJy10LCAtLXJlcXVlc3RzLXRvcGljIDxuYW1lPicsICdSZXF1ZXN0cyB0b3BpYyBuYW1lJyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9SRVFVRVNUU19UT1BJQyB8fCAncmVxdWVzdHMnKVxuXG4gICAgLm9wdGlvbignLWQsIC0tZGItc2VydmVyIDxhZGRyZXNzPicsICdkYXRhYmFzZSBzZXJ2ZXI6cG9ydCcsXG4gICAgICAgIHByb2Nlc3MuZW52LlFfREFUQUJBU0VfU0VSVkVSIHx8ICdhcmFuZ29kYjo4NTI5JylcbiAgICAub3B0aW9uKCctbiwgLS1kYi1uYW1lIDxuYW1lPicsICdkYXRhYmFzZSBuYW1lJyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9EQVRBQkFTRV9OQU1FIHx8ICdibG9ja2NoYWluJylcbiAgICAub3B0aW9uKCctYSwgLS1kYi1hdXRoIDxuYW1lPicsICdkYXRhYmFzZSBhdXRoIGluIGZvcm0gXCJ1c2VyOnBhc3N3b3JkJyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9EQVRBQkFTRV9BVVRIIHx8ICcnKVxuICAgIC5vcHRpb24oJy0tZGItbWF4LXNvY2tldHMgPG51bWJlcj4nLCAnZGF0YWJhc2UgbWF4IHNvY2tldHMnLFxuICAgICAgICBwcm9jZXNzLmVudi5RX0RBVEFCQVNFX01BWF9TT0NLRVRTIHx8ICcxMDAnKVxuXG4gICAgLm9wdGlvbignLS1zbG93LWRiLXNlcnZlciA8YWRkcmVzcz4nLCAnc2xvdyBxdWVyaWVzIGRhdGFiYXNlIHNlcnZlcjpwb3J0JyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9TTE9XX0RBVEFCQVNFX1NFUlZFUiB8fCAnJylcbiAgICAub3B0aW9uKCctLXNsb3ctZGItbmFtZSA8bmFtZT4nLCAnc2xvdyBkYXRhYmFzZSBuYW1lJyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9TTE9XX0RBVEFCQVNFX05BTUUgfHwgJycpXG4gICAgLm9wdGlvbignLS1zbG93LWRiLWF1dGggPG5hbWU+JywgJ3Nsb3cgZGF0YWJhc2UgYXV0aCBpbiBmb3JtIFwidXNlcjpwYXNzd29yZCcsXG4gICAgICAgIHByb2Nlc3MuZW52LlFfU0xPV19EQVRBQkFTRV9BVVRIIHx8ICcnKVxuICAgIC5vcHRpb24oJy0tc2xvdy1kYi1tYXgtc29ja2V0cyA8bnVtYmVyPicsICdzbG93IGRhdGFiYXNlIG1heCBzb2NrZXRzJyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9TTE9XX0RBVEFCQVNFX01BWF9TT0NLRVRTIHx8ICczJylcblxuICAgIC5vcHRpb24oJy0tYXV0aC1lbmRwb2ludCA8dXJsPicsICdhdXRoIGVuZHBvaW50JyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9BVVRIX0VORFBPSU5UIHx8ICcnKVxuICAgIC5vcHRpb24oJy0tbWFtLWFjY2Vzcy1rZXlzIDxrZXlzPicsICdBY2Nlc3Mga2V5cyB1c2VkIHRvIGF1dGhvcml6ZSBtYW0gZW5kcG9pbnQgYWNjZXNzJyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9NQU1fQUNDRVNTX0tFWVMgfHwgJycpXG5cbiAgICAub3B0aW9uKCctaiwgLS1qYWVnZXItZW5kcG9pbnQgPHVybD4nLCAnamFlZ2VyIGVuZHBvaW50JyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9KQUVHRVJfRU5EUE9JTlQgfHwgJycpXG4gICAgLm9wdGlvbignLS10cmFjZS1zZXJ2aWNlIDxuYW1lPicsICd0cmFjZSBzZXJ2aWNlIG5hbWUnLFxuICAgICAgICBwcm9jZXNzLmVudi5RX1RSQUNFX1NFUlZJQ0UgfHwgJ1EgU2VydmVyJylcbiAgICAub3B0aW9uKCctLXRyYWNlLXRhZ3MgPHRhZ3M+JywgJ2FkZGl0aW9uYWwgdHJhY2UgdGFncyAoY29tbWEgc2VwYXJhdGVkIG5hbWU9dmFsdWUgcGFpcnMpJyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9UUkFDRV9UQUdTIHx8ICcnKVxuXG4gICAgLm9wdGlvbignLXMsIC0tc3RhdHNkLXNlcnZlciA8dXJsPicsICdzdGF0c2Qgc2VydmVyIChob3N0OnBvcnQpJyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9TVEFUU0RfU0VSVkVSIHx8ICcnKVxuICAgIC5vcHRpb24oJy0tc3RhdHNkLXRhZ3MgPHRhZ3M+JywgJ2FkZGl0aW9uYWwgc3RhdHNkIHRhZ3MgKGNvbW1hIHNlcGFyYXRlZCBuYW1lPXZhbHVlIHBhaXJzKScsXG4gICAgICAgIHByb2Nlc3MuZW52LlFfU1RBVFNEX1RBR1MgfHwgJycpXG5cbiAgICAub3B0aW9uKCctLWtlZXAtYWxpdmUgPG1zPicsICdhZGRpdGlvbmFsIHN0YXRzZCB0YWdzIChjb21tYSBzZXBhcmF0ZWQgbmFtZT12YWx1ZSBwYWlycyknLFxuICAgICAgICBwcm9jZXNzLmVudi5RX0tFRVBfQUxJVkUgfHwgJzYwMDAwJylcblxuICAgIC5wYXJzZShwcm9jZXNzLmFyZ3YpO1xuXG5jb25zdCBvcHRpb25zOiBQcm9ncmFtT3B0aW9ucyA9IHByb2dyYW07XG5cbmZ1bmN0aW9uIHBhcnNlVGFncyhzOiBzdHJpbmcpOiB7IFtzdHJpbmddOiBzdHJpbmcgfSB7XG4gICAgY29uc3QgdGFnczogeyBbc3RyaW5nXTogc3RyaW5nIH0gPSB7fTtcbiAgICBzLnNwbGl0KCcsJykuZm9yRWFjaCgodCkgPT4ge1xuICAgICAgICBjb25zdCBpID0gdC5pbmRleE9mKCc9Jyk7XG4gICAgICAgIGlmIChpID49IDApIHtcbiAgICAgICAgICAgIHRhZ3NbdC5zdWJzdHIoMCwgaSldID0gdC5zdWJzdHIoaSArIDEpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGFnc1t0XSA9ICcnO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHRhZ3M7XG5cbn1cbmNvbnN0IGNvbmZpZzogUUNvbmZpZyA9IHtcbiAgICBzZXJ2ZXI6IHtcbiAgICAgICAgaG9zdDogb3B0aW9ucy5ob3N0LFxuICAgICAgICBwb3J0OiBOdW1iZXIucGFyc2VJbnQob3B0aW9ucy5wb3J0KSxcbiAgICAgICAgcnBjUG9ydDogb3B0aW9ucy5ycGNQb3J0LFxuICAgICAgICBrZWVwQWxpdmU6IE51bWJlci5wYXJzZUludChvcHRpb25zLmtlZXBBbGl2ZSksXG4gICAgfSxcbiAgICByZXF1ZXN0czoge1xuICAgICAgICBtb2RlOiBvcHRpb25zLnJlcXVlc3RzTW9kZSxcbiAgICAgICAgc2VydmVyOiBvcHRpb25zLnJlcXVlc3RzU2VydmVyLFxuICAgICAgICB0b3BpYzogb3B0aW9ucy5yZXF1ZXN0c1RvcGljLFxuICAgIH0sXG4gICAgZGF0YWJhc2U6IHtcbiAgICAgICAgc2VydmVyOiBvcHRpb25zLmRiU2VydmVyLFxuICAgICAgICBuYW1lOiBvcHRpb25zLmRiTmFtZSxcbiAgICAgICAgYXV0aDogb3B0aW9ucy5kYkF1dGgsXG4gICAgICAgIG1heFNvY2tldHM6IE51bWJlcihvcHRpb25zLmRiTWF4U29ja2V0cyksXG4gICAgfSxcbiAgICBzbG93RGF0YWJhc2U6IHtcbiAgICAgICAgc2VydmVyOiBvcHRpb25zLnNsb3dEYlNlcnZlciB8fCBvcHRpb25zLmRiU2VydmVyLFxuICAgICAgICBuYW1lOiBvcHRpb25zLnNsb3dEYk5hbWUgfHwgb3B0aW9ucy5kYk5hbWUsXG4gICAgICAgIGF1dGg6IG9wdGlvbnMuc2xvd0RiQXV0aCB8fCBvcHRpb25zLmRiQXV0aCxcbiAgICAgICAgbWF4U29ja2V0czogTnVtYmVyKG9wdGlvbnMuc2xvd0RiTWF4U29ja2V0cyksXG4gICAgfSxcbiAgICBsaXN0ZW5lcjoge1xuICAgICAgICByZXN0YXJ0VGltZW91dDogMTAwMFxuICAgIH0sXG4gICAgYXV0aG9yaXphdGlvbjoge1xuICAgICAgICBlbmRwb2ludDogb3B0aW9ucy5hdXRoRW5kcG9pbnQsXG4gICAgfSxcbiAgICBqYWVnZXI6IHtcbiAgICAgICAgZW5kcG9pbnQ6IG9wdGlvbnMuamFlZ2VyRW5kcG9pbnQsXG4gICAgICAgIHNlcnZpY2U6IG9wdGlvbnMudHJhY2VTZXJ2aWNlLFxuICAgICAgICB0YWdzOiBwYXJzZVRhZ3Mob3B0aW9ucy50cmFjZVRhZ3MpLFxuICAgIH0sXG4gICAgc3RhdHNkOiB7XG4gICAgICAgIHNlcnZlcjogb3B0aW9ucy5zdGF0c2RTZXJ2ZXIsXG4gICAgICAgIHRhZ3M6IChvcHRpb25zLnN0YXRzZFRhZ3MgfHwgJycpLnNwbGl0KCcsJykubWFwKHggPT4geC50cmltKCkpLmZpbHRlcih4ID0+IHgpLFxuICAgIH0sXG4gICAgbWFtQWNjZXNzS2V5czogbmV3IFNldCgob3B0aW9ucy5tYW1BY2Nlc3NLZXlzIHx8ICcnKS5zcGxpdCgnLCcpKSxcbn07XG5cbmNvbnN0IGxvZ3MgPSBuZXcgUUxvZ3MoKTtcbmNvbnN0IGNvbmZpZ0xvZyA9IGxvZ3MuY3JlYXRlKCdjb25maWcnKTtcbmNvbmZpZ0xvZy5kZWJ1ZygnVVNFJywgY29uZmlnKTtcblxuY29uc3Qgc2VydmVyID0gbmV3IFRPTlFTZXJ2ZXIoe1xuICAgIGNvbmZpZyxcbiAgICBsb2dzLFxufSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBtYWluKCkge1xuICAgIChhc3luYyAoKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBzZXJ2ZXIuc3RhcnQoKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHNlcnZlci5sb2cuZXJyb3IoJ0ZBSUxFRCcsICdTVEFSVCcsIGVycm9yKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfVxuICAgIH0pKCk7XG59XG4iXX0=