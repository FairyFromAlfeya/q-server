"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.main = main;

var _server = _interopRequireDefault(require("./server"));

var _logs = _interopRequireDefault(require("./logs"));

var _os = _interopRequireDefault(require("os"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const program = require('commander');

function getIp() {
  const ipv4 = Object.values(_os.default.networkInterfaces()).flatMap(x => x).find(x => x.family === 'IPv4' && !x.internal);
  return ipv4 && ipv4.address;
}

program.option('-h, --host <host>', 'listening address', process.env.Q_SERVER_HOST || getIp()).option('-p, --port <port>', 'listening port', process.env.Q_SERVER_PORT || '4000').option('-m, --requests-mode <mode>', 'Requests mode (kafka | rest)', process.env.Q_REQUESTS_MODE || 'kafka').option('-r, --requests-server <url>', 'Requests server url', process.env.Q_REQUESTS_SERVER || 'kafka:9092').option('-t, --requests-topic <name>', 'Requests topic name', process.env.Q_REQUESTS_TOPIC || 'requests').option('-d, --db-server <address>', 'database server:port', process.env.Q_DATABASE_SERVER || 'arangodb:8529').option('-n, --db-name <name>', 'database name', process.env.Q_DATABASE_NAME || 'blockchain').option('-a, --db-auth <name>', 'database auth in form "user:password', process.env.Q_DATABASE_AUTH || '').option('--db-max-sockets <number>', 'database max sockets', process.env.Q_DATABASE_MAX_SOCKETS || '100').option('--slow-db-server <address>', 'slow queries database server:port', process.env.Q_SLOW_DATABASE_SERVER || '').option('--slow-db-name <name>', 'slow database name', process.env.Q_SLOW_DATABASE_NAME || '').option('--slow-db-auth <name>', 'slow database auth in form "user:password', process.env.Q_SLOW_DATABASE_AUTH || '').option('--slow-db-max-sockets <number>', 'slow database max sockets', process.env.Q_SLOW_DATABASE_MAX_SOCKETS || '3').option('--auth-endpoint <url>', 'auth endpoint', process.env.AUTH_ENDPOINT || '').option('--mam-access-keys <keys>', 'Access keys used to authorize mam endpoint access', process.env.MAM_ACCESS_KEYS || '').option('-j, --jaeger-endpoint <url>', 'jaeger endpoint', process.env.JAEGER_ENDPOINT || '').option('--trace-service <name>', 'trace service name', process.env.Q_TRACE_SERVICE || 'Q Server').option('--trace-tags <tags>', 'additional trace tags (comma separated name=value pairs)', process.env.Q_TRACE_TAGS || '').option('-s, --statsd-server <url>', 'statsd server (host:port)', process.env.Q_STATSD_SERVER || '').parse(process.argv);
const options = program;

function parseTags(s) {
  const tags = {};
  s.split(',').forEach(t => {
    const i = t.indexOf('=');

    if (i >= 0) {
      tags[t.substr(0, i)] = t.substr(i + 1);
    } else {
      tags[t] = '';
    }
  });
  return tags;
}

const config = {
  server: {
    host: options.host,
    port: Number.parseInt(options.port)
  },
  requests: {
    mode: options.requestsMode,
    server: options.requestsServer,
    topic: options.requestsTopic
  },
  database: {
    server: options.dbServer,
    name: options.dbName,
    auth: options.dbAuth,
    maxSockets: Number(options.dbMaxSockets)
  },
  slowDatabase: {
    server: options.slowDbServer || options.dbServer,
    name: options.slowDbName || options.dbName,
    auth: options.slowDbAuth || options.dbAuth,
    maxSockets: Number(options.slowDbMaxSockets)
  },
  listener: {
    restartTimeout: 1000
  },
  authorization: {
    endpoint: options.authEndpoint
  },
  jaeger: {
    endpoint: options.jaegerEndpoint,
    service: options.traceService,
    tags: parseTags(options.traceTags)
  },
  statsd: {
    server: options.statsdServer
  },
  mamAccessKeys: new Set((options.mamAccessKeys || '').split(','))
};
const logs = new _logs.default();
const configLog = logs.create('config');
configLog.debug('USE', config);
const server = new _server.default({
  config,
  logs
});

function main() {
  (async () => {
    try {
      await server.start();
    } catch (error) {
      server.log.error('FAILED', 'START', error);
      process.exit(1);
    }
  })();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJwcm9ncmFtIiwicmVxdWlyZSIsImdldElwIiwiaXB2NCIsIk9iamVjdCIsInZhbHVlcyIsIm9zIiwibmV0d29ya0ludGVyZmFjZXMiLCJmbGF0TWFwIiwieCIsImZpbmQiLCJmYW1pbHkiLCJpbnRlcm5hbCIsImFkZHJlc3MiLCJvcHRpb24iLCJwcm9jZXNzIiwiZW52IiwiUV9TRVJWRVJfSE9TVCIsIlFfU0VSVkVSX1BPUlQiLCJRX1JFUVVFU1RTX01PREUiLCJRX1JFUVVFU1RTX1NFUlZFUiIsIlFfUkVRVUVTVFNfVE9QSUMiLCJRX0RBVEFCQVNFX1NFUlZFUiIsIlFfREFUQUJBU0VfTkFNRSIsIlFfREFUQUJBU0VfQVVUSCIsIlFfREFUQUJBU0VfTUFYX1NPQ0tFVFMiLCJRX1NMT1dfREFUQUJBU0VfU0VSVkVSIiwiUV9TTE9XX0RBVEFCQVNFX05BTUUiLCJRX1NMT1dfREFUQUJBU0VfQVVUSCIsIlFfU0xPV19EQVRBQkFTRV9NQVhfU09DS0VUUyIsIkFVVEhfRU5EUE9JTlQiLCJNQU1fQUNDRVNTX0tFWVMiLCJKQUVHRVJfRU5EUE9JTlQiLCJRX1RSQUNFX1NFUlZJQ0UiLCJRX1RSQUNFX1RBR1MiLCJRX1NUQVRTRF9TRVJWRVIiLCJwYXJzZSIsImFyZ3YiLCJvcHRpb25zIiwicGFyc2VUYWdzIiwicyIsInRhZ3MiLCJzcGxpdCIsImZvckVhY2giLCJ0IiwiaSIsImluZGV4T2YiLCJzdWJzdHIiLCJjb25maWciLCJzZXJ2ZXIiLCJob3N0IiwicG9ydCIsIk51bWJlciIsInBhcnNlSW50IiwicmVxdWVzdHMiLCJtb2RlIiwicmVxdWVzdHNNb2RlIiwicmVxdWVzdHNTZXJ2ZXIiLCJ0b3BpYyIsInJlcXVlc3RzVG9waWMiLCJkYXRhYmFzZSIsImRiU2VydmVyIiwibmFtZSIsImRiTmFtZSIsImF1dGgiLCJkYkF1dGgiLCJtYXhTb2NrZXRzIiwiZGJNYXhTb2NrZXRzIiwic2xvd0RhdGFiYXNlIiwic2xvd0RiU2VydmVyIiwic2xvd0RiTmFtZSIsInNsb3dEYkF1dGgiLCJzbG93RGJNYXhTb2NrZXRzIiwibGlzdGVuZXIiLCJyZXN0YXJ0VGltZW91dCIsImF1dGhvcml6YXRpb24iLCJlbmRwb2ludCIsImF1dGhFbmRwb2ludCIsImphZWdlciIsImphZWdlckVuZHBvaW50Iiwic2VydmljZSIsInRyYWNlU2VydmljZSIsInRyYWNlVGFncyIsInN0YXRzZCIsInN0YXRzZFNlcnZlciIsIm1hbUFjY2Vzc0tleXMiLCJTZXQiLCJsb2dzIiwiUUxvZ3MiLCJjb25maWdMb2ciLCJjcmVhdGUiLCJkZWJ1ZyIsIlRPTlFTZXJ2ZXIiLCJtYWluIiwic3RhcnQiLCJlcnJvciIsImxvZyIsImV4aXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFtQkE7O0FBQ0E7O0FBRUE7Ozs7QUF0QkE7Ozs7Ozs7Ozs7Ozs7OztBQXdCQSxNQUFNQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxXQUFELENBQXZCOztBQUVBLFNBQVNDLEtBQVQsR0FBeUI7QUFDckIsUUFBTUMsSUFBSSxHQUFJQyxNQUFNLENBQUNDLE1BQVAsQ0FBY0MsWUFBR0MsaUJBQUgsRUFBZCxDQUFELENBQ1JDLE9BRFEsQ0FDQUMsQ0FBQyxJQUFJQSxDQURMLEVBRVJDLElBRlEsQ0FFSEQsQ0FBQyxJQUFJQSxDQUFDLENBQUNFLE1BQUYsS0FBYSxNQUFiLElBQXVCLENBQUNGLENBQUMsQ0FBQ0csUUFGNUIsQ0FBYjtBQUdBLFNBQU9ULElBQUksSUFBSUEsSUFBSSxDQUFDVSxPQUFwQjtBQUNIOztBQXdCRGIsT0FBTyxDQUNGYyxNQURMLENBQ1ksbUJBRFosRUFDaUMsbUJBRGpDLEVBRVFDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxhQUFaLElBQTZCZixLQUFLLEVBRjFDLEVBR0tZLE1BSEwsQ0FHWSxtQkFIWixFQUdpQyxnQkFIakMsRUFJUUMsT0FBTyxDQUFDQyxHQUFSLENBQVlFLGFBQVosSUFBNkIsTUFKckMsRUFNS0osTUFOTCxDQU1ZLDRCQU5aLEVBTTBD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QUMrQyxHQUFQLENBQVdELEtBQVgsQ0FBaUIsUUFBakIsRUFBMkIsT0FBM0IsRUFBb0NBLEtBQXBDO0FBQ0FoRixNQUFBQSxPQUFPLENBQUNrRixJQUFSLENBQWEsQ0FBYjtBQUNIO0FBQ0osR0FQRDtBQVFIIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE4LTIwMjAgVE9OIERFViBTT0xVVElPTlMgTFRELlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBTT0ZUV0FSRSBFVkFMVUFUSU9OIExpY2Vuc2UgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZVxuICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlXG4gKiBMaWNlbnNlIGF0OlxuICpcbiAqIGh0dHA6Ly93d3cudG9uLmRldi9saWNlbnNlc1xuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgVE9OIERFViBzb2Z0d2FyZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vLyBAZmxvd1xuXG5pbXBvcnQgdHlwZSB7IFFDb25maWcgfSBmcm9tIFwiLi9jb25maWdcIjtcbmltcG9ydCBUT05RU2VydmVyIGZyb20gJy4vc2VydmVyJztcbmltcG9ydCBRTG9ncyBmcm9tICcuL2xvZ3MnO1xuXG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuXG5jb25zdCBwcm9ncmFtID0gcmVxdWlyZSgnY29tbWFuZGVyJyk7XG5cbmZ1bmN0aW9uIGdldElwKCk6IHN0cmluZyB7XG4gICAgY29uc3QgaXB2NCA9IChPYmplY3QudmFsdWVzKG9zLm5ldHdvcmtJbnRlcmZhY2VzKCkpOiBhbnkpXG4gICAgICAgIC5mbGF0TWFwKHggPT4geClcbiAgICAgICAgLmZpbmQoeCA9PiB4LmZhbWlseSA9PT0gJ0lQdjQnICYmICF4LmludGVybmFsKTtcbiAgICByZXR1cm4gaXB2NCAmJiBpcHY0LmFkZHJlc3M7XG59XG5cbnR5cGUgUHJvZ3JhbU9wdGlvbnMgPSB7XG4gICAgcmVxdWVzdHNNb2RlOiAna2Fma2EnIHwgJ3Jlc3QnLFxuICAgIHJlcXVlc3RzU2VydmVyOiBzdHJpbmcsXG4gICAgcmVxdWVzdHNUb3BpYzogc3RyaW5nLFxuICAgIGRiU2VydmVyOiBzdHJpbmcsXG4gICAgZGJOYW1lOiBzdHJpbmcsXG4gICAgZGJBdXRoOiBzdHJpbmcsXG4gICAgZGJNYXhTb2NrZXRzOiBzdHJpbmcsXG4gICAgc2xvd0RiU2VydmVyOiBzdHJpbmcsXG4gICAgc2xvd0RiTmFtZTogc3RyaW5nLFxuICAgIHNsb3dEYkF1dGg6IHN0cmluZyxcbiAgICBzbG93RGJNYXhTb2NrZXRzOiBzdHJpbmcsXG4gICAgaG9zdDogc3RyaW5nLFxuICAgIHBvcnQ6IHN0cmluZyxcbiAgICBqYWVnZXJFbmRwb2ludDogc3RyaW5nLFxuICAgIHRyYWNlU2VydmljZTogc3RyaW5nLFxuICAgIHRyYWNlVGFnczogc3RyaW5nLFxuICAgIGF1dGhFbmRwb2ludDogc3RyaW5nLFxuICAgIHN0YXRzZFNlcnZlcjogc3RyaW5nLFxuICAgIG1hbUFjY2Vzc0tleXM6IHN0cmluZyxcbn1cblxucHJvZ3JhbVxuICAgIC5vcHRpb24oJy1oLCAtLWhvc3QgPGhvc3Q+JywgJ2xpc3RlbmluZyBhZGRyZXNzJyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9TRVJWRVJfSE9TVCB8fCBnZXRJcCgpKVxuICAgIC5vcHRpb24oJy1wLCAtLXBvcnQgPHBvcnQ+JywgJ2xpc3RlbmluZyBwb3J0JyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9TRVJWRVJfUE9SVCB8fCAnNDAwMCcpXG5cbiAgICAub3B0aW9uKCctbSwgLS1yZXF1ZXN0cy1tb2RlIDxtb2RlPicsICdSZXF1ZXN0cyBtb2RlIChrYWZrYSB8IHJlc3QpJyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9SRVFVRVNUU19NT0RFIHx8ICdrYWZrYScpXG4gICAgLm9wdGlvbignLXIsIC0tcmVxdWVzdHMtc2VydmVyIDx1cmw+JywgJ1JlcXVlc3RzIHNlcnZlciB1cmwnLFxuICAgICAgICBwcm9jZXNzLmVudi5RX1JFUVVFU1RTX1NFUlZFUiB8fCAna2Fma2E6OTA5MicpXG4gICAgLm9wdGlvbignLXQsIC0tcmVxdWVzdHMtdG9waWMgPG5hbWU+JywgJ1JlcXVlc3RzIHRvcGljIG5hbWUnLFxuICAgICAgICBwcm9jZXNzLmVudi5RX1JFUVVFU1RTX1RPUElDIHx8ICdyZXF1ZXN0cycpXG5cbiAgICAub3B0aW9uKCctZCwgLS1kYi1zZXJ2ZXIgPGFkZHJlc3M+JywgJ2RhdGFiYXNlIHNlcnZlcjpwb3J0JyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9EQVRBQkFTRV9TRVJWRVIgfHwgJ2FyYW5nb2RiOjg1MjknKVxuICAgIC5vcHRpb24oJy1uLCAtLWRiLW5hbWUgPG5hbWU+JywgJ2RhdGFiYXNlIG5hbWUnLFxuICAgICAgICBwcm9jZXNzLmVudi5RX0RBVEFCQVNFX05BTUUgfHwgJ2Jsb2NrY2hhaW4nKVxuICAgIC5vcHRpb24oJy1hLCAtLWRiLWF1dGggPG5hbWU+JywgJ2RhdGFiYXNlIGF1dGggaW4gZm9ybSBcInVzZXI6cGFzc3dvcmQnLFxuICAgICAgICBwcm9jZXNzLmVudi5RX0RBVEFCQVNFX0FVVEggfHwgJycpXG4gICAgLm9wdGlvbignLS1kYi1tYXgtc29ja2V0cyA8bnVtYmVyPicsICdkYXRhYmFzZSBtYXggc29ja2V0cycsXG4gICAgICAgIHByb2Nlc3MuZW52LlFfREFUQUJBU0VfTUFYX1NPQ0tFVFMgfHwgJzEwMCcpXG5cbiAgICAub3B0aW9uKCctLXNsb3ctZGItc2VydmVyIDxhZGRyZXNzPicsICdzbG93IHF1ZXJpZXMgZGF0YWJhc2Ugc2VydmVyOnBvcnQnLFxuICAgICAgICBwcm9jZXNzLmVudi5RX1NMT1dfREFUQUJBU0VfU0VSVkVSIHx8ICcnKVxuICAgIC5vcHRpb24oJy0tc2xvdy1kYi1uYW1lIDxuYW1lPicsICdzbG93IGRhdGFiYXNlIG5hbWUnLFxuICAgICAgICBwcm9jZXNzLmVudi5RX1NMT1dfREFUQUJBU0VfTkFNRSB8fCAnJylcbiAgICAub3B0aW9uKCctLXNsb3ctZGItYXV0aCA8bmFtZT4nLCAnc2xvdyBkYXRhYmFzZSBhdXRoIGluIGZvcm0gXCJ1c2VyOnBhc3N3b3JkJyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuUV9TTE9XX0RBVEFCQVNFX0FVVEggfHwgJycpXG4gICAgLm9wdGlvbignLS1zbG93LWRiLW1heC1zb2NrZXRzIDxudW1iZXI+JywgJ3Nsb3cgZGF0YWJhc2UgbWF4IHNvY2tldHMnLFxuICAgICAgICBwcm9jZXNzLmVudi5RX1NMT1dfREFUQUJBU0VfTUFYX1NPQ0tFVFMgfHwgJzMnKVxuXG4gICAgLm9wdGlvbignLS1hdXRoLWVuZHBvaW50IDx1cmw+JywgJ2F1dGggZW5kcG9pbnQnLFxuICAgICAgICBwcm9jZXNzLmVudi5BVVRIX0VORFBPSU5UIHx8ICcnKVxuICAgIC5vcHRpb24oJy0tbWFtLWFjY2Vzcy1rZXlzIDxrZXlzPicsICdBY2Nlc3Mga2V5cyB1c2VkIHRvIGF1dGhvcml6ZSBtYW0gZW5kcG9pbnQgYWNjZXNzJyxcbiAgICAgICAgcHJvY2Vzcy5lbnYuTUFNX0FDQ0VTU19LRVlTIHx8ICcnKVxuXG4gICAgLm9wdGlvbignLWosIC0tamFlZ2VyLWVuZHBvaW50IDx1cmw+JywgJ2phZWdlciBlbmRwb2ludCcsXG4gICAgICAgIHByb2Nlc3MuZW52LkpBRUdFUl9FTkRQT0lOVCB8fCAnJylcbiAgICAub3B0aW9uKCctLXRyYWNlLXNlcnZpY2UgPG5hbWU+JywgJ3RyYWNlIHNlcnZpY2UgbmFtZScsXG4gICAgICAgIHByb2Nlc3MuZW52LlFfVFJBQ0VfU0VSVklDRSB8fCAnUSBTZXJ2ZXInKVxuICAgIC5vcHRpb24oJy0tdHJhY2UtdGFncyA8dGFncz4nLCAnYWRkaXRpb25hbCB0cmFjZSB0YWdzIChjb21tYSBzZXBhcmF0ZWQgbmFtZT12YWx1ZSBwYWlycyknLFxuICAgICAgICBwcm9jZXNzLmVudi5RX1RSQUNFX1RBR1MgfHwgJycpXG5cbiAgICAub3B0aW9uKCctcywgLS1zdGF0c2Qtc2VydmVyIDx1cmw+JywgJ3N0YXRzZCBzZXJ2ZXIgKGhvc3Q6cG9ydCknLFxuICAgICAgICBwcm9jZXNzLmVudi5RX1NUQVRTRF9TRVJWRVIgfHwgJycpXG5cbiAgICAucGFyc2UocHJvY2Vzcy5hcmd2KTtcblxuY29uc3Qgb3B0aW9uczogUHJvZ3JhbU9wdGlvbnMgPSBwcm9ncmFtO1xuXG5mdW5jdGlvbiBwYXJzZVRhZ3Moczogc3RyaW5nKTogeyBbc3RyaW5nXTogc3RyaW5nIH0ge1xuICAgIGNvbnN0IHRhZ3M6IHsgW3N0cmluZ106IHN0cmluZyB9ID0ge307XG4gICAgcy5zcGxpdCgnLCcpLmZvckVhY2goKHQpID0+IHtcbiAgICAgICAgY29uc3QgaSA9IHQuaW5kZXhPZignPScpO1xuICAgICAgICBpZiAoaSA+PSAwKSB7XG4gICAgICAgICAgICB0YWdzW3Quc3Vic3RyKDAsIGkpXSA9IHQuc3Vic3RyKGkgKyAxKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRhZ3NbdF0gPSAnJztcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiB0YWdzO1xuXG59XG5jb25zdCBjb25maWc6IFFDb25maWcgPSB7XG4gICAgc2VydmVyOiB7XG4gICAgICAgIGhvc3Q6IG9wdGlvbnMuaG9zdCxcbiAgICAgICAgcG9ydDogTnVtYmVyLnBhcnNlSW50KG9wdGlvbnMucG9ydCksXG4gICAgfSxcbiAgICByZXF1ZXN0czoge1xuICAgICAgICBtb2RlOiBvcHRpb25zLnJlcXVlc3RzTW9kZSxcbiAgICAgICAgc2VydmVyOiBvcHRpb25zLnJlcXVlc3RzU2VydmVyLFxuICAgICAgICB0b3BpYzogb3B0aW9ucy5yZXF1ZXN0c1RvcGljLFxuICAgIH0sXG4gICAgZGF0YWJhc2U6IHtcbiAgICAgICAgc2VydmVyOiBvcHRpb25zLmRiU2VydmVyLFxuICAgICAgICBuYW1lOiBvcHRpb25zLmRiTmFtZSxcbiAgICAgICAgYXV0aDogb3B0aW9ucy5kYkF1dGgsXG4gICAgICAgIG1heFNvY2tldHM6IE51bWJlcihvcHRpb25zLmRiTWF4U29ja2V0cyksXG4gICAgfSxcbiAgICBzbG93RGF0YWJhc2U6IHtcbiAgICAgICAgc2VydmVyOiBvcHRpb25zLnNsb3dEYlNlcnZlciB8fCBvcHRpb25zLmRiU2VydmVyLFxuICAgICAgICBuYW1lOiBvcHRpb25zLnNsb3dEYk5hbWUgfHwgb3B0aW9ucy5kYk5hbWUsXG4gICAgICAgIGF1dGg6IG9wdGlvbnMuc2xvd0RiQXV0aCB8fCBvcHRpb25zLmRiQXV0aCxcbiAgICAgICAgbWF4U29ja2V0czogTnVtYmVyKG9wdGlvbnMuc2xvd0RiTWF4U29ja2V0cyksXG4gICAgfSxcbiAgICBsaXN0ZW5lcjoge1xuICAgICAgICByZXN0YXJ0VGltZW91dDogMTAwMFxuICAgIH0sXG4gICAgYXV0aG9yaXphdGlvbjoge1xuICAgICAgICBlbmRwb2ludDogb3B0aW9ucy5hdXRoRW5kcG9pbnQsXG4gICAgfSxcbiAgICBqYWVnZXI6IHtcbiAgICAgICAgZW5kcG9pbnQ6IG9wdGlvbnMuamFlZ2VyRW5kcG9pbnQsXG4gICAgICAgIHNlcnZpY2U6IG9wdGlvbnMudHJhY2VTZXJ2aWNlLFxuICAgICAgICB0YWdzOiBwYXJzZVRhZ3Mob3B0aW9ucy50cmFjZVRhZ3MpLFxuICAgIH0sXG4gICAgc3RhdHNkOiB7XG4gICAgICAgIHNlcnZlcjogb3B0aW9ucy5zdGF0c2RTZXJ2ZXIsXG4gICAgfSxcbiAgICBtYW1BY2Nlc3NLZXlzOiBuZXcgU2V0KChvcHRpb25zLm1hbUFjY2Vzc0tleXMgfHwgJycpLnNwbGl0KCcsJykpLFxufTtcblxuY29uc3QgbG9ncyA9IG5ldyBRTG9ncygpO1xuY29uc3QgY29uZmlnTG9nID0gbG9ncy5jcmVhdGUoJ2NvbmZpZycpO1xuY29uZmlnTG9nLmRlYnVnKCdVU0UnLCBjb25maWcpO1xuXG5jb25zdCBzZXJ2ZXIgPSBuZXcgVE9OUVNlcnZlcih7XG4gICAgY29uZmlnLFxuICAgIGxvZ3MsXG59KTtcblxuZXhwb3J0IGZ1bmN0aW9uIG1haW4oKSB7XG4gICAgKGFzeW5jICgpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHNlcnZlci5zdGFydCgpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgc2VydmVyLmxvZy5lcnJvcignRkFJTEVEJywgJ1NUQVJUJywgZXJyb3IpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG4gICAgfSkoKTtcbn1cbiJdfQ==