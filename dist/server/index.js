"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.main = main;

var _config = require("./config");

var _server = _interopRequireDefault(require("./server"));

var _logs = _interopRequireDefault(require("./logs"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const program = require('commander');

const commandLineDefaults = (0, _config.resolveOptions)({}, process.env, _config.defaultOptions);
program.option('-h, --host <host>', 'listening address', commandLineDefaults.host).option('-p, --port <port>', 'listening port', commandLineDefaults.port).option('--rpc-port <port>', 'listening rpc port', commandLineDefaults.rpcPort).option('-m, --requests-mode <mode>', 'Requests mode (kafka | rest)', commandLineDefaults.requestsMode).option('-r, --requests-server <url>', 'Requests server url', commandLineDefaults.requestsServer).option('-t, --requests-topic <name>', 'Requests topic name', commandLineDefaults.requestsTopic).option('-d, --db-server <address>', 'database server:port', commandLineDefaults.dbServer).option('-n, --db-name <name>', 'database name', commandLineDefaults.dbName).option('-a, --db-auth <name>', 'database auth in form "user:password', commandLineDefaults.dbAuth).option('--db-max-sockets <number>', 'database max sockets', commandLineDefaults.dbMaxSockets).option('--slow-db-server <address>', 'slow queries database server:port', commandLineDefaults.slowDbServer).option('--slow-db-name <name>', 'slow database name', commandLineDefaults.slowDbName).option('--slow-db-auth <name>', 'slow database auth in form "user:password', commandLineDefaults.slowDbAuth).option('--slow-db-max-sockets <number>', 'slow database max sockets', commandLineDefaults.slowDbMaxSockets).option('--auth-endpoint <url>', 'auth endpoint', commandLineDefaults.authEndpoint).option('--mam-access-keys <keys>', 'Access keys used to authorize mam endpoint access', commandLineDefaults.mamAccessKeys).option('-j, --jaeger-endpoint <url>', 'jaeger endpoint', commandLineDefaults.jaegerEndpoint).option('--trace-service <name>', 'trace service name', commandLineDefaults.traceService).option('--trace-tags <tags>', 'additional trace tags (comma separated name=value pairs)', commandLineDefaults.traceTags).option('-s, --statsd-server <url>', 'statsd server (host:port)', commandLineDefaults.statsdServer).option('--statsd-tags <tags>', 'additional statsd tags (comma separated name=value pairs)', commandLineDefaults.statsdTags).option('--keep-alive <ms>', 'additional statsd tags (comma separated name=value pairs)', commandLineDefaults.keepAlive).parse(process.argv);
const config = (0, _config.createConfig)(program, process.env, _config.defaultOptions);
const logs = new _logs.default();
const configLog = logs.create('config');
configLog.debug('USE', config);
const server = new _server.default({
  config,
  logs
});

function main() {
  (async () => {
    try {
      await server.start();
    } catch (error) {
      server.log.error('FAILED', 'START', error);
      process.exit(1);
    }
  })();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvaW5kZXguanMiXSwibmFtZXMiOlsicHJvZ3JhbSIsInJlcXVpcmUiLCJjb21tYW5kTGluZURlZmF1bHRzIiwicHJvY2VzcyIsImVudiIsImRlZmF1bHRPcHRpb25zIiwib3B0aW9uIiwiaG9zdCIsInBvcnQiLCJycGNQb3J0IiwicmVxdWVzdHNNb2RlIiwicmVxdWVzdHNTZXJ2ZXIiLCJyZXF1ZXN0c1RvcGljIiwiZGJTZXJ2ZXIiLCJkYk5hbWUiLCJkYkF1dGgiLCJkYk1heFNvY2tldHMiLCJzbG93RGJTZXJ2ZXIiLCJzbG93RGJOYW1lIiwic2xvd0RiQXV0aCIsInNsb3dEYk1heFNvY2tldHMiLCJhdXRoRW5kcG9pbnQiLCJtYW1BY2Nlc3NLZXlzIiwiamFlZ2VyRW5kcG9pbnQiLCJ0cmFjZVNlcnZpY2UiLCJ0cmFjZVRhZ3MiLCJzdGF0c2RTZXJ2ZXIiLCJzdGF0c2RUYWdzIiwia2VlcEFsaXZlIiwicGFyc2UiLCJhcmd2IiwiY29uZmlnIiwibG9ncyIsIlFMb2dzIiwiY29uZmlnTG9nIiwiY3JlYXRlIiwiZGVidWciLCJzZXJ2ZXIiLCJUT05RU2VydmVyIiwibWFpbiIsInN0YXJ0IiwiZXJyb3IiLCJsb2ciLCJleGl0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBa0JBOztBQUVBOztBQUNBOzs7O0FBckJBOzs7Ozs7Ozs7Ozs7Ozs7QUF1QkEsTUFBTUEsT0FBTyxHQUFHQyxPQUFPLENBQUMsV0FBRCxDQUF2Qjs7QUFDQSxNQUFNQyxtQkFBbUIsR0FBRyw0QkFBZSxFQUFmLEVBQW1CQyxPQUFPLENBQUNDLEdBQTNCLEVBQWdDQyxzQkFBaEMsQ0FBNUI7QUFFQUwsT0FBTyxDQUNGTSxNQURMLENBQ1ksbUJBRFosRUFDaUMsbUJBRGpDLEVBQ3NESixtQkFBbUIsQ0FBQ0ssSUFEMUUsRUFFS0QsTUFGTCxDQUVZLG1CQUZaLEVBRWlDLGdCQUZqQyxFQUVtREosbUJBQW1CLENBQUNNLElBRnZFLEVBR0tGLE1BSEwsQ0FHWSxtQkFI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QixFQUEyQixPQUEzQixFQUFvQ0EsS0FBcEM7QUFDQXRDLE1BQUFBLE9BQU8sQ0FBQ3dDLElBQVIsQ0FBYSxDQUFiO0FBQ0g7QUFDSixHQVBEO0FBUUgiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTgtMjAyMCBUT04gREVWIFNPTFVUSU9OUyBMVEQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIFNPRlRXQVJFIEVWQUxVQVRJT04gTGljZW5zZSAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlXG4gKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGVcbiAqIExpY2Vuc2UgYXQ6XG4gKlxuICogaHR0cDovL3d3dy50b24uZGV2L2xpY2Vuc2VzXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBUT04gREVWIHNvZnR3YXJlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbi8vIEBmbG93XG5cbmltcG9ydCB7Y3JlYXRlQ29uZmlnLCBkZWZhdWx0T3B0aW9ucywgcmVzb2x2ZU9wdGlvbnN9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCB0eXBlIHsgUUNvbmZpZyB9IGZyb20gXCIuL2NvbmZpZ1wiO1xuaW1wb3J0IFRPTlFTZXJ2ZXIgZnJvbSAnLi9zZXJ2ZXInO1xuaW1wb3J0IFFMb2dzIGZyb20gJy4vbG9ncyc7XG5cbmNvbnN0IHByb2dyYW0gPSByZXF1aXJlKCdjb21tYW5kZXInKTtcbmNvbnN0IGNvbW1hbmRMaW5lRGVmYXVsdHMgPSByZXNvbHZlT3B0aW9ucyh7fSwgcHJvY2Vzcy5lbnYsIGRlZmF1bHRPcHRpb25zKTtcblxucHJvZ3JhbVxuICAgIC5vcHRpb24oJy1oLCAtLWhvc3QgPGhvc3Q+JywgJ2xpc3RlbmluZyBhZGRyZXNzJywgY29tbWFuZExpbmVEZWZhdWx0cy5ob3N0KVxuICAgIC5vcHRpb24oJy1wLCAtLXBvcnQgPHBvcnQ+JywgJ2xpc3RlbmluZyBwb3J0JywgY29tbWFuZExpbmVEZWZhdWx0cy5wb3J0KVxuICAgIC5vcHRpb24oJy0tcnBjLXBvcnQgPHBvcnQ+JywgJ2xpc3RlbmluZyBycGMgcG9ydCcsIGNvbW1hbmRMaW5lRGVmYXVsdHMucnBjUG9ydClcblxuICAgIC5vcHRpb24oJy1tLCAtLXJlcXVlc3RzLW1vZGUgPG1vZGU+JywgJ1JlcXVlc3RzIG1vZGUgKGthZmthIHwgcmVzdCknLCBjb21tYW5kTGluZURlZmF1bHRzLnJlcXVlc3RzTW9kZSlcbiAgICAub3B0aW9uKCctciwgLS1yZXF1ZXN0cy1zZXJ2ZXIgPHVybD4nLCAnUmVxdWVzdHMgc2VydmVyIHVybCcsIGNvbW1hbmRMaW5lRGVmYXVsdHMucmVxdWVzdHNTZXJ2ZXIpXG4gICAgLm9wdGlvbignLXQsIC0tcmVxdWVzdHMtdG9waWMgPG5hbWU+JywgJ1JlcXVlc3RzIHRvcGljIG5hbWUnLCBjb21tYW5kTGluZURlZmF1bHRzLnJlcXVlc3RzVG9waWMpXG5cbiAgICAub3B0aW9uKCctZCwgLS1kYi1zZXJ2ZXIgPGFkZHJlc3M+JywgJ2RhdGFiYXNlIHNlcnZlcjpwb3J0JywgY29tbWFuZExpbmVEZWZhdWx0cy5kYlNlcnZlcilcbiAgICAub3B0aW9uKCctbiwgLS1kYi1uYW1lIDxuYW1lPicsICdkYXRhYmFzZSBuYW1lJywgY29tbWFuZExpbmVEZWZhdWx0cy5kYk5hbWUpXG4gICAgLm9wdGlvbignLWEsIC0tZGItYXV0aCA8bmFtZT4nLCAnZGF0YWJhc2UgYXV0aCBpbiBmb3JtIFwidXNlcjpwYXNzd29yZCcsIGNvbW1hbmRMaW5lRGVmYXVsdHMuZGJBdXRoKVxuICAgIC5vcHRpb24oJy0tZGItbWF4LXNvY2tldHMgPG51bWJlcj4nLCAnZGF0YWJhc2UgbWF4IHNvY2tldHMnLCBjb21tYW5kTGluZURlZmF1bHRzLmRiTWF4U29ja2V0cylcblxuICAgIC5vcHRpb24oJy0tc2xvdy1kYi1zZXJ2ZXIgPGFkZHJlc3M+JywgJ3Nsb3cgcXVlcmllcyBkYXRhYmFzZSBzZXJ2ZXI6cG9ydCcsIGNvbW1hbmRMaW5lRGVmYXVsdHMuc2xvd0RiU2VydmVyKVxuICAgIC5vcHRpb24oJy0tc2xvdy1kYi1uYW1lIDxuYW1lPicsICdzbG93IGRhdGFiYXNlIG5hbWUnLCBjb21tYW5kTGluZURlZmF1bHRzLnNsb3dEYk5hbWUpXG4gICAgLm9wdGlvbignLS1zbG93LWRiLWF1dGggPG5hbWU+JywgJ3Nsb3cgZGF0YWJhc2UgYXV0aCBpbiBmb3JtIFwidXNlcjpwYXNzd29yZCcsIGNvbW1hbmRMaW5lRGVmYXVsdHMuc2xvd0RiQXV0aClcbiAgICAub3B0aW9uKCctLXNsb3ctZGItbWF4LXNvY2tldHMgPG51bWJlcj4nLCAnc2xvdyBkYXRhYmFzZSBtYXggc29ja2V0cycsIGNvbW1hbmRMaW5lRGVmYXVsdHMuc2xvd0RiTWF4U29ja2V0cylcblxuICAgIC5vcHRpb24oJy0tYXV0aC1lbmRwb2ludCA8dXJsPicsICdhdXRoIGVuZHBvaW50JywgY29tbWFuZExpbmVEZWZhdWx0cy5hdXRoRW5kcG9pbnQpXG4gICAgLm9wdGlvbignLS1tYW0tYWNjZXNzLWtleXMgPGtleXM+JywgJ0FjY2VzcyBrZXlzIHVzZWQgdG8gYXV0aG9yaXplIG1hbSBlbmRwb2ludCBhY2Nlc3MnLCBjb21tYW5kTGluZURlZmF1bHRzLm1hbUFjY2Vzc0tleXMpXG5cbiAgICAub3B0aW9uKCctaiwgLS1qYWVnZXItZW5kcG9pbnQgPHVybD4nLCAnamFlZ2VyIGVuZHBvaW50JywgY29tbWFuZExpbmVEZWZhdWx0cy5qYWVnZXJFbmRwb2ludClcbiAgICAub3B0aW9uKCctLXRyYWNlLXNlcnZpY2UgPG5hbWU+JywgJ3RyYWNlIHNlcnZpY2UgbmFtZScsIGNvbW1hbmRMaW5lRGVmYXVsdHMudHJhY2VTZXJ2aWNlKVxuICAgIC5vcHRpb24oJy0tdHJhY2UtdGFncyA8dGFncz4nLCAnYWRkaXRpb25hbCB0cmFjZSB0YWdzIChjb21tYSBzZXBhcmF0ZWQgbmFtZT12YWx1ZSBwYWlycyknLCBjb21tYW5kTGluZURlZmF1bHRzLnRyYWNlVGFncylcblxuICAgIC5vcHRpb24oJy1zLCAtLXN0YXRzZC1zZXJ2ZXIgPHVybD4nLCAnc3RhdHNkIHNlcnZlciAoaG9zdDpwb3J0KScsIGNvbW1hbmRMaW5lRGVmYXVsdHMuc3RhdHNkU2VydmVyKVxuICAgIC5vcHRpb24oJy0tc3RhdHNkLXRhZ3MgPHRhZ3M+JywgJ2FkZGl0aW9uYWwgc3RhdHNkIHRhZ3MgKGNvbW1hIHNlcGFyYXRlZCBuYW1lPXZhbHVlIHBhaXJzKScsIGNvbW1hbmRMaW5lRGVmYXVsdHMuc3RhdHNkVGFncylcblxuICAgIC5vcHRpb24oJy0ta2VlcC1hbGl2ZSA8bXM+JywgJ2FkZGl0aW9uYWwgc3RhdHNkIHRhZ3MgKGNvbW1hIHNlcGFyYXRlZCBuYW1lPXZhbHVlIHBhaXJzKScsIGNvbW1hbmRMaW5lRGVmYXVsdHMua2VlcEFsaXZlKVxuXG4gICAgLnBhcnNlKHByb2Nlc3MuYXJndik7XG5cblxuY29uc3QgY29uZmlnOiBRQ29uZmlnID0gY3JlYXRlQ29uZmlnKHByb2dyYW0sIHByb2Nlc3MuZW52LCBkZWZhdWx0T3B0aW9ucyk7XG5cbmNvbnN0IGxvZ3MgPSBuZXcgUUxvZ3MoKTtcbmNvbnN0IGNvbmZpZ0xvZyA9IGxvZ3MuY3JlYXRlKCdjb25maWcnKTtcbmNvbmZpZ0xvZy5kZWJ1ZygnVVNFJywgY29uZmlnKTtcblxuY29uc3Qgc2VydmVyID0gbmV3IFRPTlFTZXJ2ZXIoe1xuICAgIGNvbmZpZyxcbiAgICBsb2dzLFxufSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBtYWluKCkge1xuICAgIChhc3luYyAoKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBzZXJ2ZXIuc3RhcnQoKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHNlcnZlci5sb2cuZXJyb3IoJ0ZBSUxFRCcsICdTVEFSVCcsIGVycm9yKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfVxuICAgIH0pKCk7XG59XG4iXX0=