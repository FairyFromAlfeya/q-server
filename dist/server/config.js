"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ensureProtocol = ensureProtocol;
exports.parseArangoConfig = parseArangoConfig;
exports.parseMemCachedConfig = parseMemCachedConfig;
exports.overrideDefs = overrideDefs;
exports.resolveValues = resolveValues;
exports.createConfig = createConfig;
exports.parseDataConfig = parseDataConfig;
exports.STATS = exports.programOptions = exports.requestsMode = void 0;

var _os = _interopRequireDefault(require("os"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const DEFAULT_LISTENER_RESTART_TIMEOUT = 1000;
const DEFAULT_ARANGO_MAX_SOCKETS = 100;
const DEFAULT_SLOW_QUERIES_ARANGO_MAX_SOCKETS = 3;
const requestsMode = {
  kafka: 'kafka',
  rest: 'rest'
};
exports.requestsMode = requestsMode;
const programOptions = {};
exports.programOptions = programOptions;

const toPascal = s => `${s[0].toUpperCase()}${s.substr(1).toLowerCase()}`;

const opt = (option, def, description) => {
  const words = option.split('-');
  const name = `${words[0]}${words.slice(1).map(toPascal).join('')}`;
  const env = `Q_${words.map(x => x.toUpperCase()).join('_')}`;
  programOptions[name] = {
    option: `--${option} <value>`,
    env,
    def,
    description: `${description}${def && ` (default: "${def}")`}`
  };
};

const dataOpt = prefix => {
  const o = name => `${prefix.toLowerCase().split(' ').join('-')}-${name}`;

  const d = text => `${toPascal(prefix)} ${text}`;

  opt(o('mut'), 'arangodb', d('mutable db config url'));
  opt(o('hot'), 'arangodb', d('hot db config url'));
  opt(o('cold'), '', d('cold db config urls (comma separated)'));
  opt(o('cache'), '', d('cache config url'));
  opt(o('counterparties'), '', d('counterparties db config url'));
};

opt('host', getIp(), 'Listening address');
opt('port', '4000', 'Listening port');
opt('keep-alive', '60000', 'GraphQL keep alive ms');
opt('requests-mode', 'kafka', 'Requests mode (kafka | rest)');
opt('requests-server', 'kafka:9092', 'Requests server url');
opt('requests-topic', 'requests', 'Requests topic name');
opt('requests-max-size', '16383', 'Maximum request message size in bytes');
dataOpt('data');
dataOpt('slow queries');
opt('auth-endpoint', '', 'Auth endpoint');
opt('mam-access-keys', '', 'Access keys used to authorize mam endpoint access');
opt('jaeger-endpoint', '', 'Jaeger endpoint');
opt('trace-service', 'Q Server', 'Trace service name');
opt('trace-tags', '', 'Additional trace tags (comma separated name=value pairs)');
opt('statsd-server', '', 'StatsD server (host:port)');
opt('statsd-tags', '', 'Additional StatsD tags (comma separated name=value pairs)');
opt('network-name', 'cinet.tonlabs.io', 'Define the name of the network q-server is working with');
opt('cache-key-prefix', 'Q_', 'Prefix string to identify q-server keys in datacache');
opt('endpoints', '', 'Alternative endpoints of q-server (comma separated addresses)'); // Stats Schema

const STATS = {
  start: 'start',
  prefix: 'qserver.',
  doc: {
    count: 'doc.count'
  },
  post: {
    count: 'post.count',
    failed: 'post.failed'
  },
  query: {
    count: 'query.count',
    time: 'query.time',
    active: 'query.active',
    failed: 'query.failed',
    slow: 'query.slow'
  },
  subscription: {
    count: 'subscription.count',
    active: 'subscription.active'
  },
  waitFor: {
    active: 'waitfor.active'
  }
};
exports.STATS = STATS;

function ensureProtocol(address, defaultProtocol) {
  return /^\w+:\/\//gi.test(address) ? address : `${defaultProtocol}://${address}`;
}

function parseArangoEndpoint(config, defMaxSockets) {
  const lowerCased = config.toLowerCase().trim();
  const hasProtocol = lowerCased.startsWith('http:') || lowerCased.startsWith('https:');
  const url = new URL(hasProtocol ? config : `https://${config}`);
  const protocol = url.protocol || 'https:';
  const host = url.port || protocol.toLowerCase() === 'https:' ? url.host : `${url.host}:8529`;
  const path = url.pathname !== '/' ? url.pathname : '';

  const param = name => url.searchParams.get(name) || '';

  return {
    server: `${protocol}//${host}${path}`,
    auth: url.username && `${url.username}:${url.password}`,
    name: param('name') || 'blockchain',
    maxSockets: Number.parseInt(param('maxSockets')) || defMaxSockets,
    listenerRestartTimeout: Number.parseInt(param('listenerRestartTimeout')) || DEFAULT_LISTENER_RESTART_TIMEOUT
  };
}

function parseArangoEndpointList(config, defMaxSockets) {
  return config.split(",").filter(x => x.trim() !== "").map(x => parseArangoEndpoint(x, defMaxSockets));
}

function parseArangoConfig(config, defMaxSockets) {
  return parseArangoEndpointList(config, defMaxSockets)[0] || parseArangoEndpoint('', defMaxSockets);
}

function parseMemCachedConfig(config) {
  return {
    server: config
  };
}

function overrideDefs(options, defs) {
  const resolved = {};
  Object.entries(options).forEach(([name, value]) => {
    const opt = value;
    resolved[name] = { ...opt,
      def: defs[name] || opt.def
    };
  });
  return resolved;
}

function resolveValues(values, env, def) {
  const resolved = {};
  Object.entries(def).forEach(([name, value]) => {
    const opt = value;
    resolved[name] = values[name] || env[opt.env] || def[name].def;
  });
  return resolved;
}

function createConfig(values, env, def) {
  const resolved = resolveValues(values, env, def);
  const {
    data,
    slowQueriesData,
    networkName,
    cacheKeyPrefix
  } = parseDataConfig(resolved);
  return {
    server: {
      host: resolved.host,
      port: Number.parseInt(resolved.port),
      keepAlive: Number.parseInt(resolved.keepAlive)
    },
    requests: {
      mode: resolved.requestsMode,
      server: resolved.requestsServer,
      topic: resolved.requestsTopic,
      maxSize: Number.parseInt(resolved.requestsMaxSize)
    },
    data,
    slowQueriesData,
    authorization: {
      endpoint: resolved.authEndpoint
    },
    mamAccessKeys: new Set((resolved.mamAccessKeys || '').split(',')),
    jaeger: {
      endpoint: resolved.jaegerEndpoint,
      service: resolved.traceService,
      tags: parseTags(resolved.traceTags)
    },
    statsd: {
      server: resolved.statsdServer,
      tags: (resolved.statsdTags || '').split(',').map(x => x.trim()).filter(x => x)
    },
    networkName,
    cacheKeyPrefix,
    endpoints: (resolved.endpoints || '').split(',').map(x => x.trim()).filter(x => x)
  };
} // Internals


function getIp() {
  const ipv4 = Object.values(_os.default.networkInterfaces()).reduce((acc, x) => acc.concat(x), []).find(x => x.family === 'IPv4' && !x.internal);
  return ipv4 && ipv4.address;
}

function parseTags(s) {
  const tags = {};
  s.split(',').forEach(t => {
    const i = t.indexOf('=');

    if (i >= 0) {
      tags[t.substr(0, i)] = t.substr(i + 1);
    } else {
      tags[t] = '';
    }
  });
  return tags;
}

function parseDataConfig(values) {
  function parse(prefix, defMaxSockets) {
    const opt = suffix => values[`${prefix}${suffix}`] || '';

    const mut = parseArangoConfig(opt('Mut'), defMaxSockets);
    const hot = parseArangoConfig(opt('Hot'), defMaxSockets);
    const cold = parseArangoEndpointList(opt('Cold'), defMaxSockets);
    const cache = parseMemCachedConfig(opt('Cache'));
    const counterpartiesOpt = opt('Counterparties');
    const counterparties = counterpartiesOpt ? parseArangoConfig(counterpartiesOpt, defMaxSockets) : mut;
    return {
      mut,
      hot,
      cold,
      cache,
      counterparties
    };
  }

  const {
    networkName,
    cacheKeyPrefix
  } = values;
  return {
    data: parse('data', DEFAULT_ARANGO_MAX_SOCKETS),
    slowQueriesData: parse('slowQueries', DEFAULT_SLOW_QUERIES_ARANGO_MAX_SOCKETS),
    networkName,
    cacheKeyPrefix
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvY29uZmlnLmpzIl0sIm5hbWVzIjpbIkRFRkFVTFRfTElTVEVORVJfUkVTVEFSVF9USU1FT1VUIiwiREVGQVVMVF9BUkFOR09fTUFYX1NPQ0tFVFMiLCJERUZBVUxUX1NMT1dfUVVFUklFU19BUkFOR09fTUFYX1NPQ0tFVFMiLCJyZXF1ZXN0c01vZGUiLCJrYWZrYSIsInJlc3QiLCJwcm9ncmFtT3B0aW9ucyIsInRvUGFzY2FsIiwicyIsInRvVXBwZXJDYXNlIiwic3Vic3RyIiwidG9Mb3dlckNhc2UiLCJvcHQiLCJvcHRpb24iLCJkZWYiLCJkZXNjcmlwdGlvbiIsIndvcmRzIiwic3BsaXQiLCJuYW1lIiwic2xpY2UiLCJtYXAiLCJqb2luIiwiZW52IiwieCIsImRhdGFPcHQiLCJwcmVmaXgiLCJvIiwiZCIsInRleHQiLCJnZXRJcCIsIlNUQVRTIiwic3RhcnQiLCJkb2MiLCJjb3VudCIsInBvc3QiLCJmYWlsZWQiLCJxdWVyeSIsInRpbWUiLCJhY3RpdmUiLCJzbG93Iiwic3Vic2NyaXB0aW9uIiwid2FpdEZvciIsImVuc3VyZVByb3RvY29sIiwiYWRkcmVzcyIsImRlZmF1bHRQcm90b2NvbCIsInRlc3QiLCJwYXJzZUFyYW5nb0VuZHBvaW50IiwiY29uZmlnIiwiZGVmTWF4U29ja2V0cyIsImxvd2VyQ2FzZWQiLCJ0cmltIiwiaGFzUHJvdG9jb2wiLCJzdGFydHNXaXRoIiwidXJsIiwiVVJMIiwicHJvdG9jb2wiLCJob3N0IiwicG9ydCIsInBhdGgiLCJwYXRobmFtZSIsInBhcmFtIiwic2VhcmNoUGFyYW1zIiwiZ2V0Iiwic2VydmVyIiwiYXV0aCIsInVzZXJuYW1lIiwicGFzc3dvcmQiLCJtYXhTb2NrZXRzIiwiTnVtYmVyIiwicGFyc2VJbnQiLCJsaXN0ZW5lclJlc3RhcnRUaW1lb3V0IiwicGFyc2VBcmFuZ29FbmRwb2ludExpc3QiLCJmaWx0ZXIiLCJwYXJzZUFyYW5nb0NvbmZpZyIsInBhcnNlTWVtQ2FjaGVkQ29uZmlnIiwib3ZlcnJpZGVEZWZzIiwib3B0aW9ucyIsImRlZnMiLCJyZXNvbHZlZCIsIk9iamVjdCIsImVudHJpZXMiLCJmb3JFYWNoIiwidmFsdWUiLCJyZXNvbHZlVmFsdWVzIiwidmFsdWVzIiwiY3JlYXRlQ29uZmlnIiwiZGF0YSIsInNsb3dRdWVyaWVzRGF0YSIsIm5ldHdvcmtOYW1lIiwiY2FjaGVLZXlQcmVmaXgiLCJwYXJzZURhdGFDb25maWciLCJrZWVwQWxpdmUiLCJyZXF1ZXN0cyIsIm1vZGUiLCJyZXF1ZXN0c1NlcnZlciIsInRvcGljIiwicmVxdWVzdHNUb3BpYyIsIm1heFNpemUiLCJyZXF1ZXN0c01heFNpemUiLCJhdXRob3JpemF0aW9uIiwiZW5kcG9pbnQiLCJhdXRoRW5kcG9pbnQiLCJtYW1BY2Nlc3NLZXlzIiwiU2V0IiwiamFlZ2VyIiwiamFlZ2VyRW5kcG9pbnQiLCJzZXJ2aWNlIiwidHJhY2VTZXJ2aWNlIiwidGFncyIsInBhcnNlVGFncyIsInRyYWNlVGFncyIsInN0YXRzZCIsInN0YXRzZFNlcnZlciIsInN0YXRzZFRhZ3MiLCJlbmRwb2ludHMiLCJpcHY0Iiwib3MiLCJuZXR3b3JrSW50ZXJmYWNlcyIsInJlZHVjZSIsImFjYyIsImNvbmNhdCIsImZpbmQiLCJmYW1pbHkiLCJpbnRlcm5hbCIsInQiLCJpIiwiaW5kZXhPZiIsInBhcnNlIiwic3VmZml4IiwibXV0IiwiaG90IiwiY29sZCIsImNhY2hlIiwiY291bnRlcnBhcnRpZXNPcHQiLCJjb3VudGVycGFydGllcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFtQkE7Ozs7QUFuQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFxRUEsTUFBTUEsZ0NBQWdDLEdBQUcsSUFBekM7QUFDQSxNQUFNQywwQkFBMEIsR0FBRyxHQUFuQztBQUNBLE1BQU1DLHVDQUF1QyxHQUFHLENBQWhEO0FBRU8sTUFBTUMsWUFBWSxHQUFH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O0FBQ0EsVUFBTW9GLEtBQUssR0FBRzFELG9CQUFvQixDQUFDOUQsR0FBRyxDQUFDLE9BQUQsQ0FBSixDQUFsQztBQUNBLFVBQU15SCxpQkFBaUIsR0FBR3pILEdBQUcsQ0FBQyxnQkFBRCxDQUE3QjtBQUNBLFVBQU0wSCxjQUFjLEdBQUdELGlCQUFpQixHQUNsQzVELGlCQUFpQixDQUFDNEQsaUJBQUQsRUFBb0JyRixhQUFwQixDQURpQixHQUVsQ2lGLEdBRk47QUFHQSxXQUFPO0FBQ0hBLE1BQUFBLEdBREc7QUFFSEMsTUFBQUEsR0FGRztBQUdIQyxNQUFBQSxJQUhHO0FBSUhDLE1BQUFBLEtBSkc7QUFLSEUsTUFBQUE7QUFMRyxLQUFQO0FBT0g7O0FBRUQsUUFBTTtBQUFFOUMsSUFBQUEsV0FBRjtBQUFlQyxJQUFBQTtBQUFmLE1BQWtDTCxNQUF4QztBQUVBLFNBQU87QUFDSEUsSUFBQUEsSUFBSSxFQUFFeUMsS0FBSyxDQUFDLE1BQUQsRUFBUzlILDBCQUFULENBRFI7QUFFSHNGLElBQUFBLGVBQWUsRUFBRXdDLEtBQUssQ0FBQyxhQUFELEVBQWdCN0gsdUNBQWhCLENBRm5CO0FBR0hzRixJQUFBQSxXQUhHO0FBSUhDLElBQUFBO0FBSkcsR0FBUDtBQU1IIiwic291cmNlc0NvbnRlbnQiOlsiLypcbi8qXG4gKiBDb3B5cmlnaHQgMjAxOC0yMDIwIFRPTiBERVYgU09MVVRJT05TIExURC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgU09GVFdBUkUgRVZBTFVBVElPTiBMaWNlbnNlICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2VcbiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZVxuICogTGljZW5zZSBhdDpcbiAqXG4gKiBodHRwOi8vd3d3LnRvbi5kZXYvbGljZW5zZXNcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIFRPTiBERVYgc29mdHdhcmUgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuLy8gQGZsb3dcblxuaW1wb3J0IG9zIGZyb20gJ29zJztcblxuLy8gQ29uZmlnIFNjaGVtYVxuXG5leHBvcnQgdHlwZSBRQXJhbmdvQ29uZmlnID0ge1xuICAgIHNlcnZlcjogc3RyaW5nLFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICBhdXRoOiBzdHJpbmcsXG4gICAgbWF4U29ja2V0czogbnVtYmVyLFxuICAgIGxpc3RlbmVyUmVzdGFydFRpbWVvdXQ6IG51bWJlcjtcbn07XG5cbmV4cG9ydCB0eXBlIFFNZW1DYWNoZWRDb25maWcgPSB7XG4gICAgc2VydmVyOiBzdHJpbmcsXG59O1xuXG5leHBvcnQgdHlwZSBRRGF0YVByb3ZpZGVyc0NvbmZpZyA9IHtcbiAgICBtdXQ6IFFBcmFuZ29Db25maWc7XG4gICAgaG90OiBRQXJhbmdvQ29uZmlnO1xuICAgIGNvbGQ6IFFBcmFuZ29Db25maWdbXTtcbiAgICBjYWNoZTogUU1lbUNhY2hlZENvbmZpZztcbiAgICBjb3VudGVycGFydGllczogUUFyYW5nb0NvbmZpZztcbn07XG5cbmV4cG9ydCB0eXBlIFFDb25maWcgPSB7XG4gICAgc2VydmVyOiB7XG4gICAgICAgIGhvc3Q6IHN0cmluZyxcbiAgICAgICAgcG9ydDogbnVtYmVyLFxuICAgICAgICBrZWVwQWxpdmU6IG51bWJlcixcbiAgICB9LFxuICAgIHJlcXVlc3RzOiB7XG4gICAgICAgIG1vZGU6ICdrYWZrYScgfCAncmVzdCcsXG4gICAgICAgIHNlcnZlcjogc3RyaW5nLFxuICAgICAgICB0b3BpYzogc3RyaW5nLFxuICAgICAgICBtYXhTaXplOiBudW1iZXIsXG4gICAgfSxcbiAgICBkYXRhOiBRRGF0YVByb3ZpZGVyc0NvbmZpZyxcbiAgICBzbG93UXVlcmllc0RhdGE6IFFEYXRhUHJvdmlkZXJzQ29uZmlnLFxuICAgIGF1dGhvcml6YXRpb246IHtcbiAgICAgICAgZW5kcG9pbnQ6IHN0cmluZyxcbiAgICB9LFxuICAgIGphZWdlcjoge1xuICAgICAgICBlbmRwb2ludDogc3RyaW5nLFxuICAgICAgICBzZXJ2aWNlOiBzdHJpbmcsXG4gICAgICAgIHRhZ3M6IHsgW3N0cmluZ106IHN0cmluZyB9XG4gICAgfSxcbiAgICBzdGF0c2Q6IHtcbiAgICAgICAgc2VydmVyOiBzdHJpbmcsXG4gICAgICAgIHRhZ3M6IHN0cmluZ1tdLFxuICAgIH0sXG4gICAgbWFtQWNjZXNzS2V5czogU2V0PHN0cmluZz4sXG4gICAgaXNUZXN0cz86IGJvb2xlYW4sXG4gICAgbmV0d29ya05hbWU6IHN0cmluZyxcbiAgICBjYWNoZUtleVByZWZpeDogc3RyaW5nLFxuICAgIGVuZHBvaW50czogc3RyaW5nW10sXG59XG5cbmV4cG9ydCB0eXBlIFByb2dyYW1PcHRpb24gPSB7XG4gICAgb3B0aW9uOiBzdHJpbmcsXG4gICAgZW52OiBzdHJpbmcsXG4gICAgZGVmOiBzdHJpbmcsXG4gICAgZGVzY3JpcHRpb246IHN0cmluZyxcbn07XG5leHBvcnQgdHlwZSBQcm9ncmFtT3B0aW9ucyA9IHsgW3N0cmluZ106IFByb2dyYW1PcHRpb24gfTtcblxuY29uc3QgREVGQVVMVF9MSVNURU5FUl9SRVNUQVJUX1RJTUVPVVQgPSAxMDAwO1xuY29uc3QgREVGQVVMVF9BUkFOR09fTUFYX1NPQ0tFVFMgPSAxMDA7XG5jb25zdCBERUZBVUxUX1NMT1dfUVVFUklFU19BUkFOR09fTUFYX1NPQ0tFVFMgPSAzO1xuXG5leHBvcnQgY29uc3QgcmVxdWVzdHNNb2RlID0ge1xuICAgIGthZmthOiAna2Fma2EnLFxuICAgIHJlc3Q6ICdyZXN0Jyxcbn07XG5cbmV4cG9ydCBjb25zdCBwcm9ncmFtT3B0aW9uczogUHJvZ3JhbU9wdGlvbnMgPSB7fTtcblxuY29uc3QgdG9QYXNjYWwgPSBzID0+IGAke3NbMF0udG9VcHBlckNhc2UoKX0ke3Muc3Vic3RyKDEpLnRvTG93ZXJDYXNlKCl9YDtcblxuY29uc3Qgb3B0ID0gKG9wdGlvbjogc3RyaW5nLCBkZWY6IHN0cmluZywgZGVzY3JpcHRpb246IHN0cmluZykgPT4ge1xuICAgIGNvbnN0IHdvcmRzID0gb3B0aW9uLnNwbGl0KCctJyk7XG4gICAgY29uc3QgbmFtZSA9IGAke3dvcmRzWzBdfSR7d29yZHMuc2xpY2UoMSkubWFwKHRvUGFzY2FsKS5qb2luKCcnKX1gO1xuICAgIGNvbnN0IGVudiA9IGBRXyR7d29yZHMubWFwKHggPT4geC50b1VwcGVyQ2FzZSgpKS5qb2luKCdfJyl9YDtcbiAgICBwcm9ncmFtT3B0aW9uc1tuYW1lXSA9IHtcbiAgICAgICAgb3B0aW9uOiBgLS0ke29wdGlvbn0gPHZhbHVlPmAsXG4gICAgICAgIGVudixcbiAgICAgICAgZGVmLFxuICAgICAgICBkZXNjcmlwdGlvbjogYCR7ZGVzY3JpcHRpb259JHtkZWYgJiYgYCAoZGVmYXVsdDogXCIke2RlZn1cIilgfWAsXG4gICAgfVxufTtcblxuY29uc3QgZGF0YU9wdCA9IChwcmVmaXg6IHN0cmluZykgPT4ge1xuICAgIGNvbnN0IG8gPSBuYW1lID0+IGAke3ByZWZpeC50b0xvd2VyQ2FzZSgpLnNwbGl0KCcgJykuam9pbignLScpfS0ke25hbWV9YDtcbiAgICBjb25zdCBkID0gdGV4dCA9PiBgJHt0b1Bhc2NhbChwcmVmaXgpfSAke3RleHR9YDtcblxuICAgIG9wdChvKCdtdXQnKSwgJ2FyYW5nb2RiJywgZCgnbXV0YWJsZSBkYiBjb25maWcgdXJsJykpO1xuICAgIG9wdChvKCdob3QnKSwgJ2FyYW5nb2RiJywgZCgnaG90IGRiIGNvbmZpZyB1cmwnKSk7XG4gICAgb3B0KG8oJ2NvbGQnKSwgJycsIGQoJ2NvbGQgZGIgY29uZmlnIHVybHMgKGNvbW1hIHNlcGFyYXRlZCknKSk7XG4gICAgb3B0KG8oJ2NhY2hlJyksICcnLCBkKCdjYWNoZSBjb25maWcgdXJsJykpO1xuICAgIG9wdChvKCdjb3VudGVycGFydGllcycpLCAnJywgZCgnY291bnRlcnBhcnRpZXMgZGIgY29uZmlnIHVybCcpKTtcbn1cblxub3B0KCdob3N0JywgZ2V0SXAoKSwgJ0xpc3RlbmluZyBhZGRyZXNzJyk7XG5vcHQoJ3BvcnQnLCAnNDAwMCcsICdMaXN0ZW5pbmcgcG9ydCcpO1xub3B0KCdrZWVwLWFsaXZlJywgJzYwMDAwJywgJ0dyYXBoUUwga2VlcCBhbGl2ZSBtcycpO1xuXG5vcHQoJ3JlcXVlc3RzLW1vZGUnLCAna2Fma2EnLCAnUmVxdWVzdHMgbW9kZSAoa2Fma2EgfCByZXN0KScpO1xub3B0KCdyZXF1ZXN0cy1zZXJ2ZXInLCAna2Fma2E6OTA5MicsICdSZXF1ZXN0cyBzZXJ2ZXIgdXJsJyk7XG5vcHQoJ3JlcXVlc3RzLXRvcGljJywgJ3JlcXVlc3RzJywgJ1JlcXVlc3RzIHRvcGljIG5hbWUnKTtcbm9wdCgncmVxdWVzdHMtbWF4LXNpemUnLCAnMTYzODMnLCAnTWF4aW11bSByZXF1ZXN0IG1lc3NhZ2Ugc2l6ZSBpbiBieXRlcycpO1xuXG5kYXRhT3B0KCdkYXRhJyk7XG5kYXRhT3B0KCdzbG93IHF1ZXJpZXMnKTtcblxub3B0KCdhdXRoLWVuZHBvaW50JywgJycsICdBdXRoIGVuZHBvaW50Jyk7XG5vcHQoJ21hbS1hY2Nlc3Mta2V5cycsICcnLCAnQWNjZXNzIGtleXMgdXNlZCB0byBhdXRob3JpemUgbWFtIGVuZHBvaW50IGFjY2VzcycpO1xuXG5vcHQoJ2phZWdlci1lbmRwb2ludCcsICcnLCAnSmFlZ2VyIGVuZHBvaW50Jyk7XG5vcHQoJ3RyYWNlLXNlcnZpY2UnLCAnUSBTZXJ2ZXInLCAnVHJhY2Ugc2VydmljZSBuYW1lJyk7XG5vcHQoJ3RyYWNlLXRhZ3MnLCAnJywgJ0FkZGl0aW9uYWwgdHJhY2UgdGFncyAoY29tbWEgc2VwYXJhdGVkIG5hbWU9dmFsdWUgcGFpcnMpJyk7XG5cbm9wdCgnc3RhdHNkLXNlcnZlcicsICcnLCAnU3RhdHNEIHNlcnZlciAoaG9zdDpwb3J0KScpO1xub3B0KCdzdGF0c2QtdGFncycsICcnLCAnQWRkaXRpb25hbCBTdGF0c0QgdGFncyAoY29tbWEgc2VwYXJhdGVkIG5hbWU9dmFsdWUgcGFpcnMpJyk7XG5cbm9wdCgnbmV0d29yay1uYW1lJywgJ2NpbmV0LnRvbmxhYnMuaW8nLCAnRGVmaW5lIHRoZSBuYW1lIG9mIHRoZSBuZXR3b3JrIHEtc2VydmVyIGlzIHdvcmtpbmcgd2l0aCcpO1xuXG5vcHQoJ2NhY2hlLWtleS1wcmVmaXgnLCAnUV8nLCAnUHJlZml4IHN0cmluZyB0byBpZGVudGlmeSBxLXNlcnZlciBrZXlzIGluIGRhdGFjYWNoZScpO1xuXG5vcHQoJ2VuZHBvaW50cycsICcnLCAnQWx0ZXJuYXRpdmUgZW5kcG9pbnRzIG9mIHEtc2VydmVyIChjb21tYSBzZXBhcmF0ZWQgYWRkcmVzc2VzKScpO1xuXG4vLyBTdGF0cyBTY2hlbWFcblxuZXhwb3J0IGNvbnN0IFNUQVRTID0ge1xuICAgIHN0YXJ0OiAnc3RhcnQnLFxuICAgIHByZWZpeDogJ3FzZXJ2ZXIuJyxcbiAgICBkb2M6IHtcbiAgICAgICAgY291bnQ6ICdkb2MuY291bnQnLFxuICAgIH0sXG4gICAgcG9zdDoge1xuICAgICAgICBjb3VudDogJ3Bvc3QuY291bnQnLFxuICAgICAgICBmYWlsZWQ6ICdwb3N0LmZhaWxlZCcsXG4gICAgfSxcbiAgICBxdWVyeToge1xuICAgICAgICBjb3VudDogJ3F1ZXJ5LmNvdW50JyxcbiAgICAgICAgdGltZTogJ3F1ZXJ5LnRpbWUnLFxuICAgICAgICBhY3RpdmU6ICdxdWVyeS5hY3RpdmUnLFxuICAgICAgICBmYWlsZWQ6ICdxdWVyeS5mYWlsZWQnLFxuICAgICAgICBzbG93OiAncXVlcnkuc2xvdycsXG4gICAgfSxcbiAgICBzdWJzY3JpcHRpb246IHtcbiAgICAgICAgY291bnQ6ICdzdWJzY3JpcHRpb24uY291bnQnLFxuICAgICAgICBhY3RpdmU6ICdzdWJzY3JpcHRpb24uYWN0aXZlJyxcbiAgICB9LFxuICAgIHdhaXRGb3I6IHtcbiAgICAgICAgYWN0aXZlOiAnd2FpdGZvci5hY3RpdmUnLFxuICAgIH0sXG59O1xuXG5cbmV4cG9ydCBmdW5jdGlvbiBlbnN1cmVQcm90b2NvbChhZGRyZXNzOiBzdHJpbmcsIGRlZmF1bHRQcm90b2NvbDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gL15cXHcrOlxcL1xcLy9naS50ZXN0KGFkZHJlc3MpID8gYWRkcmVzcyA6IGAke2RlZmF1bHRQcm90b2NvbH06Ly8ke2FkZHJlc3N9YDtcbn1cblxuZnVuY3Rpb24gcGFyc2VBcmFuZ29FbmRwb2ludChjb25maWc6IHN0cmluZywgZGVmTWF4U29ja2V0czogbnVtYmVyKTogUUFyYW5nb0NvbmZpZyB7XG4gICAgY29uc3QgbG93ZXJDYXNlZCA9IGNvbmZpZy50b0xvd2VyQ2FzZSgpLnRyaW0oKTtcbiAgICBjb25zdCBoYXNQcm90b2NvbCA9IGxvd2VyQ2FzZWQuc3RhcnRzV2l0aCgnaHR0cDonKSB8fCBsb3dlckNhc2VkLnN0YXJ0c1dpdGgoJ2h0dHBzOicpO1xuICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoaGFzUHJvdG9jb2wgPyBjb25maWcgOiBgaHR0cHM6Ly8ke2NvbmZpZ31gKTtcbiAgICBjb25zdCBwcm90b2NvbCA9IHVybC5wcm90b2NvbCB8fCAnaHR0cHM6JztcbiAgICBjb25zdCBob3N0ID0gKHVybC5wb3J0IHx8IHByb3RvY29sLnRvTG93ZXJDYXNlKCkgPT09ICdodHRwczonKSA/IHVybC5ob3N0IDogYCR7dXJsLmhvc3R9Ojg1MjlgO1xuICAgIGNvbnN0IHBhdGggPSB1cmwucGF0aG5hbWUgIT09ICcvJyA/IHVybC5wYXRobmFtZSA6ICcnO1xuICAgIGNvbnN0IHBhcmFtID0gbmFtZSA9PiB1cmwuc2VhcmNoUGFyYW1zLmdldChuYW1lKSB8fCAnJztcbiAgICByZXR1cm4ge1xuICAgICAgICBzZXJ2ZXI6IGAke3Byb3RvY29sfS8vJHtob3N0fSR7cGF0aH1gLFxuICAgICAgICBhdXRoOiB1cmwudXNlcm5hbWUgJiYgYCR7dXJsLnVzZXJuYW1lfToke3VybC5wYXNzd29yZH1gLFxuICAgICAgICBuYW1lOiBwYXJhbSgnbmFtZScpIHx8ICdibG9ja2NoYWluJyxcbiAgICAgICAgbWF4U29ja2V0czogTnVtYmVyLnBhcnNlSW50KHBhcmFtKCdtYXhTb2NrZXRzJykpIHx8IGRlZk1heFNvY2tldHMsXG4gICAgICAgIGxpc3RlbmVyUmVzdGFydFRpbWVvdXQ6IE51bWJlci5wYXJzZUludChwYXJhbSgnbGlzdGVuZXJSZXN0YXJ0VGltZW91dCcpKSB8fCBERUZBVUxUX0xJU1RFTkVSX1JFU1RBUlRfVElNRU9VVCxcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHBhcnNlQXJhbmdvRW5kcG9pbnRMaXN0KGNvbmZpZzogc3RyaW5nLCBkZWZNYXhTb2NrZXRzOiBudW1iZXIpOiBRQXJhbmdvQ29uZmlnW10ge1xuICAgIHJldHVybiBjb25maWdcbiAgICAgICAgLnNwbGl0KFwiLFwiKVxuICAgICAgICAuZmlsdGVyKHggPT4geC50cmltKCkgIT09IFwiXCIpXG4gICAgICAgIC5tYXAoeCA9PiBwYXJzZUFyYW5nb0VuZHBvaW50KHgsIGRlZk1heFNvY2tldHMpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlQXJhbmdvQ29uZmlnKGNvbmZpZzogc3RyaW5nLCBkZWZNYXhTb2NrZXRzOiBudW1iZXIpOiBRQXJhbmdvQ29uZmlnIHtcbiAgICByZXR1cm4gcGFyc2VBcmFuZ29FbmRwb2ludExpc3QoY29uZmlnLCBkZWZNYXhTb2NrZXRzKVswXVxuICAgICAgICB8fCBwYXJzZUFyYW5nb0VuZHBvaW50KCcnLCBkZWZNYXhTb2NrZXRzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlTWVtQ2FjaGVkQ29uZmlnKGNvbmZpZzogc3RyaW5nKTogUU1lbUNhY2hlZENvbmZpZyB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgc2VydmVyOiBjb25maWcsXG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gb3ZlcnJpZGVEZWZzKG9wdGlvbnM6IFByb2dyYW1PcHRpb25zLCBkZWZzOiBhbnkpOiBQcm9ncmFtT3B0aW9ucyB7XG4gICAgY29uc3QgcmVzb2x2ZWQgPSB7fTtcbiAgICBPYmplY3QuZW50cmllcyhvcHRpb25zKS5mb3JFYWNoKChbbmFtZSwgdmFsdWVdKSA9PiB7XG4gICAgICAgIGNvbnN0IG9wdCA9ICgodmFsdWU6IGFueSk6IFByb2dyYW1PcHRpb24pO1xuICAgICAgICByZXNvbHZlZFtuYW1lXSA9IHtcbiAgICAgICAgICAgIC4uLm9wdCxcbiAgICAgICAgICAgIGRlZjogZGVmc1tuYW1lXSB8fCBvcHQuZGVmLFxuICAgICAgICB9O1xuICAgIH0pO1xuICAgIHJldHVybiByZXNvbHZlZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlc29sdmVWYWx1ZXModmFsdWVzOiBhbnksIGVudjogYW55LCBkZWY6IFByb2dyYW1PcHRpb25zKTogYW55IHtcbiAgICBjb25zdCByZXNvbHZlZCA9IHt9O1xuICAgIE9iamVjdC5lbnRyaWVzKGRlZikuZm9yRWFjaCgoW25hbWUsIHZhbHVlXSkgPT4ge1xuICAgICAgICBjb25zdCBvcHQgPSAoKHZhbHVlOiBhbnkpOiBQcm9ncmFtT3B0aW9uKTtcbiAgICAgICAgcmVzb2x2ZWRbbmFtZV0gPSB2YWx1ZXNbbmFtZV0gfHwgZW52W29wdC5lbnZdIHx8IGRlZltuYW1lXS5kZWY7XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc29sdmVkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQ29uZmlnKFxuICAgIHZhbHVlczogYW55LFxuICAgIGVudjogYW55LFxuICAgIGRlZjogUHJvZ3JhbU9wdGlvbnMsXG4pOiBRQ29uZmlnIHtcbiAgICBjb25zdCByZXNvbHZlZCA9IHJlc29sdmVWYWx1ZXModmFsdWVzLCBlbnYsIGRlZik7XG4gICAgY29uc3QgeyBkYXRhLCBzbG93UXVlcmllc0RhdGEsIG5ldHdvcmtOYW1lLCBjYWNoZUtleVByZWZpeCB9ID0gcGFyc2VEYXRhQ29uZmlnKHJlc29sdmVkKTtcbiAgICByZXR1cm4ge1xuICAgICAgICBzZXJ2ZXI6IHtcbiAgICAgICAgICAgIGhvc3Q6IHJlc29sdmVkLmhvc3QsXG4gICAgICAgICAgICBwb3J0OiBOdW1iZXIucGFyc2VJbnQocmVzb2x2ZWQucG9ydCksXG4gICAgICAgICAgICBrZWVwQWxpdmU6IE51bWJlci5wYXJzZUludChyZXNvbHZlZC5rZWVwQWxpdmUpLFxuICAgICAgICB9LFxuICAgICAgICByZXF1ZXN0czoge1xuICAgICAgICAgICAgbW9kZTogcmVzb2x2ZWQucmVxdWVzdHNNb2RlLFxuICAgICAgICAgICAgc2VydmVyOiByZXNvbHZlZC5yZXF1ZXN0c1NlcnZlcixcbiAgICAgICAgICAgIHRvcGljOiByZXNvbHZlZC5yZXF1ZXN0c1RvcGljLFxuICAgICAgICAgICAgbWF4U2l6ZTogTnVtYmVyLnBhcnNlSW50KHJlc29sdmVkLnJlcXVlc3RzTWF4U2l6ZSksXG4gICAgICAgIH0sXG4gICAgICAgIGRhdGEsXG4gICAgICAgIHNsb3dRdWVyaWVzRGF0YSxcbiAgICAgICAgYXV0aG9yaXphdGlvbjoge1xuICAgICAgICAgICAgZW5kcG9pbnQ6IHJlc29sdmVkLmF1dGhFbmRwb2ludCxcbiAgICAgICAgfSxcbiAgICAgICAgbWFtQWNjZXNzS2V5czogbmV3IFNldCgocmVzb2x2ZWQubWFtQWNjZXNzS2V5cyB8fCAnJykuc3BsaXQoJywnKSksXG4gICAgICAgIGphZWdlcjoge1xuICAgICAgICAgICAgZW5kcG9pbnQ6IHJlc29sdmVkLmphZWdlckVuZHBvaW50LFxuICAgICAgICAgICAgc2VydmljZTogcmVzb2x2ZWQudHJhY2VTZXJ2aWNlLFxuICAgICAgICAgICAgdGFnczogcGFyc2VUYWdzKHJlc29sdmVkLnRyYWNlVGFncyksXG4gICAgICAgIH0sXG4gICAgICAgIHN0YXRzZDoge1xuICAgICAgICAgICAgc2VydmVyOiByZXNvbHZlZC5zdGF0c2RTZXJ2ZXIsXG4gICAgICAgICAgICB0YWdzOiAocmVzb2x2ZWQuc3RhdHNkVGFncyB8fCAnJykuc3BsaXQoJywnKS5tYXAoeCA9PiB4LnRyaW0oKSkuZmlsdGVyKHggPT4geCksXG4gICAgICAgIH0sXG4gICAgICAgIG5ldHdvcmtOYW1lLFxuICAgICAgICBjYWNoZUtleVByZWZpeCxcbiAgICAgICAgZW5kcG9pbnRzOiAocmVzb2x2ZWQuZW5kcG9pbnRzIHx8ICcnKS5zcGxpdCgnLCcpLm1hcCh4ID0+IHgudHJpbSgpKS5maWx0ZXIoeCA9PiB4KVxuICAgIH07XG59XG5cbi8vIEludGVybmFsc1xuXG5mdW5jdGlvbiBnZXRJcCgpOiBzdHJpbmcge1xuICAgIGNvbnN0IGlwdjQgPSAoT2JqZWN0LnZhbHVlcyhvcy5uZXR3b3JrSW50ZXJmYWNlcygpKTogYW55KVxuICAgICAgICAucmVkdWNlKChhY2MsIHgpID0+IGFjYy5jb25jYXQoeCksIFtdKVxuICAgICAgICAuZmluZCh4ID0+IHguZmFtaWx5ID09PSAnSVB2NCcgJiYgIXguaW50ZXJuYWwpO1xuICAgIHJldHVybiBpcHY0ICYmIGlwdjQuYWRkcmVzcztcbn1cblxuXG5mdW5jdGlvbiBwYXJzZVRhZ3Moczogc3RyaW5nKTogeyBbc3RyaW5nXTogc3RyaW5nIH0ge1xuICAgIGNvbnN0IHRhZ3M6IHsgW3N0cmluZ106IHN0cmluZyB9ID0ge307XG4gICAgcy5zcGxpdCgnLCcpLmZvckVhY2goKHQpID0+IHtcbiAgICAgICAgY29uc3QgaSA9IHQuaW5kZXhPZignPScpO1xuICAgICAgICBpZiAoaSA+PSAwKSB7XG4gICAgICAgICAgICB0YWdzW3Quc3Vic3RyKDAsIGkpXSA9IHQuc3Vic3RyKGkgKyAxKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRhZ3NbdF0gPSAnJztcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiB0YWdzO1xuXG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlRGF0YUNvbmZpZyh2YWx1ZXM6IGFueSk6IHtcbiAgICBkYXRhOiBRRGF0YVByb3ZpZGVyc0NvbmZpZyxcbiAgICBzbG93UXVlcmllc0RhdGE6IFFEYXRhUHJvdmlkZXJzQ29uZmlnLFxuICAgIG5ldHdvcmtOYW1lOiBzdHJpbmcsXG4gICAgY2FjaGVLZXlQcmVmaXg6IHN0cmluZyxcbn0ge1xuICAgIGZ1bmN0aW9uIHBhcnNlKHByZWZpeDogc3RyaW5nLCBkZWZNYXhTb2NrZXRzOiBudW1iZXIpOiBRRGF0YVByb3ZpZGVyc0NvbmZpZyB7XG4gICAgICAgIGNvbnN0IG9wdCA9IChzdWZmaXg6IHN0cmluZyk6IHN0cmluZyA9PiB2YWx1ZXNbYCR7cHJlZml4fSR7c3VmZml4fWBdIHx8ICcnO1xuICAgICAgICBjb25zdCBtdXQgPSBwYXJzZUFyYW5nb0NvbmZpZyhvcHQoJ011dCcpLCBkZWZNYXhTb2NrZXRzKTtcbiAgICAgICAgY29uc3QgaG90ID0gcGFyc2VBcmFuZ29Db25maWcob3B0KCdIb3QnKSwgZGVmTWF4U29ja2V0cyk7XG4gICAgICAgIGNvbnN0IGNvbGQgPSBwYXJzZUFyYW5nb0VuZHBvaW50TGlzdChvcHQoJ0NvbGQnKSwgZGVmTWF4U29ja2V0cyk7XG4gICAgICAgIGNvbnN0IGNhY2hlID0gcGFyc2VNZW1DYWNoZWRDb25maWcob3B0KCdDYWNoZScpKTtcbiAgICAgICAgY29uc3QgY291bnRlcnBhcnRpZXNPcHQgPSBvcHQoJ0NvdW50ZXJwYXJ0aWVzJyk7XG4gICAgICAgIGNvbnN0IGNvdW50ZXJwYXJ0aWVzID0gY291bnRlcnBhcnRpZXNPcHRcbiAgICAgICAgICAgID8gcGFyc2VBcmFuZ29Db25maWcoY291bnRlcnBhcnRpZXNPcHQsIGRlZk1heFNvY2tldHMpXG4gICAgICAgICAgICA6IG11dDtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG11dCxcbiAgICAgICAgICAgIGhvdCxcbiAgICAgICAgICAgIGNvbGQsXG4gICAgICAgICAgICBjYWNoZSxcbiAgICAgICAgICAgIGNvdW50ZXJwYXJ0aWVzLFxuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgeyBuZXR3b3JrTmFtZSwgY2FjaGVLZXlQcmVmaXggfSA9IHZhbHVlcztcblxuICAgIHJldHVybiB7XG4gICAgICAgIGRhdGE6IHBhcnNlKCdkYXRhJywgREVGQVVMVF9BUkFOR09fTUFYX1NPQ0tFVFMpLFxuICAgICAgICBzbG93UXVlcmllc0RhdGE6IHBhcnNlKCdzbG93UXVlcmllcycsIERFRkFVTFRfU0xPV19RVUVSSUVTX0FSQU5HT19NQVhfU09DS0VUUyksXG4gICAgICAgIG5ldHdvcmtOYW1lLFxuICAgICAgICBjYWNoZUtleVByZWZpeCxcbiAgICB9O1xufVxuIl19