"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ensureProtocol = ensureProtocol;
exports.parseArangoConfig = parseArangoConfig;
exports.parseMemCachedConfig = parseMemCachedConfig;
exports.overrideDefs = overrideDefs;
exports.resolveValues = resolveValues;
exports.createConfig = createConfig;
exports.parseDataConfig = parseDataConfig;
exports.STATS = exports.programOptions = exports.requestsMode = void 0;

var _os = _interopRequireDefault(require("os"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const DEFAULT_LISTENER_RESTART_TIMEOUT = 1000;
const DEFAULT_ARANGO_MAX_SOCKETS = 100;
const DEFAULT_SLOW_QUERIES_ARANGO_MAX_SOCKETS = 3;
const requestsMode = {
  kafka: 'kafka',
  rest: 'rest'
};
exports.requestsMode = requestsMode;
const programOptions = {};
exports.programOptions = programOptions;

const toPascal = s => `${s[0].toUpperCase()}${s.substr(1).toLowerCase()}`;

const opt = (option, def, description) => {
  const words = option.split('-');
  const name = `${words[0]}${words.slice(1).map(toPascal).join('')}`;
  const env = `Q_${words.map(x => x.toUpperCase()).join('_')}`;
  programOptions[name] = {
    option: `--${option} <value>`,
    env,
    def,
    description: `${description}${def && ` (default: "${def}")`}`
  };
};

const dataOpt = prefix => {
  const o = name => `${prefix.toLowerCase().split(' ').join('-')}-${name}`;

  const d = text => `${toPascal(prefix)} ${text}`;

  opt(o('mut'), 'arangodb', d('mutable db config url'));
  opt(o('hot'), 'arangodb', d('hot db config url'));
  opt(o('cold'), '', d('cold db config urls (comma separated)'));
  opt(o('cache'), '', d('cache config url'));
};

opt('host', getIp(), 'Listening address');
opt('port', '4000', 'Listening port');
opt('keep-alive', '60000', 'GraphQL keep alive ms');
opt('requests-mode', 'kafka', 'Requests mode (kafka | rest)');
opt('requests-server', 'kafka:9092', 'Requests server url');
opt('requests-topic', 'requests', 'Requests topic name');
dataOpt('data');
dataOpt('slow queries');
opt('auth-endpoint', '', 'Auth endpoint');
opt('mam-access-keys', '', 'Access keys used to authorize mam endpoint access');
opt('jaeger-endpoint', '', 'Jaeger endpoint');
opt('trace-service', 'Q Server', 'Trace service name');
opt('trace-tags', '', 'Additional trace tags (comma separated name=value pairs)');
opt('statsd-server', '', 'StatsD server (host:port)');
opt('statsd-tags', '', 'Additional StatsD tags (comma separated name=value pairs)');
opt('network-name', 'cinet.tonlabs.io', 'Define the name of the network q-server is working with');
opt('cache-key-prefix', 'Q_', 'Prefix string to identify q-server keys in datacache');
opt('endpoints', '', 'Alternative endpoints of q-server (comma separated addresses)'); // Stats Schema

const STATS = {
  start: 'start',
  prefix: 'qserver.',
  doc: {
    count: 'doc.count'
  },
  post: {
    count: 'post.count',
    failed: 'post.failed'
  },
  query: {
    count: 'query.count',
    time: 'query.time',
    active: 'query.active',
    failed: 'query.failed',
    slow: 'query.slow'
  },
  subscription: {
    active: 'subscription.active'
  },
  waitFor: {
    active: 'waitfor.active'
  }
};
exports.STATS = STATS;

function ensureProtocol(address, defaultProtocol) {
  return /^\w+:\/\//gi.test(address) ? address : `${defaultProtocol}://${address}`;
}

function parseArangoEndpoint(config, defMaxSockets) {
  const lowerCased = config.toLowerCase().trim();
  const hasProtocol = lowerCased.startsWith('http:') || lowerCased.startsWith('https:');
  const url = new URL(hasProtocol ? config : `https://${config}`);
  const protocol = url.protocol || 'https:';
  const host = url.port || protocol.toLowerCase() === 'https:' ? url.host : `${url.host}:8529`;
  const path = url.pathname !== '/' ? url.pathname : '';

  const param = name => url.searchParams.get(name) || '';

  return {
    server: `${protocol}//${host}${path}`,
    auth: url.username && `${url.username}:${url.password}`,
    name: param('name') || 'blockchain',
    maxSockets: Number.parseInt(param('maxSockets')) || defMaxSockets,
    listenerRestartTimeout: Number.parseInt(param('listenerRestartTimeout')) || DEFAULT_LISTENER_RESTART_TIMEOUT
  };
}

function parseArangoEndpointList(config, defMaxSockets) {
  return config.split(",").filter(x => x.trim() !== "").map(x => parseArangoEndpoint(x, defMaxSockets));
}

function parseArangoConfig(config, defMaxSockets) {
  return parseArangoEndpointList(config, defMaxSockets)[0] || parseArangoEndpoint('', defMaxSockets);
}

function parseMemCachedConfig(config) {
  return {
    server: config
  };
}

function overrideDefs(options, defs) {
  const resolved = {};
  Object.entries(options).forEach(([name, value]) => {
    const opt = value;
    resolved[name] = { ...opt,
      def: defs[name] || opt.def
    };
  });
  return resolved;
}

function resolveValues(values, env, def) {
  const resolved = {};
  Object.entries(def).forEach(([name, value]) => {
    const opt = value;
    resolved[name] = values[name] || env[opt.env] || def[name].def;
  });
  return resolved;
}

function createConfig(values, env, def) {
  const resolved = resolveValues(values, env, def);
  const {
    data,
    slowQueriesData,
    networkName,
    cacheKeyPrefix
  } = parseDataConfig(resolved);
  return {
    server: {
      host: resolved.host,
      port: Number.parseInt(resolved.port),
      keepAlive: Number.parseInt(resolved.keepAlive)
    },
    requests: {
      mode: resolved.requestsMode,
      server: resolved.requestsServer,
      topic: resolved.requestsTopic
    },
    data,
    slowQueriesData,
    authorization: {
      endpoint: resolved.authEndpoint
    },
    mamAccessKeys: new Set((resolved.mamAccessKeys || '').split(',')),
    jaeger: {
      endpoint: resolved.jaegerEndpoint,
      service: resolved.traceService,
      tags: parseTags(resolved.traceTags)
    },
    statsd: {
      server: resolved.statsdServer,
      tags: (resolved.statsdTags || '').split(',').map(x => x.trim()).filter(x => x)
    },
    networkName,
    cacheKeyPrefix,
    endpoints: (resolved.endpoints || '').split(',').map(x => x.trim()).filter(x => x)
  };
} // Internals


function getIp() {
  const ipv4 = Object.values(_os.default.networkInterfaces()).reduce((acc, x) => acc.concat(x), []).find(x => x.family === 'IPv4' && !x.internal);
  return ipv4 && ipv4.address;
}

function parseTags(s) {
  const tags = {};
  s.split(',').forEach(t => {
    const i = t.indexOf('=');

    if (i >= 0) {
      tags[t.substr(0, i)] = t.substr(i + 1);
    } else {
      tags[t] = '';
    }
  });
  return tags;
}

function parseDataConfig(values) {
  function parse(prefix, defMaxSockets) {
    const opt = suffix => values[`${prefix}${suffix}`] || '';

    return {
      mut: parseArangoConfig(opt('Mut'), defMaxSockets),
      hot: parseArangoConfig(opt('Hot'), defMaxSockets),
      cold: parseArangoEndpointList(opt('Cold'), defMaxSockets),
      cache: parseMemCachedConfig(opt('Cache'))
    };
  }

  const {
    networkName,
    cacheKeyPrefix
  } = values;
  return {
    data: parse('data', DEFAULT_ARANGO_MAX_SOCKETS),
    slowQueriesData: parse('slowQueries', DEFAULT_SLOW_QUERIES_ARANGO_MAX_SOCKETS),
    networkName,
    cacheKeyPrefix
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvY29uZmlnLmpzIl0sIm5hbWVzIjpbIkRFRkFVTFRfTElTVEVORVJfUkVTVEFSVF9USU1FT1VUIiwiREVGQVVMVF9BUkFOR09fTUFYX1NPQ0tFVFMiLCJERUZBVUxUX1NMT1dfUVVFUklFU19BUkFOR09fTUFYX1NPQ0tFVFMiLCJyZXF1ZXN0c01vZGUiLCJrYWZrYSIsInJlc3QiLCJwcm9ncmFtT3B0aW9ucyIsInRvUGFzY2FsIiwicyIsInRvVXBwZXJDYXNlIiwic3Vic3RyIiwidG9Mb3dlckNhc2UiLCJvcHQiLCJvcHRpb24iLCJkZWYiLCJkZXNjcmlwdGlvbiIsIndvcmRzIiwic3BsaXQiLCJuYW1lIiwic2xpY2UiLCJtYXAiLCJqb2luIiwiZW52IiwieCIsImRhdGFPcHQiLCJwcmVmaXgiLCJvIiwiZCIsInRleHQiLCJnZXRJcCIsIlNUQVRTIiwic3RhcnQiLCJkb2MiLCJjb3VudCIsInBvc3QiLCJmYWlsZWQiLCJxdWVyeSIsInRpbWUiLCJhY3RpdmUiLCJzbG93Iiwic3Vic2NyaXB0aW9uIiwid2FpdEZvciIsImVuc3VyZVByb3RvY29sIiwiYWRkcmVzcyIsImRlZmF1bHRQcm90b2NvbCIsInRlc3QiLCJwYXJzZUFyYW5nb0VuZHBvaW50IiwiY29uZmlnIiwiZGVmTWF4U29ja2V0cyIsImxvd2VyQ2FzZWQiLCJ0cmltIiwiaGFzUHJvdG9jb2wiLCJzdGFydHNXaXRoIiwidXJsIiwiVVJMIiwicHJvdG9jb2wiLCJob3N0IiwicG9ydCIsInBhdGgiLCJwYXRobmFtZSIsInBhcmFtIiwic2VhcmNoUGFyYW1zIiwiZ2V0Iiwic2VydmVyIiwiYXV0aCIsInVzZXJuYW1lIiwicGFzc3dvcmQiLCJtYXhTb2NrZXRzIiwiTnVtYmVyIiwicGFyc2VJbnQiLCJsaXN0ZW5lclJlc3RhcnRUaW1lb3V0IiwicGFyc2VBcmFuZ29FbmRwb2ludExpc3QiLCJmaWx0ZXIiLCJwYXJzZUFyYW5nb0NvbmZpZyIsInBhcnNlTWVtQ2FjaGVkQ29uZmlnIiwib3ZlcnJpZGVEZWZzIiwib3B0aW9ucyIsImRlZnMiLCJyZXNvbHZlZCIsIk9iamVjdCIsImVudHJpZXMiLCJmb3JFYWNoIiwidmFsdWUiLCJyZXNvbHZlVmFsdWVzIiwidmFsdWVzIiwiY3JlYXRlQ29uZmlnIiwiZGF0YSIsInNsb3dRdWVyaWVzRGF0YSIsIm5ldHdvcmtOYW1lIiwiY2FjaGVLZXlQcmVmaXgiLCJwYXJzZURhdGFDb25maWciLCJrZWVwQWxpdmUiLCJyZXF1ZXN0cyIsIm1vZGUiLCJyZXF1ZXN0c1NlcnZlciIsInRvcGljIiwicmVxdWVzdHNUb3BpYyIsImF1dGhvcml6YXRpb24iLCJlbmRwb2ludCIsImF1dGhFbmRwb2ludCIsIm1hbUFjY2Vzc0tleXMiLCJTZXQiLCJqYWVnZXIiLCJqYWVnZXJFbmRwb2ludCIsInNlcnZpY2UiLCJ0cmFjZVNlcnZpY2UiLCJ0YWdzIiwicGFyc2VUYWdzIiwidHJhY2VUYWdzIiwic3RhdHNkIiwic3RhdHNkU2VydmVyIiwic3RhdHNkVGFncyIsImVuZHBvaW50cyIsImlwdjQiLCJvcyIsIm5ldHdvcmtJbnRlcmZhY2VzIiwicmVkdWNlIiwiYWNjIiwiY29uY2F0IiwiZmluZCIsImZhbWlseSIsImludGVybmFsIiwidCIsImkiLCJpbmRleE9mIiwicGFyc2UiLCJzdWZmaXgiLCJtdXQiLCJob3QiLCJjb2xkIiwiY2FjaGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBbUJBOzs7O0FBbkJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBbUVBLE1BQU1BLGdDQUFnQyxHQUFHLElBQXpDO0FBQ0EsTUFBTUMsMEJBQTBCLEdBQUcsR0FBbkM7QUFDQSxNQUFNQyx1Q0FBdUMsR0FBRyxDQUFoRDtBQUVPLE1BQU1DLFlBQVksR0FBRztBQUN4QkMsRUFBQUEsS0FBSyxFQUFFLE9BRGlCO0FBRXhCQyxFQUFBQSxJQUFJLEVBQUU7QUFGa0IsQ0FBckI7O0FBS0EsTUFBTUMsY0FBOEIsR0FBRyxFQUF2Qzs7O0FBRVAsTUFBTUMsUUFBUSxHQUFHQyxDQUFDLElBQUssR0FBRUEsQ0FBQyxDQUFDLENBQUQsQ0FBRCxDQUFLQyxXQUFMLEVBQW1CLEdBQUVELENBQUMsQ0FBQ0UsTUFBRixDQUFTLENBQVQsRUFBWUMsV0FBWixFQUEwQixFQUF4RTs7QUFFQSxNQUFNQyxHQUFHLEdBQUcsQ0FBQ0MsTUFBRCxFQUFpQkMsR0FBakIsRUFBOEJDLFdBQTlCLEtBQXNEO0FBQzlELFFBQU1DLEtBQUssR0FBR0gsTUFBTSxDQUFDSSxLQUFQLENBQWEsR0FBYixDQUFkO0FBQ0EsUUFBTUMsSUFBSSxHQUFJLEdBQUVGLEtBQUssQ0FBQyxDQUFELENBQUksR0FBRUEsS0FBSyxDQUFDRyxLQUFOLENBQVksQ0FBWixFQUFlQyxHQUFmLENBQW1CYixRQUFuQixFQUE2QmMsSUFBN0IsQ0FBa0MsRUFBbEMsQ0FBc0MsRUFBakU7QUFDQSxRQUFNQyxHQUFHLEdBQUksS0FBSU4sS0FBSyxDQUFDSSxHQUFOLENBQVVHLENBQUMsSUFBSUEsQ0FBQyxDQUFDZCxXQUFGLEVBQWYsRUFBZ0NZLElBQWhDLENBQXFDLEdBQXJDLENBQTBDLEVBQTNEO0FBQ0FmLEVBQUFBLGNBQWMsQ0FBQ1ksSUFBRCxDQUFkLEdBQXVCO0FBQ25CTCxJQUFBQSxNQUFNLEVBQUcsS0FBSUEsTUFBTyxVQUREO0FBRW5CUyxJQUFBQSxHQUZtQjtBQUduQlIsSUFBQUEsR0FIbUI7QUFJbkJDLElBQUFBLFdBQVcsRUFBRyxHQUFFQSxXQUFZLEdBQUVELEdBQUcsSUFBSyxlQUFjQSxHQUFJLElBQUk7QUFKekMsR0FBdkI7QUFNSCxDQVZEOztBQVlBLE1BQU1VLE9BQU8sR0FBSUMsTUFBRCxJQUFvQjtBQUNoQyxRQUFNQyxDQUFDLEdBQUdSLElBQUksSUFBSyxHQUFFTyxNQUFNLENBQUNkLFdBQVAsR0FBcUJNLEtBQXJCLENBQTJCLEdBQTNCLEVBQWdDSSxJQUFoQyxDQUFxQyxHQUFyQyxDQUEwQyxJQUFHSCxJQUFLLEVBQXZFOztBQUNBLFFBQU1TLENBQUMsR0FBR0MsSUFBSSxJQUFLLEdBQUVyQixRQUFRLENBQUNrQixNQUFELENBQVMsSUFBR0csSUFBSyxFQUE5Qzs7QUFFQWhCLEVBQUFBLEdBQUcsQ0FBQ2MsQ0FBQyxDQUFDLEtBQUQsQ0FBRixFQUFXLFVBQVgsRUFBdUJDLENBQUMsQ0FBQyx1QkFBRCxDQUF4QixDQUFIO0FBQ0FmLEVBQUFBLEdBQUcsQ0FBQ2MsQ0FBQyxDQUFDLEtBQUQsQ0FBRixFQUFXLFVBQVgsRUFBdUJDLENBQUMsQ0FBQyxtQkFBRCxDQUF4QixDQUFIO0FBQ0FmLEVBQUFBLEdBQUcsQ0FBQ2MsQ0FBQyxDQUFDLE1BQUQsQ0FBRixFQUFZLEVBQVosRUFBZ0JDLENBQUMsQ0FBQyx1Q0FBRCxDQUFqQixDQUFIO0FBQ0FmLEVBQUFBLEdBQUcsQ0FBQ2MsQ0FBQyxDQUFDLE9BQUQsQ0FBRixFQUFhLEVBQWIsRUFBaUJDLENBQUMsQ0FBQyxrQkFBRCxDQUFsQixDQUFIO0FBQ0gsQ0FSRDs7QUFVQWYsR0FBRyxDQUFDLE1BQUQsRUFBU2lCLEtBQUssRUFBZCxFQUFrQixtQkFBbEIsQ0FBSDtBQUNBakIsR0FBRyxDQUFDLE1BQUQsRUFBUyxNQUFULEVBQWlCLGdCQUFqQixDQUFIO0FBQ0FBLEdBQUcsQ0FBQyxZQUFELEVBQWUsT0FBZixFQUF3Qix1QkFBeEIsQ0FBSDtBQUVBQSxHQUFHLENBQUMsZUFBRCxFQUFrQixPQUFsQixFQUEyQiw4QkFBM0IsQ0FBSDtBQUNBQSxHQUFHLENBQUMsaUJBQUQsRUFBb0IsWUFBcEIsRUFBa0MscUJBQWxDLENBQUg7QUFDQUEsR0FBRyxDQUFDLGdCQUFELEVBQW1CLFVBQW5CLEVBQStCLHFCQUEvQixDQUFIO0FBRUFZLE9BQU8sQ0FBQyxNQUFELENBQVA7QUFDQUEsT0FBTyxDQUFDLGNBQUQsQ0FBUDtBQUVBWixHQUFHLENBQUMsZUFBRCxFQUFrQixFQUFsQixFQUFzQixlQUF0QixDQUFIO0FBQ0FBLEdBQUcsQ0FBQyxpQkFBRCxFQUFvQixFQUFwQixFQUF3QixtREFBeEIsQ0FBSDtBQUVBQSxHQUFHLENBQUMsaUJBQUQsRUFBb0IsRUFBcEIsRUFBd0IsaUJBQXhCLENBQUg7QUFDQUEsR0FBRyxDQUFDLGVBQUQsRUFBa0IsVUFBbEIsRUFBOEIsb0JBQTlCLENBQUg7QUFDQUEsR0FBRyxDQUFDLFlBQUQsRUFBZSxFQUFmLEVBQW1CLDBEQUFuQixDQUFIO0FBRUFBLEdBQUcsQ0FBQyxlQUFELEVBQWtCLEVBQWxCLEVBQXNCLDJCQUF0QixDQUFIO0FBQ0FBLEdBQUcsQ0FBQyxhQUFELEVBQWdCLEVBQWhCLEVBQW9CLDJEQUFwQixDQUFIO0FBRUFBLEdBQUcsQ0FBQyxjQUFELEVBQWlCLGtCQUFqQixFQUFxQyx5REFBckMsQ0FBSDtBQUVBQSxHQUFHLENBQUMsa0JBQUQsRUFBcUIsSUFBckIsRUFBMkIsc0RBQTNCLENBQUg7QUFFQUEsR0FBRyxDQUFDLFdBQUQsRUFBYyxFQUFkLEVBQWtCLCtEQUFsQixDQUFILEMsQ0FFQTs7QUFFTyxNQUFNa0IsS0FBSyxHQUFHO0FBQ2pCQyxFQUFBQSxLQUFLLEVBQUUsT0FEVTtBQUVqQk4sRUFBQUEsTUFBTSxFQUFFLFVBRlM7QUFHakJPLEVBQUFBLEdBQUcsRUFBRTtBQUNEQyxJQUFBQSxLQUFLLEVBQUU7QUFETixHQUhZO0FBTWpCQyxFQUFBQSxJQUFJLEVBQUU7QUFDRkQsSUFBQUEsS0FBSyxFQUFFLFlBREw7QUFFRkUsSUFBQUEsTUFBTSxFQUFFO0FBRk4sR0FOVztBQVVqQkMsRUFBQUEsS0FBSyxFQUFFO0FBQ0hILElBQUFBLEtBQUssRUFBRSxhQURKO0FBRUhJLElBQUFBLElBQUksRUFBRSxZQUZIO0FBR0hDLElBQUFBLE1BQU0sRUFBRSxjQUhMO0FBSUhILElBQUFBLE1BQU0sRUFBRSxjQUpMO0FBS0hJLElBQUFBLElBQUksRUFBRTtBQUxILEdBVlU7QUFpQmpCQyxFQUFBQSxZQUFZLEVBQUU7QUFDVkYsSUFBQUEsTUFBTSxFQUFFO0FBREUsR0FqQkc7QUFvQmpCRyxFQUFBQSxPQUFPLEVBQUU7QUFDTEgsSUFBQUEsTUFBTSxFQUFFO0FBREg7QUFwQlEsQ0FBZDs7O0FBMEJBLFNBQVNJLGNBQVQsQ0FBd0JDLE9BQXhCLEVBQXlDQyxlQUF6QyxFQUEwRTtBQUM3RSxTQUFPLGNBQWNDLElBQWQsQ0FBbUJGLE9BQW5CLElBQThCQSxPQUE5QixHQUF5QyxHQUFFQyxlQUFnQixNQUFLRCxPQUFRLEVBQS9FO0FBQ0g7O0FBRUQsU0FBU0csbUJBQVQsQ0FBNkJDLE1BQTdCLEVBQTZDQyxhQUE3QyxFQUFtRjtBQUMvRSxRQUFNQyxVQUFVLEdBQUdGLE1BQU0sQ0FBQ3BDLFdBQVAsR0FBcUJ1QyxJQUFyQixFQUFuQjtBQUNBLFFBQU1DLFdBQVcsR0FBR0YsVUFBVSxDQUFDRyxVQUFYLENBQXNCLE9BQXRCLEtBQWtDSCxVQUFVLENBQUNHLFVBQVgsQ0FBc0IsUUFBdEIsQ0FBdEQ7QUFDQSxRQUFNQyxHQUFHLEdBQUcsSUFBSUMsR0FBSixDQUFRSCxXQUFXLEdBQUdKLE1BQUgsR0FBYSxXQUFVQSxNQUFPLEVBQWpELENBQVo7QUFDQSxRQUFNUSxRQUFRLEdBQUdGLEdBQUcsQ0FBQ0UsUUFBSixJQUFnQixRQUFqQztBQUNBLFFBQU1DLElBQUksR0FBSUgsR0FBRyxDQUFDSSxJQUFKLElBQVlGLFFBQVEsQ0FBQzVDLFdBQVQsT0FBMkIsUUFBeEMsR0FBb0QwQyxHQUFHLENBQUNHLElBQXhELEdBQWdFLEdBQUVILEdBQUcsQ0FBQ0csSUFBSyxPQUF4RjtBQUNBLFFBQU1FLElBQUksR0FBR0wsR0FBRyxDQUFDTSxRQUFKLEtBQWlCLEdBQWpCLEdBQXVCTixHQUFHLENBQUNNLFFBQTNCLEdBQXNDLEVBQW5EOztBQUNBLFFBQU1DLEtBQUssR0FBRzFDLElBQUksSUFBSW1DLEdBQUcsQ0FBQ1EsWUFBSixDQUFpQkMsR0FBakIsQ0FBcUI1QyxJQUFyQixLQUE4QixFQUFwRDs7QUFDQSxTQUFPO0FBQ0g2QyxJQUFBQSxNQUFNLEVBQUcsR0FBRVIsUUFBUyxLQUFJQyxJQUFLLEdBQUVFLElBQUssRUFEakM7QUFFSE0sSUFBQUEsSUFBSSxFQUFFWCxHQUFHLENBQUNZLFFBQUosSUFBaUIsR0FBRVosR0FBRyxDQUFDWSxRQUFTLElBQUdaLEdBQUcsQ0FBQ2EsUUFBUyxFQUZuRDtBQUdIaEQsSUFBQUEsSUFBSSxFQUFFMEMsS0FBSyxDQUFDLE1BQUQsQ0FBTCxJQUFpQixZQUhwQjtBQUlITyxJQUFBQSxVQUFVLEVBQUVDLE1BQU0sQ0FBQ0MsUUFBUCxDQUFnQlQsS0FBSyxDQUFDLFlBQUQsQ0FBckIsS0FBd0NaLGFBSmpEO0FBS0hzQixJQUFBQSxzQkFBc0IsRUFBRUYsTUFBTSxDQUFDQyxRQUFQLENBQWdCVCxLQUFLLENBQUMsd0JBQUQsQ0FBckIsS0FBb0Q1RDtBQUx6RSxHQUFQO0FBT0g7O0FBRUQsU0FBU3VFLHVCQUFULENBQWlDeEIsTUFBakMsRUFBaURDLGFBQWpELEVBQXlGO0FBQ3JGLFNBQU9ELE1BQU0sQ0FDUjlCLEtBREUsQ0FDSSxHQURKLEVBRUZ1RCxNQUZFLENBRUtqRCxDQUFDLElBQUlBLENBQUMsQ0FBQzJCLElBQUYsT0FBYSxFQUZ2QixFQUdGOUIsR0FIRSxDQUdFRyxDQUFDLElBQUl1QixtQkFBbUIsQ0FBQ3ZCLENBQUQsRUFBSXlCLGFBQUosQ0FIMUIsQ0FBUDtBQUlIOztBQUVNLFNBQVN5QixpQkFBVCxDQUEyQjFCLE1BQTNCLEVBQTJDQyxhQUEzQyxFQUFpRjtBQUNwRixTQUFPdUIsdUJBQXVCLENBQUN4QixNQUFELEVBQVNDLGFBQVQsQ0FBdkIsQ0FBK0MsQ0FBL0MsS0FDQUYsbUJBQW1CLENBQUMsRUFBRCxFQUFLRSxhQUFMLENBRDFCO0FBRUg7O0FBRU0sU0FBUzBCLG9CQUFULENBQThCM0IsTUFBOUIsRUFBZ0U7QUFDbkUsU0FBTztBQUNIZ0IsSUFBQUEsTUFBTSxFQUFFaEI7QUFETCxHQUFQO0FBR0g7O0FBRU0sU0FBUzRCLFlBQVQsQ0FBc0JDLE9BQXRCLEVBQStDQyxJQUEvQyxFQUEwRTtBQUM3RSxRQUFNQyxRQUFRLEdBQUcsRUFBakI7QUFDQUMsRUFBQUEsTUFBTSxDQUFDQyxPQUFQLENBQWVKLE9BQWYsRUFBd0JLLE9BQXhCLENBQWdDLENBQUMsQ0FBQy9ELElBQUQsRUFBT2dFLEtBQVAsQ0FBRCxLQUFtQjtBQUMvQyxVQUFNdEUsR0FBRyxHQUFLc0UsS0FBZDtBQUNBSixJQUFBQSxRQUFRLENBQUM1RCxJQUFELENBQVIsR0FBaUIsRUFDYixHQUFHTixHQURVO0FBRWJFLE1BQUFBLEdBQUcsRUFBRStELElBQUksQ0FBQzNELElBQUQsQ0FBSixJQUFjTixHQUFHLENBQUNFO0FBRlYsS0FBakI7QUFJSCxHQU5EO0FBT0EsU0FBT2dFLFFBQVA7QUFDSDs7QUFFTSxTQUFTSyxhQUFULENBQXVCQyxNQUF2QixFQUFvQzlELEdBQXBDLEVBQThDUixHQUE5QyxFQUF3RTtBQUMzRSxRQUFNZ0UsUUFBUSxHQUFHLEVBQWpCO0FBQ0FDLEVBQUFBLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlbEUsR0FBZixFQUFvQm1FLE9BQXBCLENBQTRCLENBQUMsQ0FBQy9ELElBQUQsRUFBT2dFLEtBQVAsQ0FBRCxLQUFtQjtBQUMzQyxVQUFNdEUsR0FBRyxHQUFLc0UsS0FBZDtBQUNBSixJQUFBQSxRQUFRLENBQUM1RCxJQUFELENBQVIsR0FBaUJrRSxNQUFNLENBQUNsRSxJQUFELENBQU4sSUFBZ0JJLEdBQUcsQ0FBQ1YsR0FBRyxDQUFDVSxHQUFMLENBQW5CLElBQWdDUixHQUFHLENBQUNJLElBQUQsQ0FBSCxDQUFVSixHQUEzRDtBQUNILEdBSEQ7QUFJQSxTQUFPZ0UsUUFBUDtBQUNIOztBQUVNLFNBQVNPLFlBQVQsQ0FDSEQsTUFERyxFQUVIOUQsR0FGRyxFQUdIUixHQUhHLEVBSUk7QUFDUCxRQUFNZ0UsUUFBUSxHQUFHSyxhQUFhLENBQUNDLE1BQUQsRUFBUzlELEdBQVQsRUFBY1IsR0FBZCxDQUE5QjtBQUNBLFFBQU07QUFBRXdFLElBQUFBLElBQUY7QUFBUUMsSUFBQUEsZUFBUjtBQUF5QkMsSUFBQUEsV0FBekI7QUFBc0NDLElBQUFBO0FBQXRDLE1BQXlEQyxlQUFlLENBQUNaLFFBQUQsQ0FBOUU7QUFDQSxTQUFPO0FBQ0hmLElBQUFBLE1BQU0sRUFBRTtBQUNKUCxNQUFBQSxJQUFJLEVBQUVzQixRQUFRLENBQUN0QixJQURYO0FBRUpDLE1BQUFBLElBQUksRUFBRVcsTUFBTSxDQUFDQyxRQUFQLENBQWdCUyxRQUFRLENBQUNyQixJQUF6QixDQUZGO0FBR0prQyxNQUFBQSxTQUFTLEVBQUV2QixNQUFNLENBQUNDLFFBQVAsQ0FBZ0JTLFFBQVEsQ0FBQ2EsU0FBekI7QUFIUCxLQURMO0FBTUhDLElBQUFBLFFBQVEsRUFBRTtBQUNOQyxNQUFBQSxJQUFJLEVBQUVmLFFBQVEsQ0FBQzNFLFlBRFQ7QUFFTjRELE1BQUFBLE1BQU0sRUFBRWUsUUFBUSxDQUFDZ0IsY0FGWDtBQUdOQyxNQUFBQSxLQUFLLEVBQUVqQixRQUFRLENBQUNrQjtBQUhWLEtBTlA7QUFXSFYsSUFBQUEsSUFYRztBQVlIQyxJQUFBQSxlQVpHO0FBYUhVLElBQUFBLGFBQWEsRUFBRTtBQUNYQyxNQUFBQSxRQUFRLEVBQUVwQixRQUFRLENBQUNxQjtBQURSLEtBYlo7QUFnQkhDLElBQUFBLGFBQWEsRUFBRSxJQUFJQyxHQUFKLENBQVEsQ0FBQ3ZCLFFBQVEsQ0FBQ3NCLGFBQVQsSUFBMEIsRUFBM0IsRUFBK0JuRixLQUEvQixDQUFxQyxHQUFyQyxDQUFSLENBaEJaO0FBaUJIcUYsSUFBQUEsTUFBTSxFQUFFO0FBQ0pKLE1BQUFBLFFBQVEsRUFBRXBCLFFBQVEsQ0FBQ3lCLGNBRGY7QUFFSkMsTUFBQUEsT0FBTyxFQUFFMUIsUUFBUSxDQUFDMkIsWUFGZDtBQUdKQyxNQUFBQSxJQUFJLEVBQUVDLFNBQVMsQ0FBQzdCLFFBQVEsQ0FBQzhCLFNBQVY7QUFIWCxLQWpCTDtBQXNCSEMsSUFBQUEsTUFBTSxFQUFFO0FBQ0o5QyxNQUFBQSxNQUFNLEVBQUVlLFFBQVEsQ0FBQ2dDLFlBRGI7QUFFSkosTUFBQUEsSUFBSSxFQUFFLENBQUM1QixRQUFRLENBQUNpQyxVQUFULElBQXVCLEVBQXhCLEVBQTRCOUYsS0FBNUIsQ0FBa0MsR0FBbEMsRUFBdUNHLEdBQXZDLENBQTJDRyxDQUFDLElBQUlBLENBQUMsQ0FBQzJCLElBQUYsRUFBaEQsRUFBMERzQixNQUExRCxDQUFpRWpELENBQUMsSUFBSUEsQ0FBdEU7QUFGRixLQXRCTDtBQTBCSGlFLElBQUFBLFdBMUJHO0FBMkJIQyxJQUFBQSxjQTNCRztBQTRCSHVCLElBQUFBLFNBQVMsRUFBRSxDQUFDbEMsUUFBUSxDQUFDa0MsU0FBVCxJQUFzQixFQUF2QixFQUEyQi9GLEtBQTNCLENBQWlDLEdBQWpDLEVBQXNDRyxHQUF0QyxDQUEwQ0csQ0FBQyxJQUFJQSxDQUFDLENBQUMyQixJQUFGLEVBQS9DLEVBQXlEc0IsTUFBekQsQ0FBZ0VqRCxDQUFDLElBQUlBLENBQXJFO0FBNUJSLEdBQVA7QUE4QkgsQyxDQUVEOzs7QUFFQSxTQUFTTSxLQUFULEdBQXlCO0FBQ3JCLFFBQU1vRixJQUFJLEdBQUlsQyxNQUFNLENBQUNLLE1BQVAsQ0FBYzhCLFlBQUdDLGlCQUFILEVBQWQsQ0FBRCxDQUNSQyxNQURRLENBQ0QsQ0FBQ0MsR0FBRCxFQUFNOUYsQ0FBTixLQUFZOEYsR0FBRyxDQUFDQyxNQUFKLENBQVcvRixDQUFYLENBRFgsRUFDMEIsRUFEMUIsRUFFUmdHLElBRlEsQ0FFSGhHLENBQUMsSUFBSUEsQ0FBQyxDQUFDaUcsTUFBRixLQUFhLE1BQWIsSUFBdUIsQ0FBQ2pHLENBQUMsQ0FBQ2tHLFFBRjVCLENBQWI7QUFHQSxTQUFPUixJQUFJLElBQUlBLElBQUksQ0FBQ3RFLE9BQXBCO0FBQ0g7O0FBR0QsU0FBU2dFLFNBQVQsQ0FBbUJuRyxDQUFuQixFQUFvRDtBQUNoRCxRQUFNa0csSUFBMEIsR0FBRyxFQUFuQztBQUNBbEcsRUFBQUEsQ0FBQyxDQUFDUyxLQUFGLENBQVEsR0FBUixFQUFhZ0UsT0FBYixDQUFzQnlDLENBQUQsSUFBTztBQUN4QixVQUFNQyxDQUFDLEdBQUdELENBQUMsQ0FBQ0UsT0FBRixDQUFVLEdBQVYsQ0FBVjs7QUFDQSxRQUFJRCxDQUFDLElBQUksQ0FBVCxFQUFZO0FBQ1JqQixNQUFBQSxJQUFJLENBQUNnQixDQUFDLENBQUNoSCxNQUFGLENBQVMsQ0FBVCxFQUFZaUgsQ0FBWixDQUFELENBQUosR0FBdUJELENBQUMsQ0FBQ2hILE1BQUYsQ0FBU2lILENBQUMsR0FBRyxDQUFiLENBQXZCO0FBQ0gsS0FGRCxNQUVPO0FBQ0hqQixNQUFBQSxJQUFJLENBQUNnQixDQUFELENBQUosR0FBVSxFQUFWO0FBQ0g7QUFDSixHQVBEO0FBUUEsU0FBT2hCLElBQVA7QUFFSDs7QUFHTSxTQUFTaEIsZUFBVCxDQUF5Qk4sTUFBekIsRUFLTDtBQUNFLFdBQVN5QyxLQUFULENBQWVwRyxNQUFmLEVBQStCdUIsYUFBL0IsRUFBNEU7QUFDeEUsVUFBTXBDLEdBQUcsR0FBSWtILE1BQUQsSUFBNEIxQyxNQUFNLENBQUUsR0FBRTNELE1BQU8sR0FBRXFHLE1BQU8sRUFBcEIsQ0FBTixJQUFnQyxFQUF4RTs7QUFDQSxXQUFPO0FBQ0hDLE1BQUFBLEdBQUcsRUFBRXRELGlCQUFpQixDQUFDN0QsR0FBRyxDQUFDLEtBQUQsQ0FBSixFQUFhb0MsYUFBYixDQURuQjtBQUVIZ0YsTUFBQUEsR0FBRyxFQUFFdkQsaUJBQWlCLENBQUM3RCxHQUFHLENBQUMsS0FBRCxDQUFKLEVBQWFvQyxhQUFiLENBRm5CO0FBR0hpRixNQUFBQSxJQUFJLEVBQUUxRCx1QkFBdUIsQ0FBQzNELEdBQUcsQ0FBQyxNQUFELENBQUosRUFBY29DLGFBQWQsQ0FIMUI7QUFJSGtGLE1BQUFBLEtBQUssRUFBRXhELG9CQUFvQixDQUFDOUQsR0FBRyxDQUFDLE9BQUQsQ0FBSjtBQUp4QixLQUFQO0FBTUg7O0FBRUQsUUFBTTtBQUFFNEUsSUFBQUEsV0FBRjtBQUFlQyxJQUFBQTtBQUFmLE1BQWtDTCxNQUF4QztBQUVBLFNBQU87QUFDSEUsSUFBQUEsSUFBSSxFQUFFdUMsS0FBSyxDQUFDLE1BQUQsRUFBUzVILDBCQUFULENBRFI7QUFFSHNGLElBQUFBLGVBQWUsRUFBRXNDLEtBQUssQ0FBQyxhQUFELEVBQWdCM0gsdUNBQWhCLENBRm5CO0FBR0hzRixJQUFBQSxXQUhHO0FBSUhDLElBQUFBO0FBSkcsR0FBUDtBQU1IIiwic291cmNlc0NvbnRlbnQiOlsiLypcbi8qXG4gKiBDb3B5cmlnaHQgMjAxOC0yMDIwIFRPTiBERVYgU09MVVRJT05TIExURC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgU09GVFdBUkUgRVZBTFVBVElPTiBMaWNlbnNlICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2VcbiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZVxuICogTGljZW5zZSBhdDpcbiAqXG4gKiBodHRwOi8vd3d3LnRvbi5kZXYvbGljZW5zZXNcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIFRPTiBERVYgc29mdHdhcmUgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuLy8gQGZsb3dcblxuaW1wb3J0IG9zIGZyb20gJ29zJztcblxuLy8gQ29uZmlnIFNjaGVtYVxuXG5leHBvcnQgdHlwZSBRQXJhbmdvQ29uZmlnID0ge1xuICAgIHNlcnZlcjogc3RyaW5nLFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICBhdXRoOiBzdHJpbmcsXG4gICAgbWF4U29ja2V0czogbnVtYmVyLFxuICAgIGxpc3RlbmVyUmVzdGFydFRpbWVvdXQ6IG51bWJlcjtcbn07XG5cbmV4cG9ydCB0eXBlIFFNZW1DYWNoZWRDb25maWcgPSB7XG4gICAgc2VydmVyOiBzdHJpbmcsXG59O1xuXG5leHBvcnQgdHlwZSBRRGF0YVByb3ZpZGVyc0NvbmZpZyA9IHtcbiAgICBtdXQ6IFFBcmFuZ29Db25maWc7XG4gICAgaG90OiBRQXJhbmdvQ29uZmlnO1xuICAgIGNvbGQ6IFFBcmFuZ29Db25maWdbXTtcbiAgICBjYWNoZTogUU1lbUNhY2hlZENvbmZpZztcbn07XG5cbmV4cG9ydCB0eXBlIFFDb25maWcgPSB7XG4gICAgc2VydmVyOiB7XG4gICAgICAgIGhvc3Q6IHN0cmluZyxcbiAgICAgICAgcG9ydDogbnVtYmVyLFxuICAgICAgICBrZWVwQWxpdmU6IG51bWJlcixcbiAgICB9LFxuICAgIHJlcXVlc3RzOiB7XG4gICAgICAgIG1vZGU6ICdrYWZrYScgfCAncmVzdCcsXG4gICAgICAgIHNlcnZlcjogc3RyaW5nLFxuICAgICAgICB0b3BpYzogc3RyaW5nLFxuICAgIH0sXG4gICAgZGF0YTogUURhdGFQcm92aWRlcnNDb25maWcsXG4gICAgc2xvd1F1ZXJpZXNEYXRhOiBRRGF0YVByb3ZpZGVyc0NvbmZpZyxcbiAgICBhdXRob3JpemF0aW9uOiB7XG4gICAgICAgIGVuZHBvaW50OiBzdHJpbmcsXG4gICAgfSxcbiAgICBqYWVnZXI6IHtcbiAgICAgICAgZW5kcG9pbnQ6IHN0cmluZyxcbiAgICAgICAgc2VydmljZTogc3RyaW5nLFxuICAgICAgICB0YWdzOiB7IFtzdHJpbmddOiBzdHJpbmcgfVxuICAgIH0sXG4gICAgc3RhdHNkOiB7XG4gICAgICAgIHNlcnZlcjogc3RyaW5nLFxuICAgICAgICB0YWdzOiBzdHJpbmdbXSxcbiAgICB9LFxuICAgIG1hbUFjY2Vzc0tleXM6IFNldDxzdHJpbmc+LFxuICAgIGlzVGVzdHM/OiBib29sZWFuLFxuICAgIG5ldHdvcmtOYW1lOiBzdHJpbmcsXG4gICAgY2FjaGVLZXlQcmVmaXg6IHN0cmluZyxcbiAgICBlbmRwb2ludHM6IHN0cmluZ1tdLFxufVxuXG5leHBvcnQgdHlwZSBQcm9ncmFtT3B0aW9uID0ge1xuICAgIG9wdGlvbjogc3RyaW5nLFxuICAgIGVudjogc3RyaW5nLFxuICAgIGRlZjogc3RyaW5nLFxuICAgIGRlc2NyaXB0aW9uOiBzdHJpbmcsXG59O1xuZXhwb3J0IHR5cGUgUHJvZ3JhbU9wdGlvbnMgPSB7IFtzdHJpbmddOiBQcm9ncmFtT3B0aW9uIH07XG5cbmNvbnN0IERFRkFVTFRfTElTVEVORVJfUkVTVEFSVF9USU1FT1VUID0gMTAwMDtcbmNvbnN0IERFRkFVTFRfQVJBTkdPX01BWF9TT0NLRVRTID0gMTAwO1xuY29uc3QgREVGQVVMVF9TTE9XX1FVRVJJRVNfQVJBTkdPX01BWF9TT0NLRVRTID0gMztcblxuZXhwb3J0IGNvbnN0IHJlcXVlc3RzTW9kZSA9IHtcbiAgICBrYWZrYTogJ2thZmthJyxcbiAgICByZXN0OiAncmVzdCcsXG59O1xuXG5leHBvcnQgY29uc3QgcHJvZ3JhbU9wdGlvbnM6IFByb2dyYW1PcHRpb25zID0ge307XG5cbmNvbnN0IHRvUGFzY2FsID0gcyA9PiBgJHtzWzBdLnRvVXBwZXJDYXNlKCl9JHtzLnN1YnN0cigxKS50b0xvd2VyQ2FzZSgpfWA7XG5cbmNvbnN0IG9wdCA9IChvcHRpb246IHN0cmluZywgZGVmOiBzdHJpbmcsIGRlc2NyaXB0aW9uOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCB3b3JkcyA9IG9wdGlvbi5zcGxpdCgnLScpO1xuICAgIGNvbnN0IG5hbWUgPSBgJHt3b3Jkc1swXX0ke3dvcmRzLnNsaWNlKDEpLm1hcCh0b1Bhc2NhbCkuam9pbignJyl9YDtcbiAgICBjb25zdCBlbnYgPSBgUV8ke3dvcmRzLm1hcCh4ID0+IHgudG9VcHBlckNhc2UoKSkuam9pbignXycpfWA7XG4gICAgcHJvZ3JhbU9wdGlvbnNbbmFtZV0gPSB7XG4gICAgICAgIG9wdGlvbjogYC0tJHtvcHRpb259IDx2YWx1ZT5gLFxuICAgICAgICBlbnYsXG4gICAgICAgIGRlZixcbiAgICAgICAgZGVzY3JpcHRpb246IGAke2Rlc2NyaXB0aW9ufSR7ZGVmICYmIGAgKGRlZmF1bHQ6IFwiJHtkZWZ9XCIpYH1gLFxuICAgIH1cbn07XG5cbmNvbnN0IGRhdGFPcHQgPSAocHJlZml4OiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCBvID0gbmFtZSA9PiBgJHtwcmVmaXgudG9Mb3dlckNhc2UoKS5zcGxpdCgnICcpLmpvaW4oJy0nKX0tJHtuYW1lfWA7XG4gICAgY29uc3QgZCA9IHRleHQgPT4gYCR7dG9QYXNjYWwocHJlZml4KX0gJHt0ZXh0fWA7XG5cbiAgICBvcHQobygnbXV0JyksICdhcmFuZ29kYicsIGQoJ211dGFibGUgZGIgY29uZmlnIHVybCcpKTtcbiAgICBvcHQobygnaG90JyksICdhcmFuZ29kYicsIGQoJ2hvdCBkYiBjb25maWcgdXJsJykpO1xuICAgIG9wdChvKCdjb2xkJyksICcnLCBkKCdjb2xkIGRiIGNvbmZpZyB1cmxzIChjb21tYSBzZXBhcmF0ZWQpJykpO1xuICAgIG9wdChvKCdjYWNoZScpLCAnJywgZCgnY2FjaGUgY29uZmlnIHVybCcpKTtcbn1cblxub3B0KCdob3N0JywgZ2V0SXAoKSwgJ0xpc3RlbmluZyBhZGRyZXNzJyk7XG5vcHQoJ3BvcnQnLCAnNDAwMCcsICdMaXN0ZW5pbmcgcG9ydCcpO1xub3B0KCdrZWVwLWFsaXZlJywgJzYwMDAwJywgJ0dyYXBoUUwga2VlcCBhbGl2ZSBtcycpO1xuXG5vcHQoJ3JlcXVlc3RzLW1vZGUnLCAna2Fma2EnLCAnUmVxdWVzdHMgbW9kZSAoa2Fma2EgfCByZXN0KScpO1xub3B0KCdyZXF1ZXN0cy1zZXJ2ZXInLCAna2Fma2E6OTA5MicsICdSZXF1ZXN0cyBzZXJ2ZXIgdXJsJyk7XG5vcHQoJ3JlcXVlc3RzLXRvcGljJywgJ3JlcXVlc3RzJywgJ1JlcXVlc3RzIHRvcGljIG5hbWUnKTtcblxuZGF0YU9wdCgnZGF0YScpO1xuZGF0YU9wdCgnc2xvdyBxdWVyaWVzJyk7XG5cbm9wdCgnYXV0aC1lbmRwb2ludCcsICcnLCAnQXV0aCBlbmRwb2ludCcpO1xub3B0KCdtYW0tYWNjZXNzLWtleXMnLCAnJywgJ0FjY2VzcyBrZXlzIHVzZWQgdG8gYXV0aG9yaXplIG1hbSBlbmRwb2ludCBhY2Nlc3MnKTtcblxub3B0KCdqYWVnZXItZW5kcG9pbnQnLCAnJywgJ0phZWdlciBlbmRwb2ludCcpO1xub3B0KCd0cmFjZS1zZXJ2aWNlJywgJ1EgU2VydmVyJywgJ1RyYWNlIHNlcnZpY2UgbmFtZScpO1xub3B0KCd0cmFjZS10YWdzJywgJycsICdBZGRpdGlvbmFsIHRyYWNlIHRhZ3MgKGNvbW1hIHNlcGFyYXRlZCBuYW1lPXZhbHVlIHBhaXJzKScpO1xuXG5vcHQoJ3N0YXRzZC1zZXJ2ZXInLCAnJywgJ1N0YXRzRCBzZXJ2ZXIgKGhvc3Q6cG9ydCknKTtcbm9wdCgnc3RhdHNkLXRhZ3MnLCAnJywgJ0FkZGl0aW9uYWwgU3RhdHNEIHRhZ3MgKGNvbW1hIHNlcGFyYXRlZCBuYW1lPXZhbHVlIHBhaXJzKScpO1xuXG5vcHQoJ25ldHdvcmstbmFtZScsICdjaW5ldC50b25sYWJzLmlvJywgJ0RlZmluZSB0aGUgbmFtZSBvZiB0aGUgbmV0d29yayBxLXNlcnZlciBpcyB3b3JraW5nIHdpdGgnKTtcblxub3B0KCdjYWNoZS1rZXktcHJlZml4JywgJ1FfJywgJ1ByZWZpeCBzdHJpbmcgdG8gaWRlbnRpZnkgcS1zZXJ2ZXIga2V5cyBpbiBkYXRhY2FjaGUnKTtcblxub3B0KCdlbmRwb2ludHMnLCAnJywgJ0FsdGVybmF0aXZlIGVuZHBvaW50cyBvZiBxLXNlcnZlciAoY29tbWEgc2VwYXJhdGVkIGFkZHJlc3NlcyknKTtcblxuLy8gU3RhdHMgU2NoZW1hXG5cbmV4cG9ydCBjb25zdCBTVEFUUyA9IHtcbiAgICBzdGFydDogJ3N0YXJ0JyxcbiAgICBwcmVmaXg6ICdxc2VydmVyLicsXG4gICAgZG9jOiB7XG4gICAgICAgIGNvdW50OiAnZG9jLmNvdW50JyxcbiAgICB9LFxuICAgIHBvc3Q6IHtcbiAgICAgICAgY291bnQ6ICdwb3N0LmNvdW50JyxcbiAgICAgICAgZmFpbGVkOiAncG9zdC5mYWlsZWQnLFxuICAgIH0sXG4gICAgcXVlcnk6IHtcbiAgICAgICAgY291bnQ6ICdxdWVyeS5jb3VudCcsXG4gICAgICAgIHRpbWU6ICdxdWVyeS50aW1lJyxcbiAgICAgICAgYWN0aXZlOiAncXVlcnkuYWN0aXZlJyxcbiAgICAgICAgZmFpbGVkOiAncXVlcnkuZmFpbGVkJyxcbiAgICAgICAgc2xvdzogJ3F1ZXJ5LnNsb3cnLFxuICAgIH0sXG4gICAgc3Vic2NyaXB0aW9uOiB7XG4gICAgICAgIGFjdGl2ZTogJ3N1YnNjcmlwdGlvbi5hY3RpdmUnLFxuICAgIH0sXG4gICAgd2FpdEZvcjoge1xuICAgICAgICBhY3RpdmU6ICd3YWl0Zm9yLmFjdGl2ZScsXG4gICAgfSxcbn07XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGVuc3VyZVByb3RvY29sKGFkZHJlc3M6IHN0cmluZywgZGVmYXVsdFByb3RvY29sOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiAvXlxcdys6XFwvXFwvL2dpLnRlc3QoYWRkcmVzcykgPyBhZGRyZXNzIDogYCR7ZGVmYXVsdFByb3RvY29sfTovLyR7YWRkcmVzc31gO1xufVxuXG5mdW5jdGlvbiBwYXJzZUFyYW5nb0VuZHBvaW50KGNvbmZpZzogc3RyaW5nLCBkZWZNYXhTb2NrZXRzOiBudW1iZXIpOiBRQXJhbmdvQ29uZmlnIHtcbiAgICBjb25zdCBsb3dlckNhc2VkID0gY29uZmlnLnRvTG93ZXJDYXNlKCkudHJpbSgpO1xuICAgIGNvbnN0IGhhc1Byb3RvY29sID0gbG93ZXJDYXNlZC5zdGFydHNXaXRoKCdodHRwOicpIHx8IGxvd2VyQ2FzZWQuc3RhcnRzV2l0aCgnaHR0cHM6Jyk7XG4gICAgY29uc3QgdXJsID0gbmV3IFVSTChoYXNQcm90b2NvbCA/IGNvbmZpZyA6IGBodHRwczovLyR7Y29uZmlnfWApO1xuICAgIGNvbnN0IHByb3RvY29sID0gdXJsLnByb3RvY29sIHx8ICdodHRwczonO1xuICAgIGNvbnN0IGhvc3QgPSAodXJsLnBvcnQgfHwgcHJvdG9jb2wudG9Mb3dlckNhc2UoKSA9PT0gJ2h0dHBzOicpID8gdXJsLmhvc3QgOiBgJHt1cmwuaG9zdH06ODUyOWA7XG4gICAgY29uc3QgcGF0aCA9IHVybC5wYXRobmFtZSAhPT0gJy8nID8gdXJsLnBhdGhuYW1lIDogJyc7XG4gICAgY29uc3QgcGFyYW0gPSBuYW1lID0+IHVybC5zZWFyY2hQYXJhbXMuZ2V0KG5hbWUpIHx8ICcnO1xuICAgIHJldHVybiB7XG4gICAgICAgIHNlcnZlcjogYCR7cHJvdG9jb2x9Ly8ke2hvc3R9JHtwYXRofWAsXG4gICAgICAgIGF1dGg6IHVybC51c2VybmFtZSAmJiBgJHt1cmwudXNlcm5hbWV9OiR7dXJsLnBhc3N3b3JkfWAsXG4gICAgICAgIG5hbWU6IHBhcmFtKCduYW1lJykgfHwgJ2Jsb2NrY2hhaW4nLFxuICAgICAgICBtYXhTb2NrZXRzOiBOdW1iZXIucGFyc2VJbnQocGFyYW0oJ21heFNvY2tldHMnKSkgfHwgZGVmTWF4U29ja2V0cyxcbiAgICAgICAgbGlzdGVuZXJSZXN0YXJ0VGltZW91dDogTnVtYmVyLnBhcnNlSW50KHBhcmFtKCdsaXN0ZW5lclJlc3RhcnRUaW1lb3V0JykpIHx8IERFRkFVTFRfTElTVEVORVJfUkVTVEFSVF9USU1FT1VULFxuICAgIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VBcmFuZ29FbmRwb2ludExpc3QoY29uZmlnOiBzdHJpbmcsIGRlZk1heFNvY2tldHM6IG51bWJlcik6IFFBcmFuZ29Db25maWdbXSB7XG4gICAgcmV0dXJuIGNvbmZpZ1xuICAgICAgICAuc3BsaXQoXCIsXCIpXG4gICAgICAgIC5maWx0ZXIoeCA9PiB4LnRyaW0oKSAhPT0gXCJcIilcbiAgICAgICAgLm1hcCh4ID0+IHBhcnNlQXJhbmdvRW5kcG9pbnQoeCwgZGVmTWF4U29ja2V0cykpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VBcmFuZ29Db25maWcoY29uZmlnOiBzdHJpbmcsIGRlZk1heFNvY2tldHM6IG51bWJlcik6IFFBcmFuZ29Db25maWcge1xuICAgIHJldHVybiBwYXJzZUFyYW5nb0VuZHBvaW50TGlzdChjb25maWcsIGRlZk1heFNvY2tldHMpWzBdXG4gICAgICAgIHx8IHBhcnNlQXJhbmdvRW5kcG9pbnQoJycsIGRlZk1heFNvY2tldHMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VNZW1DYWNoZWRDb25maWcoY29uZmlnOiBzdHJpbmcpOiBRTWVtQ2FjaGVkQ29uZmlnIHtcbiAgICByZXR1cm4ge1xuICAgICAgICBzZXJ2ZXI6IGNvbmZpZyxcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBvdmVycmlkZURlZnMob3B0aW9uczogUHJvZ3JhbU9wdGlvbnMsIGRlZnM6IGFueSk6IFByb2dyYW1PcHRpb25zIHtcbiAgICBjb25zdCByZXNvbHZlZCA9IHt9O1xuICAgIE9iamVjdC5lbnRyaWVzKG9wdGlvbnMpLmZvckVhY2goKFtuYW1lLCB2YWx1ZV0pID0+IHtcbiAgICAgICAgY29uc3Qgb3B0ID0gKCh2YWx1ZTogYW55KTogUHJvZ3JhbU9wdGlvbik7XG4gICAgICAgIHJlc29sdmVkW25hbWVdID0ge1xuICAgICAgICAgICAgLi4ub3B0LFxuICAgICAgICAgICAgZGVmOiBkZWZzW25hbWVdIHx8IG9wdC5kZWYsXG4gICAgICAgIH07XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc29sdmVkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVzb2x2ZVZhbHVlcyh2YWx1ZXM6IGFueSwgZW52OiBhbnksIGRlZjogUHJvZ3JhbU9wdGlvbnMpOiBhbnkge1xuICAgIGNvbnN0IHJlc29sdmVkID0ge307XG4gICAgT2JqZWN0LmVudHJpZXMoZGVmKS5mb3JFYWNoKChbbmFtZSwgdmFsdWVdKSA9PiB7XG4gICAgICAgIGNvbnN0IG9wdCA9ICgodmFsdWU6IGFueSk6IFByb2dyYW1PcHRpb24pO1xuICAgICAgICByZXNvbHZlZFtuYW1lXSA9IHZhbHVlc1tuYW1lXSB8fCBlbnZbb3B0LmVudl0gfHwgZGVmW25hbWVdLmRlZjtcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzb2x2ZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVDb25maWcoXG4gICAgdmFsdWVzOiBhbnksXG4gICAgZW52OiBhbnksXG4gICAgZGVmOiBQcm9ncmFtT3B0aW9ucyxcbik6IFFDb25maWcge1xuICAgIGNvbnN0IHJlc29sdmVkID0gcmVzb2x2ZVZhbHVlcyh2YWx1ZXMsIGVudiwgZGVmKTtcbiAgICBjb25zdCB7IGRhdGEsIHNsb3dRdWVyaWVzRGF0YSwgbmV0d29ya05hbWUsIGNhY2hlS2V5UHJlZml4IH0gPSBwYXJzZURhdGFDb25maWcocmVzb2x2ZWQpO1xuICAgIHJldHVybiB7XG4gICAgICAgIHNlcnZlcjoge1xuICAgICAgICAgICAgaG9zdDogcmVzb2x2ZWQuaG9zdCxcbiAgICAgICAgICAgIHBvcnQ6IE51bWJlci5wYXJzZUludChyZXNvbHZlZC5wb3J0KSxcbiAgICAgICAgICAgIGtlZXBBbGl2ZTogTnVtYmVyLnBhcnNlSW50KHJlc29sdmVkLmtlZXBBbGl2ZSksXG4gICAgICAgIH0sXG4gICAgICAgIHJlcXVlc3RzOiB7XG4gICAgICAgICAgICBtb2RlOiByZXNvbHZlZC5yZXF1ZXN0c01vZGUsXG4gICAgICAgICAgICBzZXJ2ZXI6IHJlc29sdmVkLnJlcXVlc3RzU2VydmVyLFxuICAgICAgICAgICAgdG9waWM6IHJlc29sdmVkLnJlcXVlc3RzVG9waWMsXG4gICAgICAgIH0sXG4gICAgICAgIGRhdGEsXG4gICAgICAgIHNsb3dRdWVyaWVzRGF0YSxcbiAgICAgICAgYXV0aG9yaXphdGlvbjoge1xuICAgICAgICAgICAgZW5kcG9pbnQ6IHJlc29sdmVkLmF1dGhFbmRwb2ludCxcbiAgICAgICAgfSxcbiAgICAgICAgbWFtQWNjZXNzS2V5czogbmV3IFNldCgocmVzb2x2ZWQubWFtQWNjZXNzS2V5cyB8fCAnJykuc3BsaXQoJywnKSksXG4gICAgICAgIGphZWdlcjoge1xuICAgICAgICAgICAgZW5kcG9pbnQ6IHJlc29sdmVkLmphZWdlckVuZHBvaW50LFxuICAgICAgICAgICAgc2VydmljZTogcmVzb2x2ZWQudHJhY2VTZXJ2aWNlLFxuICAgICAgICAgICAgdGFnczogcGFyc2VUYWdzKHJlc29sdmVkLnRyYWNlVGFncyksXG4gICAgICAgIH0sXG4gICAgICAgIHN0YXRzZDoge1xuICAgICAgICAgICAgc2VydmVyOiByZXNvbHZlZC5zdGF0c2RTZXJ2ZXIsXG4gICAgICAgICAgICB0YWdzOiAocmVzb2x2ZWQuc3RhdHNkVGFncyB8fCAnJykuc3BsaXQoJywnKS5tYXAoeCA9PiB4LnRyaW0oKSkuZmlsdGVyKHggPT4geCksXG4gICAgICAgIH0sXG4gICAgICAgIG5ldHdvcmtOYW1lLFxuICAgICAgICBjYWNoZUtleVByZWZpeCxcbiAgICAgICAgZW5kcG9pbnRzOiAocmVzb2x2ZWQuZW5kcG9pbnRzIHx8ICcnKS5zcGxpdCgnLCcpLm1hcCh4ID0+IHgudHJpbSgpKS5maWx0ZXIoeCA9PiB4KVxuICAgIH07XG59XG5cbi8vIEludGVybmFsc1xuXG5mdW5jdGlvbiBnZXRJcCgpOiBzdHJpbmcge1xuICAgIGNvbnN0IGlwdjQgPSAoT2JqZWN0LnZhbHVlcyhvcy5uZXR3b3JrSW50ZXJmYWNlcygpKTogYW55KVxuICAgICAgICAucmVkdWNlKChhY2MsIHgpID0+IGFjYy5jb25jYXQoeCksIFtdKVxuICAgICAgICAuZmluZCh4ID0+IHguZmFtaWx5ID09PSAnSVB2NCcgJiYgIXguaW50ZXJuYWwpO1xuICAgIHJldHVybiBpcHY0ICYmIGlwdjQuYWRkcmVzcztcbn1cblxuXG5mdW5jdGlvbiBwYXJzZVRhZ3Moczogc3RyaW5nKTogeyBbc3RyaW5nXTogc3RyaW5nIH0ge1xuICAgIGNvbnN0IHRhZ3M6IHsgW3N0cmluZ106IHN0cmluZyB9ID0ge307XG4gICAgcy5zcGxpdCgnLCcpLmZvckVhY2goKHQpID0+IHtcbiAgICAgICAgY29uc3QgaSA9IHQuaW5kZXhPZignPScpO1xuICAgICAgICBpZiAoaSA+PSAwKSB7XG4gICAgICAgICAgICB0YWdzW3Quc3Vic3RyKDAsIGkpXSA9IHQuc3Vic3RyKGkgKyAxKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRhZ3NbdF0gPSAnJztcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiB0YWdzO1xuXG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlRGF0YUNvbmZpZyh2YWx1ZXM6IGFueSk6IHtcbiAgICBkYXRhOiBRRGF0YVByb3ZpZGVyc0NvbmZpZyxcbiAgICBzbG93UXVlcmllc0RhdGE6IFFEYXRhUHJvdmlkZXJzQ29uZmlnLFxuICAgIG5ldHdvcmtOYW1lOiBzdHJpbmcsXG4gICAgY2FjaGVLZXlQcmVmaXg6IHN0cmluZyxcbn0ge1xuICAgIGZ1bmN0aW9uIHBhcnNlKHByZWZpeDogc3RyaW5nLCBkZWZNYXhTb2NrZXRzOiBudW1iZXIpOiBRRGF0YVByb3ZpZGVyc0NvbmZpZyB7XG4gICAgICAgIGNvbnN0IG9wdCA9IChzdWZmaXg6IHN0cmluZyk6IHN0cmluZyA9PiB2YWx1ZXNbYCR7cHJlZml4fSR7c3VmZml4fWBdIHx8ICcnO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbXV0OiBwYXJzZUFyYW5nb0NvbmZpZyhvcHQoJ011dCcpLCBkZWZNYXhTb2NrZXRzKSxcbiAgICAgICAgICAgIGhvdDogcGFyc2VBcmFuZ29Db25maWcob3B0KCdIb3QnKSwgZGVmTWF4U29ja2V0cyksXG4gICAgICAgICAgICBjb2xkOiBwYXJzZUFyYW5nb0VuZHBvaW50TGlzdChvcHQoJ0NvbGQnKSwgZGVmTWF4U29ja2V0cyksXG4gICAgICAgICAgICBjYWNoZTogcGFyc2VNZW1DYWNoZWRDb25maWcob3B0KCdDYWNoZScpKSxcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHsgbmV0d29ya05hbWUsIGNhY2hlS2V5UHJlZml4IH0gPSB2YWx1ZXM7XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBkYXRhOiBwYXJzZSgnZGF0YScsIERFRkFVTFRfQVJBTkdPX01BWF9TT0NLRVRTKSxcbiAgICAgICAgc2xvd1F1ZXJpZXNEYXRhOiBwYXJzZSgnc2xvd1F1ZXJpZXMnLCBERUZBVUxUX1NMT1dfUVVFUklFU19BUkFOR09fTUFYX1NPQ0tFVFMpLFxuICAgICAgICBuZXR3b3JrTmFtZSxcbiAgICAgICAgY2FjaGVLZXlQcmVmaXgsXG4gICAgfTtcbn1cbiJdfQ==