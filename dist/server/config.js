"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ensureProtocol = ensureProtocol;
exports.parseArangoConfig = parseArangoConfig;
exports.parseMemCachedConfig = parseMemCachedConfig;
exports.overrideDefs = overrideDefs;
exports.resolveValues = resolveValues;
exports.createConfig = createConfig;
exports.parseDataConfig = parseDataConfig;
exports.STATS = exports.programOptions = exports.requestsMode = void 0;

var _os = _interopRequireDefault(require("os"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const DEFAULT_LISTENER_RESTART_TIMEOUT = 1000;
const DEFAULT_ARANGO_MAX_SOCKETS = 100;
const DEFAULT_SLOW_QUERIES_ARANGO_MAX_SOCKETS = 3;
const requestsMode = {
  kafka: 'kafka',
  rest: 'rest'
};
exports.requestsMode = requestsMode;
const programOptions = {};
exports.programOptions = programOptions;

const toPascal = s => `${s[0].toUpperCase()}${s.substr(1).toLowerCase()}`;

const opt = (option, def, description) => {
  const words = option.split('-');
  const name = `${words[0]}${words.slice(1).map(toPascal).join('')}`;
  const env = `Q_${words.map(x => x.toUpperCase()).join('_')}`;
  programOptions[name] = {
    option: `--${option} <value>`,
    env,
    def,
    description
  };
};

const dataOpt = prefix => {
  const o = name => `${prefix.toLowerCase().split(' ').join('-')}-${name}`;

  const d = text => `${toPascal(prefix)} ${text}`;

  opt(o('mutable'), 'arangodb', d('mutable db config url'));
  opt(o('immutable-hot'), 'arangodb', d('immutable hot db config url'));
  opt(o('immutable-cold'), '', d('immutable cold db config urls (comma separated)'));
  opt(o('immutable-cold-cache'), '', d('immutable cold cache config url'));
};

opt('host', getIp(), 'Listening address');
opt('port', '4000', 'Listening port');
opt('keep-alive', '60000', 'GraphQL keep alive ms');
opt('requests-mode', 'kafka', 'Requests mode (kafka | rest)');
opt('requests-server', 'kafka:9092', 'Requests server url');
opt('requests-topic', 'requests', 'Requests topic name');
dataOpt('data');
dataOpt('slow queries data');
opt('auth-endpoint', '', 'Auth endpoint');
opt('mam-access-keys', '', 'Access keys used to authorize mam endpoint access');
opt('jaeger-endpoint', '', 'Jaeger endpoint');
opt('trace-service', 'Q Server', 'Trace service name');
opt('trace-tags', '', 'Additional trace tags (comma separated name=value pairs)');
opt('statsd-server', '', 'StatsD server (host:port)');
opt('statsd-tags', '', 'Additional StatsD tags (comma separated name=value pairs)'); // Stats Schema

const STATS = {
  start: 'start',
  prefix: 'qserver.',
  doc: {
    count: 'doc.count'
  },
  post: {
    count: 'post.count',
    failed: 'post.failed'
  },
  query: {
    count: 'query.count',
    time: 'query.time',
    active: 'query.active',
    failed: 'query.failed',
    slow: 'query.slow'
  },
  subscription: {
    active: 'subscription.active'
  },
  waitFor: {
    active: 'waitfor.active'
  }
};
exports.STATS = STATS;

function ensureProtocol(address, defaultProtocol) {
  return /^\w+:\/\//gi.test(address) ? address : `${defaultProtocol}://${address}`;
}

function parseArangoConfig(config, defMaxSockets) {
  const lowerCased = config.toLowerCase().trim();
  const hasProtocol = lowerCased.startsWith('http:') || lowerCased.startsWith('https:');
  const url = new URL(hasProtocol ? config : `https://${config}`);
  const protocol = url.protocol || 'https:';
  const host = url.port ? url.host : `${url.host}:8059`;
  const path = url.pathname !== '/' ? url.pathname : '';

  const param = name => url.searchParams.get(name) || '';

  return {
    server: `${protocol}//${host}${path}`,
    auth: url.username && `${url.username}:${url.password}`,
    name: param('name') || 'blockchain',
    maxSockets: Number.parseInt(param('maxSockets')) || defMaxSockets,
    listenerRestartTimeout: Number.parseInt(param('listenerRestartTimeout')) || DEFAULT_LISTENER_RESTART_TIMEOUT
  };
}

function parseMemCachedConfig(config) {
  return {
    server: config
  };
}

function overrideDefs(options, defs) {
  const resolved = {};
  Object.entries(options).forEach(([name, value]) => {
    const opt = value;
    resolved[name] = { ...opt,
      def: defs[name] || opt.def
    };
  });
  return resolved;
}

function resolveValues(values, env, def) {
  const resolved = {};
  Object.entries(def).forEach(([name, value]) => {
    const opt = value;
    resolved[name] = values[name] || env[opt.env] || def[name].def;
  });
  return resolved;
}

function createConfig(values, env, def) {
  const resolved = resolveValues(values, env, def);
  return {
    server: {
      host: resolved.host,
      port: Number.parseInt(resolved.port),
      keepAlive: Number.parseInt(resolved.keepAlive)
    },
    requests: {
      mode: resolved.requestsMode,
      server: resolved.requestsServer,
      topic: resolved.requestsTopic
    },
    data: parseDataConfig(resolved, 'data', DEFAULT_SLOW_QUERIES_ARANGO_MAX_SOCKETS),
    slowQueriesData: parseDataConfig(resolved, 'slowQueriesData', DEFAULT_ARANGO_MAX_SOCKETS),
    authorization: {
      endpoint: resolved.authEndpoint
    },
    mamAccessKeys: new Set((resolved.mamAccessKeys || '').split(',')),
    jaeger: {
      endpoint: resolved.jaegerEndpoint,
      service: resolved.traceService,
      tags: parseTags(resolved.traceTags)
    },
    statsd: {
      server: resolved.statsdServer,
      tags: (resolved.statsdTags || '').split(',').map(x => x.trim()).filter(x => x)
    }
  };
} // Internals


function getIp() {
  const ipv4 = Object.values(_os.default.networkInterfaces()).reduce((acc, x) => acc.concat(x), []).find(x => x.family === 'IPv4' && !x.internal);
  return ipv4 && ipv4.address;
}

function parseTags(s) {
  const tags = {};
  s.split(',').forEach(t => {
    const i = t.indexOf('=');

    if (i >= 0) {
      tags[t.substr(0, i)] = t.substr(i + 1);
    } else {
      tags[t] = '';
    }
  });
  return tags;
}

function parseDataConfig(values, prefix, defMaxSockets) {
  const opt = suffix => values[`${prefix}${suffix}`] || '';

  return {
    mutable: parseArangoConfig(opt('Mutable'), defMaxSockets),
    immutableHot: parseArangoConfig(opt('ImmutableHot'), defMaxSockets),
    immutableCold: opt('ImmutableCold').split(',').filter(x => x).map(x => parseArangoConfig(x, defMaxSockets)),
    immutableColdCache: parseMemCachedConfig(opt('ImmutableColdCache'))
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvY29uZmlnLmpzIl0sIm5hbWVzIjpbIkRFRkFVTFRfTElTVEVORVJfUkVTVEFSVF9USU1FT1VUIiwiREVGQVVMVF9BUkFOR09fTUFYX1NPQ0tFVFMiLCJERUZBVUxUX1NMT1dfUVVFUklFU19BUkFOR09fTUFYX1NPQ0tFVFMiLCJyZXF1ZXN0c01vZGUiLCJrYWZrYSIsInJlc3QiLCJwcm9ncmFtT3B0aW9ucyIsInRvUGFzY2FsIiwicyIsInRvVXBwZXJDYXNlIiwic3Vic3RyIiwidG9Mb3dlckNhc2UiLCJvcHQiLCJvcHRpb24iLCJkZWYiLCJkZXNjcmlwdGlvbiIsIndvcmRzIiwic3BsaXQiLCJuYW1lIiwic2xpY2UiLCJtYXAiLCJqb2luIiwiZW52IiwieCIsImRhdGFPcHQiLCJwcmVmaXgiLCJvIiwiZCIsInRleHQiLCJnZXRJcCIsIlNUQVRTIiwic3RhcnQiLCJkb2MiLCJjb3VudCIsInBvc3QiLCJmYWlsZWQiLCJxdWVyeSIsInRpbWUiLCJhY3RpdmUiLCJzbG93Iiwic3Vic2NyaXB0aW9uIiwid2FpdEZvciIsImVuc3VyZVByb3RvY29sIiwiYWRkcmVzcyIsImRlZmF1bHRQcm90b2NvbCIsInRlc3QiLCJwYXJzZUFyYW5nb0NvbmZpZyIsImNvbmZpZyIsImRlZk1heFNvY2tldHMiLCJsb3dlckNhc2VkIiwidHJpbSIsImhhc1Byb3RvY29sIiwic3RhcnRzV2l0aCIsInVybCIsIlVSTCIsInByb3RvY29sIiwiaG9zdCIsInBvcnQiLCJwYXRoIiwicGF0aG5hbWUiLCJwYXJhbSIsInNlYXJjaFBhcmFtcyIsImdldCIsInNlcnZlciIsImF1dGgiLCJ1c2VybmFtZSIsInBhc3N3b3JkIiwibWF4U29ja2V0cyIsIk51bWJlciIsInBhcnNlSW50IiwibGlzdGVuZXJSZXN0YXJ0VGltZW91dCIsInBhcnNlTWVtQ2FjaGVkQ29uZmlnIiwib3ZlcnJpZGVEZWZzIiwib3B0aW9ucyIsImRlZnMiLCJyZXNvbHZlZCIsIk9iamVjdCIsImVudHJpZXMiLCJmb3JFYWNoIiwidmFsdWUiLCJyZXNvbHZlVmFsdWVzIiwidmFsdWVzIiwiY3JlYXRlQ29uZmlnIiwia2VlcEFsaXZlIiwicmVxdWVzdHMiLCJtb2RlIiwicmVxdWVzdHNTZXJ2ZXIiLCJ0b3BpYyIsInJlcXVlc3RzVG9waWMiLCJkYXRhIiwicGFyc2VEYXRhQ29uZmlnIiwic2xvd1F1ZXJpZXNEYXRhIiwiYXV0aG9yaXphdGlvbiIsImVuZHBvaW50IiwiYXV0aEVuZHBvaW50IiwibWFtQWNjZXNzS2V5cyIsIlNldCIsImphZWdlciIsImphZWdlckVuZHBvaW50Iiwic2VydmljZSIsInRyYWNlU2VydmljZSIsInRhZ3MiLCJwYXJzZVRhZ3MiLCJ0cmFjZVRhZ3MiLCJzdGF0c2QiLCJzdGF0c2RTZXJ2ZXIiLCJzdGF0c2RUYWdzIiwiZmlsdGVyIiwiaXB2NCIsIm9zIiwibmV0d29ya0ludGVyZmFjZXMiLCJyZWR1Y2UiLCJhY2MiLCJjb25jYXQiLCJmaW5kIiwiZmFtaWx5IiwiaW50ZXJuYWwiLCJ0IiwiaSIsImluZGV4T2YiLCJzdWZmaXgiLCJtdXRhYmxlIiwiaW1tdXRhYmxlSG90IiwiaW1tdXRhYmxlQ29sZCIsImltbXV0YWJsZUNvbGRDYWNoZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFtQkE7Ozs7QUFuQkE7Ozs7Ozs7Ozs7Ozs7Ozs7QUErRUEsTUFBTUEsZ0NBQWdDLEdBQUcsSUFBekM7QUFDQSxNQUFNQywwQkFBMEIsR0FBRyxHQUFuQztBQUNBLE1BQU1DLHVDQUF1QyxHQUFHLENBQWhEO0FBRU8sTUFBTUMsWUFBWSxHQUFHO0FBQ3hCQyxFQUFBQSxLQUFLLEVBQUUsT0FEaUI7QUFFeEJDLEVBQUFBLElBQUksRUFBRTtBQUZrQixDQUFyQjs7QUFLQSxNQUFNQyxjQUE4QixHQUFHLEVBQXZDOzs7QUFFUCxNQUFNQyxRQUFRLEdBQUdDLENBQUMsSUFBSyxHQUFFQSxDQUFDLENBQUMsQ0FBRCxDQUFELENBQUtDLFdBQUwsRUFBbUIsR0FBRUQsQ0FBQyxDQUFDRSxN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QVM0RyxDQUFDLEdBQUcsQ0FBYixDQUF2QjtBQUNILEtBRkQsTUFFTztBQUNIakIsTUFBQUEsSUFBSSxDQUFDZ0IsQ0FBRCxDQUFKLEdBQVUsRUFBVjtBQUNIO0FBQ0osR0FQRDtBQVFBLFNBQU9oQixJQUFQO0FBRUg7O0FBR00sU0FBU1gsZUFBVCxDQUF5QlQsTUFBekIsRUFBc0N4RCxNQUF0QyxFQUFzRHVCLGFBQXRELEVBQWdHO0FBQ25HLFFBQU1wQyxHQUFHLEdBQUc0RyxNQUFNLElBQUl2QyxNQUFNLENBQUUsR0FBRXhELE1BQU8sR0FBRStGLE1BQU8sRUFBcEIsQ0FBTixJQUFnQyxFQUF0RDs7QUFDQSxTQUFPO0FBQ0hDLElBQUFBLE9BQU8sRUFBRTNFLGlCQUFpQixDQUFDbEMsR0FBRyxDQUFDLFNBQUQsQ0FBSixFQUFpQm9DLGFBQWpCLENBRHZCO0FBRUgwRSxJQUFBQSxZQUFZLEVBQUU1RSxpQkFBaUIsQ0FBQ2xDLEdBQUcsQ0FBQyxjQUFELENBQUosRUFBc0JvQyxhQUF0QixDQUY1QjtBQUdIMkUsSUFBQUEsYUFBYSxFQUFFL0csR0FBRyxDQUFDLGVBQUQsQ0FBSCxDQUFxQkssS0FBckIsQ0FBMkIsR0FBM0IsRUFBZ0MwRixNQUFoQyxDQUF1Q3BGLENBQUMsSUFBSUEsQ0FBNUMsRUFBK0NILEdBQS9DLENBQW1ERyxDQUFDLElBQUl1QixpQkFBaUIsQ0FBQ3ZCLENBQUQsRUFBSXlCLGFBQUosQ0FBekUsQ0FIWjtBQUlINEUsSUFBQUEsa0JBQWtCLEVBQUVyRCxvQkFBb0IsQ0FBQzNELEdBQUcsQ0FBQyxvQkFBRCxDQUFKO0FBSnJDLEdBQVA7QUFNSCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4vKlxuICogQ29weXJpZ2h0IDIwMTgtMjAyMCBUT04gREVWIFNPTFVUSU9OUyBMVEQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIFNPRlRXQVJFIEVWQUxVQVRJT04gTGljZW5zZSAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlXG4gKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGVcbiAqIExpY2Vuc2UgYXQ6XG4gKlxuICogaHR0cDovL3d3dy50b24uZGV2L2xpY2Vuc2VzXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBUT04gREVWIHNvZnR3YXJlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbi8vIEBmbG93XG5cbmltcG9ydCBvcyBmcm9tICdvcyc7XG5cbi8vIENvbmZpZyBTY2hlbWFcblxuZXhwb3J0IHR5cGUgUUFyYW5nb0NvbmZpZyA9IHtcbiAgICBzZXJ2ZXI6IHN0cmluZyxcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgYXV0aDogc3RyaW5nLFxuICAgIG1heFNvY2tldHM6IG51bWJlcixcbiAgICBsaXN0ZW5lclJlc3RhcnRUaW1lb3V0OiBudW1iZXI7XG59O1xuXG5leHBvcnQgdHlwZSBRTWVtQ2FjaGVkQ29uZmlnID0ge1xuICAgIHNlcnZlcjogc3RyaW5nLFxufTtcblxuZXhwb3J0IHR5cGUgUURhdGFCcm9rZXJDb25maWcgPSB7XG4gICAgbXV0YWJsZTogUUFyYW5nb0NvbmZpZztcbiAgICBpbW11dGFibGVIb3Q6IFFBcmFuZ29Db25maWc7XG4gICAgaW1tdXRhYmxlQ29sZDogUUFyYW5nb0NvbmZpZ1tdO1xuICAgIGltbXV0YWJsZUNvbGRDYWNoZTogUU1lbUNhY2hlZENvbmZpZztcbn07XG5cbmV4cG9ydCB0eXBlIFFDb25maWcgPSB7XG4gICAgc2VydmVyOiB7XG4gICAgICAgIGhvc3Q6IHN0cmluZyxcbiAgICAgICAgcG9ydDogbnVtYmVyLFxuICAgICAgICBrZWVwQWxpdmU6IG51bWJlcixcbiAgICB9LFxuICAgIHJlcXVlc3RzOiB7XG4gICAgICAgIG1vZGU6ICdrYWZrYScgfCAncmVzdCcsXG4gICAgICAgIHNlcnZlcjogc3RyaW5nLFxuICAgICAgICB0b3BpYzogc3RyaW5nLFxuICAgIH0sXG4gICAgZGF0YTogUURhdGFCcm9rZXJDb25maWcsXG4gICAgc2xvd1F1ZXJpZXNEYXRhOiBRRGF0YUJyb2tlckNvbmZpZyxcbiAgICBhdXRob3JpemF0aW9uOiB7XG4gICAgICAgIGVuZHBvaW50OiBzdHJpbmcsXG4gICAgfSxcbiAgICBqYWVnZXI6IHtcbiAgICAgICAgZW5kcG9pbnQ6IHN0cmluZyxcbiAgICAgICAgc2VydmljZTogc3RyaW5nLFxuICAgICAgICB0YWdzOiB7IFtzdHJpbmddOiBzdHJpbmcgfVxuICAgIH0sXG4gICAgc3RhdHNkOiB7XG4gICAgICAgIHNlcnZlcjogc3RyaW5nLFxuICAgICAgICB0YWdzOiBzdHJpbmdbXSxcbiAgICB9LFxuICAgIG1hbUFjY2Vzc0tleXM6IFNldDxzdHJpbmc+LFxuICAgIGlzVGVzdHM/OiBib29sZWFuLFxufVxuXG5leHBvcnQgdHlwZSBQcm9ncmFtT3B0aW9uID0ge1xuICAgIG9wdGlvbjogc3RyaW5nLFxuICAgIGVudjogc3RyaW5nLFxuICAgIGRlZjogc3RyaW5nLFxuICAgIGRlc2NyaXB0aW9uOiBzdHJpbmcsXG59O1xuZXhwb3J0IHR5cGUgUHJvZ3JhbU9wdGlvbnMgPSB7IFtzdHJpbmddOiBQcm9ncmFtT3B0aW9uIH07XG5cbmNvbnN0IERFRkFVTFRfTElTVEVORVJfUkVTVEFSVF9USU1FT1VUID0gMTAwMDtcbmNvbnN0IERFRkFVTFRfQVJBTkdPX01BWF9TT0NLRVRTID0gMTAwO1xuY29uc3QgREVGQVVMVF9TTE9XX1FVRVJJRVNfQVJBTkdPX01BWF9TT0NLRVRTID0gMztcblxuZXhwb3J0IGNvbnN0IHJlcXVlc3RzTW9kZSA9IHtcbiAgICBrYWZrYTogJ2thZmthJyxcbiAgICByZXN0OiAncmVzdCcsXG59O1xuXG5leHBvcnQgY29uc3QgcHJvZ3JhbU9wdGlvbnM6IFByb2dyYW1PcHRpb25zID0ge307XG5cbmNvbnN0IHRvUGFzY2FsID0gcyA9PiBgJHtzWzBdLnRvVXBwZXJDYXNlKCl9JHtzLnN1YnN0cigxKS50b0xvd2VyQ2FzZSgpfWA7XG5cbmNvbnN0IG9wdCA9IChvcHRpb246IHN0cmluZywgZGVmOiBzdHJpbmcsIGRlc2NyaXB0aW9uOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCB3b3JkcyA9IG9wdGlvbi5zcGxpdCgnLScpO1xuICAgIGNvbnN0IG5hbWUgPSBgJHt3b3Jkc1swXX0ke3dvcmRzLnNsaWNlKDEpLm1hcCh0b1Bhc2NhbCkuam9pbignJyl9YDtcbiAgICBjb25zdCBlbnYgPSBgUV8ke3dvcmRzLm1hcCh4ID0+IHgudG9VcHBlckNhc2UoKSkuam9pbignXycpfWA7XG4gICAgcHJvZ3JhbU9wdGlvbnNbbmFtZV0gPSB7XG4gICAgICAgIG9wdGlvbjogYC0tJHtvcHRpb259IDx2YWx1ZT5gLFxuICAgICAgICBlbnYsXG4gICAgICAgIGRlZixcbiAgICAgICAgZGVzY3JpcHRpb24sXG4gICAgfVxufTtcblxuY29uc3QgZGF0YU9wdCA9IChwcmVmaXg6IHN0cmluZykgPT4ge1xuICAgIGNvbnN0IG8gPSBuYW1lID0+IGAke3ByZWZpeC50b0xvd2VyQ2FzZSgpLnNwbGl0KCcgJykuam9pbignLScpfS0ke25hbWV9YDtcbiAgICBjb25zdCBkID0gdGV4dCA9PiBgJHt0b1Bhc2NhbChwcmVmaXgpfSAke3RleHR9YDtcblxuICAgIG9wdChvKCdtdXRhYmxlJyksICdhcmFuZ29kYicsIGQoJ211dGFibGUgZGIgY29uZmlnIHVybCcpKTtcbiAgICBvcHQobygnaW1tdXRhYmxlLWhvdCcpLCAnYXJhbmdvZGInLCBkKCdpbW11dGFibGUgaG90IGRiIGNvbmZpZyB1cmwnKSk7XG4gICAgb3B0KG8oJ2ltbXV0YWJsZS1jb2xkJyksICcnLCBkKCdpbW11dGFibGUgY29sZCBkYiBjb25maWcgdXJscyAoY29tbWEgc2VwYXJhdGVkKScpKTtcbiAgICBvcHQobygnaW1tdXRhYmxlLWNvbGQtY2FjaGUnKSwgJycsIGQoJ2ltbXV0YWJsZSBjb2xkIGNhY2hlIGNvbmZpZyB1cmwnKSk7XG59XG5cbm9wdCgnaG9zdCcsIGdldElwKCksICdMaXN0ZW5pbmcgYWRkcmVzcycpO1xub3B0KCdwb3J0JywgJzQwMDAnLCAnTGlzdGVuaW5nIHBvcnQnKTtcbm9wdCgna2VlcC1hbGl2ZScsICc2MDAwMCcsICdHcmFwaFFMIGtlZXAgYWxpdmUgbXMnKTtcblxub3B0KCdyZXF1ZXN0cy1tb2RlJywgJ2thZmthJywgJ1JlcXVlc3RzIG1vZGUgKGthZmthIHwgcmVzdCknKTtcbm9wdCgncmVxdWVzdHMtc2VydmVyJywgJ2thZmthOjkwOTInLCAnUmVxdWVzdHMgc2VydmVyIHVybCcpO1xub3B0KCdyZXF1ZXN0cy10b3BpYycsICdyZXF1ZXN0cycsICdSZXF1ZXN0cyB0b3BpYyBuYW1lJyk7XG5cbmRhdGFPcHQoJ2RhdGEnKTtcbmRhdGFPcHQoJ3Nsb3cgcXVlcmllcyBkYXRhJyk7XG5cbm9wdCgnYXV0aC1lbmRwb2ludCcsICcnLCAnQXV0aCBlbmRwb2ludCcpO1xub3B0KCdtYW0tYWNjZXNzLWtleXMnLCAnJywgJ0FjY2VzcyBrZXlzIHVzZWQgdG8gYXV0aG9yaXplIG1hbSBlbmRwb2ludCBhY2Nlc3MnKTtcblxub3B0KCdqYWVnZXItZW5kcG9pbnQnLCAnJywgJ0phZWdlciBlbmRwb2ludCcpO1xub3B0KCd0cmFjZS1zZXJ2aWNlJywgJ1EgU2VydmVyJywgJ1RyYWNlIHNlcnZpY2UgbmFtZScpO1xub3B0KCd0cmFjZS10YWdzJywgJycsICdBZGRpdGlvbmFsIHRyYWNlIHRhZ3MgKGNvbW1hIHNlcGFyYXRlZCBuYW1lPXZhbHVlIHBhaXJzKScpO1xuXG5vcHQoJ3N0YXRzZC1zZXJ2ZXInLCAnJywgJ1N0YXRzRCBzZXJ2ZXIgKGhvc3Q6cG9ydCknKTtcbm9wdCgnc3RhdHNkLXRhZ3MnLCAnJywgJ0FkZGl0aW9uYWwgU3RhdHNEIHRhZ3MgKGNvbW1hIHNlcGFyYXRlZCBuYW1lPXZhbHVlIHBhaXJzKScpO1xuXG4vLyBTdGF0cyBTY2hlbWFcblxuZXhwb3J0IGNvbnN0IFNUQVRTID0ge1xuICAgIHN0YXJ0OiAnc3RhcnQnLFxuICAgIHByZWZpeDogJ3FzZXJ2ZXIuJyxcbiAgICBkb2M6IHtcbiAgICAgICAgY291bnQ6ICdkb2MuY291bnQnLFxuICAgIH0sXG4gICAgcG9zdDoge1xuICAgICAgICBjb3VudDogJ3Bvc3QuY291bnQnLFxuICAgICAgICBmYWlsZWQ6ICdwb3N0LmZhaWxlZCcsXG4gICAgfSxcbiAgICBxdWVyeToge1xuICAgICAgICBjb3VudDogJ3F1ZXJ5LmNvdW50JyxcbiAgICAgICAgdGltZTogJ3F1ZXJ5LnRpbWUnLFxuICAgICAgICBhY3RpdmU6ICdxdWVyeS5hY3RpdmUnLFxuICAgICAgICBmYWlsZWQ6ICdxdWVyeS5mYWlsZWQnLFxuICAgICAgICBzbG93OiAncXVlcnkuc2xvdycsXG4gICAgfSxcbiAgICBzdWJzY3JpcHRpb246IHtcbiAgICAgICAgYWN0aXZlOiAnc3Vic2NyaXB0aW9uLmFjdGl2ZScsXG4gICAgfSxcbiAgICB3YWl0Rm9yOiB7XG4gICAgICAgIGFjdGl2ZTogJ3dhaXRmb3IuYWN0aXZlJyxcbiAgICB9LFxufTtcblxuXG5leHBvcnQgZnVuY3Rpb24gZW5zdXJlUHJvdG9jb2woYWRkcmVzczogc3RyaW5nLCBkZWZhdWx0UHJvdG9jb2w6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIC9eXFx3KzpcXC9cXC8vZ2kudGVzdChhZGRyZXNzKSA/IGFkZHJlc3MgOiBgJHtkZWZhdWx0UHJvdG9jb2x9Oi8vJHthZGRyZXNzfWA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZUFyYW5nb0NvbmZpZyhjb25maWc6IHN0cmluZywgZGVmTWF4U29ja2V0czogbnVtYmVyKTogUUFyYW5nb0NvbmZpZyB7XG4gICAgY29uc3QgbG93ZXJDYXNlZCA9IGNvbmZpZy50b0xvd2VyQ2FzZSgpLnRyaW0oKTtcbiAgICBjb25zdCBoYXNQcm90b2NvbCA9IGxvd2VyQ2FzZWQuc3RhcnRzV2l0aCgnaHR0cDonKSB8fCBsb3dlckNhc2VkLnN0YXJ0c1dpdGgoJ2h0dHBzOicpO1xuICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoaGFzUHJvdG9jb2wgPyBjb25maWcgOiBgaHR0cHM6Ly8ke2NvbmZpZ31gKTtcbiAgICBjb25zdCBwcm90b2NvbCA9IHVybC5wcm90b2NvbCB8fCAnaHR0cHM6JztcbiAgICBjb25zdCBob3N0ID0gdXJsLnBvcnQgPyB1cmwuaG9zdCA6IGAke3VybC5ob3N0fTo4MDU5YDtcbiAgICBjb25zdCBwYXRoID0gdXJsLnBhdGhuYW1lICE9PSAnLycgPyB1cmwucGF0aG5hbWUgOiAnJztcbiAgICBjb25zdCBwYXJhbSA9IG5hbWUgPT4gdXJsLnNlYXJjaFBhcmFtcy5nZXQobmFtZSkgfHwgJyc7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgc2VydmVyOiBgJHtwcm90b2NvbH0vLyR7aG9zdH0ke3BhdGh9YCxcbiAgICAgICAgYXV0aDogdXJsLnVzZXJuYW1lICYmIGAke3VybC51c2VybmFtZX06JHt1cmwucGFzc3dvcmR9YCxcbiAgICAgICAgbmFtZTogcGFyYW0oJ25hbWUnKSB8fCAnYmxvY2tjaGFpbicsXG4gICAgICAgIG1heFNvY2tldHM6IE51bWJlci5wYXJzZUludChwYXJhbSgnbWF4U29ja2V0cycpKSB8fCBkZWZNYXhTb2NrZXRzLFxuICAgICAgICBsaXN0ZW5lclJlc3RhcnRUaW1lb3V0OiBOdW1iZXIucGFyc2VJbnQocGFyYW0oJ2xpc3RlbmVyUmVzdGFydFRpbWVvdXQnKSkgfHwgREVGQVVMVF9MSVNURU5FUl9SRVNUQVJUX1RJTUVPVVQsXG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VNZW1DYWNoZWRDb25maWcoY29uZmlnOiBzdHJpbmcpOiBRTWVtQ2FjaGVkQ29uZmlnIHtcbiAgICByZXR1cm4ge1xuICAgICAgICBzZXJ2ZXI6IGNvbmZpZyxcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBvdmVycmlkZURlZnMob3B0aW9uczogUHJvZ3JhbU9wdGlvbnMsIGRlZnM6IGFueSk6IFByb2dyYW1PcHRpb25zIHtcbiAgICBjb25zdCByZXNvbHZlZCA9IHt9O1xuICAgIE9iamVjdC5lbnRyaWVzKG9wdGlvbnMpLmZvckVhY2goKFtuYW1lLCB2YWx1ZV0pID0+IHtcbiAgICAgICAgY29uc3Qgb3B0ID0gKCh2YWx1ZTogYW55KTogUHJvZ3JhbU9wdGlvbik7XG4gICAgICAgIHJlc29sdmVkW25hbWVdID0ge1xuICAgICAgICAgICAgLi4ub3B0LFxuICAgICAgICAgICAgZGVmOiBkZWZzW25hbWVdIHx8IG9wdC5kZWYsXG4gICAgICAgIH07XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc29sdmVkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVzb2x2ZVZhbHVlcyh2YWx1ZXM6IGFueSwgZW52OiBhbnksIGRlZjogUHJvZ3JhbU9wdGlvbnMpOiBhbnkge1xuICAgIGNvbnN0IHJlc29sdmVkID0ge307XG4gICAgT2JqZWN0LmVudHJpZXMoZGVmKS5mb3JFYWNoKChbbmFtZSwgdmFsdWVdKSA9PiB7XG4gICAgICAgIGNvbnN0IG9wdCA9ICgodmFsdWU6IGFueSk6IFByb2dyYW1PcHRpb24pO1xuICAgICAgICByZXNvbHZlZFtuYW1lXSA9IHZhbHVlc1tuYW1lXSB8fCBlbnZbb3B0LmVudl0gfHwgZGVmW25hbWVdLmRlZjtcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzb2x2ZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVDb25maWcodmFsdWVzOiBhbnksIGVudjogYW55LCBkZWY6IFByb2dyYW1PcHRpb25zKTogUUNvbmZpZyB7XG4gICAgY29uc3QgcmVzb2x2ZWQgPSByZXNvbHZlVmFsdWVzKHZhbHVlcywgZW52LCBkZWYpO1xuICAgIHJldHVybiB7XG4gICAgICAgIHNlcnZlcjoge1xuICAgICAgICAgICAgaG9zdDogcmVzb2x2ZWQuaG9zdCxcbiAgICAgICAgICAgIHBvcnQ6IE51bWJlci5wYXJzZUludChyZXNvbHZlZC5wb3J0KSxcbiAgICAgICAgICAgIGtlZXBBbGl2ZTogTnVtYmVyLnBhcnNlSW50KHJlc29sdmVkLmtlZXBBbGl2ZSksXG4gICAgICAgIH0sXG4gICAgICAgIHJlcXVlc3RzOiB7XG4gICAgICAgICAgICBtb2RlOiByZXNvbHZlZC5yZXF1ZXN0c01vZGUsXG4gICAgICAgICAgICBzZXJ2ZXI6IHJlc29sdmVkLnJlcXVlc3RzU2VydmVyLFxuICAgICAgICAgICAgdG9waWM6IHJlc29sdmVkLnJlcXVlc3RzVG9waWMsXG4gICAgICAgIH0sXG4gICAgICAgIGRhdGE6IHBhcnNlRGF0YUNvbmZpZyhyZXNvbHZlZCwgJ2RhdGEnLCBERUZBVUxUX1NMT1dfUVVFUklFU19BUkFOR09fTUFYX1NPQ0tFVFMpLFxuICAgICAgICBzbG93UXVlcmllc0RhdGE6IHBhcnNlRGF0YUNvbmZpZyhyZXNvbHZlZCwgJ3Nsb3dRdWVyaWVzRGF0YScsIERFRkFVTFRfQVJBTkdPX01BWF9TT0NLRVRTKSxcbiAgICAgICAgYXV0aG9yaXphdGlvbjoge1xuICAgICAgICAgICAgZW5kcG9pbnQ6IHJlc29sdmVkLmF1dGhFbmRwb2ludCxcbiAgICAgICAgfSxcbiAgICAgICAgbWFtQWNjZXNzS2V5czogbmV3IFNldCgocmVzb2x2ZWQubWFtQWNjZXNzS2V5cyB8fCAnJykuc3BsaXQoJywnKSksXG4gICAgICAgIGphZWdlcjoge1xuICAgICAgICAgICAgZW5kcG9pbnQ6IHJlc29sdmVkLmphZWdlckVuZHBvaW50LFxuICAgICAgICAgICAgc2VydmljZTogcmVzb2x2ZWQudHJhY2VTZXJ2aWNlLFxuICAgICAgICAgICAgdGFnczogcGFyc2VUYWdzKHJlc29sdmVkLnRyYWNlVGFncyksXG4gICAgICAgIH0sXG4gICAgICAgIHN0YXRzZDoge1xuICAgICAgICAgICAgc2VydmVyOiByZXNvbHZlZC5zdGF0c2RTZXJ2ZXIsXG4gICAgICAgICAgICB0YWdzOiAocmVzb2x2ZWQuc3RhdHNkVGFncyB8fCAnJykuc3BsaXQoJywnKS5tYXAoeCA9PiB4LnRyaW0oKSkuZmlsdGVyKHggPT4geCksXG4gICAgICAgIH0sXG4gICAgfTtcbn1cblxuLy8gSW50ZXJuYWxzXG5cbmZ1bmN0aW9uIGdldElwKCk6IHN0cmluZyB7XG4gICAgY29uc3QgaXB2NCA9IChPYmplY3QudmFsdWVzKG9zLm5ldHdvcmtJbnRlcmZhY2VzKCkpOiBhbnkpXG4gICAgICAgIC5yZWR1Y2UoKGFjYywgeCkgPT4gYWNjLmNvbmNhdCh4KSwgW10pXG4gICAgICAgIC5maW5kKHggPT4geC5mYW1pbHkgPT09ICdJUHY0JyAmJiAheC5pbnRlcm5hbCk7XG4gICAgcmV0dXJuIGlwdjQgJiYgaXB2NC5hZGRyZXNzO1xufVxuXG5cbmZ1bmN0aW9uIHBhcnNlVGFncyhzOiBzdHJpbmcpOiB7IFtzdHJpbmddOiBzdHJpbmcgfSB7XG4gICAgY29uc3QgdGFnczogeyBbc3RyaW5nXTogc3RyaW5nIH0gPSB7fTtcbiAgICBzLnNwbGl0KCcsJykuZm9yRWFjaCgodCkgPT4ge1xuICAgICAgICBjb25zdCBpID0gdC5pbmRleE9mKCc9Jyk7XG4gICAgICAgIGlmIChpID49IDApIHtcbiAgICAgICAgICAgIHRhZ3NbdC5zdWJzdHIoMCwgaSldID0gdC5zdWJzdHIoaSArIDEpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGFnc1t0XSA9ICcnO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHRhZ3M7XG5cbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VEYXRhQ29uZmlnKHZhbHVlczogYW55LCBwcmVmaXg6IHN0cmluZywgZGVmTWF4U29ja2V0czogbnVtYmVyKTogUURhdGFCcm9rZXJDb25maWcge1xuICAgIGNvbnN0IG9wdCA9IHN1ZmZpeCA9PiB2YWx1ZXNbYCR7cHJlZml4fSR7c3VmZml4fWBdIHx8ICcnO1xuICAgIHJldHVybiB7XG4gICAgICAgIG11dGFibGU6IHBhcnNlQXJhbmdvQ29uZmlnKG9wdCgnTXV0YWJsZScpLCBkZWZNYXhTb2NrZXRzKSxcbiAgICAgICAgaW1tdXRhYmxlSG90OiBwYXJzZUFyYW5nb0NvbmZpZyhvcHQoJ0ltbXV0YWJsZUhvdCcpLCBkZWZNYXhTb2NrZXRzKSxcbiAgICAgICAgaW1tdXRhYmxlQ29sZDogb3B0KCdJbW11dGFibGVDb2xkJykuc3BsaXQoJywnKS5maWx0ZXIoeCA9PiB4KS5tYXAoeCA9PiBwYXJzZUFyYW5nb0NvbmZpZyh4LCBkZWZNYXhTb2NrZXRzKSksXG4gICAgICAgIGltbXV0YWJsZUNvbGRDYWNoZTogcGFyc2VNZW1DYWNoZWRDb25maWcob3B0KCdJbW11dGFibGVDb2xkQ2FjaGUnKSksXG4gICAgfVxufVxuIl19