"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.struct = struct;
exports.array = array;
exports.join = join;
exports.joinArray = joinArray;
exports.scalar = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

function qlFields(path, filter, fieldTypes, qlField) {
  var conditions = [];
  Object.entries(filter).forEach(function (_ref) {
    var _ref2 = (0, _slicedToArray2["default"])(_ref, 2),
        filterKey = _ref2[0],
        filterValue = _ref2[1];

    var fieldType = fieldTypes[filterKey];

    if (fieldType) {
      conditions.push(qlField(fieldType, path, filterKey, filterValue));
    }
  });
  return qlCombine(conditions, 'AND', 'false');
}

function testFields(value, filter, fieldTypes, testField) {
  var failed = Object.entries(filter).find(function (_ref3) {
    var _ref4 = (0, _slicedToArray2["default"])(_ref3, 2),
        filterKey = _ref4[0],
        filterValue = _ref4[1];

    var fieldType = fieldTypes[filterKey];
    return !!(fieldType && testField(fieldType, value, filterKey, filterValue));
  });
  return !failed;
}

function combine(path, key) {
  return key !== '' ? "".concat(path, ".").concat(key) : path;
}

function qlOp(path, op, filter) {
  return "".concat(path, " ").concat(op, " ").concat(JSON.stringify(filter));
}

function qlCombine(conditions, op, defaultConditions) {
  if (conditions.length === 0) {
    return defaultConditions;
  }

  if (conditions.length === 1) {
    return conditions[0];
  }

  return '(' + conditions.join(") ".concat(op, " (")) + ')';
}

function qlIn(path, filter) {
  var conditions = filter.map(function (value) {
    return qlOp(path, '==', value);
  });
  return qlCombine(conditions, 'OR', 'false');
} // Scalars


var scalarEq = {
  ql: function ql(path, filter) {
    return qlOp(path, '==', filter);
  },
  test: function test(value, filter) {
    return value === filter;
  }
};
var scalarNe = {
  ql: function ql(path, filter) {
    return qlOp(path, '!=', filter);
  },
  test: function test(value, filter) {
    return value !== filter;
  }
};
var scalarLt = {
  ql: function ql(path, filter) {
    return qlOp(path, '<', filter);
  },
  test: function test(value, filter) {
    return value < filter;
  }
};
var scalarLe = {
  ql: function ql(path, filter) {
    return qlOp(path, '<=', filter);
  },
  test: function test(value, filter) {
    return value <= filter;
  }
};
var scalarGt = {
  ql: function ql(path, filter) {
    return qlOp(path, '>', filter);
  },
  test: function test(value, filter) {
    return value > filter;
  }
};
var scalarGe = {
  ql: function ql(path, filter) {
    return qlOp(path, '>=', filter);
  },
  test: function test(value, filter) {
    return value >= filter;
  }
};
var scalarIn = {
  ql: function ql(path, filter) {
    return qlIn(path, filter);
  },
  test: function test(value, filter) {
    return filter.includes(value);
  }
};
var scalarNotIn = {
  ql: function ql(path, filter) {
    return "NOT (".concat(qlIn(path, filter), ")");
  },
  test: function test(value, filter) {
    return !filter.includes(value);
  }
};

function createScalar() {
  var fields = {
    eq: scalarEq,
    ne: scalarNe,
    lt: scalarLt,
    le: scalarLe,
    gt: scalarGt,
    ge: scalarGe,
    "in": scalarIn,
    notIn: scalarNotIn
  };
  return {
    ql: function ql(path, filter) {
      return qlFields(path, filter, fields, function (op, path, filterKey, filterValue) {
        return op.ql(path, filterValue);
      });
    },
    test: function test(value, filter) {
      return testFields(value, filter, fields, function (op, value, filterKey, filterValue) {
        return op.test(value, filterValue);
      });
    }
  };
}

var scalar = createScalar(); // Structs

exports.scalar = scalar;

function struct(fields, isCollection) {
  return {
    ql: function ql(path, filter) {
      return qlFields(path, filter, fields, function (fieldType, path, filterKey, filterValue) {
        var fieldName = isCollection && filterKey === 'id' ? '_key' : filterKey;
        return fieldType.ql(combine(path, fieldName), filterValue);
      });
    },
    test: function test(value, filter) {
      return testFields(value, filter, fields, function (fieldType, value, filterKey, filterValue) {
        return fieldType.test(value[filterKey], filterValue);
      });
    }
  };
} // Arrays


function array(itemType) {
  var ops = {
    all: {
      ql: function ql(path, filter) {
        var itemQl = itemType.ql('CURRENT', filter);
        return "LENGTH(".concat(path, "[* FILTER ").concat(itemQl, "]) == LENGTH(").concat(path, ")");
      },
      test: function test(value, filter) {
        var failedIndex = value.findIndex(function (x) {
          return !itemType.test(x, filter);
        });
        return failedIndex < 0;
      }
    },
    any: {
      ql: function ql(path, filter) {
        var itemQl = itemType.ql('CURRENT', filter);
        return "LENGTH(".concat(path, "[* FILTER ").concat(itemQl, "]) > 0");
      },
      test: function test(value, filter) {
        var succeededIndex = value.findIndex(function (x) {
          return itemType.test(x, filter);
        });
        return succeededIndex >= 0;
      }
    }
  };
  return {
    ql: function ql(path, filter) {
      return qlFields(path, filter, ops, function (op, path, filterKey, filterValue) {
        return op.ql(combine(path, filterKey), filterValue);
      });
    },
    test: function test(value, filter) {
      return testFields(value, filter, ops, function (op, value, filterKey, filterValue) {
        return op.test(value[filterKey], filterValue);
      });
    }
  };
} // Joins


function join(onField, refCollection, refType) {
  return {
    ql: function ql(path, filter) {
      var on_path = path.split('.').slice(0, -1).concat(onField).join('.');
      var alias = "".concat(on_path.replace('.', '_'));
      var refQl = refType.ql(alias, filter);
      return "\n                LENGTH(\n                    FOR ".concat(alias, " IN ").concat(refCollection, " \n                    FILTER (").concat(alias, "._key == ").concat(on_path, ") AND (").concat(refQl, ")\n                    LIMIT 1\n                    RETURN 1\n                ) > 0");
    },
    test: refType.test
  };
}

function joinArray(onField, refCollection, refType) {
  return {
    ql: function ql(path, filter) {
      var refFilter = filter.all || filter.any;
      var all = !!filter.all;
      var on_path = path.split('.').slice(0, -1).concat(onField).join('.');
      var alias = "".concat(on_path.replace('.', '_'));
      var refQl = refType.ql(alias, refFilter);
      return "\n                (LENGTH(".concat(on_path, ") > 0)\n                AND (LENGTH(\n                    FOR ").concat(alias, " IN ").concat(refCollection, " \n                    FILTER (").concat(alias, "._key IN ").concat(on_path, ") AND (").concat(refQl, ")\n                    ").concat(!all ? 'LIMIT 1' : '', "\n                    RETURN 1\n                ) ").concat(all ? "== LENGTH(".concat(on_path, ")") : '> 0', ")");
    },
    test: refType.test
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hcmFuZ28tdHlwZXMuanMiXSwibmFtZXMiOlsicWxGaWVsZHMiLCJwYXRoIiwiZmlsdGVyIiwiZmllbGRUeXBlcyIsInFsRmllbGQiLCJjb25kaXRpb25zIiwiT2JqZWN0IiwiZW50cmllcyIsImZvckVhY2giLCJmaWx0ZXJLZXkiLCJmaWx0ZXJWYWx1ZSIsImZpZWxkVHlwZSIsInB1c2giLCJxbENvbWJpbmUiLCJ0ZXN0RmllbGRzIiwidmFsdWUiLCJ0ZXN0RmllbGQiLCJmYWlsZWQiLCJmaW5kIiwiY29tYmluZSIsImtleSIsInFsT3AiLCJvcCIsIkpTT04iLCJzdHJpbmdpZnkiLCJkZWZhdWx0Q29uZGl0aW9ucyIsImxlbmd0aCIsImpvaW4iLCJxbEluIiwibWFwIiwic2NhbGFyRXEiLCJxbCIsInRlc3QiLCJzY2FsYXJOZSIsInNjYWxhckx0Iiwic2NhbGFyTGUiLCJzY2FsYXJHdCIsInNjYWxhckdlIiwic2NhbGFySW4iLCJpbmNsdWRlcyIsInNjYWxhck5vdEluIiwiY3JlYXRlU2NhbGFyIiwiZmllbGRzIiwiZXEiLCJuZSIsImx0IiwibGUiLCJndCIsImdlIiwibm90SW4iLCJzY2FsYXIiLCJzdHJ1Y3QiLCJpc0NvbGxlY3Rpb24iLCJmaWVsZE5hbWUiLCJhcnJheSIsIml0ZW1UeXBlIiwib3BzIiwiYWxsIiwiaXRlbVFsIiwiZmFpbGVkSW5kZXgiLCJmaW5kSW5kZXgiLCJ4IiwiYW55Iiwic3VjY2VlZGVkSW5kZXgiLCJvbkZpZWxkIiwicmVmQ29sbGVjdGlvbiIsInJlZlR5cGUiLCJvbl9wYXRoIiwic3BsaXQiLCJzbGljZSIsImNvbmNhdCIsImFsaWFzIiwicmVwbGFjZSIsInJlZlFsIiwiam9pbkFycmF5IiwicmVmRmlsdGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFLQSxTQUFTQSxRQUFULENBQ0lDLElBREosRUFFSUMsTUFGSixFQUdJQyxVQUhKLEVBSUlDLE9BSkosRUFLVTtBQUNOLE1BQU1DLFVB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QkMsS0FBaEIsQ0FBc0IsQ0FBdEIsRUFBeUIsQ0FBQyxDQUExQixFQUE2QkMsTUFBN0IsQ0FBb0NOLE9BQXBDLEVBQTZDckMsSUFBN0MsQ0FBa0QsR0FBbEQsQ0FBaEI7QUFDQSxVQUFNNEMsS0FBSyxhQUFNSixPQUFPLENBQUNLLE9BQVIsQ0FBZ0IsR0FBaEIsRUFBcUIsR0FBckIsQ0FBTixDQUFYO0FBQ0EsVUFBTUMsS0FBSyxHQUFHUCxPQUFPLENBQUNuQyxFQUFSLENBQVd3QyxLQUFYLEVBQWtCSSxTQUFsQixDQUFkO0FBQ0EsaURBQ2NSLE9BRGQsMkVBR2NJLEtBSGQsaUJBRzBCTixhQUgxQiw0Q0FJa0JNLEtBSmxCLHNCQUltQ0osT0FKbkMsb0JBSW9ETSxLQUpwRCxvQ0FLVSxDQUFDaEIsR0FBRCxHQUFPLFNBQVAsR0FBbUIsRUFMN0IsK0RBT1FBLEdBQUcsdUJBQWdCVSxPQUFoQixTQUE2QixLQVB4QztBQVFILEtBZkU7QUFnQkhuQyxJQUFBQSxJQUFJLEVBQUVrQyxPQUFPLENBQUNsQztBQWhCWCxHQUFQO0FBa0JIIiwic291cmNlc0NvbnRlbnQiOlsidHlwZSBRVHlwZSA9IHtcbiAgICBxbDogKHBhdGg6IHN0cmluZywgZmlsdGVyOiBhbnkpID0+IHN0cmluZyxcbiAgICB0ZXN0OiAodmFsdWU6IGFueSwgZmlsdGVyOiBhbnkpID0+IGJvb2xlYW4sXG59XG5cbmZ1bmN0aW9uIHFsRmllbGRzKFxuICAgIHBhdGg6IHN0cmluZyxcbiAgICBmaWx0ZXI6IGFueSxcbiAgICBmaWVsZFR5cGVzOiB7IFtzdHJpbmddOiBRVHlwZSB9LFxuICAgIHFsRmllbGQ6IChmaWVsZDogYW55LCBwYXRoOiBzdHJpbmcsIGZpbHRlcktleTogc3RyaW5nLCBmaWx0ZXJWYWx1ZTogYW55KSA9PiBzdHJpbmdcbik6IHN0cmluZyB7XG4gICAgY29uc3QgY29uZGl0aW9uczogc3RyaW5nW10gPSBbXTtcbiAgICBPYmplY3QuZW50cmllcyhmaWx0ZXIpLmZvckVhY2goKFtmaWx0ZXJLZXksIGZpbHRlclZhbHVlXSkgPT4ge1xuICAgICAgICBjb25zdCBmaWVsZFR5cGUgPSBmaWVsZFR5cGVzW2ZpbHRlcktleV07XG4gICAgICAgIGlmIChmaWVsZFR5cGUpIHtcbiAgICAgICAgICAgIGNvbmRpdGlvbnMucHVzaChxbEZpZWxkKGZpZWxkVHlwZSwgcGF0aCwgZmlsdGVyS2V5LCBmaWx0ZXJWYWx1ZSkpXG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcWxDb21iaW5lKGNvbmRpdGlvbnMsICdBTkQnLCAnZmFsc2UnKTtcbn1cblxuZnVuY3Rpb24gdGVzdEZpZWxkcyhcbiAgICB2YWx1ZTogYW55LFxuICAgIGZpbHRlcjogYW55LFxuICAgIGZpZWxkVHlwZXM6IHsgW3N0cmluZ106IFFUeXBlIH0sXG4gICAgdGVzdEZpZWxkOiAoZmllbGRUeXBlOiBhbnksIHZhbHVlOiBhbnksIGZpbHRlcktleTogc3RyaW5nLCBmaWx0ZXJWYWx1ZTogYW55KSA9PiBib29sZWFuXG4pOiBib29sZWFuIHtcbiAgICBjb25zdCBmYWlsZWQgPSBPYmplY3QuZW50cmllcyhmaWx0ZXIpLmZpbmQoKFtmaWx0ZXJLZXksIGZpbHRlclZhbHVlXSkgPT4ge1xuICAgICAgICBjb25zdCBmaWVsZFR5cGUgPSBmaWVsZFR5cGVzW2ZpbHRlcktleV07XG4gICAgICAgIHJldHVybiAhIShmaWVsZFR5cGUgJiYgdGVzdEZpZWxkKGZpZWxkVHlwZSwgdmFsdWUsIGZpbHRlcktleSwgZmlsdGVyVmFsdWUpKTtcbiAgICB9KTtcbiAgICByZXR1cm4gIWZhaWxlZDtcbn1cblxuXG5mdW5jdGlvbiBjb21iaW5lKHBhdGg6IHN0cmluZywga2V5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiBrZXkgIT09ICcnID8gYCR7cGF0aH0uJHtrZXl9YCA6IHBhdGg7XG59XG5cbmZ1bmN0aW9uIHFsT3AocGF0aDogc3RyaW5nLCBvcDogc3RyaW5nLCBmaWx0ZXI6IGFueSk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGAke3BhdGh9ICR7b3B9ICR7SlNPTi5zdHJpbmdpZnkoZmlsdGVyKX1gO1xufVxuXG5mdW5jdGlvbiBxbENvbWJpbmUoY29uZGl0aW9uczogc3RyaW5nW10sIG9wOiBzdHJpbmcsIGRlZmF1bHRDb25kaXRpb25zOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmIChjb25kaXRpb25zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gZGVmYXVsdENvbmRpdGlvbnM7XG4gICAgfVxuICAgIGlmIChjb25kaXRpb25zLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICByZXR1cm4gY29uZGl0aW9uc1swXTtcbiAgICB9XG4gICAgcmV0dXJuICcoJyArIGNvbmRpdGlvbnMuam9pbihgKSAke29wfSAoYCkgKyAnKSc7XG59XG5cbmZ1bmN0aW9uIHFsSW4ocGF0aDogc3RyaW5nLCBmaWx0ZXI6IGFueSk6IHN0cmluZyB7XG4gICAgY29uc3QgY29uZGl0aW9ucyA9IGZpbHRlci5tYXAodmFsdWUgPT4gcWxPcChwYXRoLCAnPT0nLCB2YWx1ZSkpO1xuICAgIHJldHVybiBxbENvbWJpbmUoY29uZGl0aW9ucywgJ09SJywgJ2ZhbHNlJyk7XG59XG5cbi8vIFNjYWxhcnNcblxuY29uc3Qgc2NhbGFyRXE6IFFUeXBlID0ge1xuICAgIHFsKHBhdGgsIGZpbHRlcikge1xuICAgICAgICByZXR1cm4gcWxPcChwYXRoLCAnPT0nLCBmaWx0ZXIpO1xuICAgIH0sXG4gICAgdGVzdCh2YWx1ZSwgZmlsdGVyKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZSA9PT0gZmlsdGVyO1xuICAgIH0sXG59O1xuXG5jb25zdCBzY2FsYXJOZTogUVR5cGUgPSB7XG4gICAgcWwocGF0aCwgZmlsdGVyKSB7XG4gICAgICAgIHJldHVybiBxbE9wKHBhdGgsICchPScsIGZpbHRlcik7XG4gICAgfSxcbiAgICB0ZXN0KHZhbHVlLCBmaWx0ZXIpIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlICE9PSBmaWx0ZXI7XG4gICAgfSxcbn07XG5cbmNvbnN0IHNjYWxhckx0OiBRVHlwZSA9IHtcbiAgICBxbChwYXRoLCBmaWx0ZXIpIHtcbiAgICAgICAgcmV0dXJuIHFsT3AocGF0aCwgJzwnLCBmaWx0ZXIpO1xuICAgIH0sXG4gICAgdGVzdCh2YWx1ZSwgZmlsdGVyKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZSA8IGZpbHRlcjtcbiAgICB9LFxufTtcblxuY29uc3Qgc2NhbGFyTGU6IFFUeXBlID0ge1xuICAgIHFsKHBhdGgsIGZpbHRlcikge1xuICAgICAgICByZXR1cm4gcWxPcChwYXRoLCAnPD0nLCBmaWx0ZXIpO1xuICAgIH0sXG4gICAgdGVzdCh2YWx1ZSwgZmlsdGVyKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZSA8PSBmaWx0ZXI7XG4gICAgfSxcbn07XG5cbmNvbnN0IHNjYWxhckd0OiBRVHlwZSA9IHtcbiAgICBxbChwYXRoLCBmaWx0ZXIpIHtcbiAgICAgICAgcmV0dXJuIHFsT3AocGF0aCwgJz4nLCBmaWx0ZXIpO1xuICAgIH0sXG4gICAgdGVzdCh2YWx1ZSwgZmlsdGVyKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZSA+IGZpbHRlcjtcbiAgICB9LFxufTtcblxuY29uc3Qgc2NhbGFyR2U6IFFUeXBlID0ge1xuICAgIHFsKHBhdGgsIGZpbHRlcikge1xuICAgICAgICByZXR1cm4gcWxPcChwYXRoLCAnPj0nLCBmaWx0ZXIpO1xuICAgIH0sXG4gICAgdGVzdCh2YWx1ZSwgZmlsdGVyKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZSA+PSBmaWx0ZXI7XG4gICAgfSxcbn07XG5cbmNvbnN0IHNjYWxhckluOiBRVHlwZSA9IHtcbiAgICBxbChwYXRoLCBmaWx0ZXIpIHtcbiAgICAgICAgcmV0dXJuIHFsSW4ocGF0aCwgZmlsdGVyKTtcbiAgICB9LFxuICAgIHRlc3QodmFsdWUsIGZpbHRlcikge1xuICAgICAgICByZXR1cm4gZmlsdGVyLmluY2x1ZGVzKHZhbHVlKTtcbiAgICB9LFxufTtcblxuY29uc3Qgc2NhbGFyTm90SW46IFFUeXBlID0ge1xuICAgIHFsKHBhdGgsIGZpbHRlcikge1xuICAgICAgICByZXR1cm4gYE5PVCAoJHtxbEluKHBhdGgsIGZpbHRlcil9KWA7XG4gICAgfSxcbiAgICB0ZXN0KHZhbHVlLCBmaWx0ZXIpIHtcbiAgICAgICAgcmV0dXJuICFmaWx0ZXIuaW5jbHVkZXModmFsdWUpO1xuICAgIH1cbn07XG5cbmZ1bmN0aW9uIGNyZWF0ZVNjYWxhcigpOiBRVHlwZSB7XG4gICAgY29uc3QgZmllbGRzID0ge1xuICAgICAgICBlcTogc2NhbGFyRXEsXG4gICAgICAgIG5lOiBzY2FsYXJOZSxcbiAgICAgICAgbHQ6IHNjYWxhckx0LFxuICAgICAgICBsZTogc2NhbGFyTGUsXG4gICAgICAgIGd0OiBzY2FsYXJHdCxcbiAgICAgICAgZ2U6IHNjYWxhckdlLFxuICAgICAgICBpbjogc2NhbGFySW4sXG4gICAgICAgIG5vdEluOiBzY2FsYXJOb3RJbixcbiAgICB9O1xuICAgIHJldHVybiB7XG4gICAgICAgIHFsKHBhdGgsIGZpbHRlcikge1xuICAgICAgICAgICAgcmV0dXJuIHFsRmllbGRzKHBhdGgsIGZpbHRlciwgZmllbGRzLCAob3AsIHBhdGgsIGZpbHRlcktleSwgZmlsdGVyVmFsdWUpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gb3AucWwocGF0aCwgZmlsdGVyVmFsdWUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0sXG4gICAgICAgIHRlc3QodmFsdWUsIGZpbHRlcikge1xuICAgICAgICAgICAgcmV0dXJuIHRlc3RGaWVsZHModmFsdWUsIGZpbHRlciwgZmllbGRzLCAob3AsIHZhbHVlLCBmaWx0ZXJLZXksIGZpbHRlclZhbHVlKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9wLnRlc3QodmFsdWUsIGZpbHRlclZhbHVlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfTtcbn1cblxuY29uc3Qgc2NhbGFyOiBRVHlwZSA9IGNyZWF0ZVNjYWxhcigpO1xuXG4vLyBTdHJ1Y3RzXG5cbmZ1bmN0aW9uIHN0cnVjdChmaWVsZHM6IHsgW3N0cmluZ106IFFUeXBlIH0sIGlzQ29sbGVjdGlvbj86IGJvb2xlYW4pOiBRVHlwZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgcWwocGF0aCwgZmlsdGVyKSB7XG4gICAgICAgICAgICByZXR1cm4gcWxGaWVsZHMocGF0aCwgZmlsdGVyLCBmaWVsZHMsIChmaWVsZFR5cGUsIHBhdGgsIGZpbHRlcktleSwgZmlsdGVyVmFsdWUpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaWVsZE5hbWUgPSBpc0NvbGxlY3Rpb24gJiYgKGZpbHRlcktleSA9PT0gJ2lkJykgPyAnX2tleScgOiBmaWx0ZXJLZXk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpZWxkVHlwZS5xbChjb21iaW5lKHBhdGgsIGZpZWxkTmFtZSksIGZpbHRlclZhbHVlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LFxuICAgICAgICB0ZXN0KHZhbHVlLCBmaWx0ZXIpIHtcbiAgICAgICAgICAgIHJldHVybiB0ZXN0RmllbGRzKHZhbHVlLCBmaWx0ZXIsIGZpZWxkcywgKGZpZWxkVHlwZSwgdmFsdWUsIGZpbHRlcktleSwgZmlsdGVyVmFsdWUpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmllbGRUeXBlLnRlc3QodmFsdWVbZmlsdGVyS2V5XSwgZmlsdGVyVmFsdWUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8vIEFycmF5c1xuXG5mdW5jdGlvbiBhcnJheShpdGVtVHlwZTogUVR5cGUpOiBRVHlwZSB7XG4gICAgY29uc3Qgb3BzID0ge1xuICAgICAgICBhbGw6IHtcbiAgICAgICAgICAgIHFsKHBhdGgsIGZpbHRlcikge1xuICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW1RbCA9IGl0ZW1UeXBlLnFsKCdDVVJSRU5UJywgZmlsdGVyKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gYExFTkdUSCgke3BhdGh9WyogRklMVEVSICR7aXRlbVFsfV0pID09IExFTkdUSCgke3BhdGh9KWA7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdGVzdCh2YWx1ZSwgZmlsdGVyKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZmFpbGVkSW5kZXggPSB2YWx1ZS5maW5kSW5kZXgoeCA9PiAhaXRlbVR5cGUudGVzdCh4LCBmaWx0ZXIpKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFpbGVkSW5kZXggPCAwO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgYW55OiB7XG4gICAgICAgICAgICBxbChwYXRoLCBmaWx0ZXIpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpdGVtUWwgPSBpdGVtVHlwZS5xbCgnQ1VSUkVOVCcsIGZpbHRlcik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGBMRU5HVEgoJHtwYXRofVsqIEZJTFRFUiAke2l0ZW1RbH1dKSA+IDBgO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRlc3QodmFsdWUsIGZpbHRlcikge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN1Y2NlZWRlZEluZGV4ID0gdmFsdWUuZmluZEluZGV4KHggPT4gaXRlbVR5cGUudGVzdCh4LCBmaWx0ZXIpKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3VjY2VlZGVkSW5kZXggPj0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICB9O1xuICAgIHJldHVybiB7XG4gICAgICAgIHFsKHBhdGgsIGZpbHRlcikge1xuICAgICAgICAgICAgcmV0dXJuIHFsRmllbGRzKHBhdGgsIGZpbHRlciwgb3BzLCAob3AsIHBhdGgsIGZpbHRlcktleSwgZmlsdGVyVmFsdWUpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gb3AucWwoY29tYmluZShwYXRoLCBmaWx0ZXJLZXkpLCBmaWx0ZXJWYWx1ZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSxcbiAgICAgICAgdGVzdCh2YWx1ZSwgZmlsdGVyKSB7XG4gICAgICAgICAgICByZXR1cm4gdGVzdEZpZWxkcyh2YWx1ZSwgZmlsdGVyLCBvcHMsIChvcCwgdmFsdWUsIGZpbHRlcktleSwgZmlsdGVyVmFsdWUpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gb3AudGVzdCh2YWx1ZVtmaWx0ZXJLZXldLCBmaWx0ZXJWYWx1ZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuLy8gSm9pbnNcblxuZnVuY3Rpb24gam9pbihvbkZpZWxkOiBzdHJpbmcsIHJlZkNvbGxlY3Rpb246IHN0cmluZywgcmVmVHlwZTogUVR5cGUpOiBRVHlwZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgcWwocGF0aCwgZmlsdGVyKSB7XG4gICAgICAgICAgICBjb25zdCBvbl9wYXRoID0gcGF0aC5zcGxpdCgnLicpLnNsaWNlKDAsIC0xKS5jb25jYXQob25GaWVsZCkuam9pbignLicpO1xuICAgICAgICAgICAgY29uc3QgYWxpYXMgPSBgJHtvbl9wYXRoLnJlcGxhY2UoJy4nLCAnXycpfWA7XG4gICAgICAgICAgICBjb25zdCByZWZRbCA9IHJlZlR5cGUucWwoYWxpYXMsIGZpbHRlcik7XG4gICAgICAgICAgICByZXR1cm4gYFxuICAgICAgICAgICAgICAgIExFTkdUSChcbiAgICAgICAgICAgICAgICAgICAgRk9SICR7YWxpYXN9IElOICR7cmVmQ29sbGVjdGlvbn0gXG4gICAgICAgICAgICAgICAgICAgIEZJTFRFUiAoJHthbGlhc30uX2tleSA9PSAke29uX3BhdGh9KSBBTkQgKCR7cmVmUWx9KVxuICAgICAgICAgICAgICAgICAgICBMSU1JVCAxXG4gICAgICAgICAgICAgICAgICAgIFJFVFVSTiAxXG4gICAgICAgICAgICAgICAgKSA+IDBgO1xuICAgICAgICB9LFxuICAgICAgICB0ZXN0OiByZWZUeXBlLnRlc3QsXG4gICAgfTtcbn1cblxuZnVuY3Rpb24gam9pbkFycmF5KG9uRmllbGQ6IHN0cmluZywgcmVmQ29sbGVjdGlvbjogc3RyaW5nLCByZWZUeXBlOiBRVHlwZSk6IFFUeXBlIHtcbiAgICByZXR1cm4ge1xuICAgICAgICBxbChwYXRoLCBmaWx0ZXIpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlZkZpbHRlciA9IGZpbHRlci5hbGwgfHwgZmlsdGVyLmFueTtcbiAgICAgICAgICAgIGNvbnN0IGFsbCA9ICEhZmlsdGVyLmFsbDtcbiAgICAgICAgICAgIGNvbnN0IG9uX3BhdGggPSBwYXRoLnNwbGl0KCcuJykuc2xpY2UoMCwgLTEpLmNvbmNhdChvbkZpZWxkKS5qb2luKCcuJyk7XG4gICAgICAgICAgICBjb25zdCBhbGlhcyA9IGAke29uX3BhdGgucmVwbGFjZSgnLicsICdfJyl9YDtcbiAgICAgICAgICAgIGNvbnN0IHJlZlFsID0gcmVmVHlwZS5xbChhbGlhcywgcmVmRmlsdGVyKTtcbiAgICAgICAgICAgIHJldHVybiBgXG4gICAgICAgICAgICAgICAgKExFTkdUSCgke29uX3BhdGh9KSA+IDApXG4gICAgICAgICAgICAgICAgQU5EIChMRU5HVEgoXG4gICAgICAgICAgICAgICAgICAgIEZPUiAke2FsaWFzfSBJTiAke3JlZkNvbGxlY3Rpb259IFxuICAgICAgICAgICAgICAgICAgICBGSUxURVIgKCR7YWxpYXN9Ll9rZXkgSU4gJHtvbl9wYXRofSkgQU5EICgke3JlZlFsfSlcbiAgICAgICAgICAgICAgICAgICAgJHshYWxsID8gJ0xJTUlUIDEnIDogJyd9XG4gICAgICAgICAgICAgICAgICAgIFJFVFVSTiAxXG4gICAgICAgICAgICAgICAgKSAke2FsbCA/IGA9PSBMRU5HVEgoJHtvbl9wYXRofSlgIDogJz4gMCd9KWA7XG4gICAgICAgIH0sXG4gICAgICAgIHRlc3Q6IHJlZlR5cGUudGVzdCxcbiAgICB9O1xufVxuXG5leHBvcnQge1xuICAgIHNjYWxhcixcbiAgICBzdHJ1Y3QsXG4gICAgYXJyYXksXG4gICAgam9pbixcbiAgICBqb2luQXJyYXlcbn1cblxuZXhwb3J0IHR5cGUge1xuICAgIFFUeXBlXG59XG5cbiJdfQ==