"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.u8enum = u8enum;
exports.isBigInt = isBigInt;
exports.unresolvedType = unresolvedType;
exports.toEnumStyle = toEnumStyle;
exports.stringifyEnumValues = stringifyEnumValues;
exports.getDocMD = getDocMD;
exports.parseDbSchema = parseDbSchema;
exports.scalarTypes = exports.DbTypeCategory = exports.otherCurrencyCollection = exports.OtherCurrency = exports.grams = exports.unixSeconds = exports.u32WithFormatter = exports.u128 = exports.u64 = exports.u32 = exports.u16 = exports.u8 = exports.i32 = exports.i8 = exports.required = exports.withDoc = exports.join = void 0;

var _gen = require("../../maintanance/gen-graphql/gen.js");

var _schema = require("./schema.js");

const {
  ref,
  arrayOf
} = _schema.Def;
const ToStringFormatter = {
  unixMillisecondsToString: 'unixMillisecondsToString',
  unixSecondsToString: 'unixSecondsToString'
};

const join = (refDef, on, refOn, preCondition) => {
  return { ...ref(refDef),
    _: {
      join: {
        on,
        refOn,
        preCondition: preCondition || ''
      }
    }
  };
};

exports.join = join;

const withDoc = (def, doc) => ({ ...def,
  ...(doc ? {
    _doc: doc
  } : {})
});

exports.withDoc = withDoc;

const required = def => def;

exports.required = required;

const uint = (size, doc) => withDoc({
  _int: {
    unsigned: true,
    size
  }
}, doc);

const int = (size, doc) => withDoc({
  _int: {
    unsigned: false,
    size
  }
}, doc);

const i8 = doc => int(8, doc);

exports.i8 = i8;

const i32 = doc => int(32, doc);

exports.i32 = i32;

const u8 = doc => uint(8, doc);

exports.u8 = u8;

const u16 = doc => uint(16, doc);

exports.u16 = u16;

const u32 = doc => uint(32, doc);

exports.u32 = u32;

const u64 = doc => uint(64, doc);

exports.u64 = u64;

const u128 = doc => uint(128, doc);

exports.u128 = u128;

const u256 = doc => uint(256, doc);

const u32WithFormatter = (formatter, doc) => withDoc({
  _int: {
    unsigned: true,
    size: 32
  },
  _: {
    formatter
  }
}, doc);

exports.u32WithFormatter = u32WithFormatter;

const unixSeconds = doc => u32WithFormatter(ToStringFormatter.unixSecondsToString, doc);

exports.unixSeconds = unixSeconds;
const grams = u128;
exports.grams = grams;

function u8enum(name, values) {
  return doc => {
    const valuesDoc = Object.entries(values).map(([name, value]) => {
      return `- ${value} â€“ ${name}`;
    }).join('\n');
    const effectiveDoc = `${doc ? `${doc}\n` : ''}${valuesDoc}`;
    return withDoc({
      _int: {
        unsigned: true,
        size: 8
      },
      _: {
        enum: {
          name,
          values
        }
      }
    }, effectiveDoc);
  };
}

const OtherCurrency = {
  currency: u32(),
  value: u256()
};
exports.OtherCurrency = OtherCurrency;

const otherCurrencyCollection = doc => arrayOf(ref({
  OtherCurrency
}), doc);

exports.otherCurrencyCollection = otherCurrencyCollection;
const DbTypeCategory = {
  unresolved: 'unresolved',
  scalar: 'scalar',
  union: 'union',
  struct: 'struct'
};
exports.DbTypeCategory = DbTypeCategory;

function scalarType(name) {
  return {
    name,
    category: DbTypeCategory.scalar,
    fields: [],
    doc: ''
  };
}

const scalarTypes = {
  int: scalarType('Int'),
  uint64: scalarType('String'),
  uint1024: scalarType('String'),
  float: scalarType('Float'),
  boolean: scalarType('Boolean'),
  string: scalarType('String')
};
exports.scalarTypes = scalarTypes;

function isBigInt(type) {
  return type === scalarTypes.uint1024 || type === scalarTypes.uint64;
}

function unresolvedType(name) {
  return {
    name,
    category: DbTypeCategory.unresolved,
    fields: [],
    doc: ''
  };
}

function toEnumStyle(s) {
  return `${s.substr(0, 1).toUpperCase()}${s.substr(1)}`;
}

function stringifyEnumValues(values) {
  const fields = Object.entries(values).map(([name, value]) => {
    return `${toEnumStyle(name)}: ${value}`;
  });
  return `{ ${fields.join(', ')} }`;
}

function getDocMD(schema) {
  const doc = schema.doc;

  if (!doc) {
    return '';
  }

  if (typeof doc === 'string') {
    return doc;
  }

  if (doc.md) {
    return doc.md;
  }

  return '';
}

function parseDbSchema(schemaDef) {
  const dbTypes = [];
  const enumTypes = new Map();

  function parseDbField(typeName, schemaField) {
    let schemaType = schemaField;
    const field = {
      name: schemaField.name,
      arrayDepth: 0,
      type: scalarTypes.string,
      doc: getDocMD(schemaField)
    };

    while (schemaType.array) {
      field.arrayDepth += 1;
      schemaType = schemaType.array;
    }

    const ex = schemaType._;
    const enumDef = ex && ex.enum || null;

    if (enumDef) {
      field.enumDef = enumDef;
      enumTypes.set(enumDef.name, enumDef);
    }

    const join = ex && ex.join;

    if (join) {
      field.join = join;
    }

    if (ex && ex.formatter) {
      field.formatter = ex.formatter;
    }

    if (schemaType.union || schemaType.struct) {
      field.type = unresolvedType((0, _gen.makeFieldTypeName)(typeName, schemaField.name));
    } else if (schemaType.ref) {
      field.type = unresolvedType(schemaType.ref.name);
    } else if (schemaType.bool) {
      field.type = scalarTypes.boolean;
    } else if (schemaType.int) {
      const unsigned = schemaType.int && schemaType.int.unsigned || false;
      const size = schemaType.int && schemaType.int.size || 32;

      if (unsigned) {
        if (size >= 128) {
          field.type = scalarTypes.uint1024;
        } else if (size >= 64) {
          field.type = scalarTypes.uint64;
        } else if (size >= 32) {
          field.type = scalarTypes.float;
        } else {
          field.type = scalarTypes.int;
        }
      } else {
        if (size > 32) {
          throw new Error(`Integer type with size ${size} bit does not supported`);
        } else {
          field.type = scalarTypes.int;
        }
      }
    } else if (schemaType.float) {
      field.type = scalarTypes.float;
    } else if (schemaType.string) {
      field.type = scalarTypes.string;
    } else {
      field.type = scalarTypes.string;
      console.log('Invalid field type: ', JSON.stringify(schemaType));
      process.exit(1);
    }

    return field;
  }

  function unwrapArrays(type) {
    if (type.array) {
      return unwrapArrays(type.array);
    }

    return type;
  }

  function parseDbType(name, schemaType) {
    const struct = schemaType.union || schemaType.struct;

    if (!struct) {
      console.log(`?? ${name}: ${JSON.stringify(schemaType).substr(0, 200)}`);
      return;
    }

    const type = {
      name,
      category: schemaType.union ? DbTypeCategory.union : DbTypeCategory.struct,
      fields: [],
      collection: schemaType._.collection,
      doc: getDocMD(schemaType)
    };

    if (type.collection) {
      type.fields.push({
        name: 'id',
        arrayDepth: 0,
        type: scalarTypes.string,
        doc: ''
      });
    }

    struct.forEach(field => {
      type.fields.push(parseDbField(name, field));
      const unwrapped = unwrapArrays(field);
      const ownType = unwrapped.struct || unwrapped.union ? unwrapped : null;

      if (ownType) {
        parseDbType((0, _gen.makeFieldTypeName)(name, field.name), ownType);
      }
    });
    dbTypes.push(type);
  }

  const schema = (0, _schema.parseTypeDef)(schemaDef);

  if (schema.class) {
    schema.class.types.forEach(type => {
      parseDbType(type.name, type);
    });
  }

  const unresolved = new Map();
  const resolving = new Set();
  const resolved = new Map();
  const orderedResolved = [];
  dbTypes.forEach(t => unresolved.set(t.name, t));

  const resolveType = type => {
    if (resolved.has(type.name)) {
      return;
    }

    if (resolving.has(type.name)) {
      console.log(`WARNING: Circular reference to type ${type.name}`);
      return;
    }

    resolving.add(type.name);
    type.fields.forEach(field => {
      if (field.type.category === DbTypeCategory.unresolved) {
        let type = resolved.get(field.type.name);

        if (!type) {
          type = unresolved.get(field.type.name);

          if (type) {
            resolveType(type);
          } else {
            console.log(`Referenced type not found: ${field.type.name}`);
            process.exit(1);
          }
        }

        if (type) {
          field.type = type;
        }
      }
    });
    resolving.delete(type.name);
    orderedResolved.push(type);
    unresolved.delete(type.name);
    resolved.set(type.name, type);
  };

  dbTypes.forEach(resolveType);
  return {
    types: orderedResolved,
    enumTypes
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvc2NoZW1hL2RiLXNjaGVtYS10eXBlcy5qcyJdLCJuYW1lcyI6WyJyZWYiLCJhcnJheU9mIiwiRGVmIiwiVG9TdHJpbmdGb3JtYXR0ZXIiLCJ1bml4TWlsbGlzZWNvbmRzVG9TdHJpbmciLCJ1bml4U2Vjb25kc1RvU3RyaW5nIiwiam9pbiIsInJlZkRlZiIsIm9uIiwicmVmT24iLCJwcmVDb25kaXRpb24iLCJfIiwid2l0aERvYyIsImRlZiIsImRvYyIsIl9kb2MiLCJyZXF1aXJlZCIsInVpbnQiLCJzaXplIiwiX2ludCIsInVuc2lnbmVkIiwiaW50IiwiaTgiLCJpMzIiLCJ1OCIsInUxNiIsInUzMiIsInU2NCIsInUxMjgiLCJ1MjU2IiwidTMyV2l0aEZvcm1hdHRlciIsImZvcm1hdHRlciIsInVuaXhTZWNvbmRzIiwiZ3JhbXMiLCJ1OGVudW0iLCJuYW1lIiwidmFsdWVzIiwidmFsdWVzRG9jIiwiT2JqZWN0IiwiZW50cmllcyIsIm1hcCIsInZhbHVlIiwiZWZmZWN0aXZlRG9jIiwiZW51bSIsIk90aGVyQ3VycmVuY3kiLCJjdXJyZW5jeSIsIm90aGVyQ3VycmVuY3lDb2xsZWN0aW9uIiwiRGJUeXBlQ2F0ZWdvcnkiLCJ1bnJlc29sdmVkIiwic2NhbGFyIiwidW5pb24iLCJzdHJ1Y3QiLCJzY2FsYXJUeXBlIiwiY2F0ZWdvcnkiLCJmaWVsZHMiLCJzY2FsYXJUeXBlcyIsInVpbnQ2NCIsInVpbnQxMDI0IiwiZmxvYXQiLCJib29sZWFuIiwic3RyaW5nIiwiaXNCaWdJbnQiLCJ0eXBlIiwidW5yZXNvbHZlZFR5cGUiLCJ0b0VudW1TdHlsZSIsInMiLCJzdWJzdHIiLCJ0b1VwcGVyQ2FzZSIsInN0cmluZ2lmeUVudW1WYWx1ZXMiLCJnZXREb2NNRCIsInNjaGVtYSIsIm1kIiwicGFyc2VEYlNjaGVtYSIsInNjaGVtYURlZiIsImRiVHlwZXMiLCJlbnVtVHlwZXMiLCJNYXAiLCJwYXJzZURiRmllbGQiLCJ0eXBlTmFtZSIsInNjaGVtYUZpZWxkIiwic2NoZW1hVHlwZSIsImZpZWxkIiwiYXJyYXlEZXB0aCIsImFycmF5IiwiZXgiLCJlbnVtRGVmIiwic2V0IiwiYm9vbCIsIkVycm9yIiwiY29uc29sZSIsImxvZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJwcm9jZXNzIiwiZXhpdCIsInVud3JhcEFycmF5cyIsInBhcnNlRGJUeXBlIiwiY29sbGVjdGlvbiIsInB1c2giLCJmb3JFYWNoIiwidW53cmFwcGVkIiwib3duVHlwZSIsImNsYXNzIiwidHlwZXMiLCJyZXNvbHZpbmciLCJTZXQiLCJyZXNvbHZlZCIsIm9yZGVyZWRSZXNvbHZlZCIsInQiLCJyZXNvbHZlVHlwZSIsImhhcyIsImFkZCIsImdldCIsImRlbGV0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFTQSxNQUFNO0FBQUVBLEVBQUFBLEdBQUY7QUFBT0MsRUFBQUE7QUFBUCxJQUFtQkMsV0FBekI7QUFFQSxNQUFNQyxpQkFBaUIsR0FBRztBQUN0QkMsRUFBQUEsd0JBQXdCLEVBQUUsMEJBREo7QUFFdEJDLEVBQUFBLG1CQUFtQixFQUFFO0FBRkMsQ0FBMUI7O0FBUU8sTUFBTUMsSUFBSSxHQUFHLENBQ2hCQyxNQURnQixFQUVoQkMsRUFGZ0IsRUFHaEJDLEtBSGdCLEVBSWhCQyxZQUpnQixLQUtOO0FBQ1YsU0FBTyxFQUNILEdBQUdWLEdBQUcsQ0FBQ08sTUFBRCxDQURIO0FBRUhJLElBQUFBLENBQUMsRUFBRTtBQUNDTCxNQUFBQSxJQUFJLEVBQUU7QUFDRkUsUUFBQUEsRUFERTtBQUVGQyxRQUFBQSxLQUZFO0FBR0ZDLFFBQUFBLFlBQVksRUFBR0EsWUFBWSxJQUFJO0FBSDdCO0FBRFA7QUFGQSxHQUFQO0FBVUgsQ0FoQk07Ozs7QUFrQkEsTUFBTUUsT0FBTyxHQUFHLENBQUNDLEdBQUQsRUFBZUMsR0FBZixNQUFpQyxFQUNwRCxHQUFHRCxHQURpRDtBQUVwRCxNQUFJQyxHQUFHLEdBQUc7QUFBRUMsSUFBQUEsSUFBSSxFQUFFRDtB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UyxDQUFDUyxNQUFWLENBQWlCbkQsSUFBSSxDQUFDM0IsSUFBdEI7QUFDQXdFLElBQUFBLGVBQWUsQ0FBQ1QsSUFBaEIsQ0FBcUJwQyxJQUFyQjtBQUNBZCxJQUFBQSxVQUFVLENBQUNpRSxNQUFYLENBQWtCbkQsSUFBSSxDQUFDM0IsSUFBdkI7QUFDQXVFLElBQUFBLFFBQVEsQ0FBQ3BCLEdBQVQsQ0FBYXhCLElBQUksQ0FBQzNCLElBQWxCLEVBQXdCMkIsSUFBeEI7QUFDSCxHQTlCRDs7QUErQkFZLEVBQUFBLE9BQU8sQ0FBQ3lCLE9BQVIsQ0FBZ0JVLFdBQWhCO0FBQ0EsU0FBTztBQUNITixJQUFBQSxLQUFLLEVBQUVJLGVBREo7QUFFSGhDLElBQUFBO0FBRkcsR0FBUDtBQUlIIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcbmltcG9ydCB7bWFrZUZpZWxkVHlwZU5hbWV9IGZyb20gXCIuLi8uLi9tYWludGFuYW5jZS9nZW4tZ3JhcGhxbC9nZW4uanNcIjtcbmltcG9ydCB7RGVmLCBwYXJzZVR5cGVEZWZ9IGZyb20gXCIuL3NjaGVtYS5qc1wiO1xuaW1wb3J0IHR5cGUge1xuICAgIEludFNpemVUeXBlLFxuICAgIFNjaGVtYURvYyxcbiAgICBTY2hlbWFNZW1iZXIsXG4gICAgU2NoZW1hVHlwZSxcbiAgICBUeXBlRGVmXG59IGZyb20gXCIuL3NjaGVtYS5qc1wiO1xuXG5jb25zdCB7IHJlZiwgYXJyYXlPZiB9ID0gRGVmO1xuXG5jb25zdCBUb1N0cmluZ0Zvcm1hdHRlciA9IHtcbiAgICB1bml4TWlsbGlzZWNvbmRzVG9TdHJpbmc6ICd1bml4TWlsbGlzZWNvbmRzVG9TdHJpbmcnLFxuICAgIHVuaXhTZWNvbmRzVG9TdHJpbmc6ICd1bml4U2Vjb25kc1RvU3RyaW5nJyxcblxufVxuXG5leHBvcnQgdHlwZSBUb1N0cmluZ0Zvcm1hdHRlclR5cGUgPSAkVmFsdWVzPHR5cGVvZiBUb1N0cmluZ0Zvcm1hdHRlcj47XG5cbmV4cG9ydCBjb25zdCBqb2luID0gKFxuICAgIHJlZkRlZjogKHN0cmluZyB8IHsgW3N0cmluZ106IFR5cGVEZWYgfSksXG4gICAgb246IHN0cmluZyxcbiAgICByZWZPbjogc3RyaW5nLFxuICAgIHByZUNvbmRpdGlvbj86IHN0cmluZyxcbik6IFR5cGVEZWYgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICAgIC4uLnJlZihyZWZEZWYpLFxuICAgICAgICBfOiB7XG4gICAgICAgICAgICBqb2luOiB7XG4gICAgICAgICAgICAgICAgb24sXG4gICAgICAgICAgICAgICAgcmVmT24sXG4gICAgICAgICAgICAgICAgcHJlQ29uZGl0aW9uOiAocHJlQ29uZGl0aW9uIHx8ICcnKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgfVxufTtcblxuZXhwb3J0IGNvbnN0IHdpdGhEb2MgPSAoZGVmOiBUeXBlRGVmLCBkb2M/OiBzdHJpbmcpID0+ICh7XG4gICAgLi4uZGVmLFxuICAgIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pLFxufSk7XG5cbmV4cG9ydCBjb25zdCByZXF1aXJlZCA9IChkZWY6IFR5cGVEZWYpID0+IGRlZjtcblxuY29uc3QgdWludCA9IChzaXplOiBJbnRTaXplVHlwZSwgZG9jPzogc3RyaW5nKSA9PiB3aXRoRG9jKHtcbiAgICBfaW50OiB7XG4gICAgICAgIHVuc2lnbmVkOiB0cnVlLFxuICAgICAgICBzaXplLFxuICAgIH0sXG59LCBkb2MpO1xuXG5jb25zdCBpbnQgPSAoc2l6ZTogSW50U2l6ZVR5cGUsIGRvYz86IHN0cmluZykgPT4gd2l0aERvYyh7XG4gICAgX2ludDoge1xuICAgICAgICB1bnNpZ25lZDogZmFsc2UsXG4gICAgICAgIHNpemUsXG4gICAgfSxcbn0sIGRvYyk7XG5cbmV4cG9ydCBjb25zdCBpOCA9IChkb2M/OiBzdHJpbmcpID0+IGludCg4LCBkb2MpO1xuZXhwb3J0IGNvbnN0IGkzMiA9IChkb2M/OiBzdHJpbmcpID0+IGludCgzMiwgZG9jKTtcbmV4cG9ydCBjb25zdCB1OCA9IChkb2M/OiBzdHJpbmcpID0+IHVpbnQoOCwgZG9jKTtcbmV4cG9ydCBjb25zdCB1MTYgPSAoZG9jPzogc3RyaW5nKSA9PiB1aW50KDE2LCBkb2MpO1xuZXhwb3J0IGNvbnN0IHUzMiA9IChkb2M/OiBzdHJpbmcpID0+IHVpbnQoMzIsIGRvYyk7XG5leHBvcnQgY29uc3QgdTY0ID0gKGRvYz86IHN0cmluZykgPT4gdWludCg2NCwgZG9jKTtcbmV4cG9ydCBjb25zdCB1MTI4ID0gKGRvYz86IHN0cmluZykgPT4gdWludCgxMjgsIGRvYyk7XG5jb25zdCB1MjU2ID0gKGRvYz86IHN0cmluZykgPT4gdWludCgyNTYsIGRvYyk7XG5cbmV4cG9ydCBjb25zdCB1MzJXaXRoRm9ybWF0dGVyID0gKGZvcm1hdHRlcjogVG9TdHJpbmdGb3JtYXR0ZXJUeXBlLCBkb2M/OiBzdHJpbmcpID0+IHdpdGhEb2Moe1xuICAgIF9pbnQ6IHtcbiAgICAgICAgdW5zaWduZWQ6IHRydWUsXG4gICAgICAgIHNpemU6IDMyLFxuICAgIH0sXG4gICAgXzoge1xuICAgICAgICBmb3JtYXR0ZXIsXG4gICAgfSxcbn0sIGRvYyk7XG5cbmV4cG9ydCBjb25zdCB1bml4U2Vjb25kcyA9IChkb2M/OiBzdHJpbmcpID0+IHUzMldpdGhGb3JtYXR0ZXIoVG9TdHJpbmdGb3JtYXR0ZXIudW5peFNlY29uZHNUb1N0cmluZywgZG9jKTtcblxuZXhwb3J0IGNvbnN0IGdyYW1zID0gdTEyODtcblxudHlwZSBJbnRFbnVtVmFsdWVzID0ge1xuICAgIFtzdHJpbmddOiBudW1iZXJcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiB1OGVudW0obmFtZTogc3RyaW5nLCB2YWx1ZXM6IEludEVudW1WYWx1ZXMpIHtcbiAgICByZXR1cm4gKGRvYz86IHN0cmluZyk6IFR5cGVEZWYgPT4ge1xuICAgICAgICBjb25zdCB2YWx1ZXNEb2MgPSBPYmplY3QuZW50cmllcyh2YWx1ZXMpLm1hcCgoW25hbWUsIHZhbHVlXSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGAtICR7KHZhbHVlOiBhbnkpfSDigJMgJHtuYW1lfWA7XG4gICAgICAgIH0pLmpvaW4oJ1xcbicpO1xuICAgICAgICBjb25zdCBlZmZlY3RpdmVEb2MgPSBgJHtkb2MgPyBgJHtkb2N9XFxuYCA6ICcnfSR7dmFsdWVzRG9jfWA7XG4gICAgICAgIHJldHVybiB3aXRoRG9jKHtcbiAgICAgICAgICAgIF9pbnQ6IHtcbiAgICAgICAgICAgICAgICB1bnNpZ25lZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzaXplOiA4LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF86IHtcbiAgICAgICAgICAgICAgICBlbnVtOiB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlcyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSwgZWZmZWN0aXZlRG9jKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjb25zdCBPdGhlckN1cnJlbmN5OiBUeXBlRGVmID0ge1xuICAgIGN1cnJlbmN5OiB1MzIoKSxcbiAgICB2YWx1ZTogdTI1NigpLFxufTtcblxuZXhwb3J0IGNvbnN0IG90aGVyQ3VycmVuY3lDb2xsZWN0aW9uID0gKGRvYz86IHN0cmluZyk6IFR5cGVEZWYgPT4gYXJyYXlPZihyZWYoeyBPdGhlckN1cnJlbmN5IH0pLCBkb2MpO1xuZXhwb3J0IGNvbnN0IERiVHlwZUNhdGVnb3J5ID0ge1xuICAgIHVucmVzb2x2ZWQ6ICd1bnJlc29sdmVkJyxcbiAgICBzY2FsYXI6ICdzY2FsYXInLFxuICAgIHVuaW9uOiAndW5pb24nLFxuICAgIHN0cnVjdDogJ3N0cnVjdCcsXG59O1xudHlwZSBEYkpvaW4gPSB7XG4gICAgY29sbGVjdGlvbjogc3RyaW5nLFxuICAgIG9uOiBzdHJpbmcsXG4gICAgcmVmT246IHN0cmluZyxcbiAgICBwcmVDb25kaXRpb246IHN0cmluZyxcbn1cbmV4cG9ydCB0eXBlIERiVHlwZSA9IHtcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgZmllbGRzOiBEYkZpZWxkW10sXG4gICAgY2F0ZWdvcnk6ICd1bnJlc29sdmVkJyB8ICdzY2FsYXInIHwgJ3VuaW9uJyB8ICdzdHJ1Y3QnLFxuICAgIGNvbGxlY3Rpb24/OiBzdHJpbmcsXG4gICAgZG9jOiBzdHJpbmcsXG59XG5leHBvcnQgdHlwZSBJbnRFbnVtRGVmID0ge1xuICAgIG5hbWU6IHN0cmluZyxcbiAgICB2YWx1ZXM6IHtcbiAgICAgICAgW3N0cmluZ106IG51bWJlclxuICAgIH0sXG59XG5leHBvcnQgdHlwZSBEYkZpZWxkID0ge1xuICAgIG5hbWU6IHN0cmluZyxcbiAgICB0eXBlOiBEYlR5cGUsXG4gICAgYXJyYXlEZXB0aDogbnVtYmVyLFxuICAgIGpvaW4/OiBEYkpvaW4sXG4gICAgZW51bURlZj86IEludEVudW1EZWYsXG4gICAgZm9ybWF0dGVyPzogVG9TdHJpbmdGb3JtYXR0ZXJUeXBlLFxuICAgIGRvYzogc3RyaW5nLFxufVxuXG5mdW5jdGlvbiBzY2FsYXJUeXBlKG5hbWU6IHN0cmluZyk6IERiVHlwZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgbmFtZSxcbiAgICAgICAgY2F0ZWdvcnk6IERiVHlwZUNhdGVnb3J5LnNjYWxhcixcbiAgICAgICAgZmllbGRzOiBbXSxcbiAgICAgICAgZG9jOiAnJyxcbiAgICB9XG59XG5cbmV4cG9ydCBjb25zdCBzY2FsYXJUeXBlcyA9IHtcbiAgICBpbnQ6IHNjYWxhclR5cGUoJ0ludCcpLFxuICAgIHVpbnQ2NDogc2NhbGFyVHlwZSgnU3RyaW5nJyksXG4gICAgdWludDEwMjQ6IHNjYWxhclR5cGUoJ1N0cmluZycpLFxuICAgIGZsb2F0OiBzY2FsYXJUeXBlKCdGbG9hdCcpLFxuICAgIGJvb2xlYW46IHNjYWxhclR5cGUoJ0Jvb2xlYW4nKSxcbiAgICBzdHJpbmc6IHNjYWxhclR5cGUoJ1N0cmluZycpLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGlzQmlnSW50KHR5cGU6IERiVHlwZSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0eXBlID09PSBzY2FsYXJUeXBlcy51aW50MTAyNCB8fCB0eXBlID09PSBzY2FsYXJUeXBlcy51aW50NjQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1bnJlc29sdmVkVHlwZShuYW1lOiBzdHJpbmcpOiBEYlR5cGUge1xuICAgIHJldHVybiB7XG4gICAgICAgIG5hbWUsXG4gICAgICAgIGNhdGVnb3J5OiBEYlR5cGVDYXRlZ29yeS51bnJlc29sdmVkLFxuICAgICAgICBmaWVsZHM6IFtdLFxuICAgICAgICBkb2M6ICcnLFxuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRvRW51bVN0eWxlKHM6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGAke3Muc3Vic3RyKDAsIDEpLnRvVXBwZXJDYXNlKCl9JHtzLnN1YnN0cigxKX1gO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3RyaW5naWZ5RW51bVZhbHVlcyh2YWx1ZXM6IHsgW3N0cmluZ106IG51bWJlciB9KTogc3RyaW5nIHtcbiAgICBjb25zdCBmaWVsZHMgPSBPYmplY3QuZW50cmllcyh2YWx1ZXMpLm1hcCgoW25hbWUsIHZhbHVlXSkgPT4ge1xuICAgICAgICByZXR1cm4gYCR7dG9FbnVtU3R5bGUobmFtZSl9OiAkeyh2YWx1ZTogYW55KX1gO1xuICAgIH0pO1xuICAgIHJldHVybiBgeyAke2ZpZWxkcy5qb2luKCcsICcpfSB9YDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldERvY01EKHNjaGVtYTogU2NoZW1hRG9jKTogc3RyaW5nIHtcbiAgICBjb25zdCBkb2MgPSBzY2hlbWEuZG9jO1xuICAgIGlmICghZG9jKSB7XG4gICAgICAgIHJldHVybiAnJztcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBkb2MgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHJldHVybiBkb2M7XG4gICAgfVxuICAgIGlmIChkb2MubWQpIHtcbiAgICAgICAgcmV0dXJuIChkb2MubWQ6IGFueSk7XG4gICAgfVxuICAgIHJldHVybiAnJztcbn1cblxuZXhwb3J0IHR5cGUgRGJTY2hlbWEgPSB7XG4gICAgdHlwZXM6IERiVHlwZVtdLFxuICAgIGVudW1UeXBlczogTWFwPHN0cmluZywgSW50RW51bURlZj4sXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZURiU2NoZW1hKHNjaGVtYURlZjogVHlwZURlZik6IERiU2NoZW1hIHtcbiAgICBjb25zdCBkYlR5cGVzOiBEYlR5cGVbXSA9IFtdO1xuICAgIGNvbnN0IGVudW1UeXBlczogTWFwPHN0cmluZywgSW50RW51bURlZj4gPSBuZXcgTWFwKCk7XG5cbiAgICBmdW5jdGlvbiBwYXJzZURiRmllbGQoXG4gICAgICAgIHR5cGVOYW1lOiBzdHJpbmcsXG4gICAgICAgIHNjaGVtYUZpZWxkOiBTY2hlbWFNZW1iZXI8U2NoZW1hVHlwZT4sXG4gICAgKTogRGJGaWVsZCB7XG4gICAgICAgIGxldCBzY2hlbWFUeXBlID0gc2NoZW1hRmllbGQ7XG4gICAgICAgIGNvbnN0IGZpZWxkOiBEYkZpZWxkID0ge1xuICAgICAgICAgICAgbmFtZTogc2NoZW1hRmllbGQubmFtZSxcbiAgICAgICAgICAgIGFycmF5RGVwdGg6IDAsXG4gICAgICAgICAgICB0eXBlOiBzY2FsYXJUeXBlcy5zdHJpbmcsXG4gICAgICAgICAgICBkb2M6IGdldERvY01EKHNjaGVtYUZpZWxkKSxcbiAgICAgICAgfTtcbiAgICAgICAgd2hpbGUgKHNjaGVtYVR5cGUuYXJyYXkpIHtcbiAgICAgICAgICAgIGZpZWxkLmFycmF5RGVwdGggKz0gMTtcbiAgICAgICAgICAgIHNjaGVtYVR5cGUgPSBzY2hlbWFUeXBlLmFycmF5O1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGV4ID0gKHNjaGVtYVR5cGU6IGFueSkuXztcbiAgICAgICAgY29uc3QgZW51bURlZjogP0ludEVudW1EZWYgPSAoZXggJiYgZXguZW51bSkgfHwgbnVsbDtcbiAgICAgICAgaWYgKGVudW1EZWYpIHtcbiAgICAgICAgICAgIGZpZWxkLmVudW1EZWYgPSBlbnVtRGVmO1xuICAgICAgICAgICAgZW51bVR5cGVzLnNldChlbnVtRGVmLm5hbWUsIGVudW1EZWYpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGpvaW4gPSBleCAmJiBleC5qb2luO1xuICAgICAgICBpZiAoam9pbikge1xuICAgICAgICAgICAgZmllbGQuam9pbiA9IGpvaW47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGV4ICYmIGV4LmZvcm1hdHRlcikge1xuICAgICAgICAgICAgZmllbGQuZm9ybWF0dGVyID0gZXguZm9ybWF0dGVyO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzY2hlbWFUeXBlLnVuaW9uIHx8IHNjaGVtYVR5cGUuc3RydWN0KSB7XG4gICAgICAgICAgICBmaWVsZC50eXBlID0gdW5yZXNvbHZlZFR5cGUobWFrZUZpZWxkVHlwZU5hbWUodHlwZU5hbWUsIHNjaGVtYUZpZWxkLm5hbWUpKTtcbiAgICAgICAgfSBlbHNlIGlmIChzY2hlbWFUeXBlLnJlZikge1xuICAgICAgICAgICAgZmllbGQudHlwZSA9IHVucmVzb2x2ZWRUeXBlKHNjaGVtYVR5cGUucmVmLm5hbWUpO1xuICAgICAgICB9IGVsc2UgaWYgKHNjaGVtYVR5cGUuYm9vbCkge1xuICAgICAgICAgICAgZmllbGQudHlwZSA9IHNjYWxhclR5cGVzLmJvb2xlYW47XG4gICAgICAgIH0gZWxzZSBpZiAoc2NoZW1hVHlwZS5pbnQpIHtcbiAgICAgICAgICAgIGNvbnN0IHVuc2lnbmVkOiBib29sZWFuID0gKHNjaGVtYVR5cGUuaW50ICYmIHNjaGVtYVR5cGUuaW50LnVuc2lnbmVkKSB8fCBmYWxzZTtcbiAgICAgICAgICAgIGNvbnN0IHNpemU6IG51bWJlciA9IChzY2hlbWFUeXBlLmludCAmJiBzY2hlbWFUeXBlLmludC5zaXplKSB8fCAzMjtcbiAgICAgICAgICAgIGlmICh1bnNpZ25lZCkge1xuICAgICAgICAgICAgICAgIGlmIChzaXplID49IDEyOCkge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZC50eXBlID0gc2NhbGFyVHlwZXMudWludDEwMjQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzaXplID49IDY0KSB7XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkLnR5cGUgPSBzY2FsYXJUeXBlcy51aW50NjQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzaXplID49IDMyKSB7XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkLnR5cGUgPSBzY2FsYXJUeXBlcy5mbG9hdDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZC50eXBlID0gc2NhbGFyVHlwZXMuaW50O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHNpemUgPiAzMikge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludGVnZXIgdHlwZSB3aXRoIHNpemUgJHtzaXplfSBiaXQgZG9lcyBub3Qgc3VwcG9ydGVkYCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGQudHlwZSA9IHNjYWxhclR5cGVzLmludDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoc2NoZW1hVHlwZS5mbG9hdCkge1xuICAgICAgICAgICAgZmllbGQudHlwZSA9IHNjYWxhclR5cGVzLmZsb2F0O1xuICAgICAgICB9IGVsc2UgaWYgKHNjaGVtYVR5cGUuc3RyaW5nKSB7XG4gICAgICAgICAgICBmaWVsZC50eXBlID0gc2NhbGFyVHlwZXMuc3RyaW5nO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZmllbGQudHlwZSA9IHNjYWxhclR5cGVzLnN0cmluZztcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdJbnZhbGlkIGZpZWxkIHR5cGU6ICcsIEpTT04uc3RyaW5naWZ5KHNjaGVtYVR5cGUpKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmllbGQ7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gdW53cmFwQXJyYXlzKHR5cGU6IFNjaGVtYVR5cGUpOiBTY2hlbWFUeXBlIHtcbiAgICAgICAgaWYgKHR5cGUuYXJyYXkpIHtcbiAgICAgICAgICAgIHJldHVybiB1bndyYXBBcnJheXModHlwZS5hcnJheSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHR5cGU7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gcGFyc2VEYlR5cGUoXG4gICAgICAgIG5hbWU6IHN0cmluZyxcbiAgICAgICAgc2NoZW1hVHlwZTogU2NoZW1hVHlwZVxuICAgICkge1xuICAgICAgICBjb25zdCBzdHJ1Y3QgPSBzY2hlbWFUeXBlLnVuaW9uIHx8IHNjaGVtYVR5cGUuc3RydWN0O1xuICAgICAgICBpZiAoIXN0cnVjdCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYD8/ICR7bmFtZX06ICR7SlNPTi5zdHJpbmdpZnkoc2NoZW1hVHlwZSkuc3Vic3RyKDAsIDIwMCl9YCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdHlwZTogRGJUeXBlID0ge1xuICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgIGNhdGVnb3J5OiBzY2hlbWFUeXBlLnVuaW9uID8gRGJUeXBlQ2F0ZWdvcnkudW5pb24gOiBEYlR5cGVDYXRlZ29yeS5zdHJ1Y3QsXG4gICAgICAgICAgICBmaWVsZHM6IFtdLFxuICAgICAgICAgICAgY29sbGVjdGlvbjogKHNjaGVtYVR5cGU6IGFueSkuXy5jb2xsZWN0aW9uLFxuICAgICAgICAgICAgZG9jOiBnZXREb2NNRChzY2hlbWFUeXBlKSxcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAodHlwZS5jb2xsZWN0aW9uKSB7XG4gICAgICAgICAgICB0eXBlLmZpZWxkcy5wdXNoKHtcbiAgICAgICAgICAgICAgICBuYW1lOiAnaWQnLFxuICAgICAgICAgICAgICAgIGFycmF5RGVwdGg6IDAsXG4gICAgICAgICAgICAgICAgdHlwZTogc2NhbGFyVHlwZXMuc3RyaW5nLFxuICAgICAgICAgICAgICAgIGRvYzogJycsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBzdHJ1Y3QuZm9yRWFjaCgoZmllbGQpID0+IHtcbiAgICAgICAgICAgIHR5cGUuZmllbGRzLnB1c2gocGFyc2VEYkZpZWxkKG5hbWUsIGZpZWxkKSk7XG4gICAgICAgICAgICBjb25zdCB1bndyYXBwZWQgPSB1bndyYXBBcnJheXMoZmllbGQpO1xuICAgICAgICAgICAgY29uc3Qgb3duVHlwZSA9ICh1bndyYXBwZWQuc3RydWN0IHx8IHVud3JhcHBlZC51bmlvbikgPyB1bndyYXBwZWQgOiBudWxsO1xuICAgICAgICAgICAgaWYgKG93blR5cGUpIHtcbiAgICAgICAgICAgICAgICBwYXJzZURiVHlwZShtYWtlRmllbGRUeXBlTmFtZShuYW1lLCBmaWVsZC5uYW1lKSwgb3duVHlwZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBkYlR5cGVzLnB1c2godHlwZSk7XG4gICAgfVxuXG4gICAgY29uc3Qgc2NoZW1hID0gcGFyc2VUeXBlRGVmKHNjaGVtYURlZik7XG5cbiAgICBpZiAoc2NoZW1hLmNsYXNzKSB7XG4gICAgICAgIHNjaGVtYS5jbGFzcy50eXBlcy5mb3JFYWNoKCh0eXBlOiBTY2hlbWFNZW1iZXI8U2NoZW1hVHlwZT4pID0+IHtcbiAgICAgICAgICAgIHBhcnNlRGJUeXBlKHR5cGUubmFtZSwgdHlwZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgY29uc3QgdW5yZXNvbHZlZDogTWFwPHN0cmluZywgRGJUeXBlPiA9IG5ldyBNYXA8c3RyaW5nLCBEYlR5cGU+KCk7XG4gICAgY29uc3QgcmVzb2x2aW5nOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuICAgIGNvbnN0IHJlc29sdmVkOiBNYXA8c3RyaW5nLCBEYlR5cGU+ID0gbmV3IE1hcDxzdHJpbmcsIERiVHlwZT4oKTtcbiAgICBjb25zdCBvcmRlcmVkUmVzb2x2ZWQ6IERiVHlwZVtdID0gW107XG4gICAgZGJUeXBlcy5mb3JFYWNoKHQgPT4gdW5yZXNvbHZlZC5zZXQodC5uYW1lLCB0KSk7XG4gICAgY29uc3QgcmVzb2x2ZVR5cGUgPSAodHlwZTogRGJUeXBlKSA9PiB7XG4gICAgICAgIGlmIChyZXNvbHZlZC5oYXModHlwZS5uYW1lKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXNvbHZpbmcuaGFzKHR5cGUubmFtZSkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBXQVJOSU5HOiBDaXJjdWxhciByZWZlcmVuY2UgdG8gdHlwZSAke3R5cGUubmFtZX1gKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICByZXNvbHZpbmcuYWRkKHR5cGUubmFtZSk7XG4gICAgICAgIHR5cGUuZmllbGRzLmZvckVhY2goKGZpZWxkKSA9PiB7XG4gICAgICAgICAgICBpZiAoZmllbGQudHlwZS5jYXRlZ29yeSA9PT0gRGJUeXBlQ2F0ZWdvcnkudW5yZXNvbHZlZCkge1xuICAgICAgICAgICAgICAgIGxldCB0eXBlID0gcmVzb2x2ZWQuZ2V0KGZpZWxkLnR5cGUubmFtZSk7XG4gICAgICAgICAgICAgICAgaWYgKCF0eXBlKSB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGUgPSB1bnJlc29sdmVkLmdldChmaWVsZC50eXBlLm5hbWUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZVR5cGUodHlwZSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgUmVmZXJlbmNlZCB0eXBlIG5vdCBmb3VuZDogJHtmaWVsZC50eXBlLm5hbWV9YCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGQudHlwZSA9IHR5cGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmVzb2x2aW5nLmRlbGV0ZSh0eXBlLm5hbWUpO1xuICAgICAgICBvcmRlcmVkUmVzb2x2ZWQucHVzaCh0eXBlKTtcbiAgICAgICAgdW5yZXNvbHZlZC5kZWxldGUodHlwZS5uYW1lKTtcbiAgICAgICAgcmVzb2x2ZWQuc2V0KHR5cGUubmFtZSwgdHlwZSk7XG4gICAgfTtcbiAgICBkYlR5cGVzLmZvckVhY2gocmVzb2x2ZVR5cGUpO1xuICAgIHJldHVybiB7XG4gICAgICAgIHR5cGVzOiBvcmRlcmVkUmVzb2x2ZWQsXG4gICAgICAgIGVudW1UeXBlcyxcbiAgICB9XG59XG4iXX0=