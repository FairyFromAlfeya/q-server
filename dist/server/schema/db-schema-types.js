"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.u8enum = u8enum;
exports.isBigInt = isBigInt;
exports.unresolvedType = unresolvedType;
exports.toEnumStyle = toEnumStyle;
exports.stringifyEnumValues = stringifyEnumValues;
exports.getDocMD = getDocMD;
exports.parseDbSchema = parseDbSchema;
exports.scalarTypes = exports.DbTypeCategory = exports.otherCurrencyCollection = exports.OtherCurrency = exports.grams = exports.unixSeconds = exports.stringWithLowerFilter = exports.u32WithFormatter = exports.u128 = exports.u64 = exports.u32 = exports.u16 = exports.u8 = exports.i32 = exports.i8 = exports.required = exports.withDoc = exports.join = void 0;

var _gen = require("../../maintanance/gen-graphql/gen.js");

var _schema = require("./schema.js");

const {
  ref,
  arrayOf
} = _schema.Def;
const ToStringFormatter = {
  unixMillisecondsToString: 'unixMillisecondsToString',
  unixSecondsToString: 'unixSecondsToString'
};

const join = (refDef, on, refOn, preCondition) => {
  return { ...ref(refDef),
    _: {
      join: {
        on,
        refOn,
        preCondition: preCondition || ''
      }
    }
  };
};

exports.join = join;

const withDoc = (def, doc) => ({ ...def,
  ...(doc ? {
    _doc: doc
  } : {})
});

exports.withDoc = withDoc;

const required = def => def;

exports.required = required;

const uint = (size, doc) => withDoc({
  _int: {
    unsigned: true,
    size
  }
}, doc);

const int = (size, doc) => withDoc({
  _int: {
    unsigned: false,
    size
  }
}, doc);

const i8 = doc => int(8, doc);

exports.i8 = i8;

const i32 = doc => int(32, doc);

exports.i32 = i32;

const u8 = doc => uint(8, doc);

exports.u8 = u8;

const u16 = doc => uint(16, doc);

exports.u16 = u16;

const u32 = doc => uint(32, doc);

exports.u32 = u32;

const u64 = doc => uint(64, doc);

exports.u64 = u64;

const u128 = doc => uint(128, doc);

exports.u128 = u128;

const u256 = doc => uint(256, doc);

const u32WithFormatter = (formatter, doc) => withDoc({
  _int: {
    unsigned: true,
    size: 32
  },
  _: {
    formatter
  }
}, doc);

exports.u32WithFormatter = u32WithFormatter;

const stringWithLowerFilter = doc => withDoc({
  _string: {},
  _: {
    lowerFilter: true
  }
}, doc);

exports.stringWithLowerFilter = stringWithLowerFilter;

const unixSeconds = doc => u32WithFormatter(ToStringFormatter.unixSecondsToString, doc);

exports.unixSeconds = unixSeconds;
const grams = u128;
exports.grams = grams;

function u8enum(name, values) {
  return doc => {
    const valuesDoc = Object.entries(values).map(([name, value]) => {
      return `- ${value} â€“ ${name}`;
    }).join('\n');
    const effectiveDoc = `${doc ? `${doc}\n` : ''}${valuesDoc}`;
    return withDoc({
      _int: {
        unsigned: true,
        size: 8
      },
      _: {
        enum: {
          name,
          values
        }
      }
    }, effectiveDoc);
  };
}

const OtherCurrency = {
  currency: u32(),
  value: u256()
};
exports.OtherCurrency = OtherCurrency;

const otherCurrencyCollection = doc => arrayOf(ref({
  OtherCurrency
}), doc);

exports.otherCurrencyCollection = otherCurrencyCollection;
const DbTypeCategory = {
  unresolved: 'unresolved',
  scalar: 'scalar',
  union: 'union',
  struct: 'struct'
};
exports.DbTypeCategory = DbTypeCategory;

function scalarType(name) {
  return {
    name,
    category: DbTypeCategory.scalar,
    fields: [],
    doc: ''
  };
}

const scalarTypes = {
  int: scalarType('Int'),
  uint64: scalarType('String'),
  uint1024: scalarType('String'),
  float: scalarType('Float'),
  boolean: scalarType('Boolean'),
  string: scalarType('String')
};
exports.scalarTypes = scalarTypes;

function isBigInt(type) {
  return type === scalarTypes.uint1024 || type === scalarTypes.uint64;
}

function unresolvedType(name) {
  return {
    name,
    category: DbTypeCategory.unresolved,
    fields: [],
    doc: ''
  };
}

function toEnumStyle(s) {
  return `${s.substr(0, 1).toUpperCase()}${s.substr(1)}`;
}

function stringifyEnumValues(values) {
  const fields = Object.entries(values).map(([name, value]) => {
    return `${toEnumStyle(name)}: ${value}`;
  });
  return `{ ${fields.join(', ')} }`;
}

function getDocMD(schema) {
  const doc = schema.doc;

  if (!doc) {
    return '';
  }

  if (typeof doc === 'string') {
    return doc;
  }

  if (doc.md) {
    return doc.md;
  }

  return '';
}

function parseDbSchema(schemaDef) {
  const dbTypes = [];
  const enumTypes = new Map();

  function parseDbField(typeName, schemaField) {
    let schemaType = schemaField;
    const field = {
      name: schemaField.name,
      arrayDepth: 0,
      type: scalarTypes.string,
      doc: getDocMD(schemaField)
    };

    while (schemaType.array) {
      field.arrayDepth += 1;
      schemaType = schemaType.array;
    }

    const ex = schemaType._;
    const enumDef = ex && ex.enum || null;

    if (enumDef) {
      field.enumDef = enumDef;
      enumTypes.set(enumDef.name, enumDef);
    }

    const join = ex && ex.join;

    if (join) {
      field.join = join;
    }

    if (ex && ex.formatter) {
      field.formatter = ex.formatter;
    }

    if (schemaType.union || schemaType.struct) {
      field.type = unresolvedType((0, _gen.makeFieldTypeName)(typeName, schemaField.name));
    } else if (schemaType.ref) {
      field.type = unresolvedType(schemaType.ref.name);
    } else if (schemaType.bool) {
      field.type = scalarTypes.boolean;
    } else if (schemaType.int) {
      const unsigned = schemaType.int && schemaType.int.unsigned || false;
      const size = schemaType.int && schemaType.int.size || 32;

      if (unsigned) {
        if (size >= 128) {
          field.type = scalarTypes.uint1024;
        } else if (size >= 64) {
          field.type = scalarTypes.uint64;
        } else if (size >= 32) {
          field.type = scalarTypes.float;
        } else {
          field.type = scalarTypes.int;
        }
      } else {
        if (size > 32) {
          throw new Error(`Integer type with size ${size} bit does not supported`);
        } else {
          field.type = scalarTypes.int;
        }
      }
    } else if (schemaType.float) {
      field.type = scalarTypes.float;
    } else if (schemaType.string) {
      field.type = scalarTypes.string;

      if (ex && ex.lowerFilter) {
        field.lowerFilter = true;
      }
    } else {
      field.type = scalarTypes.string;
      console.log('Invalid field type: ', JSON.stringify(schemaType));
      process.exit(1);
    }

    return field;
  }

  function unwrapArrays(type) {
    if (type.array) {
      return unwrapArrays(type.array);
    }

    return type;
  }

  function parseDbType(name, schemaType) {
    const struct = schemaType.union || schemaType.struct;

    if (!struct) {
      console.log(`?? ${name}: ${JSON.stringify(schemaType).substr(0, 200)}`);
      return;
    }

    const type = {
      name,
      category: schemaType.union ? DbTypeCategory.union : DbTypeCategory.struct,
      fields: [],
      collection: schemaType._.collection,
      doc: getDocMD(schemaType)
    };

    if (type.collection) {
      type.fields.push({
        name: 'id',
        arrayDepth: 0,
        type: scalarTypes.string,
        doc: ''
      });
    }

    struct.forEach(field => {
      type.fields.push(parseDbField(name, field));
      const unwrapped = unwrapArrays(field);
      const ownType = unwrapped.struct || unwrapped.union ? unwrapped : null;

      if (ownType) {
        parseDbType((0, _gen.makeFieldTypeName)(name, field.name), ownType);
      }
    });
    dbTypes.push(type);
  }

  const schema = (0, _schema.parseTypeDef)(schemaDef);

  if (schema.class) {
    schema.class.types.forEach(type => {
      parseDbType(type.name, type);
    });
  }

  const unresolved = new Map();
  const resolving = new Set();
  const resolved = new Map();
  const orderedResolved = [];
  dbTypes.forEach(t => unresolved.set(t.name, t));

  const resolveType = type => {
    if (resolved.has(type.name)) {
      return;
    }

    if (resolving.has(type.name)) {
      console.log(`WARNING: Circular reference to type ${type.name}`);
      return;
    }

    resolving.add(type.name);
    type.fields.forEach(field => {
      if (field.type.category === DbTypeCategory.unresolved) {
        let type = resolved.get(field.type.name);

        if (!type) {
          type = unresolved.get(field.type.name);

          if (type) {
            resolveType(type);
          } else {
            console.log(`Referenced type not found: ${field.type.name}`);
            process.exit(1);
          }
        }

        if (type) {
          field.type = type;
        }
      }
    });
    resolving.delete(type.name);
    orderedResolved.push(type);
    unresolved.delete(type.name);
    resolved.set(type.name, type);
  };

  dbTypes.forEach(resolveType);
  return {
    types: orderedResolved,
    enumTypes
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvc2NoZW1hL2RiLXNjaGVtYS10eXBlcy5qcyJdLCJuYW1lcyI6WyJyZWYiLCJhcnJheU9mIiwiRGVmIiwiVG9TdHJpbmdGb3JtYXR0ZXIiLCJ1bml4TWlsbGlzZWNvbmRzVG9TdHJpbmciLCJ1bml4U2Vjb25kc1RvU3RyaW5nIiwiam9pbiIsInJlZkRlZiIsIm9uIiwicmVmT24iLCJwcmVDb25kaXRpb24iLCJfIiwid2l0aERvYyIsImRlZiIsImRvYyIsIl9kb2MiLCJyZXF1aXJlZCIsInVpbnQiLCJzaXplIiwiX2ludCIsInVuc2lnbmVkIiwiaW50IiwiaTgiLCJpMzIiLCJ1OCIsInUxNiIsInUzMiIsInU2NCIsInUxMjgiLCJ1MjU2IiwidTMyV2l0aEZvcm1hdHRlciIsImZvcm1hdHRlciIsInN0cmluZ1dpdGhMb3dlckZpbHRlciIsIl9zdHJpbmciLCJsb3dlckZpbHRlciIsInVuaXhTZWNvbmRzIiwiZ3JhbXMiLCJ1OGVudW0iLCJuYW1lIiwidmFsdWVzIiwidmFsdWVzRG9jIiwiT2JqZWN0IiwiZW50cmllcyIsIm1hcCIsInZhbHVlIiwiZWZmZWN0aXZlRG9jIiwiZW51bSIsIk90aGVyQ3VycmVuY3kiLCJjdXJyZW5jeSIsIm90aGVyQ3VycmVuY3lDb2xsZWN0aW9uIiwiRGJUeXBlQ2F0ZWdvcnkiLCJ1bnJlc29sdmVkIiwic2NhbGFyIiwidW5pb24iLCJzdHJ1Y3QiLCJzY2FsYXJUeXBlIiwiY2F0ZWdvcnkiLCJmaWVsZHMiLCJzY2FsYXJUeXBlcyIsInVpbnQ2NCIsInVpbnQxMDI0IiwiZmxvYXQiLCJib29sZWFuIiwic3RyaW5nIiwiaXNCaWdJbnQiLCJ0eXBlIiwidW5yZXNvbHZlZFR5cGUiLCJ0b0VudW1TdHlsZSIsInMiLCJzdWJzdHIiLCJ0b1VwcGVyQ2FzZSIsInN0cmluZ2lmeUVudW1WYWx1ZXMiLCJnZXREb2NNRCIsInNjaGVtYSIsIm1kIiwicGFyc2VEYlNjaGVtYSIsInNjaGVtYURlZiIsImRiVHlwZXMiLCJlbnVtVHlwZXMiLCJNYXAiLCJwYXJzZURiRmllbGQiLCJ0eXBlTmFtZSIsInNjaGVtYUZpZWxkIiwic2NoZW1hVHlwZSIsImZpZWxkIiwiYXJyYXlEZXB0aCIsImFycmF5IiwiZXgiLCJlbnVtRGVmIiwic2V0IiwiYm9vbCIsIkVycm9yIiwiY29uc29sZSIsImxvZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJwcm9jZXNzIiwiZXhpdCIsInVud3JhcEFycmF5cyIsInBhcnNlRGJUeXBlIiwiY29sbGVjdGlvbiIsInB1c2giLCJmb3JFYWNoIiwidW53cmFwcGVkIiwib3duVHlwZSIsImNsYXNzIiwidHlwZXMiLCJyZXNvbHZpbmciLCJTZXQiLCJyZXNvbHZlZCIsIm9yZGVyZWRSZXNvbHZlZCIsInQiLCJyZXNvbHZlVHlwZSIsImhhcyIsImFkZCIsImdldCIsImRlbGV0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFTQSxNQUFNO0FBQUVBLEVBQUFBLEdBQUY7QUFBT0MsRUFBQUE7QUFBUCxJQUFtQkMsV0FBekI7QUFFQSxNQUFNQyxpQkFBaUIsR0FBRztBQUN0QkMsRUFBQUEsd0JBQXdCLEVBQUUsMEJBREo7QUFFdEJDLEVBQUFBLG1CQUFtQixFQUFFO0FBRkMsQ0FBMUI7O0FBUU8sTUFBTUMsSUFBSSxHQUFHLENBQ2hCQyxNQURnQixFQUVoQkMsRUFGZ0IsRUFHaEJDLEtBSGdCLEVBSWhCQyxZQUpnQixLQUtOO0FBQ1YsU0FBTyxFQUNILEdBQUdWLEdBQUcsQ0FBQ08sTUFBRCxDQURIO0FBRUhJLElBQUFBLENBQUMsRUFBRTtBQUNDTCxNQUFBQSxJQUFJLEVBQUU7QUFDRkUsUUFBQUEsRUFERTtBQUVGQyxRQUFBQSxLQUZFO0FBR0ZDLFFBQUFBLFlBQVksRUFBR0EsWUFBWSxJQUFJO0FBSDdCO0FBRFA7QUFGQSxHQUFQO0FBVUgsQ0FoQk07Ozs7QUFrQkEsTUFBTUUsT0FBTyxHQUFHLENBQUNDLEdBQUQsRUFBZUMsR0FBZixNQUFpQyxFQUNwRCxHQUFHRCxHQURpRDtBQUVwRCxNQUFJQyxHQUFHLEdBQUc7QUFBRUMsSUFBQUEsSUFBSSxFQUFFRDtBQUFSLEdBQUgsR0FBbUIsRUFBMUI7QUFGb0QsQ0FBakMsQ0FBaEI7Ozs7QUFLQSxNQUFNRSxRQUFRLEdBQUlILEdBQUQsSUFBa0JBLEdBQW5DOzs7O0FBRVAsTUFBTUksSUFBSSxHQUFHLENBQUNDLElBQUQsRUFBb0JKLEdBQXBCLEtBQXFDRixPQUFPLENBQUM7QUFDdERPLEVBQUFBLElBQUksRUFBRTtBQUNGQyxJQUFBQSxRQUFRLEVBQUUsSUFEUjtBQUVGRixJQUFBQTtBQUZFO0FBRGdELENBQUQsRUFLdERKLEdBTHNELENBQXpEOztBQU9BLE1BQU1PLEdBQUcsR0FBRyxDQUFDSCxJQUFELEVBQW9CSixHQUFwQixLQUFxQ0YsT0FBTyxDQUFDO0FBQ3JETyxFQUFBQSxJQUFJLEVBQUU7QUFDRkMsSUFBQUEsUUFBUSxFQUFFLEtBRFI7QUFFRkYsSUFBQUE7QUFGRTtBQUQrQyxDQUFELEVBS3JESixHQUxxRCxDQUF4RDs7QUFPTyxNQUFNUSxFQUFFLEdBQUlSLEdBQUQsSUFBa0JPLEdBQUcsQ0FBQyxDQUFELEVBQUlQLEdBQUosQ0FBaEM7Ozs7QUFDQSxNQUFNUyxHQUFHLEdBQUlULEdBQUQsSUFBa0JPLEdBQUcsQ0FBQyxFQUFELEVBQUtQLEdBQUwsQ0FBakM7Ozs7QUFDQSxNQUFNVSxFQUFFLEdBQUlWLEdBQUQsSUFBa0JHLElBQUksQ0FBQyxDQUFELEVBQUlILEdBQUosQ0FBakM7Ozs7QUFDQSxNQUFNVyxHQUFHLEdBQUlYLEdBQUQsSUFBa0JHLElBQUksQ0FBQyxFQUFELEVBQUtILEdBQUwsQ0FBbEM7Ozs7QUFDQSxNQUFNWSxHQUFHLEdBQUlaLEdBQUQsSUFBa0JHLElBQUksQ0FBQyxFQUFELEVBQUtILEdBQUwsQ0FBbEM7Ozs7QUFDQSxNQUFNYSxHQUFHLEdBQUliLEdBQUQsSUFBa0JHLElBQUksQ0FBQyxFQUFELEVBQUtILEdBQUwsQ0FBbEM7Ozs7QUFDQSxNQUFNYyxJQUFJLEdBQUlkLEdBQUQsSUFBa0JHLElBQUksQ0FBQyxHQUFELEVBQU1ILEdBQU4sQ0FBbkM7Ozs7QUFDUCxNQUFNZSxJQUFJLEdBQUlmLEdBQUQsSUFBa0JHLElBQUksQ0FBQyxHQUFELEVBQU1ILEdBQU4sQ0FBbkM7O0FBRU8sTUFBTWdCLGdCQUFnQixHQUFHLENBQUNDLFNBQUQsRUFBbUNqQixHQUFuQyxLQUFvREYsT0FBTyxDQUFDO0FBQ3hGTyxFQUFBQSxJQUFJLEVBQUU7QUFDRkMsSUFBQUEsUUFBUSxFQUFFLElBRFI7QUFFRkYsSUFBQUEsSUFBSSxFQUFFO0FBRkosR0FEa0Y7QUFLeEZQLEVBQUFBLENBQUMsRUFBRTtBQUNDb0IsSUFBQUE7QUFERDtBQUxxRixDQUFELEVBUXhGakIsR0FSd0YsQ0FBcEY7Ozs7QUFVQSxNQUFNa0IscUJBQXFCLEdBQUlsQixHQUFELElBQWtCRixPQUFPLENBQUM7QUFDM0RxQixFQUFBQSxPQUFPLEVBQUUsRUFEa0Q7QUFHM0R0QixFQUFBQSxDQUFDLEVBQUU7QUFDQ3VCLElBQUFBLFdBQVcsRUFBRTtBQURkO0FBSHdELENBQUQsRUFNM0RwQixHQU4yRCxDQUF2RDs7OztBQVFBLE1BQU1xQixXQUFXLEdBQUlyQixHQUFELElBQWtCZ0IsZ0JBQWdCLENBQUMzQixpQkFBaUIsQ0FBQ0UsbUJBQW5CLEVBQXdDUyxHQUF4QyxDQUF0RDs7O0FBRUEsTUFBTXNCLEtBQUssR0FBR1IsSUFBZDs7O0FBTUEsU0FBU1MsTUFBVCxDQUFnQkMsSUFBaEIsRUFBOEJDLE1BQTlCLEVBQXFEO0FBQ3hELFNBQVF6QixHQUFELElBQTJCO0FBQzlCLFVBQU0wQixTQUFTLEdBQUdDLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlSCxNQUFmLEVBQXVCSSxHQUF2QixDQUEyQixDQUFDLENBQUNMLElBQUQsRUFBT00sS0FBUCxDQUFELEtBQW1CO0FBQzVELGFBQVEsS0FBS0EsS0FBWSxNQUFLTixJQUFLLEVBQW5DO0FBQ0gsS0FGaUIsRUFFZmhDLElBRmUsQ0FFVixJQUZVLENBQWxCO0FBR0EsVUFBTXVDLFlBQVksR0FBSSxHQUFFL0IsR0FBRyxHQUFJLEdBQUVBLEdBQUksSUFBVixHQUFnQixFQUFHLEdBQUUwQixTQUFVLEVBQTFEO0FBQ0EsV0FBTzVCLE9BQU8sQ0FBQztBQUNYTyxNQUFBQSxJQUFJLEVBQUU7QUFDRkMsUUFBQUEsUUFBUSxFQUFFLElBRFI7QUFFRkYsUUFBQUEsSUFBSSxFQUFFO0FBRkosT0FESztBQUtYUCxNQUFBQSxDQUFDLEVBQUU7QUFDQ21DLFFBQUFBLElBQUksRUFBRTtBQUNGUixVQUFBQSxJQURFO0FBRUZDLFVBQUFBO0FBRkU7QUFEUDtBQUxRLEtBQUQsRUFXWE0sWUFYVyxDQUFkO0FBWUgsR0FqQkQ7QUFrQkg7O0FBRU0sTUFBTUUsYUFBc0IsR0FBRztBQUNsQ0MsRUFBQUEsUUFBUSxFQUFFdEIsR0FBRyxFQURxQjtBQUVsQ2tCLEVBQUFBLEtBQUssRUFBRWYsSUFBSTtBQUZ1QixDQUEvQjs7O0FBS0EsTUFBTW9CLHVCQUF1QixHQUFJbkMsR0FBRCxJQUEyQmIsT0FBTyxDQUFDRCxHQUFHLENBQUM7QUFBRStDLEVBQUFBO0FBQUYsQ0FBRCxDQUFKLEVBQXlCakMsR0FBekIsQ0FBbEU7OztBQUNBLE1BQU1vQyxjQUFjLEdBQUc7QUFDMUJDLEVBQUFBLFVBQVUsRUFBRSxZQURjO0FBRTFCQyxFQUFBQSxNQUFNLEVBQUUsUUFGa0I7QUFHMUJDLEVBQUFBLEtBQUssRUFBRSxPQUhtQjtBQUkxQkMsRUFBQUEsTUFBTSxFQUFFO0FBSmtCLENBQXZCOzs7QUFvQ1AsU0FBU0MsVUFBVCxDQUFvQmpCLElBQXBCLEVBQTBDO0FBQ3RDLFNBQU87QUFDSEEsSUFBQUEsSUFERztBQUVIa0IsSUFBQUEsUUFBUSxFQUFFTixjQUFjLENBQUNFLE1BRnRCO0FBR0hLLElBQUFBLE1BQU0sRUFBRSxFQUhMO0FBSUgzQyxJQUFBQSxHQUFHLEVBQUU7QUFKRixHQUFQO0FBTUg7O0FBRU0sTUFBTTRDLFdBQVcsR0FBRztBQUN2QnJDLEVBQUFBLEdBQUcsRUFBRWtDLFVBQVUsQ0FBQyxLQUFELENBRFE7QUFFdkJJLEVBQUFBLE1BQU0sRUFBRUosVUFBVSxDQUFDLFFBQUQsQ0FGSztBQUd2QkssRUFBQUEsUUFBUSxFQUFFTCxVQUFVLENBQUMsUUFBRCxDQUhHO0FBSXZCTSxFQUFBQSxLQUFLLEVBQUVOLFVBQVUsQ0FBQyxPQUFELENBSk07QUFLdkJPLEVBQUFBLE9BQU8sRUFBRVAsVUFBVSxDQUFDLFNBQUQsQ0FMSTtBQU12QlEsRUFBQUEsTUFBTSxFQUFFUixVQUFVLENBQUMsUUFBRDtBQU5LLENBQXBCOzs7QUFTQSxTQUFTUyxRQUFULENBQWtCQyxJQUFsQixFQUF5QztBQUM1QyxTQUFPQSxJQUFJLEtBQUtQLFdBQVcsQ0FBQ0UsUUFBckIsSUFBaUNLLElBQUksS0FBS1AsV0FBVyxDQUFDQyxNQUE3RDtBQUNIOztBQUVNLFNBQVNPLGNBQVQsQ0FBd0I1QixJQUF4QixFQUE4QztBQUNqRCxTQUFPO0FBQ0hBLElBQUFBLElBREc7QUFFSGtCLElBQUFBLFFBQVEsRUFBRU4sY0FBYyxDQUFDQyxVQUZ0QjtBQUdITSxJQUFBQSxNQUFNLEVBQUUsRUFITDtBQUlIM0MsSUFBQUEsR0FBRyxFQUFFO0FBSkYsR0FBUDtBQU1IOztBQUVNLFNBQVNxRCxXQUFULENBQXFCQyxDQUFyQixFQUF3QztBQUMzQyxTQUFRLEdBQUVBLENBQUMsQ0FBQ0MsTUFBRixDQUFTLENBQVQsRUFBWSxDQUFaLEVBQWVDLFdBQWYsRUFBNkIsR0FBRUYsQ0FBQyxDQUFDQyxNQUFGLENBQVMsQ0FBVCxDQUFZLEVBQXJEO0FBQ0g7O0FBRU0sU0FBU0UsbUJBQVQsQ0FBNkJoQyxNQUE3QixFQUFtRTtBQUN0RSxRQUFNa0IsTUFBTSxHQUFHaEIsTUFBTSxDQUFDQyxPQUFQLENBQWVILE1BQWYsRUFBdUJJLEdBQXZCLENBQTJCLENBQUMsQ0FBQ0wsSUFBRCxFQUFPTSxLQUFQLENBQUQsS0FBbUI7QUFDekQsV0FBUSxHQUFFdUIsV0FBVyxDQUFDN0IsSUFBRCxDQUFPLEtBQUtNLEtBQVksRUFBN0M7QUFDSCxHQUZjLENBQWY7QUFHQSxTQUFRLEtBQUlhLE1BQU0sQ0FBQ25ELElBQVAsQ0FBWSxJQUFaLENBQWtCLElBQTlCO0FBQ0g7O0FBRU0sU0FBU2tFLFFBQVQsQ0FBa0JDLE1BQWxCLEVBQTZDO0FBQ2hELFFBQU0zRCxHQUFHLEdBQUcyRCxNQUFNLENBQUMzRCxHQUFuQjs7QUFDQSxNQUFJLENBQUNBLEdBQUwsRUFBVTtBQUNOLFdBQU8sRUFBUDtBQUNIOztBQUNELE1BQUksT0FBT0EsR0FBUCxLQUFlLFFBQW5CLEVBQTZCO0FBQ3pCLFdBQU9BLEdBQVA7QUFDSDs7QUFDRCxNQUFJQSxHQUFHLENBQUM0RCxFQUFSLEVBQVk7QUFDUixXQUFRNUQsR0FBRyxDQUFDNEQsRUFBWjtBQUNIOztBQUNELFNBQU8sRUFBUDtBQUNIOztBQU9NLFNBQVNDLGFBQVQsQ0FBdUJDLFNBQXZCLEVBQXFEO0FBQ3hELFFBQU1DLE9BQWlCLEdBQUcsRUFBMUI7QUFDQSxRQUFNQyxTQUFrQyxHQUFHLElBQUlDLEdBQUosRUFBM0M7O0FBRUEsV0FBU0MsWUFBVCxDQUNJQyxRQURKLEVBRUlDLFdBRkosRUFHVztBQUNQLFFBQUlDLFVBQVUsR0FBR0QsV0FBakI7QUFDQSxVQUFNRSxLQUFjLEdBQUc7QUFDbkI5QyxNQUFBQSxJQUFJLEVBQUU0QyxXQUFXLENBQUM1QyxJQURDO0FBRW5CK0MsTUFBQUEsVUFBVSxFQUFFLENBRk87QUFHbkJwQixNQUFBQSxJQUFJLEVBQUVQLFdBQVcsQ0FBQ0ssTUFIQztBQUluQmpELE1BQUFBLEdBQUcsRUFBRTBELFFBQVEsQ0FBQ1UsV0FBRDtBQUpNLEtBQXZCOztBQU1BLFdBQU9DLFVBQVUsQ0FBQ0csS0FBbEIsRUFBeUI7QUFDckJGLE1BQUFBLEtBQUssQ0FBQ0MsVUFBTixJQUFvQixDQUFwQjtBQUNBRixNQUFBQSxVQUFVLEdBQUdBLFVBQVUsQ0FBQ0csS0FBeEI7QUFDSDs7QUFDRCxVQUFNQyxFQUFFLEdBQUlKLFVBQUQsQ0FBa0J4RSxDQUE3QjtBQUNBLFVBQU02RSxPQUFvQixHQUFJRCxFQUFFLElBQUlBLEVBQUUsQ0FBQ3pDLElBQVYsSUFBbUIsSUFBaEQ7O0FBQ0EsUUFBSTBDLE9BQUosRUFBYTtBQUNUSixNQUFBQSxLQUFLLENBQUNJLE9BQU4sR0FBZ0JBLE9BQWhCO0FBQ0FWLE1BQUFBLFNBQVMsQ0FBQ1csR0FBVixDQUFjRCxPQUFPLENBQUNsRCxJQUF0QixFQUE0QmtELE9BQTVCO0FBQ0g7O0FBQ0QsVUFBTWxGLElBQUksR0FBR2lGLEVBQUUsSUFBSUEsRUFBRSxDQUFDakYsSUFBdEI7O0FBQ0EsUUFBSUEsSUFBSixFQUFVO0FBQ044RSxNQUFBQSxLQUFLLENBQUM5RSxJQUFOLEdBQWFBLElBQWI7QUFDSDs7QUFDRCxRQUFJaUYsRUFBRSxJQUFJQSxFQUFFLENBQUN4RCxTQUFiLEVBQXdCO0FBQ3BCcUQsTUFBQUEsS0FBSyxDQUFDckQsU0FBTixHQUFrQndELEVBQUUsQ0FBQ3hELFNBQXJCO0FBQ0g7O0FBQ0QsUUFBSW9ELFVBQVUsQ0FBQzlCLEtBQVgsSUFBb0I4QixVQUFVLENBQUM3QixNQUFuQyxFQUEyQztBQUN2QzhCLE1BQUFBLEtBQUssQ0FBQ25CLElBQU4sR0FBYUMsY0FBYyxDQUFDLDRCQUFrQmUsUUFBbEIsRUFBNEJDLFdBQVcsQ0FBQzVDLElBQXhDLENBQUQsQ0FBM0I7QUFDSCxLQUZELE1BRU8sSUFBSTZDLFVBQVUsQ0FBQ25GLEdBQWYsRUFBb0I7QUFDdkJvRixNQUFBQSxLQUFLLENBQUNuQixJQUFOLEdBQWFDLGNBQWMsQ0FBQ2lCLFVBQVUsQ0FBQ25GLEdBQVgsQ0FBZXNDLElBQWhCLENBQTNCO0FBQ0gsS0FGTSxNQUVBLElBQUk2QyxVQUFVLENBQUNPLElBQWYsRUFBcUI7QUFDeEJOLE1BQUFBLEtBQUssQ0FBQ25CLElBQU4sR0FBYVAsV0FBVyxDQUFDSSxPQUF6QjtBQUNILEtBRk0sTUFFQSxJQUFJcUIsVUFBVSxDQUFDOUQsR0FBZixFQUFvQjtBQUN2QixZQUFNRCxRQUFpQixHQUFJK0QsVUFBVSxDQUFDOUQsR0FBWCxJQUFrQjhELFVBQVUsQ0FBQzlELEdBQVgsQ0FBZUQsUUFBbEMsSUFBK0MsS0FBekU7QUFDQSxZQUFNRixJQUFZLEdBQUlpRSxVQUFVLENBQUM5RCxHQUFYLElBQWtCOEQsVUFBVSxDQUFDOUQsR0FBWCxDQUFlSCxJQUFsQyxJQUEyQyxFQUFoRTs7QUFDQSxVQUFJRSxRQUFKLEVBQWM7QUFDVixZQUFJRixJQUFJLElBQUksR0FBWixFQUFpQjtBQUNia0UsVUFBQUEsS0FBSyxDQUFDbkIsSUFBTixHQUFhUCxXQUFXLENBQUNFLFFBQXpCO0FBQ0gsU0FGRCxNQUVPLElBQUkxQyxJQUFJLElBQUksRUFBWixFQUFnQjtBQUNuQmtFLFVBQUFBLEtBQUssQ0FBQ25CLElBQU4sR0FBYVAsV0FBVyxDQUFDQyxNQUF6QjtBQUNILFNBRk0sTUFFQSxJQUFJekMsSUFBSSxJQUFJLEVBQVosRUFBZ0I7QUFDbkJrRSxVQUFBQSxLQUFLLENBQUNuQixJQUFOLEdBQWFQLFdBQVcsQ0FBQ0csS0FBekI7QUFDSCxTQUZNLE1BRUE7QUFDSHVCLFVBQUFBLEtBQUssQ0FBQ25CLElBQU4sR0FBYVAsV0FBVyxDQUFDckMsR0FBekI7QUFDSDtBQUNKLE9BVkQsTUFVTztBQUNILFlBQUlILElBQUksR0FBRyxFQUFYLEVBQWU7QUFDWCxnQkFBTSxJQUFJeUUsS0FBSixDQUFXLDBCQUF5QnpFLElBQUsseUJBQXpDLENBQU47QUFDSCxTQUZELE1BRU87QUFDSGtFLFVBQUFBLEtBQUssQ0FBQ25CLElBQU4sR0FBYVAsV0FBVyxDQUFDckMsR0FBekI7QUFDSDtBQUNKO0FBQ0osS0FwQk0sTUFvQkEsSUFBSThELFVBQVUsQ0FBQ3RCLEtBQWYsRUFBc0I7QUFDekJ1QixNQUFBQSxLQUFLLENBQUNuQixJQUFOLEdBQWFQLFdBQVcsQ0FBQ0csS0FBekI7QUFDSCxLQUZNLE1BRUEsSUFBSXNCLFVBQVUsQ0FBQ3BCLE1BQWYsRUFBdUI7QUFDMUJxQixNQUFBQSxLQUFLLENBQUNuQixJQUFOLEdBQWFQLFdBQVcsQ0FBQ0ssTUFBekI7O0FBQ0EsVUFBSXdCLEVBQUUsSUFBSUEsRUFBRSxDQUFDckQsV0FBYixFQUEwQjtBQUN0QmtELFFBQUFBLEtBQUssQ0FBQ2xELFdBQU4sR0FBb0IsSUFBcEI7QUFDSDtBQUNKLEtBTE0sTUFLQTtBQUNIa0QsTUFBQUEsS0FBSyxDQUFDbkIsSUFBTixHQUFhUCxXQUFXLENBQUNLLE1BQXpCO0FBQ0E2QixNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxzQkFBWixFQUFvQ0MsSUFBSSxDQUFDQyxTQUFMLENBQWVaLFVBQWYsQ0FBcEM7QUFDQWEsTUFBQUEsT0FBTyxDQUFDQyxJQUFSLENBQWEsQ0FBYjtBQUNIOztBQUNELFdBQU9iLEtBQVA7QUFDSDs7QUFFRCxXQUFTYyxZQUFULENBQXNCakMsSUFBdEIsRUFBb0Q7QUFDaEQsUUFBSUEsSUFBSSxDQUFDcUIsS0FBVCxFQUFnQjtBQUNaLGFBQU9ZLFlBQVksQ0FBQ2pDLElBQUksQ0FBQ3FCLEtBQU4sQ0FBbkI7QUFDSDs7QUFDRCxXQUFPckIsSUFBUDtBQUNIOztBQUVELFdBQVNrQyxXQUFULENBQ0k3RCxJQURKLEVBRUk2QyxVQUZKLEVBR0U7QUFDRSxVQUFNN0IsTUFBTSxHQUFHNkIsVUFBVSxDQUFDOUIsS0FBWCxJQUFvQjhCLFVBQVUsQ0FBQzdCLE1BQTlDOztBQUNBLFFBQUksQ0FBQ0EsTUFBTCxFQUFhO0FBQ1RzQyxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBYSxNQUFLdkQsSUFBSyxLQUFJd0QsSUFBSSxDQUFDQyxTQUFMLENBQWVaLFVBQWYsRUFBMkJkLE1BQTNCLENBQWtDLENBQWxDLEVBQXFDLEdBQXJDLENBQTBDLEVBQXJFO0FBQ0E7QUFDSDs7QUFDRCxVQUFNSixJQUFZLEdBQUc7QUFDakIzQixNQUFBQSxJQURpQjtBQUVqQmtCLE1BQUFBLFFBQVEsRUFBRTJCLFVBQVUsQ0FBQzlCLEtBQVgsR0FBbUJILGNBQWMsQ0FBQ0csS0FBbEMsR0FBMENILGNBQWMsQ0FBQ0ksTUFGbEQ7QUFHakJHLE1BQUFBLE1BQU0sRUFBRSxFQUhTO0FBSWpCMkMsTUFBQUEsVUFBVSxFQUFHakIsVUFBRCxDQUFrQnhFLENBQWxCLENBQW9CeUYsVUFKZjtBQUtqQnRGLE1BQUFBLEdBQUcsRUFBRTBELFFBQVEsQ0FBQ1csVUFBRDtBQUxJLEtBQXJCOztBQVFBLFFBQUlsQixJQUFJLENBQUNtQyxVQUFULEVBQXFCO0FBQ2pCbkMsTUFBQUEsSUFBSSxDQUFDUixNQUFMLENBQVk0QyxJQUFaLENBQWlCO0FBQ2IvRCxRQUFBQSxJQUFJLEVBQUUsSUFETztBQUViK0MsUUFBQUEsVUFBVSxFQUFFLENBRkM7QUFHYnBCLFFBQUFBLElBQUksRUFBRVAsV0FBVyxDQUFDSyxNQUhMO0FBSWJqRCxRQUFBQSxHQUFHLEVBQUU7QUFKUSxPQUFqQjtBQU1IOztBQUNEd0MsSUFBQUEsTUFBTSxDQUFDZ0QsT0FBUCxDQUFnQmxCLEtBQUQsSUFBVztBQUN0Qm5CLE1BQUFBLElBQUksQ0FBQ1IsTUFBTCxDQUFZNEMsSUFBWixDQUFpQnJCLFlBQVksQ0FBQzFDLElBQUQsRUFBTzhDLEtBQVAsQ0FBN0I7QUFDQSxZQUFNbUIsU0FBUyxHQUFHTCxZQUFZLENBQUNkLEtBQUQsQ0FBOUI7QUFDQSxZQUFNb0IsT0FBTyxHQUFJRCxTQUFTLENBQUNqRCxNQUFWLElBQW9CaUQsU0FBUyxDQUFDbEQsS0FBL0IsR0FBd0NrRCxTQUF4QyxHQUFvRCxJQUFwRTs7QUFDQSxVQUFJQyxPQUFKLEVBQWE7QUFDVEwsUUFBQUEsV0FBVyxDQUFDLDRCQUFrQjdELElBQWxCLEVBQXdCOEMsS0FBSyxDQUFDOUMsSUFBOUIsQ0FBRCxFQUFzQ2tFLE9BQXRDLENBQVg7QUFDSDtBQUNKLEtBUEQ7QUFRQTNCLElBQUFBLE9BQU8sQ0FBQ3dCLElBQVIsQ0FBYXBDLElBQWI7QUFDSDs7QUFFRCxRQUFNUSxNQUFNLEdBQUcsMEJBQWFHLFNBQWIsQ0FBZjs7QUFFQSxNQUFJSCxNQUFNLENBQUNnQyxLQUFYLEVBQWtCO0FBQ2RoQyxJQUFBQSxNQUFNLENBQUNnQyxLQUFQLENBQWFDLEtBQWIsQ0FBbUJKLE9BQW5CLENBQTRCckMsSUFBRCxJQUFvQztBQUMzRGtDLE1BQUFBLFdBQVcsQ0FBQ2xDLElBQUksQ0FBQzNCLElBQU4sRUFBWTJCLElBQVosQ0FBWDtBQUNILEtBRkQ7QUFHSDs7QUFHRCxRQUFNZCxVQUErQixHQUFHLElBQUk0QixHQUFKLEVBQXhDO0FBQ0EsUUFBTTRCLFNBQXNCLEdBQUcsSUFBSUMsR0FBSixFQUEvQjtBQUNBLFFBQU1DLFFBQTZCLEdBQUcsSUFBSTlCLEdBQUosRUFBdEM7QUFDQSxRQUFNK0IsZUFBeUIsR0FBRyxFQUFsQztBQUNBakMsRUFBQUEsT0FBTyxDQUFDeUIsT0FBUixDQUFnQlMsQ0FBQyxJQUFJNUQsVUFBVSxDQUFDc0MsR0FBWCxDQUFlc0IsQ0FBQyxDQUFDekUsSUFBakIsRUFBdUJ5RSxDQUF2QixDQUFyQjs7QUFDQSxRQUFNQyxXQUFXLEdBQUkvQyxJQUFELElBQWtCO0FBQ2xDLFFBQUk0QyxRQUFRLENBQUNJLEdBQVQsQ0FBYWhELElBQUksQ0FBQzNCLElBQWxCLENBQUosRUFBNkI7QUFDekI7QUFDSDs7QUFDRCxRQUFJcUUsU0FBUyxDQUFDTSxHQUFWLENBQWNoRCxJQUFJLENBQUMzQixJQUFuQixDQUFKLEVBQThCO0FBQzFCc0QsTUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQWEsdUNBQXNDNUIsSUFBSSxDQUFDM0IsSUFBSyxFQUE3RDtBQUNBO0FBQ0g7O0FBQ0RxRSxJQUFBQSxTQUFTLENBQUNPLEdBQVYsQ0FBY2pELElBQUksQ0FBQzNCLElBQW5CO0FBQ0EyQixJQUFBQSxJQUFJLENBQUNSLE1BQUwsQ0FBWTZDLE9BQVosQ0FBcUJsQixLQUFELElBQVc7QUFDM0IsVUFBSUEsS0FBSyxDQUFDbkIsSUFBTixDQUFXVCxRQUFYLEtBQXdCTixjQUFjLENBQUNDLFVBQTNDLEVBQXVEO0FBQ25ELFlBQUljLElBQUksR0FBRzRDLFFBQVEsQ0FBQ00sR0FBVCxDQUFhL0IsS0FBSyxDQUFDbkIsSUFBTixDQUFXM0IsSUFBeEIsQ0FBWDs7QUFDQSxZQUFJLENBQUMyQixJQUFMLEVBQVc7QUFDUEEsVUFBQUEsSUFBSSxHQUFHZCxVQUFVLENBQUNnRSxHQUFYLENBQWUvQixLQUFLLENBQUNuQixJQUFOLENBQVczQixJQUExQixDQUFQOztBQUNBLGNBQUkyQixJQUFKLEVBQVU7QUFDTitDLFlBQUFBLFdBQVcsQ0FBQy9DLElBQUQsQ0FBWDtBQUNILFdBRkQsTUFFTztBQUNIMkIsWUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQWEsOEJBQTZCVCxLQUFLLENBQUNuQixJQUFOLENBQVczQixJQUFLLEVBQTFEO0FBQ0EwRCxZQUFBQSxPQUFPLENBQUNDLElBQVIsQ0FBYSxDQUFiO0FBQ0g7QUFDSjs7QUFDRCxZQUFJaEMsSUFBSixFQUFVO0FBQ05tQixVQUFBQSxLQUFLLENBQUNuQixJQUFOLEdBQWFBLElBQWI7QUFDSDtBQUNKO0FBQ0osS0FoQkQ7QUFpQkEwQyxJQUFBQSxTQUFTLENBQUNTLE1BQVYsQ0FBaUJuRCxJQUFJLENBQUMzQixJQUF0QjtBQUNBd0UsSUFBQUEsZUFBZSxDQUFDVCxJQUFoQixDQUFxQnBDLElBQXJCO0FBQ0FkLElBQUFBLFVBQVUsQ0FBQ2lFLE1BQVgsQ0FBa0JuRCxJQUFJLENBQUMzQixJQUF2QjtBQUNBdUUsSUFBQUEsUUFBUSxDQUFDcEIsR0FBVCxDQUFheEIsSUFBSSxDQUFDM0IsSUFBbEIsRUFBd0IyQixJQUF4QjtBQUNILEdBOUJEOztBQStCQVksRUFBQUEsT0FBTyxDQUFDeUIsT0FBUixDQUFnQlUsV0FBaEI7QUFDQSxTQUFPO0FBQ0hOLElBQUFBLEtBQUssRUFBRUksZUFESjtBQUVIaEMsSUFBQUE7QUFGRyxHQUFQO0FBSUgiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuaW1wb3J0IHttYWtlRmllbGRUeXBlTmFtZX0gZnJvbSBcIi4uLy4uL21haW50YW5hbmNlL2dlbi1ncmFwaHFsL2dlbi5qc1wiO1xuaW1wb3J0IHtEZWYsIHBhcnNlVHlwZURlZn0gZnJvbSBcIi4vc2NoZW1hLmpzXCI7XG5pbXBvcnQgdHlwZSB7XG4gICAgSW50U2l6ZVR5cGUsXG4gICAgU2NoZW1hRG9jLFxuICAgIFNjaGVtYU1lbWJlcixcbiAgICBTY2hlbWFUeXBlLFxuICAgIFR5cGVEZWZcbn0gZnJvbSBcIi4vc2NoZW1hLmpzXCI7XG5cbmNvbnN0IHsgcmVmLCBhcnJheU9mIH0gPSBEZWY7XG5cbmNvbnN0IFRvU3RyaW5nRm9ybWF0dGVyID0ge1xuICAgIHVuaXhNaWxsaXNlY29uZHNUb1N0cmluZzogJ3VuaXhNaWxsaXNlY29uZHNUb1N0cmluZycsXG4gICAgdW5peFNlY29uZHNUb1N0cmluZzogJ3VuaXhTZWNvbmRzVG9TdHJpbmcnLFxuXG59XG5cbmV4cG9ydCB0eXBlIFRvU3RyaW5nRm9ybWF0dGVyVHlwZSA9ICRWYWx1ZXM8dHlwZW9mIFRvU3RyaW5nRm9ybWF0dGVyPjtcblxuZXhwb3J0IGNvbnN0IGpvaW4gPSAoXG4gICAgcmVmRGVmOiAoc3RyaW5nIHwgeyBbc3RyaW5nXTogVHlwZURlZiB9KSxcbiAgICBvbjogc3RyaW5nLFxuICAgIHJlZk9uOiBzdHJpbmcsXG4gICAgcHJlQ29uZGl0aW9uPzogc3RyaW5nLFxuKTogVHlwZURlZiA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgLi4ucmVmKHJlZkRlZiksXG4gICAgICAgIF86IHtcbiAgICAgICAgICAgIGpvaW46IHtcbiAgICAgICAgICAgICAgICBvbixcbiAgICAgICAgICAgICAgICByZWZPbixcbiAgICAgICAgICAgICAgICBwcmVDb25kaXRpb246IChwcmVDb25kaXRpb24gfHwgJycpLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICB9XG59O1xuXG5leHBvcnQgY29uc3Qgd2l0aERvYyA9IChkZWY6IFR5cGVEZWYsIGRvYz86IHN0cmluZykgPT4gKHtcbiAgICAuLi5kZWYsXG4gICAgLi4uKGRvYyA/IHsgX2RvYzogZG9jIH0gOiB7fSksXG59KTtcblxuZXhwb3J0IGNvbnN0IHJlcXVpcmVkID0gKGRlZjogVHlwZURlZikgPT4gZGVmO1xuXG5jb25zdCB1aW50ID0gKHNpemU6IEludFNpemVUeXBlLCBkb2M/OiBzdHJpbmcpID0+IHdpdGhEb2Moe1xuICAgIF9pbnQ6IHtcbiAgICAgICAgdW5zaWduZWQ6IHRydWUsXG4gICAgICAgIHNpemUsXG4gICAgfSxcbn0sIGRvYyk7XG5cbmNvbnN0IGludCA9IChzaXplOiBJbnRTaXplVHlwZSwgZG9jPzogc3RyaW5nKSA9PiB3aXRoRG9jKHtcbiAgICBfaW50OiB7XG4gICAgICAgIHVuc2lnbmVkOiBmYWxzZSxcbiAgICAgICAgc2l6ZSxcbiAgICB9LFxufSwgZG9jKTtcblxuZXhwb3J0IGNvbnN0IGk4ID0gKGRvYz86IHN0cmluZykgPT4gaW50KDgsIGRvYyk7XG5leHBvcnQgY29uc3QgaTMyID0gKGRvYz86IHN0cmluZykgPT4gaW50KDMyLCBkb2MpO1xuZXhwb3J0IGNvbnN0IHU4ID0gKGRvYz86IHN0cmluZykgPT4gdWludCg4LCBkb2MpO1xuZXhwb3J0IGNvbnN0IHUxNiA9IChkb2M/OiBzdHJpbmcpID0+IHVpbnQoMTYsIGRvYyk7XG5leHBvcnQgY29uc3QgdTMyID0gKGRvYz86IHN0cmluZykgPT4gdWludCgzMiwgZG9jKTtcbmV4cG9ydCBjb25zdCB1NjQgPSAoZG9jPzogc3RyaW5nKSA9PiB1aW50KDY0LCBkb2MpO1xuZXhwb3J0IGNvbnN0IHUxMjggPSAoZG9jPzogc3RyaW5nKSA9PiB1aW50KDEyOCwgZG9jKTtcbmNvbnN0IHUyNTYgPSAoZG9jPzogc3RyaW5nKSA9PiB1aW50KDI1NiwgZG9jKTtcblxuZXhwb3J0IGNvbnN0IHUzMldpdGhGb3JtYXR0ZXIgPSAoZm9ybWF0dGVyOiBUb1N0cmluZ0Zvcm1hdHRlclR5cGUsIGRvYz86IHN0cmluZykgPT4gd2l0aERvYyh7XG4gICAgX2ludDoge1xuICAgICAgICB1bnNpZ25lZDogdHJ1ZSxcbiAgICAgICAgc2l6ZTogMzIsXG4gICAgfSxcbiAgICBfOiB7XG4gICAgICAgIGZvcm1hdHRlcixcbiAgICB9LFxufSwgZG9jKTtcblxuZXhwb3J0IGNvbnN0IHN0cmluZ1dpdGhMb3dlckZpbHRlciA9IChkb2M/OiBzdHJpbmcpID0+IHdpdGhEb2Moe1xuICAgIF9zdHJpbmc6IHtcbiAgICB9LFxuICAgIF86IHtcbiAgICAgICAgbG93ZXJGaWx0ZXI6IHRydWUsXG4gICAgfSxcbn0sIGRvYyk7XG5cbmV4cG9ydCBjb25zdCB1bml4U2Vjb25kcyA9IChkb2M/OiBzdHJpbmcpID0+IHUzMldpdGhGb3JtYXR0ZXIoVG9TdHJpbmdGb3JtYXR0ZXIudW5peFNlY29uZHNUb1N0cmluZywgZG9jKTtcblxuZXhwb3J0IGNvbnN0IGdyYW1zID0gdTEyODtcblxudHlwZSBJbnRFbnVtVmFsdWVzID0ge1xuICAgIFtzdHJpbmddOiBudW1iZXJcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiB1OGVudW0obmFtZTogc3RyaW5nLCB2YWx1ZXM6IEludEVudW1WYWx1ZXMpIHtcbiAgICByZXR1cm4gKGRvYz86IHN0cmluZyk6IFR5cGVEZWYgPT4ge1xuICAgICAgICBjb25zdCB2YWx1ZXNEb2MgPSBPYmplY3QuZW50cmllcyh2YWx1ZXMpLm1hcCgoW25hbWUsIHZhbHVlXSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGAtICR7KHZhbHVlOiBhbnkpfSDigJMgJHtuYW1lfWA7XG4gICAgICAgIH0pLmpvaW4oJ1xcbicpO1xuICAgICAgICBjb25zdCBlZmZlY3RpdmVEb2MgPSBgJHtkb2MgPyBgJHtkb2N9XFxuYCA6ICcnfSR7dmFsdWVzRG9jfWA7XG4gICAgICAgIHJldHVybiB3aXRoRG9jKHtcbiAgICAgICAgICAgIF9pbnQ6IHtcbiAgICAgICAgICAgICAgICB1bnNpZ25lZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzaXplOiA4LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF86IHtcbiAgICAgICAgICAgICAgICBlbnVtOiB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlcyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSwgZWZmZWN0aXZlRG9jKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjb25zdCBPdGhlckN1cnJlbmN5OiBUeXBlRGVmID0ge1xuICAgIGN1cnJlbmN5OiB1MzIoKSxcbiAgICB2YWx1ZTogdTI1NigpLFxufTtcblxuZXhwb3J0IGNvbnN0IG90aGVyQ3VycmVuY3lDb2xsZWN0aW9uID0gKGRvYz86IHN0cmluZyk6IFR5cGVEZWYgPT4gYXJyYXlPZihyZWYoeyBPdGhlckN1cnJlbmN5IH0pLCBkb2MpO1xuZXhwb3J0IGNvbnN0IERiVHlwZUNhdGVnb3J5ID0ge1xuICAgIHVucmVzb2x2ZWQ6ICd1bnJlc29sdmVkJyxcbiAgICBzY2FsYXI6ICdzY2FsYXInLFxuICAgIHVuaW9uOiAndW5pb24nLFxuICAgIHN0cnVjdDogJ3N0cnVjdCcsXG59O1xudHlwZSBEYkpvaW4gPSB7XG4gICAgY29sbGVjdGlvbjogc3RyaW5nLFxuICAgIG9uOiBzdHJpbmcsXG4gICAgcmVmT246IHN0cmluZyxcbiAgICBwcmVDb25kaXRpb246IHN0cmluZyxcbn1cbmV4cG9ydCB0eXBlIERiVHlwZSA9IHtcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgZmllbGRzOiBEYkZpZWxkW10sXG4gICAgY2F0ZWdvcnk6ICd1bnJlc29sdmVkJyB8ICdzY2FsYXInIHwgJ3VuaW9uJyB8ICdzdHJ1Y3QnLFxuICAgIGNvbGxlY3Rpb24/OiBzdHJpbmcsXG4gICAgZG9jOiBzdHJpbmcsXG59XG5leHBvcnQgdHlwZSBJbnRFbnVtRGVmID0ge1xuICAgIG5hbWU6IHN0cmluZyxcbiAgICB2YWx1ZXM6IHtcbiAgICAgICAgW3N0cmluZ106IG51bWJlclxuICAgIH0sXG59XG5leHBvcnQgdHlwZSBEYkZpZWxkID0ge1xuICAgIG5hbWU6IHN0cmluZyxcbiAgICB0eXBlOiBEYlR5cGUsXG4gICAgYXJyYXlEZXB0aDogbnVtYmVyLFxuICAgIGpvaW4/OiBEYkpvaW4sXG4gICAgZW51bURlZj86IEludEVudW1EZWYsXG4gICAgZm9ybWF0dGVyPzogVG9TdHJpbmdGb3JtYXR0ZXJUeXBlLFxuICAgIGxvd2VyRmlsdGVyPzogYm9vbGVhbixcbiAgICBkb2M6IHN0cmluZyxcbn1cblxuZnVuY3Rpb24gc2NhbGFyVHlwZShuYW1lOiBzdHJpbmcpOiBEYlR5cGUge1xuICAgIHJldHVybiB7XG4gICAgICAgIG5hbWUsXG4gICAgICAgIGNhdGVnb3J5OiBEYlR5cGVDYXRlZ29yeS5zY2FsYXIsXG4gICAgICAgIGZpZWxkczogW10sXG4gICAgICAgIGRvYzogJycsXG4gICAgfVxufVxuXG5leHBvcnQgY29uc3Qgc2NhbGFyVHlwZXMgPSB7XG4gICAgaW50OiBzY2FsYXJUeXBlKCdJbnQnKSxcbiAgICB1aW50NjQ6IHNjYWxhclR5cGUoJ1N0cmluZycpLFxuICAgIHVpbnQxMDI0OiBzY2FsYXJUeXBlKCdTdHJpbmcnKSxcbiAgICBmbG9hdDogc2NhbGFyVHlwZSgnRmxvYXQnKSxcbiAgICBib29sZWFuOiBzY2FsYXJUeXBlKCdCb29sZWFuJyksXG4gICAgc3RyaW5nOiBzY2FsYXJUeXBlKCdTdHJpbmcnKSxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0JpZ0ludCh0eXBlOiBEYlR5cGUpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdHlwZSA9PT0gc2NhbGFyVHlwZXMudWludDEwMjQgfHwgdHlwZSA9PT0gc2NhbGFyVHlwZXMudWludDY0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdW5yZXNvbHZlZFR5cGUobmFtZTogc3RyaW5nKTogRGJUeXBlIHtcbiAgICByZXR1cm4ge1xuICAgICAgICBuYW1lLFxuICAgICAgICBjYXRlZ29yeTogRGJUeXBlQ2F0ZWdvcnkudW5yZXNvbHZlZCxcbiAgICAgICAgZmllbGRzOiBbXSxcbiAgICAgICAgZG9jOiAnJyxcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0b0VudW1TdHlsZShzOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiBgJHtzLnN1YnN0cigwLCAxKS50b1VwcGVyQ2FzZSgpfSR7cy5zdWJzdHIoMSl9YDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN0cmluZ2lmeUVudW1WYWx1ZXModmFsdWVzOiB7IFtzdHJpbmddOiBudW1iZXIgfSk6IHN0cmluZyB7XG4gICAgY29uc3QgZmllbGRzID0gT2JqZWN0LmVudHJpZXModmFsdWVzKS5tYXAoKFtuYW1lLCB2YWx1ZV0pID0+IHtcbiAgICAgICAgcmV0dXJuIGAke3RvRW51bVN0eWxlKG5hbWUpfTogJHsodmFsdWU6IGFueSl9YDtcbiAgICB9KTtcbiAgICByZXR1cm4gYHsgJHtmaWVsZHMuam9pbignLCAnKX0gfWA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXREb2NNRChzY2hlbWE6IFNjaGVtYURvYyk6IHN0cmluZyB7XG4gICAgY29uc3QgZG9jID0gc2NoZW1hLmRvYztcbiAgICBpZiAoIWRvYykge1xuICAgICAgICByZXR1cm4gJyc7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgZG9jID09PSAnc3RyaW5nJykge1xuICAgICAgICByZXR1cm4gZG9jO1xuICAgIH1cbiAgICBpZiAoZG9jLm1kKSB7XG4gICAgICAgIHJldHVybiAoZG9jLm1kOiBhbnkpO1xuICAgIH1cbiAgICByZXR1cm4gJyc7XG59XG5cbmV4cG9ydCB0eXBlIERiU2NoZW1hID0ge1xuICAgIHR5cGVzOiBEYlR5cGVbXSxcbiAgICBlbnVtVHlwZXM6IE1hcDxzdHJpbmcsIEludEVudW1EZWY+LFxufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VEYlNjaGVtYShzY2hlbWFEZWY6IFR5cGVEZWYpOiBEYlNjaGVtYSB7XG4gICAgY29uc3QgZGJUeXBlczogRGJUeXBlW10gPSBbXTtcbiAgICBjb25zdCBlbnVtVHlwZXM6IE1hcDxzdHJpbmcsIEludEVudW1EZWY+ID0gbmV3IE1hcCgpO1xuXG4gICAgZnVuY3Rpb24gcGFyc2VEYkZpZWxkKFxuICAgICAgICB0eXBlTmFtZTogc3RyaW5nLFxuICAgICAgICBzY2hlbWFGaWVsZDogU2NoZW1hTWVtYmVyPFNjaGVtYVR5cGU+LFxuICAgICk6IERiRmllbGQge1xuICAgICAgICBsZXQgc2NoZW1hVHlwZSA9IHNjaGVtYUZpZWxkO1xuICAgICAgICBjb25zdCBmaWVsZDogRGJGaWVsZCA9IHtcbiAgICAgICAgICAgIG5hbWU6IHNjaGVtYUZpZWxkLm5hbWUsXG4gICAgICAgICAgICBhcnJheURlcHRoOiAwLFxuICAgICAgICAgICAgdHlwZTogc2NhbGFyVHlwZXMuc3RyaW5nLFxuICAgICAgICAgICAgZG9jOiBnZXREb2NNRChzY2hlbWFGaWVsZCksXG4gICAgICAgIH07XG4gICAgICAgIHdoaWxlIChzY2hlbWFUeXBlLmFycmF5KSB7XG4gICAgICAgICAgICBmaWVsZC5hcnJheURlcHRoICs9IDE7XG4gICAgICAgICAgICBzY2hlbWFUeXBlID0gc2NoZW1hVHlwZS5hcnJheTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBleCA9IChzY2hlbWFUeXBlOiBhbnkpLl87XG4gICAgICAgIGNvbnN0IGVudW1EZWY6ID9JbnRFbnVtRGVmID0gKGV4ICYmIGV4LmVudW0pIHx8IG51bGw7XG4gICAgICAgIGlmIChlbnVtRGVmKSB7XG4gICAgICAgICAgICBmaWVsZC5lbnVtRGVmID0gZW51bURlZjtcbiAgICAgICAgICAgIGVudW1UeXBlcy5zZXQoZW51bURlZi5uYW1lLCBlbnVtRGVmKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBqb2luID0gZXggJiYgZXguam9pbjtcbiAgICAgICAgaWYgKGpvaW4pIHtcbiAgICAgICAgICAgIGZpZWxkLmpvaW4gPSBqb2luO1xuICAgICAgICB9XG4gICAgICAgIGlmIChleCAmJiBleC5mb3JtYXR0ZXIpIHtcbiAgICAgICAgICAgIGZpZWxkLmZvcm1hdHRlciA9IGV4LmZvcm1hdHRlcjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc2NoZW1hVHlwZS51bmlvbiB8fCBzY2hlbWFUeXBlLnN0cnVjdCkge1xuICAgICAgICAgICAgZmllbGQudHlwZSA9IHVucmVzb2x2ZWRUeXBlKG1ha2VGaWVsZFR5cGVOYW1lKHR5cGVOYW1lLCBzY2hlbWFGaWVsZC5uYW1lKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoc2NoZW1hVHlwZS5yZWYpIHtcbiAgICAgICAgICAgIGZpZWxkLnR5cGUgPSB1bnJlc29sdmVkVHlwZShzY2hlbWFUeXBlLnJlZi5uYW1lKTtcbiAgICAgICAgfSBlbHNlIGlmIChzY2hlbWFUeXBlLmJvb2wpIHtcbiAgICAgICAgICAgIGZpZWxkLnR5cGUgPSBzY2FsYXJUeXBlcy5ib29sZWFuO1xuICAgICAgICB9IGVsc2UgaWYgKHNjaGVtYVR5cGUuaW50KSB7XG4gICAgICAgICAgICBjb25zdCB1bnNpZ25lZDogYm9vbGVhbiA9IChzY2hlbWFUeXBlLmludCAmJiBzY2hlbWFUeXBlLmludC51bnNpZ25lZCkgfHwgZmFsc2U7XG4gICAgICAgICAgICBjb25zdCBzaXplOiBudW1iZXIgPSAoc2NoZW1hVHlwZS5pbnQgJiYgc2NoZW1hVHlwZS5pbnQuc2l6ZSkgfHwgMzI7XG4gICAgICAgICAgICBpZiAodW5zaWduZWQpIHtcbiAgICAgICAgICAgICAgICBpZiAoc2l6ZSA+PSAxMjgpIHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGQudHlwZSA9IHNjYWxhclR5cGVzLnVpbnQxMDI0O1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2l6ZSA+PSA2NCkge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZC50eXBlID0gc2NhbGFyVHlwZXMudWludDY0O1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2l6ZSA+PSAzMikge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZC50eXBlID0gc2NhbGFyVHlwZXMuZmxvYXQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGQudHlwZSA9IHNjYWxhclR5cGVzLmludDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChzaXplID4gMzIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnRlZ2VyIHR5cGUgd2l0aCBzaXplICR7c2l6ZX0gYml0IGRvZXMgbm90IHN1cHBvcnRlZGApO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkLnR5cGUgPSBzY2FsYXJUeXBlcy5pbnQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHNjaGVtYVR5cGUuZmxvYXQpIHtcbiAgICAgICAgICAgIGZpZWxkLnR5cGUgPSBzY2FsYXJUeXBlcy5mbG9hdDtcbiAgICAgICAgfSBlbHNlIGlmIChzY2hlbWFUeXBlLnN0cmluZykge1xuICAgICAgICAgICAgZmllbGQudHlwZSA9IHNjYWxhclR5cGVzLnN0cmluZztcbiAgICAgICAgICAgIGlmIChleCAmJiBleC5sb3dlckZpbHRlcikge1xuICAgICAgICAgICAgICAgIGZpZWxkLmxvd2VyRmlsdGVyID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZpZWxkLnR5cGUgPSBzY2FsYXJUeXBlcy5zdHJpbmc7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnSW52YWxpZCBmaWVsZCB0eXBlOiAnLCBKU09OLnN0cmluZ2lmeShzY2hlbWFUeXBlKSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZpZWxkO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHVud3JhcEFycmF5cyh0eXBlOiBTY2hlbWFUeXBlKTogU2NoZW1hVHlwZSB7XG4gICAgICAgIGlmICh0eXBlLmFycmF5KSB7XG4gICAgICAgICAgICByZXR1cm4gdW53cmFwQXJyYXlzKHR5cGUuYXJyYXkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0eXBlO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHBhcnNlRGJUeXBlKFxuICAgICAgICBuYW1lOiBzdHJpbmcsXG4gICAgICAgIHNjaGVtYVR5cGU6IFNjaGVtYVR5cGVcbiAgICApIHtcbiAgICAgICAgY29uc3Qgc3RydWN0ID0gc2NoZW1hVHlwZS51bmlvbiB8fCBzY2hlbWFUeXBlLnN0cnVjdDtcbiAgICAgICAgaWYgKCFzdHJ1Y3QpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGA/PyAke25hbWV9OiAke0pTT04uc3RyaW5naWZ5KHNjaGVtYVR5cGUpLnN1YnN0cigwLCAyMDApfWApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHR5cGU6IERiVHlwZSA9IHtcbiAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICBjYXRlZ29yeTogc2NoZW1hVHlwZS51bmlvbiA/IERiVHlwZUNhdGVnb3J5LnVuaW9uIDogRGJUeXBlQ2F0ZWdvcnkuc3RydWN0LFxuICAgICAgICAgICAgZmllbGRzOiBbXSxcbiAgICAgICAgICAgIGNvbGxlY3Rpb246IChzY2hlbWFUeXBlOiBhbnkpLl8uY29sbGVjdGlvbixcbiAgICAgICAgICAgIGRvYzogZ2V0RG9jTUQoc2NoZW1hVHlwZSksXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKHR5cGUuY29sbGVjdGlvbikge1xuICAgICAgICAgICAgdHlwZS5maWVsZHMucHVzaCh7XG4gICAgICAgICAgICAgICAgbmFtZTogJ2lkJyxcbiAgICAgICAgICAgICAgICBhcnJheURlcHRoOiAwLFxuICAgICAgICAgICAgICAgIHR5cGU6IHNjYWxhclR5cGVzLnN0cmluZyxcbiAgICAgICAgICAgICAgICBkb2M6ICcnLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgc3RydWN0LmZvckVhY2goKGZpZWxkKSA9PiB7XG4gICAgICAgICAgICB0eXBlLmZpZWxkcy5wdXNoKHBhcnNlRGJGaWVsZChuYW1lLCBmaWVsZCkpO1xuICAgICAgICAgICAgY29uc3QgdW53cmFwcGVkID0gdW53cmFwQXJyYXlzKGZpZWxkKTtcbiAgICAgICAgICAgIGNvbnN0IG93blR5cGUgPSAodW53cmFwcGVkLnN0cnVjdCB8fCB1bndyYXBwZWQudW5pb24pID8gdW53cmFwcGVkIDogbnVsbDtcbiAgICAgICAgICAgIGlmIChvd25UeXBlKSB7XG4gICAgICAgICAgICAgICAgcGFyc2VEYlR5cGUobWFrZUZpZWxkVHlwZU5hbWUobmFtZSwgZmllbGQubmFtZSksIG93blR5cGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgZGJUeXBlcy5wdXNoKHR5cGUpO1xuICAgIH1cblxuICAgIGNvbnN0IHNjaGVtYSA9IHBhcnNlVHlwZURlZihzY2hlbWFEZWYpO1xuXG4gICAgaWYgKHNjaGVtYS5jbGFzcykge1xuICAgICAgICBzY2hlbWEuY2xhc3MudHlwZXMuZm9yRWFjaCgodHlwZTogU2NoZW1hTWVtYmVyPFNjaGVtYVR5cGU+KSA9PiB7XG4gICAgICAgICAgICBwYXJzZURiVHlwZSh0eXBlLm5hbWUsIHR5cGUpO1xuICAgICAgICB9KTtcbiAgICB9XG5cblxuICAgIGNvbnN0IHVucmVzb2x2ZWQ6IE1hcDxzdHJpbmcsIERiVHlwZT4gPSBuZXcgTWFwPHN0cmluZywgRGJUeXBlPigpO1xuICAgIGNvbnN0IHJlc29sdmluZzogU2V0PHN0cmluZz4gPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICBjb25zdCByZXNvbHZlZDogTWFwPHN0cmluZywgRGJUeXBlPiA9IG5ldyBNYXA8c3RyaW5nLCBEYlR5cGU+KCk7XG4gICAgY29uc3Qgb3JkZXJlZFJlc29sdmVkOiBEYlR5cGVbXSA9IFtdO1xuICAgIGRiVHlwZXMuZm9yRWFjaCh0ID0+IHVucmVzb2x2ZWQuc2V0KHQubmFtZSwgdCkpO1xuICAgIGNvbnN0IHJlc29sdmVUeXBlID0gKHR5cGU6IERiVHlwZSkgPT4ge1xuICAgICAgICBpZiAocmVzb2x2ZWQuaGFzKHR5cGUubmFtZSkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzb2x2aW5nLmhhcyh0eXBlLm5hbWUpKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgV0FSTklORzogQ2lyY3VsYXIgcmVmZXJlbmNlIHRvIHR5cGUgJHt0eXBlLm5hbWV9YCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgcmVzb2x2aW5nLmFkZCh0eXBlLm5hbWUpO1xuICAgICAgICB0eXBlLmZpZWxkcy5mb3JFYWNoKChmaWVsZCkgPT4ge1xuICAgICAgICAgICAgaWYgKGZpZWxkLnR5cGUuY2F0ZWdvcnkgPT09IERiVHlwZUNhdGVnb3J5LnVucmVzb2x2ZWQpIHtcbiAgICAgICAgICAgICAgICBsZXQgdHlwZSA9IHJlc29sdmVkLmdldChmaWVsZC50eXBlLm5hbWUpO1xuICAgICAgICAgICAgICAgIGlmICghdHlwZSkge1xuICAgICAgICAgICAgICAgICAgICB0eXBlID0gdW5yZXNvbHZlZC5nZXQoZmllbGQudHlwZS5uYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVUeXBlKHR5cGUpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFJlZmVyZW5jZWQgdHlwZSBub3QgZm91bmQ6ICR7ZmllbGQudHlwZS5uYW1lfWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0eXBlKSB7XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkLnR5cGUgPSB0eXBlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJlc29sdmluZy5kZWxldGUodHlwZS5uYW1lKTtcbiAgICAgICAgb3JkZXJlZFJlc29sdmVkLnB1c2godHlwZSk7XG4gICAgICAgIHVucmVzb2x2ZWQuZGVsZXRlKHR5cGUubmFtZSk7XG4gICAgICAgIHJlc29sdmVkLnNldCh0eXBlLm5hbWUsIHR5cGUpO1xuICAgIH07XG4gICAgZGJUeXBlcy5mb3JFYWNoKHJlc29sdmVUeXBlKTtcbiAgICByZXR1cm4ge1xuICAgICAgICB0eXBlczogb3JkZXJlZFJlc29sdmVkLFxuICAgICAgICBlbnVtVHlwZXMsXG4gICAgfVxufVxuIl19