"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parseTypeDef = parseTypeDef;
exports.Def = void 0;

/* eslint-disable no-use-before-define */
// Def
const Def = {
  void_(doc) {
    return {
      _void: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  any(doc) {
    return {
      _any: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  int(doc) {
    return {
      _int: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  float(doc) {
    return {
      _float: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  string(doc) {
    return {
      _string: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  bool(doc) {
    return {
      _bool: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  time(doc) {
    return {
      _time: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  arrayOf(item, doc) {
    return {
      _array: item,
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  unionOf(members, doc) {
    return {
      _union: members,
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  ref(nameOrType, doc) {
    const name = typeof nameOrType === 'string' ? nameOrType : Object.keys(nameOrType)[0];
    return {
      _ref: name,
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  value(value, doc) {
    return {
      _value: value,
      ...(doc ? {
        _doc: doc
      } : {})
    };
  }

}; // Schema

exports.Def = Def;

function isReservedKey(key) {
  return key === '_doc' || key === "_";
}

// Parser
function parseTypeDef(def) {
  const parser = new SchemaParser();
  return parser.parseTypeDef(def, '');
} // Internals


function combineName(base, name) {
  return base !== '' ? `${base}.${name}` : name;
}

const UnresolvedType = {
  void: {},
  doc: ''
};

class SchemaParser {
  constructor() {
    this.types = {};
  }

  typeRef(def) {
    const defRef = def._ref || '';
    const existing = this.types[defRef];

    if (existing) {
      if (existing.type !== UnresolvedType) {
        return {
          ref: {
            name: defRef,
            type: existing.type
          }
        };
      }

      const ref = {
        name: defRef,
        type: UnresolvedType
      };
      existing.unresolved.push(ref);
      return {
        ref
      };
    }

    const ref = {
      name: defRef,
      type: UnresolvedType
    };
    this.types[defRef] = {
      type: UnresolvedType,
      unresolved: [ref]
    };
    return {
      ref
    };
  }

  resolveType(name, type) {
    const existing = this.types[name];

    if (existing) {
      existing.unresolved.forEach(x => x.type = type);
    }

    this.types[name] = {
      type,
      unresolved: []
    };
  }

  namedMembersFromUnorderedDefs(defs, mapMember) {
    return Object.keys(defs).map(memberName => {
      const memberDef = defs[memberName];
      return {
        name: memberName,
        ...mapMember(memberName, memberDef)
      };
    });
  }

  namedMembersFromOrderedDefs(defs, mapMember) {
    const members = [];
    defs.forEach(unorderedDefs => {
      this.namedMembersFromUnorderedDefs(unorderedDefs, mapMember).forEach(member => {
        members.push(member);
      });
    });
    return members;
  }

  namedMembers(defs, mapMember) {
    return Array.isArray(defs) ? this.namedMembersFromOrderedDefs(defs, mapMember) : this.namedMembersFromUnorderedDefs(defs, mapMember);
  }

  typedNamedMembers(memberDefs, name) {
    return this.namedMembers(memberDefs, (memberName, memberDef) => {
      return this.parseTypeDef(memberDef, combineName(name, memberName));
    });
  }

  typedNamedOrderedMembers(memberDefs, name) {
    return this.namedMembersFromOrderedDefs(memberDefs, (memberName, memberDef) => {
      return this.parseTypeDef(memberDef, combineName(name, memberName));
    });
  }

  parseTypeDef(def, name) {
    const scalarTypes = ['_void', '_any', '_int', '_float', '_string', '_bool', '_time'];

    if (!def) {
      console.log('>>>', name, def);
    }

    let type = {
      def,
      doc: def._doc || '',
      _: def._ || {}
    };
    const scalarType = scalarTypes.find(t => t in def);

    if (scalarType) {
      Object.assign(type, def);
      type[scalarType.substr(1)] = def[scalarType];
    } else if (def._ref) {
      Object.assign(type, this.typeRef(def));
    } else if (def._array) {
      type.array = this.parseTypeDef(def._array, combineName(name, 'item'));
    } else if (def._struct) {
      type.struct = this.typedNamedMembers(def._struct, name);
    } else if (def._union) {
      type.union = this.namedMembers(def._union, (memberName, memberDef) => {
        return memberDef._value ? memberDef : this.parseTypeDef(memberDef, combineName(name, memberName));
      });
    } else if (def._class) {
      const classDef = def._class;
      type.class = {
        types: classDef.types ? this.typedNamedMembers(classDef.types, name) : [],
        fields: classDef.fields ? this.typedNamedMembers(classDef.fields, name) : [],
        functions: classDef.functions ? this.namedMembers(classDef.functions, (functionName, functionDef) => {
          return {
            def: functionDef,
            doc: functionDef._doc || '',
            args: functionDef.args ? this.typedNamedOrderedMembers(functionDef.args, combineName(name, functionName)) : [],
            result: functionDef.result ? this.parseTypeDef(functionDef.result, combineName(name, 'Result')) : {
              doc: '',
              void: {}
            }
          };
        }) : []
      };
    } else if (Array.isArray(def)) {
      type.struct = this.typedNamedMembers(def, name);
    } else if (typeof def === 'object') {
      const filteredDef = {};
      Object.keys(def).forEach(key => {
        if (!isReservedKey(key)) {
          filteredDef[key] = def[key];
        }
      });
      type.struct = this.typedNamedMembers(filteredDef, name);
    } else {
      console.log('>>>', name);
    }

    this.resolveType(name, type);
    return type;
  }

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvc2NoZW1hL3NjaGVtYS5qcyJdLCJuYW1lcyI6WyJEZWYiLCJ2b2lkXyIsImRvYyIsIl92b2lkIiwiX2RvYyIsImFueSIsIl9hbnkiLCJpbnQiLCJfaW50IiwiZmxvYXQiLCJfZmxvYXQiLCJzdHJpbmciLCJfc3RyaW5nIiwiYm9vbCIsIl9ib29sIiwidGltZSIsIl90aW1lIiwiYXJyYXlPZiIsIml0ZW0iLCJfYXJyYXkiLCJ1bmlvbk9mIiwibWVtYmVycyIsIl91bmlvbiIsInJlZiIsIm5hbWVPclR5cGUiLCJuYW1lIiwiT2JqZWN0Iiwia2V5cyIsIl9yZWYiLCJ2YWx1ZSIsIl92YWx1ZSIsImlzUmVzZXJ2ZWRLZXkiLCJrZXkiLCJwYXJzZVR5cGVEZWYiLCJkZWYiLCJwYXJzZXIiLCJTY2hlbWFQYXJzZXIiLCJjb21iaW5lTmFtZSIsImJhc2UiLCJVbnJlc29sdmVkVHlwZSIsInZvaWQiLCJjb25zdHJ1Y3RvciIsInR5cGVzIiwidHlwZVJlZiIsImRlZlJlZiIsImV4aXN0aW5nIiwidHlwZSIsInVucmVzb2x2ZWQiLCJwdXNoIiwicmVzb2x2ZVR5cGUiLCJmb3JFYWNoIiwieCIsIm5hbWVkTWVtYmVyc0Zyb21Vbm9yZGVyZWREZWZzIiwiZGVmcyIsIm1hcE1lbWJlciIsIm1hcCIsIm1lbWJlck5hbWUiLCJtZW1iZXJEZWYiLCJuYW1lZE1lbWJlcnNGcm9tT3JkZXJlZERlZnMiLCJ1bm9yZGVyZWREZWZzIiwibWVtYmVyIiwibmFtZWRNZW1iZXJzIiwiQXJyYXkiLCJpc0FycmF5IiwidHlwZWROYW1lZE1lbWJlcnMiLCJtZW1iZXJEZWZzIiwidHlwZWROYW1lZE9yZGVyZWRNZW1iZXJzIiwic2NhbGFyVHlwZXMiLCJjb25zb2xlIiwibG9nIiwiXyIsInNjYWxhclR5cGUiLCJmaW5kIiwidCIsImFzc2lnbiIsInN1YnN0ciIsImFycmF5IiwiX3N0cnVjdCIsInN0cnVjdCIsInVuaW9uIiwiX2NsYXNzIiwiY2xhc3NEZWYiLCJjbGFzcyIsImZpZWxkcyIsImZ1bmN0aW9ucyIsImZ1bmN0aW9uTmFtZSIsImZ1bmN0aW9uRGVmIiwiYXJncyIsInJlc3VsdCIsImZpbHRlcmVkRGVmIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBO0FBR0E7QUEyQ08sTUFBTUEsR0FBRyxHQUFHO0FBQ2ZDLEVBQUFBLEtBQUssQ0FBQ0MsR0FBRCxFQUErQjtBQUNoQyxXQUFPO0FBQUVDLE1BQUFBLEtBQUssRUFBRSxFQUFUO0FBQWEsVUFBSUQsR0FBRyxHQUFHO0FBQUVFLFFBQUFBLElBQUksRUFBRUY7QUFBUixPQUFILEdBQW1CLEVBQTFCO0FBQWIsS0FBUDtBQUNILEdBSGM7O0FBSWZHLEVBQUFBLEdBQUcsQ0FBQ0gsR0FBRCxFQUErQjtBQUM5QixXQUFPO0FBQUVJLE1BQUFBLElBQUksRUFBRSxFQUFSO0FBQVksVUFBSUosR0FBRyxHQUFHO0FBQUVFLFFBQUFBLElBQUksRUFBRUY7QUFBUixPQUFILEdBQW1CLEVBQTFCO0FBQVosS0FBUDtBQUNILEdBTmM7O0FBT2ZLLEVBQUFBLEdBQUcsQ0FBQ0wsR0FBRCxFQUErQjtBQUM5QixXQUFPO0FBQUVNLE1BQUFBLElBQUksRUFBRSxFQUFSO0FBQVksVUFBSU4sR0FBRyxHQUFHO0FBQUVFLFFBQUFBLElBQUksRUFBRUY7QUFBUixPQUFILEdBQW1CLEVBQTFCO0FBQVosS0FBUDtBQUNILEdBVGM7O0FBVWZPLEVBQUFBLEtBQUssQ0FBQ1AsR0FBRCxFQUErQjtBQUNoQyxXQUFPO0FBQUVRLE1BQUFBLE1BQU0sRUFBRSxFQUFWO0FBQWMsVUFBSVIsR0FBRyxHQUFHO0FBQUVFLFFBQUFBLElBQUksRUFBRUY7QUFBUixPQUFILEdBQW1CLEVBQTFCO0FBQWQsS0FBUDtBQUNILEdBWmM7O0FBYWZTLEVBQUFBLE1BQU0sQ0FBQ1QsR0FBRCxFQUErQjtBQUNqQyxXQUFPO0FBQUVVLE1BQUFBLE9BQU8sRUFBRSxFQUFYO0FBQWUsVUFBSVYsR0FBRyxHQUFHO0FBQUVFLFFBQUFBLElBQUksRUFBRUY7QUFBUixP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QixLQUFLLENBQUNDLE9BQU4sQ0FBYzdCLEdBQWQsQ0FBSixFQUF3QjtBQUMzQlksTUFBQUEsSUFBSSxDQUFDZ0MsTUFBTCxHQUFjLEtBQUtkLGlCQUFMLENBQXdCOUIsR0FBeEIsRUFBbUNULElBQW5DLENBQWQ7QUFDSCxLQUZNLE1BRUEsSUFBSSxPQUFPUyxHQUFQLEtBQWUsUUFBbkIsRUFBNkI7QUFDaEMsWUFBTXVELFdBQVcsR0FBRyxFQUFwQjtBQUNBL0QsTUFBQUEsTUFBTSxDQUFDQyxJQUFQLENBQVlPLEdBQVosRUFBaUJnQixPQUFqQixDQUEwQmxCLEdBQUQsSUFBUztBQUM5QixZQUFJLENBQUNELGFBQWEsQ0FBQ0MsR0FBRCxDQUFsQixFQUF5QjtBQUNyQnlELFVBQUFBLFdBQVcsQ0FBQ3pELEdBQUQsQ0FBWCxHQUFtQkUsR0FBRyxDQUFDRixHQUFELENBQXRCO0FBQ0g7QUFDSixPQUpEO0FBS0FjLE1BQUFBLElBQUksQ0FBQ2dDLE1BQUwsR0FBYyxLQUFLZCxpQkFBTCxDQUF3QnlCLFdBQXhCLEVBQTJDaEUsSUFBM0MsQ0FBZDtBQUNILEtBUk0sTUFRQTtBQUNIMkMsTUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksS0FBWixFQUFtQjVDLElBQW5CO0FBQ0g7O0FBQ0QsU0FBS3dCLFdBQUwsQ0FBaUJ4QixJQUFqQixFQUF1QnFCLElBQXZCO0FBQ0EsV0FBT0EsSUFBUDtBQUNIOztBQTFJYyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIG5vLXVzZS1iZWZvcmUtZGVmaW5lICovXG4vLyBAZmxvd1xuXG4vLyBEZWZcblxuZXhwb3J0IHR5cGUgRG9jQ29udGVudERlZiA9IHN0cmluZyB8IHsgbWQ6IHN0cmluZyB9IHwgeyBodG1sOiBzdHJpbmcgfTtcblxuZXhwb3J0IHR5cGUgRG9jRGVmID0geyBfZG9jPzogRG9jQ29udGVudERlZiB9XG5cbmV4cG9ydCB0eXBlIENsYXNzRGVmID0ge1xuICAgIHR5cGVzPzogTWVtYmVyc0RlZjxUeXBlRGVmPixcbiAgICBmaWVsZHM/OiBNZW1iZXJzRGVmPFR5cGVEZWY+LFxuICAgIGZ1bmN0aW9ucz86IE1lbWJlcnNEZWY8RnVuY3Rpb25EZWY+XG59XG5cbmV4cG9ydCB0eXBlIEludFNpemVUeXBlID0gOCB8IDE2IHwgMzIgfCA2NCB8IDEyOCB8IDI1NjtcblxuZXhwb3J0IHR5cGUgVHlwZURlZiA9IERvY0RlZiAmIHtcbiAgICBfdm9pZD86IHt9LFxuICAgIF9hbnk/OiB7fSxcbiAgICBfcmVmPzogc3RyaW5nLFxuICAgIF9ib29sPzoge30sXG4gICAgX3RpbWU/OiB7fSxcbiAgICBfc3RyaW5nPzoge30sXG4gICAgX2Zsb2F0PzogeyBzaXplPzogMzIgfCA2NCB9LFxuICAgIF9pbnQ/OiB7IHVuc2lnbmVkPzogYm9vbGVhbiwgc2l6ZT86IEludFNpemVUeXBlIH0sXG4gICAgX2FycmF5PzogVHlwZURlZixcbiAgICBfc3RydWN0PzogTWVtYmVyc0RlZjxUeXBlRGVmPixcbiAgICBfdW5pb24/OiBNZW1iZXJzRGVmPFR5cGVEZWY+LFxuICAgIF9jbGFzcz86IENsYXNzRGVmLFxuICAgIF92YWx1ZT86IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4sXG59XG5cbmV4cG9ydCB0eXBlIEZ1bmN0aW9uRGVmID0gRG9jRGVmICYge1xuICAgIGFyZ3M/OiBPcmRlcmVkTWVtYmVyc0RlZjxUeXBlRGVmPixcbiAgICByZXN1bHQ/OiBUeXBlRGVmLFxufVxuXG5leHBvcnQgdHlwZSBVbm9yZGVyZWRNZW1iZXJzRGVmPE0+ID0ge1xuICAgIFtzdHJpbmddOiBNXG59XG5cbmV4cG9ydCB0eXBlIE9yZGVyZWRNZW1iZXJzRGVmPE0+ID0gVW5vcmRlcmVkTWVtYmVyc0RlZjxNPltdXG5cbmV4cG9ydCB0eXBlIE1lbWJlcnNEZWY8TT4gPSBPcmRlcmVkTWVtYmVyc0RlZjxNPiB8IFVub3JkZXJlZE1lbWJlcnNEZWY8TT5cblxuZXhwb3J0IGNvbnN0IERlZiA9IHtcbiAgICB2b2lkXyhkb2M/OiBEb2NDb250ZW50RGVmKTogVHlwZURlZiB7XG4gICAgICAgIHJldHVybiB7IF92b2lkOiB7fSwgLi4uKGRvYyA/IHsgX2RvYzogZG9jIH0gOiB7fSkgfVxuICAgIH0sXG4gICAgYW55KGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcbiAgICAgICAgcmV0dXJuIHsgX2FueToge30sIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH1cbiAgICB9LFxuICAgIGludChkb2M/OiBEb2NDb250ZW50RGVmKTogVHlwZURlZiB7XG4gICAgICAgIHJldHVybiB7IF9pbnQ6IHt9LCAuLi4oZG9jID8geyBfZG9jOiBkb2MgfSA6IHt9KSB9XG4gICAgfSxcbiAgICBmbG9hdChkb2M/OiBEb2NDb250ZW50RGVmKTogVHlwZURlZiB7XG4gICAgICAgIHJldHVybiB7IF9mbG9hdDoge30sIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH1cbiAgICB9LFxuICAgIHN0cmluZyhkb2M/OiBEb2NDb250ZW50RGVmKTogVHlwZURlZiB7XG4gICAgICAgIHJldHVybiB7IF9zdHJpbmc6IHt9LCAuLi4oZG9jID8geyBfZG9jOiBkb2MgfSA6IHt9KSB9XG4gICAgfSxcbiAgICBib29sKGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcbiAgICAgICAgcmV0dXJuIHsgX2Jvb2w6IHt9LCAuLi4oZG9jID8geyBfZG9jOiBkb2MgfSA6IHt9KSB9XG4gICAgfSxcbiAgICB0aW1lKGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcbiAgICAgICAgcmV0dXJuIHsgX3RpbWU6IHt9LCAuLi4oZG9jID8geyBfZG9jOiBkb2MgfSA6IHt9KSB9XG4gICAgfSxcbiAgICBhcnJheU9mKGl0ZW06IFR5cGVEZWYsIGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcbiAgICAgICAgcmV0dXJuIHsgX2FycmF5OiBpdGVtLCAuLi4oZG9jID8geyBfZG9jOiBkb2MgfSA6IHt9KSB9XG4gICAgfSxcbiAgICB1bmlvbk9mKG1lbWJlcnM6IE1lbWJlcnNEZWY8VHlwZURlZj4sIGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcbiAgICAgICAgcmV0dXJuIHsgX3VuaW9uOiBtZW1iZXJzLCAuLi4oZG9jID8geyBfZG9jOiBkb2MgfSA6IHt9KSB9XG4gICAgfSxcbiAgICByZWYobmFtZU9yVHlwZTogc3RyaW5nIHwgeyBbc3RyaW5nXTogVHlwZURlZiB9LCBkb2M/OiBEb2NDb250ZW50RGVmKTogVHlwZURlZiB7XG4gICAgICAgIGNvbnN0IG5hbWUgPSB0eXBlb2YgbmFtZU9yVHlwZSA9PT0gJ3N0cmluZycgPyBuYW1lT3JUeXBlIDogT2JqZWN0LmtleXMobmFtZU9yVHlwZSlbMF07XG4gICAgICAgIHJldHVybiB7IF9yZWY6IG5hbWUsIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH07XG4gICAgfSxcbiAgICB2YWx1ZSh2YWx1ZTogc3RyaW5nLCBkb2M/OiBEb2NDb250ZW50RGVmKTogVHlwZURlZiB7XG4gICAgICAgIHJldHVybiB7IF92YWx1ZTogdmFsdWUsIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH1cbiAgICB9LFxufTtcblxuLy8gU2NoZW1hXG5mdW5jdGlvbiBpc1Jlc2VydmVkS2V5KGtleTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGtleSA9PT0gJ19kb2MnIHx8IGtleSA9PT0gXCJfXCI7XG59XG5cbmV4cG9ydCB0eXBlIFNjaGVtYURvYyA9IHtcbiAgICBkb2M/OiAoc3RyaW5nIHwgeyBtZDogc3RyaW5nIH0gfCB7IGh0bWw6IHN0cmluZyB9KVxufVxuXG5leHBvcnQgdHlwZSBTY2hlbWFDbGFzcyA9IHtcbiAgICB0eXBlczogU2NoZW1hTWVtYmVyPFNjaGVtYVR5cGU+W10sXG4gICAgZmllbGRzOiBTY2hlbWFNZW1iZXI8U2NoZW1hVHlwZT5bXSxcbiAgICBmdW5jdGlvbnM6IFNjaGVtYU1lbWJlcjxTY2hlbWFGdW5jdGlvbj5bXVxufVxuXG5leHBvcnQgdHlwZSBTY2hlbWFUeXBlID0gU2NoZW1hRG9jICYge1xuICAgIHZvaWQ/OiB7fSxcbiAgICBhbnk/OiB7fSxcbiAgICBpbnQ/OiB7IHVuc2lnbmVkPzogYm9vbGVhbiwgc2l6ZT86IEludFNpemVUeXBlIH0sXG4gICAgZmxvYXQ/OiB7IHNpemU/OiAoMzIgfCA2NCkgfSxcbiAgICBzdHJpbmc/OiB7fSxcbiAgICBib29sPzoge30sXG4gICAgdGltZT86IHt9LFxuICAgIGFycmF5PzogU2NoZW1hVHlwZSxcbiAgICBzdHJ1Y3Q/OiBTY2hlbWFNZW1iZXI8U2NoZW1hVHlwZT5bXSxcbiAgICB1bmlvbj86IFNjaGVtYU1lbWJlcjxTY2hlbWFUeXBlPltdLFxuICAgIHJlZj86IHsgbmFtZTogc3RyaW5nLCB0eXBlOiBTY2hlbWFUeXBlIH0sXG4gICAgY2xhc3M/OiBTY2hlbWFDbGFzcyxcbiAgICB2YWx1ZT86IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW5cbn1cblxuZXhwb3J0IHR5cGUgU2NoZW1hRnVuY3Rpb24gPSBTY2hlbWFEb2MgJiB7XG4gICAgYXJnczogU2NoZW1hTWVtYmVyPFNjaGVtYVR5cGU+W10sXG4gICAgcmVzdWx0OiBTY2hlbWFUeXBlLFxufVxuXG5leHBvcnQgdHlwZSBTY2hlbWFNZW1iZXI8TT4gPSB7IG5hbWU6IHN0cmluZyB9ICYgTVxuXG4vLyBQYXJzZXJcblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlVHlwZURlZihkZWY6IFR5cGVEZWYpOiBTY2hlbWFUeXBlIHtcbiAgICBjb25zdCBwYXJzZXIgPSBuZXcgU2NoZW1hUGFyc2VyKCk7XG4gICAgcmV0dXJuIHBhcnNlci5wYXJzZVR5cGVEZWYoZGVmLCAnJyk7XG59XG5cbi8vIEludGVybmFsc1xuXG50eXBlIFBhcnNpbmdUeXBlID0ge1xuICAgIHR5cGU6IFNjaGVtYVR5cGUsXG4gICAgdW5yZXNvbHZlZDogeyBuYW1lOiBzdHJpbmcsIHR5cGU6IFNjaGVtYVR5cGUgfVtdLFxufVxuXG5mdW5jdGlvbiBjb21iaW5lTmFtZShiYXNlOiBzdHJpbmcsIG5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGJhc2UgIT09ICcnID8gYCR7YmFzZX0uJHtuYW1lfWAgOiBuYW1lO1xufVxuXG5jb25zdCBVbnJlc29sdmVkVHlwZTogU2NoZW1hVHlwZSA9IHtcbiAgICB2b2lkOiB7fSxcbiAgICBkb2M6ICcnLFxufTtcblxuY2xhc3MgU2NoZW1hUGFyc2VyIHtcbiAgICB0eXBlczogeyBbc3RyaW5nXTogUGFyc2luZ1R5cGUgfTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLnR5cGVzID0ge307XG4gICAgfVxuXG4gICAgdHlwZVJlZihkZWY6IFR5cGVEZWYpOiBTY2hlbWFUeXBlIHtcbiAgICAgICAgY29uc3QgZGVmUmVmID0gZGVmLl9yZWYgfHwgJyc7XG4gICAgICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy50eXBlc1tkZWZSZWZdO1xuICAgICAgICBpZiAoZXhpc3RpbmcpIHtcbiAgICAgICAgICAgIGlmIChleGlzdGluZy50eXBlICE9PSBVbnJlc29sdmVkVHlwZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IHJlZjogeyBuYW1lOiBkZWZSZWYsIHR5cGU6IGV4aXN0aW5nLnR5cGUgfSB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCByZWYgPSB7IG5hbWU6IGRlZlJlZiwgdHlwZTogVW5yZXNvbHZlZFR5cGUgfTtcbiAgICAgICAgICAgIGV4aXN0aW5nLnVucmVzb2x2ZWQucHVzaChyZWYpO1xuICAgICAgICAgICAgcmV0dXJuIHsgcmVmIH07XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcmVmID0geyBuYW1lOiBkZWZSZWYsIHR5cGU6IFVucmVzb2x2ZWRUeXBlIH07XG4gICAgICAgIHRoaXMudHlwZXNbZGVmUmVmXSA9IHsgdHlwZTogVW5yZXNvbHZlZFR5cGUsIHVucmVzb2x2ZWQ6IFtyZWZdIH07XG4gICAgICAgIHJldHVybiB7IHJlZiB9O1xuICAgIH1cblxuICAgIHJlc29sdmVUeXBlKG5hbWU6IHN0cmluZywgdHlwZTogU2NoZW1hVHlwZSkge1xuICAgICAgICBjb25zdCBleGlzdGluZyA9IHRoaXMudHlwZXNbbmFtZV07XG4gICAgICAgIGlmIChleGlzdGluZykge1xuICAgICAgICAgICAgZXhpc3RpbmcudW5yZXNvbHZlZC5mb3JFYWNoKHggPT4geC50eXBlID0gdHlwZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50eXBlc1tuYW1lXSA9IHsgdHlwZSwgdW5yZXNvbHZlZDogW10gfTtcbiAgICB9XG5cbiAgICBuYW1lZE1lbWJlcnNGcm9tVW5vcmRlcmVkRGVmczxELCBTPihcbiAgICAgICAgZGVmczogVW5vcmRlcmVkTWVtYmVyc0RlZjxEPixcbiAgICAgICAgbWFwTWVtYmVyOiAobWVtYmVyTmFtZTogc3RyaW5nLCBtZW1iZXJEZWY6IEQpID0+IFNcbiAgICApOiBTY2hlbWFNZW1iZXI8Uz5bXSB7XG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhkZWZzKS5tYXA8U2NoZW1hTWVtYmVyPFM+PigobWVtYmVyTmFtZTogc3RyaW5nKTogU2NoZW1hTWVtYmVyPFM+ID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1lbWJlckRlZiA9IGRlZnNbbWVtYmVyTmFtZV07XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIG5hbWU6IG1lbWJlck5hbWUsXG4gICAgICAgICAgICAgICAgLi4ubWFwTWVtYmVyKG1lbWJlck5hbWUsIG1lbWJlckRlZilcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIG5hbWVkTWVtYmVyc0Zyb21PcmRlcmVkRGVmczxELCBTPihcbiAgICAgICAgZGVmczogT3JkZXJlZE1lbWJlcnNEZWY8RD4sXG4gICAgICAgIG1hcE1lbWJlcjogKG5hbWU6IHN0cmluZywgZGVmOiBEKSA9PiBTXG4gICAgKTogU2NoZW1hTWVtYmVyPFM+W10ge1xuICAgICAgICBjb25zdCBtZW1iZXJzOiBTY2hlbWFNZW1iZXI8Uz5bXSA9IFtdO1xuICAgICAgICBkZWZzLmZvckVhY2goKHVub3JkZXJlZERlZnM6IFVub3JkZXJlZE1lbWJlcnNEZWY8RD4pID0+IHtcbiAgICAgICAgICAgIHRoaXMubmFtZWRNZW1iZXJzRnJvbVVub3JkZXJlZERlZnModW5vcmRlcmVkRGVmcywgbWFwTWVtYmVyKS5mb3JFYWNoKChtZW1iZXI6IFNjaGVtYU1lbWJlcjxTPikgPT4ge1xuICAgICAgICAgICAgICAgIG1lbWJlcnMucHVzaChtZW1iZXIpXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG1lbWJlcnM7XG4gICAgfVxuXG4gICAgbmFtZWRNZW1iZXJzPEQsIFM+KFxuICAgICAgICBkZWZzOiBNZW1iZXJzRGVmPEQ+LFxuICAgICAgICBtYXBNZW1iZXI6IChuYW1lOiBzdHJpbmcsIGRlZjogRCkgPT4gU1xuICAgICk6IFNjaGVtYU1lbWJlcjxTPltdIHtcbiAgICAgICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoZGVmcylcbiAgICAgICAgICAgID8gdGhpcy5uYW1lZE1lbWJlcnNGcm9tT3JkZXJlZERlZnMoZGVmcywgbWFwTWVtYmVyKVxuICAgICAgICAgICAgOiB0aGlzLm5hbWVkTWVtYmVyc0Zyb21Vbm9yZGVyZWREZWZzKGRlZnMsIG1hcE1lbWJlcik7XG4gICAgfVxuXG4gICAgdHlwZWROYW1lZE1lbWJlcnM8RDogVHlwZURlZj4obWVtYmVyRGVmczogTWVtYmVyc0RlZjxEPiwgbmFtZTogc3RyaW5nKTogU2NoZW1hTWVtYmVyPFNjaGVtYVR5cGU+W10ge1xuICAgICAgICByZXR1cm4gdGhpcy5uYW1lZE1lbWJlcnM8RCwgU2NoZW1hVHlwZT4obWVtYmVyRGVmcywgKG1lbWJlck5hbWU6IHN0cmluZywgbWVtYmVyRGVmOiBEKTogU2NoZW1hVHlwZSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJzZVR5cGVEZWYobWVtYmVyRGVmLCBjb21iaW5lTmFtZShuYW1lLCBtZW1iZXJOYW1lKSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHR5cGVkTmFtZWRPcmRlcmVkTWVtYmVyczxEOiBUeXBlRGVmPihtZW1iZXJEZWZzOiBPcmRlcmVkTWVtYmVyc0RlZjxEPiwgbmFtZTogc3RyaW5nKTogU2NoZW1hTWVtYmVyPFNjaGVtYVR5cGU+W10ge1xuICAgICAgICByZXR1cm4gdGhpcy5uYW1lZE1lbWJlcnNGcm9tT3JkZXJlZERlZnM8RCwgU2NoZW1hVHlwZT4obWVtYmVyRGVmcywgKG1lbWJlck5hbWU6IHN0cmluZywgbWVtYmVyRGVmOiBEKTogU2NoZW1hVHlwZSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJzZVR5cGVEZWYobWVtYmVyRGVmLCBjb21iaW5lTmFtZShuYW1lLCBtZW1iZXJOYW1lKSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgcGFyc2VUeXBlRGVmKGRlZjogVHlwZURlZiwgbmFtZTogc3RyaW5nKTogU2NoZW1hVHlwZSB7XG4gICAgICAgIGNvbnN0IHNjYWxhclR5cGVzID0gWydfdm9pZCcsICdfYW55JywgJ19pbnQnLCAnX2Zsb2F0JywgJ19zdHJpbmcnLCAnX2Jvb2wnLCAnX3RpbWUnXTtcbiAgICAgICAgaWYgKCFkZWYpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCc+Pj4nLCBuYW1lLCBkZWYpO1xuICAgICAgICB9XG4gICAgICAgIGxldCB0eXBlOiBhbnkgPSB7XG4gICAgICAgICAgICBkZWYsXG4gICAgICAgICAgICBkb2M6IGRlZi5fZG9jIHx8ICcnLFxuICAgICAgICAgICAgXzogZGVmLl8gfHwge30sXG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IHNjYWxhclR5cGUgPSBzY2FsYXJUeXBlcy5maW5kKHQgPT4gdCBpbiBkZWYpO1xuICAgICAgICBpZiAoc2NhbGFyVHlwZSkge1xuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih0eXBlLCBkZWYpO1xuICAgICAgICAgICAgdHlwZVtzY2FsYXJUeXBlLnN1YnN0cigxKV0gPSBkZWZbc2NhbGFyVHlwZV07XG4gICAgICAgIH0gZWxzZSBpZiAoZGVmLl9yZWYpIHtcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odHlwZSwgdGhpcy50eXBlUmVmKChkZWY6IGFueSkpKTtcbiAgICAgICAgfSBlbHNlIGlmIChkZWYuX2FycmF5KSB7XG4gICAgICAgICAgICB0eXBlLmFycmF5ID0gdGhpcy5wYXJzZVR5cGVEZWYoZGVmLl9hcnJheSwgY29tYmluZU5hbWUobmFtZSwgJ2l0ZW0nKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoZGVmLl9zdHJ1Y3QpIHtcbiAgICAgICAgICAgIHR5cGUuc3RydWN0ID0gdGhpcy50eXBlZE5hbWVkTWVtYmVycyhkZWYuX3N0cnVjdCwgbmFtZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoZGVmLl91bmlvbikge1xuICAgICAgICAgICAgdHlwZS51bmlvbiA9IHRoaXMubmFtZWRNZW1iZXJzKGRlZi5fdW5pb24sIChtZW1iZXJOYW1lLCBtZW1iZXJEZWYpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbWVtYmVyRGVmLl92YWx1ZVxuICAgICAgICAgICAgICAgICAgICA/IG1lbWJlckRlZlxuICAgICAgICAgICAgICAgICAgICA6IHRoaXMucGFyc2VUeXBlRGVmKG1lbWJlckRlZiwgY29tYmluZU5hbWUobmFtZSwgbWVtYmVyTmFtZSkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAoZGVmLl9jbGFzcykge1xuICAgICAgICAgICAgY29uc3QgY2xhc3NEZWYgPSBkZWYuX2NsYXNzO1xuICAgICAgICAgICAgdHlwZS5jbGFzcyA9IHtcbiAgICAgICAgICAgICAgICB0eXBlczogY2xhc3NEZWYudHlwZXMgPyB0aGlzLnR5cGVkTmFtZWRNZW1iZXJzKGNsYXNzRGVmLnR5cGVzLCBuYW1lKSA6IFtdLFxuICAgICAgICAgICAgICAgIGZpZWxkczogY2xhc3NEZWYuZmllbGRzID8gdGhpcy50eXBlZE5hbWVkTWVtYmVycyhjbGFzc0RlZi5maWVsZHMsIG5hbWUpIDogW10sXG4gICAgICAgICAgICAgICAgZnVuY3Rpb25zOiBjbGFzc0RlZi5mdW5jdGlvbnMgPyB0aGlzLm5hbWVkTWVtYmVycyhjbGFzc0RlZi5mdW5jdGlvbnMsIChmdW5jdGlvbk5hbWUsIGZ1bmN0aW9uRGVmOiBGdW5jdGlvbkRlZikgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVmOiBmdW5jdGlvbkRlZixcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvYzogZnVuY3Rpb25EZWYuX2RvYyB8fCAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IGZ1bmN0aW9uRGVmLmFyZ3NcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHRoaXMudHlwZWROYW1lZE9yZGVyZWRNZW1iZXJzKGZ1bmN0aW9uRGVmLmFyZ3MsIGNvbWJpbmVOYW1lKG5hbWUsIGZ1bmN0aW9uTmFtZSkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBbXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDogZnVuY3Rpb25EZWYucmVzdWx0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPyB0aGlzLnBhcnNlVHlwZURlZihmdW5jdGlvbkRlZi5yZXN1bHQsIGNvbWJpbmVOYW1lKG5hbWUsICdSZXN1bHQnKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHsgZG9jOiAnJywgdm9pZDoge30gfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSkgOiBbXSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGRlZikpIHtcbiAgICAgICAgICAgIHR5cGUuc3RydWN0ID0gdGhpcy50eXBlZE5hbWVkTWVtYmVycygoZGVmOiBhbnkpLCBuYW1lKTtcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZGVmID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgY29uc3QgZmlsdGVyZWREZWYgPSB7fTtcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKGRlZikuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFpc1Jlc2VydmVkS2V5KGtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWREZWZba2V5XSA9IGRlZltrZXldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdHlwZS5zdHJ1Y3QgPSB0aGlzLnR5cGVkTmFtZWRNZW1iZXJzKChmaWx0ZXJlZERlZjogYW55KSwgbmFtZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnPj4+JywgbmFtZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5yZXNvbHZlVHlwZShuYW1lLCB0eXBlKTtcbiAgICAgICAgcmV0dXJuIHR5cGU7XG4gICAgfVxufVxuXG4iXX0=