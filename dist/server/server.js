"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createProviders = createProviders;
exports.default = void 0;

var _core = require("@tonclient/core");

var _libNode = require("@tonclient/lib-node");

var _fs = _interopRequireDefault(require("fs"));

var _express = _interopRequireDefault(require("express"));

var _http = _interopRequireDefault(require("http"));

var _path = _interopRequireDefault(require("path"));

var _apolloServerExpress = require("apollo-server-express");

var _subscriptionsTransportWs = require("subscriptions-transport-ws");

var _arangoProvider = require("./data/arango-provider");

var _blockchain = _interopRequireDefault(require("./data/blockchain"));

var _collection = require("./data/collection");

var _config = require("./config");

var _dataProvider = require("./data/data-provider");

var _memjsDatacache = require("./data/memjs-datacache");

var _aggregates = require("./graphql/aggregates");

var _counterparties = require("./graphql/counterparties");

var _explain = require("./graphql/explain");

var _info = require("./graphql/info");

var _postRequests = require("./graphql/post-requests");

var _resolversGenerated = require("./graphql/resolvers-generated");

var _access = require("./graphql/access");

var _mam = require("./graphql/mam");

var _totals = require("./graphql/totals");

var _logs = _interopRequireDefault(require("./logs"));

var _tracer = require("./tracer");

var _opentracing = require("opentracing");

var _auth = require("./auth");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const v8 = require('v8');

class MemStats {
  constructor(stats) {
    this.stats = stats;
  }

  report() {
    v8.getHeapSpaceStatistics().forEach(space => {
      const spaceName = space.space_name.replace('space_', '').replace('_space', '');

      const gauge = (metric, value) => {
        return this.stats.gauge(`heap.space.${spaceName}.${metric}`, value, []);
      };

      gauge('physical_size', space.physical_space_size);
      gauge('available_size', space.space_available_size);
      gauge('size', space.space_size);
      gauge('used_size', space.space_used_size);
    });
  }

  start() {//TODO: this.checkMemReport();
    //TODO: this.checkGc();
  }

  checkMemReport() {
    setTimeout(() => {
      this.report();
      this.checkMemReport();
    }, 5000);
  }

  checkGc() {
    setTimeout(() => {
      global.gc();
      this.checkGc();
    }, 60000);
  }

}

function createProviders(configName, logs, config, networkName, cacheKeyPrefix) {
  const newArangoProvider = (dbName, config) => new _arangoProvider.ArangoProvider(logs.create(`${configName}_${dbName}`), config);

  const mutable = newArangoProvider('mut', config.mut);
  const hot = newArangoProvider('hot', config.hot);
  const cacheLog = logs.create(`${configName}_cache`);
  const cold = new _dataProvider.QDataPrecachedCombiner(cacheLog, (0, _memjsDatacache.isCacheEnabled)(config.cache) ? new _memjsDatacache.MemjsDataCache(cacheLog, config.cache) : _dataProvider.missingDataCache, config.cold.map(x => newArangoProvider('cold', x)), networkName, cacheKeyPrefix);
  const immutable = new _dataProvider.QDataCombiner([hot, cold]);
  const counterparties = newArangoProvider('counterparties', config.counterparties);
  return {
    mutable,
    immutable,
    counterparties
  };
}

function isObject(test) {
  return typeof test === 'object' && test !== null;
}

function overrideObject(original, overrides) {
  Object.entries(overrides).forEach(([name, overrideValue]) => {
    if (name in original && isObject(overrideValue) && isObject(original[name])) {
      overrideObject(original[name], overrideValue);
    } else {
      original[name] = overrideValue;
    }
  });
}

class TONQServer {
  constructor(options) {
    this.config = options.config;
    this.logs = options.logs;
    this.log = this.logs.create('server');
    this.shared = new Map();
    this.tracer = _tracer.QTracer.create(options.config);
    this.stats = _tracer.QStats.create(options.config.statsd.server, options.config.statsd.tags, options.config.statsd.resetInterval);
    this.auth = new _auth.Auth(options.config);
    this.endPoints = [];
    this.app = (0, _express.default)();
    this.server = _http.default.createServer(this.app);
    this.data = options.data || new _blockchain.default({
      logs: this.logs,
      auth: this.auth,
      tracer: this.tracer,
      stats: this.stats,
      providers: createProviders('fast', this.logs, this.config.data, this.config.networkName, this.config.cacheKeyPrefix),
      slowQueriesProviders: createProviders('slow', this.logs, this.config.slowQueriesData, this.config.networkName, this.config.cacheKeyPrefix),
      isTests: false
    });
    this.memStats = new MemStats(this.stats);
    this.memStats.start();
    this.addEndPoint({
      path: '/graphql/mam',
      resolvers: _mam.mam,
      typeDefFileNames: ['type-defs-mam.graphql'],
      supportSubscriptions: false
    });
    const resolvers = (0, _resolversGenerated.createResolvers)(this.data);
    [_info.infoResolvers, _totals.totalsResolvers, (0, _aggregates.aggregatesResolvers)(this.data), (0, _explain.explainResolvers)(this.data), _postRequests.postRequestsResolvers, _access.accessResolvers, (0, _counterparties.counterpartiesResolvers)(this.data)].forEach(x => overrideObject(resolvers, x));
    this.addEndPoint({
      path: '/graphql',
      resolvers,
      typeDefFileNames: ['type-defs-generated.graphql', 'type-defs-custom.graphql', 'type-defs-counterparties.graphql'],
      supportSubscriptions: true
    });
  }

  async start() {
    _core.TonClient.useBinaryLibrary(_libNode.libNode);

    this.client = new _core.TonClient();
    await this.data.start();
    const {
      host,
      port
    } = this.config.server;
    this.server.listen({
      host,
      port
    }, () => {
      this.endPoints.forEach(endPoint => {
        this.log.debug('GRAPHQL', `http://${host}:${port}${endPoint.path}`);
      });
    });
    this.server.setTimeout(2147483647);
    const version = (0, _utils.packageJson)().version;
    const startCounter = new _tracer.StatsCounter(this.stats, _config.STATS.start, [`version:${version}`]);
    await startCounter.increment();
  }

  async stop() {
    await new Promise(resolve => this.server.close(() => resolve()));
    this.logs.stop();
  }

  addEndPoint(endPoint) {
    const typeDefs = endPoint.typeDefFileNames.map(x => _fs.default.readFileSync(_path.default.join('res', x), 'utf-8')).join('\n');
    const config = {
      debug: false,
      typeDefs,
      resolvers: endPoint.resolvers,
      subscriptions: {
        keepAlive: this.config.server.keepAlive,

        onDisconnect(_webSocket, context) {
          if (context.activeRequests) {
            context.activeRequests.forEach(x => x.emitClose());
            context.activeRequests = [];
          }
        },

        onConnect(connectionParams, _webSocket, context) {
          const activeRequests = [];
          context.activeRequests = activeRequests;
          return {
            activeRequests,
            accessKey: connectionParams.accessKey || connectionParams.accesskey
          };
        }

      },
      context: ({
        req,
        connection
      }) => {
        const request = new _collection.RequestController();

        if (req && req.on) {
          req.on('close', () => {
            request.emitClose();
          });
        }

        if (connection && connection.context) {
          if (!connection.context.activeRequests) {
            connection.context.activeRequests = [];
          }

          const activeRequests = connection.context.activeRequests;
          activeRequests.push(request);
          request.events.on(_collection.RequestEvent.FINISH, () => {
            const index = activeRequests.indexOf(request);

            if (index >= 0) {
              activeRequests.splice(index, 1);
            }
          });
        }

        return {
          data: this.data,
          tracer: this.tracer,
          stats: this.stats,
          auth: this.auth,
          client: this.client,
          config: this.config,
          shared: this.shared,
          remoteAddress: req && req.socket && req.socket.remoteAddress || '',
          accessKey: _auth.Auth.extractAccessKey(req, connection),
          parentSpan: _tracer.QTracer.extractParentSpan(this.tracer, connection ? connection : req),
          req,
          connection,
          request
        };
      },
      plugins: [{
        requestDidStart(_requestContext) {
          return {
            willSendResponse(ctx) {
              const context = ctx.context;

              if (context.multipleAccessKeysDetected) {
                throw _utils.QError.multipleAccessKeys();
              }
            }

          };
        }

      }]
    };
    const apollo = new _apolloServerExpress.ApolloServer(config);
    apollo.applyMiddleware({
      app: this.app,
      path: endPoint.path
    });

    if (endPoint.supportSubscriptions) {
      apollo.installSubscriptionHandlers(this.server);
    }

    this.endPoints.push(endPoint);
  }

}

exports.default = TONQServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvc2VydmVyLmpzIl0sIm5hbWVzIjpbInY4IiwicmVxdWlyZSIsIk1lbVN0YXRzIiwiY29uc3RydWN0b3IiLCJzdGF0cyIsInJlcG9ydCIsImdldEhlYXBTcGFjZVN0YXRpc3RpY3MiLCJmb3JFYWNoIiwic3BhY2UiLCJzcGFjZU5hbWUiLCJzcGFjZV9uYW1lIiwicmVwbGFjZSIsImdhdWdlIiwibWV0cmljIiwidmFsdWUiLCJwaHlzaWNhbF9zcGFjZV9zaXplIiwic3BhY2VfYXZhaWxhYmxlX3NpemUiLCJzcGFjZV9zaXplIiwic3BhY2VfdXNlZF9zaXplIiwic3RhcnQiLCJjaGVja01lbVJlcG9ydCIsInNldFRpbWVvdXQiLCJjaGVja0djIiwiZ2xvYmFsIiwiZ2MiLCJjcmVhdGVQcm92aWRlcnMiLCJjb25maWdOYW1lIiwibG9ncyIsImNvbmZpZyIsIm5ldHdvcmtOYW1lIiwiY2FjaGVLZXlQcmVmaXgiLCJuZXdBcmFuZ29Qcm92aWRlciIsImRiTmFtZSIsIkFyYW5nb1Byb3ZpZGVyIiwiY3JlYXRlIiwibXV0YWJsZSIsIm11dCIsImhvdCIsImNhY2hlTG9nIiwiY29sZCIsIlFEYXRhUHJlY2FjaGVkQ29tYmluZXIiLCJjYWNoZSIsIk1lbWpzRGF0YUNhY2hlIiwibWlzc2luZ0RhdGFDYWNoZSIsIm1hcCIsIngiLCJpbW11dGFibGUiLCJRRGF0YUNvbWJpbmVyIiwiY291bnRlcnBhcnRpZXMiLCJpc09iamVjdCIsInRlc3QiLCJvdmVycmlkZU9iamVjdCIsIm9yaWdpbmFsIiwib3ZlcnJpZGVzIiwiT2JqZWN0IiwiZW50cmllcyIsIm5hbWUiLCJvdmVycmlkZVZhbHVlIiwiVE9OUVNlcnZlciIsIm9wdGlvbnMiLCJsb2ciLCJzaGFyZWQiLCJNYXAiLCJ0cmFjZXIiLCJRVHJhY2VyIiwiUVN0YXRzIiwic3RhdHNkIiwic2VydmVyIiwidGFncyIsInJlc2V0SW50ZXJ2YWwiLCJhdXRoIiwiQXV0aCIsImVuZFBvaW50cyIsImFwcCIsImh0dHAiLCJjcmVhdGVTZXJ2ZXIiLCJkYXRhIiwiUUJsb2NrY2hhaW5EYXRhIiwicHJvdmlkZXJzIiwic2xvd1F1ZXJpZXNQcm92aWRlcnMiLCJzbG93UXVlcmllc0RhdGEiLCJpc1Rlc3RzIiwibWVtU3RhdHMiLCJhZGRFbmRQb2ludCIsInBhdGgiLCJyZXNvbHZlcnMiLCJtYW0iLCJ0eXBlRGVmRmlsZU5hbWVzIiwic3VwcG9ydFN1YnNjcmlwdGlvbnMiLCJpbmZvUmVzb2x2ZXJzIiwidG90YWxzUmVzb2x2ZXJzIiwicG9zdFJlcXVlc3RzUmVzb2x2ZXJzIiwiYWNjZXNzUmVzb2x2ZXJzIiwiVG9uQ2xpZW50IiwidXNlQmluYXJ5TGlicmFyeSIsImxpYk5vZGUiLCJjbGllbnQiLCJob3N0IiwicG9ydCIsImxpc3RlbiIsImVuZFBvaW50IiwiZGVidWciLCJ2ZXJzaW9uIiwic3RhcnRDb3VudGVyIiwiU3RhdHNDb3VudGVyIiwiU1RBVFMiLCJpbmNyZW1lbnQiLCJzdG9wIiwiUHJvbWlzZSIsInJlc29sdmUiLCJjbG9zZSIsInR5cGVEZWZzIiwiZnMiLCJyZWFkRmlsZVN5bmMiLCJqb2luIiwic3Vic2NyaXB0aW9ucyIsImtlZXBBbGl2ZSIsIm9uRGlzY29ubmVjdCIsIl93ZWJTb2NrZXQiLCJjb250ZXh0IiwiYWN0aXZlUmVxdWVzdHMiLCJlbWl0Q2xvc2UiLCJvbkNvbm5lY3QiLCJjb25uZWN0aW9uUGFyYW1zIiwiYWNjZXNzS2V5IiwiYWNjZXNza2V5IiwicmVxIiwiY29ubmVjdGlvbiIsInJlcXVlc3QiLCJSZXF1ZXN0Q29udHJvbGxlciIsIm9uIiwicHVzaCIsImV2ZW50cyIsIlJlcXVlc3RFdmVudCIsIkZJTklTSCIsImluZGV4IiwiaW5kZXhPZiIsInNwbGljZSIsInJlbW90ZUFkZHJlc3MiLCJzb2NrZXQiLCJleHRyYWN0QWNjZXNzS2V5IiwicGFyZW50U3BhbiIsImV4dHJhY3RQYXJlbnRTcGFuIiwicGx1Z2lucyIsInJlcXVlc3REaWRTdGFydCIsIl9yZXF1ZXN0Q29udGV4dCIsIndpbGxTZW5kUmVzcG9uc2UiLCJjdHgiLCJtdWx0aXBsZUFjY2Vzc0tleXNEZXRlY3RlZCIsIlFFcnJvciIsIm11bHRpcGxlQWNjZXNzS2V5cyIsImFwb2xsbyIsIkFwb2xsb1NlcnZlciIsImFwcGx5TWlkZGxld2FyZSIsImluc3RhbGxTdWJzY3JpcHRpb25IYW5kbGVycyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFpQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFwREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBcURBLE1BQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLElBQUQsQ0FBbEI7O0FBRUEsTUFBTUMsUUFBTixDQUFlO0FBR1hDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFnQjtBQUN2QixTQUFLQSxLQUFMLEdBQWFBLEtBQWI7QUFDSDs7QUFFREMsRUFBQUEsTUFBTSxHQUFHO0FBQ0xMLElBQUFBLEVBQUUsQ0FBQ00sc0JBQUgsR0FBNEJDLE9BQTVCLENBQXFDQyxLQUFELElBQVc7QUFDM0MsWUFBTUMsU0FBUyxHQUFHRCxLQUFLLENBQUNFLFVBQU4sQ0FDYkMsT0FEYSxDQUNMLFFBREssRUFDSyxFQURMLEVBRWJBLE9BRmEsQ0FFTCxRQUZLLEVBRUssRUFGTCxDQUFsQjs7QUFHQSxZQUFNQyxLQUFLLEdBQUcsQ0FBQ0MsTUFBRCxFQUFpQkMsS0FBakIsS0FBbUM7QUFDN0MsZUFBTyxLQUFLVixLQUFMLENBQVdRLEtBQVgsQ0FBa0IsY0FBYUgsU0FBVSxJQUFHSSxNQUFPLEVBQW5ELEVBQXNEQyxLQUF0RCxFQUE2RCxFQUE3RCxDQUFQO0FBQ0gs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QUEsTUFBTSxDQUFDRSxlQUFQLENBQXVCO0FBQ25CaEYsTUFBQUEsR0FBRyxFQUFFLEtBQUtBLEdBRFM7QUFFbkJXLE1BQUFBLElBQUksRUFBRWdCLFFBQVEsQ0FBQ2hCO0FBRkksS0FBdkI7O0FBSUEsUUFBSWdCLFFBQVEsQ0FBQ1osb0JBQWIsRUFBbUM7QUFDL0IrRCxNQUFBQSxNQUFNLENBQUNHLDJCQUFQLENBQW1DLEtBQUt2RixNQUF4QztBQUNIOztBQUNELFNBQUtLLFNBQUwsQ0FBZTJELElBQWYsQ0FBb0IvQixRQUFwQjtBQUNIOztBQXRMMkIiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTgtMjAyMCBUT04gREVWIFNPTFVUSU9OUyBMVEQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIFNPRlRXQVJFIEVWQUxVQVRJT04gTGljZW5zZSAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlXG4gKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGVcbiAqIExpY2Vuc2UgYXQ6XG4gKlxuICogaHR0cDovL3d3dy50b24uZGV2L2xpY2Vuc2VzXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBUT04gREVWIHNvZnR3YXJlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbi8vIEBmbG93XG5pbXBvcnQgeyBUb25DbGllbnQgfSBmcm9tICdAdG9uY2xpZW50L2NvcmUnO1xuaW1wb3J0IHsgbGliTm9kZSB9IGZyb20gXCJAdG9uY2xpZW50L2xpYi1ub2RlXCI7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgaHR0cCBmcm9tICdodHRwJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgeyBBcG9sbG9TZXJ2ZXIsIEFwb2xsb1NlcnZlckV4cHJlc3NDb25maWcgfSBmcm9tICdhcG9sbG8tc2VydmVyLWV4cHJlc3MnO1xuaW1wb3J0IHsgQ29ubmVjdGlvbkNvbnRleHQgfSBmcm9tICdzdWJzY3JpcHRpb25zLXRyYW5zcG9ydC13cyc7XG5pbXBvcnQgeyBBcmFuZ29Qcm92aWRlciB9IGZyb20gJy4vZGF0YS9hcmFuZ28tcHJvdmlkZXInO1xuaW1wb3J0IFFCbG9ja2NoYWluRGF0YSBmcm9tICcuL2RhdGEvYmxvY2tjaGFpbic7XG5pbXBvcnQgdHlwZSB7IFFEYXRhUHJvdmlkZXJzIH0gZnJvbSAnLi9kYXRhL2RhdGEnO1xuaW1wb3J0IHsgUmVxdWVzdENvbnRyb2xsZXIsIFJlcXVlc3RFdmVudCB9IGZyb20gJy4vZGF0YS9jb2xsZWN0aW9uJztcbmltcG9ydCB0eXBlIHsgR3JhcGhRTFJlcXVlc3RDb250ZXh0IH0gZnJvbSAnLi9kYXRhL2NvbGxlY3Rpb24nO1xuaW1wb3J0IHsgU1RBVFMgfSBmcm9tICcuL2NvbmZpZyc7XG5pbXBvcnQgeyBtaXNzaW5nRGF0YUNhY2hlLCBRRGF0YUNvbWJpbmVyLCBRRGF0YVByZWNhY2hlZENvbWJpbmVyIH0gZnJvbSAnLi9kYXRhL2RhdGEtcHJvdmlkZXInO1xuaW1wb3J0IHsgaXNDYWNoZUVuYWJsZWQsIE1lbWpzRGF0YUNhY2hlIH0gZnJvbSAnLi9kYXRhL21lbWpzLWRhdGFjYWNoZSc7XG5pbXBvcnQgeyBhZ2dyZWdhdGVzUmVzb2x2ZXJzIH0gZnJvbSBcIi4vZ3JhcGhxbC9hZ2dyZWdhdGVzXCI7XG5pbXBvcnQgeyBjb3VudGVycGFydGllc1Jlc29sdmVycyB9IGZyb20gXCIuL2dyYXBocWwvY291bnRlcnBhcnRpZXNcIjtcbmltcG9ydCB7IGV4cGxhaW5SZXNvbHZlcnMgfSBmcm9tIFwiLi9ncmFwaHFsL2V4cGxhaW5cIjtcbmltcG9ydCB7IGluZm9SZXNvbHZlcnMgfSBmcm9tIFwiLi9ncmFwaHFsL2luZm9cIjtcbmltcG9ydCB7IHBvc3RSZXF1ZXN0c1Jlc29sdmVycyB9IGZyb20gXCIuL2dyYXBocWwvcG9zdC1yZXF1ZXN0c1wiO1xuXG5pbXBvcnQgeyBjcmVhdGVSZXNvbHZlcnMgfSBmcm9tICcuL2dyYXBocWwvcmVzb2x2ZXJzLWdlbmVyYXRlZCc7XG5pbXBvcnQgeyBhY2Nlc3NSZXNvbHZlcnMgfSBmcm9tICcuL2dyYXBocWwvYWNjZXNzJztcbmltcG9ydCB7IG1hbSB9IGZyb20gJy4vZ3JhcGhxbC9tYW0nO1xuXG5pbXBvcnQgdHlwZSB7IFFBcmFuZ29Db25maWcsIFFDb25maWcsIFFEYXRhUHJvdmlkZXJzQ29uZmlnIH0gZnJvbSAnLi9jb25maWcnO1xuaW1wb3J0IHsgdG90YWxzUmVzb2x2ZXJzIH0gZnJvbSBcIi4vZ3JhcGhxbC90b3RhbHNcIjtcbmltcG9ydCBRTG9ncyBmcm9tICcuL2xvZ3MnO1xuaW1wb3J0IHR5cGUgeyBRTG9nIH0gZnJvbSAnLi9sb2dzJztcbmltcG9ydCB0eXBlIHsgSVN0YXRzIH0gZnJvbSAnLi90cmFjZXInO1xuaW1wb3J0IHsgUVN0YXRzLCBRVHJhY2VyLCBTdGF0c0NvdW50ZXIgfSBmcm9tICcuL3RyYWNlcic7XG5pbXBvcnQgeyBUcmFjZXIgfSBmcm9tICdvcGVudHJhY2luZyc7XG5pbXBvcnQgeyBBdXRoIH0gZnJvbSAnLi9hdXRoJztcbmltcG9ydCB7IHBhY2thZ2VKc29uLCBRRXJyb3IgfSBmcm9tICcuL3V0aWxzJztcblxudHlwZSBRT3B0aW9ucyA9IHtcbiAgICBjb25maWc6IFFDb25maWcsXG4gICAgbG9nczogUUxvZ3MsXG4gICAgZGF0YT86IFFCbG9ja2NoYWluRGF0YSxcbn1cblxudHlwZSBFbmRQb2ludCA9IHtcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgcmVzb2x2ZXJzOiBhbnksXG4gICAgdHlwZURlZkZpbGVOYW1lczogc3RyaW5nW10sXG4gICAgc3VwcG9ydFN1YnNjcmlwdGlvbnM6IGJvb2xlYW4sXG59XG5cbmNvbnN0IHY4ID0gcmVxdWlyZSgndjgnKTtcblxuY2xhc3MgTWVtU3RhdHMge1xuICAgIHN0YXRzOiBJU3RhdHM7XG5cbiAgICBjb25zdHJ1Y3RvcihzdGF0czogSVN0YXRzKSB7XG4gICAgICAgIHRoaXMuc3RhdHMgPSBzdGF0cztcbiAgICB9XG5cbiAgICByZXBvcnQoKSB7XG4gICAgICAgIHY4LmdldEhlYXBTcGFjZVN0YXRpc3RpY3MoKS5mb3JFYWNoKChzcGFjZSkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc3BhY2VOYW1lID0gc3BhY2Uuc3BhY2VfbmFtZVxuICAgICAgICAgICAgICAgIC5yZXBsYWNlKCdzcGFjZV8nLCAnJylcbiAgICAgICAgICAgICAgICAucmVwbGFjZSgnX3NwYWNlJywgJycpO1xuICAgICAgICAgICAgY29uc3QgZ2F1Z2UgPSAobWV0cmljOiBzdHJpbmcsIHZhbHVlOiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdGF0cy5nYXVnZShgaGVhcC5zcGFjZS4ke3NwYWNlTmFtZX0uJHttZXRyaWN9YCwgdmFsdWUsIFtdKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBnYXVnZSgncGh5c2ljYWxfc2l6ZScsIHNwYWNlLnBoeXNpY2FsX3NwYWNlX3NpemUpO1xuICAgICAgICAgICAgZ2F1Z2UoJ2F2YWlsYWJsZV9zaXplJywgc3BhY2Uuc3BhY2VfYXZhaWxhYmxlX3NpemUpO1xuICAgICAgICAgICAgZ2F1Z2UoJ3NpemUnLCBzcGFjZS5zcGFjZV9zaXplKTtcbiAgICAgICAgICAgIGdhdWdlKCd1c2VkX3NpemUnLCBzcGFjZS5zcGFjZV91c2VkX3NpemUpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBzdGFydCgpIHtcbiAgICAgICAgLy9UT0RPOiB0aGlzLmNoZWNrTWVtUmVwb3J0KCk7XG4gICAgICAgIC8vVE9ETzogdGhpcy5jaGVja0djKCk7XG4gICAgfVxuXG4gICAgY2hlY2tNZW1SZXBvcnQoKSB7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZXBvcnQoKTtcbiAgICAgICAgICAgIHRoaXMuY2hlY2tNZW1SZXBvcnQoKTtcbiAgICAgICAgfSwgNTAwMCk7XG4gICAgfVxuXG4gICAgY2hlY2tHYygpIHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICBnbG9iYWwuZ2MoKTtcbiAgICAgICAgICAgIHRoaXMuY2hlY2tHYygpO1xuICAgICAgICB9LCA2MDAwMCk7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlUHJvdmlkZXJzKGNvbmZpZ05hbWU6IHN0cmluZywgbG9nczogUUxvZ3MsIGNvbmZpZzogUURhdGFQcm92aWRlcnNDb25maWcsIG5ldHdvcmtOYW1lOiBzdHJpbmcsIGNhY2hlS2V5UHJlZml4OiBzdHJpbmcpOiBRRGF0YVByb3ZpZGVycyB7XG4gICAgY29uc3QgbmV3QXJhbmdvUHJvdmlkZXIgPSAoZGJOYW1lOiBzdHJpbmcsIGNvbmZpZzogUUFyYW5nb0NvbmZpZyk6IEFyYW5nb1Byb3ZpZGVyID0+IChcbiAgICAgICAgbmV3IEFyYW5nb1Byb3ZpZGVyKGxvZ3MuY3JlYXRlKGAke2NvbmZpZ05hbWV9XyR7ZGJOYW1lfWApLCBjb25maWcpXG4gICAgKTtcbiAgICBjb25zdCBtdXRhYmxlID0gbmV3QXJhbmdvUHJvdmlkZXIoJ211dCcsIGNvbmZpZy5tdXQpO1xuICAgIGNvbnN0IGhvdCA9IG5ld0FyYW5nb1Byb3ZpZGVyKCdob3QnLCBjb25maWcuaG90KTtcbiAgICBjb25zdCBjYWNoZUxvZyA9IGxvZ3MuY3JlYXRlKGAke2NvbmZpZ05hbWV9X2NhY2hlYCk7XG4gICAgY29uc3QgY29sZCA9IG5ldyBRRGF0YVByZWNhY2hlZENvbWJpbmVyKFxuICAgICAgICBjYWNoZUxvZyxcbiAgICAgICAgaXNDYWNoZUVuYWJsZWQoY29uZmlnLmNhY2hlKSA/IG5ldyBNZW1qc0RhdGFDYWNoZShjYWNoZUxvZywgY29uZmlnLmNhY2hlKSA6IG1pc3NpbmdEYXRhQ2FjaGUsXG4gICAgICAgIGNvbmZpZy5jb2xkLm1hcCh4ID0+IG5ld0FyYW5nb1Byb3ZpZGVyKCdjb2xkJywgeCkpLFxuICAgICAgICBuZXR3b3JrTmFtZSxcbiAgICAgICAgY2FjaGVLZXlQcmVmaXgsXG4gICAgKTtcbiAgICBjb25zdCBpbW11dGFibGUgPSBuZXcgUURhdGFDb21iaW5lcihbaG90LCBjb2xkXSk7XG4gICAgY29uc3QgY291bnRlcnBhcnRpZXMgPSBuZXdBcmFuZ29Qcm92aWRlcignY291bnRlcnBhcnRpZXMnLCBjb25maWcuY291bnRlcnBhcnRpZXMpO1xuICAgIHJldHVybiB7XG4gICAgICAgIG11dGFibGUsXG4gICAgICAgIGltbXV0YWJsZSxcbiAgICAgICAgY291bnRlcnBhcnRpZXMsXG4gICAgfTtcbn1cblxuZnVuY3Rpb24gaXNPYmplY3QodGVzdDogYW55KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHR5cGVvZiB0ZXN0ID09PSAnb2JqZWN0JyAmJiB0ZXN0ICE9PSBudWxsO1xufVxuXG5mdW5jdGlvbiBvdmVycmlkZU9iamVjdChvcmlnaW5hbDogYW55LCBvdmVycmlkZXM6IGFueSkge1xuICAgIE9iamVjdC5lbnRyaWVzKG92ZXJyaWRlcykuZm9yRWFjaCgoW25hbWUsIG92ZXJyaWRlVmFsdWVdKSA9PiB7XG4gICAgICAgIGlmICgobmFtZSBpbiBvcmlnaW5hbCkgJiYgaXNPYmplY3Qob3ZlcnJpZGVWYWx1ZSkgJiYgaXNPYmplY3Qob3JpZ2luYWxbbmFtZV0pKSB7XG4gICAgICAgICAgICBvdmVycmlkZU9iamVjdChvcmlnaW5hbFtuYW1lXSwgb3ZlcnJpZGVWYWx1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvcmlnaW5hbFtuYW1lXSA9IG92ZXJyaWRlVmFsdWU7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVE9OUVNlcnZlciB7XG4gICAgY29uZmlnOiBRQ29uZmlnO1xuICAgIGxvZ3M6IFFMb2dzO1xuICAgIGxvZzogUUxvZztcbiAgICBhcHA6IGV4cHJlc3MuQXBwbGljYXRpb247XG4gICAgc2VydmVyOiBhbnk7XG4gICAgZW5kUG9pbnRzOiBFbmRQb2ludFtdO1xuICAgIGRhdGE6IFFCbG9ja2NoYWluRGF0YTtcbiAgICB0cmFjZXI6IFRyYWNlcjtcbiAgICBzdGF0czogSVN0YXRzO1xuICAgIGNsaWVudDogVG9uQ2xpZW50O1xuICAgIGF1dGg6IEF1dGg7XG4gICAgbWVtU3RhdHM6IE1lbVN0YXRzO1xuICAgIHNoYXJlZDogTWFwPHN0cmluZywgYW55PjtcblxuXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczogUU9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5jb25maWcgPSBvcHRpb25zLmNvbmZpZztcbiAgICAgICAgdGhpcy5sb2dzID0gb3B0aW9ucy5sb2dzO1xuICAgICAgICB0aGlzLmxvZyA9IHRoaXMubG9ncy5jcmVhdGUoJ3NlcnZlcicpO1xuICAgICAgICB0aGlzLnNoYXJlZCA9IG5ldyBNYXAoKTtcbiAgICAgICAgdGhpcy50cmFjZXIgPSBRVHJhY2VyLmNyZWF0ZShvcHRpb25zLmNvbmZpZyk7XG4gICAgICAgIHRoaXMuc3RhdHMgPSBRU3RhdHMuY3JlYXRlKFxuICAgICAgICAgICAgb3B0aW9ucy5jb25maWcuc3RhdHNkLnNlcnZlcixcbiAgICAgICAgICAgIG9wdGlvbnMuY29uZmlnLnN0YXRzZC50YWdzLFxuICAgICAgICAgICAgb3B0aW9ucy5jb25maWcuc3RhdHNkLnJlc2V0SW50ZXJ2YWwsXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuYXV0aCA9IG5ldyBBdXRoKG9wdGlvbnMuY29uZmlnKTtcbiAgICAgICAgdGhpcy5lbmRQb2ludHMgPSBbXTtcbiAgICAgICAgdGhpcy5hcHAgPSBleHByZXNzKCk7XG4gICAgICAgIHRoaXMuc2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIodGhpcy5hcHApO1xuICAgICAgICB0aGlzLmRhdGEgPSBvcHRpb25zLmRhdGEgfHwgbmV3IFFCbG9ja2NoYWluRGF0YSh7XG4gICAgICAgICAgICBsb2dzOiB0aGlzLmxvZ3MsXG4gICAgICAgICAgICBhdXRoOiB0aGlzLmF1dGgsXG4gICAgICAgICAgICB0cmFjZXI6IHRoaXMudHJhY2VyLFxuICAgICAgICAgICAgc3RhdHM6IHRoaXMuc3RhdHMsXG4gICAgICAgICAgICBwcm92aWRlcnM6IGNyZWF0ZVByb3ZpZGVycygnZmFzdCcsIHRoaXMubG9ncywgdGhpcy5jb25maWcuZGF0YSwgdGhpcy5jb25maWcubmV0d29ya05hbWUsIHRoaXMuY29uZmlnLmNhY2hlS2V5UHJlZml4KSxcbiAgICAgICAgICAgIHNsb3dRdWVyaWVzUHJvdmlkZXJzOiBjcmVhdGVQcm92aWRlcnMoJ3Nsb3cnLCB0aGlzLmxvZ3MsIHRoaXMuY29uZmlnLnNsb3dRdWVyaWVzRGF0YSwgdGhpcy5jb25maWcubmV0d29ya05hbWUsIHRoaXMuY29uZmlnLmNhY2hlS2V5UHJlZml4KSxcbiAgICAgICAgICAgIGlzVGVzdHM6IGZhbHNlLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5tZW1TdGF0cyA9IG5ldyBNZW1TdGF0cyh0aGlzLnN0YXRzKTtcbiAgICAgICAgdGhpcy5tZW1TdGF0cy5zdGFydCgpO1xuICAgICAgICB0aGlzLmFkZEVuZFBvaW50KHtcbiAgICAgICAgICAgIHBhdGg6ICcvZ3JhcGhxbC9tYW0nLFxuICAgICAgICAgICAgcmVzb2x2ZXJzOiBtYW0sXG4gICAgICAgICAgICB0eXBlRGVmRmlsZU5hbWVzOiBbJ3R5cGUtZGVmcy1tYW0uZ3JhcGhxbCddLFxuICAgICAgICAgICAgc3VwcG9ydFN1YnNjcmlwdGlvbnM6IGZhbHNlLFxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgcmVzb2x2ZXJzID0gY3JlYXRlUmVzb2x2ZXJzKHRoaXMuZGF0YSk7XG4gICAgICAgIFtcbiAgICAgICAgICAgIGluZm9SZXNvbHZlcnMsXG4gICAgICAgICAgICB0b3RhbHNSZXNvbHZlcnMsXG4gICAgICAgICAgICBhZ2dyZWdhdGVzUmVzb2x2ZXJzKHRoaXMuZGF0YSksXG4gICAgICAgICAgICBleHBsYWluUmVzb2x2ZXJzKHRoaXMuZGF0YSksXG4gICAgICAgICAgICBwb3N0UmVxdWVzdHNSZXNvbHZlcnMsXG4gICAgICAgICAgICBhY2Nlc3NSZXNvbHZlcnMsXG4gICAgICAgICAgICBjb3VudGVycGFydGllc1Jlc29sdmVycyh0aGlzLmRhdGEpLFxuICAgICAgICBdLmZvckVhY2goeCA9PiBvdmVycmlkZU9iamVjdChyZXNvbHZlcnMsIHgpKTtcbiAgICAgICAgdGhpcy5hZGRFbmRQb2ludCh7XG4gICAgICAgICAgICBwYXRoOiAnL2dyYXBocWwnLFxuICAgICAgICAgICAgcmVzb2x2ZXJzLFxuICAgICAgICAgICAgdHlwZURlZkZpbGVOYW1lczogW1xuICAgICAgICAgICAgICAgICd0eXBlLWRlZnMtZ2VuZXJhdGVkLmdyYXBocWwnLFxuICAgICAgICAgICAgICAgICd0eXBlLWRlZnMtY3VzdG9tLmdyYXBocWwnLFxuICAgICAgICAgICAgICAgICd0eXBlLWRlZnMtY291bnRlcnBhcnRpZXMuZ3JhcGhxbCcsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgc3VwcG9ydFN1YnNjcmlwdGlvbnM6IHRydWUsXG4gICAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgYXN5bmMgc3RhcnQoKSB7XG4gICAgICAgIFRvbkNsaWVudC51c2VCaW5hcnlMaWJyYXJ5KGxpYk5vZGUpO1xuICAgICAgICB0aGlzLmNsaWVudCA9IG5ldyBUb25DbGllbnQoKTtcbiAgICAgICAgYXdhaXQgdGhpcy5kYXRhLnN0YXJ0KCk7XG4gICAgICAgIGNvbnN0IHsgaG9zdCwgcG9ydCB9ID0gdGhpcy5jb25maWcuc2VydmVyO1xuICAgICAgICB0aGlzLnNlcnZlci5saXN0ZW4oe1xuICAgICAgICAgICAgaG9zdCxcbiAgICAgICAgICAgIHBvcnQsXG4gICAgICAgIH0sICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZW5kUG9pbnRzLmZvckVhY2goKGVuZFBvaW50OiBFbmRQb2ludCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCdHUkFQSFFMJywgYGh0dHA6Ly8ke2hvc3R9OiR7cG9ydH0ke2VuZFBvaW50LnBhdGh9YCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc2VydmVyLnNldFRpbWVvdXQoMjE0NzQ4MzY0Nyk7XG5cbiAgICAgICAgY29uc3QgdmVyc2lvbiA9IHBhY2thZ2VKc29uKCkudmVyc2lvbjtcbiAgICAgICAgY29uc3Qgc3RhcnRDb3VudGVyID0gbmV3IFN0YXRzQ291bnRlcih0aGlzLnN0YXRzLCBTVEFUUy5zdGFydCwgW2B2ZXJzaW9uOiR7dmVyc2lvbn1gXSk7XG4gICAgICAgIGF3YWl0IHN0YXJ0Q291bnRlci5pbmNyZW1lbnQoKVxuICAgIH1cblxuXG4gICAgYXN5bmMgc3RvcCgpIHtcbiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHRoaXMuc2VydmVyLmNsb3NlKCgpID0+IHJlc29sdmUoKSkpO1xuICAgICAgICB0aGlzLmxvZ3Muc3RvcCgpO1xuICAgIH1cblxuICAgIGFkZEVuZFBvaW50KGVuZFBvaW50OiBFbmRQb2ludCkge1xuICAgICAgICBjb25zdCB0eXBlRGVmcyA9IGVuZFBvaW50LnR5cGVEZWZGaWxlTmFtZXNcbiAgICAgICAgICAgIC5tYXAoeCA9PiBmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKCdyZXMnLCB4KSwgJ3V0Zi04JykpXG4gICAgICAgICAgICAuam9pbignXFxuJyk7XG4gICAgICAgIGNvbnN0IGNvbmZpZzogQXBvbGxvU2VydmVyRXhwcmVzc0NvbmZpZyA9IHtcbiAgICAgICAgICAgIGRlYnVnOiBmYWxzZSxcbiAgICAgICAgICAgIHR5cGVEZWZzLFxuICAgICAgICAgICAgcmVzb2x2ZXJzOiBlbmRQb2ludC5yZXNvbHZlcnMsXG4gICAgICAgICAgICBzdWJzY3JpcHRpb25zOiB7XG4gICAgICAgICAgICAgICAga2VlcEFsaXZlOiB0aGlzLmNvbmZpZy5zZXJ2ZXIua2VlcEFsaXZlLFxuICAgICAgICAgICAgICAgIG9uRGlzY29ubmVjdChfd2ViU29ja2V0OiBXZWJTb2NrZXQsIGNvbnRleHQ6IENvbm5lY3Rpb25Db250ZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0LmFjdGl2ZVJlcXVlc3RzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmFjdGl2ZVJlcXVlc3RzLmZvckVhY2goeCA9PiB4LmVtaXRDbG9zZSgpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQuYWN0aXZlUmVxdWVzdHMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgb25Db25uZWN0KGNvbm5lY3Rpb25QYXJhbXM6IE9iamVjdCwgX3dlYlNvY2tldDogV2ViU29ja2V0LCBjb250ZXh0OiBDb25uZWN0aW9uQ29udGV4dCk6IGFueSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2ZVJlcXVlc3RzID0gW107XG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQuYWN0aXZlUmVxdWVzdHMgPSBhY3RpdmVSZXF1ZXN0cztcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZVJlcXVlc3RzLFxuICAgICAgICAgICAgICAgICAgICAgICAgYWNjZXNzS2V5OiBjb25uZWN0aW9uUGFyYW1zLmFjY2Vzc0tleSB8fCBjb25uZWN0aW9uUGFyYW1zLmFjY2Vzc2tleSxcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgY29udGV4dDogKHsgcmVxLCBjb25uZWN0aW9uIH0pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXF1ZXN0ID0gbmV3IFJlcXVlc3RDb250cm9sbGVyKCk7XG4gICAgICAgICAgICAgICAgaWYgKHJlcSAmJiByZXEub24pIHtcbiAgICAgICAgICAgICAgICAgICAgcmVxLm9uKCdjbG9zZScsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3QuZW1pdENsb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoY29ubmVjdGlvbiAmJiBjb25uZWN0aW9uLmNvbnRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjb25uZWN0aW9uLmNvbnRleHQuYWN0aXZlUmVxdWVzdHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24uY29udGV4dC5hY3RpdmVSZXF1ZXN0cyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2ZVJlcXVlc3RzID0gY29ubmVjdGlvbi5jb250ZXh0LmFjdGl2ZVJlcXVlc3RzO1xuICAgICAgICAgICAgICAgICAgICBhY3RpdmVSZXF1ZXN0cy5wdXNoKHJlcXVlc3QpO1xuICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LmV2ZW50cy5vbihSZXF1ZXN0RXZlbnQuRklOSVNILCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IGFjdGl2ZVJlcXVlc3RzLmluZGV4T2YocmVxdWVzdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZVJlcXVlc3RzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBkYXRhOiB0aGlzLmRhdGEsXG4gICAgICAgICAgICAgICAgICAgIHRyYWNlcjogdGhpcy50cmFjZXIsXG4gICAgICAgICAgICAgICAgICAgIHN0YXRzOiB0aGlzLnN0YXRzLFxuICAgICAgICAgICAgICAgICAgICBhdXRoOiB0aGlzLmF1dGgsXG4gICAgICAgICAgICAgICAgICAgIGNsaWVudDogdGhpcy5jbGllbnQsXG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZzogdGhpcy5jb25maWcsXG4gICAgICAgICAgICAgICAgICAgIHNoYXJlZDogdGhpcy5zaGFyZWQsXG4gICAgICAgICAgICAgICAgICAgIHJlbW90ZUFkZHJlc3M6IChyZXEgJiYgcmVxLnNvY2tldCAmJiByZXEuc29ja2V0LnJlbW90ZUFkZHJlc3MpIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICBhY2Nlc3NLZXk6IEF1dGguZXh0cmFjdEFjY2Vzc0tleShyZXEsIGNvbm5lY3Rpb24pLFxuICAgICAgICAgICAgICAgICAgICBwYXJlbnRTcGFuOiBRVHJhY2VyLmV4dHJhY3RQYXJlbnRTcGFuKHRoaXMudHJhY2VyLCBjb25uZWN0aW9uID8gY29ubmVjdGlvbiA6IHJlcSksXG4gICAgICAgICAgICAgICAgICAgIHJlcSxcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbixcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdCxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHBsdWdpbnM6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3REaWRTdGFydChfcmVxdWVzdENvbnRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lsbFNlbmRSZXNwb25zZShjdHgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0ID0gY3R4LmNvbnRleHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0Lm11bHRpcGxlQWNjZXNzS2V5c0RldGVjdGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBRRXJyb3IubXVsdGlwbGVBY2Nlc3NLZXlzKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBhcG9sbG8gPSBuZXcgQXBvbGxvU2VydmVyKGNvbmZpZyk7XG4gICAgICAgIGFwb2xsby5hcHBseU1pZGRsZXdhcmUoe1xuICAgICAgICAgICAgYXBwOiB0aGlzLmFwcCxcbiAgICAgICAgICAgIHBhdGg6IGVuZFBvaW50LnBhdGgsXG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoZW5kUG9pbnQuc3VwcG9ydFN1YnNjcmlwdGlvbnMpIHtcbiAgICAgICAgICAgIGFwb2xsby5pbnN0YWxsU3Vic2NyaXB0aW9uSGFuZGxlcnModGhpcy5zZXJ2ZXIpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZW5kUG9pbnRzLnB1c2goZW5kUG9pbnQpO1xuICAgIH1cblxuXG59XG4iXX0=