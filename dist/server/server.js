"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _express = _interopRequireDefault(require("express"));

var _http = _interopRequireDefault(require("http"));

var _apolloServerExpress = require("apollo-server-express");

var _subscriptionsTransportWs = require("subscriptions-transport-ws");

var _tonClientNodeJs = require("ton-client-node-js");

var _arango = _interopRequireDefault(require("./arango"));

var _resolversGenerated = require("./resolvers-generated");

var _resolversCustom = require("./resolvers-custom");

var _resolversMam = require("./resolvers-mam");

var _logs = _interopRequireDefault(require("./logs"));

var _tracer = require("./tracer");

var _opentracing = require("opentracing");

var _auth = require("./auth");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
class TONQServer {
  constructor(options) {
    this.config = options.config;
    this.logs = options.logs;
    this.log = this.logs.create('server');
    this.shared = new Map();
    this.tracer = _tracer.QTracer.create(options.config);
    this.stats = _tracer.QStats.create(options.config.statsd.server);
    this.auth = new _auth.Auth(options.config);
    this.endPoints = [];
    this.app = (0, _express.default)();
    this.server = _http.default.createServer(this.app);
    this.db = new _arango.default(this.config, this.logs, this.auth, this.tracer, this.stats);
    this.addEndPoint({
      path: '/graphql/mam',
      resolvers: _resolversMam.resolversMam,
      typeDefFileNames: ['type-defs-mam.graphql'],
      supportSubscriptions: false
    });
    this.addEndPoint({
      path: '/graphql',
      resolvers: (0, _resolversCustom.attachCustomResolvers)((0, _resolversGenerated.createResolvers)(this.db)),
      typeDefFileNames: ['type-defs-generated.graphql', 'type-defs-custom.graphql'],
      supportSubscriptions: true
    });
  }

  async start() {
    this.client = await _tonClientNodeJs.TONClient.create({
      servers: ['']
    });
    await this.db.start();
    const {
      host,
      port
    } = this.config.server;
    this.server.listen({
      host,
      port
    }, () => {
      this.endPoints.forEach(endPoint => {
        this.log.debug('GRAPHQL', `http://${host}:${port}${endPoint.path}`);
      });
    });
    this.server.setTimeout(2147483647);
  }

  addEndPoint(endPoint) {
    const typeDefs = endPoint.typeDefFileNames.map(x => _fs.default.readFileSync(x, 'utf-8')).join('\n');
    const config = {
      typeDefs,
      resolvers: endPoint.resolvers,
      subscriptions: {
        onConnect(connectionParams, _websocket, _context) {
          return {
            accessKey: connectionParams.accessKey || connectionParams.accesskey
          };
        }

      },
      context: ({
        req,
        connection
      }) => {
        return {
          db: this.db,
          tracer: this.tracer,
          stats: this.stats,
          auth: this.auth,
          client: this.client,
          config: this.config,
          shared: this.shared,
          remoteAddress: req && req.socket && req.socket.remoteAddress || '',
          accessKey: _auth.Auth.extractAccessKey(req, connection),
          parentSpan: _tracer.QTracer.extractParentSpan(this.tracer, connection ? connection : req)
        };
      },
      plugins: [{
        requestDidStart(_requestContext) {
          return {
            willSendResponse(ctx) {
              const context = ctx.context;

              if (context.multipleAccessKeysDetected) {
                throw (0, _utils.createError)(400, 'Request must use the same access key for all queries and mutations');
              }
            }

          };
        }

      }]
    };
    const apollo = new _apolloServerExpress.ApolloServer(config);
    apollo.applyMiddleware({
      app: this.app,
      path: endPoint.path
    });

    if (endPoint.supportSubscriptions) {
      apollo.installSubscriptionHandlers(this.server);
    }

    this.endPoints.push(endPoint);
  }

}

exports.default = TONQServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9zZXJ2ZXIuanMiXSwibmFtZXMiOlsiVE9OUVNlcnZlciIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImNvbmZpZyIsImxvZ3MiLCJsb2ciLCJjcmVhdGUiLCJzaGFyZWQiLCJNYXAiLCJ0cmFjZXIiLCJRVHJhY2VyIiwic3RhdHMiLCJRU3RhdHMiLCJzdGF0c2QiLCJzZXJ2ZXIiLCJhdXRoIiwiQXV0aCIsImVuZFBvaW50cyIsImFwcCIsImh0dHAiLCJjcmVhdGVTZXJ2ZXIiLCJkYiIsIkFyYW5nbyIsImFkZEVuZFBvaW50IiwicGF0aCIsInJlc29sdmVycyIsInJlc29sdmVyc01hbSIsInR5cGVEZWZGaWxlTmFtZXMiLCJzdXBwb3J0U3Vic2NyaXB0aW9ucyIsInN0YXJ0IiwiY2xpZW50IiwiVE9OQ2xpZW50Tm9kZUpzIiwic2VydmVycyIsImhvc3QiLCJwb3J0IiwibGlzdGVuIiwiZm9yRWFjaCIsImVuZFBvaW50IiwiZGVidWciLCJzZXRUaW1lb3V0IiwidHlwZURlZnMiLCJtYXAiLCJ4IiwiZnMiLCJyZWFkRmlsZVN5bmMiLCJqb2luIiwic3Vic2NyaXB0aW9ucyIsIm9uQ29ubmVjdCIsImNvbm5lY3Rpb25QYXJhbXMiLCJfd2Vic29ja2V0IiwiX2NvbnRleHQiLCJhY2Nlc3NLZXkiLCJhY2Nlc3NrZXkiLCJjb250ZXh0IiwicmVxIiwiY29ubmVjdGlvbiIsInJlbW90ZUFkZHJlc3MiLCJzb2NrZXQiLCJleHRyYWN0QWNjZXNzS2V5IiwicGFyZW50U3BhbiIsImV4dHJhY3RQYXJlbnRTcGFuIiwicGx1Z2lucyIsInJlcXVlc3REaWRTdGFydCIsIl9yZXF1ZXN0Q29udGV4dCIsIndpbGxTZW5kUmVzcG9uc2UiLCJjdHgiLCJtdWx0aXBsZUFjY2Vzc0tleXNEZXRlY3RlZCIsImFwb2xsbyIsIkFwb2xsb1NlcnZlciIsImFwcGx5TWlkZGxld2FyZSIsImluc3RhbGxTdWJzY3JpcHRpb25IYW5kbGVycyIsInB1c2giXSwibWFwcGlu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RTtBQVZULFNBQVA7QUFZSCxPQXZCcUM7QUF3QnRDTyxNQUFBQSxPQUFPLEVBQUUsQ0FDTDtBQUNJQyxRQUFBQSxlQUFlLENBQUNDLGVBQUQsRUFBa0I7QUFDN0IsaUJBQU87QUFDSEMsWUFBQUEsZ0JBQWdCLENBQUNDLEdBQUQsRUFBTTtBQUNsQixvQkFBTVosT0FBOEIsR0FBR1ksR0FBRyxDQUFDWixPQUEzQzs7QUFDQSxrQkFBSUEsT0FBTyxDQUFDYSwwQkFBWixFQUF3QztBQUNwQyxzQkFBTSx3QkFDRixHQURFLEVBRUYsb0VBRkUsQ0FBTjtBQUlIO0FBQ0o7O0FBVEUsV0FBUDtBQVdIOztBQWJMLE9BREs7QUF4QjZCLEtBQTFDO0FBMENBLFVBQU1DLE1BQU0sR0FBRyxJQUFJQyxpQ0FBSixDQUFpQmpFLE1BQWpCLENBQWY7QUFDQWdFLElBQUFBLE1BQU0sQ0FBQ0UsZUFBUCxDQUF1QjtBQUFFbkQsTUFBQUEsR0FBRyxFQUFFLEtBQUtBLEdBQVo7QUFBaUJNLE1BQUFBLElBQUksRUFBRWEsUUFBUSxDQUFDYjtBQUFoQyxLQUF2Qjs7QUFDQSxRQUFJYSxRQUFRLENBQUNULG9CQUFiLEVBQW1DO0FBQy9CdUMsTUFBQUEsTUFBTSxDQUFDRywyQkFBUCxDQUFtQyxLQUFLeEQsTUFBeEM7QUFDSDs7QUFDRCxTQUFLRyxTQUFMLENBQWVzRCxJQUFmLENBQW9CbEMsUUFBcEI7QUFDSDs7QUEzRzJCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE4LTIwMjAgVE9OIERFViBTT0xVVElPTlMgTFRELlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBTT0ZUV0FSRSBFVkFMVUFUSU9OIExpY2Vuc2UgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZVxuICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlXG4gKiBMaWNlbnNlIGF0OlxuICpcbiAqIGh0dHA6Ly93d3cudG9uLmRldi9saWNlbnNlc1xuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgVE9OIERFViBzb2Z0d2FyZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vLyBAZmxvd1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IGh0dHAgZnJvbSAnaHR0cCc7XG5cbmltcG9ydCB7IEFwb2xsb1NlcnZlciwgQXBvbGxvU2VydmVyRXhwcmVzc0NvbmZpZyB9IGZyb20gJ2Fwb2xsby1zZXJ2ZXItZXhwcmVzcyc7XG5pbXBvcnQgeyBDb25uZWN0aW9uQ29udGV4dCB9IGZyb20gJ3N1YnNjcmlwdGlvbnMtdHJhbnNwb3J0LXdzJztcbmltcG9ydCB0eXBlIHsgVE9OQ2xpZW50IH0gZnJvbSBcInRvbi1jbGllbnQtanMvdHlwZXNcIjtcbmltcG9ydCB7IFRPTkNsaWVudCBhcyBUT05DbGllbnROb2RlSnMgfSBmcm9tICd0b24tY2xpZW50LW5vZGUtanMnO1xuaW1wb3J0IEFyYW5nbyBmcm9tICcuL2FyYW5nbyc7XG5pbXBvcnQgdHlwZSB7IEdyYXBoUUxSZXF1ZXN0Q29udGV4dCB9IGZyb20gXCIuL2FyYW5nby1jb2xsZWN0aW9uXCI7XG5cbmltcG9ydCB7IGNyZWF0ZVJlc29sdmVycyB9IGZyb20gJy4vcmVzb2x2ZXJzLWdlbmVyYXRlZCc7XG5pbXBvcnQgeyBhdHRhY2hDdXN0b21SZXNvbHZlcnMgfSBmcm9tIFwiLi9yZXNvbHZlcnMtY3VzdG9tXCI7XG5pbXBvcnQgeyByZXNvbHZlcnNNYW0gfSBmcm9tIFwiLi9yZXNvbHZlcnMtbWFtXCI7XG5cbmltcG9ydCB0eXBlIHsgUUNvbmZpZyB9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCBRTG9ncyBmcm9tICcuL2xvZ3MnO1xuaW1wb3J0IHR5cGUgeyBRTG9nIH0gZnJvbSAnLi9sb2dzJztcbmltcG9ydCB0eXBlIHtJU3RhdHN9IGZyb20gJy4vdHJhY2VyJztcbmltcG9ydCB7UVN0YXRzLCBRVHJhY2VyfSBmcm9tIFwiLi90cmFjZXJcIjtcbmltcG9ydCB7IFRyYWNlciB9IGZyb20gXCJvcGVudHJhY2luZ1wiO1xuaW1wb3J0IHsgQXV0aCB9IGZyb20gJy4vYXV0aCc7XG5pbXBvcnQgeyBjcmVhdGVFcnJvciB9IGZyb20gXCIuL3V0aWxzXCI7XG5cbnR5cGUgUU9wdGlvbnMgPSB7XG4gICAgY29uZmlnOiBRQ29uZmlnLFxuICAgIGxvZ3M6IFFMb2dzLFxufVxuXG50eXBlIEVuZFBvaW50ID0ge1xuICAgIHBhdGg6IHN0cmluZyxcbiAgICByZXNvbHZlcnM6IGFueSxcbiAgICB0eXBlRGVmRmlsZU5hbWVzOiBzdHJpbmdbXSxcbiAgICBzdXBwb3J0U3Vic2NyaXB0aW9uczogYm9vbGVhbixcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVE9OUVNlcnZlciB7XG4gICAgY29uZmlnOiBRQ29uZmlnO1xuICAgIGxvZ3M6IFFMb2dzO1xuICAgIGxvZzogUUxvZztcbiAgICBhcHA6IGV4cHJlc3MuQXBwbGljYXRpb247XG4gICAgc2VydmVyOiBhbnk7XG4gICAgZW5kUG9pbnRzOiBFbmRQb2ludFtdO1xuICAgIGRiOiBBcmFuZ287XG4gICAgdHJhY2VyOiBUcmFjZXI7XG4gICAgc3RhdHM6IElTdGF0cztcbiAgICBjbGllbnQ6IFRPTkNsaWVudDtcbiAgICBhdXRoOiBBdXRoO1xuICAgIHNoYXJlZDogTWFwPHN0cmluZywgYW55PjtcblxuXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczogUU9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5jb25maWcgPSBvcHRpb25zLmNvbmZpZztcbiAgICAgICAgdGhpcy5sb2dzID0gb3B0aW9ucy5sb2dzO1xuICAgICAgICB0aGlzLmxvZyA9IHRoaXMubG9ncy5jcmVhdGUoJ3NlcnZlcicpO1xuICAgICAgICB0aGlzLnNoYXJlZCA9IG5ldyBNYXAoKTtcbiAgICAgICAgdGhpcy50cmFjZXIgPSBRVHJhY2VyLmNyZWF0ZShvcHRpb25zLmNvbmZpZyk7XG4gICAgICAgIHRoaXMuc3RhdHMgPSBRU3RhdHMuY3JlYXRlKG9wdGlvbnMuY29uZmlnLnN0YXRzZC5zZXJ2ZXIpO1xuICAgICAgICB0aGlzLmF1dGggPSBuZXcgQXV0aChvcHRpb25zLmNvbmZpZyk7XG4gICAgICAgIHRoaXMuZW5kUG9pbnRzID0gW107XG4gICAgICAgIHRoaXMuYXBwID0gZXhwcmVzcygpO1xuICAgICAgICB0aGlzLnNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKHRoaXMuYXBwKTtcbiAgICAgICAgdGhpcy5kYiA9IG5ldyBBcmFuZ28odGhpcy5jb25maWcsIHRoaXMubG9ncywgdGhpcy5hdXRoLCB0aGlzLnRyYWNlciwgdGhpcy5zdGF0cyk7XG4gICAgICAgIHRoaXMuYWRkRW5kUG9pbnQoe1xuICAgICAgICAgICAgcGF0aDogJy9ncmFwaHFsL21hbScsXG4gICAgICAgICAgICByZXNvbHZlcnM6IHJlc29sdmVyc01hbSxcbiAgICAgICAgICAgIHR5cGVEZWZGaWxlTmFtZXM6IFsndHlwZS1kZWZzLW1hbS5ncmFwaHFsJ10sXG4gICAgICAgICAgICBzdXBwb3J0U3Vic2NyaXB0aW9uczogZmFsc2UsXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmFkZEVuZFBvaW50KHtcbiAgICAgICAgICAgIHBhdGg6ICcvZ3JhcGhxbCcsXG4gICAgICAgICAgICByZXNvbHZlcnM6IGF0dGFjaEN1c3RvbVJlc29sdmVycyhjcmVhdGVSZXNvbHZlcnModGhpcy5kYikpLFxuICAgICAgICAgICAgdHlwZURlZkZpbGVOYW1lczogWyd0eXBlLWRlZnMtZ2VuZXJhdGVkLmdyYXBocWwnLCAndHlwZS1kZWZzLWN1c3RvbS5ncmFwaHFsJ10sXG4gICAgICAgICAgICBzdXBwb3J0U3Vic2NyaXB0aW9uczogdHJ1ZSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG5cbiAgICBhc3luYyBzdGFydCgpIHtcbiAgICAgICAgdGhpcy5jbGllbnQgPSBhd2FpdCBUT05DbGllbnROb2RlSnMuY3JlYXRlKHsgc2VydmVyczogWycnXSB9KTtcbiAgICAgICAgYXdhaXQgdGhpcy5kYi5zdGFydCgpO1xuICAgICAgICBjb25zdCB7IGhvc3QsIHBvcnQgfSA9IHRoaXMuY29uZmlnLnNlcnZlcjtcbiAgICAgICAgdGhpcy5zZXJ2ZXIubGlzdGVuKHsgaG9zdCwgcG9ydCB9LCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmVuZFBvaW50cy5mb3JFYWNoKChlbmRQb2ludDogRW5kUG9pbnQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnR1JBUEhRTCcsIGBodHRwOi8vJHtob3N0fToke3BvcnR9JHtlbmRQb2ludC5wYXRofWApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNlcnZlci5zZXRUaW1lb3V0KDIxNDc0ODM2NDcpO1xuICAgIH1cblxuXG4gICAgYWRkRW5kUG9pbnQoZW5kUG9pbnQ6IEVuZFBvaW50KSB7XG4gICAgICAgIGNvbnN0IHR5cGVEZWZzID0gZW5kUG9pbnQudHlwZURlZkZpbGVOYW1lc1xuICAgICAgICAgICAgLm1hcCh4ID0+IGZzLnJlYWRGaWxlU3luYyh4LCAndXRmLTgnKSlcbiAgICAgICAgICAgIC5qb2luKCdcXG4nKTtcbiAgICAgICAgY29uc3QgY29uZmlnOiBBcG9sbG9TZXJ2ZXJFeHByZXNzQ29uZmlnID0ge1xuICAgICAgICAgICAgdHlwZURlZnMsXG4gICAgICAgICAgICByZXNvbHZlcnM6IGVuZFBvaW50LnJlc29sdmVycyxcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbnM6IHtcbiAgICAgICAgICAgICAgICBvbkNvbm5lY3QoY29ubmVjdGlvblBhcmFtczogT2JqZWN0LCBfd2Vic29ja2V0OiBXZWJTb2NrZXQsIF9jb250ZXh0OiBDb25uZWN0aW9uQ29udGV4dCk6IGFueSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY2Nlc3NLZXk6IGNvbm5lY3Rpb25QYXJhbXMuYWNjZXNzS2V5IHx8IGNvbm5lY3Rpb25QYXJhbXMuYWNjZXNza2V5LFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNvbnRleHQ6ICh7IHJlcSwgY29ubmVjdGlvbiB9KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgZGI6IHRoaXMuZGIsXG4gICAgICAgICAgICAgICAgICAgIHRyYWNlcjogdGhpcy50cmFjZXIsXG4gICAgICAgICAgICAgICAgICAgIHN0YXRzOiB0aGlzLnN0YXRzLFxuICAgICAgICAgICAgICAgICAgICBhdXRoOiB0aGlzLmF1dGgsXG4gICAgICAgICAgICAgICAgICAgIGNsaWVudDogdGhpcy5jbGllbnQsXG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZzogdGhpcy5jb25maWcsXG4gICAgICAgICAgICAgICAgICAgIHNoYXJlZDogdGhpcy5zaGFyZWQsXG4gICAgICAgICAgICAgICAgICAgIHJlbW90ZUFkZHJlc3M6IChyZXEgJiYgcmVxLnNvY2tldCAmJiByZXEuc29ja2V0LnJlbW90ZUFkZHJlc3MpIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICBhY2Nlc3NLZXk6IEF1dGguZXh0cmFjdEFjY2Vzc0tleShyZXEsIGNvbm5lY3Rpb24pLFxuICAgICAgICAgICAgICAgICAgICBwYXJlbnRTcGFuOiBRVHJhY2VyLmV4dHJhY3RQYXJlbnRTcGFuKHRoaXMudHJhY2VyLCBjb25uZWN0aW9uID8gY29ubmVjdGlvbiA6IHJlcSksXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwbHVnaW5zOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICByZXF1ZXN0RGlkU3RhcnQoX3JlcXVlc3RDb250ZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbGxTZW5kUmVzcG9uc2UoY3R4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dCA9IGN0eC5jb250ZXh0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udGV4dC5tdWx0aXBsZUFjY2Vzc0tleXNEZXRlY3RlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgY3JlYXRlRXJyb3IoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgNDAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdSZXF1ZXN0IG11c3QgdXNlIHRoZSBzYW1lIGFjY2VzcyBrZXkgZm9yIGFsbCBxdWVyaWVzIGFuZCBtdXRhdGlvbnMnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF0sXG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IGFwb2xsbyA9IG5ldyBBcG9sbG9TZXJ2ZXIoY29uZmlnKTtcbiAgICAgICAgYXBvbGxvLmFwcGx5TWlkZGxld2FyZSh7IGFwcDogdGhpcy5hcHAsIHBhdGg6IGVuZFBvaW50LnBhdGggfSk7XG4gICAgICAgIGlmIChlbmRQb2ludC5zdXBwb3J0U3Vic2NyaXB0aW9ucykge1xuICAgICAgICAgICAgYXBvbGxvLmluc3RhbGxTdWJzY3JpcHRpb25IYW5kbGVycyh0aGlzLnNlcnZlcik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5lbmRQb2ludHMucHVzaChlbmRQb2ludCk7XG4gICAgfVxuXG5cbn1cblxuIl19