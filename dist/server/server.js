"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createProviders = createProviders;
exports.default = void 0;

var _core = require("@tonclient/core");

var _libNode = require("@tonclient/lib-node");

var _fs = _interopRequireDefault(require("fs"));

var _express = _interopRequireDefault(require("express"));

var _http = _interopRequireDefault(require("http"));

var _path = _interopRequireDefault(require("path"));

var _apolloServerExpress = require("apollo-server-express");

var _subscriptionsTransportWs = require("subscriptions-transport-ws");

var _arangoProvider = require("./data/arango-provider");

var _blockchain = _interopRequireDefault(require("./data/blockchain"));

var _collection = require("./data/collection");

var _config = require("./config");

var _dataProvider = require("./data/data-provider");

var _memjsDatacache = require("./data/memjs-datacache");

var _aggregates = require("./graphql/aggregates");

var _counterparties = require("./graphql/counterparties");

var _explain = require("./graphql/explain");

var _info = require("./graphql/info");

var _postRequests = require("./graphql/post-requests");

var _resolversGenerated = require("./graphql/resolvers-generated");

var _access = require("./graphql/access");

var _mam = require("./graphql/mam");

var _totals = require("./graphql/totals");

var _logs = _interopRequireDefault(require("./logs"));

var _tracer = require("./tracer");

var _opentracing = require("opentracing");

var _auth = require("./auth");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const v8 = require('v8');

class MemStats {
  constructor(stats) {
    this.stats = stats;
  }

  report() {
    v8.getHeapSpaceStatistics().forEach(space => {
      const spaceName = space.space_name.replace('space_', '').replace('_space', '');

      const gauge = (metric, value) => {
        this.stats.gauge(`heap.space.${spaceName}.${metric}`, value);
      };

      gauge('physical_size', space.physical_space_size);
      gauge('available_size', space.space_available_size);
      gauge('size', space.space_size);
      gauge('used_size', space.space_used_size);
    });
  }

  start() {//TODO: this.checkMemReport();
    //TODO: this.checkGc();
  }

  checkMemReport() {
    setTimeout(() => {
      this.report();
      this.checkMemReport();
    }, 5000);
  }

  checkGc() {
    setTimeout(() => {
      global.gc();
      this.checkGc();
    }, 60000);
  }

}

function createProviders(configName, logs, config, networkName, cacheKeyPrefix) {
  const newArangoProvider = (dbName, config) => new _arangoProvider.ArangoProvider(logs.create(`${configName}_${dbName}`), config);

  const mutable = newArangoProvider('mut', config.mut);
  const hot = newArangoProvider('hot', config.hot);
  const cacheLog = logs.create(`${configName}_cache`);
  const cold = new _dataProvider.QDataPrecachedCombiner(cacheLog, (0, _memjsDatacache.isCacheEnabled)(config.cache) ? new _memjsDatacache.MemjsDataCache(cacheLog, config.cache) : _dataProvider.missingDataCache, config.cold.map(x => newArangoProvider('cold', x)), networkName, cacheKeyPrefix);
  const immutable = new _dataProvider.QDataCombiner([hot, cold]);
  const counterparties = newArangoProvider('counterparties', config.counterparties);
  return {
    mutable,
    immutable,
    counterparties
  };
}

function isObject(test) {
  return typeof test === 'object' && test !== null;
}

function overrideObject(original, overrides) {
  Object.entries(overrides).forEach(([name, overrideValue]) => {
    if (name in original && isObject(overrideValue) && isObject(original[name])) {
      overrideObject(original[name], overrideValue);
    } else {
      original[name] = overrideValue;
    }
  });
}

class TONQServer {
  constructor(options) {
    this.config = options.config;
    this.logs = options.logs;
    this.log = this.logs.create('server');
    this.shared = new Map();
    this.tracer = _tracer.QTracer.create(options.config);
    this.stats = _tracer.QStats.create(options.config.statsd.server, options.config.statsd.tags);
    this.auth = new _auth.Auth(options.config);
    this.endPoints = [];
    this.app = (0, _express.default)();
    this.server = _http.default.createServer(this.app);
    this.data = options.data || new _blockchain.default({
      logs: this.logs,
      auth: this.auth,
      tracer: this.tracer,
      stats: this.stats,
      providers: createProviders('fast', this.logs, this.config.data, this.config.networkName, this.config.cacheKeyPrefix),
      slowQueriesProviders: createProviders('slow', this.logs, this.config.slowQueriesData, this.config.networkName, this.config.cacheKeyPrefix),
      isTests: false
    });
    this.memStats = new MemStats(this.stats);
    this.memStats.start();
    this.addEndPoint({
      path: '/graphql/mam',
      resolvers: _mam.mam,
      typeDefFileNames: ['type-defs-mam.graphql'],
      supportSubscriptions: false
    });
    const resolvers = (0, _resolversGenerated.createResolvers)(this.data);
    [_info.infoResolvers, _totals.totalsResolvers, (0, _aggregates.aggregatesResolvers)(this.data), (0, _explain.explainResolvers)(this.data), _postRequests.postRequestsResolvers, _access.accessResolvers, (0, _counterparties.counterpartiesResolvers)(this.data)].forEach(x => overrideObject(resolvers, x));
    this.addEndPoint({
      path: '/graphql',
      resolvers,
      typeDefFileNames: ['type-defs-generated.graphql', 'type-defs-custom.graphql', 'type-defs-counterparties.graphql'],
      supportSubscriptions: true
    });
  }

  async start() {
    _core.TonClient.useBinaryLibrary(_libNode.libNode);

    this.client = new _core.TonClient();
    await this.data.start();
    const {
      host,
      port
    } = this.config.server;
    this.server.listen({
      host,
      port
    }, () => {
      this.endPoints.forEach(endPoint => {
        this.log.debug('GRAPHQL', `http://${host}:${port}${endPoint.path}`);
      });
    });
    this.server.setTimeout(2147483647);
    const version = (0, _utils.packageJson)().version;
    const startCounter = new _tracer.StatsCounter(this.stats, _config.STATS.start, [`version:${version}`]);
    startCounter.increment();
  }

  async stop() {
    await new Promise(resolve => this.server.close(() => resolve()));
    this.logs.stop();
  }

  addEndPoint(endPoint) {
    const typeDefs = endPoint.typeDefFileNames.map(x => _fs.default.readFileSync(_path.default.join('res', x), 'utf-8')).join('\n');
    const config = {
      debug: false,
      typeDefs,
      resolvers: endPoint.resolvers,
      subscriptions: {
        keepAlive: this.config.server.keepAlive,

        onDisconnect(_webSocket, context) {
          if (context.activeRequests) {
            context.activeRequests.forEach(x => x.emitClose());
            context.activeRequests = [];
          }
        },

        onConnect(connectionParams, _webSocket, context) {
          const activeRequests = [];
          context.activeRequests = activeRequests;
          return {
            activeRequests,
            accessKey: connectionParams.accessKey || connectionParams.accesskey
          };
        }

      },
      context: ({
        req,
        connection
      }) => {
        const request = new _collection.RequestController();

        if (req && req.on) {
          req.on('close', () => {
            request.emitClose();
          });
        }

        if (connection && connection.context) {
          if (!connection.context.activeRequests) {
            connection.context.activeRequests = [];
          }

          const activeRequests = connection.context.activeRequests;
          activeRequests.push(request);
          request.events.on(_collection.RequestEvent.FINISH, () => {
            const index = activeRequests.indexOf(request);

            if (index >= 0) {
              activeRequests.splice(index, 1);
            }
          });
        }

        return {
          data: this.data,
          tracer: this.tracer,
          stats: this.stats,
          auth: this.auth,
          client: this.client,
          config: this.config,
          shared: this.shared,
          remoteAddress: req && req.socket && req.socket.remoteAddress || '',
          accessKey: _auth.Auth.extractAccessKey(req, connection),
          parentSpan: _tracer.QTracer.extractParentSpan(this.tracer, connection ? connection : req),
          req,
          connection,
          request
        };
      },
      plugins: [{
        requestDidStart(_requestContext) {
          return {
            willSendResponse(ctx) {
              const context = ctx.context;

              if (context.multipleAccessKeysDetected) {
                throw _utils.QError.multipleAccessKeys();
              }
            }

          };
        }

      }]
    };
    const apollo = new _apolloServerExpress.ApolloServer(config);
    apollo.applyMiddleware({
      app: this.app,
      path: endPoint.path
    });

    if (endPoint.supportSubscriptions) {
      apollo.installSubscriptionHandlers(this.server);
    }

    this.endPoints.push(endPoint);
  }

}

exports.default = TONQServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvc2VydmVyLmpzIl0sIm5hbWVzIjpbInY4IiwicmVxdWlyZSIsIk1lbVN0YXRzIiwiY29uc3RydWN0b3IiLCJzdGF0cyIsInJlcG9ydCIsImdldEhlYXBTcGFjZVN0YXRpc3RpY3MiLCJmb3JFYWNoIiwic3BhY2UiLCJzcGFjZU5hbWUiLCJzcGFjZV9uYW1lIiwicmVwbGFjZSIsImdhdWdlIiwibWV0cmljIiwidmFsdWUiLCJwaHlzaWNhbF9zcGFjZV9zaXplIiwic3BhY2VfYXZhaWxhYmxlX3NpemUiLCJzcGFjZV9zaXplIiwic3BhY2VfdXNlZF9zaXplIiwic3RhcnQiLCJjaGVja01lbVJlcG9ydCIsInNldFRpbWVvdXQiLCJjaGVja0djIiwiZ2xvYmFsIiwiZ2MiLCJjcmVhdGVQcm92aWRlcnMiLCJjb25maWdOYW1lIiwibG9ncyIsImNvbmZpZyIsIm5ldHdvcmtOYW1lIiwiY2FjaGVLZXlQcmVmaXgiLCJuZXdBcmFuZ29Qcm92aWRlciIsImRiTmFtZSIsIkFyYW5nb1Byb3ZpZGVyIiwiY3JlYXRlIiwibXV0YWJsZSIsIm11dCIsImhvdCIsImNhY2hlTG9nIiwiY29sZCIsIlFEYXRhUHJlY2FjaGVkQ29tYmluZXIiLCJjYWNoZSIsIk1lbWpzRGF0YUNhY2hlIiwibWlzc2luZ0RhdGFDYWNoZSIsIm1hcCIsIngiLCJpbW11dGFibGUiLCJRRGF0YUNvbWJpbmVyIiwiY291bnRlcnBhcnRpZXMiLCJpc09iamVjdCIsInRlc3QiLCJvdmVycmlkZU9iamVjdCIsIm9yaWdpbmFsIiwib3ZlcnJpZGVzIiwiT2JqZWN0IiwiZW50cmllcyIsIm5hbWUiLCJvdmVycmlkZVZhbHVlIiwiVE9OUVNlcnZlciIsIm9wdGlvbnMiLCJsb2ciLCJzaGFyZWQiLCJNYXAiLCJ0cmFjZXIiLCJRVHJhY2VyIiwiUVN0YXRzIiwic3RhdHNkIiwic2VydmVyIiwidGFncyIsImF1dGgiLCJBdXRoIiwiZW5kUG9pbnRzIiwiYXBwIiwiaHR0cCIsImNyZWF0ZVNlcnZlciIsImRhdGEiLCJRQmxvY2tjaGFpbkRhdGEiLCJwcm92aWRlcnMiLCJzbG93UXVlcmllc1Byb3ZpZGVycyIsInNsb3dRdWVyaWVzRGF0YSIsImlzVGVzdHMiLCJtZW1TdGF0cyIsImFkZEVuZFBvaW50IiwicGF0aCIsInJlc29sdmVycyIsIm1hbSIsInR5cGVEZWZGaWxlTmFtZXMiLCJzdXBwb3J0U3Vic2NyaXB0aW9ucyIsImluZm9SZXNvbHZlcnMiLCJ0b3RhbHNSZXNvbHZlcnMiLCJwb3N0UmVxdWVzdHNSZXNvbHZlcnMiLCJhY2Nlc3NSZXNvbHZlcnMiLCJUb25DbGllbnQiLCJ1c2VCaW5hcnlMaWJyYXJ5IiwibGliTm9kZSIsImNsaWVudCIsImhvc3QiLCJwb3J0IiwibGlzdGVuIiwiZW5kUG9pbnQiLCJkZWJ1ZyIsInZlcnNpb24iLCJzdGFydENvdW50ZXIiLCJTdGF0c0NvdW50ZXIiLCJTVEFUUyIsImluY3JlbWVudCIsInN0b3AiLCJQcm9taXNlIiwicmVzb2x2ZSIsImNsb3NlIiwidHlwZURlZnMiLCJmcyIsInJlYWRGaWxlU3luYyIsImpvaW4iLCJzdWJzY3JpcHRpb25zIiwia2VlcEFsaXZlIiwib25EaXNjb25uZWN0IiwiX3dlYlNvY2tldCIsImNvbnRleHQiLCJhY3RpdmVSZXF1ZXN0cyIsImVtaXRDbG9zZSIsIm9uQ29ubmVjdCIsImNvbm5lY3Rpb25QYXJhbXMiLCJhY2Nlc3NLZXkiLCJhY2Nlc3NrZXkiLCJyZXEiLCJjb25uZWN0aW9uIiwicmVxdWVzdCIsIlJlcXVlc3RDb250cm9sbGVyIiwib24iLCJwdXNoIiwiZXZlbnRzIiwiUmVxdWVzdEV2ZW50IiwiRklOSVNIIiwiaW5kZXgiLCJpbmRleE9mIiwic3BsaWNlIiwicmVtb3RlQWRkcmVzcyIsInNvY2tldCIsImV4dHJhY3RBY2Nlc3NLZXkiLCJwYXJlbnRTcGFuIiwiZXh0cmFjdFBhcmVudFNwYW4iLCJwbHVnaW5zIiwicmVxdWVzdERpZFN0YXJ0IiwiX3JlcXVlc3RDb250ZXh0Iiwid2lsbFNlbmRSZXNwb25zZSIsImN0eCIsIm11bHRpcGxlQWNjZXNzS2V5c0RldGVjdGVkIiwiUUVycm9yIiwibXVsdGlwbGVBY2Nlc3NLZXlzIiwiYXBvbGxvIiwiQXBvbGxvU2VydmVyIiwiYXBwbHlNaWRkbGV3YXJlIiwiaW5zdGFsbFN1YnNjcmlwdGlvbkhhbmRsZXJzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQWlCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQXBEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFxREEsTUFBTUEsRUFBRSxHQUFHQyxPQUFPLENBQUMsSUFBRCxDQUFsQjs7QUFFQSxNQUFNQyxRQUFOLENBQWU7QUFHWEMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQWdCO0FBQ3ZCLFNBQUtBLEtBQUwsR0FBYUEsS0FBYjtBQUNIOztBQUVEQyxFQUFBQSxNQUFNLEdBQUc7QUFDTEwsSUFBQUEsRUFBRSxDQUFDTSxzQkFBSCxHQUE0QkMsT0FBNUIsQ0FBcUNDLEtBQUQsSUFBVztBQUMzQyxZQUFNQyxTQUFTLEdBQUdELEtBQUssQ0FBQ0UsVUFBTixDQUNiQyxPQURhLENBQ0wsUUFESyxFQUNLLEVBREwsRUFFYkEsT0FGYSxDQUVMLFFBRkssRUFFSyxFQUZMLENBQWxCOztBQUdBLFlBQU1DLEtBQUssR0FBRyxDQUFDQyxNQUFELEVBQWlCQyxLQUFqQixLQUFtQztBQUM3QyxhQUFLVixLQUFMLENBQVdRLEtBQVgsQ0FBa0IsY0FBYUgsU0FBVSxJQUFHSSxNQUFPLEVBQW5ELEVBQXNEQyxLQUF0RDtBQUNILE9BRkQ7O0FBR0FGLE1BQUFBLEtBQUssQ0FBQyxlQUFELEVBQWtC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QUFRLENBQUNoQjtBQUZJLEtBQXZCOztBQUlBLFFBQUlnQixRQUFRLENBQUNaLG9CQUFiLEVBQW1DO0FBQy9CK0QsTUFBQUEsTUFBTSxDQUFDRywyQkFBUCxDQUFtQyxLQUFLdEYsTUFBeEM7QUFDSDs7QUFDRCxTQUFLSSxTQUFMLENBQWUyRCxJQUFmLENBQW9CL0IsUUFBcEI7QUFDSDs7QUFsTDJCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE4LTIwMjAgVE9OIERFViBTT0xVVElPTlMgTFRELlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBTT0ZUV0FSRSBFVkFMVUFUSU9OIExpY2Vuc2UgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZVxuICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlXG4gKiBMaWNlbnNlIGF0OlxuICpcbiAqIGh0dHA6Ly93d3cudG9uLmRldi9saWNlbnNlc1xuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgVE9OIERFViBzb2Z0d2FyZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vLyBAZmxvd1xuaW1wb3J0IHsgVG9uQ2xpZW50IH0gZnJvbSAnQHRvbmNsaWVudC9jb3JlJztcbmltcG9ydCB7IGxpYk5vZGUgfSBmcm9tIFwiQHRvbmNsaWVudC9saWItbm9kZVwiO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IGh0dHAgZnJvbSAnaHR0cCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IHsgQXBvbGxvU2VydmVyLCBBcG9sbG9TZXJ2ZXJFeHByZXNzQ29uZmlnIH0gZnJvbSAnYXBvbGxvLXNlcnZlci1leHByZXNzJztcbmltcG9ydCB7IENvbm5lY3Rpb25Db250ZXh0IH0gZnJvbSAnc3Vic2NyaXB0aW9ucy10cmFuc3BvcnQtd3MnO1xuaW1wb3J0IHsgQXJhbmdvUHJvdmlkZXIgfSBmcm9tICcuL2RhdGEvYXJhbmdvLXByb3ZpZGVyJztcbmltcG9ydCBRQmxvY2tjaGFpbkRhdGEgZnJvbSAnLi9kYXRhL2Jsb2NrY2hhaW4nO1xuaW1wb3J0IHR5cGUgeyBRRGF0YVByb3ZpZGVycyB9IGZyb20gJy4vZGF0YS9kYXRhJztcbmltcG9ydCB7IFJlcXVlc3RDb250cm9sbGVyLCBSZXF1ZXN0RXZlbnQgfSBmcm9tICcuL2RhdGEvY29sbGVjdGlvbic7XG5pbXBvcnQgdHlwZSB7IEdyYXBoUUxSZXF1ZXN0Q29udGV4dCB9IGZyb20gJy4vZGF0YS9jb2xsZWN0aW9uJztcbmltcG9ydCB7IFNUQVRTIH0gZnJvbSAnLi9jb25maWcnO1xuaW1wb3J0IHsgbWlzc2luZ0RhdGFDYWNoZSwgUURhdGFDb21iaW5lciwgUURhdGFQcmVjYWNoZWRDb21iaW5lciB9IGZyb20gJy4vZGF0YS9kYXRhLXByb3ZpZGVyJztcbmltcG9ydCB7IGlzQ2FjaGVFbmFibGVkLCBNZW1qc0RhdGFDYWNoZSB9IGZyb20gJy4vZGF0YS9tZW1qcy1kYXRhY2FjaGUnO1xuaW1wb3J0IHsgYWdncmVnYXRlc1Jlc29sdmVycyB9IGZyb20gXCIuL2dyYXBocWwvYWdncmVnYXRlc1wiO1xuaW1wb3J0IHsgY291bnRlcnBhcnRpZXNSZXNvbHZlcnMgfSBmcm9tIFwiLi9ncmFwaHFsL2NvdW50ZXJwYXJ0aWVzXCI7XG5pbXBvcnQgeyBleHBsYWluUmVzb2x2ZXJzIH0gZnJvbSBcIi4vZ3JhcGhxbC9leHBsYWluXCI7XG5pbXBvcnQgeyBpbmZvUmVzb2x2ZXJzIH0gZnJvbSBcIi4vZ3JhcGhxbC9pbmZvXCI7XG5pbXBvcnQgeyBwb3N0UmVxdWVzdHNSZXNvbHZlcnMgfSBmcm9tIFwiLi9ncmFwaHFsL3Bvc3QtcmVxdWVzdHNcIjtcblxuaW1wb3J0IHsgY3JlYXRlUmVzb2x2ZXJzIH0gZnJvbSAnLi9ncmFwaHFsL3Jlc29sdmVycy1nZW5lcmF0ZWQnO1xuaW1wb3J0IHsgYWNjZXNzUmVzb2x2ZXJzIH0gZnJvbSAnLi9ncmFwaHFsL2FjY2Vzcyc7XG5pbXBvcnQgeyBtYW0gfSBmcm9tICcuL2dyYXBocWwvbWFtJztcblxuaW1wb3J0IHR5cGUgeyBRQXJhbmdvQ29uZmlnLCBRQ29uZmlnLCBRRGF0YVByb3ZpZGVyc0NvbmZpZyB9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCB7IHRvdGFsc1Jlc29sdmVycyB9IGZyb20gXCIuL2dyYXBocWwvdG90YWxzXCI7XG5pbXBvcnQgUUxvZ3MgZnJvbSAnLi9sb2dzJztcbmltcG9ydCB0eXBlIHsgUUxvZyB9IGZyb20gJy4vbG9ncyc7XG5pbXBvcnQgdHlwZSB7IElTdGF0cyB9IGZyb20gJy4vdHJhY2VyJztcbmltcG9ydCB7IFFTdGF0cywgUVRyYWNlciwgU3RhdHNDb3VudGVyIH0gZnJvbSAnLi90cmFjZXInO1xuaW1wb3J0IHsgVHJhY2VyIH0gZnJvbSAnb3BlbnRyYWNpbmcnO1xuaW1wb3J0IHsgQXV0aCB9IGZyb20gJy4vYXV0aCc7XG5pbXBvcnQgeyBwYWNrYWdlSnNvbiwgUUVycm9yIH0gZnJvbSAnLi91dGlscyc7XG5cbnR5cGUgUU9wdGlvbnMgPSB7XG4gICAgY29uZmlnOiBRQ29uZmlnLFxuICAgIGxvZ3M6IFFMb2dzLFxuICAgIGRhdGE/OiBRQmxvY2tjaGFpbkRhdGEsXG59XG5cbnR5cGUgRW5kUG9pbnQgPSB7XG4gICAgcGF0aDogc3RyaW5nLFxuICAgIHJlc29sdmVyczogYW55LFxuICAgIHR5cGVEZWZGaWxlTmFtZXM6IHN0cmluZ1tdLFxuICAgIHN1cHBvcnRTdWJzY3JpcHRpb25zOiBib29sZWFuLFxufVxuXG5jb25zdCB2OCA9IHJlcXVpcmUoJ3Y4Jyk7XG5cbmNsYXNzIE1lbVN0YXRzIHtcbiAgICBzdGF0czogSVN0YXRzO1xuXG4gICAgY29uc3RydWN0b3Ioc3RhdHM6IElTdGF0cykge1xuICAgICAgICB0aGlzLnN0YXRzID0gc3RhdHM7XG4gICAgfVxuXG4gICAgcmVwb3J0KCkge1xuICAgICAgICB2OC5nZXRIZWFwU3BhY2VTdGF0aXN0aWNzKCkuZm9yRWFjaCgoc3BhY2UpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNwYWNlTmFtZSA9IHNwYWNlLnNwYWNlX25hbWVcbiAgICAgICAgICAgICAgICAucmVwbGFjZSgnc3BhY2VfJywgJycpXG4gICAgICAgICAgICAgICAgLnJlcGxhY2UoJ19zcGFjZScsICcnKTtcbiAgICAgICAgICAgIGNvbnN0IGdhdWdlID0gKG1ldHJpYzogc3RyaW5nLCB2YWx1ZTogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5nYXVnZShgaGVhcC5zcGFjZS4ke3NwYWNlTmFtZX0uJHttZXRyaWN9YCwgdmFsdWUpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGdhdWdlKCdwaHlzaWNhbF9zaXplJywgc3BhY2UucGh5c2ljYWxfc3BhY2Vfc2l6ZSk7XG4gICAgICAgICAgICBnYXVnZSgnYXZhaWxhYmxlX3NpemUnLCBzcGFjZS5zcGFjZV9hdmFpbGFibGVfc2l6ZSk7XG4gICAgICAgICAgICBnYXVnZSgnc2l6ZScsIHNwYWNlLnNwYWNlX3NpemUpO1xuICAgICAgICAgICAgZ2F1Z2UoJ3VzZWRfc2l6ZScsIHNwYWNlLnNwYWNlX3VzZWRfc2l6ZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHN0YXJ0KCkge1xuICAgICAgICAvL1RPRE86IHRoaXMuY2hlY2tNZW1SZXBvcnQoKTtcbiAgICAgICAgLy9UT0RPOiB0aGlzLmNoZWNrR2MoKTtcbiAgICB9XG5cbiAgICBjaGVja01lbVJlcG9ydCgpIHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlcG9ydCgpO1xuICAgICAgICAgICAgdGhpcy5jaGVja01lbVJlcG9ydCgpO1xuICAgICAgICB9LCA1MDAwKTtcbiAgICB9XG5cbiAgICBjaGVja0djKCkge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIGdsb2JhbC5nYygpO1xuICAgICAgICAgICAgdGhpcy5jaGVja0djKCk7XG4gICAgICAgIH0sIDYwMDAwKTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVQcm92aWRlcnMoY29uZmlnTmFtZTogc3RyaW5nLCBsb2dzOiBRTG9ncywgY29uZmlnOiBRRGF0YVByb3ZpZGVyc0NvbmZpZywgbmV0d29ya05hbWU6IHN0cmluZywgY2FjaGVLZXlQcmVmaXg6IHN0cmluZyk6IFFEYXRhUHJvdmlkZXJzIHtcbiAgICBjb25zdCBuZXdBcmFuZ29Qcm92aWRlciA9IChkYk5hbWU6IHN0cmluZywgY29uZmlnOiBRQXJhbmdvQ29uZmlnKTogQXJhbmdvUHJvdmlkZXIgPT4gKFxuICAgICAgICBuZXcgQXJhbmdvUHJvdmlkZXIobG9ncy5jcmVhdGUoYCR7Y29uZmlnTmFtZX1fJHtkYk5hbWV9YCksIGNvbmZpZylcbiAgICApO1xuICAgIGNvbnN0IG11dGFibGUgPSBuZXdBcmFuZ29Qcm92aWRlcignbXV0JywgY29uZmlnLm11dCk7XG4gICAgY29uc3QgaG90ID0gbmV3QXJhbmdvUHJvdmlkZXIoJ2hvdCcsIGNvbmZpZy5ob3QpO1xuICAgIGNvbnN0IGNhY2hlTG9nID0gbG9ncy5jcmVhdGUoYCR7Y29uZmlnTmFtZX1fY2FjaGVgKTtcbiAgICBjb25zdCBjb2xkID0gbmV3IFFEYXRhUHJlY2FjaGVkQ29tYmluZXIoXG4gICAgICAgIGNhY2hlTG9nLFxuICAgICAgICBpc0NhY2hlRW5hYmxlZChjb25maWcuY2FjaGUpID8gbmV3IE1lbWpzRGF0YUNhY2hlKGNhY2hlTG9nLCBjb25maWcuY2FjaGUpIDogbWlzc2luZ0RhdGFDYWNoZSxcbiAgICAgICAgY29uZmlnLmNvbGQubWFwKHggPT4gbmV3QXJhbmdvUHJvdmlkZXIoJ2NvbGQnLCB4KSksXG4gICAgICAgIG5ldHdvcmtOYW1lLFxuICAgICAgICBjYWNoZUtleVByZWZpeCxcbiAgICApO1xuICAgIGNvbnN0IGltbXV0YWJsZSA9IG5ldyBRRGF0YUNvbWJpbmVyKFtob3QsIGNvbGRdKTtcbiAgICBjb25zdCBjb3VudGVycGFydGllcyA9IG5ld0FyYW5nb1Byb3ZpZGVyKCdjb3VudGVycGFydGllcycsIGNvbmZpZy5jb3VudGVycGFydGllcyk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgbXV0YWJsZSxcbiAgICAgICAgaW1tdXRhYmxlLFxuICAgICAgICBjb3VudGVycGFydGllcyxcbiAgICB9O1xufVxuXG5mdW5jdGlvbiBpc09iamVjdCh0ZXN0OiBhbnkpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdHlwZW9mIHRlc3QgPT09ICdvYmplY3QnICYmIHRlc3QgIT09IG51bGw7XG59XG5cbmZ1bmN0aW9uIG92ZXJyaWRlT2JqZWN0KG9yaWdpbmFsOiBhbnksIG92ZXJyaWRlczogYW55KSB7XG4gICAgT2JqZWN0LmVudHJpZXMob3ZlcnJpZGVzKS5mb3JFYWNoKChbbmFtZSwgb3ZlcnJpZGVWYWx1ZV0pID0+IHtcbiAgICAgICAgaWYgKChuYW1lIGluIG9yaWdpbmFsKSAmJiBpc09iamVjdChvdmVycmlkZVZhbHVlKSAmJiBpc09iamVjdChvcmlnaW5hbFtuYW1lXSkpIHtcbiAgICAgICAgICAgIG92ZXJyaWRlT2JqZWN0KG9yaWdpbmFsW25hbWVdLCBvdmVycmlkZVZhbHVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG9yaWdpbmFsW25hbWVdID0gb3ZlcnJpZGVWYWx1ZTtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUT05RU2VydmVyIHtcbiAgICBjb25maWc6IFFDb25maWc7XG4gICAgbG9nczogUUxvZ3M7XG4gICAgbG9nOiBRTG9nO1xuICAgIGFwcDogZXhwcmVzcy5BcHBsaWNhdGlvbjtcbiAgICBzZXJ2ZXI6IGFueTtcbiAgICBlbmRQb2ludHM6IEVuZFBvaW50W107XG4gICAgZGF0YTogUUJsb2NrY2hhaW5EYXRhO1xuICAgIHRyYWNlcjogVHJhY2VyO1xuICAgIHN0YXRzOiBJU3RhdHM7XG4gICAgY2xpZW50OiBUb25DbGllbnQ7XG4gICAgYXV0aDogQXV0aDtcbiAgICBtZW1TdGF0czogTWVtU3RhdHM7XG4gICAgc2hhcmVkOiBNYXA8c3RyaW5nLCBhbnk+O1xuXG5cbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiBRT3B0aW9ucykge1xuICAgICAgICB0aGlzLmNvbmZpZyA9IG9wdGlvbnMuY29uZmlnO1xuICAgICAgICB0aGlzLmxvZ3MgPSBvcHRpb25zLmxvZ3M7XG4gICAgICAgIHRoaXMubG9nID0gdGhpcy5sb2dzLmNyZWF0ZSgnc2VydmVyJyk7XG4gICAgICAgIHRoaXMuc2hhcmVkID0gbmV3IE1hcCgpO1xuICAgICAgICB0aGlzLnRyYWNlciA9IFFUcmFjZXIuY3JlYXRlKG9wdGlvbnMuY29uZmlnKTtcbiAgICAgICAgdGhpcy5zdGF0cyA9IFFTdGF0cy5jcmVhdGUob3B0aW9ucy5jb25maWcuc3RhdHNkLnNlcnZlciwgb3B0aW9ucy5jb25maWcuc3RhdHNkLnRhZ3MpO1xuICAgICAgICB0aGlzLmF1dGggPSBuZXcgQXV0aChvcHRpb25zLmNvbmZpZyk7XG4gICAgICAgIHRoaXMuZW5kUG9pbnRzID0gW107XG4gICAgICAgIHRoaXMuYXBwID0gZXhwcmVzcygpO1xuICAgICAgICB0aGlzLnNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKHRoaXMuYXBwKTtcbiAgICAgICAgdGhpcy5kYXRhID0gb3B0aW9ucy5kYXRhIHx8IG5ldyBRQmxvY2tjaGFpbkRhdGEoe1xuICAgICAgICAgICAgbG9nczogdGhpcy5sb2dzLFxuICAgICAgICAgICAgYXV0aDogdGhpcy5hdXRoLFxuICAgICAgICAgICAgdHJhY2VyOiB0aGlzLnRyYWNlcixcbiAgICAgICAgICAgIHN0YXRzOiB0aGlzLnN0YXRzLFxuICAgICAgICAgICAgcHJvdmlkZXJzOiBjcmVhdGVQcm92aWRlcnMoJ2Zhc3QnLCB0aGlzLmxvZ3MsIHRoaXMuY29uZmlnLmRhdGEsIHRoaXMuY29uZmlnLm5ldHdvcmtOYW1lLCB0aGlzLmNvbmZpZy5jYWNoZUtleVByZWZpeCksXG4gICAgICAgICAgICBzbG93UXVlcmllc1Byb3ZpZGVyczogY3JlYXRlUHJvdmlkZXJzKCdzbG93JywgdGhpcy5sb2dzLCB0aGlzLmNvbmZpZy5zbG93UXVlcmllc0RhdGEsIHRoaXMuY29uZmlnLm5ldHdvcmtOYW1lLCB0aGlzLmNvbmZpZy5jYWNoZUtleVByZWZpeCksXG4gICAgICAgICAgICBpc1Rlc3RzOiBmYWxzZSxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMubWVtU3RhdHMgPSBuZXcgTWVtU3RhdHModGhpcy5zdGF0cyk7XG4gICAgICAgIHRoaXMubWVtU3RhdHMuc3RhcnQoKTtcbiAgICAgICAgdGhpcy5hZGRFbmRQb2ludCh7XG4gICAgICAgICAgICBwYXRoOiAnL2dyYXBocWwvbWFtJyxcbiAgICAgICAgICAgIHJlc29sdmVyczogbWFtLFxuICAgICAgICAgICAgdHlwZURlZkZpbGVOYW1lczogWyd0eXBlLWRlZnMtbWFtLmdyYXBocWwnXSxcbiAgICAgICAgICAgIHN1cHBvcnRTdWJzY3JpcHRpb25zOiBmYWxzZSxcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHJlc29sdmVycyA9IGNyZWF0ZVJlc29sdmVycyh0aGlzLmRhdGEpO1xuICAgICAgICBbXG4gICAgICAgICAgICBpbmZvUmVzb2x2ZXJzLFxuICAgICAgICAgICAgdG90YWxzUmVzb2x2ZXJzLFxuICAgICAgICAgICAgYWdncmVnYXRlc1Jlc29sdmVycyh0aGlzLmRhdGEpLFxuICAgICAgICAgICAgZXhwbGFpblJlc29sdmVycyh0aGlzLmRhdGEpLFxuICAgICAgICAgICAgcG9zdFJlcXVlc3RzUmVzb2x2ZXJzLFxuICAgICAgICAgICAgYWNjZXNzUmVzb2x2ZXJzLFxuICAgICAgICAgICAgY291bnRlcnBhcnRpZXNSZXNvbHZlcnModGhpcy5kYXRhKSxcbiAgICAgICAgXS5mb3JFYWNoKHggPT4gb3ZlcnJpZGVPYmplY3QocmVzb2x2ZXJzLCB4KSk7XG4gICAgICAgIHRoaXMuYWRkRW5kUG9pbnQoe1xuICAgICAgICAgICAgcGF0aDogJy9ncmFwaHFsJyxcbiAgICAgICAgICAgIHJlc29sdmVycyxcbiAgICAgICAgICAgIHR5cGVEZWZGaWxlTmFtZXM6IFtcbiAgICAgICAgICAgICAgICAndHlwZS1kZWZzLWdlbmVyYXRlZC5ncmFwaHFsJyxcbiAgICAgICAgICAgICAgICAndHlwZS1kZWZzLWN1c3RvbS5ncmFwaHFsJyxcbiAgICAgICAgICAgICAgICAndHlwZS1kZWZzLWNvdW50ZXJwYXJ0aWVzLmdyYXBocWwnLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIHN1cHBvcnRTdWJzY3JpcHRpb25zOiB0cnVlLFxuICAgICAgICB9KTtcbiAgICB9XG5cblxuICAgIGFzeW5jIHN0YXJ0KCkge1xuICAgICAgICBUb25DbGllbnQudXNlQmluYXJ5TGlicmFyeShsaWJOb2RlKTtcbiAgICAgICAgdGhpcy5jbGllbnQgPSBuZXcgVG9uQ2xpZW50KCk7XG4gICAgICAgIGF3YWl0IHRoaXMuZGF0YS5zdGFydCgpO1xuICAgICAgICBjb25zdCB7IGhvc3QsIHBvcnQgfSA9IHRoaXMuY29uZmlnLnNlcnZlcjtcbiAgICAgICAgdGhpcy5zZXJ2ZXIubGlzdGVuKHtcbiAgICAgICAgICAgIGhvc3QsXG4gICAgICAgICAgICBwb3J0LFxuICAgICAgICB9LCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmVuZFBvaW50cy5mb3JFYWNoKChlbmRQb2ludDogRW5kUG9pbnQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnR1JBUEhRTCcsIGBodHRwOi8vJHtob3N0fToke3BvcnR9JHtlbmRQb2ludC5wYXRofWApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNlcnZlci5zZXRUaW1lb3V0KDIxNDc0ODM2NDcpO1xuXG4gICAgICAgIGNvbnN0IHZlcnNpb24gPSBwYWNrYWdlSnNvbigpLnZlcnNpb247XG4gICAgICAgIGNvbnN0IHN0YXJ0Q291bnRlciA9IG5ldyBTdGF0c0NvdW50ZXIodGhpcy5zdGF0cywgU1RBVFMuc3RhcnQsIFtgdmVyc2lvbjoke3ZlcnNpb259YF0pO1xuICAgICAgICBzdGFydENvdW50ZXIuaW5jcmVtZW50KClcbiAgICB9XG5cblxuICAgIGFzeW5jIHN0b3AoKSB7XG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB0aGlzLnNlcnZlci5jbG9zZSgoKSA9PiByZXNvbHZlKCkpKTtcbiAgICAgICAgdGhpcy5sb2dzLnN0b3AoKTtcbiAgICB9XG5cbiAgICBhZGRFbmRQb2ludChlbmRQb2ludDogRW5kUG9pbnQpIHtcbiAgICAgICAgY29uc3QgdHlwZURlZnMgPSBlbmRQb2ludC50eXBlRGVmRmlsZU5hbWVzXG4gICAgICAgICAgICAubWFwKHggPT4gZnMucmVhZEZpbGVTeW5jKHBhdGguam9pbigncmVzJywgeCksICd1dGYtOCcpKVxuICAgICAgICAgICAgLmpvaW4oJ1xcbicpO1xuICAgICAgICBjb25zdCBjb25maWc6IEFwb2xsb1NlcnZlckV4cHJlc3NDb25maWcgPSB7XG4gICAgICAgICAgICBkZWJ1ZzogZmFsc2UsXG4gICAgICAgICAgICB0eXBlRGVmcyxcbiAgICAgICAgICAgIHJlc29sdmVyczogZW5kUG9pbnQucmVzb2x2ZXJzLFxuICAgICAgICAgICAgc3Vic2NyaXB0aW9uczoge1xuICAgICAgICAgICAgICAgIGtlZXBBbGl2ZTogdGhpcy5jb25maWcuc2VydmVyLmtlZXBBbGl2ZSxcbiAgICAgICAgICAgICAgICBvbkRpc2Nvbm5lY3QoX3dlYlNvY2tldDogV2ViU29ja2V0LCBjb250ZXh0OiBDb25uZWN0aW9uQ29udGV4dCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY29udGV4dC5hY3RpdmVSZXF1ZXN0cykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5hY3RpdmVSZXF1ZXN0cy5mb3JFYWNoKHggPT4geC5lbWl0Q2xvc2UoKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmFjdGl2ZVJlcXVlc3RzID0gW107XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG9uQ29ubmVjdChjb25uZWN0aW9uUGFyYW1zOiBPYmplY3QsIF93ZWJTb2NrZXQ6IFdlYlNvY2tldCwgY29udGV4dDogQ29ubmVjdGlvbkNvbnRleHQpOiBhbnkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmVSZXF1ZXN0cyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmFjdGl2ZVJlcXVlc3RzID0gYWN0aXZlUmVxdWVzdHM7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVSZXF1ZXN0cyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjY2Vzc0tleTogY29ubmVjdGlvblBhcmFtcy5hY2Nlc3NLZXkgfHwgY29ubmVjdGlvblBhcmFtcy5hY2Nlc3NrZXksXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNvbnRleHQ6ICh7IHJlcSwgY29ubmVjdGlvbiB9KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVxdWVzdCA9IG5ldyBSZXF1ZXN0Q29udHJvbGxlcigpO1xuICAgICAgICAgICAgICAgIGlmIChyZXEgJiYgcmVxLm9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlcS5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LmVtaXRDbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGNvbm5lY3Rpb24gJiYgY29ubmVjdGlvbi5jb250ZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghY29ubmVjdGlvbi5jb250ZXh0LmFjdGl2ZVJlcXVlc3RzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uLmNvbnRleHQuYWN0aXZlUmVxdWVzdHMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmVSZXF1ZXN0cyA9IGNvbm5lY3Rpb24uY29udGV4dC5hY3RpdmVSZXF1ZXN0cztcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZlUmVxdWVzdHMucHVzaChyZXF1ZXN0KTtcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdC5ldmVudHMub24oUmVxdWVzdEV2ZW50LkZJTklTSCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBhY3RpdmVSZXF1ZXN0cy5pbmRleE9mKHJlcXVlc3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVSZXF1ZXN0cy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogdGhpcy5kYXRhLFxuICAgICAgICAgICAgICAgICAgICB0cmFjZXI6IHRoaXMudHJhY2VyLFxuICAgICAgICAgICAgICAgICAgICBzdGF0czogdGhpcy5zdGF0cyxcbiAgICAgICAgICAgICAgICAgICAgYXV0aDogdGhpcy5hdXRoLFxuICAgICAgICAgICAgICAgICAgICBjbGllbnQ6IHRoaXMuY2xpZW50LFxuICAgICAgICAgICAgICAgICAgICBjb25maWc6IHRoaXMuY29uZmlnLFxuICAgICAgICAgICAgICAgICAgICBzaGFyZWQ6IHRoaXMuc2hhcmVkLFxuICAgICAgICAgICAgICAgICAgICByZW1vdGVBZGRyZXNzOiAocmVxICYmIHJlcS5zb2NrZXQgJiYgcmVxLnNvY2tldC5yZW1vdGVBZGRyZXNzKSB8fCAnJyxcbiAgICAgICAgICAgICAgICAgICAgYWNjZXNzS2V5OiBBdXRoLmV4dHJhY3RBY2Nlc3NLZXkocmVxLCBjb25uZWN0aW9uKSxcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50U3BhbjogUVRyYWNlci5leHRyYWN0UGFyZW50U3Bhbih0aGlzLnRyYWNlciwgY29ubmVjdGlvbiA/IGNvbm5lY3Rpb24gOiByZXEpLFxuICAgICAgICAgICAgICAgICAgICByZXEsXG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24sXG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3QsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwbHVnaW5zOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICByZXF1ZXN0RGlkU3RhcnQoX3JlcXVlc3RDb250ZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbGxTZW5kUmVzcG9uc2UoY3R4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dCA9IGN0eC5jb250ZXh0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udGV4dC5tdWx0aXBsZUFjY2Vzc0tleXNEZXRlY3RlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgUUVycm9yLm11bHRpcGxlQWNjZXNzS2V5cygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgYXBvbGxvID0gbmV3IEFwb2xsb1NlcnZlcihjb25maWcpO1xuICAgICAgICBhcG9sbG8uYXBwbHlNaWRkbGV3YXJlKHtcbiAgICAgICAgICAgIGFwcDogdGhpcy5hcHAsXG4gICAgICAgICAgICBwYXRoOiBlbmRQb2ludC5wYXRoLFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGVuZFBvaW50LnN1cHBvcnRTdWJzY3JpcHRpb25zKSB7XG4gICAgICAgICAgICBhcG9sbG8uaW5zdGFsbFN1YnNjcmlwdGlvbkhhbmRsZXJzKHRoaXMuc2VydmVyKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmVuZFBvaW50cy5wdXNoKGVuZFBvaW50KTtcbiAgICB9XG5cblxufVxuIl19