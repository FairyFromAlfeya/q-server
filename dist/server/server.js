"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _express = _interopRequireDefault(require("express"));

var _http = _interopRequireDefault(require("http"));

var _path = _interopRequireDefault(require("path"));

var _apolloServerExpress = require("apollo-server-express");

var _subscriptionsTransportWs = require("subscriptions-transport-ws");

var _tonClientNodeJs = require("ton-client-node-js");

var _data = _interopRequireDefault(require("./data/data"));

var _collection = require("./data/collection");

var _config = require("./config");

var _resolversGenerated = require("./graphql/resolvers-generated");

var _resolversCustom = require("./graphql/resolvers-custom");

var _resolversMam = require("./graphql/resolvers-mam");

var _logs = _interopRequireDefault(require("./logs"));

var _tracer = require("./tracer");

var _opentracing = require("opentracing");

var _auth = require("./auth");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const v8 = require('v8');

class MemStats {
  constructor(stats) {
    this.stats = stats;
  }

  report() {
    v8.getHeapSpaceStatistics().forEach(space => {
      const spaceName = space.space_name.replace('space_', '').replace('_space', '');

      const gauge = (metric, value) => {
        this.stats.gauge(`heap.space.${spaceName}.${metric}`, value);
      };

      gauge('physical_size', space.physical_space_size);
      gauge('available_size', space.space_available_size);
      gauge('size', space.space_size);
      gauge('used_size', space.space_used_size);
    });
  }

  start() {//TODO: this.checkMemReport();
    //TODO: this.checkGc();
  }

  checkMemReport() {
    setTimeout(() => {
      this.report();
      this.checkMemReport();
    }, 5000);
  }

  checkGc() {
    setTimeout(() => {
      global.gc();
      this.checkGc();
    }, 60000);
  }

}

class TONQServer {
  constructor(options) {
    this.config = options.config;
    this.logs = options.logs;
    this.log = this.logs.create('server');
    this.shared = new Map();
    this.tracer = _tracer.QTracer.create(options.config);
    this.stats = _tracer.QStats.create(options.config.statsd.server, options.config.statsd.tags);
    this.auth = new _auth.Auth(options.config);
    this.endPoints = [];
    this.app = (0, _express.default)();
    this.server = _http.default.createServer(this.app);
    this.data = new _data.default(this.config, this.logs, this.auth, this.tracer, this.stats);
    this.memStats = new MemStats(this.stats);
    this.memStats.start();
    this.addEndPoint({
      path: '/graphql/mam',
      resolvers: _resolversMam.resolversMam,
      typeDefFileNames: ['type-defs-mam.graphql'],
      supportSubscriptions: false
    });
    this.addEndPoint({
      path: '/graphql',
      resolvers: (0, _resolversCustom.attachCustomResolvers)(this.data, (0, _resolversGenerated.createResolvers)(this.data)),
      typeDefFileNames: ['type-defs-generated.graphql', 'type-defs-custom.graphql'],
      supportSubscriptions: true
    });
  }

  async start() {
    this.client = await _tonClientNodeJs.TONClient.create({
      servers: ['']
    });
    await this.data.start();
    const {
      host,
      port
    } = this.config.server;
    this.server.listen({
      host,
      port
    }, () => {
      this.endPoints.forEach(endPoint => {
        this.log.debug('GRAPHQL', `http://${host}:${port}${endPoint.path}`);
      });
    });
    this.server.setTimeout(2147483647);
    const version = (0, _utils.packageJson)().version;
    const startCounter = new _tracer.StatsCounter(this.stats, _config.STATS.start, [`version:${version}`]);
    startCounter.increment();
  }

  async stop() {
    await new Promise(resolve => this.server.close(() => resolve()));
    this.logs.stop();
  }

  addEndPoint(endPoint) {
    const typeDefs = endPoint.typeDefFileNames.map(x => _fs.default.readFileSync(_path.default.join('res', x), 'utf-8')).join('\n');
    const config = {
      debug: false,
      typeDefs,
      resolvers: endPoint.resolvers,
      subscriptions: {
        keepAlive: this.config.server.keepAlive,

        onDisconnect(_webSocket, context) {
          if (context.activeRequests) {
            context.activeRequests.forEach(x => x.emitClose());
            context.activeRequests = [];
          }
        },

        onConnect(connectionParams, _webSocket, context) {
          const activeRequests = [];
          context.activeRequests = activeRequests;
          return {
            activeRequests,
            accessKey: connectionParams.accessKey || connectionParams.accesskey
          };
        }

      },
      context: ({
        req,
        connection
      }) => {
        const request = new _collection.RequestController();

        if (req && req.on) {
          req.on('close', () => {
            request.emitClose();
          });
        }

        if (connection && connection.context) {
          if (!connection.context.activeRequests) {
            connection.context.activeRequests = [];
          }

          const activeRequests = connection.context.activeRequests;
          activeRequests.push(request);
          request.events.on(_collection.RequestEvent.FINISH, () => {
            const index = activeRequests.indexOf(request);

            if (index >= 0) {
              activeRequests.splice(index, 1);
            }
          });
        }

        return {
          data: this.data,
          tracer: this.tracer,
          stats: this.stats,
          auth: this.auth,
          client: this.client,
          config: this.config,
          shared: this.shared,
          remoteAddress: req && req.socket && req.socket.remoteAddress || '',
          accessKey: _auth.Auth.extractAccessKey(req, connection),
          parentSpan: _tracer.QTracer.extractParentSpan(this.tracer, connection ? connection : req),
          req,
          connection,
          request
        };
      },
      plugins: [{
        requestDidStart(_requestContext) {
          return {
            willSendResponse(ctx) {
              const context = ctx.context;

              if (context.multipleAccessKeysDetected) {
                throw _utils.QError.multipleAccessKeys();
              }
            }

          };
        }

      }]
    };
    const apollo = new _apolloServerExpress.ApolloServer(config);
    apollo.applyMiddleware({
      app: this.app,
      path: endPoint.path
    });

    if (endPoint.supportSubscriptions) {
      apollo.installSubscriptionHandlers(this.server);
    }

    this.endPoints.push(endPoint);
  }

}

exports.default = TONQServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvc2VydmVyLmpzIl0sIm5hbWVzIjpbInY4IiwicmVxdWlyZSIsIk1lbVN0YXRzIiwiY29uc3RydWN0b3IiLCJzdGF0cyIsInJlcG9ydCIsImdldEhlYXBTcGFjZVN0YXRpc3RpY3MiLCJmb3JFYWNoIiwic3BhY2UiLCJzcGFjZU5hbWUiLCJzcGFjZV9uYW1lIiwicmVwbGFjZSIsImdhdWdlIiwibWV0cmljIiwidmFsdWUiLCJwaHlzaWNhbF9zcGFjZV9zaXplIiwic3BhY2VfYXZhaWxhYmxlX3NpemUiLCJzcGFjZV9zaXplIiwic3BhY2VfdXNlZF9zaXplIiwic3RhcnQiLCJjaGVja01lbVJlcG9ydCIsInNldFRpbWVvdXQiLCJjaGVja0djIiwiZ2xvYmFsIiwiZ2MiLCJUT05RU2VydmVyIiwib3B0aW9ucyIsImNvbmZpZyIsImxvZ3MiLCJsb2ciLCJjcmVhdGUiLCJzaGFyZWQiLCJNYXAiLCJ0cmFjZXIiLCJRVHJhY2VyIiwiUVN0YXRzIiwic3RhdHNkIiwic2VydmVyIiwidGFncyIsImF1dGgiLCJBdXRoIiwiZW5kUG9pbnRzIiwiYXBwIiwiaHR0cCIsImNyZWF0ZVNlcnZlciIsImRhdGEiLCJRRGF0YSIsIm1lbVN0YXRzIiwiYWRkRW5kUG9pbnQiLCJwYXRoIiwicmVzb2x2ZXJzIiwicmVzb2x2ZXJzTWFtIiwidHlwZURlZkZpbGVOYW1lcyIsInN1cHBvcnRTdWJzY3JpcHRpb25zIiwiY2xpZW50IiwiVE9OQ2xpZW50Tm9kZUpzIiwic2VydmVycyIsImhvc3QiLCJwb3J0IiwibGlzdGVuIiwiZW5kUG9pbnQiLCJkZWJ1ZyIsInZlcnNpb24iLCJzdGFydENvdW50ZXIiLCJTdGF0c0NvdW50ZXIiLCJTVEFUUyIsImluY3JlbWVudCIsInN0b3AiLCJQcm9taXNlIiwicmVzb2x2ZSIsImNsb3NlIiwidHlwZURlZnMiLCJtYXAiLCJ4IiwiZnMiLCJyZWFkRmlsZVN5bmMiLCJqb2luIiwic3Vic2NyaXB0aW9ucyIsImtlZXBBbGl2ZSIsIm9uRGlzY29ubmVjdCIsIl93ZWJTb2NrZXQiLCJjb250ZXh0IiwiYWN0aXZlUmVxdWVzdHMiLCJlbWl0Q2xvc2UiLCJvbkNvbm5lY3QiLCJjb25uZWN0aW9uUGFyYW1zIiwiYWNjZXNzS2V5IiwiYWNjZXNza2V5IiwicmVxIiwiY29ubmVjdGlvbiIsInJlcXVlc3QiLCJSZXF1ZXN0Q29udHJvbGxlciIsIm9uIiwicHVzaCIsImV2ZW50cyIsIlJlcXVlc3RFdmVudCIsIkZJTklTSCIsImluZGV4IiwiaW5kZXhPZiIsInNwbGljZSIsInJlbW90ZUFkZHJlc3MiLCJzb2NrZXQiLCJleHRyYWN0QWNjZXNzS2V5IiwicGFyZW50U3BhbiIsImV4dHJhY3RQYXJlbnRTcGFuIiwicGx1Z2lucyIsInJlcXVlc3REaWRTdGFydCIsIl9yZXF1ZXN0Q29udGV4dCIsIndpbGxTZW5kUmVzcG9uc2UiLCJjdHgiLCJtdWx0aXBsZUFjY2Vzc0tleXNEZXRlY3RlZCIsIlFFcnJvciIsIm11bHRpcGxlQWNjZXNzS2V5cyIsImFwb2xsbyIsIkFwb2xsb1NlcnZlciIsImFwcGx5TWlkZGxld2FyZSIsImluc3RhbGxTdWJzY3JpcHRpb25IYW5kbGVycyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQWlCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQTFDQTs7Ozs7Ozs7Ozs7Ozs7O0FBd0RBLE1BQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLElBQUQsQ0FBbEI7O0FBRUEsTUFBTUMsUUFBTixDQUFlO0FBR1hDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFnQjtBQUN2QixTQUFLQSxLQUFMLEdBQWFBLEtBQWI7QUFDSDs7QUFFREMsRUFBQUEsTUFBTSxHQUFHO0FBQ0xMLElBQUFBLEVBQUUsQ0FBQ00sc0JBQUgsR0FBNEJDLE9BQTVCLENBQXFDQyxLQUFELElBQVc7QUFDM0MsWUFB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TyxNQUFBQSxJQUFJLEVBQUVXLFFBQVEsQ0FBQ1g7QUFGSSxLQUF2Qjs7QUFJQSxRQUFJVyxRQUFRLENBQUNQLG9CQUFiLEVBQW1DO0FBQy9CNEQsTUFBQUEsTUFBTSxDQUFDRywyQkFBUCxDQUFtQyxLQUFLL0UsTUFBeEM7QUFDSDs7QUFDRCxTQUFLSSxTQUFMLENBQWVvRCxJQUFmLENBQW9CakMsUUFBcEI7QUFDSDs7QUEzSjJCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE4LTIwMjAgVE9OIERFViBTT0xVVElPTlMgTFRELlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBTT0ZUV0FSRSBFVkFMVUFUSU9OIExpY2Vuc2UgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZVxuICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlXG4gKiBMaWNlbnNlIGF0OlxuICpcbiAqIGh0dHA6Ly93d3cudG9uLmRldi9saWNlbnNlc1xuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgVE9OIERFViBzb2Z0d2FyZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vLyBAZmxvd1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IGh0dHAgZnJvbSAnaHR0cCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IHsgQXBvbGxvU2VydmVyLCBBcG9sbG9TZXJ2ZXJFeHByZXNzQ29uZmlnIH0gZnJvbSAnYXBvbGxvLXNlcnZlci1leHByZXNzJztcbmltcG9ydCB7IENvbm5lY3Rpb25Db250ZXh0IH0gZnJvbSAnc3Vic2NyaXB0aW9ucy10cmFuc3BvcnQtd3MnO1xuaW1wb3J0IHR5cGUgeyBUT05DbGllbnQgfSBmcm9tICd0b24tY2xpZW50LWpzL3R5cGVzJztcbmltcG9ydCB7IFRPTkNsaWVudCBhcyBUT05DbGllbnROb2RlSnMgfSBmcm9tICd0b24tY2xpZW50LW5vZGUtanMnO1xuaW1wb3J0IFFEYXRhIGZyb20gJy4vZGF0YS9kYXRhJztcbmltcG9ydCB7IFJlcXVlc3RDb250cm9sbGVyLCBSZXF1ZXN0RXZlbnQgfSBmcm9tICcuL2RhdGEvY29sbGVjdGlvbic7XG5pbXBvcnQgdHlwZSB7IEdyYXBoUUxSZXF1ZXN0Q29udGV4dCB9IGZyb20gJy4vZGF0YS9jb2xsZWN0aW9uJztcbmltcG9ydCB7IFNUQVRTIH0gZnJvbSAnLi9jb25maWcnO1xuXG5pbXBvcnQgeyBjcmVhdGVSZXNvbHZlcnMgfSBmcm9tICcuL2dyYXBocWwvcmVzb2x2ZXJzLWdlbmVyYXRlZCc7XG5pbXBvcnQgeyBhdHRhY2hDdXN0b21SZXNvbHZlcnMgfSBmcm9tICcuL2dyYXBocWwvcmVzb2x2ZXJzLWN1c3RvbSc7XG5pbXBvcnQgeyByZXNvbHZlcnNNYW0gfSBmcm9tICcuL2dyYXBocWwvcmVzb2x2ZXJzLW1hbSc7XG5cbmltcG9ydCB0eXBlIHsgUUNvbmZpZyB9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCBRTG9ncyBmcm9tICcuL2xvZ3MnO1xuaW1wb3J0IHR5cGUgeyBRTG9nIH0gZnJvbSAnLi9sb2dzJztcbmltcG9ydCB0eXBlIHsgSVN0YXRzIH0gZnJvbSAnLi90cmFjZXInO1xuaW1wb3J0IHsgUVN0YXRzLCBRVHJhY2VyLCBTdGF0c0NvdW50ZXIgfSBmcm9tICcuL3RyYWNlcic7XG5pbXBvcnQgeyBUcmFjZXIgfSBmcm9tICdvcGVudHJhY2luZyc7XG5pbXBvcnQgeyBBdXRoIH0gZnJvbSAnLi9hdXRoJztcbmltcG9ydCB7IHBhY2thZ2VKc29uLCBRRXJyb3IgfSBmcm9tICcuL3V0aWxzJztcblxudHlwZSBRT3B0aW9ucyA9IHtcbiAgICBjb25maWc6IFFDb25maWcsXG4gICAgbG9nczogUUxvZ3MsXG59XG5cbnR5cGUgRW5kUG9pbnQgPSB7XG4gICAgcGF0aDogc3RyaW5nLFxuICAgIHJlc29sdmVyczogYW55LFxuICAgIHR5cGVEZWZGaWxlTmFtZXM6IHN0cmluZ1tdLFxuICAgIHN1cHBvcnRTdWJzY3JpcHRpb25zOiBib29sZWFuLFxufVxuXG5jb25zdCB2OCA9IHJlcXVpcmUoJ3Y4Jyk7XG5cbmNsYXNzIE1lbVN0YXRzIHtcbiAgICBzdGF0czogSVN0YXRzO1xuXG4gICAgY29uc3RydWN0b3Ioc3RhdHM6IElTdGF0cykge1xuICAgICAgICB0aGlzLnN0YXRzID0gc3RhdHM7XG4gICAgfVxuXG4gICAgcmVwb3J0KCkge1xuICAgICAgICB2OC5nZXRIZWFwU3BhY2VTdGF0aXN0aWNzKCkuZm9yRWFjaCgoc3BhY2UpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNwYWNlTmFtZSA9IHNwYWNlLnNwYWNlX25hbWVcbiAgICAgICAgICAgICAgICAucmVwbGFjZSgnc3BhY2VfJywgJycpXG4gICAgICAgICAgICAgICAgLnJlcGxhY2UoJ19zcGFjZScsICcnKTtcbiAgICAgICAgICAgIGNvbnN0IGdhdWdlID0gKG1ldHJpYzogc3RyaW5nLCB2YWx1ZTogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5nYXVnZShgaGVhcC5zcGFjZS4ke3NwYWNlTmFtZX0uJHttZXRyaWN9YCwgdmFsdWUpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGdhdWdlKCdwaHlzaWNhbF9zaXplJywgc3BhY2UucGh5c2ljYWxfc3BhY2Vfc2l6ZSk7XG4gICAgICAgICAgICBnYXVnZSgnYXZhaWxhYmxlX3NpemUnLCBzcGFjZS5zcGFjZV9hdmFpbGFibGVfc2l6ZSk7XG4gICAgICAgICAgICBnYXVnZSgnc2l6ZScsIHNwYWNlLnNwYWNlX3NpemUpO1xuICAgICAgICAgICAgZ2F1Z2UoJ3VzZWRfc2l6ZScsIHNwYWNlLnNwYWNlX3VzZWRfc2l6ZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHN0YXJ0KCkge1xuICAgICAgICAvL1RPRE86IHRoaXMuY2hlY2tNZW1SZXBvcnQoKTtcbiAgICAgICAgLy9UT0RPOiB0aGlzLmNoZWNrR2MoKTtcbiAgICB9XG5cbiAgICBjaGVja01lbVJlcG9ydCgpIHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlcG9ydCgpO1xuICAgICAgICAgICAgdGhpcy5jaGVja01lbVJlcG9ydCgpO1xuICAgICAgICB9LCA1MDAwKTtcbiAgICB9XG5cbiAgICBjaGVja0djKCkge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIGdsb2JhbC5nYygpO1xuICAgICAgICAgICAgdGhpcy5jaGVja0djKCk7XG4gICAgICAgIH0sIDYwMDAwKTtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRPTlFTZXJ2ZXIge1xuICAgIGNvbmZpZzogUUNvbmZpZztcbiAgICBsb2dzOiBRTG9ncztcbiAgICBsb2c6IFFMb2c7XG4gICAgYXBwOiBleHByZXNzLkFwcGxpY2F0aW9uO1xuICAgIHNlcnZlcjogYW55O1xuICAgIGVuZFBvaW50czogRW5kUG9pbnRbXTtcbiAgICBkYXRhOiBRRGF0YTtcbiAgICB0cmFjZXI6IFRyYWNlcjtcbiAgICBzdGF0czogSVN0YXRzO1xuICAgIGNsaWVudDogVE9OQ2xpZW50O1xuICAgIGF1dGg6IEF1dGg7XG4gICAgbWVtU3RhdHM6IE1lbVN0YXRzO1xuICAgIHNoYXJlZDogTWFwPHN0cmluZywgYW55PjtcblxuXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczogUU9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5jb25maWcgPSBvcHRpb25zLmNvbmZpZztcbiAgICAgICAgdGhpcy5sb2dzID0gb3B0aW9ucy5sb2dzO1xuICAgICAgICB0aGlzLmxvZyA9IHRoaXMubG9ncy5jcmVhdGUoJ3NlcnZlcicpO1xuICAgICAgICB0aGlzLnNoYXJlZCA9IG5ldyBNYXAoKTtcbiAgICAgICAgdGhpcy50cmFjZXIgPSBRVHJhY2VyLmNyZWF0ZShvcHRpb25zLmNvbmZpZyk7XG4gICAgICAgIHRoaXMuc3RhdHMgPSBRU3RhdHMuY3JlYXRlKG9wdGlvbnMuY29uZmlnLnN0YXRzZC5zZXJ2ZXIsIG9wdGlvbnMuY29uZmlnLnN0YXRzZC50YWdzKTtcbiAgICAgICAgdGhpcy5hdXRoID0gbmV3IEF1dGgob3B0aW9ucy5jb25maWcpO1xuICAgICAgICB0aGlzLmVuZFBvaW50cyA9IFtdO1xuICAgICAgICB0aGlzLmFwcCA9IGV4cHJlc3MoKTtcbiAgICAgICAgdGhpcy5zZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcih0aGlzLmFwcCk7XG4gICAgICAgIHRoaXMuZGF0YSA9IG5ldyBRRGF0YSh0aGlzLmNvbmZpZywgdGhpcy5sb2dzLCB0aGlzLmF1dGgsIHRoaXMudHJhY2VyLCB0aGlzLnN0YXRzKTtcbiAgICAgICAgdGhpcy5tZW1TdGF0cyA9IG5ldyBNZW1TdGF0cyh0aGlzLnN0YXRzKTtcbiAgICAgICAgdGhpcy5tZW1TdGF0cy5zdGFydCgpO1xuICAgICAgICB0aGlzLmFkZEVuZFBvaW50KHtcbiAgICAgICAgICAgIHBhdGg6ICcvZ3JhcGhxbC9tYW0nLFxuICAgICAgICAgICAgcmVzb2x2ZXJzOiByZXNvbHZlcnNNYW0sXG4gICAgICAgICAgICB0eXBlRGVmRmlsZU5hbWVzOiBbJ3R5cGUtZGVmcy1tYW0uZ3JhcGhxbCddLFxuICAgICAgICAgICAgc3VwcG9ydFN1YnNjcmlwdGlvbnM6IGZhbHNlLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5hZGRFbmRQb2ludCh7XG4gICAgICAgICAgICBwYXRoOiAnL2dyYXBocWwnLFxuICAgICAgICAgICAgcmVzb2x2ZXJzOiBhdHRhY2hDdXN0b21SZXNvbHZlcnModGhpcy5kYXRhLCBjcmVhdGVSZXNvbHZlcnModGhpcy5kYXRhKSksXG4gICAgICAgICAgICB0eXBlRGVmRmlsZU5hbWVzOiBbJ3R5cGUtZGVmcy1nZW5lcmF0ZWQuZ3JhcGhxbCcsICd0eXBlLWRlZnMtY3VzdG9tLmdyYXBocWwnXSxcbiAgICAgICAgICAgIHN1cHBvcnRTdWJzY3JpcHRpb25zOiB0cnVlLFxuICAgICAgICB9KTtcbiAgICB9XG5cblxuICAgIGFzeW5jIHN0YXJ0KCkge1xuICAgICAgICB0aGlzLmNsaWVudCA9IGF3YWl0IFRPTkNsaWVudE5vZGVKcy5jcmVhdGUoeyBzZXJ2ZXJzOiBbJyddIH0pO1xuICAgICAgICBhd2FpdCB0aGlzLmRhdGEuc3RhcnQoKTtcbiAgICAgICAgY29uc3QgeyBob3N0LCBwb3J0IH0gPSB0aGlzLmNvbmZpZy5zZXJ2ZXI7XG4gICAgICAgIHRoaXMuc2VydmVyLmxpc3Rlbih7XG4gICAgICAgICAgICBob3N0LFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5lbmRQb2ludHMuZm9yRWFjaCgoZW5kUG9pbnQ6IEVuZFBvaW50KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2cuZGVidWcoJ0dSQVBIUUwnLCBgaHR0cDovLyR7aG9zdH06JHtwb3J0fSR7ZW5kUG9pbnQucGF0aH1gKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zZXJ2ZXIuc2V0VGltZW91dCgyMTQ3NDgzNjQ3KTtcblxuICAgICAgICBjb25zdCB2ZXJzaW9uID0gcGFja2FnZUpzb24oKS52ZXJzaW9uO1xuICAgICAgICBjb25zdCBzdGFydENvdW50ZXIgPSBuZXcgU3RhdHNDb3VudGVyKHRoaXMuc3RhdHMsIFNUQVRTLnN0YXJ0LCBbYHZlcnNpb246JHt2ZXJzaW9ufWBdKTtcbiAgICAgICAgc3RhcnRDb3VudGVyLmluY3JlbWVudCgpXG4gICAgfVxuXG5cbiAgICBhc3luYyBzdG9wKCkge1xuICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gdGhpcy5zZXJ2ZXIuY2xvc2UoKCkgPT4gcmVzb2x2ZSgpKSk7XG4gICAgICAgIHRoaXMubG9ncy5zdG9wKCk7XG4gICAgfVxuXG4gICAgYWRkRW5kUG9pbnQoZW5kUG9pbnQ6IEVuZFBvaW50KSB7XG4gICAgICAgIGNvbnN0IHR5cGVEZWZzID0gZW5kUG9pbnQudHlwZURlZkZpbGVOYW1lc1xuICAgICAgICAgICAgLm1hcCh4ID0+IGZzLnJlYWRGaWxlU3luYyhwYXRoLmpvaW4oJ3JlcycsIHgpLCAndXRmLTgnKSlcbiAgICAgICAgICAgIC5qb2luKCdcXG4nKTtcbiAgICAgICAgY29uc3QgY29uZmlnOiBBcG9sbG9TZXJ2ZXJFeHByZXNzQ29uZmlnID0ge1xuICAgICAgICAgICAgZGVidWc6IGZhbHNlLFxuICAgICAgICAgICAgdHlwZURlZnMsXG4gICAgICAgICAgICByZXNvbHZlcnM6IGVuZFBvaW50LnJlc29sdmVycyxcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbnM6IHtcbiAgICAgICAgICAgICAgICBrZWVwQWxpdmU6IHRoaXMuY29uZmlnLnNlcnZlci5rZWVwQWxpdmUsXG4gICAgICAgICAgICAgICAgb25EaXNjb25uZWN0KF93ZWJTb2NrZXQ6IFdlYlNvY2tldCwgY29udGV4dDogQ29ubmVjdGlvbkNvbnRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRleHQuYWN0aXZlUmVxdWVzdHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQuYWN0aXZlUmVxdWVzdHMuZm9yRWFjaCh4ID0+IHguZW1pdENsb3NlKCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5hY3RpdmVSZXF1ZXN0cyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBvbkNvbm5lY3QoY29ubmVjdGlvblBhcmFtczogT2JqZWN0LCBfd2ViU29ja2V0OiBXZWJTb2NrZXQsIGNvbnRleHQ6IENvbm5lY3Rpb25Db250ZXh0KTogYW55IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0aXZlUmVxdWVzdHMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5hY3RpdmVSZXF1ZXN0cyA9IGFjdGl2ZVJlcXVlc3RzO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlUmVxdWVzdHMsXG4gICAgICAgICAgICAgICAgICAgICAgICBhY2Nlc3NLZXk6IGNvbm5lY3Rpb25QYXJhbXMuYWNjZXNzS2V5IHx8IGNvbm5lY3Rpb25QYXJhbXMuYWNjZXNza2V5LFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjb250ZXh0OiAoeyByZXEsIGNvbm5lY3Rpb24gfSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgUmVxdWVzdENvbnRyb2xsZXIoKTtcbiAgICAgICAgICAgICAgICBpZiAocmVxICYmIHJlcS5vbikge1xuICAgICAgICAgICAgICAgICAgICByZXEub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdC5lbWl0Q2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChjb25uZWN0aW9uICYmIGNvbm5lY3Rpb24uY29udGV4dCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbm5lY3Rpb24uY29udGV4dC5hY3RpdmVSZXF1ZXN0cykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbi5jb250ZXh0LmFjdGl2ZVJlcXVlc3RzID0gW107XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0aXZlUmVxdWVzdHMgPSBjb25uZWN0aW9uLmNvbnRleHQuYWN0aXZlUmVxdWVzdHM7XG4gICAgICAgICAgICAgICAgICAgIGFjdGl2ZVJlcXVlc3RzLnB1c2gocmVxdWVzdCk7XG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3QuZXZlbnRzLm9uKFJlcXVlc3RFdmVudC5GSU5JU0gsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gYWN0aXZlUmVxdWVzdHMuaW5kZXhPZihyZXF1ZXN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlUmVxdWVzdHMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHRoaXMuZGF0YSxcbiAgICAgICAgICAgICAgICAgICAgdHJhY2VyOiB0aGlzLnRyYWNlcixcbiAgICAgICAgICAgICAgICAgICAgc3RhdHM6IHRoaXMuc3RhdHMsXG4gICAgICAgICAgICAgICAgICAgIGF1dGg6IHRoaXMuYXV0aCxcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50OiB0aGlzLmNsaWVudCxcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnOiB0aGlzLmNvbmZpZyxcbiAgICAgICAgICAgICAgICAgICAgc2hhcmVkOiB0aGlzLnNoYXJlZCxcbiAgICAgICAgICAgICAgICAgICAgcmVtb3RlQWRkcmVzczogKHJlcSAmJiByZXEuc29ja2V0ICYmIHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcykgfHwgJycsXG4gICAgICAgICAgICAgICAgICAgIGFjY2Vzc0tleTogQXV0aC5leHRyYWN0QWNjZXNzS2V5KHJlcSwgY29ubmVjdGlvbiksXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudFNwYW46IFFUcmFjZXIuZXh0cmFjdFBhcmVudFNwYW4odGhpcy50cmFjZXIsIGNvbm5lY3Rpb24gPyBjb25uZWN0aW9uIDogcmVxKSxcbiAgICAgICAgICAgICAgICAgICAgcmVxLFxuICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uLFxuICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcGx1Z2luczogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdERpZFN0YXJ0KF9yZXF1ZXN0Q29udGV4dCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWxsU2VuZFJlc3BvbnNlKGN0eCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHQgPSBjdHguY29udGV4dDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRleHQubXVsdGlwbGVBY2Nlc3NLZXlzRGV0ZWN0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IFFFcnJvci5tdWx0aXBsZUFjY2Vzc0tleXMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IGFwb2xsbyA9IG5ldyBBcG9sbG9TZXJ2ZXIoY29uZmlnKTtcbiAgICAgICAgYXBvbGxvLmFwcGx5TWlkZGxld2FyZSh7XG4gICAgICAgICAgICBhcHA6IHRoaXMuYXBwLFxuICAgICAgICAgICAgcGF0aDogZW5kUG9pbnQucGF0aCxcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChlbmRQb2ludC5zdXBwb3J0U3Vic2NyaXB0aW9ucykge1xuICAgICAgICAgICAgYXBvbGxvLmluc3RhbGxTdWJzY3JpcHRpb25IYW5kbGVycyh0aGlzLnNlcnZlcik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5lbmRQb2ludHMucHVzaChlbmRQb2ludCk7XG4gICAgfVxuXG5cbn1cblxuIl19