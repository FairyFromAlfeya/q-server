"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _express = _interopRequireDefault(require("express"));

var _http = _interopRequireDefault(require("http"));

var _apolloServerExpress = require("apollo-server-express");

var _subscriptionsTransportWs = require("subscriptions-transport-ws");

var _tonClientNodeJs = require("ton-client-node-js");

var _arango = _interopRequireDefault(require("./arango"));

var _resolversGenerated = require("./resolvers-generated");

var _resolversCustom = require("./resolvers-custom");

var _resolversMam = require("./resolvers-mam");

var _logs = _interopRequireDefault(require("./logs"));

var _tracer = require("./tracer");

var _opentracing = require("opentracing");

var _auth = require("./auth");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
class TONQServer {
  constructor(options) {
    this.config = options.config;
    this.logs = options.logs;
    this.log = this.logs.create('server');
    this.shared = new Map();
    this.tracer = _tracer.QTracer.create(options.config);
    this.auth = new _auth.Auth(options.config);
    this.endPoints = [];
    this.app = (0, _express.default)();
    this.server = _http.default.createServer(this.app);
    this.db = new _arango.default(this.config, this.logs, this.auth, this.tracer);
    this.addEndPoint({
      path: '/graphql/mam',
      resolvers: _resolversMam.resolversMam,
      typeDefFileNames: ['type-defs-mam.graphql'],
      supportSubscriptions: false
    });
    this.addEndPoint({
      path: '/graphql',
      resolvers: (0, _resolversCustom.attachCustomResolvers)((0, _resolversGenerated.createResolvers)(this.db)),
      typeDefFileNames: ['type-defs-generated.graphql', 'type-defs-custom.graphql'],
      supportSubscriptions: true
    });
  }

  async start() {
    this.client = await _tonClientNodeJs.TONClient.create({
      servers: ['']
    });
    await this.db.start();
    const {
      host,
      port
    } = this.config.server;
    this.server.listen({
      host,
      port
    }, () => {
      this.endPoints.forEach(endPoint => {
        this.log.debug('GRAPHQL', `http://${host}:${port}${endPoint.path}`);
      });
    });
  }

  addEndPoint(endPoint) {
    const typeDefs = endPoint.typeDefFileNames.map(x => _fs.default.readFileSync(x, 'utf-8')).join('\n');
    const config = {
      typeDefs,
      resolvers: endPoint.resolvers,
      subscriptions: {
        onConnect(connectionParams, _websocket, _context) {
          return {
            accessKey: connectionParams.accessKey || connectionParams.accesskey
          };
        }

      },
      context: ({
        req,
        connection
      }) => {
        return {
          db: this.db,
          tracer: this.tracer,
          auth: this.auth,
          client: this.client,
          config: this.config,
          shared: this.shared,
          remoteAddress: req && req.socket && req.socket.remoteAddress || '',
          accessKey: _auth.Auth.extractAccessKey(req, connection),
          parentSpan: _tracer.QTracer.extractParentSpan(this.tracer, connection ? connection : req)
        };
      }
    };
    const apollo = new _apolloServerExpress.ApolloServer(config);
    apollo.applyMiddleware({
      app: this.app,
      path: endPoint.path
    });

    if (endPoint.supportSubscriptions) {
      apollo.installSubscriptionHandlers(this.server);
    }

    this.endPoints.push(endPoint);
  }

}

exports.default = TONQServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9zZXJ2ZXIuanMiXSwibmFtZXMiOlsiVE9OUVNlcnZlciIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImNvbmZpZyIsImxvZ3MiLCJsb2ciLCJjcmVhdGUiLCJzaGFyZWQiLCJNYXAiLCJ0cmFjZXIiLCJRVHJhY2VyIiwiYXV0aCIsIkF1dGgiLCJlbmRQb2ludHMiLCJhcHAiLCJzZXJ2ZXIiLCJodHRwIiwiY3JlYXRlU2VydmVyIiwiZGIiLCJBcmFuZ28iLCJhZGRFbmRQb2ludCIsInBhdGgiLCJyZXNvbHZlcnMiLCJyZXNvbHZlcnNNYW0iLCJ0eXBlRGVmRmlsZU5hbWVzIiwic3VwcG9ydFN1YnNjcmlwdGlvbnMiLCJzdGFydCIsImNsaWVudCIsIlRPTkNsaWVudE5vZGVKcyIsInNlcnZlcnMiLCJob3N0IiwicG9ydCIsImxpc3RlbiIsImZvckVhY2giLCJlbmRQb2ludCIsImRlYnVnIiwidHlwZURlZnMiLCJtYXAiLCJ4IiwiZnMiLCJyZWFkRmlsZVN5bmMiLCJqb2luIiwic3Vic2NyaXB0aW9ucyIsIm9uQ29ubmVjdCIsImNvbm5lY3Rpb25QYXJhbXMiLCJfd2Vic29ja2V0IiwiX2NvbnRleHQiLCJhY2Nlc3NLZXkiLCJhY2Nlc3NrZXkiLCJjb250ZXh0IiwicmVxIiwiY29ubmVjdGlvbiIsInJlbW90ZUFkZHJlc3MiLCJzb2NrZXQiLCJleHRyYWN0QWNjZXNzS2V5IiwicGFyZW50U3BhbiIsImV4dHJhY3RQYXJlbnRTcGFuIiwiYXBvbGxvIiwiQXBvbGxvU2VydmVyIiwiYXBwbHlNaWRkbGV3YXJlIiwiaW5zdGFsbFN1YnNjcmlwdGlvbkhhbmRsZXJzIiwicHVzaCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQWlCQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFFQTs7QUFDQTs7QUFDQTs7OztBQXBDQTs7Ozs7Ozs7Ozs7Ozs7O0FBa0RlLE1BQU1BLFVBQU4sQ0FB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QW9CM0IsUUFBcEI7QUFDSDs7QUF0RjJCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE4LTIwMjAgVE9OIERFViBTT0xVVElPTlMgTFRELlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBTT0ZUV0FSRSBFVkFMVUFUSU9OIExpY2Vuc2UgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZVxuICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlXG4gKiBMaWNlbnNlIGF0OlxuICpcbiAqIGh0dHA6Ly93d3cudG9uLmRldi9saWNlbnNlc1xuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgVE9OIERFViBzb2Z0d2FyZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vLyBAZmxvd1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IGh0dHAgZnJvbSAnaHR0cCc7XG5cbmltcG9ydCB7IEFwb2xsb1NlcnZlciwgQXBvbGxvU2VydmVyRXhwcmVzc0NvbmZpZyB9IGZyb20gJ2Fwb2xsby1zZXJ2ZXItZXhwcmVzcyc7XG5pbXBvcnQgeyBDb25uZWN0aW9uQ29udGV4dCB9IGZyb20gJ3N1YnNjcmlwdGlvbnMtdHJhbnNwb3J0LXdzJztcbmltcG9ydCB0eXBlIHsgVE9OQ2xpZW50IH0gZnJvbSBcInRvbi1jbGllbnQtanMvdHlwZXNcIjtcbmltcG9ydCB7IFRPTkNsaWVudCBhcyBUT05DbGllbnROb2RlSnMgfSBmcm9tICd0b24tY2xpZW50LW5vZGUtanMnO1xuaW1wb3J0IEFyYW5nbyBmcm9tICcuL2FyYW5nbyc7XG5cbmltcG9ydCB7IGNyZWF0ZVJlc29sdmVycyB9IGZyb20gJy4vcmVzb2x2ZXJzLWdlbmVyYXRlZCc7XG5pbXBvcnQgeyBhdHRhY2hDdXN0b21SZXNvbHZlcnMgfSBmcm9tIFwiLi9yZXNvbHZlcnMtY3VzdG9tXCI7XG5pbXBvcnQgeyByZXNvbHZlcnNNYW0gfSBmcm9tIFwiLi9yZXNvbHZlcnMtbWFtXCI7XG5cbmltcG9ydCB0eXBlIHsgUUNvbmZpZyB9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCBRTG9ncyBmcm9tICcuL2xvZ3MnO1xuaW1wb3J0IHR5cGUgeyBRTG9nIH0gZnJvbSAnLi9sb2dzJztcbmltcG9ydCB7IFFUcmFjZXIgfSBmcm9tIFwiLi90cmFjZXJcIjtcbmltcG9ydCB7IFRyYWNlciB9IGZyb20gXCJvcGVudHJhY2luZ1wiO1xuaW1wb3J0IHsgQXV0aCB9IGZyb20gJy4vYXV0aCc7XG5cbnR5cGUgUU9wdGlvbnMgPSB7XG4gICAgY29uZmlnOiBRQ29uZmlnLFxuICAgIGxvZ3M6IFFMb2dzLFxufVxuXG50eXBlIEVuZFBvaW50ID0ge1xuICAgIHBhdGg6IHN0cmluZyxcbiAgICByZXNvbHZlcnM6IGFueSxcbiAgICB0eXBlRGVmRmlsZU5hbWVzOiBzdHJpbmdbXSxcbiAgICBzdXBwb3J0U3Vic2NyaXB0aW9uczogYm9vbGVhbixcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVE9OUVNlcnZlciB7XG4gICAgY29uZmlnOiBRQ29uZmlnO1xuICAgIGxvZ3M6IFFMb2dzO1xuICAgIGxvZzogUUxvZztcbiAgICBhcHA6IGV4cHJlc3MuQXBwbGljYXRpb247XG4gICAgc2VydmVyOiBhbnk7XG4gICAgZW5kUG9pbnRzOiBFbmRQb2ludFtdO1xuICAgIGRiOiBBcmFuZ287XG4gICAgdHJhY2VyOiBUcmFjZXI7XG4gICAgY2xpZW50OiBUT05DbGllbnQ7XG4gICAgYXV0aDogQXV0aDtcbiAgICBzaGFyZWQ6IE1hcDxzdHJpbmcsIGFueT47XG5cblxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IFFPcHRpb25zKSB7XG4gICAgICAgIHRoaXMuY29uZmlnID0gb3B0aW9ucy5jb25maWc7XG4gICAgICAgIHRoaXMubG9ncyA9IG9wdGlvbnMubG9ncztcbiAgICAgICAgdGhpcy5sb2cgPSB0aGlzLmxvZ3MuY3JlYXRlKCdzZXJ2ZXInKTtcbiAgICAgICAgdGhpcy5zaGFyZWQgPSBuZXcgTWFwKCk7XG4gICAgICAgIHRoaXMudHJhY2VyID0gUVRyYWNlci5jcmVhdGUob3B0aW9ucy5jb25maWcpO1xuICAgICAgICB0aGlzLmF1dGggPSBuZXcgQXV0aChvcHRpb25zLmNvbmZpZyk7XG4gICAgICAgIHRoaXMuZW5kUG9pbnRzID0gW107XG4gICAgICAgIHRoaXMuYXBwID0gZXhwcmVzcygpO1xuICAgICAgICB0aGlzLnNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKHRoaXMuYXBwKTtcbiAgICAgICAgdGhpcy5kYiA9IG5ldyBBcmFuZ28odGhpcy5jb25maWcsIHRoaXMubG9ncywgdGhpcy5hdXRoLCB0aGlzLnRyYWNlcik7XG4gICAgICAgIHRoaXMuYWRkRW5kUG9pbnQoe1xuICAgICAgICAgICAgcGF0aDogJy9ncmFwaHFsL21hbScsXG4gICAgICAgICAgICByZXNvbHZlcnM6IHJlc29sdmVyc01hbSxcbiAgICAgICAgICAgIHR5cGVEZWZGaWxlTmFtZXM6IFsndHlwZS1kZWZzLW1hbS5ncmFwaHFsJ10sXG4gICAgICAgICAgICBzdXBwb3J0U3Vic2NyaXB0aW9uczogZmFsc2UsXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmFkZEVuZFBvaW50KHtcbiAgICAgICAgICAgIHBhdGg6ICcvZ3JhcGhxbCcsXG4gICAgICAgICAgICByZXNvbHZlcnM6IGF0dGFjaEN1c3RvbVJlc29sdmVycyhjcmVhdGVSZXNvbHZlcnModGhpcy5kYikpLFxuICAgICAgICAgICAgdHlwZURlZkZpbGVOYW1lczogWyd0eXBlLWRlZnMtZ2VuZXJhdGVkLmdyYXBocWwnLCAndHlwZS1kZWZzLWN1c3RvbS5ncmFwaHFsJ10sXG4gICAgICAgICAgICBzdXBwb3J0U3Vic2NyaXB0aW9uczogdHJ1ZSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG5cbiAgICBhc3luYyBzdGFydCgpIHtcbiAgICAgICAgdGhpcy5jbGllbnQgPSBhd2FpdCBUT05DbGllbnROb2RlSnMuY3JlYXRlKHsgc2VydmVyczogWycnXSB9KTtcbiAgICAgICAgYXdhaXQgdGhpcy5kYi5zdGFydCgpO1xuICAgICAgICBjb25zdCB7IGhvc3QsIHBvcnQgfSA9IHRoaXMuY29uZmlnLnNlcnZlcjtcbiAgICAgICAgdGhpcy5zZXJ2ZXIubGlzdGVuKHsgaG9zdCwgcG9ydCB9LCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmVuZFBvaW50cy5mb3JFYWNoKChlbmRQb2ludDogRW5kUG9pbnQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnR1JBUEhRTCcsIGBodHRwOi8vJHtob3N0fToke3BvcnR9JHtlbmRQb2ludC5wYXRofWApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgYWRkRW5kUG9pbnQoZW5kUG9pbnQ6IEVuZFBvaW50KSB7XG4gICAgICAgIGNvbnN0IHR5cGVEZWZzID0gZW5kUG9pbnQudHlwZURlZkZpbGVOYW1lc1xuICAgICAgICAgICAgLm1hcCh4ID0+IGZzLnJlYWRGaWxlU3luYyh4LCAndXRmLTgnKSlcbiAgICAgICAgICAgIC5qb2luKCdcXG4nKTtcbiAgICAgICAgY29uc3QgY29uZmlnOiBBcG9sbG9TZXJ2ZXJFeHByZXNzQ29uZmlnID0ge1xuICAgICAgICAgICAgdHlwZURlZnMsXG4gICAgICAgICAgICByZXNvbHZlcnM6IGVuZFBvaW50LnJlc29sdmVycyxcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbnM6IHtcbiAgICAgICAgICAgICAgICBvbkNvbm5lY3QoY29ubmVjdGlvblBhcmFtczogT2JqZWN0LCBfd2Vic29ja2V0OiBXZWJTb2NrZXQsIF9jb250ZXh0OiBDb25uZWN0aW9uQ29udGV4dCk6IGFueSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY2Nlc3NLZXk6IGNvbm5lY3Rpb25QYXJhbXMuYWNjZXNzS2V5IHx8IGNvbm5lY3Rpb25QYXJhbXMuYWNjZXNza2V5LFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNvbnRleHQ6ICh7IHJlcSwgY29ubmVjdGlvbiB9KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgZGI6IHRoaXMuZGIsXG4gICAgICAgICAgICAgICAgICAgIHRyYWNlcjogdGhpcy50cmFjZXIsXG4gICAgICAgICAgICAgICAgICAgIGF1dGg6IHRoaXMuYXV0aCxcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50OiB0aGlzLmNsaWVudCxcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnOiB0aGlzLmNvbmZpZyxcbiAgICAgICAgICAgICAgICAgICAgc2hhcmVkOiB0aGlzLnNoYXJlZCxcbiAgICAgICAgICAgICAgICAgICAgcmVtb3RlQWRkcmVzczogKHJlcSAmJiByZXEuc29ja2V0ICYmIHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcykgfHwgJycsXG4gICAgICAgICAgICAgICAgICAgIGFjY2Vzc0tleTogQXV0aC5leHRyYWN0QWNjZXNzS2V5KHJlcSwgY29ubmVjdGlvbiksXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudFNwYW46IFFUcmFjZXIuZXh0cmFjdFBhcmVudFNwYW4odGhpcy50cmFjZXIsIGNvbm5lY3Rpb24gPyBjb25uZWN0aW9uIDogcmVxKSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgYXBvbGxvID0gbmV3IEFwb2xsb1NlcnZlcihjb25maWcpO1xuICAgICAgICBhcG9sbG8uYXBwbHlNaWRkbGV3YXJlKHsgYXBwOiB0aGlzLmFwcCwgcGF0aDogZW5kUG9pbnQucGF0aCB9KTtcbiAgICAgICAgaWYgKGVuZFBvaW50LnN1cHBvcnRTdWJzY3JpcHRpb25zKSB7XG4gICAgICAgICAgICBhcG9sbG8uaW5zdGFsbFN1YnNjcmlwdGlvbkhhbmRsZXJzKHRoaXMuc2VydmVyKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmVuZFBvaW50cy5wdXNoKGVuZFBvaW50KTtcbiAgICB9XG5cblxufVxuXG4iXX0=