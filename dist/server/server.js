"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _express = _interopRequireDefault(require("express"));

var _http = _interopRequireDefault(require("http"));

var _ws = _interopRequireDefault(require("ws"));

var _apolloServerExpress = require("apollo-server-express");

var _subscriptionsTransportWs = require("subscriptions-transport-ws");

var _tonClientNodeJs = require("ton-client-node-js");

var _arango = _interopRequireDefault(require("./arango"));

var _resolversGenerated = require("./resolvers-generated");

var _resolversCustom = require("./resolvers-custom");

var _resolversMam = require("./resolvers-mam");

var _logs = _interopRequireDefault(require("./logs"));

var _tracer = require("./tracer");

var _opentracing = require("opentracing");

var _auth = require("./auth");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const v8 = require('v8');

class MemStats {
  constructor(stats) {
    this.stats = stats;
  }

  report() {
    v8.getHeapSpaceStatistics().forEach(space => {
      const spaceName = space.space_name.replace('space_', '').replace('_space', '');

      const gauge = (metric, value) => {
        this.stats.gauge(`heap.space.${spaceName}.${metric}`, value);
      };

      gauge('physical_size', space.physical_space_size);
      gauge('available_size', space.space_available_size);
      gauge('size', space.space_size);
      gauge('used_size', space.space_used_size);
    });
  }

  start() {
    setTimeout(() => {
      this.report();
      this.start();
    }, 5000);
  }

}

class TONQServer {
  constructor(options) {
    this.config = options.config;
    this.logs = options.logs;
    this.log = this.logs.create('server');
    this.shared = new Map();
    this.tracer = _tracer.QTracer.create(options.config);
    this.stats = _tracer.QStats.create(options.config.statsd.server);
    this.auth = new _auth.Auth(options.config);
    this.endPoints = [];
    this.app = (0, _express.default)();
    this.server = _http.default.createServer(this.app);
    this.db = new _arango.default(this.config, this.logs, this.auth, this.tracer, this.stats);
    this.memStats = new MemStats(this.stats);
    this.memStats.start();
    this.addEndPoint({
      path: '/graphql/mam',
      resolvers: _resolversMam.resolversMam,
      typeDefFileNames: ['type-defs-mam.graphql'],
      supportSubscriptions: false
    });
    this.addEndPoint({
      path: '/graphql',
      resolvers: (0, _resolversCustom.attachCustomResolvers)((0, _resolversGenerated.createResolvers)(this.db)),
      typeDefFileNames: ['type-defs-generated.graphql', 'type-defs-custom.graphql'],
      supportSubscriptions: true
    });
  }

  async start() {
    this.client = await _tonClientNodeJs.TONClient.create({
      servers: ['']
    });
    await this.db.start();
    const {
      host,
      port
    } = this.config.server;
    this.server.listen({
      host,
      port
    }, () => {
      this.endPoints.forEach(endPoint => {
        this.log.debug('GRAPHQL', `http://${host}:${port}${endPoint.path}`);
      });
    });
    this.server.setTimeout(2147483647);
    this.app.post('/api', (req, res) => {
      (async () => {
        this.db.transactions.statQuery.increment();
        this.db.transactions.statQueryActive.increment();
        await new Promise(resolve => setTimeout(resolve, 40000));
        res.send('{}');
        this.db.transactions.statQueryActive.decrement();
      })();
    });
    const MESSAGE = {
      request: 1,
      response: 2
    };
    const wss = new _ws.default.Server({
      port: 8084
    });
    wss.on('connection', ws => {
      ws.on('message', data => {
        (async () => {
          const message = JSON.parse(data);

          if (message.type === MESSAGE.request) {
            this.db.transactions.statQuery.increment();
            this.db.transactions.statQueryActive.increment();
            await new Promise(resolve => setTimeout(resolve, 40000));
            this.db.transactions.statQueryActive.decrement();
            ws.send(JSON.stringify({
              type: MESSAGE.response,
              id: message.id,
              body: Date.now()
            }));
          }
        })();
      });
    });
  }

  addEndPoint(endPoint) {
    const typeDefs = endPoint.typeDefFileNames.map(x => _fs.default.readFileSync(x, 'utf-8')).join('\n');
    const config = {
      typeDefs,
      resolvers: endPoint.resolvers,
      subscriptions: {
        onConnect(connectionParams, _websocket, _context) {
          return {
            accessKey: connectionParams.accessKey || connectionParams.accesskey
          };
        }

      },
      context: ({
        req,
        connection
      }) => {
        return {// db: this.db,
          // tracer: this.tracer,
          // stats: this.stats,
          // auth: this.auth,
          // client: this.client,
          // config: this.config,
          // shared: this.shared,
          // remoteAddress: (req && req.socket && req.socket.remoteAddress) || '',
          // accessKey: Auth.extractAccessKey(req, connection),
          // parentSpan: QTracer.extractParentSpan(this.tracer, connection ? connection : req),
        };
      },
      plugins: [{
        requestDidStart(_requestContext) {
          return {
            willSendResponse(ctx) {
              const context = ctx.context;

              if (context.multipleAccessKeysDetected) {
                throw (0, _utils.createError)(400, 'Request must use the same access key for all queries and mutations');
              }
            }

          };
        }

      }]
    };
    const apollo = new _apolloServerExpress.ApolloServer(config);
    apollo.applyMiddleware({
      app: this.app,
      path: endPoint.path
    });

    if (endPoint.supportSubscriptions) {
      apollo.installSubscriptionHandlers(this.server);
    }

    this.endPoints.push(endPoint);
  }

}

exports.default = TONQServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9zZXJ2ZXIuanMiXSwibmFtZXMiOlsidjgiLCJyZXF1aXJlIiwiTWVtU3RhdHMiLCJjb25zdHJ1Y3RvciIsInN0YXRzIiwicmVwb3J0IiwiZ2V0SGVhcFNwYWNlU3RhdGlzdGljcyIsImZvckVhY2giLCJzcGFjZSIsInNwYWNlTmFtZSIsInNwYWNlX25hbWUiLCJyZXBsYWNlIiwiZ2F1Z2UiLCJtZXRyaWMiLCJ2YWx1ZSIsInBoeXNpY2FsX3NwYWNlX3NpemUiLCJzcGFjZV9hdmFpbGFibGVfc2l6ZSIsInNwYWNlX3NpemUiLCJzcGFjZV91c2VkX3NpemUiLCJzdGFydCIsInNldFRpbWVvdXQiLCJUT05RU2VydmVyIiwib3B0aW9ucyIsImNvbmZpZyIsImxvZ3MiLCJsb2ciLCJjcmVhdGUiLCJzaGFyZWQiLCJNYXAiLCJ0cmFjZXIiLCJRVHJhY2VyIiwiUVN0YXRzIiwic3RhdHNkIiwic2VydmVyIiwiYXV0aCIsIkF1dGgiLCJlbmRQb2ludHMiLCJhcHAiLCJodHRwIiwiY3JlYXRlU2VydmVyIiwiZGIiLCJBcmFuZ28iLCJtZW1TdGF0cyIsImFkZEVuZFBvaW50IiwicGF0aCIsInJlc29sdmVycyIsInJlc29sdmVyc01hbSIsInR5cGVEZWZGaWxlTmFtZXMiLCJzdXBwb3J0U3Vic2NyaXB0aW9ucyIsImNsaWVudCIsIlRPTkNsaWVudE5vZGVKcyIsInNlcnZlcnMiLCJob3N0IiwicG9ydCIsImxpc3RlbiIsImVuZFBvaW50IiwiZGVidWciLCJwb3N0IiwicmVxIiwicmVzIiwidHJhbnNhY3Rpb25zIiwic3RhdFF1ZXJ5IiwiaW5jcmVtZW50Iiwic3RhdFF1ZXJ5QWN0aXZlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJzZW5kIiwiZGVjcmVtZW50IiwiTUVTU0FHRSIsInJlcXVlc3QiLCJyZXNwb25zZSIsIndzcyIsIldlYlNvY2tldCIsIlNlcnZlciIsIm9uIiwid3MiLCJkYXRhIiwibWVzc2FnZSIsIkpTT04iLCJwYXJzZSIsInR5cGUiLCJzdHJpbmdpZnkiLCJpZCIsImJvZHkiLCJEYXRlIiwibm93IiwidHlwZURlZnMiLCJtYXAiLCJ4IiwiZnMiLCJyZWFkRmlsZVN5bmMiLCJqb2luIiwic3Vic2NyaXB0aW9ucyIsIm9uQ29ubmVjdCIsImNvbm5lY3Rpb25QYXJhbXMiLCJfd2Vic29ja2V0IiwiX2NvbnRleHQiLCJhY2Nlc3NLZXkiLCJhY2Nlc3NrZXkiLCJjb250ZXh0IiwiY29ubmVjdGlvbiIsInBsdWdpbnMiLCJyZXF1ZXN0RGlkU3RhcnQiLCJfcmVxdWVzdENvbnRleHQiLCJ3aWxsU2VuZFJlc3BvbnNlIiwiY3R4IiwibXVsdGlwbGVBY2Nlc3NLZXlzRGV0ZWN0ZWQiLCJhcG9sbG8iLCJBcG9sbG9TZXJ2ZXIiLCJhcHBseU1pZGRsZXdhcmUiLCJpbnN0YWxsU3Vic2NyaXB0aW9uSGFuZGxlcnMiLCJwdXNoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBaUJBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUVBOztBQUNBOztBQUdBOztBQUNBOztBQUNBOztBQUdBOztBQUdBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBeENBOzs7Ozs7Ozs7Ozs7Ozs7QUFzREEsTUFBTUEsRUFBRSxHQUFHQyxPQUFPLENBQUMsSUFBRCxDQUFsQjs7QUFFQSxNQUFNQyxRQUFOLENBQWU7QUFHWEMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQWdCO0FBQ3ZCLFNBQUtBLEtBQUwsR0FBYUEsS0FBYjtBQUNIOztBQUVEQyxFQUFBQSxNQUFNLEdBQUc7QUFDTEwsSUFBQUEsRUFBRSxDQUFDTSxzQkFBSCxHQUE0QkMsT0FBNUIsQ0FBcUNDLEtBQUQsSUFBVztBQUMzQyxZQUFNQyxTQUFTLEdBQUdELEtBQUssQ0FBQ0UsVUFBTixDQUNiQyxPQURhLENBQ0wsUUFESyxFQUNLLEVBREwsRUFFYkEsT0FGYSxDQUVMLFFBRkssRUFFSyxFQUZMLENBQWxCOztBQUdBLFlBQU1DLEtBQUssR0FBRyxDQUFDQyxNQUFELEVBQWlCQyxLQUFqQixLQUFtQztBQUM3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Q0g7O0FBQ0QsU0FBS0csU0FBTCxDQUFlMkUsSUFBZixDQUFvQnhELFFBQXBCO0FBQ0g7O0FBekoyQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAxOC0yMDIwIFRPTiBERVYgU09MVVRJT05TIExURC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgU09GVFdBUkUgRVZBTFVBVElPTiBMaWNlbnNlICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2VcbiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZVxuICogTGljZW5zZSBhdDpcbiAqXG4gKiBodHRwOi8vd3d3LnRvbi5kZXYvbGljZW5zZXNcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIFRPTiBERVYgc29mdHdhcmUgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuLy8gQGZsb3dcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnO1xuaW1wb3J0IFdlYlNvY2tldCBmcm9tICd3cyc7XG5cbmltcG9ydCB7QXBvbGxvU2VydmVyLCBBcG9sbG9TZXJ2ZXJFeHByZXNzQ29uZmlnfSBmcm9tICdhcG9sbG8tc2VydmVyLWV4cHJlc3MnO1xuaW1wb3J0IHtDb25uZWN0aW9uQ29udGV4dH0gZnJvbSAnc3Vic2NyaXB0aW9ucy10cmFuc3BvcnQtd3MnO1xuaW1wb3J0IHR5cGUge1RPTkNsaWVudH0gZnJvbSBcInRvbi1jbGllbnQtanMvdHlwZXNcIjtcbmltcG9ydCB7VE9OQ2xpZW50IGFzIFRPTkNsaWVudE5vZGVKc30gZnJvbSAndG9uLWNsaWVudC1ub2RlLWpzJztcbmltcG9ydCBBcmFuZ28gZnJvbSAnLi9hcmFuZ28nO1xuaW1wb3J0IHR5cGUge0dyYXBoUUxSZXF1ZXN0Q29udGV4dH0gZnJvbSBcIi4vYXJhbmdvLWNvbGxlY3Rpb25cIjtcblxuaW1wb3J0IHtjcmVhdGVSZXNvbHZlcnN9IGZyb20gJy4vcmVzb2x2ZXJzLWdlbmVyYXRlZCc7XG5pbXBvcnQge2F0dGFjaEN1c3RvbVJlc29sdmVyc30gZnJvbSBcIi4vcmVzb2x2ZXJzLWN1c3RvbVwiO1xuaW1wb3J0IHtyZXNvbHZlcnNNYW19IGZyb20gXCIuL3Jlc29sdmVycy1tYW1cIjtcblxuaW1wb3J0IHR5cGUge1FDb25maWd9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCBRTG9ncyBmcm9tICcuL2xvZ3MnO1xuaW1wb3J0IHR5cGUge1FMb2d9IGZyb20gJy4vbG9ncyc7XG5pbXBvcnQgdHlwZSB7SVN0YXRzfSBmcm9tICcuL3RyYWNlcic7XG5pbXBvcnQge1FTdGF0cywgUVRyYWNlciwgU3RhdHNHYXVnZX0gZnJvbSBcIi4vdHJhY2VyXCI7XG5pbXBvcnQge1RyYWNlcn0gZnJvbSBcIm9wZW50cmFjaW5nXCI7XG5pbXBvcnQge0F1dGh9IGZyb20gJy4vYXV0aCc7XG5pbXBvcnQge2NyZWF0ZUVycm9yfSBmcm9tIFwiLi91dGlsc1wiO1xuXG50eXBlIFFPcHRpb25zID0ge1xuICAgIGNvbmZpZzogUUNvbmZpZyxcbiAgICBsb2dzOiBRTG9ncyxcbn1cblxudHlwZSBFbmRQb2ludCA9IHtcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgcmVzb2x2ZXJzOiBhbnksXG4gICAgdHlwZURlZkZpbGVOYW1lczogc3RyaW5nW10sXG4gICAgc3VwcG9ydFN1YnNjcmlwdGlvbnM6IGJvb2xlYW4sXG59XG5cbmNvbnN0IHY4ID0gcmVxdWlyZSgndjgnKTtcblxuY2xhc3MgTWVtU3RhdHMge1xuICAgIHN0YXRzOiBJU3RhdHM7XG5cbiAgICBjb25zdHJ1Y3RvcihzdGF0czogSVN0YXRzKSB7XG4gICAgICAgIHRoaXMuc3RhdHMgPSBzdGF0cztcbiAgICB9XG5cbiAgICByZXBvcnQoKSB7XG4gICAgICAgIHY4LmdldEhlYXBTcGFjZVN0YXRpc3RpY3MoKS5mb3JFYWNoKChzcGFjZSkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc3BhY2VOYW1lID0gc3BhY2Uuc3BhY2VfbmFtZVxuICAgICAgICAgICAgICAgIC5yZXBsYWNlKCdzcGFjZV8nLCAnJylcbiAgICAgICAgICAgICAgICAucmVwbGFjZSgnX3NwYWNlJywgJycpO1xuICAgICAgICAgICAgY29uc3QgZ2F1Z2UgPSAobWV0cmljOiBzdHJpbmcsIHZhbHVlOiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRzLmdhdWdlKGBoZWFwLnNwYWNlLiR7c3BhY2VOYW1lfS4ke21ldHJpY31gLCB2YWx1ZSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgZ2F1Z2UoJ3BoeXNpY2FsX3NpemUnLCBzcGFjZS5waHlzaWNhbF9zcGFjZV9zaXplKTtcbiAgICAgICAgICAgIGdhdWdlKCdhdmFpbGFibGVfc2l6ZScsIHNwYWNlLnNwYWNlX2F2YWlsYWJsZV9zaXplKTtcbiAgICAgICAgICAgIGdhdWdlKCdzaXplJywgc3BhY2Uuc3BhY2Vfc2l6ZSk7XG4gICAgICAgICAgICBnYXVnZSgndXNlZF9zaXplJywgc3BhY2Uuc3BhY2VfdXNlZF9zaXplKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3RhcnQoKSB7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZXBvcnQoKTtcbiAgICAgICAgICAgIHRoaXMuc3RhcnQoKTtcbiAgICAgICAgfSwgNTAwMCk7XG4gICAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUT05RU2VydmVyIHtcbiAgICBjb25maWc6IFFDb25maWc7XG4gICAgbG9nczogUUxvZ3M7XG4gICAgbG9nOiBRTG9nO1xuICAgIGFwcDogZXhwcmVzcy5BcHBsaWNhdGlvbjtcbiAgICBzZXJ2ZXI6IGFueTtcbiAgICBlbmRQb2ludHM6IEVuZFBvaW50W107XG4gICAgZGI6IEFyYW5nbztcbiAgICB0cmFjZXI6IFRyYWNlcjtcbiAgICBzdGF0czogSVN0YXRzO1xuICAgIGNsaWVudDogVE9OQ2xpZW50O1xuICAgIGF1dGg6IEF1dGg7XG4gICAgbWVtU3RhdHM6IE1lbVN0YXRzO1xuICAgIHNoYXJlZDogTWFwPHN0cmluZywgYW55PjtcblxuXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczogUU9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5jb25maWcgPSBvcHRpb25zLmNvbmZpZztcbiAgICAgICAgdGhpcy5sb2dzID0gb3B0aW9ucy5sb2dzO1xuICAgICAgICB0aGlzLmxvZyA9IHRoaXMubG9ncy5jcmVhdGUoJ3NlcnZlcicpO1xuICAgICAgICB0aGlzLnNoYXJlZCA9IG5ldyBNYXAoKTtcbiAgICAgICAgdGhpcy50cmFjZXIgPSBRVHJhY2VyLmNyZWF0ZShvcHRpb25zLmNvbmZpZyk7XG4gICAgICAgIHRoaXMuc3RhdHMgPSBRU3RhdHMuY3JlYXRlKG9wdGlvbnMuY29uZmlnLnN0YXRzZC5zZXJ2ZXIpO1xuICAgICAgICB0aGlzLmF1dGggPSBuZXcgQXV0aChvcHRpb25zLmNvbmZpZyk7XG4gICAgICAgIHRoaXMuZW5kUG9pbnRzID0gW107XG4gICAgICAgIHRoaXMuYXBwID0gZXhwcmVzcygpO1xuICAgICAgICB0aGlzLnNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKHRoaXMuYXBwKTtcbiAgICAgICAgdGhpcy5kYiA9IG5ldyBBcmFuZ28odGhpcy5jb25maWcsIHRoaXMubG9ncywgdGhpcy5hdXRoLCB0aGlzLnRyYWNlciwgdGhpcy5zdGF0cyk7XG4gICAgICAgIHRoaXMubWVtU3RhdHMgPSBuZXcgTWVtU3RhdHModGhpcy5zdGF0cyk7XG4gICAgICAgIHRoaXMubWVtU3RhdHMuc3RhcnQoKTtcbiAgICAgICAgdGhpcy5hZGRFbmRQb2ludCh7XG4gICAgICAgICAgICBwYXRoOiAnL2dyYXBocWwvbWFtJyxcbiAgICAgICAgICAgIHJlc29sdmVyczogcmVzb2x2ZXJzTWFtLFxuICAgICAgICAgICAgdHlwZURlZkZpbGVOYW1lczogWyd0eXBlLWRlZnMtbWFtLmdyYXBocWwnXSxcbiAgICAgICAgICAgIHN1cHBvcnRTdWJzY3JpcHRpb25zOiBmYWxzZSxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuYWRkRW5kUG9pbnQoe1xuICAgICAgICAgICAgcGF0aDogJy9ncmFwaHFsJyxcbiAgICAgICAgICAgIHJlc29sdmVyczogYXR0YWNoQ3VzdG9tUmVzb2x2ZXJzKGNyZWF0ZVJlc29sdmVycyh0aGlzLmRiKSksXG4gICAgICAgICAgICB0eXBlRGVmRmlsZU5hbWVzOiBbJ3R5cGUtZGVmcy1nZW5lcmF0ZWQuZ3JhcGhxbCcsICd0eXBlLWRlZnMtY3VzdG9tLmdyYXBocWwnXSxcbiAgICAgICAgICAgIHN1cHBvcnRTdWJzY3JpcHRpb25zOiB0cnVlLFxuICAgICAgICB9KTtcbiAgICB9XG5cblxuICAgIGFzeW5jIHN0YXJ0KCkge1xuICAgICAgICB0aGlzLmNsaWVudCA9IGF3YWl0IFRPTkNsaWVudE5vZGVKcy5jcmVhdGUoe3NlcnZlcnM6IFsnJ119KTtcbiAgICAgICAgYXdhaXQgdGhpcy5kYi5zdGFydCgpO1xuICAgICAgICBjb25zdCB7aG9zdCwgcG9ydH0gPSB0aGlzLmNvbmZpZy5zZXJ2ZXI7XG4gICAgICAgIHRoaXMuc2VydmVyLmxpc3Rlbih7XG4gICAgICAgICAgICBob3N0LFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5lbmRQb2ludHMuZm9yRWFjaCgoZW5kUG9pbnQ6IEVuZFBvaW50KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2cuZGVidWcoJ0dSQVBIUUwnLCBgaHR0cDovLyR7aG9zdH06JHtwb3J0fSR7ZW5kUG9pbnQucGF0aH1gKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zZXJ2ZXIuc2V0VGltZW91dCgyMTQ3NDgzNjQ3KTtcblxuXG4gICAgICAgIHRoaXMuYXBwLnBvc3QoJy9hcGknLCAocmVxLCByZXMpID0+IHtcbiAgICAgICAgICAgIChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5kYi50cmFuc2FjdGlvbnMuc3RhdFF1ZXJ5LmluY3JlbWVudCgpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGIudHJhbnNhY3Rpb25zLnN0YXRRdWVyeUFjdGl2ZS5pbmNyZW1lbnQoKTtcbiAgICAgICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgNDAwMDApKTtcbiAgICAgICAgICAgICAgICByZXMuc2VuZCgne30nKTtcbiAgICAgICAgICAgICAgICB0aGlzLmRiLnRyYW5zYWN0aW9ucy5zdGF0UXVlcnlBY3RpdmUuZGVjcmVtZW50KCk7XG4gICAgICAgICAgICB9KSgpO1xuICAgICAgICB9KTtcblxuXG4gICAgICAgIGNvbnN0IE1FU1NBR0UgPSB7XG4gICAgICAgICAgICByZXF1ZXN0OiAxLFxuICAgICAgICAgICAgcmVzcG9uc2U6IDIsXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3Qgd3NzID0gbmV3IFdlYlNvY2tldC5TZXJ2ZXIoe3BvcnQ6IDgwODR9KTtcbiAgICAgICAgd3NzLm9uKCdjb25uZWN0aW9uJywgKHdzKSA9PiB7XG4gICAgICAgICAgICB3cy5vbignbWVzc2FnZScsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IEpTT04ucGFyc2UoZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLnR5cGUgPT09IE1FU1NBR0UucmVxdWVzdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kYi50cmFuc2FjdGlvbnMuc3RhdFF1ZXJ5LmluY3JlbWVudCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kYi50cmFuc2FjdGlvbnMuc3RhdFF1ZXJ5QWN0aXZlLmluY3JlbWVudCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDQwMDAwKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRiLnRyYW5zYWN0aW9ucy5zdGF0UXVlcnlBY3RpdmUuZGVjcmVtZW50KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB3cy5zZW5kKEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBNRVNTQUdFLnJlc3BvbnNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBtZXNzYWdlLmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvZHk6IERhdGUubm93KCksXG4gICAgICAgICAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgYWRkRW5kUG9pbnQoZW5kUG9pbnQ6IEVuZFBvaW50KSB7XG4gICAgICAgIGNvbnN0IHR5cGVEZWZzID0gZW5kUG9pbnQudHlwZURlZkZpbGVOYW1lc1xuICAgICAgICAgICAgLm1hcCh4ID0+IGZzLnJlYWRGaWxlU3luYyh4LCAndXRmLTgnKSlcbiAgICAgICAgICAgIC5qb2luKCdcXG4nKTtcbiAgICAgICAgY29uc3QgY29uZmlnOiBBcG9sbG9TZXJ2ZXJFeHByZXNzQ29uZmlnID0ge1xuICAgICAgICAgICAgdHlwZURlZnMsXG4gICAgICAgICAgICByZXNvbHZlcnM6IGVuZFBvaW50LnJlc29sdmVycyxcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbnM6IHtcbiAgICAgICAgICAgICAgICBvbkNvbm5lY3QoY29ubmVjdGlvblBhcmFtczogT2JqZWN0LCBfd2Vic29ja2V0OiBXZWJTb2NrZXQsIF9jb250ZXh0OiBDb25uZWN0aW9uQ29udGV4dCk6IGFueSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY2Nlc3NLZXk6IGNvbm5lY3Rpb25QYXJhbXMuYWNjZXNzS2V5IHx8IGNvbm5lY3Rpb25QYXJhbXMuYWNjZXNza2V5LFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjb250ZXh0OiAoe3JlcSwgY29ubmVjdGlvbn0pID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAvLyBkYjogdGhpcy5kYixcbiAgICAgICAgICAgICAgICAgICAgLy8gdHJhY2VyOiB0aGlzLnRyYWNlcixcbiAgICAgICAgICAgICAgICAgICAgLy8gc3RhdHM6IHRoaXMuc3RhdHMsXG4gICAgICAgICAgICAgICAgICAgIC8vIGF1dGg6IHRoaXMuYXV0aCxcbiAgICAgICAgICAgICAgICAgICAgLy8gY2xpZW50OiB0aGlzLmNsaWVudCxcbiAgICAgICAgICAgICAgICAgICAgLy8gY29uZmlnOiB0aGlzLmNvbmZpZyxcbiAgICAgICAgICAgICAgICAgICAgLy8gc2hhcmVkOiB0aGlzLnNoYXJlZCxcbiAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3RlQWRkcmVzczogKHJlcSAmJiByZXEuc29ja2V0ICYmIHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcykgfHwgJycsXG4gICAgICAgICAgICAgICAgICAgIC8vIGFjY2Vzc0tleTogQXV0aC5leHRyYWN0QWNjZXNzS2V5KHJlcSwgY29ubmVjdGlvbiksXG4gICAgICAgICAgICAgICAgICAgIC8vIHBhcmVudFNwYW46IFFUcmFjZXIuZXh0cmFjdFBhcmVudFNwYW4odGhpcy50cmFjZXIsIGNvbm5lY3Rpb24gPyBjb25uZWN0aW9uIDogcmVxKSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHBsdWdpbnM6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3REaWRTdGFydChfcmVxdWVzdENvbnRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lsbFNlbmRSZXNwb25zZShjdHgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0ID0gY3R4LmNvbnRleHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0Lm11bHRpcGxlQWNjZXNzS2V5c0RldGVjdGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBjcmVhdGVFcnJvcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0MDAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1JlcXVlc3QgbXVzdCB1c2UgdGhlIHNhbWUgYWNjZXNzIGtleSBmb3IgYWxsIHF1ZXJpZXMgYW5kIG11dGF0aW9ucycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgYXBvbGxvID0gbmV3IEFwb2xsb1NlcnZlcihjb25maWcpO1xuICAgICAgICBhcG9sbG8uYXBwbHlNaWRkbGV3YXJlKHtcbiAgICAgICAgICAgIGFwcDogdGhpcy5hcHAsXG4gICAgICAgICAgICBwYXRoOiBlbmRQb2ludC5wYXRoLFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGVuZFBvaW50LnN1cHBvcnRTdWJzY3JpcHRpb25zKSB7XG4gICAgICAgICAgICBhcG9sbG8uaW5zdGFsbFN1YnNjcmlwdGlvbkhhbmRsZXJzKHRoaXMuc2VydmVyKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmVuZFBvaW50cy5wdXNoKGVuZFBvaW50KTtcbiAgICB9XG5cblxufVxuXG4iXX0=