"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SubscriptionListener = exports.WaitForListener = exports.CollectionListener = void 0;

var _iterall = require("iterall");

var _dbTypes = require("./db-types");

var _utils = require("./utils");

class CollectionListener {
  constructor(collectionName, docType, listeners, accessRights, filter, selection, operationId) {
    this.collectionName = collectionName;
    this.docType = docType;
    this.listeners = listeners;
    this.authFilter = CollectionListener.getAuthFilter(collectionName, accessRights);
    this.filter = filter;
    this.selection = selection;
    this.id = listeners.add(this);
    this.startTime = Date.now();
    this.operationId = operationId;
  }

  static getAuthFilter(collectionName, accessRights) {
    if (accessRights.restrictToAccounts.length === 0) {
      return null;
    }

    const accounts = new Set(accessRights.restrictToAccounts);

    switch (collectionName) {
      case 'accounts':
        return doc => accounts.has(doc._key);

      case 'transactions':
        return doc => accounts.has(doc.account_addr);

      case 'messages':
        return doc => accounts.has(doc.src) || accounts.has(doc.dst);

      default:
        return _ => false;
    }
  }

  close() {
    const id = this.id;

    if (id !== null && id !== undefined) {
      this.id = null;
      this.listeners.remove(id);
    }
  }

  isFiltered(doc) {
    if (this.authFilter && !this.authFilter(doc)) {
      return false;
    }

    return this.docType.test(null, doc, this.filter);
  }

  onDocumentInsertOrUpdate(doc) {}

  getEventCount() {
    return 0;
  }

}

exports.CollectionListener = CollectionListener;

class WaitForListener extends CollectionListener {
  constructor(collectionName, docType, listeners, accessRights, filter, selection, operationId, onInsertOrUpdate) {
    super(collectionName, docType, listeners, accessRights, filter, selection, operationId);
    this.onInsertOrUpdate = onInsertOrUpdate;
  }

  onDocumentInsertOrUpdate(doc) {
    this.onInsertOrUpdate(doc);
  }

} //$FlowFixMe


exports.WaitForListener = WaitForListener;

class SubscriptionListener extends CollectionListener {
  constructor(collectionName, docType, listeners, accessRights, filter, selection) {
    super(collectionName, docType, listeners, accessRights, filter, selection, null);
    this.eventCount = 0;
    this.pullQueue = [];
    this.pushQueue = [];
    this.running = true;
  }

  onDocumentInsertOrUpdate(doc) {
    if (!this.isQueueOverflow()) {
      const reduced = (0, _dbTypes.selectFields)(doc, this.selection);
      this.pushValue({
        [this.collectionName]: reduced
      });
    }
  }

  isQueueOverflow() {
    return this.getQueueSize() >= 10;
  }

  getEventCount() {
    return this.eventCount;
  }

  getQueueSize() {
    return this.pushQueue.length + this.pullQueue.length;
  }

  pushValue(value) {
    this.eventCount += 1;

    if (this.pullQueue.length !== 0) {
      this.pullQueue.shift()(this.running ? {
        value,
        done: false
      } : {
        value: undefined,
        done: true
      });
    } else {
      this.pushQueue.push(value);
    }
  }

  async next() {
    return new Promise(resolve => {
      if (this.pushQueue.length !== 0) {
        resolve(this.running ? {
          value: this.pushQueue.shift(),
          done: false
        } : {
          value: undefined,
          done: true
        });
      } else {
        this.pullQueue.push(resolve);
      }
    });
  }

  async return() {
    this.close();
    await this.emptyQueue();
    return {
      value: undefined,
      done: true
    };
  }

  async throw(error) {
    this.close();
    await this.emptyQueue();
    return Promise.reject(error);
  } //$FlowFixMe


  [_iterall.$$asyncIterator]() {
    return this;
  }

  async emptyQueue() {
    if (this.running) {
      this.running = false;
      this.pullQueue.forEach(resolve => resolve({
        value: undefined,
        done: true
      }));
      this.pullQueue = [];
      this.pushQueue = [];
    }
  }

}

exports.SubscriptionListener = SubscriptionListener;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hcmFuZ28tbGlzdGVuZXJzLmpzIl0sIm5hbWVzIjpbIkNvbGxlY3Rpb25MaXN0ZW5lciIsImNvbnN0cnVjdG9yIiwiY29sbGVjdGlvbk5hbWUiLCJkb2NUeXBlIiwibGlzdGVuZXJzIiwiYWNjZXNzUmlnaHRzIiwiZmlsdGVyIiwic2VsZWN0aW9uIiwib3BlcmF0aW9uSWQiLCJhdXRoRmlsdGVyIiwiZ2V0QXV0aEZpbHRlciIsImlkIiwiYWRkIiwic3RhcnRUaW1lIiwiRGF0ZSIsIm5vdyIsInJlc3RyaWN0VG9BY2NvdW50cyIsImxlbmd0aCIsImFjY291bnRzIiwiU2V0IiwiZG9jIiwiaGFzIiwiX2tleSIsImFjY291bnRfYWRkciIsInNyYyIsImRzdCIsIl8iLCJjbG9zZSIsInVuZGVmaW5lZCIsInJlbW92ZSIsImlzRmlsdGVyZWQiLCJ0ZXN0Iiwib25Eb2N1bWVudEluc2VydE9yVXBkYXRlIiwiZ2V0RXZlbnRDb3VudCIsIldhaXRGb3JMaXN0ZW5lciIsIm9uSW5zZXJ0T3JVcGRhdGUiLCJTdWJzY3JpcHRpb25MaXN0ZW5lciIsImV2ZW50Q291bnQiLCJwdWxsUXVldWUiLCJwdXNoUXVldWUiLCJydW5uaW5nIiwiaXNRdWV1ZU92ZXJmbG93IiwicmVkdWNlZCIsInB1c2hWYWx1ZSIsImdldFF1ZXVlU2l6ZSIsInZhbHVlIiwic2hpZnQiLCJkb25lIiwicHVzaCIsIm5leHQiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJldHVybiIsImVtcHR5UXVldWUiLCJ0aHJvdyIsImVycm9yIiwicmVqZWN0IiwiJCRhc3luY0l0ZXJhdG9yIiwiZm9yRWFjaCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUVBOztBQUVBOztBQUVBOztBQUVPLE1BQU1BLGtCQUFOLENBQXlCO0FBVzVCQyxFQUFBQSxXQUFXLENBQ1BDLGNBRE8sRUFFUEMsT0FGTyxFQUdQQyxTQUhPLEVBSVBDLFlBSk8sRUFLUEMsTUFMTyxFQU1QQyxTQU5PLEVBT1BDLFdBUE8sRUFR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QUFDSDs7QUFFRCxRQUFNSixVQUFOLEdBQW1CO0FBQ2YsUUFBSSxLQUFLYixPQUFULEVBQWtCO0FBQ2QsV0FBS0EsT0FBTCxHQUFlLEtBQWY7QUFDQSxXQUFLRixTQUFMLENBQWVvQixPQUFmLENBQXVCUCxPQUFPLElBQUlBLE9BQU8sQ0FBQztBQUFFTixRQUFBQSxLQUFLLEVBQUVqQixTQUFUO0FBQW9CbUIsUUFBQUEsSUFBSSxFQUFFO0FBQTFCLE9BQUQsQ0FBekM7QUFDQSxXQUFLVCxTQUFMLEdBQWlCLEVBQWpCO0FBQ0EsV0FBS0MsU0FBTCxHQUFpQixFQUFqQjtBQUNIO0FBQ0o7O0FBMUZzRiIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB7ICQkYXN5bmNJdGVyYXRvciB9IGZyb20gXCJpdGVyYWxsXCI7XG5pbXBvcnQgdHlwZSB7IEFjY2Vzc1JpZ2h0cyB9IGZyb20gXCIuL2F1dGhcIjtcbmltcG9ydCB7IHNlbGVjdEZpZWxkcyB9IGZyb20gXCIuL2RiLXR5cGVzXCI7XG5pbXBvcnQgdHlwZSB7IEZpZWxkU2VsZWN0aW9uLCBRVHlwZSB9IGZyb20gXCIuL2RiLXR5cGVzXCI7XG5pbXBvcnQgeyBSZWdpc3RyeU1hcH0gZnJvbSBcIi4vdXRpbHNcIjtcblxuZXhwb3J0IGNsYXNzIENvbGxlY3Rpb25MaXN0ZW5lciB7XG4gICAgY29sbGVjdGlvbk5hbWU6IHN0cmluZztcbiAgICBkb2NUeXBlOiBRVHlwZTtcbiAgICBsaXN0ZW5lcnM6IFJlZ2lzdHJ5TWFwPENvbGxlY3Rpb25MaXN0ZW5lcj47XG4gICAgaWQ6ID9udW1iZXI7XG4gICAgZmlsdGVyOiBhbnk7XG4gICAgYXV0aEZpbHRlcjogPygoZG9jOiBhbnkpID0+IGJvb2xlYW4pO1xuICAgIHNlbGVjdGlvbjogRmllbGRTZWxlY3Rpb25bXTtcbiAgICBvcGVyYXRpb25JZDogP3N0cmluZztcbiAgICBzdGFydFRpbWU6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBjb2xsZWN0aW9uTmFtZTogc3RyaW5nLFxuICAgICAgICBkb2NUeXBlOiBRVHlwZSxcbiAgICAgICAgbGlzdGVuZXJzOiBSZWdpc3RyeU1hcDxDb2xsZWN0aW9uTGlzdGVuZXI+LFxuICAgICAgICBhY2Nlc3NSaWdodHM6IEFjY2Vzc1JpZ2h0cyxcbiAgICAgICAgZmlsdGVyOiBhbnksXG4gICAgICAgIHNlbGVjdGlvbjogRmllbGRTZWxlY3Rpb25bXSxcbiAgICAgICAgb3BlcmF0aW9uSWQ6ID9zdHJpbmcsXG4gICAgKSB7XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbk5hbWUgPSBjb2xsZWN0aW9uTmFtZTtcbiAgICAgICAgdGhpcy5kb2NUeXBlID0gZG9jVHlwZTtcbiAgICAgICAgdGhpcy5saXN0ZW5lcnMgPSBsaXN0ZW5lcnM7XG4gICAgICAgIHRoaXMuYXV0aEZpbHRlciA9IENvbGxlY3Rpb25MaXN0ZW5lci5nZXRBdXRoRmlsdGVyKGNvbGxlY3Rpb25OYW1lLCBhY2Nlc3NSaWdodHMpO1xuICAgICAgICB0aGlzLmZpbHRlciA9IGZpbHRlcjtcbiAgICAgICAgdGhpcy5zZWxlY3Rpb24gPSBzZWxlY3Rpb247XG4gICAgICAgIHRoaXMuaWQgPSBsaXN0ZW5lcnMuYWRkKHRoaXMpO1xuICAgICAgICB0aGlzLnN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgICAgIHRoaXMub3BlcmF0aW9uSWQgPSBvcGVyYXRpb25JZDtcbiAgICB9XG5cbiAgICBzdGF0aWMgZ2V0QXV0aEZpbHRlcihjb2xsZWN0aW9uTmFtZTogc3RyaW5nLCBhY2Nlc3NSaWdodHM6IEFjY2Vzc1JpZ2h0cyk6ID8oKGRvYzogYW55KSA9PiBib29sZWFuKSB7XG4gICAgICAgIGlmIChhY2Nlc3NSaWdodHMucmVzdHJpY3RUb0FjY291bnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYWNjb3VudHMgPSBuZXcgU2V0KGFjY2Vzc1JpZ2h0cy5yZXN0cmljdFRvQWNjb3VudHMpO1xuICAgICAgICBzd2l0Y2ggKGNvbGxlY3Rpb25OYW1lKSB7XG4gICAgICAgIGNhc2UgJ2FjY291bnRzJzpcbiAgICAgICAgICAgIHJldHVybiAoZG9jKSA9PiBhY2NvdW50cy5oYXMoZG9jLl9rZXkpO1xuICAgICAgICBjYXNlICd0cmFuc2FjdGlvbnMnOlxuICAgICAgICAgICAgcmV0dXJuIChkb2MpID0+IGFjY291bnRzLmhhcyhkb2MuYWNjb3VudF9hZGRyKTtcbiAgICAgICAgY2FzZSAnbWVzc2FnZXMnOlxuICAgICAgICAgICAgcmV0dXJuIChkb2MpID0+IGFjY291bnRzLmhhcyhkb2Muc3JjKSB8fCBhY2NvdW50cy5oYXMoZG9jLmRzdCk7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICByZXR1cm4gKF8pID0+IGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY2xvc2UoKSB7XG4gICAgICAgIGNvbnN0IGlkID0gdGhpcy5pZDtcbiAgICAgICAgaWYgKGlkICE9PSBudWxsICYmIGlkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuaWQgPSBudWxsO1xuICAgICAgICAgICAgdGhpcy5saXN0ZW5lcnMucmVtb3ZlKGlkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlzRmlsdGVyZWQoZG9jOiBhbnkpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHRoaXMuYXV0aEZpbHRlciAmJiAhdGhpcy5hdXRoRmlsdGVyKGRvYykpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5kb2NUeXBlLnRlc3QobnVsbCwgZG9jLCB0aGlzLmZpbHRlcik7XG4gICAgfVxuXG4gICAgb25Eb2N1bWVudEluc2VydE9yVXBkYXRlKGRvYzogYW55KSB7XG4gICAgfVxuXG4gICAgZ2V0RXZlbnRDb3VudCgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBXYWl0Rm9yTGlzdGVuZXIgZXh0ZW5kcyBDb2xsZWN0aW9uTGlzdGVuZXIge1xuICAgIG9uSW5zZXJ0T3JVcGRhdGU6IChkb2M6IGFueSkgPT4gdm9pZDtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBjb2xsZWN0aW9uTmFtZTogc3RyaW5nLFxuICAgICAgICBkb2NUeXBlOiBRVHlwZSxcbiAgICAgICAgbGlzdGVuZXJzOiBSZWdpc3RyeU1hcDxDb2xsZWN0aW9uTGlzdGVuZXI+LFxuICAgICAgICBhY2Nlc3NSaWdodHM6IEFjY2Vzc1JpZ2h0cyxcbiAgICAgICAgZmlsdGVyOiBhbnksXG4gICAgICAgIHNlbGVjdGlvbjogRmllbGRTZWxlY3Rpb25bXSxcbiAgICAgICAgb3BlcmF0aW9uSWQ6ID9zdHJpbmcsXG4gICAgICAgIG9uSW5zZXJ0T3JVcGRhdGU6IChkb2M6IGFueSkgPT4gdm9pZFxuICAgICkge1xuICAgICAgICBzdXBlcihjb2xsZWN0aW9uTmFtZSwgZG9jVHlwZSwgbGlzdGVuZXJzLCBhY2Nlc3NSaWdodHMsIGZpbHRlciwgc2VsZWN0aW9uLCBvcGVyYXRpb25JZCk7XG4gICAgICAgIHRoaXMub25JbnNlcnRPclVwZGF0ZSA9IG9uSW5zZXJ0T3JVcGRhdGU7XG4gICAgfVxuXG4gICAgb25Eb2N1bWVudEluc2VydE9yVXBkYXRlKGRvYzogYW55KSB7XG4gICAgICAgIHRoaXMub25JbnNlcnRPclVwZGF0ZShkb2MpO1xuICAgIH1cbn1cblxuLy8kRmxvd0ZpeE1lXG5leHBvcnQgY2xhc3MgU3Vic2NyaXB0aW9uTGlzdGVuZXIgZXh0ZW5kcyBDb2xsZWN0aW9uTGlzdGVuZXIgaW1wbGVtZW50cyBBc3luY0l0ZXJhdG9yPGFueT4ge1xuICAgIGV2ZW50Q291bnQ6IG51bWJlcjtcbiAgICBwdWxsUXVldWU6ICgodmFsdWU6IGFueSkgPT4gdm9pZClbXTtcbiAgICBwdXNoUXVldWU6IGFueVtdO1xuICAgIHJ1bm5pbmc6IGJvb2xlYW47XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgY29sbGVjdGlvbk5hbWU6IHN0cmluZyxcbiAgICAgICAgZG9jVHlwZTogUVR5cGUsXG4gICAgICAgIGxpc3RlbmVyczogUmVnaXN0cnlNYXA8Q29sbGVjdGlvbkxpc3RlbmVyPixcbiAgICAgICAgYWNjZXNzUmlnaHRzOiBBY2Nlc3NSaWdodHMsXG4gICAgICAgIGZpbHRlcjogYW55LFxuICAgICAgICBzZWxlY3Rpb246IEZpZWxkU2VsZWN0aW9uW11cbiAgICApIHtcbiAgICAgICAgc3VwZXIoY29sbGVjdGlvbk5hbWUsIGRvY1R5cGUsIGxpc3RlbmVycywgYWNjZXNzUmlnaHRzLCBmaWx0ZXIsIHNlbGVjdGlvbiwgbnVsbCk7XG5cbiAgICAgICAgdGhpcy5ldmVudENvdW50ID0gMDtcbiAgICAgICAgdGhpcy5wdWxsUXVldWUgPSBbXTtcbiAgICAgICAgdGhpcy5wdXNoUXVldWUgPSBbXTtcbiAgICAgICAgdGhpcy5ydW5uaW5nID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBvbkRvY3VtZW50SW5zZXJ0T3JVcGRhdGUoZG9jOiBhbnkpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzUXVldWVPdmVyZmxvdygpKSB7XG4gICAgICAgICAgICBjb25zdCByZWR1Y2VkID0gc2VsZWN0RmllbGRzKGRvYywgdGhpcy5zZWxlY3Rpb24pO1xuICAgICAgICAgICAgdGhpcy5wdXNoVmFsdWUoeyBbdGhpcy5jb2xsZWN0aW9uTmFtZV06IHJlZHVjZWQgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpc1F1ZXVlT3ZlcmZsb3coKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldFF1ZXVlU2l6ZSgpID49IDEwO1xuICAgIH1cblxuICAgIGdldEV2ZW50Q291bnQoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRDb3VudDtcbiAgICB9XG5cbiAgICBnZXRRdWV1ZVNpemUoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHVzaFF1ZXVlLmxlbmd0aCArIHRoaXMucHVsbFF1ZXVlLmxlbmd0aDtcbiAgICB9XG5cbiAgICBwdXNoVmFsdWUodmFsdWU6IGFueSkge1xuICAgICAgICB0aGlzLmV2ZW50Q291bnQgKz0gMTtcbiAgICAgICAgaWYgKHRoaXMucHVsbFF1ZXVlLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICAgICAgdGhpcy5wdWxsUXVldWUuc2hpZnQoKSh0aGlzLnJ1bm5pbmdcbiAgICAgICAgICAgICAgICA/IHsgdmFsdWUsIGRvbmU6IGZhbHNlIH1cbiAgICAgICAgICAgICAgICA6IHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucHVzaFF1ZXVlLnB1c2godmFsdWUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgbmV4dCgpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLnB1c2hRdWV1ZS5sZW5ndGggIT09IDApIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHRoaXMucnVubmluZ1xuICAgICAgICAgICAgICAgICAgICA/IHsgdmFsdWU6IHRoaXMucHVzaFF1ZXVlLnNoaWZ0KCksIGRvbmU6IGZhbHNlIH1cbiAgICAgICAgICAgICAgICAgICAgOiB7IHZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWUgfSxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnB1bGxRdWV1ZS5wdXNoKHJlc29sdmUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyByZXR1cm4oKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgdGhpcy5jbG9zZSgpO1xuICAgICAgICBhd2FpdCB0aGlzLmVtcHR5UXVldWUoKTtcbiAgICAgICAgcmV0dXJuIHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9O1xuICAgIH1cblxuICAgIGFzeW5jIHRocm93KGVycm9yPzogYW55KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgdGhpcy5jbG9zZSgpO1xuICAgICAgICBhd2FpdCB0aGlzLmVtcHR5UXVldWUoKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgICB9XG5cbiAgICAvLyRGbG93Rml4TWVcbiAgICBbJCRhc3luY0l0ZXJhdG9yXSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYXN5bmMgZW1wdHlRdWV1ZSgpIHtcbiAgICAgICAgaWYgKHRoaXMucnVubmluZykge1xuICAgICAgICAgICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLnB1bGxRdWV1ZS5mb3JFYWNoKHJlc29sdmUgPT4gcmVzb2x2ZSh7IHZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWUgfSkpO1xuICAgICAgICAgICAgdGhpcy5wdWxsUXVldWUgPSBbXTtcbiAgICAgICAgICAgIHRoaXMucHVzaFF1ZXVlID0gW107XG4gICAgICAgIH1cbiAgICB9XG5cbn1cbiJdfQ==