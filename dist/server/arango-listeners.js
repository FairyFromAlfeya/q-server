"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SubscriptionListener = exports.WaitForListener = exports.CollectionListener = void 0;

var _iterall = require("iterall");

var _dbTypes = require("./db-types");

var _utils = require("./utils");

class CollectionListener {
  constructor(collectionName, docType, listeners, accessRights, filter, selection, operationId) {
    this.collectionName = collectionName;
    this.docType = docType;
    this.listeners = listeners;
    this.authFilter = CollectionListener.getAuthFilter(collectionName, accessRights);
    this.filter = filter;
    this.selection = selection;
    this.id = listeners.add(this);
    this.startTime = Date.now();
    this.operationId = operationId;
  }

  static getAuthFilter(collectionName, accessRights) {
    if (accessRights.restrictToAccounts.length === 0) {
      return null;
    }

    const accounts = new Set(accessRights.restrictToAccounts);

    switch (collectionName) {
      case 'accounts':
        return doc => accounts.has(doc._key);

      case 'transactions':
        return doc => accounts.has(doc.account_addr);

      case 'messages':
        return doc => accounts.has(doc.src) || accounts.has(doc.dst);

      default:
        return _ => false;
    }
  }

  close() {
    const id = this.id;

    if (id !== null && id !== undefined) {
      this.id = null;
      this.listeners.remove(id);
    }
  }

  isFiltered(doc) {
    if (this.authFilter && !this.authFilter(doc)) {
      return false;
    }

    return this.docType.test(null, doc, this.filter);
  }

  onDocumentInsertOrUpdate(doc) {}

  getEventCount() {
    return 0;
  }

}

exports.CollectionListener = CollectionListener;

class WaitForListener extends CollectionListener {
  constructor(collectionName, docType, listeners, accessRights, filter, selection, operationId, onInsertOrUpdate) {
    super(collectionName, docType, listeners, accessRights, filter, selection, operationId);
    this.onInsertOrUpdate = onInsertOrUpdate;
  }

  onDocumentInsertOrUpdate(doc) {
    this.onInsertOrUpdate(doc);
  }

}

exports.WaitForListener = WaitForListener;

class SubscriptionListener extends CollectionListener {
  constructor(collectionName, docType, listeners, accessRights, filter, selection) {
    super(collectionName, docType, listeners, accessRights, filter, selection, null);
    this.eventCount = 0;
    this.pullQueue = [];
    this.pushQueue = [];
    this.running = true;
  }

  onDocumentInsertOrUpdate(doc) {
    if (!this.isQueueOverflow()) {
      const reduced = (0, _dbTypes.selectFields)(doc, this.selection);
      this.pushValue({
        [this.collectionName]: reduced
      });
    }
  }

  isQueueOverflow() {
    return this.getQueueSize() >= 10;
  }

  getEventCount() {
    return this.eventCount;
  }

  getQueueSize() {
    return this.pushQueue.length + this.pullQueue.length;
  }

  pushValue(value) {
    this.eventCount += 1;

    if (this.pullQueue.length !== 0) {
      this.pullQueue.shift()(this.running ? {
        value,
        done: false
      } : {
        value: undefined,
        done: true
      });
    } else {
      this.pushQueue.push(value);
    }
  }

  async next() {
    return new Promise(resolve => {
      if (this.pushQueue.length !== 0) {
        resolve(this.running ? {
          value: this.pushQueue.shift(),
          done: false
        } : {
          value: undefined,
          done: true
        });
      } else {
        this.pullQueue.push(resolve);
      }
    });
  }

  async return() {
    this.close();
    await this.emptyQueue();
    return {
      value: undefined,
      done: true
    };
  }

  async throw(error) {
    this.close();
    await this.emptyQueue();
    return Promise.reject(error);
  } //$FlowFixMe


  [_iterall.$$asyncIterator]() {
    return this;
  }

  async emptyQueue() {
    if (this.running) {
      this.running = false;
      this.pullQueue.forEach(resolve => resolve({
        value: undefined,
        done: true
      }));
      this.pullQueue = [];
      this.pushQueue = [];
    }
  }

}

exports.SubscriptionListener = SubscriptionListener;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hcmFuZ28tbGlzdGVuZXJzLmpzIl0sIm5hbWVzIjpbIkNvbGxlY3Rpb25MaXN0ZW5lciIsImNvbnN0cnVjdG9yIiwiY29sbGVjdGlvbk5hbWUiLCJkb2NUeXBlIiwibGlzdGVuZXJzIiwiYWNjZXNzUmlnaHRzIiwiZmlsdGVyIiwic2VsZWN0aW9uIiwib3BlcmF0aW9uSWQiLCJhdXRoRmlsdGVyIiwiZ2V0QXV0aEZpbHRlciIsImlkIiwiYWRkIiwic3RhcnRUaW1lIiwiRGF0ZSIsIm5vdyIsInJlc3RyaWN0VG9BY2NvdW50cyIsImxlbmd0aCIsImFjY291bnRzIiwiU2V0IiwiZG9jIiwiaGFzIiwiX2tleSIsImFjY291bnRfYWRkciIsInNyYyIsImRzdCIsIl8iLCJjbG9zZSIsInVuZGVmaW5lZCIsInJlbW92ZSIsImlzRmlsdGVyZWQiLCJ0ZXN0Iiwib25Eb2N1bWVudEluc2VydE9yVXBkYXRlIiwiZ2V0RXZlbnRDb3VudCIsIldhaXRGb3JMaXN0ZW5lciIsIm9uSW5zZXJ0T3JVcGRhdGUiLCJTdWJzY3JpcHRpb25MaXN0ZW5lciIsImV2ZW50Q291bnQiLCJwdWxsUXVldWUiLCJwdXNoUXVldWUiLCJydW5uaW5nIiwiaXNRdWV1ZU92ZXJmbG93IiwicmVkdWNlZCIsInB1c2hWYWx1ZSIsImdldFF1ZXVlU2l6ZSIsInZhbHVlIiwic2hpZnQiLCJkb25lIiwicHVzaCIsIm5leHQiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJldHVybiIsImVtcHR5UXVldWUiLCJ0aHJvdyIsImVycm9yIiwicmVqZWN0IiwiJCRhc3luY0l0ZXJhdG9yIiwiZm9yRWFjaCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUVBOztBQUVBOztBQUVPLE1BQU1BLGtCQUFOLENBQXlCO0FBVzVCQyxFQUFBQSxXQUFXLENBQ1BDLGNBRE8sRUFFUEMsT0FGTyxFQUdQQyxTQUhPLEVBSVBDLFlBSk8sRUFLUEMsTUFMTyxFQU1QQyxTQU5PLEVBT1BDLFdBUE8sRUFR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RUQsUUFBTUosVUFBTixHQUFtQjtBQUNmLFFBQUksS0FBS2IsT0FBVCxFQUFrQjtBQUNkLFdBQUtBLE9BQUwsR0FBZSxLQUFmO0FBQ0EsV0FBS0YsU0FBTCxDQUFlb0IsT0FBZixDQUF1QlAsT0FBTyxJQUFJQSxPQUFPLENBQUM7QUFBRU4sUUFBQUEsS0FBSyxFQUFFakIsU0FBVDtBQUFvQm1CLFFBQUFBLElBQUksRUFBRTtBQUExQixPQUFELENBQXpDO0FBQ0EsV0FBS1QsU0FBTCxHQUFpQixFQUFqQjtBQUNBLFdBQUtDLFNBQUwsR0FBaUIsRUFBakI7QUFDSDtBQUNKOztBQTFGc0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyAkJGFzeW5jSXRlcmF0b3IgfSBmcm9tIFwiaXRlcmFsbFwiO1xuaW1wb3J0IHR5cGUgeyBBY2Nlc3NSaWdodHMgfSBmcm9tIFwiLi9hdXRoXCI7XG5pbXBvcnQgeyBzZWxlY3RGaWVsZHMgfSBmcm9tIFwiLi9kYi10eXBlc1wiO1xuaW1wb3J0IHR5cGUgeyBGaWVsZFNlbGVjdGlvbiwgUVR5cGUgfSBmcm9tIFwiLi9kYi10eXBlc1wiO1xuaW1wb3J0IHsgUmVnaXN0cnlNYXB9IGZyb20gXCIuL3V0aWxzXCI7XG5cbmV4cG9ydCBjbGFzcyBDb2xsZWN0aW9uTGlzdGVuZXIge1xuICAgIGNvbGxlY3Rpb25OYW1lOiBzdHJpbmc7XG4gICAgZG9jVHlwZTogUVR5cGU7XG4gICAgbGlzdGVuZXJzOiBSZWdpc3RyeU1hcDxDb2xsZWN0aW9uTGlzdGVuZXI+O1xuICAgIGlkOiA/bnVtYmVyO1xuICAgIGZpbHRlcjogYW55O1xuICAgIGF1dGhGaWx0ZXI6ID8oKGRvYzogYW55KSA9PiBib29sZWFuKTtcbiAgICBzZWxlY3Rpb246IEZpZWxkU2VsZWN0aW9uW107XG4gICAgb3BlcmF0aW9uSWQ6ID9zdHJpbmc7XG4gICAgc3RhcnRUaW1lOiBudW1iZXI7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgY29sbGVjdGlvbk5hbWU6IHN0cmluZyxcbiAgICAgICAgZG9jVHlwZTogUVR5cGUsXG4gICAgICAgIGxpc3RlbmVyczogUmVnaXN0cnlNYXA8Q29sbGVjdGlvbkxpc3RlbmVyPixcbiAgICAgICAgYWNjZXNzUmlnaHRzOiBBY2Nlc3NSaWdodHMsXG4gICAgICAgIGZpbHRlcjogYW55LFxuICAgICAgICBzZWxlY3Rpb246IEZpZWxkU2VsZWN0aW9uW10sXG4gICAgICAgIG9wZXJhdGlvbklkOiA/c3RyaW5nLFxuICAgICkge1xuICAgICAgICB0aGlzLmNvbGxlY3Rpb25OYW1lID0gY29sbGVjdGlvbk5hbWU7XG4gICAgICAgIHRoaXMuZG9jVHlwZSA9IGRvY1R5cGU7XG4gICAgICAgIHRoaXMubGlzdGVuZXJzID0gbGlzdGVuZXJzO1xuICAgICAgICB0aGlzLmF1dGhGaWx0ZXIgPSBDb2xsZWN0aW9uTGlzdGVuZXIuZ2V0QXV0aEZpbHRlcihjb2xsZWN0aW9uTmFtZSwgYWNjZXNzUmlnaHRzKTtcbiAgICAgICAgdGhpcy5maWx0ZXIgPSBmaWx0ZXI7XG4gICAgICAgIHRoaXMuc2VsZWN0aW9uID0gc2VsZWN0aW9uO1xuICAgICAgICB0aGlzLmlkID0gbGlzdGVuZXJzLmFkZCh0aGlzKTtcbiAgICAgICAgdGhpcy5zdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgICB0aGlzLm9wZXJhdGlvbklkID0gb3BlcmF0aW9uSWQ7XG4gICAgfVxuXG4gICAgc3RhdGljIGdldEF1dGhGaWx0ZXIoY29sbGVjdGlvbk5hbWU6IHN0cmluZywgYWNjZXNzUmlnaHRzOiBBY2Nlc3NSaWdodHMpOiA/KChkb2M6IGFueSkgPT4gYm9vbGVhbikge1xuICAgICAgICBpZiAoYWNjZXNzUmlnaHRzLnJlc3RyaWN0VG9BY2NvdW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGFjY291bnRzID0gbmV3IFNldChhY2Nlc3NSaWdodHMucmVzdHJpY3RUb0FjY291bnRzKTtcbiAgICAgICAgc3dpdGNoIChjb2xsZWN0aW9uTmFtZSkge1xuICAgICAgICBjYXNlICdhY2NvdW50cyc6XG4gICAgICAgICAgICByZXR1cm4gKGRvYykgPT4gYWNjb3VudHMuaGFzKGRvYy5fa2V5KTtcbiAgICAgICAgY2FzZSAndHJhbnNhY3Rpb25zJzpcbiAgICAgICAgICAgIHJldHVybiAoZG9jKSA9PiBhY2NvdW50cy5oYXMoZG9jLmFjY291bnRfYWRkcik7XG4gICAgICAgIGNhc2UgJ21lc3NhZ2VzJzpcbiAgICAgICAgICAgIHJldHVybiAoZG9jKSA9PiBhY2NvdW50cy5oYXMoZG9jLnNyYykgfHwgYWNjb3VudHMuaGFzKGRvYy5kc3QpO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgcmV0dXJuIChfKSA9PiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNsb3NlKCkge1xuICAgICAgICBjb25zdCBpZCA9IHRoaXMuaWQ7XG4gICAgICAgIGlmIChpZCAhPT0gbnVsbCAmJiBpZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLmlkID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMubGlzdGVuZXJzLnJlbW92ZShpZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpc0ZpbHRlcmVkKGRvYzogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIGlmICh0aGlzLmF1dGhGaWx0ZXIgJiYgIXRoaXMuYXV0aEZpbHRlcihkb2MpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuZG9jVHlwZS50ZXN0KG51bGwsIGRvYywgdGhpcy5maWx0ZXIpO1xuICAgIH1cblxuICAgIG9uRG9jdW1lbnRJbnNlcnRPclVwZGF0ZShkb2M6IGFueSkge1xuICAgIH1cblxuICAgIGdldEV2ZW50Q291bnQoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIDA7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgV2FpdEZvckxpc3RlbmVyIGV4dGVuZHMgQ29sbGVjdGlvbkxpc3RlbmVyIHtcbiAgICBvbkluc2VydE9yVXBkYXRlOiAoZG9jOiBhbnkpID0+IHZvaWQ7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgY29sbGVjdGlvbk5hbWU6IHN0cmluZyxcbiAgICAgICAgZG9jVHlwZTogUVR5cGUsXG4gICAgICAgIGxpc3RlbmVyczogUmVnaXN0cnlNYXA8Q29sbGVjdGlvbkxpc3RlbmVyPixcbiAgICAgICAgYWNjZXNzUmlnaHRzOiBBY2Nlc3NSaWdodHMsXG4gICAgICAgIGZpbHRlcjogYW55LFxuICAgICAgICBzZWxlY3Rpb246IEZpZWxkU2VsZWN0aW9uW10sXG4gICAgICAgIG9wZXJhdGlvbklkOiA/c3RyaW5nLFxuICAgICAgICBvbkluc2VydE9yVXBkYXRlOiAoZG9jOiBhbnkpID0+IHZvaWRcbiAgICApIHtcbiAgICAgICAgc3VwZXIoY29sbGVjdGlvbk5hbWUsIGRvY1R5cGUsIGxpc3RlbmVycywgYWNjZXNzUmlnaHRzLCBmaWx0ZXIsIHNlbGVjdGlvbiwgb3BlcmF0aW9uSWQpO1xuICAgICAgICB0aGlzLm9uSW5zZXJ0T3JVcGRhdGUgPSBvbkluc2VydE9yVXBkYXRlO1xuICAgIH1cblxuICAgIG9uRG9jdW1lbnRJbnNlcnRPclVwZGF0ZShkb2M6IGFueSkge1xuICAgICAgICB0aGlzLm9uSW5zZXJ0T3JVcGRhdGUoZG9jKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBTdWJzY3JpcHRpb25MaXN0ZW5lciBleHRlbmRzIENvbGxlY3Rpb25MaXN0ZW5lciBpbXBsZW1lbnRzIEFzeW5jSXRlcmF0b3I8YW55PiB7XG4gICAgZXZlbnRDb3VudDogbnVtYmVyO1xuICAgIHB1bGxRdWV1ZTogKCh2YWx1ZTogYW55KSA9PiB2b2lkKVtdO1xuICAgIHB1c2hRdWV1ZTogYW55W107XG4gICAgcnVubmluZzogYm9vbGVhbjtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBjb2xsZWN0aW9uTmFtZTogc3RyaW5nLFxuICAgICAgICBkb2NUeXBlOiBRVHlwZSxcbiAgICAgICAgbGlzdGVuZXJzOiBSZWdpc3RyeU1hcDxDb2xsZWN0aW9uTGlzdGVuZXI+LFxuICAgICAgICBhY2Nlc3NSaWdodHM6IEFjY2Vzc1JpZ2h0cyxcbiAgICAgICAgZmlsdGVyOiBhbnksXG4gICAgICAgIHNlbGVjdGlvbjogRmllbGRTZWxlY3Rpb25bXVxuICAgICkge1xuICAgICAgICBzdXBlcihjb2xsZWN0aW9uTmFtZSwgZG9jVHlwZSwgbGlzdGVuZXJzLCBhY2Nlc3NSaWdodHMsIGZpbHRlciwgc2VsZWN0aW9uLCBudWxsKTtcblxuICAgICAgICB0aGlzLmV2ZW50Q291bnQgPSAwO1xuICAgICAgICB0aGlzLnB1bGxRdWV1ZSA9IFtdO1xuICAgICAgICB0aGlzLnB1c2hRdWV1ZSA9IFtdO1xuICAgICAgICB0aGlzLnJ1bm5pbmcgPSB0cnVlO1xuICAgIH1cblxuICAgIG9uRG9jdW1lbnRJbnNlcnRPclVwZGF0ZShkb2M6IGFueSkge1xuICAgICAgICBpZiAoIXRoaXMuaXNRdWV1ZU92ZXJmbG93KCkpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlZHVjZWQgPSBzZWxlY3RGaWVsZHMoZG9jLCB0aGlzLnNlbGVjdGlvbik7XG4gICAgICAgICAgICB0aGlzLnB1c2hWYWx1ZSh7IFt0aGlzLmNvbGxlY3Rpb25OYW1lXTogcmVkdWNlZCB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlzUXVldWVPdmVyZmxvdygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UXVldWVTaXplKCkgPj0gMTA7XG4gICAgfVxuXG4gICAgZ2V0RXZlbnRDb3VudCgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5ldmVudENvdW50O1xuICAgIH1cblxuICAgIGdldFF1ZXVlU2l6ZSgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5wdXNoUXVldWUubGVuZ3RoICsgdGhpcy5wdWxsUXVldWUubGVuZ3RoO1xuICAgIH1cblxuICAgIHB1c2hWYWx1ZSh2YWx1ZTogYW55KSB7XG4gICAgICAgIHRoaXMuZXZlbnRDb3VudCArPSAxO1xuICAgICAgICBpZiAodGhpcy5wdWxsUXVldWUubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgICAgICB0aGlzLnB1bGxRdWV1ZS5zaGlmdCgpKHRoaXMucnVubmluZ1xuICAgICAgICAgICAgICAgID8geyB2YWx1ZSwgZG9uZTogZmFsc2UgfVxuICAgICAgICAgICAgICAgIDogeyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH0sXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wdXNoUXVldWUucHVzaCh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBuZXh0KCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMucHVzaFF1ZXVlLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICAgICAgICAgIHJlc29sdmUodGhpcy5ydW5uaW5nXG4gICAgICAgICAgICAgICAgICAgID8geyB2YWx1ZTogdGhpcy5wdXNoUXVldWUuc2hpZnQoKSwgZG9uZTogZmFsc2UgfVxuICAgICAgICAgICAgICAgICAgICA6IHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9LFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMucHVsbFF1ZXVlLnB1c2gocmVzb2x2ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIHJldHVybigpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICB0aGlzLmNsb3NlKCk7XG4gICAgICAgIGF3YWl0IHRoaXMuZW1wdHlRdWV1ZSgpO1xuICAgICAgICByZXR1cm4geyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH07XG4gICAgfVxuXG4gICAgYXN5bmMgdGhyb3coZXJyb3I/OiBhbnkpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICB0aGlzLmNsb3NlKCk7XG4gICAgICAgIGF3YWl0IHRoaXMuZW1wdHlRdWV1ZSgpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpO1xuICAgIH1cblxuICAgIC8vJEZsb3dGaXhNZVxuICAgIFskJGFzeW5jSXRlcmF0b3JdKCkge1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBhc3luYyBlbXB0eVF1ZXVlKCkge1xuICAgICAgICBpZiAodGhpcy5ydW5uaW5nKSB7XG4gICAgICAgICAgICB0aGlzLnJ1bm5pbmcgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMucHVsbFF1ZXVlLmZvckVhY2gocmVzb2x2ZSA9PiByZXNvbHZlKHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9KSk7XG4gICAgICAgICAgICB0aGlzLnB1bGxRdWV1ZSA9IFtdO1xuICAgICAgICAgICAgdGhpcy5wdXNoUXVldWUgPSBbXTtcbiAgICAgICAgfVxuICAgIH1cblxufVxuIl19