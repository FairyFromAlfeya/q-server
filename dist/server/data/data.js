"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _collection = require("./collection");

var _auth = require("../auth");

var _config = require("../config");

var _logs = _interopRequireDefault(require("../logs"));

var _opentracing = require("opentracing");

var _tracer = require("../tracer");

var _utils = require("../utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
class QData {
  // Dependencies
  // Own
  constructor(options) {
    this.providers = options.providers;
    this.slowQueriesProviders = options.slowQueriesProviders || options.providers;
    this.logs = options.logs;
    this.stats = options.stats;
    this.auth = options.auth;
    this.tracer = options.tracer;
    this.isTests = options.isTests;
    this.log = this.logs.create('data');
    this.statPostCount = new _tracer.StatsCounter(this.stats, _config.STATS.post.count, []);
    this.statPostFailed = new _tracer.StatsCounter(this.stats, _config.STATS.post.failed, []);
    this.collections = [];
    this.collectionsByName = new Map();
  }

  addCollection(name, docType, mutable, indexes) {
    const collection = new _collection.QDataCollection({
      name,
      docType,
      mutable,
      indexes,
      provider: mutable ? this.providers.mutable : this.providers.immutable,
      slowQueriesProvider: mutable ? this.providers.mutable : this.slowQueriesProviders.immutable,
      logs: this.logs,
      auth: this.auth,
      tracer: this.tracer,
      stats: this.stats,
      isTests: this.isTests
    });
    this.collections.push(collection);
    this.collectionsByName.set(name, collection);
    return collection;
  }

  async start() {
    const mutable = [];
    const immutable = [];
    this.collections.forEach(x => (x.mutable ? mutable : immutable).push(x.name));
    await this.providers.mutable.start(mutable);
    await this.providers.immutable.start(immutable);
    await this.slowQueriesProviders.mutable.start([]);
    await this.slowQueriesProviders.immutable.start([]);
    await this.providers.immutable.hotUpdate();
  }

  async dropCachedDbInfo() {
    this.collections.forEach(x => x.dropCachedDbInfo());
    await this.providers.immutable.hotUpdate();
  }

  async query(provider, text, vars, orderBy) {
    return (0, _utils.wrap)(this.log, 'QUERY', {
      text,
      vars
    }, async () => {
      return provider.query(text, vars, orderBy);
    });
  }

  async finishOperations(operationIds) {
    let count = 0;
    this.collections.forEach(x => count += x.finishOperations(operationIds));
    return count;
  }

}

exports.default = QData;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9kYXRhLmpzIl0sIm5hbWVzIjpbIlFEYXRhIiwiY29uc3RydWN0b3IiLCJvcHRpb25zIiwicHJvdmlkZXJzIiwic2xvd1F1ZXJpZXNQcm92aWRlcnMiLCJsb2dzIiwic3RhdHMiLCJhdXRoIiwidHJhY2VyIiwiaXNUZXN0cyIsImxvZyIsImNyZWF0ZSIsInN0YXRQb3N0Q291bnQiLCJTdGF0c0NvdW50ZXIiLCJTVEFUUyIsInBvc3QiLCJjb3VudCIsInN0YXRQb3N0RmFpbGVkIiwiZmFpbGVkIiwiY29sbGVjdGlvbnMiLCJjb2xsZWN0aW9uc0J5TmFtZSIsIk1hcCIsImFkZENvbGxlY3Rpb24iLCJuYW1lIiwiZG9jVHlwZSIsIm11dGFibGUiLCJpbmRleGVzIiwiY29sbGVjdGlvbiIsIlFEYXRhQ29sbGVjdGlvbiIsInByb3ZpZGVyIiwiaW1tdXRhYmxlIiwic2xvd1F1ZXJpZXNQcm92aWRlciIsInB1c2giLCJzZXQiLCJzdGFydCIsImZvckVhY2giLCJ4IiwiaG90VXBkYXRlIiwiZHJvcENhY2hlZERiSW5mbyIsInF1ZXJ5IiwidGV4dCIsInZhcnMiLCJvcmRlckJ5IiwiZmluaXNoT3BlcmF0aW9ucyIsIm9wZXJhdGlvbklkcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQWtCQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUFFQTs7OztBQTNCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFnQ2UsTUFBTUEsS0FBTixDQUFZO0FBQ3ZCO0FBU0E7QUFRQUMsRUFBQUEsV0FBVyxDQUFDQyxPQUFELEVBQXdCO0FBQy9CLFNBQUtDLFNBQUwsR0FBaUJELE9BQU8sQ0FBQ0MsU0FBekI7QUFDQSxTQUFLQyxvQkFBTCxHQUE0QkYsT0FBTyxDQUFDRSxvQkFBUixJQUFnQ0YsT0FBTyxDQUFDQyxTQUFwRTtBQUNBLFNBQUtFLElB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QSxDQUFDLENBQUNFLGdCQUFGLEVBQWpEO0FBQ0EsVUFBTSxLQUFLbkMsU0FBTCxDQUFlMkIsU0FBZixDQUF5Qk8sU0FBekIsRUFBTjtBQUNIOztBQUVELFFBQU1FLEtBQU4sQ0FBWVYsUUFBWixFQUFxQ1csSUFBckMsRUFBbURDLElBQW5ELEVBQTRFQyxPQUE1RSxFQUFnRztBQUM1RixXQUFPLGlCQUFLLEtBQUtoQyxHQUFWLEVBQWUsT0FBZixFQUF3QjtBQUFFOEIsTUFBQUEsSUFBRjtBQUFRQyxNQUFBQTtBQUFSLEtBQXhCLEVBQXdDLFlBQVk7QUFDdkQsYUFBT1osUUFBUSxDQUFDVSxLQUFULENBQWVDLElBQWYsRUFBcUJDLElBQXJCLEVBQTJCQyxPQUEzQixDQUFQO0FBQ0gsS0FGTSxDQUFQO0FBR0g7O0FBRUQsUUFBTUMsZ0JBQU4sQ0FBdUJDLFlBQXZCLEVBQW1FO0FBQy9ELFFBQUk1QixLQUFLLEdBQUcsQ0FBWjtBQUNBLFNBQUtHLFdBQUwsQ0FBaUJnQixPQUFqQixDQUF5QkMsQ0FBQyxJQUFLcEIsS0FBSyxJQUFJb0IsQ0FBQyxDQUFDTyxnQkFBRixDQUFtQkMsWUFBbkIsQ0FBeEM7QUFDQSxXQUFPNUIsS0FBUDtBQUNIOztBQWpGc0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTgtMjAyMCBUT04gREVWIFNPTFVUSU9OUyBMVEQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIFNPRlRXQVJFIEVWQUxVQVRJT04gTGljZW5zZSAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlXG4gKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGVcbiAqIExpY2Vuc2UgYXQ6XG4gKlxuICogaHR0cDovL3d3dy50b24uZGV2L2xpY2Vuc2VzXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBUT04gREVWIHNvZnR3YXJlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbi8vIEBmbG93XG5cbmltcG9ydCB7IFFEYXRhQ29sbGVjdGlvbiB9IGZyb20gJy4vY29sbGVjdGlvbic7XG5pbXBvcnQgeyBBdXRoIH0gZnJvbSAnLi4vYXV0aCc7XG5pbXBvcnQgeyBTVEFUUyB9IGZyb20gJy4uL2NvbmZpZyc7XG5pbXBvcnQgdHlwZSB7IFFMb2cgfSBmcm9tICcuLi9sb2dzJztcbmltcG9ydCBRTG9ncyBmcm9tICcuLi9sb2dzJ1xuaW1wb3J0IHR5cGUgeyBPcmRlckJ5LCBRVHlwZSB9IGZyb20gJy4uL2ZpbHRlci9maWx0ZXJzJztcbmltcG9ydCB7IFRyYWNlciB9IGZyb20gJ29wZW50cmFjaW5nJztcbmltcG9ydCB7IFN0YXRzQ291bnRlciB9IGZyb20gJy4uL3RyYWNlcic7XG5pbXBvcnQgdHlwZSB7IElTdGF0cyB9IGZyb20gJy4uL3RyYWNlcic7XG5pbXBvcnQgeyB3cmFwIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHR5cGUgeyBRRGF0YVByb3ZpZGVyLCBRSW5kZXhJbmZvIH0gZnJvbSAnLi9kYXRhLXByb3ZpZGVyJztcblxuZXhwb3J0IHR5cGUgUURhdGFQcm92aWRlcnMgPSB7XG4gICAgbXV0YWJsZTogUURhdGFQcm92aWRlcixcbiAgICBpbW11dGFibGU6IFFEYXRhUHJvdmlkZXIsXG59XG5cbmV4cG9ydCB0eXBlIFFEYXRhT3B0aW9ucyA9IHtcbiAgICBwcm92aWRlcnM6IFFEYXRhUHJvdmlkZXJzLFxuICAgIHNsb3dRdWVyaWVzUHJvdmlkZXJzPzogUURhdGFQcm92aWRlcnMsXG5cbiAgICBsb2dzOiBRTG9ncyxcbiAgICBhdXRoOiBBdXRoLFxuICAgIHRyYWNlcjogVHJhY2VyLFxuICAgIHN0YXRzOiBJU3RhdHMsXG4gICAgaXNUZXN0czogYm9vbGVhbixcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUURhdGEge1xuICAgIC8vIERlcGVuZGVuY2llc1xuICAgIHByb3ZpZGVyczogUURhdGFQcm92aWRlcnM7XG4gICAgc2xvd1F1ZXJpZXNQcm92aWRlcnM6IFFEYXRhUHJvdmlkZXJzO1xuICAgIGxvZ3M6IFFMb2dzO1xuICAgIHN0YXRzOiBJU3RhdHM7XG4gICAgYXV0aDogQXV0aDtcbiAgICB0cmFjZXI6IFRyYWNlcjtcbiAgICBpc1Rlc3RzOiBib29sZWFuO1xuXG4gICAgLy8gT3duXG4gICAgbG9nOiBRTG9nO1xuICAgIHN0YXRQb3N0Q291bnQ6IFN0YXRzQ291bnRlcjtcbiAgICBzdGF0UG9zdEZhaWxlZDogU3RhdHNDb3VudGVyO1xuXG4gICAgY29sbGVjdGlvbnM6IFFEYXRhQ29sbGVjdGlvbltdO1xuICAgIGNvbGxlY3Rpb25zQnlOYW1lOiBNYXA8c3RyaW5nLCBRRGF0YUNvbGxlY3Rpb24+O1xuXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczogUURhdGFPcHRpb25zKSB7XG4gICAgICAgIHRoaXMucHJvdmlkZXJzID0gb3B0aW9ucy5wcm92aWRlcnM7XG4gICAgICAgIHRoaXMuc2xvd1F1ZXJpZXNQcm92aWRlcnMgPSBvcHRpb25zLnNsb3dRdWVyaWVzUHJvdmlkZXJzIHx8IG9wdGlvbnMucHJvdmlkZXJzO1xuICAgICAgICB0aGlzLmxvZ3MgPSBvcHRpb25zLmxvZ3M7XG4gICAgICAgIHRoaXMuc3RhdHMgPSBvcHRpb25zLnN0YXRzO1xuICAgICAgICB0aGlzLmF1dGggPSBvcHRpb25zLmF1dGg7XG4gICAgICAgIHRoaXMudHJhY2VyID0gb3B0aW9ucy50cmFjZXI7XG4gICAgICAgIHRoaXMuaXNUZXN0cyA9IG9wdGlvbnMuaXNUZXN0cztcblxuICAgICAgICB0aGlzLmxvZyA9IHRoaXMubG9ncy5jcmVhdGUoJ2RhdGEnKTtcblxuICAgICAgICB0aGlzLnN0YXRQb3N0Q291bnQgPSBuZXcgU3RhdHNDb3VudGVyKHRoaXMuc3RhdHMsIFNUQVRTLnBvc3QuY291bnQsIFtdKTtcbiAgICAgICAgdGhpcy5zdGF0UG9zdEZhaWxlZCA9IG5ldyBTdGF0c0NvdW50ZXIodGhpcy5zdGF0cywgU1RBVFMucG9zdC5mYWlsZWQsIFtdKTtcblxuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zID0gW107XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnNCeU5hbWUgPSBuZXcgTWFwKCk7XG4gICAgfVxuXG4gICAgYWRkQ29sbGVjdGlvbihuYW1lOiBzdHJpbmcsIGRvY1R5cGU6IFFUeXBlLCBtdXRhYmxlOiBib29sZWFuLCBpbmRleGVzOiBRSW5kZXhJbmZvW10pIHtcbiAgICAgICAgY29uc3QgY29sbGVjdGlvbiA9IG5ldyBRRGF0YUNvbGxlY3Rpb24oe1xuICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgIGRvY1R5cGUsXG4gICAgICAgICAgICBtdXRhYmxlLFxuICAgICAgICAgICAgaW5kZXhlcyxcbiAgICAgICAgICAgIHByb3ZpZGVyOiBtdXRhYmxlID8gdGhpcy5wcm92aWRlcnMubXV0YWJsZSA6IHRoaXMucHJvdmlkZXJzLmltbXV0YWJsZSxcbiAgICAgICAgICAgIHNsb3dRdWVyaWVzUHJvdmlkZXI6IG11dGFibGUgPyB0aGlzLnByb3ZpZGVycy5tdXRhYmxlIDogdGhpcy5zbG93UXVlcmllc1Byb3ZpZGVycy5pbW11dGFibGUsXG4gICAgICAgICAgICBsb2dzOiB0aGlzLmxvZ3MsXG4gICAgICAgICAgICBhdXRoOiB0aGlzLmF1dGgsXG4gICAgICAgICAgICB0cmFjZXI6IHRoaXMudHJhY2VyLFxuICAgICAgICAgICAgc3RhdHM6IHRoaXMuc3RhdHMsXG4gICAgICAgICAgICBpc1Rlc3RzOiB0aGlzLmlzVGVzdHMsXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zLnB1c2goY29sbGVjdGlvbik7XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnNCeU5hbWUuc2V0KG5hbWUsIGNvbGxlY3Rpb24pO1xuICAgICAgICByZXR1cm4gY29sbGVjdGlvbjtcbiAgICB9XG5cbiAgICBhc3luYyBzdGFydCgpIHtcbiAgICAgICAgY29uc3QgbXV0YWJsZSA9IFtdO1xuICAgICAgICBjb25zdCBpbW11dGFibGUgPSBbXTtcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9ucy5mb3JFYWNoKHggPT4gKHgubXV0YWJsZSA/IG11dGFibGUgOiBpbW11dGFibGUpLnB1c2goeC5uYW1lKSk7XG4gICAgICAgIGF3YWl0IHRoaXMucHJvdmlkZXJzLm11dGFibGUuc3RhcnQobXV0YWJsZSk7XG4gICAgICAgIGF3YWl0IHRoaXMucHJvdmlkZXJzLmltbXV0YWJsZS5zdGFydChpbW11dGFibGUpO1xuICAgICAgICBhd2FpdCB0aGlzLnNsb3dRdWVyaWVzUHJvdmlkZXJzLm11dGFibGUuc3RhcnQoW10pO1xuICAgICAgICBhd2FpdCB0aGlzLnNsb3dRdWVyaWVzUHJvdmlkZXJzLmltbXV0YWJsZS5zdGFydChbXSk7XG4gICAgICAgIGF3YWl0IHRoaXMucHJvdmlkZXJzLmltbXV0YWJsZS5ob3RVcGRhdGUoKTtcbiAgICB9XG5cbiAgICBhc3luYyBkcm9wQ2FjaGVkRGJJbmZvKCkge1xuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zLmZvckVhY2goKHg6IFFEYXRhQ29sbGVjdGlvbikgPT4geC5kcm9wQ2FjaGVkRGJJbmZvKCkpO1xuICAgICAgICBhd2FpdCB0aGlzLnByb3ZpZGVycy5pbW11dGFibGUuaG90VXBkYXRlKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgcXVlcnkocHJvdmlkZXI6IFFEYXRhUHJvdmlkZXIsIHRleHQ6IHN0cmluZywgdmFyczogeyBbc3RyaW5nXTogYW55IH0sIG9yZGVyQnk6IE9yZGVyQnlbXSkge1xuICAgICAgICByZXR1cm4gd3JhcCh0aGlzLmxvZywgJ1FVRVJZJywgeyB0ZXh0LCB2YXJzIH0sIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBwcm92aWRlci5xdWVyeSh0ZXh0LCB2YXJzLCBvcmRlckJ5KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluaXNoT3BlcmF0aW9ucyhvcGVyYXRpb25JZHM6IFNldDxzdHJpbmc+KTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICAgICAgbGV0IGNvdW50ID0gMDtcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9ucy5mb3JFYWNoKHggPT4gKGNvdW50ICs9IHguZmluaXNoT3BlcmF0aW9ucyhvcGVyYXRpb25JZHMpKSk7XG4gICAgICAgIHJldHVybiBjb3VudDtcbiAgICB9XG59XG4iXX0=