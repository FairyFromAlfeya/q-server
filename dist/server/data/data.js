"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _collection = require("./collection");

var _auth = require("../auth");

var _config = require("../config");

var _logs = _interopRequireDefault(require("../logs"));

var _opentracing = require("opentracing");

var _tracer = require("../tracer");

var _utils = require("../utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
class QData {
  // Dependencies
  // Own
  constructor(options) {
    this.providers = options.providers;
    this.slowQueriesProviders = options.slowQueriesProviders || options.providers;
    this.logs = options.logs;
    this.stats = options.stats;
    this.auth = options.auth;
    this.tracer = options.tracer;
    this.isTests = options.isTests;
    this.log = this.logs.create('data');
    this.statPostCount = new _tracer.StatsCounter(this.stats, _config.STATS.post.count, []);
    this.statPostFailed = new _tracer.StatsCounter(this.stats, _config.STATS.post.failed, []);
    this.collections = [];
    this.collectionsByName = new Map();
  }

  addCollection(name, docType, scope, indexes) {
    const collection = new _collection.QDataCollection({
      name,
      docType,
      scope,
      indexes,
      provider: this.providers[scope],
      slowQueriesProvider: this.slowQueriesProviders[scope],
      logs: this.logs,
      auth: this.auth,
      tracer: this.tracer,
      stats: this.stats,
      isTests: this.isTests
    });
    this.collections.push(collection);
    this.collectionsByName.set(name, collection);
    return collection;
  }

  async start() {
    for (const scope of Object.keys(_collection.QDataScope)) {
      const collectionsForSubscribe = this.collections.filter(x => x.scope === scope).map(x => x.name);
      await this.providers[scope].start(collectionsForSubscribe);
      await this.slowQueriesProviders[scope].start([]);
    }

    await this.providers.immutable.hotUpdate();
  }

  async dropCachedDbInfo() {
    this.collections.forEach(x => x.dropCachedDbInfo());
    await this.providers.immutable.hotUpdate();
  }

  async query(provider, text, vars, orderBy) {
    return (0, _utils.wrap)(this.log, 'QUERY', {
      text,
      vars
    }, async () => {
      return provider.query(text, vars, orderBy);
    });
  }

  async finishOperations(operationIds) {
    let count = 0;
    this.collections.forEach(x => count += x.finishOperations(operationIds));
    return count;
  }

}

exports.default = QData;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9kYXRhLmpzIl0sIm5hbWVzIjpbIlFEYXRhIiwiY29uc3RydWN0b3IiLCJvcHRpb25zIiwicHJvdmlkZXJzIiwic2xvd1F1ZXJpZXNQcm92aWRlcnMiLCJsb2dzIiwic3RhdHMiLCJhdXRoIiwidHJhY2VyIiwiaXNUZXN0cyIsImxvZyIsImNyZWF0ZSIsInN0YXRQb3N0Q291bnQiLCJTdGF0c0NvdW50ZXIiLCJTVEFUUyIsInBvc3QiLCJjb3VudCIsInN0YXRQb3N0RmFpbGVkIiwiZmFpbGVkIiwiY29sbGVjdGlvbnMiLCJjb2xsZWN0aW9uc0J5TmFtZSIsIk1hcCIsImFkZENvbGxlY3Rpb24iLCJuYW1lIiwiZG9jVHlwZSIsInNjb3BlIiwiaW5kZXhlcyIsImNvbGxlY3Rpb24iLCJRRGF0YUNvbGxlY3Rpb24iLCJwcm92aWRlciIsInNsb3dRdWVyaWVzUHJvdmlkZXIiLCJwdXNoIiwic2V0Iiwic3RhcnQiLCJPYmplY3QiLCJrZXlzIiwiUURhdGFTY29wZSIsImNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlIiwiZmlsdGVyIiwieCIsIm1hcCIsImltbXV0YWJsZSIsImhvdFVwZGF0ZSIsImRyb3BDYWNoZWREYkluZm8iLCJmb3JFYWNoIiwicXVlcnkiLCJ0ZXh0IiwidmFycyIsIm9yZGVyQnkiLCJmaW5pc2hPcGVyYXRpb25zIiwib3BlcmF0aW9uSWRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBbUJBOztBQUNBOztBQUNBOztBQUVBOztBQUVBOztBQUNBOztBQUVBOzs7O0FBNUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQWtDZSxNQUFNQSxLQUFOLENBQVk7QUFDdkI7QUFTQTtBQVFBQyxFQUFBQSxXQUFXLENBQUNDLE9BQUQsRUFBd0I7QUFDL0IsU0FBS0MsU0FBTCxHQUFpQkQsT0FBTyxDQUFDQyxTQUF6QjtBQUNBLFNBQUtD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QUNoQixRQUFELEVBQTBCaUIsSUFBMUIsRUFBd0NDLElBQXhDLEVBQWlFQyxPQUFqRSxFQUFxRjtBQUM1RixXQUFPLGlCQUFLLEtBQUt0QyxHQUFWLEVBQWUsT0FBZixFQUF3QjtBQUFFb0MsTUFBQUEsSUFBRjtBQUFRQyxNQUFBQTtBQUFSLEtBQXhCLEVBQXdDLFlBQVk7QUFDdkQsYUFBT2xCLFFBQVEsQ0FBQ2dCLEtBQVQsQ0FBZUMsSUFBZixFQUFxQkMsSUFBckIsRUFBMkJDLE9BQTNCLENBQVA7QUFDSCxLQUZNLENBQVA7QUFHSDs7QUFFcUIsUUFBaEJDLGdCQUFnQixDQUFDQyxZQUFELEVBQTZDO0FBQy9ELFFBQUlsQyxLQUFLLEdBQUcsQ0FBWjtBQUNBLFNBQUtHLFdBQUwsQ0FBaUJ5QixPQUFqQixDQUF5QkwsQ0FBQyxJQUFLdkIsS0FBSyxJQUFJdUIsQ0FBQyxDQUFDVSxnQkFBRixDQUFtQkMsWUFBbkIsQ0FBeEM7QUFDQSxXQUFPbEMsS0FBUDtBQUNIOztBQWpGc0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTgtMjAyMCBUT04gREVWIFNPTFVUSU9OUyBMVEQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIFNPRlRXQVJFIEVWQUxVQVRJT04gTGljZW5zZSAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlXG4gKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGVcbiAqIExpY2Vuc2UgYXQ6XG4gKlxuICogaHR0cDovL3d3dy50b24uZGV2L2xpY2Vuc2VzXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBUT04gREVWIHNvZnR3YXJlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbi8vIEBmbG93XG5cbmltcG9ydCB0eXBlIHsgUURhdGFTY29wZVR5cGUgfSBmcm9tIFwiLi9jb2xsZWN0aW9uXCI7XG5pbXBvcnQgeyBRRGF0YUNvbGxlY3Rpb24sIFFEYXRhU2NvcGUgfSBmcm9tICcuL2NvbGxlY3Rpb24nO1xuaW1wb3J0IHsgQXV0aCB9IGZyb20gJy4uL2F1dGgnO1xuaW1wb3J0IHsgU1RBVFMgfSBmcm9tICcuLi9jb25maWcnO1xuaW1wb3J0IHR5cGUgeyBRTG9nIH0gZnJvbSAnLi4vbG9ncyc7XG5pbXBvcnQgUUxvZ3MgZnJvbSAnLi4vbG9ncydcbmltcG9ydCB0eXBlIHsgT3JkZXJCeSwgUVR5cGUgfSBmcm9tICcuLi9maWx0ZXIvZmlsdGVycyc7XG5pbXBvcnQgeyBUcmFjZXIgfSBmcm9tICdvcGVudHJhY2luZyc7XG5pbXBvcnQgeyBTdGF0c0NvdW50ZXIgfSBmcm9tICcuLi90cmFjZXInO1xuaW1wb3J0IHR5cGUgeyBJU3RhdHMgfSBmcm9tICcuLi90cmFjZXInO1xuaW1wb3J0IHsgd3JhcCB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB0eXBlIHsgUURhdGFQcm92aWRlciwgUUluZGV4SW5mbyB9IGZyb20gJy4vZGF0YS1wcm92aWRlcic7XG5cbmV4cG9ydCB0eXBlIFFEYXRhUHJvdmlkZXJzID0ge1xuICAgIG11dGFibGU6IFFEYXRhUHJvdmlkZXIsXG4gICAgaW1tdXRhYmxlOiBRRGF0YVByb3ZpZGVyLFxuICAgIGNvdW50ZXJwYXJ0aWVzOiBRRGF0YVByb3ZpZGVyLFxufVxuXG5leHBvcnQgdHlwZSBRRGF0YU9wdGlvbnMgPSB7XG4gICAgcHJvdmlkZXJzOiBRRGF0YVByb3ZpZGVycyxcbiAgICBzbG93UXVlcmllc1Byb3ZpZGVycz86IFFEYXRhUHJvdmlkZXJzLFxuXG4gICAgbG9nczogUUxvZ3MsXG4gICAgYXV0aDogQXV0aCxcbiAgICB0cmFjZXI6IFRyYWNlcixcbiAgICBzdGF0czogSVN0YXRzLFxuICAgIGlzVGVzdHM6IGJvb2xlYW4sXG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFFEYXRhIHtcbiAgICAvLyBEZXBlbmRlbmNpZXNcbiAgICBwcm92aWRlcnM6IFFEYXRhUHJvdmlkZXJzO1xuICAgIHNsb3dRdWVyaWVzUHJvdmlkZXJzOiBRRGF0YVByb3ZpZGVycztcbiAgICBsb2dzOiBRTG9ncztcbiAgICBzdGF0czogSVN0YXRzO1xuICAgIGF1dGg6IEF1dGg7XG4gICAgdHJhY2VyOiBUcmFjZXI7XG4gICAgaXNUZXN0czogYm9vbGVhbjtcblxuICAgIC8vIE93blxuICAgIGxvZzogUUxvZztcbiAgICBzdGF0UG9zdENvdW50OiBTdGF0c0NvdW50ZXI7XG4gICAgc3RhdFBvc3RGYWlsZWQ6IFN0YXRzQ291bnRlcjtcblxuICAgIGNvbGxlY3Rpb25zOiBRRGF0YUNvbGxlY3Rpb25bXTtcbiAgICBjb2xsZWN0aW9uc0J5TmFtZTogTWFwPHN0cmluZywgUURhdGFDb2xsZWN0aW9uPjtcblxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IFFEYXRhT3B0aW9ucykge1xuICAgICAgICB0aGlzLnByb3ZpZGVycyA9IG9wdGlvbnMucHJvdmlkZXJzO1xuICAgICAgICB0aGlzLnNsb3dRdWVyaWVzUHJvdmlkZXJzID0gb3B0aW9ucy5zbG93UXVlcmllc1Byb3ZpZGVycyB8fCBvcHRpb25zLnByb3ZpZGVycztcbiAgICAgICAgdGhpcy5sb2dzID0gb3B0aW9ucy5sb2dzO1xuICAgICAgICB0aGlzLnN0YXRzID0gb3B0aW9ucy5zdGF0cztcbiAgICAgICAgdGhpcy5hdXRoID0gb3B0aW9ucy5hdXRoO1xuICAgICAgICB0aGlzLnRyYWNlciA9IG9wdGlvbnMudHJhY2VyO1xuICAgICAgICB0aGlzLmlzVGVzdHMgPSBvcHRpb25zLmlzVGVzdHM7XG5cbiAgICAgICAgdGhpcy5sb2cgPSB0aGlzLmxvZ3MuY3JlYXRlKCdkYXRhJyk7XG5cbiAgICAgICAgdGhpcy5zdGF0UG9zdENvdW50ID0gbmV3IFN0YXRzQ291bnRlcih0aGlzLnN0YXRzLCBTVEFUUy5wb3N0LmNvdW50LCBbXSk7XG4gICAgICAgIHRoaXMuc3RhdFBvc3RGYWlsZWQgPSBuZXcgU3RhdHNDb3VudGVyKHRoaXMuc3RhdHMsIFNUQVRTLnBvc3QuZmFpbGVkLCBbXSk7XG5cbiAgICAgICAgdGhpcy5jb2xsZWN0aW9ucyA9IFtdO1xuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zQnlOYW1lID0gbmV3IE1hcCgpO1xuICAgIH1cblxuICAgIGFkZENvbGxlY3Rpb24obmFtZTogc3RyaW5nLCBkb2NUeXBlOiBRVHlwZSwgc2NvcGU6IFFEYXRhU2NvcGVUeXBlLCBpbmRleGVzOiBRSW5kZXhJbmZvW10pIHtcbiAgICAgICAgY29uc3QgY29sbGVjdGlvbiA9IG5ldyBRRGF0YUNvbGxlY3Rpb24oe1xuICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgIGRvY1R5cGUsXG4gICAgICAgICAgICBzY29wZSxcbiAgICAgICAgICAgIGluZGV4ZXMsXG4gICAgICAgICAgICBwcm92aWRlcjogdGhpcy5wcm92aWRlcnNbc2NvcGVdLFxuICAgICAgICAgICAgc2xvd1F1ZXJpZXNQcm92aWRlcjogdGhpcy5zbG93UXVlcmllc1Byb3ZpZGVyc1tzY29wZV0sXG4gICAgICAgICAgICBsb2dzOiB0aGlzLmxvZ3MsXG4gICAgICAgICAgICBhdXRoOiB0aGlzLmF1dGgsXG4gICAgICAgICAgICB0cmFjZXI6IHRoaXMudHJhY2VyLFxuICAgICAgICAgICAgc3RhdHM6IHRoaXMuc3RhdHMsXG4gICAgICAgICAgICBpc1Rlc3RzOiB0aGlzLmlzVGVzdHMsXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zLnB1c2goY29sbGVjdGlvbik7XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnNCeU5hbWUuc2V0KG5hbWUsIGNvbGxlY3Rpb24pO1xuICAgICAgICByZXR1cm4gY29sbGVjdGlvbjtcbiAgICB9XG5cbiAgICBhc3luYyBzdGFydCgpIHtcbiAgICAgICAgZm9yIChjb25zdCBzY29wZSBvZiBPYmplY3Qua2V5cyhRRGF0YVNjb3BlKSkge1xuICAgICAgICAgICAgY29uc3QgY29sbGVjdGlvbnNGb3JTdWJzY3JpYmUgPSB0aGlzLmNvbGxlY3Rpb25zXG4gICAgICAgICAgICAgICAgLmZpbHRlcih4ID0+IHguc2NvcGUgPT09IHNjb3BlKVxuICAgICAgICAgICAgICAgIC5tYXAoeCA9PiB4Lm5hbWUpO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5wcm92aWRlcnNbc2NvcGVdLnN0YXJ0KGNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2xvd1F1ZXJpZXNQcm92aWRlcnNbc2NvcGVdLnN0YXJ0KFtdKTtcbiAgICAgICAgfVxuICAgICAgICBhd2FpdCB0aGlzLnByb3ZpZGVycy5pbW11dGFibGUuaG90VXBkYXRlKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgZHJvcENhY2hlZERiSW5mbygpIHtcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9ucy5mb3JFYWNoKCh4OiBRRGF0YUNvbGxlY3Rpb24pID0+IHguZHJvcENhY2hlZERiSW5mbygpKTtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm92aWRlcnMuaW1tdXRhYmxlLmhvdFVwZGF0ZSgpO1xuICAgIH1cblxuICAgIGFzeW5jIHF1ZXJ5KHByb3ZpZGVyOiBRRGF0YVByb3ZpZGVyLCB0ZXh0OiBzdHJpbmcsIHZhcnM6IHsgW3N0cmluZ106IGFueSB9LCBvcmRlckJ5OiBPcmRlckJ5W10pIHtcbiAgICAgICAgcmV0dXJuIHdyYXAodGhpcy5sb2csICdRVUVSWScsIHsgdGV4dCwgdmFycyB9LCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gcHJvdmlkZXIucXVlcnkodGV4dCwgdmFycywgb3JkZXJCeSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmlzaE9wZXJhdGlvbnMob3BlcmF0aW9uSWRzOiBTZXQ8c3RyaW5nPik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGxldCBjb3VudCA9IDA7XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnMuZm9yRWFjaCh4ID0+IChjb3VudCArPSB4LmZpbmlzaE9wZXJhdGlvbnMob3BlcmF0aW9uSWRzKSkpO1xuICAgICAgICByZXR1cm4gY291bnQ7XG4gICAgfVxufVxuIl19