"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _arangoProvider = require("./arango-provider");

var _collection = require("./collection");

var _auth = require("../auth");

var _config = require("../config");

var _logs = _interopRequireDefault(require("../logs"));

var _resolversGenerated = require("../graphql/resolvers-generated");

var _opentracing = require("opentracing");

var _tracer = require("../tracer");

var _utils = require("../utils");

var _dataBroker = require("./data-broker");

var _dataProvider = require("./data-provider");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
function createBroker(brokerName, logs, config) {
  const arangoDb = (dbName, segment, config) => new _arangoProvider.ArangoProvider(logs.create(`${brokerName}_${dbName}`), segment, config);

  return new _dataBroker.QDataBroker({
    mutable: arangoDb('mutable', _dataProvider.dataSegment.MUTABLE, config.mutable),
    immutableHot: arangoDb('hot', _dataProvider.dataSegment.IMMUTABLE, config.immutableHot),
    immutableCold: config.immutableCold.map(x => arangoDb('cold', _dataProvider.dataSegment.IMMUTABLE, x)),
    immutableColdCache: _dataProvider.missingDataCache
  });
}

class QData {
  constructor(config, logs, auth, tracer, stats) {
    this.config = config;
    this.log = logs.create('data');
    this.auth = auth;
    this.tracer = tracer;
    this.statPostCount = new _tracer.StatsCounter(stats, _config.STATS.post.count, []);
    this.statPostFailed = new _tracer.StatsCounter(stats, _config.STATS.post.failed, []);
    this.broker = createBroker('fast', logs, config.data);
    this.slowQueriesBroker = createBroker('slow', logs, config.slowQueriesData);
    this.collections = [];
    this.collectionsByName = new Map();

    const addCollection = (name, docType) => {
      const collection = new _collection.QDataCollection({
        name,
        docType,
        logs,
        auth,
        tracer,
        stats,
        broker: this.broker,
        slowQueriesBroker: this.slowQueriesBroker,
        isTests: config.isTests || false
      });
      this.collections.push(collection);
      this.collectionsByName.set(name, collection);
      return collection;
    };

    this.transactions = addCollection('transactions', _resolversGenerated.Transaction);
    this.messages = addCollection('messages', _resolversGenerated.Message);
    this.accounts = addCollection('accounts', _resolversGenerated.Account);
    this.blocks = addCollection('blocks', _resolversGenerated.Block);
    this.blocks_signatures = addCollection('blocks_signatures', _resolversGenerated.BlockSignatures);
  }

  start() {
    this.broker.start();
    this.slowQueriesBroker.start();
  }

  dropCachedDbInfo() {
    this.collections.forEach(x => x.dropCachedDbInfo());
  }

  async query(segment, text, vars, orderBy) {
    return (0, _utils.wrap)(this.log, 'QUERY', {
      text,
      vars
    }, async () => {
      return this.broker.query({
        segment,
        text,
        vars,
        orderBy
      });
    });
  }

  async finishOperations(operationIds) {
    let count = 0;
    this.collections.forEach(x => count += x.finishOperations(operationIds));
    return count;
  }

}

exports.default = QData;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9kYXRhLmpzIl0sIm5hbWVzIjpbImNyZWF0ZUJyb2tlciIsImJyb2tlck5hbWUiLCJsb2dzIiwiY29uZmlnIiwiYXJhbmdvRGIiLCJkYk5hbWUiLCJzZWdtZW50IiwiQXJhbmdvUHJvdmlkZXIiLCJjcmVhdGUiLCJRRGF0YUJyb2tlciIsIm11dGFibGUiLCJkYXRhU2VnbWVudCIsIk1VVEFCTEUiLCJpbW11dGFibGVIb3QiLCJJTU1VVEFCTEUiLCJpbW11dGFibGVDb2xkIiwibWFwIiwieCIsImltbXV0YWJsZUNvbGRDYWNoZSIsIm1pc3NpbmdEYXRhQ2FjaGUiLCJRRGF0YSIsImNvbnN0cnVjdG9yIiwiYXV0aCIsInRyYWNlciIsInN0YXRzIiwibG9nIiwic3RhdFBvc3RDb3VudCIsIlN0YXRzQ291bnRlciIsIlNUQVRTIiwicG9zdCIsImNvdW50Iiwic3RhdFBvc3RGYWlsZWQiLCJmYWlsZWQiLCJicm9rZXIiLCJkYXRhIiwic2xvd1F1ZXJpZXNCcm9rZXIiLCJzbG93UXVlcmllc0RhdGEiLCJjb2xsZWN0aW9ucyIsImNvbGxlY3Rpb25zQnlOYW1lIiwiTWFwIiwiYWRkQ29sbGVjdGlvbiIsIm5hbWUiLCJkb2NUeXBlIiwiY29sbGVjdGlvbiIsIlFEYXRhQ29sbGVjdGlvbiIsImlzVGVzdHMiLCJwdXNoIiwic2V0IiwidHJhbnNhY3Rpb25zIiwiVHJhbnNhY3Rpb24iLCJtZXNzYWdlcyIsIk1lc3NhZ2UiLCJhY2NvdW50cyIsIkFjY291bnQiLCJibG9ja3MiLCJCbG9jayIsImJsb2Nrc19zaWduYXR1cmVzIiwiQmxvY2tTaWduYXR1cmVzIiwic3RhcnQiLCJkcm9wQ2FjaGVkRGJJbmZvIiwiZm9yRWFjaCIsInF1ZXJ5IiwidGV4dCIsInZhcnMiLCJvcmRlckJ5IiwiZmluaXNoT3BlcmF0aW9ucyIsIm9wZXJhdGlvbklkcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQWtCQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFF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LENBQUMsSUFBS2EsS0FBSyxJQUFJYixDQUFDLENBQUNnRCxnQkFBRixDQUFtQkMsWUFBbkIsQ0FBeEM7QUFDQSxXQUFPcEMsS0FBUDtBQUNIOztBQTFGc0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTgtMjAyMCBUT04gREVWIFNPTFVUSU9OUyBMVEQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIFNPRlRXQVJFIEVWQUxVQVRJT04gTGljZW5zZSAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlXG4gKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGVcbiAqIExpY2Vuc2UgYXQ6XG4gKlxuICogaHR0cDovL3d3dy50b24uZGV2L2xpY2Vuc2VzXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBUT04gREVWIHNvZnR3YXJlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbi8vIEBmbG93XG5cbmltcG9ydCB7IEFyYW5nb1Byb3ZpZGVyIH0gZnJvbSAnLi9hcmFuZ28tcHJvdmlkZXInO1xuaW1wb3J0IHsgUURhdGFDb2xsZWN0aW9uIH0gZnJvbSAnLi9jb2xsZWN0aW9uJztcbmltcG9ydCB7IEF1dGggfSBmcm9tICcuLi9hdXRoJztcbmltcG9ydCB0eXBlIHsgUUNvbmZpZywgUURhdGFCcm9rZXJDb25maWcsIFFBcmFuZ29Db25maWcgfSBmcm9tICcuLi9jb25maWcnXG5pbXBvcnQgeyBTVEFUUyB9IGZyb20gJy4uL2NvbmZpZyc7XG5pbXBvcnQgdHlwZSB7IFFMb2cgfSBmcm9tICcuLi9sb2dzJztcbmltcG9ydCBRTG9ncyBmcm9tICcuLi9sb2dzJ1xuaW1wb3J0IHR5cGUgeyBPcmRlckJ5LCBRVHlwZSB9IGZyb20gJy4uL2ZpbHRlci9kYXRhLXR5cGVzJztcbmltcG9ydCB7IEFjY291bnQsIEJsb2NrLCBCbG9ja1NpZ25hdHVyZXMsIE1lc3NhZ2UsIFRyYW5zYWN0aW9uIH0gZnJvbSAnLi4vZ3JhcGhxbC9yZXNvbHZlcnMtZ2VuZXJhdGVkJztcbmltcG9ydCB7IFRyYWNlciB9IGZyb20gJ29wZW50cmFjaW5nJztcbmltcG9ydCB7IFN0YXRzQ291bnRlciB9IGZyb20gJy4uL3RyYWNlcic7XG5pbXBvcnQgdHlwZSB7IElTdGF0cyB9IGZyb20gJy4uL3RyYWNlcic7XG5pbXBvcnQgeyB3cmFwIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgUURhdGFCcm9rZXIgfSBmcm9tICcuL2RhdGEtYnJva2VyJztcbmltcG9ydCB0eXBlIHsgUURhdGFTZWdtZW50IH0gZnJvbSAnLi9kYXRhLXByb3ZpZGVyJztcbmltcG9ydCB7IGRhdGFTZWdtZW50LCBtaXNzaW5nRGF0YUNhY2hlIH0gZnJvbSAnLi9kYXRhLXByb3ZpZGVyJztcblxuXG5mdW5jdGlvbiBjcmVhdGVCcm9rZXIoXG4gICAgYnJva2VyTmFtZTogc3RyaW5nLFxuICAgIGxvZ3M6IFFMb2dzLFxuICAgIGNvbmZpZzogUURhdGFCcm9rZXJDb25maWcsXG4pOiBRRGF0YUJyb2tlciB7XG4gICAgY29uc3QgYXJhbmdvRGIgPSAoZGJOYW1lOiBzdHJpbmcsIHNlZ21lbnQ6IFFEYXRhU2VnbWVudCwgY29uZmlnOiBRQXJhbmdvQ29uZmlnKTogQXJhbmdvUHJvdmlkZXIgPT4gKFxuICAgICAgICBuZXcgQXJhbmdvUHJvdmlkZXIobG9ncy5jcmVhdGUoYCR7YnJva2VyTmFtZX1fJHtkYk5hbWV9YCksIHNlZ21lbnQsIGNvbmZpZylcbiAgICApO1xuICAgIHJldHVybiBuZXcgUURhdGFCcm9rZXIoe1xuICAgICAgICBtdXRhYmxlOiBhcmFuZ29EYignbXV0YWJsZScsIGRhdGFTZWdtZW50Lk1VVEFCTEUsIGNvbmZpZy5tdXRhYmxlKSxcbiAgICAgICAgaW1tdXRhYmxlSG90OiBhcmFuZ29EYignaG90JywgZGF0YVNlZ21lbnQuSU1NVVRBQkxFLCBjb25maWcuaW1tdXRhYmxlSG90KSxcbiAgICAgICAgaW1tdXRhYmxlQ29sZDogY29uZmlnLmltbXV0YWJsZUNvbGQubWFwKHggPT4gYXJhbmdvRGIoJ2NvbGQnLCBkYXRhU2VnbWVudC5JTU1VVEFCTEUsIHgpKSxcbiAgICAgICAgaW1tdXRhYmxlQ29sZENhY2hlOiBtaXNzaW5nRGF0YUNhY2hlLFxuICAgIH0pXG59XG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUURhdGEge1xuICAgIGNvbmZpZzogUUNvbmZpZztcbiAgICBsb2c6IFFMb2c7XG5cbiAgICBicm9rZXI6IFFEYXRhQnJva2VyO1xuICAgIHNsb3dRdWVyaWVzQnJva2VyOiBRRGF0YUJyb2tlcjtcblxuICAgIGF1dGg6IEF1dGg7XG4gICAgdHJhY2VyOiBUcmFjZXI7XG4gICAgc3RhdFBvc3RDb3VudDogU3RhdHNDb3VudGVyO1xuICAgIHN0YXRQb3N0RmFpbGVkOiBTdGF0c0NvdW50ZXI7XG5cbiAgICB0cmFuc2FjdGlvbnM6IFFEYXRhQ29sbGVjdGlvbjtcbiAgICBtZXNzYWdlczogUURhdGFDb2xsZWN0aW9uO1xuICAgIGFjY291bnRzOiBRRGF0YUNvbGxlY3Rpb247XG4gICAgYmxvY2tzOiBRRGF0YUNvbGxlY3Rpb247XG4gICAgYmxvY2tzX3NpZ25hdHVyZXM6IFFEYXRhQ29sbGVjdGlvbjtcblxuICAgIGNvbGxlY3Rpb25zOiBRRGF0YUNvbGxlY3Rpb25bXTtcbiAgICBjb2xsZWN0aW9uc0J5TmFtZTogTWFwPHN0cmluZywgUURhdGFDb2xsZWN0aW9uPjtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBjb25maWc6IFFDb25maWcsXG4gICAgICAgIGxvZ3M6IFFMb2dzLFxuICAgICAgICBhdXRoOiBBdXRoLFxuICAgICAgICB0cmFjZXI6IFRyYWNlcixcbiAgICAgICAgc3RhdHM6IElTdGF0cyxcbiAgICApIHtcbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgICAgIHRoaXMubG9nID0gbG9ncy5jcmVhdGUoJ2RhdGEnKTtcbiAgICAgICAgdGhpcy5hdXRoID0gYXV0aDtcbiAgICAgICAgdGhpcy50cmFjZXIgPSB0cmFjZXI7XG5cbiAgICAgICAgdGhpcy5zdGF0UG9zdENvdW50ID0gbmV3IFN0YXRzQ291bnRlcihzdGF0cywgU1RBVFMucG9zdC5jb3VudCwgW10pO1xuICAgICAgICB0aGlzLnN0YXRQb3N0RmFpbGVkID0gbmV3IFN0YXRzQ291bnRlcihzdGF0cywgU1RBVFMucG9zdC5mYWlsZWQsIFtdKTtcblxuICAgICAgICB0aGlzLmJyb2tlciA9IGNyZWF0ZUJyb2tlcignZmFzdCcsIGxvZ3MsIGNvbmZpZy5kYXRhKVxuICAgICAgICB0aGlzLnNsb3dRdWVyaWVzQnJva2VyID0gY3JlYXRlQnJva2VyKCdzbG93JywgbG9ncywgY29uZmlnLnNsb3dRdWVyaWVzRGF0YSk7XG5cbiAgICAgICAgdGhpcy5jb2xsZWN0aW9ucyA9IFtdO1xuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zQnlOYW1lID0gbmV3IE1hcCgpO1xuXG4gICAgICAgIGNvbnN0IGFkZENvbGxlY3Rpb24gPSAobmFtZTogc3RyaW5nLCBkb2NUeXBlOiBRVHlwZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29sbGVjdGlvbiA9IG5ldyBRRGF0YUNvbGxlY3Rpb24oe1xuICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgZG9jVHlwZSxcbiAgICAgICAgICAgICAgICBsb2dzLFxuICAgICAgICAgICAgICAgIGF1dGgsXG4gICAgICAgICAgICAgICAgdHJhY2VyLFxuICAgICAgICAgICAgICAgIHN0YXRzLFxuICAgICAgICAgICAgICAgIGJyb2tlcjogdGhpcy5icm9rZXIsXG4gICAgICAgICAgICAgICAgc2xvd1F1ZXJpZXNCcm9rZXI6IHRoaXMuc2xvd1F1ZXJpZXNCcm9rZXIsXG4gICAgICAgICAgICAgICAgaXNUZXN0czogY29uZmlnLmlzVGVzdHMgfHwgZmFsc2UsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMuY29sbGVjdGlvbnMucHVzaChjb2xsZWN0aW9uKTtcbiAgICAgICAgICAgIHRoaXMuY29sbGVjdGlvbnNCeU5hbWUuc2V0KG5hbWUsIGNvbGxlY3Rpb24pO1xuICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3Rpb247XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy50cmFuc2FjdGlvbnMgPSBhZGRDb2xsZWN0aW9uKCd0cmFuc2FjdGlvbnMnLCBUcmFuc2FjdGlvbik7XG4gICAgICAgIHRoaXMubWVzc2FnZXMgPSBhZGRDb2xsZWN0aW9uKCdtZXNzYWdlcycsIE1lc3NhZ2UpO1xuICAgICAgICB0aGlzLmFjY291bnRzID0gYWRkQ29sbGVjdGlvbignYWNjb3VudHMnLCBBY2NvdW50KTtcbiAgICAgICAgdGhpcy5ibG9ja3MgPSBhZGRDb2xsZWN0aW9uKCdibG9ja3MnLCBCbG9jayk7XG4gICAgICAgIHRoaXMuYmxvY2tzX3NpZ25hdHVyZXMgPSBhZGRDb2xsZWN0aW9uKCdibG9ja3Nfc2lnbmF0dXJlcycsIEJsb2NrU2lnbmF0dXJlcyk7XG4gICAgfVxuXG4gICAgc3RhcnQoKSB7XG4gICAgICAgIHRoaXMuYnJva2VyLnN0YXJ0KCk7XG4gICAgICAgIHRoaXMuc2xvd1F1ZXJpZXNCcm9rZXIuc3RhcnQoKTtcbiAgICB9XG5cbiAgICBkcm9wQ2FjaGVkRGJJbmZvKCkge1xuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zLmZvckVhY2goKHg6IFFEYXRhQ29sbGVjdGlvbikgPT4geC5kcm9wQ2FjaGVkRGJJbmZvKCkpO1xuICAgIH1cblxuICAgIGFzeW5jIHF1ZXJ5KHNlZ21lbnQ6IFFEYXRhU2VnbWVudCwgdGV4dDogc3RyaW5nLCB2YXJzOiB7IFtzdHJpbmddOiBhbnkgfSwgb3JkZXJCeTogT3JkZXJCeVtdKSB7XG4gICAgICAgIHJldHVybiB3cmFwKHRoaXMubG9nLCAnUVVFUlknLCB7IHRleHQsIHZhcnMgfSwgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYnJva2VyLnF1ZXJ5KHtcbiAgICAgICAgICAgICAgICBzZWdtZW50LFxuICAgICAgICAgICAgICAgIHRleHQsXG4gICAgICAgICAgICAgICAgdmFycyxcbiAgICAgICAgICAgICAgICBvcmRlckJ5LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmlzaE9wZXJhdGlvbnMob3BlcmF0aW9uSWRzOiBTZXQ8c3RyaW5nPik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGxldCBjb3VudCA9IDA7XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnMuZm9yRWFjaCh4ID0+IChjb3VudCArPSB4LmZpbmlzaE9wZXJhdGlvbnMob3BlcmF0aW9uSWRzKSkpO1xuICAgICAgICByZXR1cm4gY291bnQ7XG4gICAgfVxufVxuIl19