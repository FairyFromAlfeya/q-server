"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.QDataBroker = void 0;

var _data = require("./data");

class QDataBroker {
  constructor(options) {
    this.mut = options.mut;
    this.hot = options.hot;
    this.cold = options.cold;
    this.cache = options.cache;
  }

  start() {
    this.mut.start();
    this.hot.start();
    this.cold.forEach(x => x.start());
  }

  async query(params) {
    if (params.segment === _data.dataSegment.MUTABLE) {
      return this.mut.query(params.text, params.vars);
    }

    return combineResults(await Promise.all([this.hot.query(params.text, params.vars), this.queryCold(params)]), params.orderBy);
  }

  async queryCold(params) {
    if (this.cold.length === 0) {
      return [];
    }

    const key = JSON.stringify({
      text: params.text,
      vars: params.vars,
      orderBy: params.orderBy
    });
    let docs = await this.cache.get(key);

    if (isNullOrUndefined(docs)) {
      const results = await Promise.all(this.cold.map(x => x.query(params.text, params.vars)));
      docs = combineResults(results, params.orderBy);
      await this.cache.set(key, docs);
    }

    return docs;
  }

}

exports.QDataBroker = QDataBroker;

function combineResults(results, orderBy) {
  const docs = collectDistinctDocs(results);

  if (orderBy.length > 0) {
    docs.sort((a, b) => compareDocs(a, b, orderBy));
  }

  return docs;
}

function collectDistinctDocs(source) {
  const distinctDocs = [];
  const distinctKeys = new Set();
  source.forEach(docs => {
    docs.forEach(doc => {
      if (!doc._key) {
        distinctDocs.push(doc);
      } else if (!distinctKeys.has(doc._key)) {
        distinctDocs.push(doc);
        distinctKeys.add(doc._key);
      }
    });
  });
  return distinctDocs;
}

function compareDocs(a, b, orderBy) {
  for (let i = 0; i < orderBy.length; i += 1) {
    const field = orderBy[i];
    const path = field.path.split('.');
    const aValue = getValue(a, path, 0);
    const bValue = getValue(a, path, 0);
    let comparison = compareValues(aValue, bValue);

    if (comparison !== 0) {
      return field.direction === 'DESC' ? -comparison : comparison;
    }
  }

  return 0;
}

function getValue(value, path, pathIndex) {
  if (isNullOrUndefined(value) || pathIndex >= path.length) {
    return value;
  }

  return getValue(value[path[pathIndex]], path, pathIndex + 1);
}

function compareValues(a, b) {
  const aHasValue = !isNullOrUndefined(a);
  const bHasValue = !isNullOrUndefined(b);

  if (!aHasValue) {
    return bHasValue ? -1 : 0;
  }

  if (!bHasValue) {
    return 1;
  }

  return a === b ? 0 : a < b ? -1 : 0;
}

function isNullOrUndefined(v) {
  return v === null || typeof v === 'undefined';
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9icm9rZXIuanMiXSwibmFtZXMiOlsiUURhdGFCcm9rZXIiLCJjb25zdHJ1Y3RvciIsIm9wdGlvbnMiLCJtdXQiLCJob3QiLCJjb2xkIiwiY2FjaGUiLCJzdGFydCIsImZvckVhY2giLCJ4IiwicXVlcnkiLCJwYXJhbXMiLCJzZWdtZW50IiwiZGF0YVNlZ21lbnQiLCJNVVRBQkxFIiwidGV4dCIsInZhcnMiLCJjb21iaW5lUmVzdWx0cyIsIlByb21pc2UiLCJhbGwiLCJxdWVyeUNvbGQiLCJvcmRlckJ5IiwibGVuZ3RoIiwia2V5IiwiSlNPTiIsInN0cmluZ2lmeSIsImRvY3MiLCJnZXQiLCJpc051bGxPclVuZGVmaW5lZCIsInJlc3VsdHMiLCJtYXAiLCJzZXQiLCJjb2xsZWN0RGlzdGluY3REb2NzIiwic29ydCIsImEiLCJiIiwiY29tcGFyZURvY3MiLCJzb3VyY2UiLCJkaXN0aW5jdERvY3MiLCJkaXN0aW5jdEtleXMiLCJTZXQiLCJkb2MiLCJfa2V5IiwicHVzaCIsImhhcyIsImFkZCIsImkiLCJmaWVsZCIsInBhdGgiLCJzcGxpdCIsImFWYWx1ZSIsImdldFZhbHVlIiwiYlZhbHVlIiwiY29tcGFyaXNvbiIsImNvbXBhcmVWYWx1ZXMiLCJkaXJlY3Rpb24iLCJ2YWx1ZSIsInBhdGhJbmRleCIsImFIYXNWYWx1ZSIsImJIYXNWYWx1ZSIsInYiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7QUFtQk8sTUFBTUEsV0FBTixDQUFrQjtBQU9yQkMsRUFBQUEsV0FBVyxDQUFDQyxPQUFELEVBQThCO0FBQ3JDLFNBQUtDLEdBQUwsR0FBV0QsT0FBTyxDQUFDQyxHQUFuQjtBQUNBLFNBQUtDLEdBQUwsR0FBV0YsT0FBTyxDQUFDRSxHQUFuQjtBQUNBLFNBQUtDLElBQUwsR0FBWUgsT0FBTyxDQUFDRyxJQUFwQjtBQUNBLFNBQUtDLEtBQUwsR0FBYUosT0FBTyxDQUFDSSxLQUFyQjtBQUNIOztBQUdEQyxFQUFBQSxL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Q0FBQzRCLEtBQUQsQ0FBakIsSUFBNEJDLFNBQVMsSUFBSVQsSUFBSSxDQUFDMUIsTUFBbEQsRUFBMEQ7QUFDdEQsV0FBT2tDLEtBQVA7QUFDSDs7QUFDRCxTQUFPTCxRQUFRLENBQUNLLEtBQUssQ0FBQ1IsSUFBSSxDQUFDUyxTQUFELENBQUwsQ0FBTixFQUF5QlQsSUFBekIsRUFBK0JTLFNBQVMsR0FBRyxDQUEzQyxDQUFmO0FBQ0g7O0FBR0QsU0FBU0gsYUFBVCxDQUF1QnBCLENBQXZCLEVBQStCQyxDQUEvQixFQUErQztBQUMzQyxRQUFNdUIsU0FBUyxHQUFHLENBQUM5QixpQkFBaUIsQ0FBQ00sQ0FBRCxDQUFwQztBQUNBLFFBQU15QixTQUFTLEdBQUcsQ0FBQy9CLGlCQUFpQixDQUFDTyxDQUFELENBQXBDOztBQUNBLE1BQUksQ0FBQ3VCLFNBQUwsRUFBZ0I7QUFDWixXQUFPQyxTQUFTLEdBQUcsQ0FBQyxDQUFKLEdBQVEsQ0FBeEI7QUFDSDs7QUFDRCxNQUFJLENBQUNBLFNBQUwsRUFBZ0I7QUFDWixXQUFPLENBQVA7QUFDSDs7QUFDRCxTQUFPekIsQ0FBQyxLQUFLQyxDQUFOLEdBQVUsQ0FBVixHQUFlRCxDQUFDLEdBQUdDLENBQUosR0FBUSxDQUFDLENBQVQsR0FBYSxDQUFuQztBQUNIOztBQUdELFNBQVNQLGlCQUFULENBQTJCZ0MsQ0FBM0IsRUFBbUM7QUFDL0IsU0FBT0EsQ0FBQyxLQUFLLElBQU4sSUFBYyxPQUFPQSxDQUFQLEtBQWEsV0FBbEM7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5pbXBvcnQgdHlwZSB7IE9yZGVyQnkgfSBmcm9tICcuLi9maWx0ZXIvZmlsdGVycyc7XG5pbXBvcnQgeyBkYXRhU2VnbWVudCB9IGZyb20gJy4vZGF0YSc7XG5pbXBvcnQgdHlwZSB7IFFEYXRhUHJvdmlkZXIsIFFEYXRhQ2FjaGUsIFFEb2MsIFFEYXRhU2VnbWVudCB9IGZyb20gJy4vZGF0YSc7XG5cbmV4cG9ydCB0eXBlIFFEYXRhUXVlcnlQYXJhbXMgPSB7XG4gICAgc2VnbWVudDogUURhdGFTZWdtZW50O1xuICAgIHRleHQ6IHN0cmluZztcbiAgICB2YXJzOiB7IFtzdHJpbmddOiBhbnkgfTtcbiAgICBvcmRlckJ5OiBPcmRlckJ5W107XG59XG5cblxuZXhwb3J0IHR5cGUgUURhdGFCcm9rZXJPcHRpb25zID0ge1xuICAgIG11dDogUURhdGFQcm92aWRlcjtcbiAgICBob3Q6IFFEYXRhUHJvdmlkZXI7XG4gICAgY29sZDogUURhdGFQcm92aWRlcltdO1xuICAgIGNhY2hlOiBRRGF0YUNhY2hlO1xufVxuXG5cbmV4cG9ydCBjbGFzcyBRRGF0YUJyb2tlciB7XG4gICAgbXV0OiBRRGF0YVByb3ZpZGVyO1xuICAgIGhvdDogUURhdGFQcm92aWRlcjtcbiAgICBjb2xkOiBRRGF0YVByb3ZpZGVyW107XG4gICAgY2FjaGU6IFFEYXRhQ2FjaGU7XG5cblxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IFFEYXRhQnJva2VyT3B0aW9ucykge1xuICAgICAgICB0aGlzLm11dCA9IG9wdGlvbnMubXV0O1xuICAgICAgICB0aGlzLmhvdCA9IG9wdGlvbnMuaG90O1xuICAgICAgICB0aGlzLmNvbGQgPSBvcHRpb25zLmNvbGQ7XG4gICAgICAgIHRoaXMuY2FjaGUgPSBvcHRpb25zLmNhY2hlO1xuICAgIH1cblxuXG4gICAgc3RhcnQoKSB7XG4gICAgICAgIHRoaXMubXV0LnN0YXJ0KCk7XG4gICAgICAgIHRoaXMuaG90LnN0YXJ0KCk7XG4gICAgICAgIHRoaXMuY29sZC5mb3JFYWNoKHggPT4geC5zdGFydCgpKTtcbiAgICB9XG5cbiAgICBhc3luYyBxdWVyeShwYXJhbXM6IFFEYXRhUXVlcnlQYXJhbXMpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBpZiAocGFyYW1zLnNlZ21lbnQgPT09IGRhdGFTZWdtZW50Lk1VVEFCTEUpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm11dC5xdWVyeShwYXJhbXMudGV4dCwgcGFyYW1zLnZhcnMpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjb21iaW5lUmVzdWx0cyhhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICB0aGlzLmhvdC5xdWVyeShwYXJhbXMudGV4dCwgcGFyYW1zLnZhcnMpLFxuICAgICAgICAgICAgdGhpcy5xdWVyeUNvbGQocGFyYW1zKSxcbiAgICAgICAgXSksIHBhcmFtcy5vcmRlckJ5KTtcbiAgICB9XG5cblxuICAgIGFzeW5jIHF1ZXJ5Q29sZChwYXJhbXM6IFFEYXRhUXVlcnlQYXJhbXMpOiBQcm9taXNlPFFEb2NbXT4ge1xuICAgICAgICBpZiAodGhpcy5jb2xkLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGtleSA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIHRleHQ6IHBhcmFtcy50ZXh0LFxuICAgICAgICAgICAgdmFyczogcGFyYW1zLnZhcnMsXG4gICAgICAgICAgICBvcmRlckJ5OiBwYXJhbXMub3JkZXJCeSxcbiAgICAgICAgfSk7XG4gICAgICAgIGxldCBkb2NzID0gYXdhaXQgdGhpcy5jYWNoZS5nZXQoa2V5KTtcbiAgICAgICAgaWYgKGlzTnVsbE9yVW5kZWZpbmVkKGRvY3MpKSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwodGhpcy5jb2xkLm1hcCh4ID0+IHgucXVlcnkocGFyYW1zLnRleHQsIHBhcmFtcy52YXJzKSkpO1xuICAgICAgICAgICAgZG9jcyA9IGNvbWJpbmVSZXN1bHRzKHJlc3VsdHMsIHBhcmFtcy5vcmRlckJ5KTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY2FjaGUuc2V0KGtleSwgZG9jcyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGRvY3M7XG4gICAgfVxufVxuXG5cbmZ1bmN0aW9uIGNvbWJpbmVSZXN1bHRzKHJlc3VsdHM6IGFueVtdW10sIG9yZGVyQnk6IE9yZGVyQnlbXSk6IGFueVtdIHtcbiAgICBjb25zdCBkb2NzID0gY29sbGVjdERpc3RpbmN0RG9jcyhyZXN1bHRzKTtcbiAgICBpZiAob3JkZXJCeS5sZW5ndGggPiAwKSB7XG4gICAgICAgIGRvY3Muc29ydCgoYTogUURvYywgYjogUURvYykgPT4gY29tcGFyZURvY3MoYSwgYiwgb3JkZXJCeSkpO1xuICAgIH1cbiAgICByZXR1cm4gZG9jcztcbn1cblxuXG5mdW5jdGlvbiBjb2xsZWN0RGlzdGluY3REb2NzKHNvdXJjZTogUURvY1tdW10pOiBRRG9jW10ge1xuICAgIGNvbnN0IGRpc3RpbmN0RG9jcyA9IChbXTogUURvY1tdKTtcbiAgICBjb25zdCBkaXN0aW5jdEtleXMgPSBuZXcgU2V0KCk7XG4gICAgc291cmNlLmZvckVhY2goKGRvY3MpID0+IHtcbiAgICAgICAgZG9jcy5mb3JFYWNoKChkb2MpID0+IHtcbiAgICAgICAgICAgIGlmICghZG9jLl9rZXkpIHtcbiAgICAgICAgICAgICAgICBkaXN0aW5jdERvY3MucHVzaChkb2MpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICghZGlzdGluY3RLZXlzLmhhcyhkb2MuX2tleSkpIHtcbiAgICAgICAgICAgICAgICBkaXN0aW5jdERvY3MucHVzaChkb2MpO1xuICAgICAgICAgICAgICAgIGRpc3RpbmN0S2V5cy5hZGQoZG9jLl9rZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gZGlzdGluY3REb2NzO1xufVxuXG5cbmZ1bmN0aW9uIGNvbXBhcmVEb2NzKGE6IFFEb2MsIGI6IFFEb2MsIG9yZGVyQnk6IE9yZGVyQnlbXSkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3JkZXJCeS5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICBjb25zdCBmaWVsZCA9IG9yZGVyQnlbaV07XG4gICAgICAgIGNvbnN0IHBhdGggPSBmaWVsZC5wYXRoLnNwbGl0KCcuJyk7XG4gICAgICAgIGNvbnN0IGFWYWx1ZSA9IGdldFZhbHVlKGEsIHBhdGgsIDApO1xuICAgICAgICBjb25zdCBiVmFsdWUgPSBnZXRWYWx1ZShhLCBwYXRoLCAwKTtcbiAgICAgICAgbGV0IGNvbXBhcmlzb24gPSBjb21wYXJlVmFsdWVzKGFWYWx1ZSwgYlZhbHVlKTtcbiAgICAgICAgaWYgKGNvbXBhcmlzb24gIT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBmaWVsZC5kaXJlY3Rpb24gPT09ICdERVNDJyA/IC1jb21wYXJpc29uIDogY29tcGFyaXNvbjtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gMDtcbn1cblxuXG5mdW5jdGlvbiBnZXRWYWx1ZSh2YWx1ZTogYW55LCBwYXRoOiBzdHJpbmdbXSwgcGF0aEluZGV4OiBudW1iZXIpOiBhbnkge1xuICAgIGlmIChpc051bGxPclVuZGVmaW5lZCh2YWx1ZSkgfHwgcGF0aEluZGV4ID49IHBhdGgubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGdldFZhbHVlKHZhbHVlW3BhdGhbcGF0aEluZGV4XV0sIHBhdGgsIHBhdGhJbmRleCArIDEpO1xufVxuXG5cbmZ1bmN0aW9uIGNvbXBhcmVWYWx1ZXMoYTogYW55LCBiOiBhbnkpOiBudW1iZXIge1xuICAgIGNvbnN0IGFIYXNWYWx1ZSA9ICFpc051bGxPclVuZGVmaW5lZChhKTtcbiAgICBjb25zdCBiSGFzVmFsdWUgPSAhaXNOdWxsT3JVbmRlZmluZWQoYik7XG4gICAgaWYgKCFhSGFzVmFsdWUpIHtcbiAgICAgICAgcmV0dXJuIGJIYXNWYWx1ZSA/IC0xIDogMDtcbiAgICB9XG4gICAgaWYgKCFiSGFzVmFsdWUpIHtcbiAgICAgICAgcmV0dXJuIDE7XG4gICAgfVxuICAgIHJldHVybiBhID09PSBiID8gMCA6IChhIDwgYiA/IC0xIDogMCk7XG59XG5cblxuZnVuY3Rpb24gaXNOdWxsT3JVbmRlZmluZWQodjogYW55KSB7XG4gICAgcmV0dXJuIHYgPT09IG51bGwgfHwgdHlwZW9mIHYgPT09ICd1bmRlZmluZWQnO1xufVxuIl19