"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ArangoProvider = void 0;

var _arangochair = _interopRequireDefault(require("arangochair"));

var _arangojs = require("arangojs");

var _events = _interopRequireDefault(require("events"));

var _config = require("../config");

var _url = _interopRequireDefault(require("url"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class ArangoProvider {
  constructor(log, config) {
    this.log = log;
    this.config = config;
    this.started = false;
    this.arango = new _arangojs.Database({
      url: `${(0, _config.ensureProtocol)(config.server, 'http')}`,
      agentOptions: {
        maxSockets: config.maxSockets
      }
    });
    this.arango.useDatabase(config.name);

    if (config.auth) {
      const authParts = config.auth.split(':');
      this.arango.useBasicAuth(authParts[0], authParts.slice(1).join(':'));
    }

    this.collectionsForSubscribe = [];
    this.listener = null;
    this.listenerSubscribers = new _events.default();
    this.listenerSubscribers.setMaxListeners(0);
    this.listenerSubscribersCount = 0;
  }

  async start(collectionsForSubscribe) {
    this.started = true;
    this.collectionsForSubscribe = collectionsForSubscribe;
    this.checkStartListener();
    return Promise.resolve();
  }

  getCollectionIndexes(collection) {
    return this.arango.collection(collection).indexes();
  }

  async loadFingerprint() {
    /**
     * Returns object with collection names in keys and collection size in values.
     */
    const collections = (await this.arango.listCollections()).map(descr => descr.name); // TODO: add this when required a new version arangojs v7.x.x
    // await Promise.all(collections.map(col => this.arango.collection(col).recalculateCount()));

    const results = await Promise.all(collections.map(col => this.arango.collection(col).count()));
    return Object.fromEntries(collections.map((_, i) => [collections[i], results[i].count]));
  }

  async hotUpdate() {
    return Promise.resolve();
  }

  async query(text, vars) {
    const cursor = await this.arango.query(text, vars);
    return cursor.all();
  }

  async subscribe(collection, listener) {
    var _this$listenerSubscri;

    (_this$listenerSubscri = this.listenerSubscribers) === null || _this$listenerSubscri === void 0 ? void 0 : _this$listenerSubscri.on(collection, listener);
    this.listenerSubscribersCount += 1;
    this.checkStartListener();
    return {
      collection,
      listener
    };
  }

  unsubscribe(subscription) {
    var _this$listenerSubscri2;

    (_this$listenerSubscri2 = this.listenerSubscribers) === null || _this$listenerSubscri2 === void 0 ? void 0 : _this$listenerSubscri2.removeListener(subscription.collection, subscription.listener);
    this.listenerSubscribersCount = Math.max(this.listenerSubscribersCount - 1, 0);
  } // Internals


  checkStartListener() {
    if (!this.started) {
      return;
    }

    if (this.listener) {
      return;
    }

    if (this.collectionsForSubscribe.length === 0) {
      return;
    }

    if (this.listenerSubscribersCount === 0) {
      return;
    }

    this.listener = this.createAndStartListener();
  }

  createAndStartListener() {
    const {
      server,
      name,
      auth
    } = this.config;
    const dbUrl = (0, _config.ensureProtocol)(server, 'http');
    const listenerUrl = `${dbUrl}/${name}`;
    const listener = new _arangochair.default(listenerUrl);

    const parsedDbUrl = _url.default.parse(dbUrl);

    const pathPrefix = parsedDbUrl.path !== "/" ? parsedDbUrl.path || "" : "";
    listener._loggerStatePath = `${pathPrefix}/_db/${name}/_api/replication/logger-state`;
    listener._loggerFollowPath = `${pathPrefix}/_db/${name}/_api/replication/logger-follow`;

    if (this.config.auth) {
      const userPassword = Buffer.from(auth).toString('base64');
      listener.req.opts.headers['Authorization'] = `Basic ${userPassword}`;
    }

    this.collectionsForSubscribe.forEach(collectionName => {
      listener.subscribe({
        collection: collectionName
      });
      listener.on(collectionName, (docJson, type) => {
        if (type === 'insert/update' || type === 'insert' || type === 'update') {
          this.onDataEvent(type, collectionName, docJson);
        }
      });
    });
    listener.on('error', (err, status, headers, body) => {
      let error = err;

      try {
        error = JSON.parse(body);
      } catch {}

      this.log.error('FAILED', 'LISTEN', `${err}`, error);
      setTimeout(() => listener.start(), this.config.listenerRestartTimeout || 1000);
    });
    listener.start();
    return listener;
  }

  onDataEvent(event, collection, doc) {
    var _this$listenerSubscri3;

    (_this$listenerSubscri3 = this.listenerSubscribers) === null || _this$listenerSubscri3 === void 0 ? void 0 : _this$listenerSubscri3.emit(collection, doc, event);
  }

}

exports.ArangoProvider = ArangoProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9hcmFuZ28tcHJvdmlkZXIuanMiXSwibmFtZXMiOlsiQXJhbmdvUHJvdmlkZXIiLCJjb25zdHJ1Y3RvciIsImxvZyIsImNvbmZpZyIsInN0YXJ0ZWQiLCJhcmFuZ28iLCJEYXRhYmFzZSIsInVybCIsInNlcnZlciIsImFnZW50T3B0aW9ucyIsIm1heFNvY2tldHMiLCJ1c2VEYXRhYmFzZSIsIm5hbWUiLCJhdXRoIiwiYXV0aFBhcnRzIiwic3BsaXQiLCJ1c2VCYXNpY0F1dGgiLCJzbGljZSIsImpvaW4iLCJjb2xsZWN0aW9uc0ZvclN1YnNjcmliZSIsImxpc3RlbmVyIiwibGlzdGVuZXJTdWJzY3JpYmVycyIsIkV2ZW50RW1pdHRlciIsInNldE1heExpc3RlbmVycyIsImxpc3RlbmVyU3Vic2NyaWJlcnNDb3VudCIsInN0YXJ0IiwiY2hlY2tTdGFydExpc3RlbmVyIiwiUHJvbWlzZSIsInJlc29sdmUiLCJnZXRDb2xsZWN0aW9uSW5kZXhlcyIsImNvbGxlY3Rpb24iLCJpbmRleGVzIiwibG9hZEZpbmdlcnByaW50IiwiY29sbGVjdGlvbnMiLCJsaXN0Q29sbGVjdGlvbnMiLCJtYXAiLCJkZXNjciIsInJlc3VsdHMiLCJhbGwiLCJjb2wiLCJjb3VudCIsIk9iamVjdCIsImZyb21FbnRyaWVzIiwiXyIsImkiLCJob3RVcGRhdGUiLCJxdWVyeSIsInRleHQiLCJ2YXJzIiwiY3Vyc29yIiwic3Vic2NyaWJlIiwib24iLCJ1bnN1YnNjcmliZSIsInN1YnNjcmlwdGlvbiIsInJlbW92ZUxpc3RlbmVyIiwiTWF0aCIsIm1heCIsImxlbmd0aCIsImNyZWF0ZUFuZFN0YXJ0TGlzdGVuZXIiLCJkYlVybCIsImxpc3RlbmVyVXJsIiwiYXJhbmdvY2hhaXIiLCJwYXJzZWREYlVybCIsInBhcnNlIiwicGF0aFByZWZpeCIsInBhdGgiLCJfbG9nZ2VyU3RhdGVQYXRoIiwiX2xvZ2dlckZvbGxvd1BhdGgiLCJ1c2VyUGFzc3dvcmQiLCJCdWZmZXIiLCJmcm9tIiwidG9TdHJpbmciLCJyZXEiLCJvcHRzIiwiaGVhZGVycyIsImZvckVhY2giLCJjb2xsZWN0aW9uTmFtZSIsImRvY0pzb24iLCJ0eXBlIiwib25EYXRhRXZlbnQiLCJlcnIiLCJzdGF0dXMiLCJib2R5IiwiZXJyb3IiLCJKU09OIiwic2V0VGltZW91dCIsImxpc3RlbmVyUmVzdGFydFRpbWVvdXQiLCJldmVudCIsImRvYyIsImVtaXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFJQTs7OztBQWtCTyxNQUFNQSxjQUFOLENBQThDO0FBWWpEQyxFQUFBQSxXQUFXLENBQUNDLEdBQUQsRUFBWUMsTUFBWixFQUFtQztBQUMxQyxTQUFLRCxHQUFMLEdBQVdBLEdBQVg7QUFDQSxTQUFLQyxNQUFMLEdBQWNBLE1BQWQ7QUFFQSxTQUFLQyxPQUFMLEdBQWUsS0FBZjtBQUNBLFNBQUtDLE1BQUwsR0FBYyxJQUFJQyxrQkFBSixDQUFhO0FBQ3ZCQyxNQUFBQSxHQUFHLEVBQUcsR0FBRSw0QkFBZUosTUFBTSxDQUFDSyxNQUF0QixFQUE4QixNQUE5QixDQUFzQyxFQUR2QjtBQUV2QkMsTUFBQUEsWUFBWSxFQUFFO0FBQ1ZDLFFBQUFBLFVBQVUsRUFBRVAsTUFBTSxDQUFDTztBQURUO0FBRlMsS0FBYixDQUFkO0FBTUEsU0FBS0wsTUFBTCxDQUFZTSxXQUFaLENBQXdCUixNQUFNLENBQUNTLElBQS9COztBQUNBLFFBQUlULE1BQU0sQ0FBQ1UsSUFBWCxFQUFpQjtBQUNiLFlBQU1DLFNBQVMsR0FBR1gsTUFBTSxDQUFDVSxJQUFQLENBQVlFLEtBQVosQ0FBa0IsR0FBbEIsQ0FBbEI7QUFDQSxXQUFLVixNQUFMLENBQVlXLFlBQVosQ0FBeUJGLFNBQVMsQ0FBQyxDQUFELENBQWxDLEVBQXVDQSxTQUFTLENBQUNHLEtBQVYsQ0FBZ0IsQ0FBaEIsRUFBbUJDLElBQW5CLENBQXdCLEdBQXhCLENBQXZDO0FBQ0g7O0FBQ0QsU0FBS0MsdUJBQUwsR0FBK0Is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Iiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcbmltcG9ydCBhcmFuZ29jaGFpciBmcm9tICdhcmFuZ29jaGFpcic7XG5pbXBvcnQgeyBEYXRhYmFzZSB9IGZyb20gJ2FyYW5nb2pzJztcbmltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IGVuc3VyZVByb3RvY29sIH0gZnJvbSAnLi4vY29uZmlnJztcbmltcG9ydCB0eXBlIHsgUUFyYW5nb0NvbmZpZyB9IGZyb20gJy4uL2NvbmZpZyc7XG5pbXBvcnQgdHlwZSB7IFFMb2cgfSBmcm9tICcuLi9sb2dzJztcbmltcG9ydCB0eXBlIHsgUURhdGFFdmVudCwgUURhdGFQcm92aWRlciwgUURvYywgUUluZGV4SW5mbyB9IGZyb20gJy4vZGF0YS1wcm92aWRlcic7XG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5cbnR5cGUgQXJhbmdvRXZlbnRIYW5kbGVyID0gKGVycjogYW55LCBzdGF0dXM6IHN0cmluZywgaGVhZGVyczogeyBbc3RyaW5nXTogYW55IH0sIGJvZHk6IHN0cmluZykgPT4gdm9pZDtcblxuaW50ZXJmYWNlIEFyYW5nb0xpc3RlbmVyIHtcbiAgICByZXE6IHtcbiAgICAgICAgb3B0czoge1xuICAgICAgICAgICAgaGVhZGVyczogeyBbc3RyaW5nXTogYW55IH0sXG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgb24oZXZlbnQ6IHN0cmluZywgaGFuZGxlcjogQXJhbmdvRXZlbnRIYW5kbGVyKTogdm9pZDtcblxuICAgIHN1YnNjcmliZShwYXJhbXM6IHsgY29sbGVjdGlvbjogc3RyaW5nIH0pOiB2b2lkO1xuXG4gICAgc3RhcnQoKTogdm9pZDtcbn1cblxuZXhwb3J0IGNsYXNzIEFyYW5nb1Byb3ZpZGVyIGltcGxlbWVudHMgUURhdGFQcm92aWRlciB7XG4gICAgbG9nOiBRTG9nO1xuICAgIGNvbmZpZzogUUFyYW5nb0NvbmZpZztcblxuICAgIHN0YXJ0ZWQ6IGJvb2xlYW47XG4gICAgYXJhbmdvOiBEYXRhYmFzZTtcbiAgICBjb2xsZWN0aW9uc0ZvclN1YnNjcmliZTogc3RyaW5nW107XG4gICAgbGlzdGVuZXI6ID9BcmFuZ29MaXN0ZW5lcjtcbiAgICBsaXN0ZW5lclN1YnNjcmliZXJzOiBFdmVudEVtaXR0ZXI7XG4gICAgbGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50OiBudW1iZXI7XG5cblxuICAgIGNvbnN0cnVjdG9yKGxvZzogUUxvZywgY29uZmlnOiBRQXJhbmdvQ29uZmlnKSB7XG4gICAgICAgIHRoaXMubG9nID0gbG9nO1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcblxuICAgICAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5hcmFuZ28gPSBuZXcgRGF0YWJhc2Uoe1xuICAgICAgICAgICAgdXJsOiBgJHtlbnN1cmVQcm90b2NvbChjb25maWcuc2VydmVyLCAnaHR0cCcpfWAsXG4gICAgICAgICAgICBhZ2VudE9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgICBtYXhTb2NrZXRzOiBjb25maWcubWF4U29ja2V0cyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmFyYW5nby51c2VEYXRhYmFzZShjb25maWcubmFtZSk7XG4gICAgICAgIGlmIChjb25maWcuYXV0aCkge1xuICAgICAgICAgICAgY29uc3QgYXV0aFBhcnRzID0gY29uZmlnLmF1dGguc3BsaXQoJzonKTtcbiAgICAgICAgICAgIHRoaXMuYXJhbmdvLnVzZUJhc2ljQXV0aChhdXRoUGFydHNbMF0sIGF1dGhQYXJ0cy5zbGljZSgxKS5qb2luKCc6JykpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnNGb3JTdWJzY3JpYmUgPSBbXTtcbiAgICAgICAgdGhpcy5saXN0ZW5lciA9IG51bGw7XG4gICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVycyA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzLnNldE1heExpc3RlbmVycygwKTtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzQ291bnQgPSAwO1xuICAgIH1cblxuICAgIGFzeW5jIHN0YXJ0KGNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlOiBzdHJpbmdbXSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHRoaXMuc3RhcnRlZCA9IHRydWU7XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnNGb3JTdWJzY3JpYmUgPSBjb2xsZWN0aW9uc0ZvclN1YnNjcmliZTtcbiAgICAgICAgdGhpcy5jaGVja1N0YXJ0TGlzdGVuZXIoKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH1cblxuICAgIGdldENvbGxlY3Rpb25JbmRleGVzKGNvbGxlY3Rpb246IHN0cmluZyk6IFByb21pc2U8UUluZGV4SW5mb1tdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFyYW5nby5jb2xsZWN0aW9uKGNvbGxlY3Rpb24pLmluZGV4ZXMoKTtcbiAgICB9XG5cbiAgICBhc3luYyBsb2FkRmluZ2VycHJpbnQoKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJldHVybnMgb2JqZWN0IHdpdGggY29sbGVjdGlvbiBuYW1lcyBpbiBrZXlzIGFuZCBjb2xsZWN0aW9uIHNpemUgaW4gdmFsdWVzLlxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3QgY29sbGVjdGlvbnMgPSAoYXdhaXQgdGhpcy5hcmFuZ28ubGlzdENvbGxlY3Rpb25zKCkpLm1hcChkZXNjciA9PiBkZXNjci5uYW1lKTtcbiAgICAgICAgLy8gVE9ETzogYWRkIHRoaXMgd2hlbiByZXF1aXJlZCBhIG5ldyB2ZXJzaW9uIGFyYW5nb2pzIHY3LngueFxuICAgICAgICAvLyBhd2FpdCBQcm9taXNlLmFsbChjb2xsZWN0aW9ucy5tYXAoY29sID0+IHRoaXMuYXJhbmdvLmNvbGxlY3Rpb24oY29sKS5yZWNhbGN1bGF0ZUNvdW50KCkpKTtcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IFByb21pc2UuYWxsKGNvbGxlY3Rpb25zLm1hcChjb2wgPT4gdGhpcy5hcmFuZ28uY29sbGVjdGlvbihjb2wpLmNvdW50KCkpKVxuICAgICAgICByZXR1cm4gT2JqZWN0LmZyb21FbnRyaWVzKGNvbGxlY3Rpb25zLm1hcCgoXywgaSkgPT4gW2NvbGxlY3Rpb25zW2ldLCByZXN1bHRzW2ldLmNvdW50XSkpO1xuICAgIH1cblxuICAgIGFzeW5jIGhvdFVwZGF0ZSgpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgcXVlcnkodGV4dDogc3RyaW5nLCB2YXJzOiB7IFtzdHJpbmddOiBhbnkgfSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IGN1cnNvciA9IGF3YWl0IHRoaXMuYXJhbmdvLnF1ZXJ5KHRleHQsIHZhcnMpO1xuICAgICAgICByZXR1cm4gY3Vyc29yLmFsbCgpO1xuICAgIH1cblxuICAgIGFzeW5jIHN1YnNjcmliZShjb2xsZWN0aW9uOiBzdHJpbmcsIGxpc3RlbmVyOiAoZG9jOiBhbnksIGV2ZW50OiBRRGF0YUV2ZW50KSA9PiB2b2lkKTogYW55IHtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzPy5vbihjb2xsZWN0aW9uLCBsaXN0ZW5lcik7XG4gICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50ICs9IDE7XG4gICAgICAgIHRoaXMuY2hlY2tTdGFydExpc3RlbmVyKCk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjb2xsZWN0aW9uLFxuICAgICAgICAgICAgbGlzdGVuZXIsXG4gICAgICAgIH07XG4gICAgfVxuXG5cbiAgICB1bnN1YnNjcmliZShzdWJzY3JpcHRpb246IGFueSkge1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnM/LnJlbW92ZUxpc3RlbmVyKHN1YnNjcmlwdGlvbi5jb2xsZWN0aW9uLCBzdWJzY3JpcHRpb24ubGlzdGVuZXIpO1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnNDb3VudCA9IE1hdGgubWF4KHRoaXMubGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50IC0gMSwgMCk7XG4gICAgfVxuXG4gICAgLy8gSW50ZXJuYWxzXG5cbiAgICBjaGVja1N0YXJ0TGlzdGVuZXIoKSB7XG4gICAgICAgIGlmICghdGhpcy5zdGFydGVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubGlzdGVuZXIpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5jb2xsZWN0aW9uc0ZvclN1YnNjcmliZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5saXN0ZW5lclN1YnNjcmliZXJzQ291bnQgPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmxpc3RlbmVyID0gdGhpcy5jcmVhdGVBbmRTdGFydExpc3RlbmVyKCk7XG4gICAgfVxuXG4gICAgY3JlYXRlQW5kU3RhcnRMaXN0ZW5lcigpOiBBcmFuZ29MaXN0ZW5lciB7XG4gICAgICAgIGNvbnN0IHsgc2VydmVyLCBuYW1lLCBhdXRoIH0gPSB0aGlzLmNvbmZpZztcbiAgICAgICAgY29uc3QgZGJVcmwgPSBlbnN1cmVQcm90b2NvbChzZXJ2ZXIsICdodHRwJyk7XG4gICAgICAgIGNvbnN0IGxpc3RlbmVyVXJsID0gYCR7ZGJVcmx9LyR7bmFtZX1gO1xuXG4gICAgICAgIGNvbnN0IGxpc3RlbmVyID0gbmV3IGFyYW5nb2NoYWlyKGxpc3RlbmVyVXJsKTtcbiAgICAgICAgY29uc3QgcGFyc2VkRGJVcmwgPSB1cmwucGFyc2UoZGJVcmwpO1xuXG4gICAgICAgIGNvbnN0IHBhdGhQcmVmaXggPSBwYXJzZWREYlVybC5wYXRoICE9PSBcIi9cIiA/IChwYXJzZWREYlVybC5wYXRoIHx8IFwiXCIpIDogXCJcIjtcbiAgICAgICAgbGlzdGVuZXIuX2xvZ2dlclN0YXRlUGF0aCA9IGAke3BhdGhQcmVmaXh9L19kYi8ke25hbWV9L19hcGkvcmVwbGljYXRpb24vbG9nZ2VyLXN0YXRlYDtcbiAgICAgICAgbGlzdGVuZXIuX2xvZ2dlckZvbGxvd1BhdGggPSBgJHtwYXRoUHJlZml4fS9fZGIvJHtuYW1lfS9fYXBpL3JlcGxpY2F0aW9uL2xvZ2dlci1mb2xsb3dgO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5hdXRoKSB7XG4gICAgICAgICAgICBjb25zdCB1c2VyUGFzc3dvcmQgPSBCdWZmZXIuZnJvbShhdXRoKS50b1N0cmluZygnYmFzZTY0Jyk7XG4gICAgICAgICAgICBsaXN0ZW5lci5yZXEub3B0cy5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10gPSBgQmFzaWMgJHt1c2VyUGFzc3dvcmR9YDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnNGb3JTdWJzY3JpYmUuZm9yRWFjaCgoY29sbGVjdGlvbk5hbWUpID0+IHtcbiAgICAgICAgICAgIGxpc3RlbmVyLnN1YnNjcmliZSh7IGNvbGxlY3Rpb246IGNvbGxlY3Rpb25OYW1lIH0pO1xuICAgICAgICAgICAgbGlzdGVuZXIub24oY29sbGVjdGlvbk5hbWUsIChkb2NKc29uLCB0eXBlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdpbnNlcnQvdXBkYXRlJyB8fCB0eXBlID09PSAnaW5zZXJ0JyB8fCB0eXBlID09PSAndXBkYXRlJykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uRGF0YUV2ZW50KHR5cGUsIGNvbGxlY3Rpb25OYW1lLCBkb2NKc29uKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSlcblxuICAgICAgICBsaXN0ZW5lci5vbignZXJyb3InLCAoZXJyLCBzdGF0dXMsIGhlYWRlcnMsIGJvZHkpID0+IHtcbiAgICAgICAgICAgIGxldCBlcnJvciA9IGVycjtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgZXJyb3IgPSBKU09OLnBhcnNlKGJvZHkpO1xuICAgICAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignRkFJTEVEJywgJ0xJU1RFTicsIGAke2Vycn1gLCBlcnJvcik7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGxpc3RlbmVyLnN0YXJ0KCksIHRoaXMuY29uZmlnLmxpc3RlbmVyUmVzdGFydFRpbWVvdXQgfHwgMTAwMCk7XG4gICAgICAgIH0pO1xuICAgICAgICBsaXN0ZW5lci5zdGFydCgpO1xuICAgICAgICByZXR1cm4gbGlzdGVuZXI7XG4gICAgfVxuXG4gICAgb25EYXRhRXZlbnQoZXZlbnQ6IFFEYXRhRXZlbnQsIGNvbGxlY3Rpb246IHN0cmluZywgZG9jOiBRRG9jKSB7XG4gICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVycz8uZW1pdChjb2xsZWN0aW9uLCBkb2MsIGV2ZW50KTtcbiAgICB9XG5cbn1cbiJdfQ==