"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ArangoProvider = void 0;

var _arangochair = _interopRequireDefault(require("arangochair"));

var _arangojs = require("arangojs");

var _events = _interopRequireDefault(require("events"));

var _config = require("../config");

var _url = _interopRequireDefault(require("url"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class ArangoProvider {
  constructor(log, config) {
    this.log = log;
    this.config = config;
    this.started = false;
    this.arango = new _arangojs.Database({
      url: `${(0, _config.ensureProtocol)(config.server, 'http')}`,
      agentOptions: {
        maxSockets: config.maxSockets
      }
    });
    this.arango.useDatabase(config.name);

    if (config.auth) {
      const authParts = config.auth.split(':');
      this.arango.useBasicAuth(authParts[0], authParts.slice(1).join(':'));
    }

    this.collectionsForSubscribe = [];
    this.listener = null;
    this.listenerSubscribers = new _events.default();
    this.listenerSubscribers.setMaxListeners(0);
    this.listenerSubscribersCount = 0;
  }

  async start(collectionsForSubscribe) {
    this.started = true;
    this.collectionsForSubscribe = collectionsForSubscribe;
    this.checkStartListener();
    return Promise.resolve();
  }

  getCollectionIndexes(collection) {
    return this.arango.collection(collection).indexes();
  }
  /**
   * Returns object with collection names in keys and collection size in values.
   */


  async loadFingerprint() {
    const collectionNames = (await this.arango.listCollections()).map(descr => descr.name); // TODO: add this when required a new version arangojs v7.x.x
    // await Promise.all(collections.map(col => this.arango.collection(col).recalculateCount()));

    const results = await Promise.all(collectionNames.map(col => this.arango.collection(col).count()));
    const fingerprint = {};
    collectionNames.forEach((collectionName, i) => {
      fingerprint[collectionName] = results[i].count;
    });
    return fingerprint;
  }

  async hotUpdate() {
    return Promise.resolve();
  }

  async query(text, vars) {
    const cursor = await this.arango.query(text, vars);
    return cursor.all();
  }

  async subscribe(collection, listener) {
    if (this.listenerSubscribers) {
      this.listenerSubscribers.on(collection, listener);
      this.listenerSubscribersCount += 1;
    }

    this.checkStartListener();
    return {
      collection,
      listener
    };
  }

  unsubscribe(subscription) {
    if (this.listenerSubscribers) {
      this.listenerSubscribers.removeListener(subscription.collection, subscription.listener);
      this.listenerSubscribersCount = Math.max(this.listenerSubscribersCount - 1, 0);
    }
  } // Internals


  checkStartListener() {
    if (!this.started) {
      return;
    }

    if (this.listener) {
      return;
    }

    if (this.collectionsForSubscribe.length === 0) {
      return;
    }

    if (this.listenerSubscribersCount === 0) {
      return;
    }

    this.listener = this.createAndStartListener();
  }

  createAndStartListener() {
    const {
      server,
      name,
      auth
    } = this.config;
    const dbUrl = (0, _config.ensureProtocol)(server, 'http');
    const listenerUrl = `${dbUrl}/${name}`;
    const listener = new _arangochair.default(listenerUrl);

    const parsedDbUrl = _url.default.parse(dbUrl);

    const pathPrefix = parsedDbUrl.path !== "/" ? parsedDbUrl.path || "" : "";
    listener._loggerStatePath = `${pathPrefix}/_db/${name}/_api/replication/logger-state`;
    listener._loggerFollowPath = `${pathPrefix}/_db/${name}/_api/replication/logger-follow`;

    if (this.config.auth) {
      const userPassword = Buffer.from(auth).toString('base64');
      listener.req.opts.headers['Authorization'] = `Basic ${userPassword}`;
    }

    this.collectionsForSubscribe.forEach(collectionName => {
      listener.subscribe({
        collection: collectionName
      });
      listener.on(collectionName, (docJson, type) => {
        if (type === 'insert/update' || type === 'insert' || type === 'update') {
          this.onDataEvent(type, collectionName, docJson);
        }
      });
    });
    listener.on('error', (err, status, headers, body) => {
      let error = err;

      try {
        error = JSON.parse(body);
      } catch {}

      this.log.error('FAILED', 'LISTEN', `${err}`, error);
      setTimeout(() => listener.start(), this.config.listenerRestartTimeout || 1000);
    });
    listener.start();
    return listener;
  }

  onDataEvent(event, collection, doc) {
    if (this.listenerSubscribers) {
      this.listenerSubscribers.emit(collection, doc, event);
    }
  }

}

exports.ArangoProvider = ArangoProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9hcmFuZ28tcHJvdmlkZXIuanMiXSwibmFtZXMiOlsiQXJhbmdvUHJvdmlkZXIiLCJjb25zdHJ1Y3RvciIsImxvZyIsImNvbmZpZyIsInN0YXJ0ZWQiLCJhcmFuZ28iLCJEYXRhYmFzZSIsInVybCIsInNlcnZlciIsImFnZW50T3B0aW9ucyIsIm1heFNvY2tldHMiLCJ1c2VEYXRhYmFzZSIsIm5hbWUiLCJhdXRoIiwiYXV0aFBhcnRzIiwic3BsaXQiLCJ1c2VCYXNpY0F1dGgiLCJzbGljZSIsImpvaW4iLCJjb2xsZWN0aW9uc0ZvclN1YnNjcmliZSIsImxpc3RlbmVyIiwibGlzdGVuZXJTdWJzY3JpYmVycyIsIkV2ZW50RW1pdHRlciIsInNldE1heExpc3RlbmVycyIsImxpc3RlbmVyU3Vic2NyaWJlcnNDb3VudCIsInN0YXJ0IiwiY2hlY2tTdGFydExpc3RlbmVyIiwiUHJvbWlzZSIsInJlc29sdmUiLCJnZXRDb2xsZWN0aW9uSW5kZXhlcyIsImNvbGxlY3Rpb24iLCJpbmRleGVzIiwibG9hZEZpbmdlcnByaW50IiwiY29sbGVjdGlvbk5hbWVzIiwibGlzdENvbGxlY3Rpb25zIiwibWFwIiwiZGVzY3IiLCJyZXN1bHRzIiwiYWxsIiwiY29sIiwiY291bnQiLCJmaW5nZXJwcmludCIsImZvckVhY2giLCJjb2xsZWN0aW9uTmFtZSIsImkiLCJob3RVcGRhdGUiLCJxdWVyeSIsInRleHQiLCJ2YXJzIiwiY3Vyc29yIiwic3Vic2NyaWJlIiwib24iLCJ1bnN1YnNjcmliZSIsInN1YnNjcmlwdGlvbiIsInJlbW92ZUxpc3RlbmVyIiwiTWF0aCIsIm1heCIsImxlbmd0aCIsImNyZWF0ZUFuZFN0YXJ0TGlzdGVuZXIiLCJkYlVybCIsImxpc3RlbmVyVXJsIiwiYXJhbmdvY2hhaXIiLCJwYXJzZWREYlVybCIsInBhcnNlIiwicGF0aFByZWZpeCIsInBhdGgiLCJfbG9nZ2VyU3RhdGVQYXRoIiwiX2xvZ2dlckZvbGxvd1BhdGgiLCJ1c2VyUGFzc3dvcmQiLCJCdWZmZXIiLCJmcm9tIiwidG9TdHJpbmciLCJyZXEiLCJvcHRzIiwiaGVhZGVycyIsImRvY0pzb24iLCJ0eXBlIiwib25EYXRhRXZlbnQiLCJlcnIiLCJzdGF0dXMiLCJib2R5IiwiZXJyb3IiLCJKU09OIiwic2V0VGltZW91dCIsImxpc3RlbmVyUmVzdGFydFRpbWVvdXQiLCJldmVudCIsImRvYyIsImVtaXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFJQTs7OztBQWtCTyxNQUFNQSxjQUFOLENBQThDO0FBWWpEQyxFQUFBQSxXQUFXLENBQUNDLEdBQUQsRUFBWUMsTUFBWixFQUFtQztBQUMxQyxTQUFLRCxHQUFMLEdBQVdBLEdBQVg7QUFDQSxTQUFLQyxNQUFMLEdBQWNBLE1BQWQ7QUFFQSxTQUFLQyxPQUFMLEdBQWUsS0FBZjtBQUNBLFNBQUtDLE1BQUwsR0FBYyxJQUFJQyxrQkFBSixDQUFhO0FBQ3ZCQyxNQUFBQSxHQUFHLEVBQUcsR0FBRSw0QkFBZUosTUFBTSxDQUFDSyxNQUF0QixFQUE4QixNQUE5QixDQUFzQyxFQUR2QjtBQUV2QkMsTUFBQUEsWUFBWSxFQUFFO0FBQ1ZDLFFBQUFBLFVBQVUsRUFBRVAsTUFBTSxDQUFDTztBQURUO0FBRlMsS0FBYixDQUFkO0FBTUEsU0FBS0wsTUFBTCxDQUFZTSxXQUFaLENBQXdCUixNQUFNLENBQUNTLElBQS9COztBQUNBLFFBQUlULE1BQU0sQ0FBQ1UsSUFBWCxFQUFpQjtBQUNiLFlBQU1DLFNBQVMsR0FBR1gsTUFBTSxDQUFDVSxJQUFQLENBQVlFLEtBQVosQ0FBa0IsR0FBbEIsQ0FBbEI7QUFDQSxXQUFLVixNQUFMLENBQVlXLFlBQVosQ0FBeUJGLFNBQVMsQ0FBQyxDQUFELENBQWxDLEVBQXVDQSxTQUFTLENBQUNHLEtBQVYsQ0FBZ0IsQ0FBaEIsRUFBbUJDLElBQW5CLENBQXdCLEdBQXhCLENBQXZDO0FBQ0g7O0FBQ0QsU0FBS0MsdUJBQUwsR0FBK0IsRUFBL0I7QUFD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QUtqRSxtQkFBVCxFQUE4QjtBQUMxQixXQUFLQSxtQkFBTCxDQUF5QmtFLElBQXpCLENBQThCekQsVUFBOUIsRUFBMEN3RCxHQUExQyxFQUErQ0QsS0FBL0M7QUFDSDtBQUNKOztBQXZKZ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuaW1wb3J0IGFyYW5nb2NoYWlyIGZyb20gJ2FyYW5nb2NoYWlyJztcbmltcG9ydCB7IERhdGFiYXNlIH0gZnJvbSAnYXJhbmdvanMnO1xuaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICdldmVudHMnO1xuaW1wb3J0IHsgZW5zdXJlUHJvdG9jb2wgfSBmcm9tICcuLi9jb25maWcnO1xuaW1wb3J0IHR5cGUgeyBRQXJhbmdvQ29uZmlnIH0gZnJvbSAnLi4vY29uZmlnJztcbmltcG9ydCB0eXBlIHsgUUxvZyB9IGZyb20gJy4uL2xvZ3MnO1xuaW1wb3J0IHR5cGUgeyBRRGF0YUV2ZW50LCBRRGF0YVByb3ZpZGVyLCBRRG9jLCBRSW5kZXhJbmZvIH0gZnJvbSAnLi9kYXRhLXByb3ZpZGVyJztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcblxudHlwZSBBcmFuZ29FdmVudEhhbmRsZXIgPSAoZXJyOiBhbnksIHN0YXR1czogc3RyaW5nLCBoZWFkZXJzOiB7IFtzdHJpbmddOiBhbnkgfSwgYm9keTogc3RyaW5nKSA9PiB2b2lkO1xuXG5pbnRlcmZhY2UgQXJhbmdvTGlzdGVuZXIge1xuICAgIHJlcToge1xuICAgICAgICBvcHRzOiB7XG4gICAgICAgICAgICBoZWFkZXJzOiB7IFtzdHJpbmddOiBhbnkgfSxcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBvbihldmVudDogc3RyaW5nLCBoYW5kbGVyOiBBcmFuZ29FdmVudEhhbmRsZXIpOiB2b2lkO1xuXG4gICAgc3Vic2NyaWJlKHBhcmFtczogeyBjb2xsZWN0aW9uOiBzdHJpbmcgfSk6IHZvaWQ7XG5cbiAgICBzdGFydCgpOiB2b2lkO1xufVxuXG5leHBvcnQgY2xhc3MgQXJhbmdvUHJvdmlkZXIgaW1wbGVtZW50cyBRRGF0YVByb3ZpZGVyIHtcbiAgICBsb2c6IFFMb2c7XG4gICAgY29uZmlnOiBRQXJhbmdvQ29uZmlnO1xuXG4gICAgc3RhcnRlZDogYm9vbGVhbjtcbiAgICBhcmFuZ286IERhdGFiYXNlO1xuICAgIGNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlOiBzdHJpbmdbXTtcbiAgICBsaXN0ZW5lcjogP0FyYW5nb0xpc3RlbmVyO1xuICAgIGxpc3RlbmVyU3Vic2NyaWJlcnM6IEV2ZW50RW1pdHRlcjtcbiAgICBsaXN0ZW5lclN1YnNjcmliZXJzQ291bnQ6IG51bWJlcjtcblxuXG4gICAgY29uc3RydWN0b3IobG9nOiBRTG9nLCBjb25maWc6IFFBcmFuZ29Db25maWcpIHtcbiAgICAgICAgdGhpcy5sb2cgPSBsb2c7XG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuXG4gICAgICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmFyYW5nbyA9IG5ldyBEYXRhYmFzZSh7XG4gICAgICAgICAgICB1cmw6IGAke2Vuc3VyZVByb3RvY29sKGNvbmZpZy5zZXJ2ZXIsICdodHRwJyl9YCxcbiAgICAgICAgICAgIGFnZW50T3B0aW9uczoge1xuICAgICAgICAgICAgICAgIG1heFNvY2tldHM6IGNvbmZpZy5tYXhTb2NrZXRzLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuYXJhbmdvLnVzZURhdGFiYXNlKGNvbmZpZy5uYW1lKTtcbiAgICAgICAgaWYgKGNvbmZpZy5hdXRoKSB7XG4gICAgICAgICAgICBjb25zdCBhdXRoUGFydHMgPSBjb25maWcuYXV0aC5zcGxpdCgnOicpO1xuICAgICAgICAgICAgdGhpcy5hcmFuZ28udXNlQmFzaWNBdXRoKGF1dGhQYXJ0c1swXSwgYXV0aFBhcnRzLnNsaWNlKDEpLmpvaW4oJzonKSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jb2xsZWN0aW9uc0ZvclN1YnNjcmliZSA9IFtdO1xuICAgICAgICB0aGlzLmxpc3RlbmVyID0gbnVsbDtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnMuc2V0TWF4TGlzdGVuZXJzKDApO1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnNDb3VudCA9IDA7XG4gICAgfVxuXG4gICAgYXN5bmMgc3RhcnQoY29sbGVjdGlvbnNGb3JTdWJzY3JpYmU6IHN0cmluZ1tdKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgdGhpcy5zdGFydGVkID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9uc0ZvclN1YnNjcmliZSA9IGNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlO1xuICAgICAgICB0aGlzLmNoZWNrU3RhcnRMaXN0ZW5lcigpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuXG4gICAgZ2V0Q29sbGVjdGlvbkluZGV4ZXMoY29sbGVjdGlvbjogc3RyaW5nKTogUHJvbWlzZTxRSW5kZXhJbmZvW10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXJhbmdvLmNvbGxlY3Rpb24oY29sbGVjdGlvbikuaW5kZXhlcygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgb2JqZWN0IHdpdGggY29sbGVjdGlvbiBuYW1lcyBpbiBrZXlzIGFuZCBjb2xsZWN0aW9uIHNpemUgaW4gdmFsdWVzLlxuICAgICAqL1xuICAgIGFzeW5jIGxvYWRGaW5nZXJwcmludCgpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCBjb2xsZWN0aW9uTmFtZXMgPSAoYXdhaXQgdGhpcy5hcmFuZ28ubGlzdENvbGxlY3Rpb25zKCkpLm1hcChkZXNjciA9PiBkZXNjci5uYW1lKTtcbiAgICAgICAgLy8gVE9ETzogYWRkIHRoaXMgd2hlbiByZXF1aXJlZCBhIG5ldyB2ZXJzaW9uIGFyYW5nb2pzIHY3LngueFxuICAgICAgICAvLyBhd2FpdCBQcm9taXNlLmFsbChjb2xsZWN0aW9ucy5tYXAoY29sID0+IHRoaXMuYXJhbmdvLmNvbGxlY3Rpb24oY29sKS5yZWNhbGN1bGF0ZUNvdW50KCkpKTtcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IFByb21pc2UuYWxsKGNvbGxlY3Rpb25OYW1lcy5tYXAoY29sID0+IHRoaXMuYXJhbmdvLmNvbGxlY3Rpb24oY29sKS5jb3VudCgpKSk7XG4gICAgICAgIGNvbnN0IGZpbmdlcnByaW50OiBhbnkgPSB7fTtcbiAgICAgICAgY29sbGVjdGlvbk5hbWVzLmZvckVhY2goKGNvbGxlY3Rpb25OYW1lLCBpKSA9PiB7XG4gICAgICAgICAgICBmaW5nZXJwcmludFtjb2xsZWN0aW9uTmFtZV0gPSByZXN1bHRzW2ldLmNvdW50O1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGZpbmdlcnByaW50O1xuICAgIH1cblxuICAgIGFzeW5jIGhvdFVwZGF0ZSgpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgcXVlcnkodGV4dDogc3RyaW5nLCB2YXJzOiB7IFtzdHJpbmddOiBhbnkgfSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IGN1cnNvciA9IGF3YWl0IHRoaXMuYXJhbmdvLnF1ZXJ5KHRleHQsIHZhcnMpO1xuICAgICAgICByZXR1cm4gY3Vyc29yLmFsbCgpO1xuICAgIH1cblxuICAgIGFzeW5jIHN1YnNjcmliZShjb2xsZWN0aW9uOiBzdHJpbmcsIGxpc3RlbmVyOiAoZG9jOiBhbnksIGV2ZW50OiBRRGF0YUV2ZW50KSA9PiB2b2lkKTogYW55IHtcbiAgICAgICAgaWYgKHRoaXMubGlzdGVuZXJTdWJzY3JpYmVycykge1xuICAgICAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzLm9uKGNvbGxlY3Rpb24sIGxpc3RlbmVyKTtcbiAgICAgICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50ICs9IDE7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jaGVja1N0YXJ0TGlzdGVuZXIoKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNvbGxlY3Rpb24sXG4gICAgICAgICAgICBsaXN0ZW5lcixcbiAgICAgICAgfTtcbiAgICB9XG5cblxuICAgIHVuc3Vic2NyaWJlKHN1YnNjcmlwdGlvbjogYW55KSB7XG4gICAgICAgIGlmICh0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnMpIHtcbiAgICAgICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVycy5yZW1vdmVMaXN0ZW5lcihzdWJzY3JpcHRpb24uY29sbGVjdGlvbiwgc3Vic2NyaXB0aW9uLmxpc3RlbmVyKTtcbiAgICAgICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50ID0gTWF0aC5tYXgodGhpcy5saXN0ZW5lclN1YnNjcmliZXJzQ291bnQgLSAxLCAwKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIEludGVybmFsc1xuXG4gICAgY2hlY2tTdGFydExpc3RlbmVyKCkge1xuICAgICAgICBpZiAoIXRoaXMuc3RhcnRlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmxpc3RlbmVyKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbnNGb3JTdWJzY3JpYmUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50ID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5saXN0ZW5lciA9IHRoaXMuY3JlYXRlQW5kU3RhcnRMaXN0ZW5lcigpO1xuICAgIH1cblxuICAgIGNyZWF0ZUFuZFN0YXJ0TGlzdGVuZXIoKTogQXJhbmdvTGlzdGVuZXIge1xuICAgICAgICBjb25zdCB7IHNlcnZlciwgbmFtZSwgYXV0aCB9ID0gdGhpcy5jb25maWc7XG4gICAgICAgIGNvbnN0IGRiVXJsID0gZW5zdXJlUHJvdG9jb2woc2VydmVyLCAnaHR0cCcpO1xuICAgICAgICBjb25zdCBsaXN0ZW5lclVybCA9IGAke2RiVXJsfS8ke25hbWV9YDtcblxuICAgICAgICBjb25zdCBsaXN0ZW5lciA9IG5ldyBhcmFuZ29jaGFpcihsaXN0ZW5lclVybCk7XG4gICAgICAgIGNvbnN0IHBhcnNlZERiVXJsID0gdXJsLnBhcnNlKGRiVXJsKTtcblxuICAgICAgICBjb25zdCBwYXRoUHJlZml4ID0gcGFyc2VkRGJVcmwucGF0aCAhPT0gXCIvXCIgPyAocGFyc2VkRGJVcmwucGF0aCB8fCBcIlwiKSA6IFwiXCI7XG4gICAgICAgIGxpc3RlbmVyLl9sb2dnZXJTdGF0ZVBhdGggPSBgJHtwYXRoUHJlZml4fS9fZGIvJHtuYW1lfS9fYXBpL3JlcGxpY2F0aW9uL2xvZ2dlci1zdGF0ZWA7XG4gICAgICAgIGxpc3RlbmVyLl9sb2dnZXJGb2xsb3dQYXRoID0gYCR7cGF0aFByZWZpeH0vX2RiLyR7bmFtZX0vX2FwaS9yZXBsaWNhdGlvbi9sb2dnZXItZm9sbG93YDtcblxuICAgICAgICBpZiAodGhpcy5jb25maWcuYXV0aCkge1xuICAgICAgICAgICAgY29uc3QgdXNlclBhc3N3b3JkID0gQnVmZmVyLmZyb20oYXV0aCkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICAgICAgICAgICAgbGlzdGVuZXIucmVxLm9wdHMuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddID0gYEJhc2ljICR7dXNlclBhc3N3b3JkfWA7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlLmZvckVhY2goKGNvbGxlY3Rpb25OYW1lKSA9PiB7XG4gICAgICAgICAgICBsaXN0ZW5lci5zdWJzY3JpYmUoeyBjb2xsZWN0aW9uOiBjb2xsZWN0aW9uTmFtZSB9KTtcbiAgICAgICAgICAgIGxpc3RlbmVyLm9uKGNvbGxlY3Rpb25OYW1lLCAoZG9jSnNvbiwgdHlwZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnaW5zZXJ0L3VwZGF0ZScgfHwgdHlwZSA9PT0gJ2luc2VydCcgfHwgdHlwZSA9PT0gJ3VwZGF0ZScpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkRhdGFFdmVudCh0eXBlLCBjb2xsZWN0aW9uTmFtZSwgZG9jSnNvbik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pXG5cbiAgICAgICAgbGlzdGVuZXIub24oJ2Vycm9yJywgKGVyciwgc3RhdHVzLCBoZWFkZXJzLCBib2R5KSA9PiB7XG4gICAgICAgICAgICBsZXQgZXJyb3IgPSBlcnI7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGVycm9yID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICAgICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ0ZBSUxFRCcsICdMSVNURU4nLCBgJHtlcnJ9YCwgZXJyb3IpO1xuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBsaXN0ZW5lci5zdGFydCgpLCB0aGlzLmNvbmZpZy5saXN0ZW5lclJlc3RhcnRUaW1lb3V0IHx8IDEwMDApO1xuICAgICAgICB9KTtcbiAgICAgICAgbGlzdGVuZXIuc3RhcnQoKTtcbiAgICAgICAgcmV0dXJuIGxpc3RlbmVyO1xuICAgIH1cblxuICAgIG9uRGF0YUV2ZW50KGV2ZW50OiBRRGF0YUV2ZW50LCBjb2xsZWN0aW9uOiBzdHJpbmcsIGRvYzogUURvYykge1xuICAgICAgICBpZiAodGhpcy5saXN0ZW5lclN1YnNjcmliZXJzKSB7XG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnMuZW1pdChjb2xsZWN0aW9uLCBkb2MsIGV2ZW50KTtcbiAgICAgICAgfVxuICAgIH1cblxufVxuIl19