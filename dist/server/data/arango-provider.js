"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ArangoProvider = void 0;

var _arangochair = _interopRequireDefault(require("arangochair"));

var _arangojs = require("arangojs");

var _events = _interopRequireDefault(require("events"));

var _config = require("../config");

var _dataProvider = require("./data-provider");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DATA_EVENT = 'data';

class ArangoProvider {
  constructor(log, segment, config) {
    this.log = log;
    this.segment = segment;
    this.config = config;
    this.started = false;
    this.arango = new _arangojs.Database({
      url: `${(0, _config.ensureProtocol)(config.server, 'http')}`,
      agentOptions: {
        maxSockets: config.maxSockets
      }
    });
    this.arango.useDatabase(config.name);

    if (config.auth) {
      const authParts = config.auth.split(':');
      this.arango.useBasicAuth(authParts[0], authParts.slice(1).join(':'));
    }

    this.listener = this.createListener();
    this.listenerSubscribers = new _events.default();
    this.listenerSubscribers.setMaxListeners(0);
    this.listenerStarted = false;
  }

  start() {
    this.checkStartListener();
  }

  getCollectionIndexes(collection) {
    return this.arango.collection(collection).indexes();
  }

  async query(text, vars) {
    const cursor = await this.arango.query(text, vars);
    return cursor.all();
  }

  async subscribe(collection, listener) {
    var _this$listenerSubscri;

    (_this$listenerSubscri = this.listenerSubscribers) === null || _this$listenerSubscri === void 0 ? void 0 : _this$listenerSubscri.on(DATA_EVENT, listener);
    this.checkStartListener();
    return listener;
  }

  unsubscribe(subscription) {
    var _this$listenerSubscri2;

    (_this$listenerSubscri2 = this.listenerSubscribers) === null || _this$listenerSubscri2 === void 0 ? void 0 : _this$listenerSubscri2.removeListener(DATA_EVENT, subscription);
  } // Internals


  checkStartListener() {
    const hasSubscribers = this.listenerSubscribers.listenerCount(DATA_EVENT) > 0;

    if (this.started && !this.listenerStarted && hasSubscribers) {
      this.listenerStarted = true;
      this.listener.start();
    }
  }

  createListener() {
    const {
      server,
      name,
      auth
    } = this.config;
    const listenerUrl = `${(0, _config.ensureProtocol)(server, 'http')}/${name}`;
    const listener = new _arangochair.default(listenerUrl);

    if (this.config.auth) {
      const userPassword = Buffer.from(auth).toString('base64');
      listener.req.opts.headers['Authorization'] = `Basic ${userPassword}`;
    }

    Object.values(_dataProvider.dataCollectionInfo).forEach(collection => {
      const collectionName = collection.name;
      listener.subscribe({
        collection: collectionName
      });
      listener.on(name, (docJson, type) => {
        if (type === 'insert/update' || type === 'insert' || type === 'update') {
          this.onDataEvent(type, collectionName, docJson);
        }
      });
    });
    listener.on('error', (err, status, headers, body) => {
      let error = err;

      try {
        error = JSON.parse(body);
      } catch {}

      this.log.error('FAILED', 'LISTEN', `${err}`, error);
      setTimeout(() => listener.start(), this.config.listenerRestartTimeout || 1000);
    });
  }

  onDataEvent(event, collection, doc) {
    var _this$listenerSubscri3;

    (_this$listenerSubscri3 = this.listenerSubscribers) === null || _this$listenerSubscri3 === void 0 ? void 0 : _this$listenerSubscri3.emit(collection, doc, event);
  }

}

exports.ArangoProvider = ArangoProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9hcmFuZ28tcHJvdmlkZXIuanMiXSwibmFtZXMiOlsiREFUQV9FVkVOVCIsIkFyYW5nb1Byb3ZpZGVyIiwiY29uc3RydWN0b3IiLCJsb2ciLCJzZWdtZW50IiwiY29uZmlnIiwic3RhcnRlZCIsImFyYW5nbyIsIkRhdGFiYXNlIiwidXJsIiwic2VydmVyIiwiYWdlbnRPcHRpb25zIiwibWF4U29ja2V0cyIsInVzZURhdGFiYXNlIiwibmFtZSIsImF1dGgiLCJhdXRoUGFydHMiLCJzcGxpdCIsInVzZUJhc2ljQXV0aCIsInNsaWNlIiwiam9pbiIsImxpc3RlbmVyIiwiY3JlYXRlTGlzdGVuZXIiLCJsaXN0ZW5lclN1YnNjcmliZXJzIiwiRXZlbnRFbWl0dGVyIiwic2V0TWF4TGlzdGVuZXJzIiwibGlzdGVuZXJTdGFydGVkIiwic3RhcnQiLCJjaGVja1N0YXJ0TGlzdGVuZXIiLCJnZXRDb2xsZWN0aW9uSW5kZXhlcyIsImNvbGxlY3Rpb24iLCJpbmRleGVzIiwicXVlcnkiLCJ0ZXh0IiwidmFycyIsImN1cnNvciIsImFsbCIsInN1YnNjcmliZSIsIm9uIiwidW5zdWJzY3JpYmUiLCJzdWJzY3JpcHRpb24iLCJyZW1vdmVMaXN0ZW5lciIsImhhc1N1YnNjcmliZXJzIiwibGlzdGVuZXJDb3VudCIsImxpc3RlbmVyVXJsIiwiYXJhbmdvY2hhaXIiLCJ1c2VyUGFzc3dvcmQiLCJCdWZmZXIiLCJmcm9tIiwidG9TdHJpbmciLCJyZXEiLCJvcHRzIiwiaGVhZGVycyIsIk9iamVjdCIsInZhbHVlcyIsImRhdGFDb2xsZWN0aW9uSW5mbyIsImZvckVhY2giLCJjb2xsZWN0aW9uTmFtZSIsImRvY0pzb24iLCJ0eXBlIiwib25EYXRhRXZlbnQiLCJlcnIiLCJzdGF0dXMiLCJib2R5IiwiZXJyb3IiLCJKU09OIiwicGFyc2UiLCJzZXRUaW1lb3V0IiwibGlzdGVuZXJSZXN0YXJ0VGltZW91dCIsImV2ZW50IiwiZG9jIiwiZW1p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QUFDakQsVUFBSUMsS0FBSyxHQUFHSCxHQUFaOztBQUNBLFVBQUk7QUFDQUcsUUFBQUEsS0FBSyxHQUFHQyxJQUFJLENBQUNDLEtBQUwsQ0FBV0gsSUFBWCxDQUFSO0FBQ0gsT0FGRCxDQUVFLE1BQU0sQ0FDUDs7QUFDRCxXQUFLNUQsR0FBTCxDQUFTNkQsS0FBVCxDQUFlLFFBQWYsRUFBeUIsUUFBekIsRUFBb0MsR0FBRUgsR0FBSSxFQUExQyxFQUE2Q0csS0FBN0M7QUFDQUcsTUFBQUEsVUFBVSxDQUFDLE1BQU05QyxRQUFRLENBQUNNLEtBQVQsRUFBUCxFQUF5QixLQUFLdEIsTUFBTCxDQUFZK0Qsc0JBQVosSUFBc0MsSUFBL0QsQ0FBVjtBQUNILEtBUkQ7QUFTSDs7QUFFRFIsRUFBQUEsV0FBVyxDQUFDUyxLQUFELEVBQW9CdkMsVUFBcEIsRUFBd0N3QyxHQUF4QyxFQUFtRDtBQUFBOztBQUMxRCxtQ0FBSy9DLG1CQUFMLGtGQUEwQmdELElBQTFCLENBQStCekMsVUFBL0IsRUFBMkN3QyxHQUEzQyxFQUFnREQsS0FBaEQ7QUFDSDs7QUEzR2dEIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcbmltcG9ydCBhcmFuZ29jaGFpciBmcm9tICdhcmFuZ29jaGFpcic7XG5pbXBvcnQgeyBEYXRhYmFzZSB9IGZyb20gJ2FyYW5nb2pzJztcbmltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IGVuc3VyZVByb3RvY29sIH0gZnJvbSAnLi4vY29uZmlnJztcbmltcG9ydCB0eXBlIHsgUUFyYW5nb0NvbmZpZyB9IGZyb20gJy4uL2NvbmZpZyc7XG5pbXBvcnQgdHlwZSB7IFFMb2cgfSBmcm9tICcuLi9sb2dzJztcbmltcG9ydCB7IGRhdGFDb2xsZWN0aW9uSW5mbyB9IGZyb20gJy4vZGF0YS1wcm92aWRlcic7XG5pbXBvcnQgdHlwZSB7IFFEYXRhRXZlbnQsIFFEYXRhUHJvdmlkZXIsIFFEYXRhU2VnbWVudCwgUURvYywgUUluZGV4SW5mbyB9IGZyb20gJy4vZGF0YS1wcm92aWRlcic7XG5cbmNvbnN0IERBVEFfRVZFTlQgPSAnZGF0YSc7XG5cbnR5cGUgQXJhbmdvRXZlbnRIYW5kbGVyID0gKGVycjogYW55LCBzdGF0dXM6IHN0cmluZywgaGVhZGVyczogeyBbc3RyaW5nXTogYW55IH0sIGJvZHk6IHN0cmluZykgPT4gdm9pZDtcbmludGVyZmFjZSBBcmFuZ29MaXN0ZW5lciB7XG4gICAgcmVxOiB7XG4gICAgICAgIG9wdHM6IHtcbiAgICAgICAgICAgIGhlYWRlcnM6IHsgW3N0cmluZ106IGFueSB9LFxuICAgICAgICB9XG4gICAgfTtcblxuICAgIG9uKGV2ZW50OiBzdHJpbmcsIGhhbmRsZXI6IEFyYW5nb0V2ZW50SGFuZGxlcik6IHZvaWQ7XG5cbiAgICBzdWJzY3JpYmUocGFyYW1zOiB7IGNvbGxlY3Rpb246IHN0cmluZyB9KTogdm9pZDtcblxuICAgIHN0YXJ0KCk6IHZvaWQ7XG59XG5cbmV4cG9ydCBjbGFzcyBBcmFuZ29Qcm92aWRlciBpbXBsZW1lbnRzIFFEYXRhUHJvdmlkZXIge1xuICAgIGxvZzogUUxvZztcbiAgICBzZWdtZW50OiBRRGF0YVNlZ21lbnQ7XG4gICAgY29uZmlnOiBRQXJhbmdvQ29uZmlnO1xuXG4gICAgc3RhcnRlZDogYm9vbGVhbjtcbiAgICBhcmFuZ286IERhdGFiYXNlO1xuICAgIGxpc3RlbmVyOiBBcmFuZ29MaXN0ZW5lcjtcbiAgICBsaXN0ZW5lclN1YnNjcmliZXJzOiBFdmVudEVtaXR0ZXI7XG4gICAgbGlzdGVuZXJTdGFydGVkOiBib29sZWFuO1xuXG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgbG9nOiBRTG9nLFxuICAgICAgICBzZWdtZW50OiBRRGF0YVNlZ21lbnQsXG4gICAgICAgIGNvbmZpZzogUUFyYW5nb0NvbmZpZyxcbiAgICApIHtcbiAgICAgICAgdGhpcy5sb2cgPSBsb2c7XG4gICAgICAgIHRoaXMuc2VnbWVudCA9IHNlZ21lbnQ7XG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuXG4gICAgICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmFyYW5nbyA9IG5ldyBEYXRhYmFzZSh7XG4gICAgICAgICAgICB1cmw6IGAke2Vuc3VyZVByb3RvY29sKGNvbmZpZy5zZXJ2ZXIsICdodHRwJyl9YCxcbiAgICAgICAgICAgIGFnZW50T3B0aW9uczoge1xuICAgICAgICAgICAgICAgIG1heFNvY2tldHM6IGNvbmZpZy5tYXhTb2NrZXRzLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuYXJhbmdvLnVzZURhdGFiYXNlKGNvbmZpZy5uYW1lKTtcbiAgICAgICAgaWYgKGNvbmZpZy5hdXRoKSB7XG4gICAgICAgICAgICBjb25zdCBhdXRoUGFydHMgPSBjb25maWcuYXV0aC5zcGxpdCgnOicpO1xuICAgICAgICAgICAgdGhpcy5hcmFuZ28udXNlQmFzaWNBdXRoKGF1dGhQYXJ0c1swXSwgYXV0aFBhcnRzLnNsaWNlKDEpLmpvaW4oJzonKSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5saXN0ZW5lciA9IHRoaXMuY3JlYXRlTGlzdGVuZXIoKTtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnMuc2V0TWF4TGlzdGVuZXJzKDApO1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3RhcnRlZCA9IGZhbHNlO1xuICAgIH1cblxuICAgIHN0YXJ0KCkge1xuICAgICAgICB0aGlzLmNoZWNrU3RhcnRMaXN0ZW5lcigpO1xuICAgIH1cblxuICAgIGdldENvbGxlY3Rpb25JbmRleGVzKGNvbGxlY3Rpb24pOiBQcm9taXNlPFFJbmRleEluZm9bXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5hcmFuZ28uY29sbGVjdGlvbihjb2xsZWN0aW9uKS5pbmRleGVzKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgcXVlcnkodGV4dDogc3RyaW5nLCB2YXJzOiB7IFtzdHJpbmddOiBhbnkgfSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IGN1cnNvciA9IGF3YWl0IHRoaXMuYXJhbmdvLnF1ZXJ5KHRleHQsIHZhcnMpO1xuICAgICAgICByZXR1cm4gY3Vyc29yLmFsbCgpO1xuICAgIH1cblxuICAgIGFzeW5jIHN1YnNjcmliZShjb2xsZWN0aW9uOiBzdHJpbmcsIGxpc3RlbmVyOiAoZG9jOiBhbnksIGV2ZW50OiBRRGF0YUV2ZW50KSA9PiB2b2lkKTogYW55IHtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzPy5vbihEQVRBX0VWRU5ULCBsaXN0ZW5lcik7XG4gICAgICAgIHRoaXMuY2hlY2tTdGFydExpc3RlbmVyKCk7XG4gICAgICAgIHJldHVybiBsaXN0ZW5lcjtcbiAgICB9XG5cblxuICAgIHVuc3Vic2NyaWJlKHN1YnNjcmlwdGlvbjogYW55KSB7XG4gICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVycz8ucmVtb3ZlTGlzdGVuZXIoREFUQV9FVkVOVCwgc3Vic2NyaXB0aW9uKTtcbiAgICB9XG5cbiAgICAvLyBJbnRlcm5hbHNcblxuICAgIGNoZWNrU3RhcnRMaXN0ZW5lcigpIHtcbiAgICAgICAgY29uc3QgaGFzU3Vic2NyaWJlcnMgPSB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnMubGlzdGVuZXJDb3VudChEQVRBX0VWRU5UKSA+IDA7XG4gICAgICAgIGlmICh0aGlzLnN0YXJ0ZWQgJiYgIXRoaXMubGlzdGVuZXJTdGFydGVkICYmIGhhc1N1YnNjcmliZXJzKSB7XG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyU3RhcnRlZCA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyLnN0YXJ0KCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjcmVhdGVMaXN0ZW5lcigpOiBBcmFuZ29MaXN0ZW5lciB7XG4gICAgICAgIGNvbnN0IHsgc2VydmVyLCBuYW1lLCBhdXRoIH0gPSB0aGlzLmNvbmZpZztcbiAgICAgICAgY29uc3QgbGlzdGVuZXJVcmwgPSBgJHtlbnN1cmVQcm90b2NvbChzZXJ2ZXIsICdodHRwJyl9LyR7bmFtZX1gO1xuXG4gICAgICAgIGNvbnN0IGxpc3RlbmVyID0gbmV3IGFyYW5nb2NoYWlyKGxpc3RlbmVyVXJsKTtcblxuICAgICAgICBpZiAodGhpcy5jb25maWcuYXV0aCkge1xuICAgICAgICAgICAgY29uc3QgdXNlclBhc3N3b3JkID0gQnVmZmVyLmZyb20oYXV0aCkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICAgICAgICAgICAgbGlzdGVuZXIucmVxLm9wdHMuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddID0gYEJhc2ljICR7dXNlclBhc3N3b3JkfWA7XG4gICAgICAgIH1cblxuICAgICAgICBPYmplY3QudmFsdWVzKGRhdGFDb2xsZWN0aW9uSW5mbykuZm9yRWFjaCgoY29sbGVjdGlvbikgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29sbGVjdGlvbk5hbWUgPSBjb2xsZWN0aW9uLm5hbWU7XG4gICAgICAgICAgICBsaXN0ZW5lci5zdWJzY3JpYmUoeyBjb2xsZWN0aW9uOiBjb2xsZWN0aW9uTmFtZSB9KTtcbiAgICAgICAgICAgIGxpc3RlbmVyLm9uKG5hbWUsIChkb2NKc29uLCB0eXBlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdpbnNlcnQvdXBkYXRlJyB8fCB0eXBlID09PSAnaW5zZXJ0JyB8fCB0eXBlID09PSAndXBkYXRlJykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uRGF0YUV2ZW50KHR5cGUsIGNvbGxlY3Rpb25OYW1lLCBkb2NKc29uKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSlcblxuICAgICAgICBsaXN0ZW5lci5vbignZXJyb3InLCAoZXJyLCBzdGF0dXMsIGhlYWRlcnMsIGJvZHkpID0+IHtcbiAgICAgICAgICAgIGxldCBlcnJvciA9IGVycjtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgZXJyb3IgPSBKU09OLnBhcnNlKGJvZHkpO1xuICAgICAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignRkFJTEVEJywgJ0xJU1RFTicsIGAke2Vycn1gLCBlcnJvcik7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGxpc3RlbmVyLnN0YXJ0KCksIHRoaXMuY29uZmlnLmxpc3RlbmVyUmVzdGFydFRpbWVvdXQgfHwgMTAwMCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIG9uRGF0YUV2ZW50KGV2ZW50OiBRRGF0YUV2ZW50LCBjb2xsZWN0aW9uOiBzdHJpbmcsIGRvYzogUURvYykge1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnM/LmVtaXQoY29sbGVjdGlvbiwgZG9jLCBldmVudCk7XG4gICAgfVxuXG59XG4iXX0=