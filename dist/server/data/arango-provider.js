"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ArangoProvider = void 0;

var _arangochair = _interopRequireDefault(require("arangochair"));

var _arangojs = require("arangojs");

var _events = _interopRequireDefault(require("events"));

var _config = require("../config");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class ArangoProvider {
  constructor(log, config) {
    this.log = log;
    this.config = config;
    this.started = false;
    this.arango = new _arangojs.Database({
      url: `${(0, _config.ensureProtocol)(config.server, 'http')}`,
      agentOptions: {
        maxSockets: config.maxSockets
      }
    });
    this.arango.useDatabase(config.name);

    if (config.auth) {
      const authParts = config.auth.split(':');
      this.arango.useBasicAuth(authParts[0], authParts.slice(1).join(':'));
    }

    this.collectionsForSubscribe = [];
    this.listener = null;
    this.listenerSubscribers = new _events.default();
    this.listenerSubscribers.setMaxListeners(0);
    this.listenerSubscribersCount = 0;
  }

  start(collectionsForSubscribe) {
    this.started = true;
    this.collectionsForSubscribe = collectionsForSubscribe;
    this.checkStartListener();
  }

  getCollectionIndexes(collection) {
    return this.arango.collection(collection).indexes();
  }

  async query(text, vars) {
    const cursor = await this.arango.query(text, vars);
    return cursor.all();
  }

  async subscribe(collection, listener) {
    var _this$listenerSubscri;

    (_this$listenerSubscri = this.listenerSubscribers) === null || _this$listenerSubscri === void 0 ? void 0 : _this$listenerSubscri.on(collection, listener);
    this.listenerSubscribersCount += 1;
    this.checkStartListener();
    return {
      collection,
      listener
    };
  }

  unsubscribe(subscription) {
    var _this$listenerSubscri2;

    (_this$listenerSubscri2 = this.listenerSubscribers) === null || _this$listenerSubscri2 === void 0 ? void 0 : _this$listenerSubscri2.removeListener(subscription.collection, subscription.listener);
    this.listenerSubscribersCount = Math.max(this.listenerSubscribersCount - 1, 0);
  } // Internals


  checkStartListener() {
    if (!this.started) {
      return;
    }

    if (this.listener) {
      return;
    }

    if (this.collectionsForSubscribe.length === 0) {
      return;
    }

    if (this.listenerSubscribersCount === 0) {
      return;
    }

    this.listener = this.createAndStartListener();
  }

  createAndStartListener() {
    const {
      server,
      name,
      auth
    } = this.config;
    const listenerUrl = `${(0, _config.ensureProtocol)(server, 'http')}/${name}`;
    const listener = new _arangochair.default(listenerUrl);

    if (this.config.auth) {
      const userPassword = Buffer.from(auth).toString('base64');
      listener.req.opts.headers['Authorization'] = `Basic ${userPassword}`;
    }

    this.collectionsForSubscribe.forEach(collectionName => {
      listener.subscribe({
        collection: collectionName
      });
      listener.on(collectionName, (docJson, type) => {
        if (type === 'insert/update' || type === 'insert' || type === 'update') {
          this.onDataEvent(type, collectionName, docJson);
        }
      });
    });
    listener.on('error', (err, status, headers, body) => {
      let error = err;

      try {
        error = JSON.parse(body);
      } catch {}

      this.log.error('FAILED', 'LISTEN', `${err}`, error);
      setTimeout(() => listener.start(), this.config.listenerRestartTimeout || 1000);
    });
    listener.start();
    return listener;
  }

  onDataEvent(event, collection, doc) {
    var _this$listenerSubscri3;

    (_this$listenerSubscri3 = this.listenerSubscribers) === null || _this$listenerSubscri3 === void 0 ? void 0 : _this$listenerSubscri3.emit(collection, doc, event);
  }

}

exports.ArangoProvider = ArangoProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9hcmFuZ28tcHJvdmlkZXIuanMiXSwibmFtZXMiOlsiQXJhbmdvUHJvdmlkZXIiLCJjb25zdHJ1Y3RvciIsImxvZyIsImNvbmZpZyIsInN0YXJ0ZWQiLCJhcmFuZ28iLCJEYXRhYmFzZSIsInVybCIsInNlcnZlciIsImFnZW50T3B0aW9ucyIsIm1heFNvY2tldHMiLCJ1c2VEYXRhYmFzZSIsIm5hbWUiLCJhdXRoIiwiYXV0aFBhcnRzIiwic3BsaXQiLCJ1c2VCYXNpY0F1dGgiLCJzbGljZSIsImpvaW4iLCJjb2xsZWN0aW9uc0ZvclN1YnNjcmliZSIsImxpc3RlbmVyIiwibGlzdGVuZXJTdWJzY3JpYmVycyIsIkV2ZW50RW1pdHRlciIsInNldE1heExpc3RlbmVycyIsImxpc3RlbmVyU3Vic2NyaWJlcnNDb3VudCIsInN0YXJ0IiwiY2hlY2tTdGFydExpc3RlbmVyIiwiZ2V0Q29sbGVjdGlvbkluZGV4ZXMiLCJjb2xsZWN0aW9uIiwiaW5kZXhlcyIsInF1ZXJ5IiwidGV4dCIsInZhcnMiLCJjdXJzb3IiLCJhbGwiLCJzdWJzY3JpYmUiLCJvbiIsInVuc3Vic2NyaWJlIiwic3Vic2NyaXB0aW9uIiwicmVtb3ZlTGlzdGVuZXIiLCJNYXRoIiwibWF4IiwibGVuZ3RoIiwiY3JlYXRlQW5kU3RhcnRMaXN0ZW5lciIsImxpc3RlbmVyVXJsIiwiYXJhbmdvY2hhaXIiLCJ1c2VyUGFzc3dvcmQiLCJCdWZmZXIiLCJmcm9tIiwidG9TdHJpbmciLCJyZXEiLCJvcHRzIiwiaGVhZGVycyIsImZvckVhY2giLCJjb2xsZWN0aW9uTmFtZSIsImRvY0pzb24iLCJ0eXBlIiwib25EYXRhRXZlbnQiLCJlcnIiLCJzdGF0dXMiLCJib2R5IiwiZXJyb3IiLCJKU09OIiwicGFyc2UiLCJzZXRUaW1lb3V0IiwibGlzdGVuZXJSZXN0YXJ0VGltZW91dCIsImV2ZW50IiwiZG9jIiwiZW1pdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBOztB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QixFQUF1Q0MsT0FBdkM7QUFDSDtBQUNKLE9BSkQ7QUFLSCxLQVBEO0FBU0FuQyxJQUFBQSxRQUFRLENBQUNnQixFQUFULENBQVksT0FBWixFQUFxQixDQUFDc0IsR0FBRCxFQUFNQyxNQUFOLEVBQWNQLE9BQWQsRUFBdUJRLElBQXZCLEtBQWdDO0FBQ2pELFVBQUlDLEtBQUssR0FBR0gsR0FBWjs7QUFDQSxVQUFJO0FBQ0FHLFFBQUFBLEtBQUssR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVdILElBQVgsQ0FBUjtBQUNILE9BRkQsQ0FFRSxNQUFNLENBQ1A7O0FBQ0QsV0FBSzFELEdBQUwsQ0FBUzJELEtBQVQsQ0FBZSxRQUFmLEVBQXlCLFFBQXpCLEVBQW9DLEdBQUVILEdBQUksRUFBMUMsRUFBNkNHLEtBQTdDO0FBQ0FHLE1BQUFBLFVBQVUsQ0FBQyxNQUFNNUMsUUFBUSxDQUFDSyxLQUFULEVBQVAsRUFBeUIsS0FBS3RCLE1BQUwsQ0FBWThELHNCQUFaLElBQXNDLElBQS9ELENBQVY7QUFDSCxLQVJEO0FBU0E3QyxJQUFBQSxRQUFRLENBQUNLLEtBQVQ7QUFDQSxXQUFPTCxRQUFQO0FBQ0g7O0FBRURxQyxFQUFBQSxXQUFXLENBQUNTLEtBQUQsRUFBb0J0QyxVQUFwQixFQUF3Q3VDLEdBQXhDLEVBQW1EO0FBQUE7O0FBQzFELG1DQUFLOUMsbUJBQUwsa0ZBQTBCK0MsSUFBMUIsQ0FBK0J4QyxVQUEvQixFQUEyQ3VDLEdBQTNDLEVBQWdERCxLQUFoRDtBQUNIOztBQXZIZ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuaW1wb3J0IGFyYW5nb2NoYWlyIGZyb20gJ2FyYW5nb2NoYWlyJztcbmltcG9ydCB7IERhdGFiYXNlIH0gZnJvbSAnYXJhbmdvanMnO1xuaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICdldmVudHMnO1xuaW1wb3J0IHsgZW5zdXJlUHJvdG9jb2wgfSBmcm9tICcuLi9jb25maWcnO1xuaW1wb3J0IHR5cGUgeyBRQXJhbmdvQ29uZmlnIH0gZnJvbSAnLi4vY29uZmlnJztcbmltcG9ydCB0eXBlIHsgUUxvZyB9IGZyb20gJy4uL2xvZ3MnO1xuaW1wb3J0IHR5cGUgeyBRRGF0YUV2ZW50LCBRRGF0YVByb3ZpZGVyLCBRRG9jLCBRSW5kZXhJbmZvIH0gZnJvbSAnLi9kYXRhLXByb3ZpZGVyJztcblxudHlwZSBBcmFuZ29FdmVudEhhbmRsZXIgPSAoZXJyOiBhbnksIHN0YXR1czogc3RyaW5nLCBoZWFkZXJzOiB7IFtzdHJpbmddOiBhbnkgfSwgYm9keTogc3RyaW5nKSA9PiB2b2lkO1xuXG5pbnRlcmZhY2UgQXJhbmdvTGlzdGVuZXIge1xuICAgIHJlcToge1xuICAgICAgICBvcHRzOiB7XG4gICAgICAgICAgICBoZWFkZXJzOiB7IFtzdHJpbmddOiBhbnkgfSxcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBvbihldmVudDogc3RyaW5nLCBoYW5kbGVyOiBBcmFuZ29FdmVudEhhbmRsZXIpOiB2b2lkO1xuXG4gICAgc3Vic2NyaWJlKHBhcmFtczogeyBjb2xsZWN0aW9uOiBzdHJpbmcgfSk6IHZvaWQ7XG5cbiAgICBzdGFydCgpOiB2b2lkO1xufVxuXG5leHBvcnQgY2xhc3MgQXJhbmdvUHJvdmlkZXIgaW1wbGVtZW50cyBRRGF0YVByb3ZpZGVyIHtcbiAgICBsb2c6IFFMb2c7XG4gICAgY29uZmlnOiBRQXJhbmdvQ29uZmlnO1xuXG4gICAgc3RhcnRlZDogYm9vbGVhbjtcbiAgICBhcmFuZ286IERhdGFiYXNlO1xuICAgIGNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlOiBzdHJpbmdbXTtcbiAgICBsaXN0ZW5lcjogP0FyYW5nb0xpc3RlbmVyO1xuICAgIGxpc3RlbmVyU3Vic2NyaWJlcnM6IEV2ZW50RW1pdHRlcjtcbiAgICBsaXN0ZW5lclN1YnNjcmliZXJzQ291bnQ6IG51bWJlcjtcblxuXG4gICAgY29uc3RydWN0b3IobG9nOiBRTG9nLCBjb25maWc6IFFBcmFuZ29Db25maWcpIHtcbiAgICAgICAgdGhpcy5sb2cgPSBsb2c7XG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuXG4gICAgICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmFyYW5nbyA9IG5ldyBEYXRhYmFzZSh7XG4gICAgICAgICAgICB1cmw6IGAke2Vuc3VyZVByb3RvY29sKGNvbmZpZy5zZXJ2ZXIsICdodHRwJyl9YCxcbiAgICAgICAgICAgIGFnZW50T3B0aW9uczoge1xuICAgICAgICAgICAgICAgIG1heFNvY2tldHM6IGNvbmZpZy5tYXhTb2NrZXRzLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuYXJhbmdvLnVzZURhdGFiYXNlKGNvbmZpZy5uYW1lKTtcbiAgICAgICAgaWYgKGNvbmZpZy5hdXRoKSB7XG4gICAgICAgICAgICBjb25zdCBhdXRoUGFydHMgPSBjb25maWcuYXV0aC5zcGxpdCgnOicpO1xuICAgICAgICAgICAgdGhpcy5hcmFuZ28udXNlQmFzaWNBdXRoKGF1dGhQYXJ0c1swXSwgYXV0aFBhcnRzLnNsaWNlKDEpLmpvaW4oJzonKSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jb2xsZWN0aW9uc0ZvclN1YnNjcmliZSA9IFtdO1xuICAgICAgICB0aGlzLmxpc3RlbmVyID0gbnVsbDtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnMuc2V0TWF4TGlzdGVuZXJzKDApO1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnNDb3VudCA9IDA7XG4gICAgfVxuXG4gICAgc3RhcnQoY29sbGVjdGlvbnNGb3JTdWJzY3JpYmU6IHN0cmluZ1tdKSB7XG4gICAgICAgIHRoaXMuc3RhcnRlZCA9IHRydWU7XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnNGb3JTdWJzY3JpYmUgPSBjb2xsZWN0aW9uc0ZvclN1YnNjcmliZTtcbiAgICAgICAgdGhpcy5jaGVja1N0YXJ0TGlzdGVuZXIoKTtcbiAgICB9XG5cbiAgICBnZXRDb2xsZWN0aW9uSW5kZXhlcyhjb2xsZWN0aW9uOiBzdHJpbmcpOiBQcm9taXNlPFFJbmRleEluZm9bXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5hcmFuZ28uY29sbGVjdGlvbihjb2xsZWN0aW9uKS5pbmRleGVzKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgcXVlcnkodGV4dDogc3RyaW5nLCB2YXJzOiB7IFtzdHJpbmddOiBhbnkgfSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IGN1cnNvciA9IGF3YWl0IHRoaXMuYXJhbmdvLnF1ZXJ5KHRleHQsIHZhcnMpO1xuICAgICAgICByZXR1cm4gY3Vyc29yLmFsbCgpO1xuICAgIH1cblxuICAgIGFzeW5jIHN1YnNjcmliZShjb2xsZWN0aW9uOiBzdHJpbmcsIGxpc3RlbmVyOiAoZG9jOiBhbnksIGV2ZW50OiBRRGF0YUV2ZW50KSA9PiB2b2lkKTogYW55IHtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzPy5vbihjb2xsZWN0aW9uLCBsaXN0ZW5lcik7XG4gICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50ICs9IDE7XG4gICAgICAgIHRoaXMuY2hlY2tTdGFydExpc3RlbmVyKCk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjb2xsZWN0aW9uLFxuICAgICAgICAgICAgbGlzdGVuZXJcbiAgICAgICAgfTtcbiAgICB9XG5cblxuICAgIHVuc3Vic2NyaWJlKHN1YnNjcmlwdGlvbjogYW55KSB7XG4gICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVycz8ucmVtb3ZlTGlzdGVuZXIoc3Vic2NyaXB0aW9uLmNvbGxlY3Rpb24sIHN1YnNjcmlwdGlvbi5saXN0ZW5lcik7XG4gICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50ID0gTWF0aC5tYXgodGhpcy5saXN0ZW5lclN1YnNjcmliZXJzQ291bnQgLSAxLCAwKTtcbiAgICB9XG5cbiAgICAvLyBJbnRlcm5hbHNcblxuICAgIGNoZWNrU3RhcnRMaXN0ZW5lcigpIHtcbiAgICAgICAgaWYgKCF0aGlzLnN0YXJ0ZWQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5saXN0ZW5lcikge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnNDb3VudCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubGlzdGVuZXIgPSB0aGlzLmNyZWF0ZUFuZFN0YXJ0TGlzdGVuZXIoKTtcbiAgICB9XG5cbiAgICBjcmVhdGVBbmRTdGFydExpc3RlbmVyKCk6IEFyYW5nb0xpc3RlbmVyIHtcbiAgICAgICAgY29uc3QgeyBzZXJ2ZXIsIG5hbWUsIGF1dGggfSA9IHRoaXMuY29uZmlnO1xuICAgICAgICBjb25zdCBsaXN0ZW5lclVybCA9IGAke2Vuc3VyZVByb3RvY29sKHNlcnZlciwgJ2h0dHAnKX0vJHtuYW1lfWA7XG5cbiAgICAgICAgY29uc3QgbGlzdGVuZXIgPSBuZXcgYXJhbmdvY2hhaXIobGlzdGVuZXJVcmwpO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5hdXRoKSB7XG4gICAgICAgICAgICBjb25zdCB1c2VyUGFzc3dvcmQgPSBCdWZmZXIuZnJvbShhdXRoKS50b1N0cmluZygnYmFzZTY0Jyk7XG4gICAgICAgICAgICBsaXN0ZW5lci5yZXEub3B0cy5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10gPSBgQmFzaWMgJHt1c2VyUGFzc3dvcmR9YDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnNGb3JTdWJzY3JpYmUuZm9yRWFjaCgoY29sbGVjdGlvbk5hbWUpID0+IHtcbiAgICAgICAgICAgIGxpc3RlbmVyLnN1YnNjcmliZSh7IGNvbGxlY3Rpb246IGNvbGxlY3Rpb25OYW1lIH0pO1xuICAgICAgICAgICAgbGlzdGVuZXIub24oY29sbGVjdGlvbk5hbWUsIChkb2NKc29uLCB0eXBlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdpbnNlcnQvdXBkYXRlJyB8fCB0eXBlID09PSAnaW5zZXJ0JyB8fCB0eXBlID09PSAndXBkYXRlJykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uRGF0YUV2ZW50KHR5cGUsIGNvbGxlY3Rpb25OYW1lLCBkb2NKc29uKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSlcblxuICAgICAgICBsaXN0ZW5lci5vbignZXJyb3InLCAoZXJyLCBzdGF0dXMsIGhlYWRlcnMsIGJvZHkpID0+IHtcbiAgICAgICAgICAgIGxldCBlcnJvciA9IGVycjtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgZXJyb3IgPSBKU09OLnBhcnNlKGJvZHkpO1xuICAgICAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignRkFJTEVEJywgJ0xJU1RFTicsIGAke2Vycn1gLCBlcnJvcik7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGxpc3RlbmVyLnN0YXJ0KCksIHRoaXMuY29uZmlnLmxpc3RlbmVyUmVzdGFydFRpbWVvdXQgfHwgMTAwMCk7XG4gICAgICAgIH0pO1xuICAgICAgICBsaXN0ZW5lci5zdGFydCgpO1xuICAgICAgICByZXR1cm4gbGlzdGVuZXI7XG4gICAgfVxuXG4gICAgb25EYXRhRXZlbnQoZXZlbnQ6IFFEYXRhRXZlbnQsIGNvbGxlY3Rpb246IHN0cmluZywgZG9jOiBRRG9jKSB7XG4gICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVycz8uZW1pdChjb2xsZWN0aW9uLCBkb2MsIGV2ZW50KTtcbiAgICB9XG5cbn1cbiJdfQ==