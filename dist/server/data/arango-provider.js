"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ArangoProvider = void 0;

var _arangochair = _interopRequireDefault(require("arangochair"));

var _arangojs = require("arangojs");

var _events = _interopRequireDefault(require("events"));

var _config = require("../config");

var _data = require("./data");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class ArangoProvider {
  constructor(log, segment, config) {
    this.log = log;
    this.segment = segment;
    this.config = config;
    this.started = false;
    this.arango = new _arangojs.Database({
      url: `${(0, _config.ensureProtocol)(config.server, 'http')}`,
      agentOptions: {
        maxSockets: config.maxSockets
      }
    });
    this.arango.useDatabase(config.name);

    if (config.auth) {
      const authParts = config.auth.split(':');
      this.arango.useBasicAuth(authParts[0], authParts.slice(1).join(':'));
    }

    this.listener = this.createListener();
    this.listenerSubscribers = new _events.default();
    this.listenerSubscribers.setMaxListeners(0);
    this.listenerStarted = false;
    this.listenerSubscribersCount = 0;
  }

  start() {
    this.started = true;
    this.checkStartListener();
  }

  getCollectionIndexes(collection) {
    return this.arango.collection(collection).indexes();
  }

  async query(text, vars) {
    const cursor = await this.arango.query(text, vars);
    return cursor.all();
  }

  async subscribe(collection, listener) {
    var _this$listenerSubscri;

    (_this$listenerSubscri = this.listenerSubscribers) === null || _this$listenerSubscri === void 0 ? void 0 : _this$listenerSubscri.on(collection, listener);
    this.listenerSubscribersCount += 1;
    this.checkStartListener();
    return {
      collection,
      listener
    };
  }

  unsubscribe(subscription) {
    var _this$listenerSubscri2;

    (_this$listenerSubscri2 = this.listenerSubscribers) === null || _this$listenerSubscri2 === void 0 ? void 0 : _this$listenerSubscri2.removeListener(subscription.collection, subscription.listener);
    this.listenerSubscribersCount = Math.max(this.listenerSubscribersCount - 1, 0);
  } // Internals


  checkStartListener() {
    if (this.started && !this.listenerStarted && this.listenerSubscribersCount > 0) {
      this.listenerStarted = true;
      this.listener.start();
    }
  }

  createListener() {
    const {
      server,
      name,
      auth
    } = this.config;
    const listenerUrl = `${(0, _config.ensureProtocol)(server, 'http')}/${name}`;
    const listener = new _arangochair.default(listenerUrl);

    if (this.config.auth) {
      const userPassword = Buffer.from(auth).toString('base64');
      listener.req.opts.headers['Authorization'] = `Basic ${userPassword}`;
    }

    Object.values(_data.dataCollectionInfo).forEach(value => {
      const collectionInfo = value;
      const collectionName = collectionInfo.name;
      listener.subscribe({
        collection: collectionName
      });
      listener.on(collectionName, (docJson, type) => {
        if (type === 'insert/update' || type === 'insert' || type === 'update') {
          this.onDataEvent(type, collectionName, docJson);
        }
      });
    });
    listener.on('error', (err, status, headers, body) => {
      let error = err;

      try {
        error = JSON.parse(body);
      } catch {}

      this.log.error('FAILED', 'LISTEN', `${err}`, error);
      setTimeout(() => listener.start(), this.config.listenerRestartTimeout || 1000);
    });
    return listener;
  }

  onDataEvent(event, collection, doc) {
    var _this$listenerSubscri3;

    (_this$listenerSubscri3 = this.listenerSubscribers) === null || _this$listenerSubscri3 === void 0 ? void 0 : _this$listenerSubscri3.emit(collection, doc, event);
  }

}

exports.ArangoProvider = ArangoProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9hcmFuZ28tcHJvdmlkZXIuanMiXSwibmFtZXMiOlsiQXJhbmdvUHJvdmlkZXIiLCJjb25zdHJ1Y3RvciIsImxvZyIsInNlZ21lbnQiLCJjb25maWciLCJzdGFydGVkIiwiYXJhbmdvIiwiRGF0YWJhc2UiLCJ1cmwiLCJzZXJ2ZXIiLCJhZ2VudE9wdGlvbnMiLCJtYXhTb2NrZXRzIiwidXNlRGF0YWJhc2UiLCJuYW1lIiwiYXV0aCIsImF1dGhQYXJ0cyIsInNwbGl0IiwidXNlQmFzaWNBdXRoIiwic2xpY2UiLCJqb2luIiwibGlzdGVuZXIiLCJjcmVhdGVMaXN0ZW5lciIsImxpc3RlbmVyU3Vic2NyaWJlcnMiLCJFdmVudEVtaXR0ZXIiLCJzZXRNYXhMaXN0ZW5lcnMiLCJsaXN0ZW5lclN0YXJ0ZWQiLCJsaXN0ZW5lclN1YnNjcmliZXJzQ291bnQiLCJzdGFydCIsImNoZWNrU3RhcnRMaXN0ZW5lciIsImdldENvbGxlY3Rpb25JbmRleGVzIiwiY29sbGVjdGlvbiIsImluZGV4ZXMiLCJxdWVyeSIsInRleHQiLCJ2YXJzIiwiY3Vyc29yIiwiYWxsIiwic3Vic2NyaWJlIiwib24iLCJ1bnN1YnNjcmliZSIsInN1YnNjcmlwdGlvbiIsInJlbW92ZUxpc3RlbmVyIiwiTWF0aCIsIm1heCIsImxpc3RlbmVyVXJsIiwiYXJhbmdvY2hhaXIiLCJ1c2VyUGFzc3dvcmQiLCJCdWZmZXIiLCJmcm9tIiwidG9TdHJpbmciLCJyZXEiLCJvcHRzIiwiaGVhZGVycyIsIk9iamVjdCIsInZhbHVlcyIsImRhdGFDb2xsZWN0aW9uSW5mbyIsImZvckVhY2giLCJ2YWx1ZSIsImNvbGxlY3Rpb25JbmZvIiwiY29sbGVjdGlvbk5hbWUiLCJkb2NKc29uIiwidHlwZSIsIm9uRGF0YUV2ZW50IiwiZXJyIiwic3RhdHVzIiwiYm9keSIsImVycm9yIiwiSlNPTiIsInBhcnNlIiwic2V0VGltZW91dCIsImxpc3RlbmVyUmVzdGFydFRpbWVvdXQi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d0U7QUFDcEUsZUFBS0MsV0FBTCxDQUFpQkQsSUFBakIsRUFBdUJGLGNBQXZCLEVBQXVDQyxPQUF2QztBQUNIO0FBQ0osT0FKRDtBQUtILEtBVEQ7QUFXQXhDLElBQUFBLFFBQVEsQ0FBQ2tCLEVBQVQsQ0FBWSxPQUFaLEVBQXFCLENBQUN5QixHQUFELEVBQU1DLE1BQU4sRUFBY1osT0FBZCxFQUF1QmEsSUFBdkIsS0FBZ0M7QUFDakQsVUFBSUMsS0FBSyxHQUFHSCxHQUFaOztBQUNBLFVBQUk7QUFDQUcsUUFBQUEsS0FBSyxHQUFHQyxJQUFJLENBQUNDLEtBQUwsQ0FBV0gsSUFBWCxDQUFSO0FBQ0gsT0FGRCxDQUVFLE1BQU0sQ0FDUDs7QUFDRCxXQUFLL0QsR0FBTCxDQUFTZ0UsS0FBVCxDQUFlLFFBQWYsRUFBeUIsUUFBekIsRUFBb0MsR0FBRUgsR0FBSSxFQUExQyxFQUE2Q0csS0FBN0M7QUFDQUcsTUFBQUEsVUFBVSxDQUFDLE1BQU1qRCxRQUFRLENBQUNPLEtBQVQsRUFBUCxFQUF5QixLQUFLdkIsTUFBTCxDQUFZa0Usc0JBQVosSUFBc0MsSUFBL0QsQ0FBVjtBQUNILEtBUkQ7QUFTQSxXQUFPbEQsUUFBUDtBQUNIOztBQUVEMEMsRUFBQUEsV0FBVyxDQUFDUyxLQUFELEVBQW9CekMsVUFBcEIsRUFBd0MwQyxHQUF4QyxFQUFtRDtBQUFBOztBQUMxRCxtQ0FBS2xELG1CQUFMLGtGQUEwQm1ELElBQTFCLENBQStCM0MsVUFBL0IsRUFBMkMwQyxHQUEzQyxFQUFnREQsS0FBaEQ7QUFDSDs7QUFwSGdEIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcbmltcG9ydCBhcmFuZ29jaGFpciBmcm9tICdhcmFuZ29jaGFpcic7XG5pbXBvcnQgeyBEYXRhYmFzZSB9IGZyb20gJ2FyYW5nb2pzJztcbmltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IGVuc3VyZVByb3RvY29sIH0gZnJvbSAnLi4vY29uZmlnJztcbmltcG9ydCB0eXBlIHsgUUFyYW5nb0NvbmZpZyB9IGZyb20gJy4uL2NvbmZpZyc7XG5pbXBvcnQgdHlwZSB7IFFMb2cgfSBmcm9tICcuLi9sb2dzJztcbmltcG9ydCB7IGRhdGFDb2xsZWN0aW9uSW5mbyB9IGZyb20gJy4vZGF0YSc7XG5pbXBvcnQgdHlwZSB7IFFEYXRhRXZlbnQsIFFEYXRhUHJvdmlkZXIsIFFEYXRhU2VnbWVudCwgUURvYywgUUNvbGxlY3Rpb25JbmZvLCBRSW5kZXhJbmZvIH0gZnJvbSAnLi9kYXRhJztcblxudHlwZSBBcmFuZ29FdmVudEhhbmRsZXIgPSAoZXJyOiBhbnksIHN0YXR1czogc3RyaW5nLCBoZWFkZXJzOiB7IFtzdHJpbmddOiBhbnkgfSwgYm9keTogc3RyaW5nKSA9PiB2b2lkO1xuXG5pbnRlcmZhY2UgQXJhbmdvTGlzdGVuZXIge1xuICAgIHJlcToge1xuICAgICAgICBvcHRzOiB7XG4gICAgICAgICAgICBoZWFkZXJzOiB7IFtzdHJpbmddOiBhbnkgfSxcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBvbihldmVudDogc3RyaW5nLCBoYW5kbGVyOiBBcmFuZ29FdmVudEhhbmRsZXIpOiB2b2lkO1xuXG4gICAgc3Vic2NyaWJlKHBhcmFtczogeyBjb2xsZWN0aW9uOiBzdHJpbmcgfSk6IHZvaWQ7XG5cbiAgICBzdGFydCgpOiB2b2lkO1xufVxuXG5leHBvcnQgY2xhc3MgQXJhbmdvUHJvdmlkZXIgaW1wbGVtZW50cyBRRGF0YVByb3ZpZGVyIHtcbiAgICBsb2c6IFFMb2c7XG4gICAgc2VnbWVudDogUURhdGFTZWdtZW50O1xuICAgIGNvbmZpZzogUUFyYW5nb0NvbmZpZztcblxuICAgIHN0YXJ0ZWQ6IGJvb2xlYW47XG4gICAgYXJhbmdvOiBEYXRhYmFzZTtcbiAgICBsaXN0ZW5lcjogQXJhbmdvTGlzdGVuZXI7XG4gICAgbGlzdGVuZXJTdWJzY3JpYmVyczogRXZlbnRFbWl0dGVyO1xuICAgIGxpc3RlbmVyU3Vic2NyaWJlcnNDb3VudDogbnVtYmVyO1xuICAgIGxpc3RlbmVyU3RhcnRlZDogYm9vbGVhbjtcblxuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIGxvZzogUUxvZyxcbiAgICAgICAgc2VnbWVudDogUURhdGFTZWdtZW50LFxuICAgICAgICBjb25maWc6IFFBcmFuZ29Db25maWcsXG4gICAgKSB7XG4gICAgICAgIHRoaXMubG9nID0gbG9nO1xuICAgICAgICB0aGlzLnNlZ21lbnQgPSBzZWdtZW50O1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcblxuICAgICAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5hcmFuZ28gPSBuZXcgRGF0YWJhc2Uoe1xuICAgICAgICAgICAgdXJsOiBgJHtlbnN1cmVQcm90b2NvbChjb25maWcuc2VydmVyLCAnaHR0cCcpfWAsXG4gICAgICAgICAgICBhZ2VudE9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgICBtYXhTb2NrZXRzOiBjb25maWcubWF4U29ja2V0cyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmFyYW5nby51c2VEYXRhYmFzZShjb25maWcubmFtZSk7XG4gICAgICAgIGlmIChjb25maWcuYXV0aCkge1xuICAgICAgICAgICAgY29uc3QgYXV0aFBhcnRzID0gY29uZmlnLmF1dGguc3BsaXQoJzonKTtcbiAgICAgICAgICAgIHRoaXMuYXJhbmdvLnVzZUJhc2ljQXV0aChhdXRoUGFydHNbMF0sIGF1dGhQYXJ0cy5zbGljZSgxKS5qb2luKCc6JykpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubGlzdGVuZXIgPSB0aGlzLmNyZWF0ZUxpc3RlbmVyKCk7XG4gICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVycyA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzLnNldE1heExpc3RlbmVycygwKTtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN0YXJ0ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzQ291bnQgPSAwO1xuICAgIH1cblxuICAgIHN0YXJ0KCkge1xuICAgICAgICB0aGlzLnN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLmNoZWNrU3RhcnRMaXN0ZW5lcigpO1xuICAgIH1cblxuICAgIGdldENvbGxlY3Rpb25JbmRleGVzKGNvbGxlY3Rpb246IHN0cmluZyk6IFByb21pc2U8UUluZGV4SW5mb1tdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFyYW5nby5jb2xsZWN0aW9uKGNvbGxlY3Rpb24pLmluZGV4ZXMoKTtcbiAgICB9XG5cbiAgICBhc3luYyBxdWVyeSh0ZXh0OiBzdHJpbmcsIHZhcnM6IHsgW3N0cmluZ106IGFueSB9KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgY3Vyc29yID0gYXdhaXQgdGhpcy5hcmFuZ28ucXVlcnkodGV4dCwgdmFycyk7XG4gICAgICAgIHJldHVybiBjdXJzb3IuYWxsKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgc3Vic2NyaWJlKGNvbGxlY3Rpb246IHN0cmluZywgbGlzdGVuZXI6IChkb2M6IGFueSwgZXZlbnQ6IFFEYXRhRXZlbnQpID0+IHZvaWQpOiBhbnkge1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnM/Lm9uKGNvbGxlY3Rpb24sIGxpc3RlbmVyKTtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzQ291bnQgKz0gMTtcbiAgICAgICAgdGhpcy5jaGVja1N0YXJ0TGlzdGVuZXIoKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNvbGxlY3Rpb24sXG4gICAgICAgICAgICBsaXN0ZW5lclxuICAgICAgICB9O1xuICAgIH1cblxuXG4gICAgdW5zdWJzY3JpYmUoc3Vic2NyaXB0aW9uOiBhbnkpIHtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzPy5yZW1vdmVMaXN0ZW5lcihzdWJzY3JpcHRpb24uY29sbGVjdGlvbiwgc3Vic2NyaXB0aW9uLmxpc3RlbmVyKTtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzQ291bnQgPSBNYXRoLm1heCh0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnNDb3VudCAtIDEsIDApO1xuICAgIH1cblxuICAgIC8vIEludGVybmFsc1xuXG4gICAgY2hlY2tTdGFydExpc3RlbmVyKCkge1xuICAgICAgICBpZiAodGhpcy5zdGFydGVkICYmICF0aGlzLmxpc3RlbmVyU3RhcnRlZCAmJiB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnNDb3VudCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMubGlzdGVuZXJTdGFydGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMubGlzdGVuZXIuc3RhcnQoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNyZWF0ZUxpc3RlbmVyKCk6IEFyYW5nb0xpc3RlbmVyIHtcbiAgICAgICAgY29uc3QgeyBzZXJ2ZXIsIG5hbWUsIGF1dGggfSA9IHRoaXMuY29uZmlnO1xuICAgICAgICBjb25zdCBsaXN0ZW5lclVybCA9IGAke2Vuc3VyZVByb3RvY29sKHNlcnZlciwgJ2h0dHAnKX0vJHtuYW1lfWA7XG5cbiAgICAgICAgY29uc3QgbGlzdGVuZXIgPSBuZXcgYXJhbmdvY2hhaXIobGlzdGVuZXJVcmwpO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5hdXRoKSB7XG4gICAgICAgICAgICBjb25zdCB1c2VyUGFzc3dvcmQgPSBCdWZmZXIuZnJvbShhdXRoKS50b1N0cmluZygnYmFzZTY0Jyk7XG4gICAgICAgICAgICBsaXN0ZW5lci5yZXEub3B0cy5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10gPSBgQmFzaWMgJHt1c2VyUGFzc3dvcmR9YDtcbiAgICAgICAgfVxuXG4gICAgICAgIE9iamVjdC52YWx1ZXMoZGF0YUNvbGxlY3Rpb25JbmZvKS5mb3JFYWNoKCh2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29sbGVjdGlvbkluZm8gPSAoKHZhbHVlOiBhbnkpOiBRQ29sbGVjdGlvbkluZm8pO1xuICAgICAgICAgICAgY29uc3QgY29sbGVjdGlvbk5hbWUgPSBjb2xsZWN0aW9uSW5mby5uYW1lO1xuICAgICAgICAgICAgbGlzdGVuZXIuc3Vic2NyaWJlKHsgY29sbGVjdGlvbjogY29sbGVjdGlvbk5hbWUgfSk7XG4gICAgICAgICAgICBsaXN0ZW5lci5vbihjb2xsZWN0aW9uTmFtZSwgKGRvY0pzb24sIHR5cGUpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2luc2VydC91cGRhdGUnIHx8IHR5cGUgPT09ICdpbnNlcnQnIHx8IHR5cGUgPT09ICd1cGRhdGUnKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25EYXRhRXZlbnQodHlwZSwgY29sbGVjdGlvbk5hbWUsIGRvY0pzb24pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuXG4gICAgICAgIGxpc3RlbmVyLm9uKCdlcnJvcicsIChlcnIsIHN0YXR1cywgaGVhZGVycywgYm9keSkgPT4ge1xuICAgICAgICAgICAgbGV0IGVycm9yID0gZXJyO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBlcnJvciA9IEpTT04ucGFyc2UoYm9keSk7XG4gICAgICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdGQUlMRUQnLCAnTElTVEVOJywgYCR7ZXJyfWAsIGVycm9yKTtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gbGlzdGVuZXIuc3RhcnQoKSwgdGhpcy5jb25maWcubGlzdGVuZXJSZXN0YXJ0VGltZW91dCB8fCAxMDAwKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBsaXN0ZW5lcjtcbiAgICB9XG5cbiAgICBvbkRhdGFFdmVudChldmVudDogUURhdGFFdmVudCwgY29sbGVjdGlvbjogc3RyaW5nLCBkb2M6IFFEb2MpIHtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzPy5lbWl0KGNvbGxlY3Rpb24sIGRvYywgZXZlbnQpO1xuICAgIH1cblxufVxuIl19