"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ArangoProvider = void 0;

var _arangochair = _interopRequireDefault(require("arangochair"));

var _arangojs = require("arangojs");

var _events = _interopRequireDefault(require("events"));

var _config = require("../config");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class ArangoProvider {
  constructor(log, config) {
    this.log = log;
    this.config = config;
    this.started = false;
    this.arango = new _arangojs.Database({
      url: `${(0, _config.ensureProtocol)(config.server, 'http')}`,
      agentOptions: {
        maxSockets: config.maxSockets
      }
    });
    this.arango.useDatabase(config.name);

    if (config.auth) {
      const authParts = config.auth.split(':');
      this.arango.useBasicAuth(authParts[0], authParts.slice(1).join(':'));
    }

    this.collectionsForSubscribe = [];
    this.listener = this.createListener();
    this.listenerSubscribers = new _events.default();
    this.listenerSubscribers.setMaxListeners(0);
    this.listenerStarted = false;
    this.listenerSubscribersCount = 0;
  }

  start(collectionsForSubscribe) {
    this.started = true;
    this.collectionsForSubscribe = collectionsForSubscribe;
    this.checkStartListener();
  }

  getCollectionIndexes(collection) {
    return this.arango.collection(collection).indexes();
  }

  async query(text, vars) {
    const cursor = await this.arango.query(text, vars);
    return cursor.all();
  }

  async subscribe(collection, listener) {
    var _this$listenerSubscri;

    (_this$listenerSubscri = this.listenerSubscribers) === null || _this$listenerSubscri === void 0 ? void 0 : _this$listenerSubscri.on(collection, listener);
    this.listenerSubscribersCount += 1;
    this.checkStartListener();
    return {
      collection,
      listener
    };
  }

  unsubscribe(subscription) {
    var _this$listenerSubscri2;

    (_this$listenerSubscri2 = this.listenerSubscribers) === null || _this$listenerSubscri2 === void 0 ? void 0 : _this$listenerSubscri2.removeListener(subscription.collection, subscription.listener);
    this.listenerSubscribersCount = Math.max(this.listenerSubscribersCount - 1, 0);
  } // Internals


  checkStartListener() {
    if (!this.started) {
      return;
    }

    if (this.listenerStarted) {
      return;
    }

    if (this.collectionsForSubscribe.length === 0) {
      return;
    }

    if (this.listenerSubscribersCount === 0) {
      return;
    }

    this.listenerStarted = true;
    this.listener.start();
  }

  createListener() {
    const {
      server,
      name,
      auth
    } = this.config;
    const listenerUrl = `${(0, _config.ensureProtocol)(server, 'http')}/${name}`;
    const listener = new _arangochair.default(listenerUrl);

    if (this.config.auth) {
      const userPassword = Buffer.from(auth).toString('base64');
      listener.req.opts.headers['Authorization'] = `Basic ${userPassword}`;
    }

    this.collectionsForSubscribe.forEach(collectionName => {
      listener.subscribe({
        collection: collectionName
      });
      listener.on(collectionName, (docJson, type) => {
        if (type === 'insert/update' || type === 'insert' || type === 'update') {
          this.onDataEvent(type, collectionName, docJson);
        }
      });
    });
    listener.on('error', (err, status, headers, body) => {
      let error = err;

      try {
        error = JSON.parse(body);
      } catch {}

      this.log.error('FAILED', 'LISTEN', `${err}`, error);
      setTimeout(() => listener.start(), this.config.listenerRestartTimeout || 1000);
    });
    return listener;
  }

  onDataEvent(event, collection, doc) {
    var _this$listenerSubscri3;

    (_this$listenerSubscri3 = this.listenerSubscribers) === null || _this$listenerSubscri3 === void 0 ? void 0 : _this$listenerSubscri3.emit(collection, doc, event);
  }

}

exports.ArangoProvider = ArangoProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9hcmFuZ28tcHJvdmlkZXIuanMiXSwibmFtZXMiOlsiQXJhbmdvUHJvdmlkZXIiLCJjb25zdHJ1Y3RvciIsImxvZyIsImNvbmZpZyIsInN0YXJ0ZWQiLCJhcmFuZ28iLCJEYXRhYmFzZSIsInVybCIsInNlcnZlciIsImFnZW50T3B0aW9ucyIsIm1heFNvY2tldHMiLCJ1c2VEYXRhYmFzZSIsIm5hbWUiLCJhdXRoIiwiYXV0aFBhcnRzIiwic3BsaXQiLCJ1c2VCYXNpY0F1dGgiLCJzbGljZSIsImpvaW4iLCJjb2xsZWN0aW9uc0ZvclN1YnNjcmliZSIsImxpc3RlbmVyIiwiY3JlYXRlTGlzdGVuZXIiLCJsaXN0ZW5lclN1YnNjcmliZXJzIiwiRXZlbnRFbWl0dGVyIiwic2V0TWF4TGlzdGVuZXJzIiwibGlzdGVuZXJTdGFydGVkIiwibGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50Iiwic3RhcnQiLCJjaGVja1N0YXJ0TGlzdGVuZXIiLCJnZXRDb2xsZWN0aW9uSW5kZXhlcyIsImNvbGxlY3Rpb24iLCJpbmRleGVzIiwicXVlcnkiLCJ0ZXh0IiwidmFycyIsImN1cnNvciIsImFsbCIsInN1YnNjcmliZSIsIm9uIiwidW5zdWJzY3JpYmUiLCJzdWJzY3JpcHRpb24iLCJyZW1vdmVMaXN0ZW5lciIsIk1hdGgiLCJtYXgiLCJsZW5ndGgiLCJsaXN0ZW5lclVybCIsImFyYW5nb2NoYWlyIiwidXNlclBhc3N3b3JkIiwiQnVmZmVyIiwiZnJvbSIsInRvU3RyaW5nIiwicmVxIiwib3B0cyIsImhlYWRlcnMiLCJmb3JFYWNoIiwiY29sbGVjdGlvbk5hbWUiLCJkb2NKc29uIiwidHlwZSIsIm9uRGF0YUV2ZW50IiwiZXJyIiwic3RhdHVzIiwiYm9keSIsImVycm9yIiwiSlNPTiIsInBhcnNlIiwic2V0VGltZW91dCIsImxpc3RlbmVyUmVzdGFydFRpbWVvdXQiLCJldmVudCIsImRvYyIsImVtaXQiXSwibWFwcGluZ3MiOiI7Ozs7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SUFBSSxLQUFLLFFBQTlELEVBQXdFO0FBQ3BFLGVBQUtDLFdBQUwsQ0FBaUJELElBQWpCLEVBQXVCRixjQUF2QixFQUF1Q0MsT0FBdkM7QUFDSDtBQUNKLE9BSkQ7QUFLSCxLQVBEO0FBU0FwQyxJQUFBQSxRQUFRLENBQUNrQixFQUFULENBQVksT0FBWixFQUFxQixDQUFDcUIsR0FBRCxFQUFNQyxNQUFOLEVBQWNQLE9BQWQsRUFBdUJRLElBQXZCLEtBQWdDO0FBQ2pELFVBQUlDLEtBQUssR0FBR0gsR0FBWjs7QUFDQSxVQUFJO0FBQ0FHLFFBQUFBLEtBQUssR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVdILElBQVgsQ0FBUjtBQUNILE9BRkQsQ0FFRSxNQUFNLENBQ1A7O0FBQ0QsV0FBSzNELEdBQUwsQ0FBUzRELEtBQVQsQ0FBZSxRQUFmLEVBQXlCLFFBQXpCLEVBQW9DLEdBQUVILEdBQUksRUFBMUMsRUFBNkNHLEtBQTdDO0FBQ0FHLE1BQUFBLFVBQVUsQ0FBQyxNQUFNN0MsUUFBUSxDQUFDTyxLQUFULEVBQVAsRUFBeUIsS0FBS3hCLE1BQUwsQ0FBWStELHNCQUFaLElBQXNDLElBQS9ELENBQVY7QUFDSCxLQVJEO0FBU0EsV0FBTzlDLFFBQVA7QUFDSDs7QUFFRHNDLEVBQUFBLFdBQVcsQ0FBQ1MsS0FBRCxFQUFvQnJDLFVBQXBCLEVBQXdDc0MsR0FBeEMsRUFBbUQ7QUFBQTs7QUFDMUQsbUNBQUs5QyxtQkFBTCxrRkFBMEIrQyxJQUExQixDQUErQnZDLFVBQS9CLEVBQTJDc0MsR0FBM0MsRUFBZ0RELEtBQWhEO0FBQ0g7O0FBekhnRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5pbXBvcnQgYXJhbmdvY2hhaXIgZnJvbSAnYXJhbmdvY2hhaXInO1xuaW1wb3J0IHsgRGF0YWJhc2UgfSBmcm9tICdhcmFuZ29qcyc7XG5pbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgeyBlbnN1cmVQcm90b2NvbCB9IGZyb20gJy4uL2NvbmZpZyc7XG5pbXBvcnQgdHlwZSB7IFFBcmFuZ29Db25maWcgfSBmcm9tICcuLi9jb25maWcnO1xuaW1wb3J0IHR5cGUgeyBRTG9nIH0gZnJvbSAnLi4vbG9ncyc7XG5pbXBvcnQgdHlwZSB7IFFEYXRhRXZlbnQsIFFEYXRhUHJvdmlkZXIsIFFEb2MsIFFJbmRleEluZm8gfSBmcm9tICcuL2RhdGEtcHJvdmlkZXInO1xuXG50eXBlIEFyYW5nb0V2ZW50SGFuZGxlciA9IChlcnI6IGFueSwgc3RhdHVzOiBzdHJpbmcsIGhlYWRlcnM6IHsgW3N0cmluZ106IGFueSB9LCBib2R5OiBzdHJpbmcpID0+IHZvaWQ7XG5cbmludGVyZmFjZSBBcmFuZ29MaXN0ZW5lciB7XG4gICAgcmVxOiB7XG4gICAgICAgIG9wdHM6IHtcbiAgICAgICAgICAgIGhlYWRlcnM6IHsgW3N0cmluZ106IGFueSB9LFxuICAgICAgICB9XG4gICAgfTtcblxuICAgIG9uKGV2ZW50OiBzdHJpbmcsIGhhbmRsZXI6IEFyYW5nb0V2ZW50SGFuZGxlcik6IHZvaWQ7XG5cbiAgICBzdWJzY3JpYmUocGFyYW1zOiB7IGNvbGxlY3Rpb246IHN0cmluZyB9KTogdm9pZDtcblxuICAgIHN0YXJ0KCk6IHZvaWQ7XG59XG5cbmV4cG9ydCBjbGFzcyBBcmFuZ29Qcm92aWRlciBpbXBsZW1lbnRzIFFEYXRhUHJvdmlkZXIge1xuICAgIGxvZzogUUxvZztcbiAgICBjb25maWc6IFFBcmFuZ29Db25maWc7XG5cbiAgICBzdGFydGVkOiBib29sZWFuO1xuICAgIGFyYW5nbzogRGF0YWJhc2U7XG4gICAgY29sbGVjdGlvbnNGb3JTdWJzY3JpYmU6IHN0cmluZ1tdO1xuICAgIGxpc3RlbmVyOiBBcmFuZ29MaXN0ZW5lcjtcbiAgICBsaXN0ZW5lclN1YnNjcmliZXJzOiBFdmVudEVtaXR0ZXI7XG4gICAgbGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50OiBudW1iZXI7XG4gICAgbGlzdGVuZXJTdGFydGVkOiBib29sZWFuO1xuXG5cbiAgICBjb25zdHJ1Y3Rvcihsb2c6IFFMb2csIGNvbmZpZzogUUFyYW5nb0NvbmZpZykge1xuICAgICAgICB0aGlzLmxvZyA9IGxvZztcbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG5cbiAgICAgICAgdGhpcy5zdGFydGVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuYXJhbmdvID0gbmV3IERhdGFiYXNlKHtcbiAgICAgICAgICAgIHVybDogYCR7ZW5zdXJlUHJvdG9jb2woY29uZmlnLnNlcnZlciwgJ2h0dHAnKX1gLFxuICAgICAgICAgICAgYWdlbnRPcHRpb25zOiB7XG4gICAgICAgICAgICAgICAgbWF4U29ja2V0czogY29uZmlnLm1heFNvY2tldHMsXG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5hcmFuZ28udXNlRGF0YWJhc2UoY29uZmlnLm5hbWUpO1xuICAgICAgICBpZiAoY29uZmlnLmF1dGgpIHtcbiAgICAgICAgICAgIGNvbnN0IGF1dGhQYXJ0cyA9IGNvbmZpZy5hdXRoLnNwbGl0KCc6Jyk7XG4gICAgICAgICAgICB0aGlzLmFyYW5nby51c2VCYXNpY0F1dGgoYXV0aFBhcnRzWzBdLCBhdXRoUGFydHMuc2xpY2UoMSkuam9pbignOicpKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlID0gW107XG4gICAgICAgIHRoaXMubGlzdGVuZXIgPSB0aGlzLmNyZWF0ZUxpc3RlbmVyKCk7XG4gICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVycyA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzLnNldE1heExpc3RlbmVycygwKTtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN0YXJ0ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzQ291bnQgPSAwO1xuICAgIH1cblxuICAgIHN0YXJ0KGNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlOiBzdHJpbmdbXSkge1xuICAgICAgICB0aGlzLnN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlID0gY29sbGVjdGlvbnNGb3JTdWJzY3JpYmU7XG4gICAgICAgIHRoaXMuY2hlY2tTdGFydExpc3RlbmVyKCk7XG4gICAgfVxuXG4gICAgZ2V0Q29sbGVjdGlvbkluZGV4ZXMoY29sbGVjdGlvbjogc3RyaW5nKTogUHJvbWlzZTxRSW5kZXhJbmZvW10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXJhbmdvLmNvbGxlY3Rpb24oY29sbGVjdGlvbikuaW5kZXhlcygpO1xuICAgIH1cblxuICAgIGFzeW5jIHF1ZXJ5KHRleHQ6IHN0cmluZywgdmFyczogeyBbc3RyaW5nXTogYW55IH0pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCBjdXJzb3IgPSBhd2FpdCB0aGlzLmFyYW5nby5xdWVyeSh0ZXh0LCB2YXJzKTtcbiAgICAgICAgcmV0dXJuIGN1cnNvci5hbGwoKTtcbiAgICB9XG5cbiAgICBhc3luYyBzdWJzY3JpYmUoY29sbGVjdGlvbjogc3RyaW5nLCBsaXN0ZW5lcjogKGRvYzogYW55LCBldmVudDogUURhdGFFdmVudCkgPT4gdm9pZCk6IGFueSB7XG4gICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVycz8ub24oY29sbGVjdGlvbiwgbGlzdGVuZXIpO1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnNDb3VudCArPSAxO1xuICAgICAgICB0aGlzLmNoZWNrU3RhcnRMaXN0ZW5lcigpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY29sbGVjdGlvbixcbiAgICAgICAgICAgIGxpc3RlbmVyXG4gICAgICAgIH07XG4gICAgfVxuXG5cbiAgICB1bnN1YnNjcmliZShzdWJzY3JpcHRpb246IGFueSkge1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnM/LnJlbW92ZUxpc3RlbmVyKHN1YnNjcmlwdGlvbi5jb2xsZWN0aW9uLCBzdWJzY3JpcHRpb24ubGlzdGVuZXIpO1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnNDb3VudCA9IE1hdGgubWF4KHRoaXMubGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50IC0gMSwgMCk7XG4gICAgfVxuXG4gICAgLy8gSW50ZXJuYWxzXG5cbiAgICBjaGVja1N0YXJ0TGlzdGVuZXIoKSB7XG4gICAgICAgIGlmICghdGhpcy5zdGFydGVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubGlzdGVuZXJTdGFydGVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbnNGb3JTdWJzY3JpYmUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50ID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5saXN0ZW5lclN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLmxpc3RlbmVyLnN0YXJ0KCk7XG4gICAgfVxuXG4gICAgY3JlYXRlTGlzdGVuZXIoKTogQXJhbmdvTGlzdGVuZXIge1xuICAgICAgICBjb25zdCB7IHNlcnZlciwgbmFtZSwgYXV0aCB9ID0gdGhpcy5jb25maWc7XG4gICAgICAgIGNvbnN0IGxpc3RlbmVyVXJsID0gYCR7ZW5zdXJlUHJvdG9jb2woc2VydmVyLCAnaHR0cCcpfS8ke25hbWV9YDtcblxuICAgICAgICBjb25zdCBsaXN0ZW5lciA9IG5ldyBhcmFuZ29jaGFpcihsaXN0ZW5lclVybCk7XG5cbiAgICAgICAgaWYgKHRoaXMuY29uZmlnLmF1dGgpIHtcbiAgICAgICAgICAgIGNvbnN0IHVzZXJQYXNzd29yZCA9IEJ1ZmZlci5mcm9tKGF1dGgpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgICAgICAgICAgIGxpc3RlbmVyLnJlcS5vcHRzLmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXSA9IGBCYXNpYyAke3VzZXJQYXNzd29yZH1gO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jb2xsZWN0aW9uc0ZvclN1YnNjcmliZS5mb3JFYWNoKChjb2xsZWN0aW9uTmFtZSkgPT4ge1xuICAgICAgICAgICAgbGlzdGVuZXIuc3Vic2NyaWJlKHsgY29sbGVjdGlvbjogY29sbGVjdGlvbk5hbWUgfSk7XG4gICAgICAgICAgICBsaXN0ZW5lci5vbihjb2xsZWN0aW9uTmFtZSwgKGRvY0pzb24sIHR5cGUpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2luc2VydC91cGRhdGUnIHx8IHR5cGUgPT09ICdpbnNlcnQnIHx8IHR5cGUgPT09ICd1cGRhdGUnKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25EYXRhRXZlbnQodHlwZSwgY29sbGVjdGlvbk5hbWUsIGRvY0pzb24pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuXG4gICAgICAgIGxpc3RlbmVyLm9uKCdlcnJvcicsIChlcnIsIHN0YXR1cywgaGVhZGVycywgYm9keSkgPT4ge1xuICAgICAgICAgICAgbGV0IGVycm9yID0gZXJyO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBlcnJvciA9IEpTT04ucGFyc2UoYm9keSk7XG4gICAgICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdGQUlMRUQnLCAnTElTVEVOJywgYCR7ZXJyfWAsIGVycm9yKTtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gbGlzdGVuZXIuc3RhcnQoKSwgdGhpcy5jb25maWcubGlzdGVuZXJSZXN0YXJ0VGltZW91dCB8fCAxMDAwKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBsaXN0ZW5lcjtcbiAgICB9XG5cbiAgICBvbkRhdGFFdmVudChldmVudDogUURhdGFFdmVudCwgY29sbGVjdGlvbjogc3RyaW5nLCBkb2M6IFFEb2MpIHtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzPy5lbWl0KGNvbGxlY3Rpb24sIGRvYywgZXZlbnQpO1xuICAgIH1cblxufVxuIl19