"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.QDataSubscription = exports.QDataListener = void 0;

var _iterall = require("iterall");

var _filters = require("../filter/filters");

class QDataListener {
  constructor(collectionName, docType, accessRights, filter) {
    this.docType = docType;
    this.authFilter = QDataListener.getAuthFilter(collectionName, accessRights);
    this.filter = filter;
  }

  static getAuthFilter(collectionName, accessRights) {
    if (accessRights.restrictToAccounts.length === 0) {
      return null;
    }

    const accounts = new Set(accessRights.restrictToAccounts);

    switch (collectionName) {
      case 'accounts':
        return doc => accounts.has(doc._key);

      case 'transactions':
        return doc => accounts.has(doc.account_addr);

      case 'messages':
        return doc => accounts.has(doc.src) || accounts.has(doc.dst);

      default:
        return _ => false;
    }
  }

  isFiltered(doc) {
    if (this.authFilter && !this.authFilter(doc)) {
      return false;
    }

    return this.docType.test(null, doc, this.filter);
  }

} //$FlowFixMe


exports.QDataListener = QDataListener;

class QDataSubscription extends QDataListener {
  constructor(collectionName, docType, accessRights, filter, selection) {
    super(collectionName, docType, accessRights, filter);
    this.collectionName = collectionName;
    this.selection = selection;
    this.pullQueue = [];
    this.pushQueue = [];
    this.running = true;
    this.onClose = null;
  }

  pushDocument(doc) {
    if (this.isFiltered(doc) && !this.isQueueOverflow()) {
      const reduced = (0, _filters.selectFields)(doc, this.selection);
      this.pushValue({
        [this.collectionName]: reduced
      });
    }
  }

  isQueueOverflow() {
    return this.getQueueSize() >= 10;
  }

  getQueueSize() {
    return this.pushQueue.length + this.pullQueue.length;
  }

  pushValue(value) {
    if (this.pullQueue.length !== 0) {
      this.pullQueue.shift()(this.running ? {
        value,
        done: false
      } : {
        value: undefined,
        done: true
      });
    } else {
      this.pushQueue.push(value);
    }
  }

  async next() {
    return new Promise(resolve => {
      if (this.pushQueue.length !== 0) {
        resolve(this.running ? {
          value: this.pushQueue.shift(),
          done: false
        } : {
          value: undefined,
          done: true
        });
      } else {
        this.pullQueue.push(resolve);
      }
    });
  }

  async return() {
    if (this.onClose) {
      this.onClose();
    }

    await this.emptyQueue();
    return {
      value: undefined,
      done: true
    };
  }

  async throw(error) {
    if (this.onClose) {
      this.onClose();
    }

    await this.emptyQueue();
    return Promise.reject(error);
  } //$FlowFixMe


  [_iterall.$$asyncIterator]() {
    return this;
  }

  async emptyQueue() {
    if (this.running) {
      this.running = false;
      this.pullQueue.forEach(resolve => resolve({
        value: undefined,
        done: true
      }));
      this.pullQueue = [];
      this.pushQueue = [];
    }
  }

}

exports.QDataSubscription = QDataSubscription;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9saXN0ZW5lci5qcyJdLCJuYW1lcyI6WyJRRGF0YUxpc3RlbmVyIiwiY29uc3RydWN0b3IiLCJjb2xsZWN0aW9uTmFtZSIsImRvY1R5cGUiLCJhY2Nlc3NSaWdodHMiLCJmaWx0ZXIiLCJhdXRoRmlsdGVyIiwiZ2V0QXV0aEZpbHRlciIsInJlc3RyaWN0VG9BY2NvdW50cyIsImxlbmd0aCIsImFjY291bnRzIiwiU2V0IiwiZG9jIiwiaGFzIiwiX2tleSIsImFjY291bnRfYWRkciIsInNyYyIsImRzdCIsIl8iLCJpc0ZpbHRlcmVkIiwidGVzdCIsIlFEYXRhU3Vic2NyaXB0aW9uIiwic2VsZWN0aW9uIiwicHVsbFF1ZXVlIiwicHVzaFF1ZXVlIiwicnVubmluZyIsIm9uQ2xvc2UiLCJwdXNoRG9jdW1lbnQiLCJpc1F1ZXVlT3ZlcmZsb3ciLCJyZWR1Y2VkIiwicHVzaFZhbHVlIiwiZ2V0UXVldWVTaXplIiwidmFsdWUiLCJzaGlmdCIsImRvbmUiLCJ1bmRlZmluZWQiLCJwdXNoIiwibmV4dCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmV0dXJuIiwiZW1wdHlRdWV1ZSIsInRocm93IiwiZXJyb3IiLCJyZWplY3QiLCIkJGFzeW5jSXRlcmF0b3IiLCJmb3JFYWNoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7O0FBRUE7O0FBR08sTUFBTUEsYUFBTixDQUFvQjtBQUt2QkMsRUFBQUEsV0FBVyxDQUNQQyxjQURPLEVBRVBDLE9BRk8sRUFHUEMsWUFITyxFQUlQQyxNQUpPLEVBS1Q7QUFDRSxTQUFLRixPQUFMLEdBQWVBLE9BQWY7QUFDQSxTQUFLRyxVQUFMLEdBQWtCTixhQUFhLENBQUNPLGFBQWQsQ0FBNEJMLGNBQTVCLEVBQTRDRSxZQUE1QyxDQUFsQjtBQUNBLFNBQUtDLE1BQUwsR0FBY0EsTUFBZDtBQUNIOztBQUVELFNBQU9FLGFBQVAsQ0FBcUJMLGNBQXJCLEVBQTZDRSxZQUE3QyxFQUFtRztBQUMvRixRQUFJ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QUFLLEVBQUVHLFNBQVQ7QUFBb0JELFFBQUFBLElBQUksRUFBRTtBQUExQixPQUFELENBQXpDO0FBQ0EsV0FBS1gsU0FBTCxHQUFpQixFQUFqQjtBQUNBLFdBQUtDLFNBQUwsR0FBaUIsRUFBakI7QUFDSDtBQUNKOztBQTNGOEUiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgeyAkJGFzeW5jSXRlcmF0b3IgfSBmcm9tICdpdGVyYWxsJztcbmltcG9ydCB0eXBlIHsgQWNjZXNzUmlnaHRzIH0gZnJvbSAnLi4vYXV0aCc7XG5pbXBvcnQgeyBzZWxlY3RGaWVsZHMgfSBmcm9tICcuLi9maWx0ZXIvZmlsdGVycyc7XG5pbXBvcnQgdHlwZSB7IEZpZWxkU2VsZWN0aW9uLCBRVHlwZSB9IGZyb20gJy4uL2ZpbHRlci9maWx0ZXJzJztcblxuZXhwb3J0IGNsYXNzIFFEYXRhTGlzdGVuZXIge1xuICAgIGRvY1R5cGU6IFFUeXBlO1xuICAgIGZpbHRlcjogYW55O1xuICAgIGF1dGhGaWx0ZXI6ID8oKGRvYzogYW55KSA9PiBib29sZWFuKTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBjb2xsZWN0aW9uTmFtZTogc3RyaW5nLFxuICAgICAgICBkb2NUeXBlOiBRVHlwZSxcbiAgICAgICAgYWNjZXNzUmlnaHRzOiBBY2Nlc3NSaWdodHMsXG4gICAgICAgIGZpbHRlcjogYW55LFxuICAgICkge1xuICAgICAgICB0aGlzLmRvY1R5cGUgPSBkb2NUeXBlO1xuICAgICAgICB0aGlzLmF1dGhGaWx0ZXIgPSBRRGF0YUxpc3RlbmVyLmdldEF1dGhGaWx0ZXIoY29sbGVjdGlvbk5hbWUsIGFjY2Vzc1JpZ2h0cyk7XG4gICAgICAgIHRoaXMuZmlsdGVyID0gZmlsdGVyO1xuICAgIH1cblxuICAgIHN0YXRpYyBnZXRBdXRoRmlsdGVyKGNvbGxlY3Rpb25OYW1lOiBzdHJpbmcsIGFjY2Vzc1JpZ2h0czogQWNjZXNzUmlnaHRzKTogPygoZG9jOiBhbnkpID0+IGJvb2xlYW4pIHtcbiAgICAgICAgaWYgKGFjY2Vzc1JpZ2h0cy5yZXN0cmljdFRvQWNjb3VudHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBhY2NvdW50cyA9IG5ldyBTZXQoYWNjZXNzUmlnaHRzLnJlc3RyaWN0VG9BY2NvdW50cyk7XG4gICAgICAgIHN3aXRjaCAoY29sbGVjdGlvbk5hbWUpIHtcbiAgICAgICAgY2FzZSAnYWNjb3VudHMnOlxuICAgICAgICAgICAgcmV0dXJuIChkb2MpID0+IGFjY291bnRzLmhhcyhkb2MuX2tleSk7XG4gICAgICAgIGNhc2UgJ3RyYW5zYWN0aW9ucyc6XG4gICAgICAgICAgICByZXR1cm4gKGRvYykgPT4gYWNjb3VudHMuaGFzKGRvYy5hY2NvdW50X2FkZHIpO1xuICAgICAgICBjYXNlICdtZXNzYWdlcyc6XG4gICAgICAgICAgICByZXR1cm4gKGRvYykgPT4gYWNjb3VudHMuaGFzKGRvYy5zcmMpIHx8IGFjY291bnRzLmhhcyhkb2MuZHN0KTtcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHJldHVybiAoXykgPT4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpc0ZpbHRlcmVkKGRvYzogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIGlmICh0aGlzLmF1dGhGaWx0ZXIgJiYgIXRoaXMuYXV0aEZpbHRlcihkb2MpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuZG9jVHlwZS50ZXN0KG51bGwsIGRvYywgdGhpcy5maWx0ZXIpO1xuICAgIH1cbn1cblxuLy8kRmxvd0ZpeE1lXG5leHBvcnQgY2xhc3MgUURhdGFTdWJzY3JpcHRpb24gZXh0ZW5kcyBRRGF0YUxpc3RlbmVyIGltcGxlbWVudHMgQXN5bmNJdGVyYXRvcjxhbnk+IHtcbiAgICBjb2xsZWN0aW9uTmFtZTogc3RyaW5nO1xuICAgIHNlbGVjdGlvbjogRmllbGRTZWxlY3Rpb25bXTtcbiAgICBwdWxsUXVldWU6ICgodmFsdWU6IGFueSkgPT4gdm9pZClbXTtcbiAgICBwdXNoUXVldWU6IGFueVtdO1xuICAgIHJ1bm5pbmc6IGJvb2xlYW47XG4gICAgb25DbG9zZTogPygoKSA9PiB2b2lkKTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBjb2xsZWN0aW9uTmFtZTogc3RyaW5nLFxuICAgICAgICBkb2NUeXBlOiBRVHlwZSxcbiAgICAgICAgYWNjZXNzUmlnaHRzOiBBY2Nlc3NSaWdodHMsXG4gICAgICAgIGZpbHRlcjogYW55LFxuICAgICAgICBzZWxlY3Rpb246IEZpZWxkU2VsZWN0aW9uW10sXG4gICAgKSB7XG4gICAgICAgIHN1cGVyKGNvbGxlY3Rpb25OYW1lLCBkb2NUeXBlLCBhY2Nlc3NSaWdodHMsIGZpbHRlcik7XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbk5hbWUgPSBjb2xsZWN0aW9uTmFtZTtcbiAgICAgICAgdGhpcy5zZWxlY3Rpb24gPSBzZWxlY3Rpb247XG4gICAgICAgIHRoaXMucHVsbFF1ZXVlID0gW107XG4gICAgICAgIHRoaXMucHVzaFF1ZXVlID0gW107XG4gICAgICAgIHRoaXMucnVubmluZyA9IHRydWU7XG4gICAgICAgIHRoaXMub25DbG9zZSA9IG51bGw7XG4gICAgfVxuXG4gICAgcHVzaERvY3VtZW50KGRvYzogYW55KSB7XG4gICAgICAgIGlmICh0aGlzLmlzRmlsdGVyZWQoZG9jKSAmJiAhdGhpcy5pc1F1ZXVlT3ZlcmZsb3coKSkge1xuICAgICAgICAgICAgY29uc3QgcmVkdWNlZCA9IHNlbGVjdEZpZWxkcyhkb2MsIHRoaXMuc2VsZWN0aW9uKTtcbiAgICAgICAgICAgIHRoaXMucHVzaFZhbHVlKHsgW3RoaXMuY29sbGVjdGlvbk5hbWVdOiByZWR1Y2VkIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaXNRdWV1ZU92ZXJmbG93KCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRRdWV1ZVNpemUoKSA+PSAxMDtcbiAgICB9XG5cbiAgICBnZXRRdWV1ZVNpemUoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHVzaFF1ZXVlLmxlbmd0aCArIHRoaXMucHVsbFF1ZXVlLmxlbmd0aDtcbiAgICB9XG5cbiAgICBwdXNoVmFsdWUodmFsdWU6IGFueSkge1xuICAgICAgICBpZiAodGhpcy5wdWxsUXVldWUubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgICAgICB0aGlzLnB1bGxRdWV1ZS5zaGlmdCgpKHRoaXMucnVubmluZ1xuICAgICAgICAgICAgICAgID8geyB2YWx1ZSwgZG9uZTogZmFsc2UgfVxuICAgICAgICAgICAgICAgIDogeyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH0sXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wdXNoUXVldWUucHVzaCh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBuZXh0KCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMucHVzaFF1ZXVlLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICAgICAgICAgIHJlc29sdmUodGhpcy5ydW5uaW5nXG4gICAgICAgICAgICAgICAgICAgID8geyB2YWx1ZTogdGhpcy5wdXNoUXVldWUuc2hpZnQoKSwgZG9uZTogZmFsc2UgfVxuICAgICAgICAgICAgICAgICAgICA6IHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9LFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMucHVsbFF1ZXVlLnB1c2gocmVzb2x2ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIHJldHVybigpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBpZiAodGhpcy5vbkNsb3NlKSB7XG4gICAgICAgICAgICB0aGlzLm9uQ2xvc2UoKTtcbiAgICAgICAgfVxuICAgICAgICBhd2FpdCB0aGlzLmVtcHR5UXVldWUoKTtcbiAgICAgICAgcmV0dXJuIHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9O1xuICAgIH1cblxuICAgIGFzeW5jIHRocm93KGVycm9yPzogYW55KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgaWYgKHRoaXMub25DbG9zZSkge1xuICAgICAgICAgICAgdGhpcy5vbkNsb3NlKCk7XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgdGhpcy5lbXB0eVF1ZXVlKCk7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7XG4gICAgfVxuXG4gICAgLy8kRmxvd0ZpeE1lXG4gICAgWyQkYXN5bmNJdGVyYXRvcl0oKSB7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFzeW5jIGVtcHR5UXVldWUoKSB7XG4gICAgICAgIGlmICh0aGlzLnJ1bm5pbmcpIHtcbiAgICAgICAgICAgIHRoaXMucnVubmluZyA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5wdWxsUXVldWUuZm9yRWFjaChyZXNvbHZlID0+IHJlc29sdmUoeyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH0pKTtcbiAgICAgICAgICAgIHRoaXMucHVsbFF1ZXVlID0gW107XG4gICAgICAgICAgICB0aGlzLnB1c2hRdWV1ZSA9IFtdO1xuICAgICAgICB9XG4gICAgfVxuXG59XG4iXX0=