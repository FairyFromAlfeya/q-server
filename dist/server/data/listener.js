"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.QDataSubscription = exports.QDataListener = void 0;

var _iterall = require("iterall");

var _filters = require("../filter/filters");

class QDataListener {
  constructor(collectionName, docType, accessRights, filter) {
    this.docType = docType;
    this.authFilter = QDataListener.getAuthFilter(collectionName, accessRights);
    this.filter = filter;
  }

  static getAuthFilter(collectionName, accessRights) {
    if (accessRights.restrictToAccounts.length === 0) {
      return null;
    }

    const accounts = new Set(accessRights.restrictToAccounts);

    switch (collectionName) {
      case 'accounts':
        return doc => accounts.has(doc._key);

      case 'transactions':
        return doc => accounts.has(doc.account_addr);

      case 'messages':
        return doc => accounts.has(doc.src) || accounts.has(doc.dst);

      default:
        return _ => false;
    }
  }

  isFiltered(doc) {
    if (this.authFilter && !this.authFilter(doc)) {
      return false;
    }

    return this.docType.test(null, doc, this.filter);
  }

} //$FlowFixMe


exports.QDataListener = QDataListener;

class QDataSubscription extends QDataListener {
  constructor(collectionName, docType, accessRights, filter, selection) {
    super(collectionName, docType, accessRights, filter);
    this.collectionName = collectionName;
    this.selection = selection;
    this.pullQueue = [];
    this.pushQueue = [];
    this.running = true;
    this.onClose = null;
  }

  pushDocument(doc) {
    if (this.isFiltered(doc) && !this.isQueueOverflow()) {
      const reduced = (0, _filters.selectFields)(doc, this.selection);
      this.pushValue({
        [this.collectionName]: reduced
      });
    }
  }

  isQueueOverflow() {
    return this.getQueueSize() >= 10;
  }

  getQueueSize() {
    return this.pushQueue.length + this.pullQueue.length;
  }

  pushValue(value) {
    if (this.pullQueue.length !== 0) {
      this.pullQueue.shift()(this.running ? {
        value,
        done: false
      } : {
        value: undefined,
        done: true
      });
    } else {
      this.pushQueue.push(value);
    }
  }

  async next() {
    return new Promise(resolve => {
      if (this.pushQueue.length !== 0) {
        resolve(this.running ? {
          value: this.pushQueue.shift(),
          done: false
        } : {
          value: undefined,
          done: true
        });
      } else {
        this.pullQueue.push(resolve);
      }
    });
  }

  async return() {
    if (this.onClose) {
      this.onClose();
    }

    await this.emptyQueue();
    return {
      value: undefined,
      done: true
    };
  }

  async throw(error) {
    if (this.onClose) {
      this.onClose();
    }

    await this.emptyQueue();
    return Promise.reject(error);
  } //$FlowFixMe


  [_iterall.$$asyncIterator]() {
    return this;
  }

  async emptyQueue() {
    if (this.running) {
      this.running = false;
      this.pullQueue.forEach(resolve => resolve({
        value: undefined,
        done: true
      }));
      this.pullQueue = [];
      this.pushQueue = [];
    }
  }

}

exports.QDataSubscription = QDataSubscription;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9saXN0ZW5lci5qcyJdLCJuYW1lcyI6WyJRRGF0YUxpc3RlbmVyIiwiY29uc3RydWN0b3IiLCJjb2xsZWN0aW9uTmFtZSIsImRvY1R5cGUiLCJhY2Nlc3NSaWdodHMiLCJmaWx0ZXIiLCJhdXRoRmlsdGVyIiwiZ2V0QXV0aEZpbHRlciIsInJlc3RyaWN0VG9BY2NvdW50cyIsImxlbmd0aCIsImFjY291bnRzIiwiU2V0IiwiZG9jIiwiaGFzIiwiX2tleSIsImFjY291bnRfYWRkciIsInNyYyIsImRzdCIsIl8iLCJpc0ZpbHRlcmVkIiwidGVzdCIsIlFEYXRhU3Vic2NyaXB0aW9uIiwic2VsZWN0aW9uIiwicHVsbFF1ZXVlIiwicHVzaFF1ZXVlIiwicnVubmluZyIsIm9uQ2xvc2UiLCJwdXNoRG9jdW1lbnQiLCJpc1F1ZXVlT3ZlcmZsb3ciLCJyZWR1Y2VkIiwicHVzaFZhbHVlIiwiZ2V0UXVldWVTaXplIiwidmFsdWUiLCJzaGlmdCIsImRvbmUiLCJ1bmRlZmluZWQiLCJwdXNoIiwibmV4dCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmV0dXJuIiwiZW1wdHlRdWV1ZSIsInRocm93IiwiZXJyb3IiLCJyZWplY3QiLCIkJGFzeW5jSXRlcmF0b3IiLCJmb3JFYWNoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7O0FBRUE7O0FBR08sTUFBTUEsYUFBTixDQUFvQjtBQUt2QkMsRUFBQUEsV0FBVyxDQUNQQyxjQURPLEVBRVBDLE9BRk8sRUFHUEMsWUFITyxFQUlQQyxNQUpPLEVBS1Q7QUFDRSxTQUFLRixPQUFMLEdBQWVBLE9BQWY7QUFDQSxTQUFLRyxVQUFMLEdBQWtCTixhQUFhLENBQUNPLGFBQWQsQ0FBNEJMLGNBQTVCLEVBQTRDRSxZQUE1QyxDQUFsQjtBQUNBLFNBQUtDLE1BQUwsR0FBY0EsTUFBZDtBQUNIOztBQUVtQixTQUFiRSxhQUFhLENBQUNMLGNBQUQsRUFBeUJFLFlBQXpCLEVBQStFO0FBQy9GLFFBQUlB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SyxFQUFFRyxTQUFUO0FBQW9CRCxRQUFBQSxJQUFJLEVBQUU7QUFBMUIsT0FBRCxDQUF6QztBQUNBLFdBQUtYLFNBQUwsR0FBaUIsRUFBakI7QUFDQSxXQUFLQyxTQUFMLEdBQWlCLEVBQWpCO0FBQ0g7QUFDSjs7QUEzRjhFIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHsgJCRhc3luY0l0ZXJhdG9yIH0gZnJvbSAnaXRlcmFsbCc7XG5pbXBvcnQgdHlwZSB7IEFjY2Vzc1JpZ2h0cyB9IGZyb20gJy4uL2F1dGgnO1xuaW1wb3J0IHsgc2VsZWN0RmllbGRzIH0gZnJvbSAnLi4vZmlsdGVyL2ZpbHRlcnMnO1xuaW1wb3J0IHR5cGUgeyBGaWVsZFNlbGVjdGlvbiwgUVR5cGUgfSBmcm9tICcuLi9maWx0ZXIvZmlsdGVycyc7XG5cbmV4cG9ydCBjbGFzcyBRRGF0YUxpc3RlbmVyIHtcbiAgICBkb2NUeXBlOiBRVHlwZTtcbiAgICBmaWx0ZXI6IGFueTtcbiAgICBhdXRoRmlsdGVyOiA/KChkb2M6IGFueSkgPT4gYm9vbGVhbik7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgY29sbGVjdGlvbk5hbWU6IHN0cmluZyxcbiAgICAgICAgZG9jVHlwZTogUVR5cGUsXG4gICAgICAgIGFjY2Vzc1JpZ2h0czogQWNjZXNzUmlnaHRzLFxuICAgICAgICBmaWx0ZXI6IGFueSxcbiAgICApIHtcbiAgICAgICAgdGhpcy5kb2NUeXBlID0gZG9jVHlwZTtcbiAgICAgICAgdGhpcy5hdXRoRmlsdGVyID0gUURhdGFMaXN0ZW5lci5nZXRBdXRoRmlsdGVyKGNvbGxlY3Rpb25OYW1lLCBhY2Nlc3NSaWdodHMpO1xuICAgICAgICB0aGlzLmZpbHRlciA9IGZpbHRlcjtcbiAgICB9XG5cbiAgICBzdGF0aWMgZ2V0QXV0aEZpbHRlcihjb2xsZWN0aW9uTmFtZTogc3RyaW5nLCBhY2Nlc3NSaWdodHM6IEFjY2Vzc1JpZ2h0cyk6ID8oKGRvYzogYW55KSA9PiBib29sZWFuKSB7XG4gICAgICAgIGlmIChhY2Nlc3NSaWdodHMucmVzdHJpY3RUb0FjY291bnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYWNjb3VudHMgPSBuZXcgU2V0KGFjY2Vzc1JpZ2h0cy5yZXN0cmljdFRvQWNjb3VudHMpO1xuICAgICAgICBzd2l0Y2ggKGNvbGxlY3Rpb25OYW1lKSB7XG4gICAgICAgIGNhc2UgJ2FjY291bnRzJzpcbiAgICAgICAgICAgIHJldHVybiAoZG9jKSA9PiBhY2NvdW50cy5oYXMoZG9jLl9rZXkpO1xuICAgICAgICBjYXNlICd0cmFuc2FjdGlvbnMnOlxuICAgICAgICAgICAgcmV0dXJuIChkb2MpID0+IGFjY291bnRzLmhhcyhkb2MuYWNjb3VudF9hZGRyKTtcbiAgICAgICAgY2FzZSAnbWVzc2FnZXMnOlxuICAgICAgICAgICAgcmV0dXJuIChkb2MpID0+IGFjY291bnRzLmhhcyhkb2Muc3JjKSB8fCBhY2NvdW50cy5oYXMoZG9jLmRzdCk7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICByZXR1cm4gKF8pID0+IGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaXNGaWx0ZXJlZChkb2M6IGFueSk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAodGhpcy5hdXRoRmlsdGVyICYmICF0aGlzLmF1dGhGaWx0ZXIoZG9jKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmRvY1R5cGUudGVzdChudWxsLCBkb2MsIHRoaXMuZmlsdGVyKTtcbiAgICB9XG59XG5cbi8vJEZsb3dGaXhNZVxuZXhwb3J0IGNsYXNzIFFEYXRhU3Vic2NyaXB0aW9uIGV4dGVuZHMgUURhdGFMaXN0ZW5lciBpbXBsZW1lbnRzIEFzeW5jSXRlcmF0b3I8YW55PiB7XG4gICAgY29sbGVjdGlvbk5hbWU6IHN0cmluZztcbiAgICBzZWxlY3Rpb246IEZpZWxkU2VsZWN0aW9uW107XG4gICAgcHVsbFF1ZXVlOiAoKHZhbHVlOiBhbnkpID0+IHZvaWQpW107XG4gICAgcHVzaFF1ZXVlOiBhbnlbXTtcbiAgICBydW5uaW5nOiBib29sZWFuO1xuICAgIG9uQ2xvc2U6ID8oKCkgPT4gdm9pZCk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgY29sbGVjdGlvbk5hbWU6IHN0cmluZyxcbiAgICAgICAgZG9jVHlwZTogUVR5cGUsXG4gICAgICAgIGFjY2Vzc1JpZ2h0czogQWNjZXNzUmlnaHRzLFxuICAgICAgICBmaWx0ZXI6IGFueSxcbiAgICAgICAgc2VsZWN0aW9uOiBGaWVsZFNlbGVjdGlvbltdLFxuICAgICkge1xuICAgICAgICBzdXBlcihjb2xsZWN0aW9uTmFtZSwgZG9jVHlwZSwgYWNjZXNzUmlnaHRzLCBmaWx0ZXIpO1xuICAgICAgICB0aGlzLmNvbGxlY3Rpb25OYW1lID0gY29sbGVjdGlvbk5hbWU7XG4gICAgICAgIHRoaXMuc2VsZWN0aW9uID0gc2VsZWN0aW9uO1xuICAgICAgICB0aGlzLnB1bGxRdWV1ZSA9IFtdO1xuICAgICAgICB0aGlzLnB1c2hRdWV1ZSA9IFtdO1xuICAgICAgICB0aGlzLnJ1bm5pbmcgPSB0cnVlO1xuICAgICAgICB0aGlzLm9uQ2xvc2UgPSBudWxsO1xuICAgIH1cblxuICAgIHB1c2hEb2N1bWVudChkb2M6IGFueSkge1xuICAgICAgICBpZiAodGhpcy5pc0ZpbHRlcmVkKGRvYykgJiYgIXRoaXMuaXNRdWV1ZU92ZXJmbG93KCkpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlZHVjZWQgPSBzZWxlY3RGaWVsZHMoZG9jLCB0aGlzLnNlbGVjdGlvbik7XG4gICAgICAgICAgICB0aGlzLnB1c2hWYWx1ZSh7IFt0aGlzLmNvbGxlY3Rpb25OYW1lXTogcmVkdWNlZCB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlzUXVldWVPdmVyZmxvdygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UXVldWVTaXplKCkgPj0gMTA7XG4gICAgfVxuXG4gICAgZ2V0UXVldWVTaXplKCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLnB1c2hRdWV1ZS5sZW5ndGggKyB0aGlzLnB1bGxRdWV1ZS5sZW5ndGg7XG4gICAgfVxuXG4gICAgcHVzaFZhbHVlKHZhbHVlOiBhbnkpIHtcbiAgICAgICAgaWYgKHRoaXMucHVsbFF1ZXVlLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICAgICAgdGhpcy5wdWxsUXVldWUuc2hpZnQoKSh0aGlzLnJ1bm5pbmdcbiAgICAgICAgICAgICAgICA/IHsgdmFsdWUsIGRvbmU6IGZhbHNlIH1cbiAgICAgICAgICAgICAgICA6IHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucHVzaFF1ZXVlLnB1c2godmFsdWUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgbmV4dCgpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLnB1c2hRdWV1ZS5sZW5ndGggIT09IDApIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHRoaXMucnVubmluZ1xuICAgICAgICAgICAgICAgICAgICA/IHsgdmFsdWU6IHRoaXMucHVzaFF1ZXVlLnNoaWZ0KCksIGRvbmU6IGZhbHNlIH1cbiAgICAgICAgICAgICAgICAgICAgOiB7IHZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWUgfSxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnB1bGxRdWV1ZS5wdXNoKHJlc29sdmUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyByZXR1cm4oKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgaWYgKHRoaXMub25DbG9zZSkge1xuICAgICAgICAgICAgdGhpcy5vbkNsb3NlKCk7XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgdGhpcy5lbXB0eVF1ZXVlKCk7XG4gICAgICAgIHJldHVybiB7IHZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWUgfTtcbiAgICB9XG5cbiAgICBhc3luYyB0aHJvdyhlcnJvcj86IGFueSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGlmICh0aGlzLm9uQ2xvc2UpIHtcbiAgICAgICAgICAgIHRoaXMub25DbG9zZSgpO1xuICAgICAgICB9XG4gICAgICAgIGF3YWl0IHRoaXMuZW1wdHlRdWV1ZSgpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpO1xuICAgIH1cblxuICAgIC8vJEZsb3dGaXhNZVxuICAgIFskJGFzeW5jSXRlcmF0b3JdKCkge1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBhc3luYyBlbXB0eVF1ZXVlKCkge1xuICAgICAgICBpZiAodGhpcy5ydW5uaW5nKSB7XG4gICAgICAgICAgICB0aGlzLnJ1bm5pbmcgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMucHVsbFF1ZXVlLmZvckVhY2gocmVzb2x2ZSA9PiByZXNvbHZlKHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9KSk7XG4gICAgICAgICAgICB0aGlzLnB1bGxRdWV1ZSA9IFtdO1xuICAgICAgICAgICAgdGhpcy5wdXNoUXVldWUgPSBbXTtcbiAgICAgICAgfVxuICAgIH1cblxufVxuIl19