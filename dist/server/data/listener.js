"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.QDataSubscription = exports.QDataListener = void 0;

var _iterall = require("iterall");

var _filters = require("../filter/filters");

class QDataListener {
  constructor(collectionName, docType, accessRights, filter) {
    this.docType = docType;
    this.authFilter = QDataListener.getAuthFilter(collectionName, accessRights);
    this.filter = filter;
  }

  static getAuthFilter(collectionName, accessRights) {
    if (accessRights.restrictToAccounts.length === 0) {
      return null;
    }

    const accounts = new Set(accessRights.restrictToAccounts);

    switch (collectionName) {
      case 'accounts':
        return doc => accounts.has(doc._key);

      case 'transactions':
        return doc => accounts.has(doc.account_addr);

      case 'messages':
        return doc => accounts.has(doc.src) || accounts.has(doc.dst);

      default:
        return _ => false;
    }
  }

  isFiltered(doc) {
    if (this.authFilter && !this.authFilter(doc)) {
      return false;
    }

    return this.docType.test(null, doc, this.filter);
  }

} //$FlowFixMe


exports.QDataListener = QDataListener;

class QDataSubscription extends QDataListener {
  constructor(collectionName, docType, accessRights, filter, selection) {
    super(collectionName, docType, accessRights, filter);
    this.collectionName = collectionName;
    this.selection = selection;
    this.pullQueue = [];
    this.pushQueue = [];
    this.running = true;
    this.onClose = null;
  }

  pushDocument(doc) {
    if (this.isFiltered(doc) && !this.isQueueOverflow()) {
      const reduced = (0, _filters.selectFields)(doc, this.selection);
      this.pushValue({
        [this.collectionName]: reduced
      });
    }
  }

  isQueueOverflow() {
    return this.getQueueSize() >= 10;
  }

  getQueueSize() {
    return this.pushQueue.length + this.pullQueue.length;
  }

  pushValue(value) {
    if (this.pullQueue.length !== 0) {
      this.pullQueue.shift()(this.running ? {
        value,
        done: false
      } : {
        value: undefined,
        done: true
      });
    } else {
      this.pushQueue.push(value);
    }
  }

  async next() {
    return new Promise(resolve => {
      if (this.pushQueue.length !== 0) {
        resolve(this.running ? {
          value: this.pushQueue.shift(),
          done: false
        } : {
          value: undefined,
          done: true
        });
      } else {
        this.pullQueue.push(resolve);
      }
    });
  }

  async return() {
    if (this.onClose) {
      this.onClose();
    }

    await this.emptyQueue();
    return {
      value: undefined,
      done: true
    };
  }

  async throw(error) {
    if (this.onClose) {
      this.onClose();
    }

    await this.emptyQueue();
    return Promise.reject(error);
  } //$FlowFixMe


  [_iterall.$$asyncIterator]() {
    return this;
  }

  async emptyQueue() {
    if (this.running) {
      this.running = false;
      this.pullQueue.forEach(resolve => resolve({
        value: undefined,
        done: true
      }));
      this.pullQueue = [];
      this.pushQueue = [];
    }
  }

}

exports.QDataSubscription = QDataSubscription;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9saXN0ZW5lci5qcyJdLCJuYW1lcyI6WyJRRGF0YUxpc3RlbmVyIiwiY29uc3RydWN0b3IiLCJjb2xsZWN0aW9uTmFtZSIsImRvY1R5cGUiLCJhY2Nlc3NSaWdodHMiLCJmaWx0ZXIiLCJhdXRoRmlsdGVyIiwiZ2V0QXV0aEZpbHRlciIsInJlc3RyaWN0VG9BY2NvdW50cyIsImxlbmd0aCIsImFjY291bnRzIiwiU2V0IiwiZG9jIiwiaGFzIiwiX2tleSIsImFjY291bnRfYWRkciIsInNyYyIsImRzdCIsIl8iLCJpc0ZpbHRlcmVkIiwidGVzdCIsIlFEYXRhU3Vic2NyaXB0aW9uIiwic2VsZWN0aW9uIiwicHVsbFF1ZXVlIiwicHVzaFF1ZXVlIiwicnVubmluZyIsIm9uQ2xvc2UiLCJwdXNoRG9jdW1lbnQiLCJpc1F1ZXVlT3ZlcmZsb3ciLCJyZWR1Y2VkIiwicHVzaFZhbHVlIiwiZ2V0UXVldWVTaXplIiwidmFsdWUiLCJzaGlmdCIsImRvbmUiLCJ1bmRlZmluZWQiLCJwdXNoIiwibmV4dCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmV0dXJuIiwiZW1wdHlRdWV1ZSIsInRocm93IiwiZXJyb3IiLCJyZWplY3QiLCIkJGFzeW5jSXRlcmF0b3IiLCJmb3JFYWNoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7O0FBRUE7O0FBR08sTUFBTUEsYUFBTixDQUFvQjtBQUt2QkMsRUFBQUEsV0FBVyxDQUNQQyxjQURPLEVBRVBDLE9BRk8sRUFHUEMsWUFITyxFQUlQQyxNQUpPLEVBS1Q7QUFDRSxTQUFLRixPQUFMLEdBQWVBLE9BQWY7QUFDQSxTQUFLRyxVQUFMLEdBQWtCTixhQUFhLENBQUNPLGFBQWQsQ0FBNEJMLGNBQTVCLEVBQTRDRSxZQUE1QyxDQUFsQjtBQUNBLFNBQUtDLE1BQUwsR0FBY0EsTUFBZDtBQUNIOztBQUVELFNBQU9FLGFBQVAsQ0FBcUJMLGNBQXJCLEVBQTZDRSxZQUE3QyxFQUFtRztBQUMvRixRQUFJ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QUFLLEVBQUVHLFNBQVQ7QUFBb0JELFFBQUFBLElBQUksRUFBRTtBQUExQixPQUFELENBQXpDO0FBQ0EsV0FBS1gsU0FBTCxHQUFpQixFQUFqQjtBQUNBLFdBQUtDLFNBQUwsR0FBaUIsRUFBakI7QUFDSDtBQUNKOztBQTNGOEUiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgeyAkJGFzeW5jSXRlcmF0b3IgfSBmcm9tIFwiaXRlcmFsbFwiO1xuaW1wb3J0IHR5cGUgeyBBY2Nlc3NSaWdodHMgfSBmcm9tIFwiLi4vYXV0aFwiO1xuaW1wb3J0IHsgc2VsZWN0RmllbGRzIH0gZnJvbSBcIi4uL2ZpbHRlci9maWx0ZXJzXCI7XG5pbXBvcnQgdHlwZSB7IEZpZWxkU2VsZWN0aW9uLCBRVHlwZSB9IGZyb20gXCIuLi9maWx0ZXIvZmlsdGVyc1wiO1xuXG5leHBvcnQgY2xhc3MgUURhdGFMaXN0ZW5lciB7XG4gICAgZG9jVHlwZTogUVR5cGU7XG4gICAgZmlsdGVyOiBhbnk7XG4gICAgYXV0aEZpbHRlcjogPygoZG9jOiBhbnkpID0+IGJvb2xlYW4pO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIGNvbGxlY3Rpb25OYW1lOiBzdHJpbmcsXG4gICAgICAgIGRvY1R5cGU6IFFUeXBlLFxuICAgICAgICBhY2Nlc3NSaWdodHM6IEFjY2Vzc1JpZ2h0cyxcbiAgICAgICAgZmlsdGVyOiBhbnksXG4gICAgKSB7XG4gICAgICAgIHRoaXMuZG9jVHlwZSA9IGRvY1R5cGU7XG4gICAgICAgIHRoaXMuYXV0aEZpbHRlciA9IFFEYXRhTGlzdGVuZXIuZ2V0QXV0aEZpbHRlcihjb2xsZWN0aW9uTmFtZSwgYWNjZXNzUmlnaHRzKTtcbiAgICAgICAgdGhpcy5maWx0ZXIgPSBmaWx0ZXI7XG4gICAgfVxuXG4gICAgc3RhdGljIGdldEF1dGhGaWx0ZXIoY29sbGVjdGlvbk5hbWU6IHN0cmluZywgYWNjZXNzUmlnaHRzOiBBY2Nlc3NSaWdodHMpOiA/KChkb2M6IGFueSkgPT4gYm9vbGVhbikge1xuICAgICAgICBpZiAoYWNjZXNzUmlnaHRzLnJlc3RyaWN0VG9BY2NvdW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGFjY291bnRzID0gbmV3IFNldChhY2Nlc3NSaWdodHMucmVzdHJpY3RUb0FjY291bnRzKTtcbiAgICAgICAgc3dpdGNoIChjb2xsZWN0aW9uTmFtZSkge1xuICAgICAgICBjYXNlICdhY2NvdW50cyc6XG4gICAgICAgICAgICByZXR1cm4gKGRvYykgPT4gYWNjb3VudHMuaGFzKGRvYy5fa2V5KTtcbiAgICAgICAgY2FzZSAndHJhbnNhY3Rpb25zJzpcbiAgICAgICAgICAgIHJldHVybiAoZG9jKSA9PiBhY2NvdW50cy5oYXMoZG9jLmFjY291bnRfYWRkcik7XG4gICAgICAgIGNhc2UgJ21lc3NhZ2VzJzpcbiAgICAgICAgICAgIHJldHVybiAoZG9jKSA9PiBhY2NvdW50cy5oYXMoZG9jLnNyYykgfHwgYWNjb3VudHMuaGFzKGRvYy5kc3QpO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgcmV0dXJuIChfKSA9PiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlzRmlsdGVyZWQoZG9jOiBhbnkpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHRoaXMuYXV0aEZpbHRlciAmJiAhdGhpcy5hdXRoRmlsdGVyKGRvYykpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5kb2NUeXBlLnRlc3QobnVsbCwgZG9jLCB0aGlzLmZpbHRlcik7XG4gICAgfVxufVxuXG4vLyRGbG93Rml4TWVcbmV4cG9ydCBjbGFzcyBRRGF0YVN1YnNjcmlwdGlvbiBleHRlbmRzIFFEYXRhTGlzdGVuZXIgaW1wbGVtZW50cyBBc3luY0l0ZXJhdG9yPGFueT4ge1xuICAgIGNvbGxlY3Rpb25OYW1lOiBzdHJpbmc7XG4gICAgc2VsZWN0aW9uOiBGaWVsZFNlbGVjdGlvbltdO1xuICAgIHB1bGxRdWV1ZTogKCh2YWx1ZTogYW55KSA9PiB2b2lkKVtdO1xuICAgIHB1c2hRdWV1ZTogYW55W107XG4gICAgcnVubmluZzogYm9vbGVhbjtcbiAgICBvbkNsb3NlOiA/KCgpID0+IHZvaWQpO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIGNvbGxlY3Rpb25OYW1lOiBzdHJpbmcsXG4gICAgICAgIGRvY1R5cGU6IFFUeXBlLFxuICAgICAgICBhY2Nlc3NSaWdodHM6IEFjY2Vzc1JpZ2h0cyxcbiAgICAgICAgZmlsdGVyOiBhbnksXG4gICAgICAgIHNlbGVjdGlvbjogRmllbGRTZWxlY3Rpb25bXSxcbiAgICApIHtcbiAgICAgICAgc3VwZXIoY29sbGVjdGlvbk5hbWUsIGRvY1R5cGUsIGFjY2Vzc1JpZ2h0cywgZmlsdGVyKTtcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9uTmFtZSA9IGNvbGxlY3Rpb25OYW1lO1xuICAgICAgICB0aGlzLnNlbGVjdGlvbiA9IHNlbGVjdGlvbjtcbiAgICAgICAgdGhpcy5wdWxsUXVldWUgPSBbXTtcbiAgICAgICAgdGhpcy5wdXNoUXVldWUgPSBbXTtcbiAgICAgICAgdGhpcy5ydW5uaW5nID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5vbkNsb3NlID0gbnVsbDtcbiAgICB9XG5cbiAgICBwdXNoRG9jdW1lbnQoZG9jOiBhbnkpIHtcbiAgICAgICAgaWYgKHRoaXMuaXNGaWx0ZXJlZChkb2MpICYmICF0aGlzLmlzUXVldWVPdmVyZmxvdygpKSB7XG4gICAgICAgICAgICBjb25zdCByZWR1Y2VkID0gc2VsZWN0RmllbGRzKGRvYywgdGhpcy5zZWxlY3Rpb24pO1xuICAgICAgICAgICAgdGhpcy5wdXNoVmFsdWUoeyBbdGhpcy5jb2xsZWN0aW9uTmFtZV06IHJlZHVjZWQgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpc1F1ZXVlT3ZlcmZsb3coKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldFF1ZXVlU2l6ZSgpID49IDEwO1xuICAgIH1cblxuICAgIGdldFF1ZXVlU2l6ZSgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5wdXNoUXVldWUubGVuZ3RoICsgdGhpcy5wdWxsUXVldWUubGVuZ3RoO1xuICAgIH1cblxuICAgIHB1c2hWYWx1ZSh2YWx1ZTogYW55KSB7XG4gICAgICAgIGlmICh0aGlzLnB1bGxRdWV1ZS5sZW5ndGggIT09IDApIHtcbiAgICAgICAgICAgIHRoaXMucHVsbFF1ZXVlLnNoaWZ0KCkodGhpcy5ydW5uaW5nXG4gICAgICAgICAgICAgICAgPyB7IHZhbHVlLCBkb25lOiBmYWxzZSB9XG4gICAgICAgICAgICAgICAgOiB7IHZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWUgfSxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnB1c2hRdWV1ZS5wdXNoKHZhbHVlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIG5leHQoKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5wdXNoUXVldWUubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh0aGlzLnJ1bm5pbmdcbiAgICAgICAgICAgICAgICAgICAgPyB7IHZhbHVlOiB0aGlzLnB1c2hRdWV1ZS5zaGlmdCgpLCBkb25lOiBmYWxzZSB9XG4gICAgICAgICAgICAgICAgICAgIDogeyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH0sXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wdWxsUXVldWUucHVzaChyZXNvbHZlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmV0dXJuKCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGlmICh0aGlzLm9uQ2xvc2UpIHtcbiAgICAgICAgICAgIHRoaXMub25DbG9zZSgpO1xuICAgICAgICB9XG4gICAgICAgIGF3YWl0IHRoaXMuZW1wdHlRdWV1ZSgpO1xuICAgICAgICByZXR1cm4geyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH07XG4gICAgfVxuXG4gICAgYXN5bmMgdGhyb3coZXJyb3I/OiBhbnkpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBpZiAodGhpcy5vbkNsb3NlKSB7XG4gICAgICAgICAgICB0aGlzLm9uQ2xvc2UoKTtcbiAgICAgICAgfVxuICAgICAgICBhd2FpdCB0aGlzLmVtcHR5UXVldWUoKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgICB9XG5cbiAgICAvLyRGbG93Rml4TWVcbiAgICBbJCRhc3luY0l0ZXJhdG9yXSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYXN5bmMgZW1wdHlRdWV1ZSgpIHtcbiAgICAgICAgaWYgKHRoaXMucnVubmluZykge1xuICAgICAgICAgICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLnB1bGxRdWV1ZS5mb3JFYWNoKHJlc29sdmUgPT4gcmVzb2x2ZSh7IHZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWUgfSkpO1xuICAgICAgICAgICAgdGhpcy5wdWxsUXVldWUgPSBbXTtcbiAgICAgICAgICAgIHRoaXMucHVzaFF1ZXVlID0gW107XG4gICAgICAgIH1cbiAgICB9XG5cbn1cbiJdfQ==