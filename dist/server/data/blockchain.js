"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.INDEXES = void 0;

var _counterparties = require("../graphql/counterparties");

var _data = _interopRequireDefault(require("./data"));

var _collection = require("./collection");

var _resolversGenerated = require("../graphql/resolvers-generated");

var _dataProvider = require("./data-provider");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const INDEXES = {
  blocks: {
    indexes: [(0, _dataProvider.sortedIndex)(['seq_no', 'gen_utime']), (0, _dataProvider.sortedIndex)(['gen_utime']), (0, _dataProvider.sortedIndex)(['workchain_id', 'shard', 'seq_no']), (0, _dataProvider.sortedIndex)(['workchain_id', 'shard', 'gen_utime']), (0, _dataProvider.sortedIndex)(['workchain_id', 'seq_no']), (0, _dataProvider.sortedIndex)(['workchain_id', 'gen_utime']), (0, _dataProvider.sortedIndex)(['master.min_shard_gen_utime']), (0, _dataProvider.sortedIndex)(['prev_ref.root_hash', '_key']), (0, _dataProvider.sortedIndex)(['prev_alt_ref.root_hash', '_key'])]
  },
  accounts: {
    indexes: [(0, _dataProvider.sortedIndex)(['last_trans_lt']), (0, _dataProvider.sortedIndex)(['balance'])]
  },
  messages: {
    indexes: [(0, _dataProvider.sortedIndex)(['block_id']), (0, _dataProvider.sortedIndex)(['value', 'created_at']), (0, _dataProvider.sortedIndex)(['src', 'value', 'created_at']), (0, _dataProvider.sortedIndex)(['dst', 'value', 'created_at']), (0, _dataProvider.sortedIndex)(['src', 'created_at']), (0, _dataProvider.sortedIndex)(['dst', 'created_at']), (0, _dataProvider.sortedIndex)(['created_lt']), (0, _dataProvider.sortedIndex)(['created_at'])]
  },
  transactions: {
    indexes: [(0, _dataProvider.sortedIndex)(['block_id']), (0, _dataProvider.sortedIndex)(['in_msg']), (0, _dataProvider.sortedIndex)(['out_msgs[*]']), (0, _dataProvider.sortedIndex)(['account_addr', 'now']), (0, _dataProvider.sortedIndex)(['now']), (0, _dataProvider.sortedIndex)(['lt']), (0, _dataProvider.sortedIndex)(['account_addr', 'orig_status', 'end_status']), (0, _dataProvider.sortedIndex)(['now', 'account_addr', 'lt'])]
  },
  blocks_signatures: {
    indexes: [(0, _dataProvider.sortedIndex)(['signatures[*].node_id', 'gen_utime'])]
  },
  zerostates: {
    indexes: []
  },
  counterparties: {
    indexes: []
  }
};
exports.INDEXES = INDEXES;
Object.values(INDEXES).forEach(collection => {
  collection.indexes = collection.indexes.concat({
    fields: ['_key']
  });
});

class QBlockchainData extends _data.default {
  constructor(options) {
    super(options);

    const add = (name, type, mutable) => {
      return this.addCollection(name, type, mutable, INDEXES[name].indexes);
    };

    this.accounts = add('accounts', _resolversGenerated.Account, _collection.QDataScope.mutable);
    this.transactions = add('transactions', _resolversGenerated.Transaction, _collection.QDataScope.immutable);
    this.messages = add('messages', _resolversGenerated.Message, _collection.QDataScope.immutable);
    this.blocks = add('blocks', _resolversGenerated.Block, _collection.QDataScope.immutable);
    this.blocks_signatures = add('blocks_signatures', _resolversGenerated.BlockSignatures, _collection.QDataScope.immutable);
    this.zerostates = add('zerostates', _resolversGenerated.Zerostate, _collection.QDataScope.immutable);
    this.counterparties = add('counterparties', _counterparties.Counterparty, _collection.QDataScope.counterparties);
    this.latency = {
      blocks: {
        maxTime: 0,
        nextUpdateTime: 0,
        latency: 0
      },
      messages: {
        maxTime: 0,
        nextUpdateTime: 0,
        latency: 0
      },
      transactions: {
        maxTime: 0,
        nextUpdateTime: 0,
        latency: 0
      },
      nextUpdateTime: 0,
      latency: 0,
      lastBlockTime: 0
    };
    this.blocks.docInsertOrUpdate.on("doc", async block => {
      this.updateLatency(this.latency.blocks, block.gen_utime);
    });
    this.transactions.docInsertOrUpdate.on("doc", async tr => {
      this.updateLatency(this.latency.transactions, tr.now);
    });
    this.messages.docInsertOrUpdate.on("doc", async msg => {
      this.updateLatency(this.latency.transactions, msg.created_at);
    });
  }

  updateLatency(latency, timeInSeconds) {
    if (this.updateCollectionLatency(latency, timeInSeconds)) {
      this.updateLatencySummary();
    }
  }

  updateCollectionLatency(latency, timeInSeconds) {
    if (timeInSeconds === undefined || timeInSeconds === null || timeInSeconds === 0) {
      return false;
    }

    const time = timeInSeconds * 1000;
    const now = Date.now();

    if (time > latency.maxTime) {
      latency.maxTime = time;
    }

    latency.nextUpdateTime = now + 30000; // LATENCY_UPDATE_FREQUENCY

    latency.latency = Math.max(0, now - latency.maxTime);
    return true;
  }

  updateLatencySummary() {
    const {
      blocks,
      messages,
      transactions
    } = this.latency;
    this.latency.nextUpdateTime = Math.min(blocks.nextUpdateTime, messages.nextUpdateTime, transactions.nextUpdateTime);
    this.latency.latency = Math.max(blocks.latency, messages.latency, transactions.latency);
    this.latency.lastBlockTime = blocks.maxTime;
  }

  async updateMaxTime(latency, collection, field) {
    if (Date.now() <= latency.nextUpdateTime) {
      return false;
    }

    const maxTime = (await collection.provider.query(`FOR d IN ${collection.name} COLLECT AGGREGATE m = MAX(d.${field}) RETURN { maxTime: m }`, {}, []))[0].maxTime;
    return this.updateCollectionLatency(latency, maxTime);
  }

  async getLatency() {
    const latency = this.latency;

    if (Date.now() > latency.nextUpdateTime) {
      let hasUpdates = await this.updateMaxTime(latency.blocks, this.blocks, "gen_utime");

      if (await this.updateMaxTime(latency.messages, this.messages, "created_at")) {
        hasUpdates = true;
      }

      if (await this.updateMaxTime(latency.transactions, this.transactions, "now")) {
        hasUpdates = true;
      }

      if (hasUpdates) {
        this.updateLatencySummary();
      }
    }

    return latency;
  }

}

exports.default = QBlockchainData;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9ibG9ja2NoYWluLmpzIl0sIm5hbWVzIjpbIklOREVYRVMiLCJibG9ja3MiLCJpbmRleGVzIiwiYWNjb3VudHMiLCJtZXNzYWdlcyIsInRyYW5zYWN0aW9ucyIsImJsb2Nrc19zaWduYXR1cmVzIiwiemVyb3N0YXRlcyIsImNvdW50ZXJwYXJ0aWVzIiwiT2JqZWN0IiwidmFsdWVzIiwiZm9yRWFjaCIsImNvbGxlY3Rpb24iLCJjb25jYXQiLCJmaWVsZHMiLCJRQmxvY2tjaGFpbkRhdGEiLCJRRGF0YSIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImFkZCIsIm5hbWUiLCJ0eXBlIiwibXV0YWJsZSIsImFkZENvbGxlY3Rpb24iLCJBY2NvdW50IiwiUURhdGFTY29wZSIsIlRyYW5zYWN0aW9uIiwiaW1tdXRhYmxlIiwiTWVzc2FnZSIsIkJsb2NrIiwiQmxvY2tTaWduYXR1cmVzIiwiWmVyb3N0YXRlIiwiQ291bnRlcnBhcnR5IiwibGF0ZW5jeSIsIm1heFRpbWUiLCJuZXh0VXBkYXRlVGltZSIsImxhc3RCbG9ja1RpbWUiLCJkb2NJbnNlcnRPclVwZGF0ZSIsIm9uIiwiYmxvY2siLCJ1cGRhdGVMYXRlbmN5IiwiZ2VuX3V0aW1lIiwidHIiLCJub3ciLCJtc2ciLCJjcmVhdGVkX2F0IiwidGltZUluU2Vjb25kcyIsInVwZGF0ZUNvbGxlY3Rpb25MYXRlbmN5IiwidXBkYXRlTGF0ZW5jeVN1bW1hcnkiLCJ1bmRlZmluZWQiLCJ0aW1lIiwiRGF0ZSIsIk1hdGgiLCJtYXgiLCJtaW4iLCJ1cGRhdGVNYXhUaW1lIiwiZmllbGQiLCJwcm92aWRlciIsInF1ZXJ5IiwiZ2V0TGF0ZW5jeSIsImhhc1VwZGF0ZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFrQkE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBUUE7Ozs7QUE5QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7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RCxRQUFBQSxVQUFVLEdBQUcsSUFBYjtBQUNIOztBQUNELFVBQUlBLFVBQUosRUFBZ0I7QUFDWixhQUFLWixvQkFBTDtBQUNIO0FBQ0o7O0FBQ0QsV0FBT2YsT0FBUDtBQUNIOztBQXRIOEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTgtMjAyMCBUT04gREVWIFNPTFVUSU9OUyBMVEQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIFNPRlRXQVJFIEVWQUxVQVRJT04gTGljZW5zZSAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlXG4gKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGVcbiAqIExpY2Vuc2UgYXQ6XG4gKlxuICogaHR0cDovL3d3dy50b24uZGV2L2xpY2Vuc2VzXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBUT04gREVWIHNvZnR3YXJlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbi8vIEBmbG93XG5cbmltcG9ydCB7IENvdW50ZXJwYXJ0eSB9IGZyb20gXCIuLi9ncmFwaHFsL2NvdW50ZXJwYXJ0aWVzXCI7XG5pbXBvcnQgdHlwZSB7IFFEYXRhT3B0aW9ucyB9IGZyb20gJy4vZGF0YSc7XG5pbXBvcnQgUURhdGEgZnJvbSAnLi9kYXRhJztcbmltcG9ydCB7IFFEYXRhQ29sbGVjdGlvbiwgUURhdGFTY29wZSB9IGZyb20gJy4vY29sbGVjdGlvbic7XG5pbXBvcnQge1xuICAgIEFjY291bnQsXG4gICAgQmxvY2ssXG4gICAgQmxvY2tTaWduYXR1cmVzLFxuICAgIE1lc3NhZ2UsXG4gICAgVHJhbnNhY3Rpb24sXG4gICAgWmVyb3N0YXRlLFxufSBmcm9tICcuLi9ncmFwaHFsL3Jlc29sdmVycy1nZW5lcmF0ZWQnO1xuaW1wb3J0IHsgc29ydGVkSW5kZXggfSBmcm9tICcuL2RhdGEtcHJvdmlkZXInO1xuXG5leHBvcnQgY29uc3QgSU5ERVhFUyA9IHtcbiAgICBibG9ja3M6IHtcbiAgICAgICAgaW5kZXhlczogW1xuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydzZXFfbm8nLCAnZ2VuX3V0aW1lJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydnZW5fdXRpbWUnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3dvcmtjaGFpbl9pZCcsICdzaGFyZCcsICdzZXFfbm8nXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3dvcmtjaGFpbl9pZCcsICdzaGFyZCcsICdnZW5fdXRpbWUnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3dvcmtjaGFpbl9pZCcsICdzZXFfbm8nXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3dvcmtjaGFpbl9pZCcsICdnZW5fdXRpbWUnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ21hc3Rlci5taW5fc2hhcmRfZ2VuX3V0aW1lJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydwcmV2X3JlZi5yb290X2hhc2gnLCAnX2tleSddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsncHJldl9hbHRfcmVmLnJvb3RfaGFzaCcsICdfa2V5J10pLFxuICAgICAgICBdLFxuICAgIH0sXG4gICAgYWNjb3VudHM6IHtcbiAgICAgICAgaW5kZXhlczogW1xuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydsYXN0X3RyYW5zX2x0J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydiYWxhbmNlJ10pLFxuICAgICAgICBdLFxuICAgIH0sXG4gICAgbWVzc2FnZXM6IHtcbiAgICAgICAgaW5kZXhlczogW1xuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydibG9ja19pZCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsndmFsdWUnLCAnY3JlYXRlZF9hdCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnc3JjJywgJ3ZhbHVlJywgJ2NyZWF0ZWRfYXQnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2RzdCcsICd2YWx1ZScsICdjcmVhdGVkX2F0J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydzcmMnLCAnY3JlYXRlZF9hdCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnZHN0JywgJ2NyZWF0ZWRfYXQnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2NyZWF0ZWRfbHQnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2NyZWF0ZWRfYXQnXSksXG4gICAgICAgIF0sXG4gICAgfSxcbiAgICB0cmFuc2FjdGlvbnM6IHtcbiAgICAgICAgaW5kZXhlczogW1xuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydibG9ja19pZCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnaW5fbXNnJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydvdXRfbXNnc1sqXSddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnYWNjb3VudF9hZGRyJywgJ25vdyddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnbm93J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydsdCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnYWNjb3VudF9hZGRyJywgJ29yaWdfc3RhdHVzJywgJ2VuZF9zdGF0dXMnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ25vdycsICdhY2NvdW50X2FkZHInLCAnbHQnXSksXG4gICAgICAgIF0sXG4gICAgfSxcbiAgICBibG9ja3Nfc2lnbmF0dXJlczoge1xuICAgICAgICBpbmRleGVzOiBbXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3NpZ25hdHVyZXNbKl0ubm9kZV9pZCcsICdnZW5fdXRpbWUnXSksXG4gICAgICAgIF0sXG4gICAgfSxcbiAgICB6ZXJvc3RhdGVzOiB7XG4gICAgICAgIGluZGV4ZXM6IFtdLFxuICAgIH0sXG4gICAgY291bnRlcnBhcnRpZXM6IHtcbiAgICAgICAgaW5kZXhlczogW10sXG4gICAgfSxcbn07XG5cblxuT2JqZWN0LnZhbHVlcyhJTkRFWEVTKS5mb3JFYWNoKChjb2xsZWN0aW9uOiBhbnkpID0+IHtcbiAgICBjb2xsZWN0aW9uLmluZGV4ZXMgPSBjb2xsZWN0aW9uLmluZGV4ZXMuY29uY2F0KHsgZmllbGRzOiBbJ19rZXknXSB9KTtcbn0pO1xuXG5leHBvcnQgdHlwZSBDb2xsZWN0aW9uTGF0ZW5jeSA9IHtcbiAgICBtYXhUaW1lOiBudW1iZXIsXG4gICAgbmV4dFVwZGF0ZVRpbWU6IG51bWJlcixcbiAgICBsYXRlbmN5OiBudW1iZXIsXG59O1xuXG5leHBvcnQgdHlwZSBMYXRlbmN5ID0ge1xuICAgIGJsb2NrczogQ29sbGVjdGlvbkxhdGVuY3ksXG4gICAgbWVzc2FnZXM6IENvbGxlY3Rpb25MYXRlbmN5LFxuICAgIHRyYW5zYWN0aW9uczogQ29sbGVjdGlvbkxhdGVuY3ksXG4gICAgbmV4dFVwZGF0ZVRpbWU6IG51bWJlcixcbiAgICBsYXRlbmN5OiBudW1iZXIsXG4gICAgbGFzdEJsb2NrVGltZTogbnVtYmVyLFxufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUUJsb2NrY2hhaW5EYXRhIGV4dGVuZHMgUURhdGEge1xuICAgIHRyYW5zYWN0aW9uczogUURhdGFDb2xsZWN0aW9uO1xuICAgIG1lc3NhZ2VzOiBRRGF0YUNvbGxlY3Rpb247XG4gICAgYWNjb3VudHM6IFFEYXRhQ29sbGVjdGlvbjtcbiAgICBibG9ja3M6IFFEYXRhQ29sbGVjdGlvbjtcbiAgICBibG9ja3Nfc2lnbmF0dXJlczogUURhdGFDb2xsZWN0aW9uO1xuICAgIHplcm9zdGF0ZXM6IFFEYXRhQ29sbGVjdGlvbjtcbiAgICBjb3VudGVycGFydGllczogUURhdGFDb2xsZWN0aW9uO1xuXG4gICAgbGF0ZW5jeTogTGF0ZW5jeTtcblxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IFFEYXRhT3B0aW9ucykge1xuICAgICAgICBzdXBlcihvcHRpb25zKTtcbiAgICAgICAgY29uc3QgYWRkID0gKG5hbWUsIHR5cGUsIG11dGFibGUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZENvbGxlY3Rpb24obmFtZSwgdHlwZSwgbXV0YWJsZSwgSU5ERVhFU1tuYW1lXS5pbmRleGVzKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5hY2NvdW50cyA9IGFkZCgnYWNjb3VudHMnLCBBY2NvdW50LCBRRGF0YVNjb3BlLm11dGFibGUpO1xuICAgICAgICB0aGlzLnRyYW5zYWN0aW9ucyA9IGFkZCgndHJhbnNhY3Rpb25zJywgVHJhbnNhY3Rpb24sIFFEYXRhU2NvcGUuaW1tdXRhYmxlKTtcbiAgICAgICAgdGhpcy5tZXNzYWdlcyA9IGFkZCgnbWVzc2FnZXMnLCBNZXNzYWdlLCBRRGF0YVNjb3BlLmltbXV0YWJsZSk7XG4gICAgICAgIHRoaXMuYmxvY2tzID0gYWRkKCdibG9ja3MnLCBCbG9jaywgUURhdGFTY29wZS5pbW11dGFibGUpO1xuICAgICAgICB0aGlzLmJsb2Nrc19zaWduYXR1cmVzID0gYWRkKCdibG9ja3Nfc2lnbmF0dXJlcycsIEJsb2NrU2lnbmF0dXJlcywgUURhdGFTY29wZS5pbW11dGFibGUpO1xuICAgICAgICB0aGlzLnplcm9zdGF0ZXMgPSBhZGQoJ3plcm9zdGF0ZXMnLCBaZXJvc3RhdGUsIFFEYXRhU2NvcGUuaW1tdXRhYmxlKTtcbiAgICAgICAgdGhpcy5jb3VudGVycGFydGllcyA9IGFkZCgnY291bnRlcnBhcnRpZXMnLCBDb3VudGVycGFydHksIFFEYXRhU2NvcGUuY291bnRlcnBhcnRpZXMpO1xuXG4gICAgICAgIHRoaXMubGF0ZW5jeSA9IHtcbiAgICAgICAgICAgIGJsb2Nrczoge1xuICAgICAgICAgICAgICAgIG1heFRpbWU6IDAsXG4gICAgICAgICAgICAgICAgbmV4dFVwZGF0ZVRpbWU6IDAsXG4gICAgICAgICAgICAgICAgbGF0ZW5jeTogMCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBtZXNzYWdlczoge1xuICAgICAgICAgICAgICAgIG1heFRpbWU6IDAsXG4gICAgICAgICAgICAgICAgbmV4dFVwZGF0ZVRpbWU6IDAsXG4gICAgICAgICAgICAgICAgbGF0ZW5jeTogMCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0cmFuc2FjdGlvbnM6IHtcbiAgICAgICAgICAgICAgICBtYXhUaW1lOiAwLFxuICAgICAgICAgICAgICAgIG5leHRVcGRhdGVUaW1lOiAwLFxuICAgICAgICAgICAgICAgIGxhdGVuY3k6IDAsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbmV4dFVwZGF0ZVRpbWU6IDAsXG4gICAgICAgICAgICBsYXRlbmN5OiAwLFxuICAgICAgICAgICAgbGFzdEJsb2NrVGltZTogMCxcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuYmxvY2tzLmRvY0luc2VydE9yVXBkYXRlLm9uKFwiZG9jXCIsIGFzeW5jIChibG9jaykgPT4ge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVMYXRlbmN5KHRoaXMubGF0ZW5jeS5ibG9ja3MsIGJsb2NrLmdlbl91dGltZSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnRyYW5zYWN0aW9ucy5kb2NJbnNlcnRPclVwZGF0ZS5vbihcImRvY1wiLCBhc3luYyAodHIpID0+IHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlTGF0ZW5jeSh0aGlzLmxhdGVuY3kudHJhbnNhY3Rpb25zLCB0ci5ub3cpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5tZXNzYWdlcy5kb2NJbnNlcnRPclVwZGF0ZS5vbihcImRvY1wiLCBhc3luYyAobXNnKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUxhdGVuY3kodGhpcy5sYXRlbmN5LnRyYW5zYWN0aW9ucywgbXNnLmNyZWF0ZWRfYXQpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICB1cGRhdGVMYXRlbmN5KGxhdGVuY3k6IENvbGxlY3Rpb25MYXRlbmN5LCB0aW1lSW5TZWNvbmRzPzogP251bWJlcikge1xuICAgICAgICBpZiAodGhpcy51cGRhdGVDb2xsZWN0aW9uTGF0ZW5jeShsYXRlbmN5LCB0aW1lSW5TZWNvbmRzKSkge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVMYXRlbmN5U3VtbWFyeSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdXBkYXRlQ29sbGVjdGlvbkxhdGVuY3kobGF0ZW5jeTogQ29sbGVjdGlvbkxhdGVuY3ksIHRpbWVJblNlY29uZHM/OiA/bnVtYmVyKTogYm9vbGVhbiB7XG4gICAgICAgIGlmICh0aW1lSW5TZWNvbmRzID09PSB1bmRlZmluZWQgfHwgdGltZUluU2Vjb25kcyA9PT0gbnVsbCB8fCB0aW1lSW5TZWNvbmRzID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdGltZSA9IHRpbWVJblNlY29uZHMgKiAxMDAwO1xuICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgICAgICBpZiAodGltZSA+IGxhdGVuY3kubWF4VGltZSkge1xuICAgICAgICAgICAgbGF0ZW5jeS5tYXhUaW1lID0gdGltZTtcbiAgICAgICAgfVxuICAgICAgICBsYXRlbmN5Lm5leHRVcGRhdGVUaW1lID0gbm93ICsgMzAwMDA7IC8vIExBVEVOQ1lfVVBEQVRFX0ZSRVFVRU5DWVxuICAgICAgICBsYXRlbmN5LmxhdGVuY3kgPSBNYXRoLm1heCgwLCBub3cgLSBsYXRlbmN5Lm1heFRpbWUpO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICB1cGRhdGVMYXRlbmN5U3VtbWFyeSgpIHtcbiAgICAgICAgY29uc3QgeyBibG9ja3MsIG1lc3NhZ2VzLCB0cmFuc2FjdGlvbnMgfSA9IHRoaXMubGF0ZW5jeTtcbiAgICAgICAgdGhpcy5sYXRlbmN5Lm5leHRVcGRhdGVUaW1lID0gTWF0aC5taW4oXG4gICAgICAgICAgICBibG9ja3MubmV4dFVwZGF0ZVRpbWUsXG4gICAgICAgICAgICBtZXNzYWdlcy5uZXh0VXBkYXRlVGltZSxcbiAgICAgICAgICAgIHRyYW5zYWN0aW9ucy5uZXh0VXBkYXRlVGltZSxcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5sYXRlbmN5LmxhdGVuY3kgPSBNYXRoLm1heChcbiAgICAgICAgICAgIGJsb2Nrcy5sYXRlbmN5LFxuICAgICAgICAgICAgbWVzc2FnZXMubGF0ZW5jeSxcbiAgICAgICAgICAgIHRyYW5zYWN0aW9ucy5sYXRlbmN5LFxuICAgICAgICApO1xuICAgICAgICB0aGlzLmxhdGVuY3kubGFzdEJsb2NrVGltZSA9IGJsb2Nrcy5tYXhUaW1lO1xuICAgIH1cblxuICAgIGFzeW5jIHVwZGF0ZU1heFRpbWUobGF0ZW5jeTogQ29sbGVjdGlvbkxhdGVuY3ksIGNvbGxlY3Rpb246IFFEYXRhQ29sbGVjdGlvbiwgZmllbGQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBpZiAoRGF0ZS5ub3coKSA8PSBsYXRlbmN5Lm5leHRVcGRhdGVUaW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbWF4VGltZSA9IChhd2FpdCBjb2xsZWN0aW9uLnByb3ZpZGVyLnF1ZXJ5KFxuICAgICAgICAgICAgYEZPUiBkIElOICR7Y29sbGVjdGlvbi5uYW1lfSBDT0xMRUNUIEFHR1JFR0FURSBtID0gTUFYKGQuJHtmaWVsZH0pIFJFVFVSTiB7IG1heFRpbWU6IG0gfWAsXG4gICAgICAgICAgICB7fSwgW11cbiAgICAgICAgKSlbMF0ubWF4VGltZTtcbiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlQ29sbGVjdGlvbkxhdGVuY3kobGF0ZW5jeSwgbWF4VGltZSk7XG5cbiAgICB9XG5cbiAgICBhc3luYyBnZXRMYXRlbmN5KCk6IFByb21pc2U8TGF0ZW5jeT4ge1xuICAgICAgICBjb25zdCBsYXRlbmN5ID0gdGhpcy5sYXRlbmN5O1xuICAgICAgICBpZiAoRGF0ZS5ub3coKSA+IGxhdGVuY3kubmV4dFVwZGF0ZVRpbWUpIHtcbiAgICAgICAgICAgIGxldCBoYXNVcGRhdGVzID0gYXdhaXQgdGhpcy51cGRhdGVNYXhUaW1lKGxhdGVuY3kuYmxvY2tzLCB0aGlzLmJsb2NrcywgXCJnZW5fdXRpbWVcIik7XG4gICAgICAgICAgICBpZiAoYXdhaXQgdGhpcy51cGRhdGVNYXhUaW1lKGxhdGVuY3kubWVzc2FnZXMsIHRoaXMubWVzc2FnZXMsIFwiY3JlYXRlZF9hdFwiKSkge1xuICAgICAgICAgICAgICAgIGhhc1VwZGF0ZXMgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGF3YWl0IHRoaXMudXBkYXRlTWF4VGltZShsYXRlbmN5LnRyYW5zYWN0aW9ucywgdGhpcy50cmFuc2FjdGlvbnMsIFwibm93XCIpKSB7XG4gICAgICAgICAgICAgICAgaGFzVXBkYXRlcyA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaGFzVXBkYXRlcykge1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGF0ZW5jeVN1bW1hcnkoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbGF0ZW5jeTtcbiAgICB9XG59XG4iXX0=