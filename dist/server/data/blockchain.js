"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.INDEXES = void 0;

var _counterparties = require("../graphql/counterparties");

var _data = _interopRequireDefault(require("./data"));

var _collection = require("./collection");

var _resolversGenerated = require("../graphql/resolvers-generated");

var _dataProvider = require("./data-provider");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const INDEXES = {
  blocks: {
    indexes: [(0, _dataProvider.sortedIndex)(['seq_no', 'gen_utime']), (0, _dataProvider.sortedIndex)(['gen_utime']), (0, _dataProvider.sortedIndex)(['workchain_id', 'shard', 'seq_no']), (0, _dataProvider.sortedIndex)(['workchain_id', 'shard', 'gen_utime']), (0, _dataProvider.sortedIndex)(['workchain_id', 'seq_no']), (0, _dataProvider.sortedIndex)(['workchain_id', 'gen_utime']), (0, _dataProvider.sortedIndex)(['master.min_shard_gen_utime']), (0, _dataProvider.sortedIndex)(['prev_ref.root_hash', '_key']), (0, _dataProvider.sortedIndex)(['prev_alt_ref.root_hash', '_key'])]
  },
  accounts: {
    indexes: [(0, _dataProvider.sortedIndex)(['last_trans_lt']), (0, _dataProvider.sortedIndex)(['balance'])]
  },
  messages: {
    indexes: [(0, _dataProvider.sortedIndex)(['block_id']), (0, _dataProvider.sortedIndex)(['value', 'created_at']), (0, _dataProvider.sortedIndex)(['src', 'value', 'created_at']), (0, _dataProvider.sortedIndex)(['dst', 'value', 'created_at']), (0, _dataProvider.sortedIndex)(['src', 'created_at']), (0, _dataProvider.sortedIndex)(['dst', 'created_at']), (0, _dataProvider.sortedIndex)(['created_lt']), (0, _dataProvider.sortedIndex)(['created_at'])]
  },
  transactions: {
    indexes: [(0, _dataProvider.sortedIndex)(['block_id']), (0, _dataProvider.sortedIndex)(['in_msg']), (0, _dataProvider.sortedIndex)(['out_msgs[*]']), (0, _dataProvider.sortedIndex)(['account_addr', 'now']), (0, _dataProvider.sortedIndex)(['now']), (0, _dataProvider.sortedIndex)(['lt']), (0, _dataProvider.sortedIndex)(['account_addr', 'orig_status', 'end_status']), (0, _dataProvider.sortedIndex)(['now', 'account_addr', 'lt'])]
  },
  blocks_signatures: {
    indexes: [(0, _dataProvider.sortedIndex)(['signatures[*].node_id', 'gen_utime'])]
  },
  zerostates: {
    indexes: []
  },
  counterparties: {
    indexes: []
  }
};
exports.INDEXES = INDEXES;
Object.values(INDEXES).forEach(collection => {
  collection.indexes = collection.indexes.concat({
    fields: ['_key']
  });
});

class QBlockchainData extends _data.default {
  constructor(options) {
    super(options);

    const add = (name, type, mutable) => {
      return this.addCollection(name, type, mutable, INDEXES[name].indexes);
    };

    this.accounts = add('accounts', _resolversGenerated.Account, _collection.QDataScope.mutable);
    this.transactions = add('transactions', _resolversGenerated.Transaction, _collection.QDataScope.immutable);
    this.messages = add('messages', _resolversGenerated.Message, _collection.QDataScope.immutable);
    this.blocks = add('blocks', _resolversGenerated.Block, _collection.QDataScope.immutable);
    this.blocks_signatures = add('blocks_signatures', _resolversGenerated.BlockSignatures, _collection.QDataScope.immutable);
    this.zerostates = add('zerostates', _resolversGenerated.Zerostate, _collection.QDataScope.immutable);
    this.counterparties = add('counterparties', _counterparties.Counterparty, _collection.QDataScope.counterparties);
    this.lastBlockTime = null;
    this.lastBlockTimeUpdateTime = null;
    this.blocks.docInsertOrUpdate.on("doc", async block => {
      if (block.gen_utime) {
        this.lastBlockTime = block.gen_utime;
        this.lastBlockTimeUpdateTime = Date.now();
      }
    });
  }

  async getLastBlockTime() {
    const isRefreshRequired = this.lastBlockTime === null || this.lastBlockTimeUpdateTime === null || Date.now() - (this.lastBlockTimeUpdateTime || 0) > 60000;

    if (isRefreshRequired) {
      const result = await this.blocks.provider.query("FOR b IN blocks COLLECT AGGREGATE m = MAX(b.gen_utime) RETURN { maxTime: m }", {}, []);
      this.lastBlockTime = result[0].maxTime;
      this.lastBlockTimeUpdateTime = Date.now();
    }

    return this.lastBlockTime || 0;
  }

}

exports.default = QBlockchainData;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9ibG9ja2NoYWluLmpzIl0sIm5hbWVzIjpbIklOREVYRVMiLCJibG9ja3MiLCJpbmRleGVzIiwiYWNjb3VudHMiLCJtZXNzYWdlcyIsInRyYW5zYWN0aW9ucyIsImJsb2Nrc19zaWduYXR1cmVzIiwiemVyb3N0YXRlcyIsImNvdW50ZXJwYXJ0aWVzIiwiT2JqZWN0IiwidmFsdWVzIiwiZm9yRWFjaCIsImNvbGxlY3Rpb24iLCJjb25jYXQiLCJmaWVsZHMiLCJRQmxvY2tjaGFpbkRhdGEiLCJRRGF0YSIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImFkZCIsIm5hbWUiLCJ0eXBlIiwibXV0YWJsZSIsImFkZENvbGxlY3Rpb24iLCJBY2NvdW50IiwiUURhdGFTY29wZSIsIlRyYW5zYWN0aW9uIiwiaW1tdXRhYmxlIiwiTWVzc2FnZSIsIkJsb2NrIiwiQmxvY2tTaWduYXR1cmVzIiwiWmVyb3N0YXRlIiwiQ291bnRlcnBhcnR5IiwibGFzdEJsb2NrVGltZSIsImxhc3RCbG9ja1RpbWVVcGRhdGVUaW1lIiwiZG9jSW5zZXJ0T3JVcGRhdGUiLCJvbiIsImJsb2NrIiwiZ2VuX3V0aW1lIiwiRGF0ZSIsIm5vdyIsImdldExhc3RCbG9ja1RpbWUiLCJpc1JlZnJlc2hSZXF1aXJlZCIsInJlc3VsdCIsInByb3ZpZGVyIiwicXVlcnkiLCJtYXhUaW1lIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBa0JBOztBQUVBOztBQUNBOztBQUNBOztBQVFBOzs7O0FBOUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQWtCTyxNQUFNQSxPQUFPLEdBQUc7QUFDbkJDLEVBQUFBLE1BQU0sRUFBRTtBQUNKQyxJQUFBQSxPQUFPLEVBQUUsQ0FDTCwrQkFBWSxDQUFDLFFBQUQsRUFBVyxXQUFYLENBQVosQ0FESyxFQUVMLCtCQUFZLENBQUMsV0FBRCxDQUFaLENB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SDs7QUFHcUIsUUFBaEJDLGdCQUFnQixHQUFvQjtBQUN0QyxVQUFNQyxpQkFBaUIsR0FDbkIsS0FBS1QsYUFBTCxLQUF1QixJQUF2QixJQUNHLEtBQUtDLHVCQUFMLEtBQWlDLElBRHBDLElBRUlLLElBQUksQ0FBQ0MsR0FBTCxNQUFjLEtBQUtOLHVCQUFMLElBQWdDLENBQTlDLENBQUQsR0FBcUQsS0FINUQ7O0FBSUEsUUFBSVEsaUJBQUosRUFBdUI7QUFDbkIsWUFBTUMsTUFBTSxHQUFHLE1BQU0sS0FBSzFDLE1BQUwsQ0FBWTJDLFFBQVosQ0FBcUJDLEtBQXJCLENBQ2pCLDhFQURpQixFQUVqQixFQUZpQixFQUViLEVBRmEsQ0FBckI7QUFJQSxXQUFLWixhQUFMLEdBQXFCVSxNQUFNLENBQUMsQ0FBRCxDQUFOLENBQVVHLE9BQS9CO0FBQ0EsV0FBS1osdUJBQUwsR0FBK0JLLElBQUksQ0FBQ0MsR0FBTCxFQUEvQjtBQUNIOztBQUNELFdBQU8sS0FBS1AsYUFBTCxJQUFzQixDQUE3QjtBQUNIOztBQWpEOEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTgtMjAyMCBUT04gREVWIFNPTFVUSU9OUyBMVEQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIFNPRlRXQVJFIEVWQUxVQVRJT04gTGljZW5zZSAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlXG4gKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGVcbiAqIExpY2Vuc2UgYXQ6XG4gKlxuICogaHR0cDovL3d3dy50b24uZGV2L2xpY2Vuc2VzXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBUT04gREVWIHNvZnR3YXJlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbi8vIEBmbG93XG5cbmltcG9ydCB7IENvdW50ZXJwYXJ0eSB9IGZyb20gXCIuLi9ncmFwaHFsL2NvdW50ZXJwYXJ0aWVzXCI7XG5pbXBvcnQgdHlwZSB7IFFEYXRhT3B0aW9ucyB9IGZyb20gJy4vZGF0YSc7XG5pbXBvcnQgUURhdGEgZnJvbSAnLi9kYXRhJztcbmltcG9ydCB7IFFEYXRhQ29sbGVjdGlvbiwgUURhdGFTY29wZSB9IGZyb20gJy4vY29sbGVjdGlvbic7XG5pbXBvcnQge1xuICAgIEFjY291bnQsXG4gICAgQmxvY2ssXG4gICAgQmxvY2tTaWduYXR1cmVzLFxuICAgIE1lc3NhZ2UsXG4gICAgVHJhbnNhY3Rpb24sXG4gICAgWmVyb3N0YXRlLFxufSBmcm9tICcuLi9ncmFwaHFsL3Jlc29sdmVycy1nZW5lcmF0ZWQnO1xuaW1wb3J0IHsgc29ydGVkSW5kZXggfSBmcm9tICcuL2RhdGEtcHJvdmlkZXInO1xuXG5leHBvcnQgY29uc3QgSU5ERVhFUyA9IHtcbiAgICBibG9ja3M6IHtcbiAgICAgICAgaW5kZXhlczogW1xuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydzZXFfbm8nLCAnZ2VuX3V0aW1lJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydnZW5fdXRpbWUnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3dvcmtjaGFpbl9pZCcsICdzaGFyZCcsICdzZXFfbm8nXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3dvcmtjaGFpbl9pZCcsICdzaGFyZCcsICdnZW5fdXRpbWUnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3dvcmtjaGFpbl9pZCcsICdzZXFfbm8nXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3dvcmtjaGFpbl9pZCcsICdnZW5fdXRpbWUnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ21hc3Rlci5taW5fc2hhcmRfZ2VuX3V0aW1lJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydwcmV2X3JlZi5yb290X2hhc2gnLCAnX2tleSddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsncHJldl9hbHRfcmVmLnJvb3RfaGFzaCcsICdfa2V5J10pLFxuICAgICAgICBdLFxuICAgIH0sXG4gICAgYWNjb3VudHM6IHtcbiAgICAgICAgaW5kZXhlczogW1xuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydsYXN0X3RyYW5zX2x0J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydiYWxhbmNlJ10pLFxuICAgICAgICBdLFxuICAgIH0sXG4gICAgbWVzc2FnZXM6IHtcbiAgICAgICAgaW5kZXhlczogW1xuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydibG9ja19pZCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsndmFsdWUnLCAnY3JlYXRlZF9hdCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnc3JjJywgJ3ZhbHVlJywgJ2NyZWF0ZWRfYXQnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2RzdCcsICd2YWx1ZScsICdjcmVhdGVkX2F0J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydzcmMnLCAnY3JlYXRlZF9hdCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnZHN0JywgJ2NyZWF0ZWRfYXQnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2NyZWF0ZWRfbHQnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2NyZWF0ZWRfYXQnXSksXG4gICAgICAgIF0sXG4gICAgfSxcbiAgICB0cmFuc2FjdGlvbnM6IHtcbiAgICAgICAgaW5kZXhlczogW1xuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydibG9ja19pZCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnaW5fbXNnJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydvdXRfbXNnc1sqXSddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnYWNjb3VudF9hZGRyJywgJ25vdyddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnbm93J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydsdCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnYWNjb3VudF9hZGRyJywgJ29yaWdfc3RhdHVzJywgJ2VuZF9zdGF0dXMnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ25vdycsICdhY2NvdW50X2FkZHInLCAnbHQnXSksXG4gICAgICAgIF0sXG4gICAgfSxcbiAgICBibG9ja3Nfc2lnbmF0dXJlczoge1xuICAgICAgICBpbmRleGVzOiBbXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3NpZ25hdHVyZXNbKl0ubm9kZV9pZCcsICdnZW5fdXRpbWUnXSksXG4gICAgICAgIF0sXG4gICAgfSxcbiAgICB6ZXJvc3RhdGVzOiB7XG4gICAgICAgIGluZGV4ZXM6IFtdLFxuICAgIH0sXG4gICAgY291bnRlcnBhcnRpZXM6IHtcbiAgICAgICAgaW5kZXhlczogW10sXG4gICAgfSxcbn07XG5cblxuT2JqZWN0LnZhbHVlcyhJTkRFWEVTKS5mb3JFYWNoKChjb2xsZWN0aW9uOiBhbnkpID0+IHtcbiAgICBjb2xsZWN0aW9uLmluZGV4ZXMgPSBjb2xsZWN0aW9uLmluZGV4ZXMuY29uY2F0KHsgZmllbGRzOiBbJ19rZXknXSB9KTtcbn0pO1xuXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFFCbG9ja2NoYWluRGF0YSBleHRlbmRzIFFEYXRhIHtcbiAgICB0cmFuc2FjdGlvbnM6IFFEYXRhQ29sbGVjdGlvbjtcbiAgICBtZXNzYWdlczogUURhdGFDb2xsZWN0aW9uO1xuICAgIGFjY291bnRzOiBRRGF0YUNvbGxlY3Rpb247XG4gICAgYmxvY2tzOiBRRGF0YUNvbGxlY3Rpb247XG4gICAgYmxvY2tzX3NpZ25hdHVyZXM6IFFEYXRhQ29sbGVjdGlvbjtcbiAgICB6ZXJvc3RhdGVzOiBRRGF0YUNvbGxlY3Rpb247XG4gICAgY291bnRlcnBhcnRpZXM6IFFEYXRhQ29sbGVjdGlvbjtcblxuICAgIGxhc3RCbG9ja1RpbWU6ID9udW1iZXI7XG4gICAgbGFzdEJsb2NrVGltZVVwZGF0ZVRpbWU6ID9udW1iZXI7XG5cbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiBRRGF0YU9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIob3B0aW9ucyk7XG4gICAgICAgIGNvbnN0IGFkZCA9IChuYW1lLCB0eXBlLCBtdXRhYmxlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRDb2xsZWN0aW9uKG5hbWUsIHR5cGUsIG11dGFibGUsIElOREVYRVNbbmFtZV0uaW5kZXhlcyk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuYWNjb3VudHMgPSBhZGQoJ2FjY291bnRzJywgQWNjb3VudCwgUURhdGFTY29wZS5tdXRhYmxlKTtcbiAgICAgICAgdGhpcy50cmFuc2FjdGlvbnMgPSBhZGQoJ3RyYW5zYWN0aW9ucycsIFRyYW5zYWN0aW9uLCBRRGF0YVNjb3BlLmltbXV0YWJsZSk7XG4gICAgICAgIHRoaXMubWVzc2FnZXMgPSBhZGQoJ21lc3NhZ2VzJywgTWVzc2FnZSwgUURhdGFTY29wZS5pbW11dGFibGUpO1xuICAgICAgICB0aGlzLmJsb2NrcyA9IGFkZCgnYmxvY2tzJywgQmxvY2ssIFFEYXRhU2NvcGUuaW1tdXRhYmxlKTtcbiAgICAgICAgdGhpcy5ibG9ja3Nfc2lnbmF0dXJlcyA9IGFkZCgnYmxvY2tzX3NpZ25hdHVyZXMnLCBCbG9ja1NpZ25hdHVyZXMsIFFEYXRhU2NvcGUuaW1tdXRhYmxlKTtcbiAgICAgICAgdGhpcy56ZXJvc3RhdGVzID0gYWRkKCd6ZXJvc3RhdGVzJywgWmVyb3N0YXRlLCBRRGF0YVNjb3BlLmltbXV0YWJsZSk7XG4gICAgICAgIHRoaXMuY291bnRlcnBhcnRpZXMgPSBhZGQoJ2NvdW50ZXJwYXJ0aWVzJywgQ291bnRlcnBhcnR5LCBRRGF0YVNjb3BlLmNvdW50ZXJwYXJ0aWVzKTtcbiAgICAgICAgdGhpcy5sYXN0QmxvY2tUaW1lID0gbnVsbDtcbiAgICAgICAgdGhpcy5sYXN0QmxvY2tUaW1lVXBkYXRlVGltZSA9IG51bGw7XG4gICAgICAgIHRoaXMuYmxvY2tzLmRvY0luc2VydE9yVXBkYXRlLm9uKFwiZG9jXCIsIGFzeW5jIChibG9jaykgPT4ge1xuICAgICAgICAgICAgaWYgKGJsb2NrLmdlbl91dGltZSkge1xuICAgICAgICAgICAgICAgIHRoaXMubGFzdEJsb2NrVGltZSA9IGJsb2NrLmdlbl91dGltZTtcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3RCbG9ja1RpbWVVcGRhdGVUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG5cbiAgICBhc3luYyBnZXRMYXN0QmxvY2tUaW1lKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGNvbnN0IGlzUmVmcmVzaFJlcXVpcmVkID1cbiAgICAgICAgICAgIHRoaXMubGFzdEJsb2NrVGltZSA9PT0gbnVsbFxuICAgICAgICAgICAgfHwgdGhpcy5sYXN0QmxvY2tUaW1lVXBkYXRlVGltZSA9PT0gbnVsbFxuICAgICAgICAgICAgfHwgKERhdGUubm93KCkgLSAodGhpcy5sYXN0QmxvY2tUaW1lVXBkYXRlVGltZSB8fCAwKSkgPiA2MDAwMFxuICAgICAgICBpZiAoaXNSZWZyZXNoUmVxdWlyZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuYmxvY2tzLnByb3ZpZGVyLnF1ZXJ5KFxuICAgICAgICAgICAgICAgIFwiRk9SIGIgSU4gYmxvY2tzIENPTExFQ1QgQUdHUkVHQVRFIG0gPSBNQVgoYi5nZW5fdXRpbWUpIFJFVFVSTiB7IG1heFRpbWU6IG0gfVwiLFxuICAgICAgICAgICAgICAgIHt9LCBbXVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHRoaXMubGFzdEJsb2NrVGltZSA9IHJlc3VsdFswXS5tYXhUaW1lO1xuICAgICAgICAgICAgdGhpcy5sYXN0QmxvY2tUaW1lVXBkYXRlVGltZSA9IERhdGUubm93KCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMubGFzdEJsb2NrVGltZSB8fCAwO1xuICAgIH1cbn1cbiJdfQ==