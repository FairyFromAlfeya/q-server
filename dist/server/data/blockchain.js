"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _arangoProvider = require("./arango-provider");

var _collection = require("./collection");

var _auth = require("../auth");

var _config = require("../config");

var _logs = _interopRequireDefault(require("../logs"));

var _resolversGenerated = require("../graphql/resolvers-generated");

var _opentracing = require("opentracing");

var _tracer = require("../tracer");

var _utils = require("../utils");

var _broker = require("./broker");

var _data = require("./data");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
function createBroker(brokerName, logs, config) {
  const arangoDb = (dbName, segment, config) => new _arangoProvider.ArangoProvider(logs.create(`${brokerName}_${dbName}`), segment, config);

  return new _broker.QDataBroker({
    mut: arangoDb('mutable', _data.dataSegment.MUTABLE, config.mut),
    hot: arangoDb('hot', _data.dataSegment.IMMUTABLE, config.hot),
    cold: config.cold.map(x => arangoDb('cold', _data.dataSegment.IMMUTABLE, x)),
    cache: _data.missingDataCache
  });
}

class QBlockchainData {
  constructor(config, logs, auth, tracer, stats) {
    this.config = config;
    this.log = logs.create('data');
    this.auth = auth;
    this.tracer = tracer;
    this.statPostCount = new _tracer.StatsCounter(stats, _config.STATS.post.count, []);
    this.statPostFailed = new _tracer.StatsCounter(stats, _config.STATS.post.failed, []);
    this.broker = createBroker('fast', logs, config.data);
    this.slowQueriesBroker = createBroker('slow', logs, config.slowQueriesData);
    this.collections = [];
    this.collectionsByName = new Map();

    const addCollection = (name, docType) => {
      const collection = new _collection.QDataCollection({
        name,
        docType,
        logs,
        auth,
        tracer,
        stats,
        broker: this.broker,
        slowQueriesBroker: this.slowQueriesBroker,
        isTests: config.isTests || false
      });
      this.collections.push(collection);
      this.collectionsByName.set(name, collection);
      return collection;
    };

    this.transactions = addCollection('transactions', _resolversGenerated.Transaction);
    this.messages = addCollection('messages', _resolversGenerated.Message);
    this.accounts = addCollection('accounts', _resolversGenerated.Account);
    this.blocks = addCollection('blocks', _resolversGenerated.Block);
    this.blocks_signatures = addCollection('blocks_signatures', _resolversGenerated.BlockSignatures);
  }

  start() {
    this.broker.start();
    this.slowQueriesBroker.start();
  }

  dropCachedDbInfo() {
    this.collections.forEach(x => x.dropCachedDbInfo());
  }

  async query(segment, text, vars, orderBy) {
    return (0, _utils.wrap)(this.log, 'QUERY', {
      text,
      vars
    }, async () => {
      return this.broker.query({
        segment,
        text,
        vars,
        orderBy
      });
    });
  }

  async finishOperations(operationIds) {
    let count = 0;
    this.collections.forEach(x => count += x.finishOperations(operationIds));
    return count;
  }

}

exports.default = QBlockchainData;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9ibG9ja2NoYWluLmpzIl0sIm5hbWVzIjpbImNyZWF0ZUJyb2tlciIsImJyb2tlck5hbWUiLCJsb2dzIiwiY29uZmlnIiwiYXJhbmdvRGIiLCJkYk5hbWUiLCJzZWdtZW50IiwiQXJhbmdvUHJvdmlkZXIiLCJjcmVhdGUiLCJRRGF0YUJyb2tlciIsIm11dCIsImRhdGFTZWdtZW50IiwiTVVUQUJMRSIsImhvdCIsIklNTVVUQUJMRSIsImNvbGQiLCJtYXAiLCJ4IiwiY2FjaGUiLCJtaXNzaW5nRGF0YUNhY2hlIiwiUUJsb2NrY2hhaW5EYXRhIiwiY29uc3RydWN0b3IiLCJhdXRoIiwidHJhY2VyIiwic3RhdHMiLCJsb2ciLCJzdGF0UG9zdENvdW50IiwiU3RhdHNDb3VudGVyIiwiU1RBVFMiLCJwb3N0IiwiY291bnQiLCJzdGF0UG9zdEZhaWxlZCIsImZhaWxlZCIsImJyb2tlciIsImRhdGEiLCJzbG93UXVlcmllc0Jyb2tlciIsInNsb3dRdWVyaWVzRGF0YSIsImNvbGxlY3Rpb25zIiwiY29sbGVjdGlvbnNCeU5hbWUiLCJNYXAiLCJhZGRDb2xsZWN0aW9uIiwibmFtZSIsImRvY1R5cGUiLCJjb2xsZWN0aW9uIiwiUURhdGFDb2xsZWN0aW9uIiwiaXNUZXN0cyIsInB1c2giLCJzZXQiLCJ0cmFuc2FjdGlvbnMiLCJUcmFuc2FjdGlvbiIsIm1lc3NhZ2VzIiwiTWVzc2FnZSIsImFjY291bnRzIiwiQWNjb3VudCIsImJsb2NrcyIsIkJsb2NrIiwiYmxvY2tzX3NpZ25hdHVyZXMiLCJCbG9ja1NpZ25hdHVyZXMiLCJzdGFydCIsImRyb3BDYWNoZWREYkluZm8iLCJmb3JFYWNoIiwicXVlcnkiLCJ0ZXh0IiwidmFycyIsIm9yZGVyQnkiLCJmaW5pc2hPcGVyYXRpb25zIiwib3BlcmF0aW9uSWRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBa0JBOztBQUNBOztBQUNBOztBQUVBOztBQUVBOztBQUVBOztBQUNBOztBQUNB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LENBQUMsQ0FBQ2dELGdCQUFGLENBQW1CQyxZQUFuQixDQUF4QztBQUNBLFdBQU9wQyxLQUFQO0FBQ0g7O0FBMUZnQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAxOC0yMDIwIFRPTiBERVYgU09MVVRJT05TIExURC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgU09GVFdBUkUgRVZBTFVBVElPTiBMaWNlbnNlICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2VcbiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZVxuICogTGljZW5zZSBhdDpcbiAqXG4gKiBodHRwOi8vd3d3LnRvbi5kZXYvbGljZW5zZXNcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIFRPTiBERVYgc29mdHdhcmUgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuLy8gQGZsb3dcblxuaW1wb3J0IHsgQXJhbmdvUHJvdmlkZXIgfSBmcm9tICcuL2FyYW5nby1wcm92aWRlcic7XG5pbXBvcnQgeyBRRGF0YUNvbGxlY3Rpb24gfSBmcm9tICcuL2NvbGxlY3Rpb24nO1xuaW1wb3J0IHsgQXV0aCB9IGZyb20gJy4uL2F1dGgnO1xuaW1wb3J0IHR5cGUgeyBRQ29uZmlnLCBRRGF0YUJyb2tlckNvbmZpZywgUUFyYW5nb0NvbmZpZyB9IGZyb20gJy4uL2NvbmZpZydcbmltcG9ydCB7IFNUQVRTIH0gZnJvbSAnLi4vY29uZmlnJztcbmltcG9ydCB0eXBlIHsgUUxvZyB9IGZyb20gJy4uL2xvZ3MnO1xuaW1wb3J0IFFMb2dzIGZyb20gJy4uL2xvZ3MnXG5pbXBvcnQgdHlwZSB7IE9yZGVyQnksIFFUeXBlIH0gZnJvbSAnLi4vZmlsdGVyL2ZpbHRlcnMnO1xuaW1wb3J0IHsgQWNjb3VudCwgQmxvY2ssIEJsb2NrU2lnbmF0dXJlcywgTWVzc2FnZSwgVHJhbnNhY3Rpb24gfSBmcm9tICcuLi9ncmFwaHFsL3Jlc29sdmVycy1nZW5lcmF0ZWQnO1xuaW1wb3J0IHsgVHJhY2VyIH0gZnJvbSAnb3BlbnRyYWNpbmcnO1xuaW1wb3J0IHsgU3RhdHNDb3VudGVyIH0gZnJvbSAnLi4vdHJhY2VyJztcbmltcG9ydCB0eXBlIHsgSVN0YXRzIH0gZnJvbSAnLi4vdHJhY2VyJztcbmltcG9ydCB7IHdyYXAgfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyBRRGF0YUJyb2tlciB9IGZyb20gJy4vYnJva2VyJztcbmltcG9ydCB0eXBlIHsgUURhdGFTZWdtZW50IH0gZnJvbSAnLi9kYXRhJztcbmltcG9ydCB7IGRhdGFTZWdtZW50LCBtaXNzaW5nRGF0YUNhY2hlIH0gZnJvbSAnLi9kYXRhJztcblxuXG5mdW5jdGlvbiBjcmVhdGVCcm9rZXIoXG4gICAgYnJva2VyTmFtZTogc3RyaW5nLFxuICAgIGxvZ3M6IFFMb2dzLFxuICAgIGNvbmZpZzogUURhdGFCcm9rZXJDb25maWcsXG4pOiBRRGF0YUJyb2tlciB7XG4gICAgY29uc3QgYXJhbmdvRGIgPSAoZGJOYW1lOiBzdHJpbmcsIHNlZ21lbnQ6IFFEYXRhU2VnbWVudCwgY29uZmlnOiBRQXJhbmdvQ29uZmlnKTogQXJhbmdvUHJvdmlkZXIgPT4gKFxuICAgICAgICBuZXcgQXJhbmdvUHJvdmlkZXIobG9ncy5jcmVhdGUoYCR7YnJva2VyTmFtZX1fJHtkYk5hbWV9YCksIHNlZ21lbnQsIGNvbmZpZylcbiAgICApO1xuICAgIHJldHVybiBuZXcgUURhdGFCcm9rZXIoe1xuICAgICAgICBtdXQ6IGFyYW5nb0RiKCdtdXRhYmxlJywgZGF0YVNlZ21lbnQuTVVUQUJMRSwgY29uZmlnLm11dCksXG4gICAgICAgIGhvdDogYXJhbmdvRGIoJ2hvdCcsIGRhdGFTZWdtZW50LklNTVVUQUJMRSwgY29uZmlnLmhvdCksXG4gICAgICAgIGNvbGQ6IGNvbmZpZy5jb2xkLm1hcCh4ID0+IGFyYW5nb0RiKCdjb2xkJywgZGF0YVNlZ21lbnQuSU1NVVRBQkxFLCB4KSksXG4gICAgICAgIGNhY2hlOiBtaXNzaW5nRGF0YUNhY2hlLFxuICAgIH0pXG59XG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUUJsb2NrY2hhaW5EYXRhIHtcbiAgICBjb25maWc6IFFDb25maWc7XG4gICAgbG9nOiBRTG9nO1xuXG4gICAgYnJva2VyOiBRRGF0YUJyb2tlcjtcbiAgICBzbG93UXVlcmllc0Jyb2tlcjogUURhdGFCcm9rZXI7XG5cbiAgICBhdXRoOiBBdXRoO1xuICAgIHRyYWNlcjogVHJhY2VyO1xuICAgIHN0YXRQb3N0Q291bnQ6IFN0YXRzQ291bnRlcjtcbiAgICBzdGF0UG9zdEZhaWxlZDogU3RhdHNDb3VudGVyO1xuXG4gICAgdHJhbnNhY3Rpb25zOiBRRGF0YUNvbGxlY3Rpb247XG4gICAgbWVzc2FnZXM6IFFEYXRhQ29sbGVjdGlvbjtcbiAgICBhY2NvdW50czogUURhdGFDb2xsZWN0aW9uO1xuICAgIGJsb2NrczogUURhdGFDb2xsZWN0aW9uO1xuICAgIGJsb2Nrc19zaWduYXR1cmVzOiBRRGF0YUNvbGxlY3Rpb247XG5cbiAgICBjb2xsZWN0aW9uczogUURhdGFDb2xsZWN0aW9uW107XG4gICAgY29sbGVjdGlvbnNCeU5hbWU6IE1hcDxzdHJpbmcsIFFEYXRhQ29sbGVjdGlvbj47XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgY29uZmlnOiBRQ29uZmlnLFxuICAgICAgICBsb2dzOiBRTG9ncyxcbiAgICAgICAgYXV0aDogQXV0aCxcbiAgICAgICAgdHJhY2VyOiBUcmFjZXIsXG4gICAgICAgIHN0YXRzOiBJU3RhdHMsXG4gICAgKSB7XG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgICAgICB0aGlzLmxvZyA9IGxvZ3MuY3JlYXRlKCdkYXRhJyk7XG4gICAgICAgIHRoaXMuYXV0aCA9IGF1dGg7XG4gICAgICAgIHRoaXMudHJhY2VyID0gdHJhY2VyO1xuXG4gICAgICAgIHRoaXMuc3RhdFBvc3RDb3VudCA9IG5ldyBTdGF0c0NvdW50ZXIoc3RhdHMsIFNUQVRTLnBvc3QuY291bnQsIFtdKTtcbiAgICAgICAgdGhpcy5zdGF0UG9zdEZhaWxlZCA9IG5ldyBTdGF0c0NvdW50ZXIoc3RhdHMsIFNUQVRTLnBvc3QuZmFpbGVkLCBbXSk7XG5cbiAgICAgICAgdGhpcy5icm9rZXIgPSBjcmVhdGVCcm9rZXIoJ2Zhc3QnLCBsb2dzLCBjb25maWcuZGF0YSlcbiAgICAgICAgdGhpcy5zbG93UXVlcmllc0Jyb2tlciA9IGNyZWF0ZUJyb2tlcignc2xvdycsIGxvZ3MsIGNvbmZpZy5zbG93UXVlcmllc0RhdGEpO1xuXG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnMgPSBbXTtcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9uc0J5TmFtZSA9IG5ldyBNYXAoKTtcblxuICAgICAgICBjb25zdCBhZGRDb2xsZWN0aW9uID0gKG5hbWU6IHN0cmluZywgZG9jVHlwZTogUVR5cGUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbGxlY3Rpb24gPSBuZXcgUURhdGFDb2xsZWN0aW9uKHtcbiAgICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgICAgIGRvY1R5cGUsXG4gICAgICAgICAgICAgICAgbG9ncyxcbiAgICAgICAgICAgICAgICBhdXRoLFxuICAgICAgICAgICAgICAgIHRyYWNlcixcbiAgICAgICAgICAgICAgICBzdGF0cyxcbiAgICAgICAgICAgICAgICBicm9rZXI6IHRoaXMuYnJva2VyLFxuICAgICAgICAgICAgICAgIHNsb3dRdWVyaWVzQnJva2VyOiB0aGlzLnNsb3dRdWVyaWVzQnJva2VyLFxuICAgICAgICAgICAgICAgIGlzVGVzdHM6IGNvbmZpZy5pc1Rlc3RzIHx8IGZhbHNlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLmNvbGxlY3Rpb25zLnB1c2goY29sbGVjdGlvbik7XG4gICAgICAgICAgICB0aGlzLmNvbGxlY3Rpb25zQnlOYW1lLnNldChuYW1lLCBjb2xsZWN0aW9uKTtcbiAgICAgICAgICAgIHJldHVybiBjb2xsZWN0aW9uO1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMudHJhbnNhY3Rpb25zID0gYWRkQ29sbGVjdGlvbigndHJhbnNhY3Rpb25zJywgVHJhbnNhY3Rpb24pO1xuICAgICAgICB0aGlzLm1lc3NhZ2VzID0gYWRkQ29sbGVjdGlvbignbWVzc2FnZXMnLCBNZXNzYWdlKTtcbiAgICAgICAgdGhpcy5hY2NvdW50cyA9IGFkZENvbGxlY3Rpb24oJ2FjY291bnRzJywgQWNjb3VudCk7XG4gICAgICAgIHRoaXMuYmxvY2tzID0gYWRkQ29sbGVjdGlvbignYmxvY2tzJywgQmxvY2spO1xuICAgICAgICB0aGlzLmJsb2Nrc19zaWduYXR1cmVzID0gYWRkQ29sbGVjdGlvbignYmxvY2tzX3NpZ25hdHVyZXMnLCBCbG9ja1NpZ25hdHVyZXMpO1xuICAgIH1cblxuICAgIHN0YXJ0KCkge1xuICAgICAgICB0aGlzLmJyb2tlci5zdGFydCgpO1xuICAgICAgICB0aGlzLnNsb3dRdWVyaWVzQnJva2VyLnN0YXJ0KCk7XG4gICAgfVxuXG4gICAgZHJvcENhY2hlZERiSW5mbygpIHtcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9ucy5mb3JFYWNoKCh4OiBRRGF0YUNvbGxlY3Rpb24pID0+IHguZHJvcENhY2hlZERiSW5mbygpKTtcbiAgICB9XG5cbiAgICBhc3luYyBxdWVyeShzZWdtZW50OiBRRGF0YVNlZ21lbnQsIHRleHQ6IHN0cmluZywgdmFyczogeyBbc3RyaW5nXTogYW55IH0sIG9yZGVyQnk6IE9yZGVyQnlbXSkge1xuICAgICAgICByZXR1cm4gd3JhcCh0aGlzLmxvZywgJ1FVRVJZJywgeyB0ZXh0LCB2YXJzIH0sIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmJyb2tlci5xdWVyeSh7XG4gICAgICAgICAgICAgICAgc2VnbWVudCxcbiAgICAgICAgICAgICAgICB0ZXh0LFxuICAgICAgICAgICAgICAgIHZhcnMsXG4gICAgICAgICAgICAgICAgb3JkZXJCeSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5pc2hPcGVyYXRpb25zKG9wZXJhdGlvbklkczogU2V0PHN0cmluZz4pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICBsZXQgY291bnQgPSAwO1xuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zLmZvckVhY2goeCA9PiAoY291bnQgKz0geC5maW5pc2hPcGVyYXRpb25zKG9wZXJhdGlvbklkcykpKTtcbiAgICAgICAgcmV0dXJuIGNvdW50O1xuICAgIH1cbn1cbiJdfQ==