"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.INDEXES = void 0;

var _counterparties = require("../graphql/counterparties");

var _data = _interopRequireDefault(require("./data"));

var _collection = require("./collection");

var _resolversGenerated = require("../graphql/resolvers-generated");

var _dataProvider = require("./data-provider");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const INDEXES = {
  blocks: {
    indexes: [(0, _dataProvider.sortedIndex)(['seq_no', 'gen_utime']), (0, _dataProvider.sortedIndex)(['gen_utime']), (0, _dataProvider.sortedIndex)(['workchain_id', 'shard', 'seq_no']), (0, _dataProvider.sortedIndex)(['workchain_id', 'shard', 'gen_utime']), (0, _dataProvider.sortedIndex)(['workchain_id', 'seq_no']), (0, _dataProvider.sortedIndex)(['workchain_id', 'gen_utime']), (0, _dataProvider.sortedIndex)(['master.min_shard_gen_utime']), (0, _dataProvider.sortedIndex)(['prev_ref.root_hash', '_key']), (0, _dataProvider.sortedIndex)(['prev_alt_ref.root_hash', '_key'])]
  },
  accounts: {
    indexes: [(0, _dataProvider.sortedIndex)(['last_trans_lt']), (0, _dataProvider.sortedIndex)(['balance'])]
  },
  messages: {
    indexes: [(0, _dataProvider.sortedIndex)(['block_id']), (0, _dataProvider.sortedIndex)(['value', 'created_at']), (0, _dataProvider.sortedIndex)(['src', 'value', 'created_at']), (0, _dataProvider.sortedIndex)(['dst', 'value', 'created_at']), (0, _dataProvider.sortedIndex)(['src', 'created_at']), (0, _dataProvider.sortedIndex)(['dst', 'created_at']), (0, _dataProvider.sortedIndex)(['created_lt']), (0, _dataProvider.sortedIndex)(['created_at'])]
  },
  transactions: {
    indexes: [(0, _dataProvider.sortedIndex)(['block_id']), (0, _dataProvider.sortedIndex)(['in_msg']), (0, _dataProvider.sortedIndex)(['out_msgs[*]']), (0, _dataProvider.sortedIndex)(['account_addr', 'now']), (0, _dataProvider.sortedIndex)(['now']), (0, _dataProvider.sortedIndex)(['lt']), (0, _dataProvider.sortedIndex)(['account_addr', 'orig_status', 'end_status']), (0, _dataProvider.sortedIndex)(['now', 'account_addr', 'lt'])]
  },
  blocks_signatures: {
    indexes: [(0, _dataProvider.sortedIndex)(['signatures[*].node_id', 'gen_utime'])]
  },
  zerostates: {
    indexes: []
  },
  counterparties: {
    indexes: []
  }
};
exports.INDEXES = INDEXES;
Object.values(INDEXES).forEach(collection => {
  collection.indexes = collection.indexes.concat({
    fields: ['_key']
  });
});

class QBlockchainData extends _data.default {
  constructor(options) {
    super(options);

    const add = (name, type, mutable) => {
      return this.addCollection(name, type, mutable, INDEXES[name].indexes);
    };

    this.accounts = add('accounts', _resolversGenerated.Account, _collection.QDataScope.mutable);
    this.transactions = add('transactions', _resolversGenerated.Transaction, _collection.QDataScope.immutable);
    this.messages = add('messages', _resolversGenerated.Message, _collection.QDataScope.immutable);
    this.blocks = add('blocks', _resolversGenerated.Block, _collection.QDataScope.immutable);
    this.blocks_signatures = add('blocks_signatures', _resolversGenerated.BlockSignatures, _collection.QDataScope.immutable);
    this.zerostates = add('zerostates', _resolversGenerated.Zerostate, _collection.QDataScope.mutable);
    this.counterparties = add('counterparties', _counterparties.Counterparty, _collection.QDataScope.counterparties);
    this.latency = {
      blocks: {
        maxTime: 0,
        nextUpdateTime: 0,
        latency: 0
      },
      messages: {
        maxTime: 0,
        nextUpdateTime: 0,
        latency: 0
      },
      transactions: {
        maxTime: 0,
        nextUpdateTime: 0,
        latency: 0
      },
      nextUpdateTime: 0,
      latency: 0,
      lastBlockTime: 0
    };
    this.blocks.docInsertOrUpdate.on("doc", async block => {
      this.updateLatency(this.latency.blocks, block.gen_utime);
    });
    this.transactions.docInsertOrUpdate.on("doc", async tr => {
      this.updateLatency(this.latency.transactions, tr.now);
    });
    this.messages.docInsertOrUpdate.on("doc", async msg => {
      this.updateLatency(this.latency.messages, msg.created_at);
    });
  }

  updateLatency(latency, timeInSeconds) {
    if (this.updateCollectionLatency(latency, timeInSeconds)) {
      this.updateLatencySummary();
    }
  }

  updateCollectionLatency(latency, timeInSeconds) {
    if (timeInSeconds === undefined || timeInSeconds === null || timeInSeconds === 0) {
      return false;
    }

    const time = timeInSeconds * 1000;
    const now = Date.now();

    if (time > latency.maxTime) {
      latency.maxTime = time;
    }

    latency.nextUpdateTime = now + 30000; // LATENCY_UPDATE_FREQUENCY

    latency.latency = Math.max(0, now - latency.maxTime);
    return true;
  }

  updateLatencySummary() {
    const {
      blocks,
      messages,
      transactions
    } = this.latency;
    this.latency.nextUpdateTime = Math.min(blocks.nextUpdateTime, messages.nextUpdateTime, transactions.nextUpdateTime);
    this.latency.latency = Math.max(blocks.latency, messages.latency, transactions.latency);
    this.latency.lastBlockTime = blocks.maxTime;
  }

  async updateMaxTime(latency, collection, field) {
    if (Date.now() <= latency.nextUpdateTime) {
      return false;
    }

    const result = await collection.provider.query(`FOR d IN ${collection.name} SORT d.${field} DESC LIMIT 1 RETURN { maxTime: d.${field} }`, {}, [{
      path: field,
      direction: "DESC"
    }]);
    const maxTime = result && result.length > 0 && result[0] ? result[0].maxTime || 0 : 0;
    return this.updateCollectionLatency(latency, maxTime);
  }

  async getLatency() {
    const latency = this.latency;

    if (Date.now() > latency.nextUpdateTime) {
      let hasUpdates = await this.updateMaxTime(latency.blocks, this.blocks, "gen_utime");

      if (await this.updateMaxTime(latency.messages, this.messages, "created_at")) {
        hasUpdates = true;
      }

      if (await this.updateMaxTime(latency.transactions, this.transactions, "now")) {
        hasUpdates = true;
      }

      if (hasUpdates) {
        this.updateLatencySummary();
      }
    }

    return latency;
  }

}

exports.default = QBlockchainData;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9ibG9ja2NoYWluLmpzIl0sIm5hbWVzIjpbIklOREVYRVMiLCJibG9ja3MiLCJpbmRleGVzIiwiYWNjb3VudHMiLCJtZXNzYWdlcyIsInRyYW5zYWN0aW9ucyIsImJsb2Nrc19zaWduYXR1cmVzIiwiemVyb3N0YXRlcyIsImNvdW50ZXJwYXJ0aWVzIiwiT2JqZWN0IiwidmFsdWVzIiwiZm9yRWFjaCIsImNvbGxlY3Rpb24iLCJjb25jYXQiLCJmaWVsZHMiLCJRQmxvY2tjaGFpbkRhdGEiLCJRRGF0YSIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImFkZCIsIm5hbWUiLCJ0eXBlIiwibXV0YWJsZSIsImFkZENvbGxlY3Rpb24iLCJBY2NvdW50IiwiUURhdGFTY29wZSIsIlRyYW5zYWN0aW9uIiwiaW1tdXRhYmxlIiwiTWVzc2FnZSIsIkJsb2NrIiwiQmxvY2tTaWduYXR1cmVzIiwiWmVyb3N0YXRlIiwiQ291bnRlcnBhcnR5IiwibGF0ZW5jeSIsIm1heFRpbWUiLCJuZXh0VXBkYXRlVGltZSIsImxhc3RCbG9ja1RpbWUiLCJkb2NJbnNlcnRPclVwZGF0ZSIsIm9uIiwiYmxvY2siLCJ1cGRhdGVMYXRlbmN5IiwiZ2VuX3V0aW1lIiwidHIiLCJub3ciLCJtc2ciLCJjcmVhdGVkX2F0IiwidGltZUluU2Vjb25kcyIsInVwZGF0ZUNvbGxlY3Rpb25MYXRlbmN5IiwidXBkYXRlTGF0ZW5jeVN1bW1hcnkiLCJ1bmRlZmluZWQiLCJ0aW1lIiwiRGF0ZSIsIk1hdGgiLCJtYXgiLCJtaW4iLCJ1cGRhdGVNYXhUaW1lIiwiZmllbGQiLCJyZXN1bHQiLCJwcm92aWRlciIsInF1ZXJ5IiwicGF0aCIsImRpcmVjdGlvbiIsImxlbmd0aCIsImdldExhdGVuY3kiLCJoYXNVcGRhdGVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBa0JBOztBQUVBOztBQUNBOztBQUNBOztBQVFBOzs7O0FBOUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFD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V0FBaEQsQ0FBdkI7O0FBQ0EsVUFBSSxNQUFNLEtBQUtzRCxhQUFMLENBQW1CdEIsT0FBTyxDQUFDN0IsUUFBM0IsRUFBcUMsS0FBS0EsUUFBMUMsRUFBb0QsWUFBcEQsQ0FBVixFQUE2RTtBQUN6RTRELFFBQUFBLFVBQVUsR0FBRyxJQUFiO0FBQ0g7O0FBQ0QsVUFBSSxNQUFNLEtBQUtULGFBQUwsQ0FBbUJ0QixPQUFPLENBQUM1QixZQUEzQixFQUF5QyxLQUFLQSxZQUE5QyxFQUE0RCxLQUE1RCxDQUFWLEVBQThFO0FBQzFFMkQsUUFBQUEsVUFBVSxHQUFHLElBQWI7QUFDSDs7QUFDRCxVQUFJQSxVQUFKLEVBQWdCO0FBQ1osYUFBS2hCLG9CQUFMO0FBQ0g7QUFDSjs7QUFDRCxXQUFPZixPQUFQO0FBQ0g7O0FBdkg4QyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAxOC0yMDIwIFRPTiBERVYgU09MVVRJT05TIExURC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgU09GVFdBUkUgRVZBTFVBVElPTiBMaWNlbnNlICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2VcbiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZVxuICogTGljZW5zZSBhdDpcbiAqXG4gKiBodHRwOi8vd3d3LnRvbi5kZXYvbGljZW5zZXNcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIFRPTiBERVYgc29mdHdhcmUgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuLy8gQGZsb3dcblxuaW1wb3J0IHsgQ291bnRlcnBhcnR5IH0gZnJvbSBcIi4uL2dyYXBocWwvY291bnRlcnBhcnRpZXNcIjtcbmltcG9ydCB0eXBlIHsgUURhdGFPcHRpb25zIH0gZnJvbSAnLi9kYXRhJztcbmltcG9ydCBRRGF0YSBmcm9tICcuL2RhdGEnO1xuaW1wb3J0IHsgUURhdGFDb2xsZWN0aW9uLCBRRGF0YVNjb3BlIH0gZnJvbSAnLi9jb2xsZWN0aW9uJztcbmltcG9ydCB7XG4gICAgQWNjb3VudCxcbiAgICBCbG9jayxcbiAgICBCbG9ja1NpZ25hdHVyZXMsXG4gICAgTWVzc2FnZSxcbiAgICBUcmFuc2FjdGlvbixcbiAgICBaZXJvc3RhdGUsXG59IGZyb20gJy4uL2dyYXBocWwvcmVzb2x2ZXJzLWdlbmVyYXRlZCc7XG5pbXBvcnQgeyBzb3J0ZWRJbmRleCB9IGZyb20gJy4vZGF0YS1wcm92aWRlcic7XG5cbmV4cG9ydCBjb25zdCBJTkRFWEVTID0ge1xuICAgIGJsb2Nrczoge1xuICAgICAgICBpbmRleGVzOiBbXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3NlcV9ubycsICdnZW5fdXRpbWUnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2dlbl91dGltZSddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnd29ya2NoYWluX2lkJywgJ3NoYXJkJywgJ3NlcV9ubyddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnd29ya2NoYWluX2lkJywgJ3NoYXJkJywgJ2dlbl91dGltZSddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnd29ya2NoYWluX2lkJywgJ3NlcV9ubyddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnd29ya2NoYWluX2lkJywgJ2dlbl91dGltZSddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnbWFzdGVyLm1pbl9zaGFyZF9nZW5fdXRpbWUnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3ByZXZfcmVmLnJvb3RfaGFzaCcsICdfa2V5J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydwcmV2X2FsdF9yZWYucm9vdF9oYXNoJywgJ19rZXknXSksXG4gICAgICAgIF0sXG4gICAgfSxcbiAgICBhY2NvdW50czoge1xuICAgICAgICBpbmRleGVzOiBbXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2xhc3RfdHJhbnNfbHQnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2JhbGFuY2UnXSksXG4gICAgICAgIF0sXG4gICAgfSxcbiAgICBtZXNzYWdlczoge1xuICAgICAgICBpbmRleGVzOiBbXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2Jsb2NrX2lkJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWyd2YWx1ZScsICdjcmVhdGVkX2F0J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydzcmMnLCAndmFsdWUnLCAnY3JlYXRlZF9hdCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnZHN0JywgJ3ZhbHVlJywgJ2NyZWF0ZWRfYXQnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3NyYycsICdjcmVhdGVkX2F0J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydkc3QnLCAnY3JlYXRlZF9hdCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnY3JlYXRlZF9sdCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnY3JlYXRlZF9hdCddKSxcbiAgICAgICAgXSxcbiAgICB9LFxuICAgIHRyYW5zYWN0aW9uczoge1xuICAgICAgICBpbmRleGVzOiBbXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2Jsb2NrX2lkJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydpbl9tc2cnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ291dF9tc2dzWypdJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydhY2NvdW50X2FkZHInLCAnbm93J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydub3cnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2x0J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydhY2NvdW50X2FkZHInLCAnb3JpZ19zdGF0dXMnLCAnZW5kX3N0YXR1cyddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnbm93JywgJ2FjY291bnRfYWRkcicsICdsdCddKSxcbiAgICAgICAgXSxcbiAgICB9LFxuICAgIGJsb2Nrc19zaWduYXR1cmVzOiB7XG4gICAgICAgIGluZGV4ZXM6IFtcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnc2lnbmF0dXJlc1sqXS5ub2RlX2lkJywgJ2dlbl91dGltZSddKSxcbiAgICAgICAgXSxcbiAgICB9LFxuICAgIHplcm9zdGF0ZXM6IHtcbiAgICAgICAgaW5kZXhlczogW10sXG4gICAgfSxcbiAgICBjb3VudGVycGFydGllczoge1xuICAgICAgICBpbmRleGVzOiBbXSxcbiAgICB9LFxufTtcblxuXG5PYmplY3QudmFsdWVzKElOREVYRVMpLmZvckVhY2goKGNvbGxlY3Rpb246IGFueSkgPT4ge1xuICAgIGNvbGxlY3Rpb24uaW5kZXhlcyA9IGNvbGxlY3Rpb24uaW5kZXhlcy5jb25jYXQoeyBmaWVsZHM6IFsnX2tleSddIH0pO1xufSk7XG5cbmV4cG9ydCB0eXBlIENvbGxlY3Rpb25MYXRlbmN5ID0ge1xuICAgIG1heFRpbWU6IG51bWJlcixcbiAgICBuZXh0VXBkYXRlVGltZTogbnVtYmVyLFxuICAgIGxhdGVuY3k6IG51bWJlcixcbn07XG5cbmV4cG9ydCB0eXBlIExhdGVuY3kgPSB7XG4gICAgYmxvY2tzOiBDb2xsZWN0aW9uTGF0ZW5jeSxcbiAgICBtZXNzYWdlczogQ29sbGVjdGlvbkxhdGVuY3ksXG4gICAgdHJhbnNhY3Rpb25zOiBDb2xsZWN0aW9uTGF0ZW5jeSxcbiAgICBuZXh0VXBkYXRlVGltZTogbnVtYmVyLFxuICAgIGxhdGVuY3k6IG51bWJlcixcbiAgICBsYXN0QmxvY2tUaW1lOiBudW1iZXIsXG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBRQmxvY2tjaGFpbkRhdGEgZXh0ZW5kcyBRRGF0YSB7XG4gICAgdHJhbnNhY3Rpb25zOiBRRGF0YUNvbGxlY3Rpb247XG4gICAgbWVzc2FnZXM6IFFEYXRhQ29sbGVjdGlvbjtcbiAgICBhY2NvdW50czogUURhdGFDb2xsZWN0aW9uO1xuICAgIGJsb2NrczogUURhdGFDb2xsZWN0aW9uO1xuICAgIGJsb2Nrc19zaWduYXR1cmVzOiBRRGF0YUNvbGxlY3Rpb247XG4gICAgemVyb3N0YXRlczogUURhdGFDb2xsZWN0aW9uO1xuICAgIGNvdW50ZXJwYXJ0aWVzOiBRRGF0YUNvbGxlY3Rpb247XG5cbiAgICBsYXRlbmN5OiBMYXRlbmN5O1xuXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczogUURhdGFPcHRpb25zKSB7XG4gICAgICAgIHN1cGVyKG9wdGlvbnMpO1xuICAgICAgICBjb25zdCBhZGQgPSAobmFtZSwgdHlwZSwgbXV0YWJsZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkQ29sbGVjdGlvbihuYW1lLCB0eXBlLCBtdXRhYmxlLCBJTkRFWEVTW25hbWVdLmluZGV4ZXMpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmFjY291bnRzID0gYWRkKCdhY2NvdW50cycsIEFjY291bnQsIFFEYXRhU2NvcGUubXV0YWJsZSk7XG4gICAgICAgIHRoaXMudHJhbnNhY3Rpb25zID0gYWRkKCd0cmFuc2FjdGlvbnMnLCBUcmFuc2FjdGlvbiwgUURhdGFTY29wZS5pbW11dGFibGUpO1xuICAgICAgICB0aGlzLm1lc3NhZ2VzID0gYWRkKCdtZXNzYWdlcycsIE1lc3NhZ2UsIFFEYXRhU2NvcGUuaW1tdXRhYmxlKTtcbiAgICAgICAgdGhpcy5ibG9ja3MgPSBhZGQoJ2Jsb2NrcycsIEJsb2NrLCBRRGF0YVNjb3BlLmltbXV0YWJsZSk7XG4gICAgICAgIHRoaXMuYmxvY2tzX3NpZ25hdHVyZXMgPSBhZGQoJ2Jsb2Nrc19zaWduYXR1cmVzJywgQmxvY2tTaWduYXR1cmVzLCBRRGF0YVNjb3BlLmltbXV0YWJsZSk7XG4gICAgICAgIHRoaXMuemVyb3N0YXRlcyA9IGFkZCgnemVyb3N0YXRlcycsIFplcm9zdGF0ZSwgUURhdGFTY29wZS5tdXRhYmxlKTtcbiAgICAgICAgdGhpcy5jb3VudGVycGFydGllcyA9IGFkZCgnY291bnRlcnBhcnRpZXMnLCBDb3VudGVycGFydHksIFFEYXRhU2NvcGUuY291bnRlcnBhcnRpZXMpO1xuXG4gICAgICAgIHRoaXMubGF0ZW5jeSA9IHtcbiAgICAgICAgICAgIGJsb2Nrczoge1xuICAgICAgICAgICAgICAgIG1heFRpbWU6IDAsXG4gICAgICAgICAgICAgICAgbmV4dFVwZGF0ZVRpbWU6IDAsXG4gICAgICAgICAgICAgICAgbGF0ZW5jeTogMCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBtZXNzYWdlczoge1xuICAgICAgICAgICAgICAgIG1heFRpbWU6IDAsXG4gICAgICAgICAgICAgICAgbmV4dFVwZGF0ZVRpbWU6IDAsXG4gICAgICAgICAgICAgICAgbGF0ZW5jeTogMCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0cmFuc2FjdGlvbnM6IHtcbiAgICAgICAgICAgICAgICBtYXhUaW1lOiAwLFxuICAgICAgICAgICAgICAgIG5leHRVcGRhdGVUaW1lOiAwLFxuICAgICAgICAgICAgICAgIGxhdGVuY3k6IDAsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbmV4dFVwZGF0ZVRpbWU6IDAsXG4gICAgICAgICAgICBsYXRlbmN5OiAwLFxuICAgICAgICAgICAgbGFzdEJsb2NrVGltZTogMCxcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuYmxvY2tzLmRvY0luc2VydE9yVXBkYXRlLm9uKFwiZG9jXCIsIGFzeW5jIChibG9jaykgPT4ge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVMYXRlbmN5KHRoaXMubGF0ZW5jeS5ibG9ja3MsIGJsb2NrLmdlbl91dGltZSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnRyYW5zYWN0aW9ucy5kb2NJbnNlcnRPclVwZGF0ZS5vbihcImRvY1wiLCBhc3luYyAodHIpID0+IHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlTGF0ZW5jeSh0aGlzLmxhdGVuY3kudHJhbnNhY3Rpb25zLCB0ci5ub3cpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5tZXNzYWdlcy5kb2NJbnNlcnRPclVwZGF0ZS5vbihcImRvY1wiLCBhc3luYyAobXNnKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUxhdGVuY3kodGhpcy5sYXRlbmN5Lm1lc3NhZ2VzLCBtc2cuY3JlYXRlZF9hdCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHVwZGF0ZUxhdGVuY3kobGF0ZW5jeTogQ29sbGVjdGlvbkxhdGVuY3ksIHRpbWVJblNlY29uZHM/OiA/bnVtYmVyKSB7XG4gICAgICAgIGlmICh0aGlzLnVwZGF0ZUNvbGxlY3Rpb25MYXRlbmN5KGxhdGVuY3ksIHRpbWVJblNlY29uZHMpKSB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUxhdGVuY3lTdW1tYXJ5KCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB1cGRhdGVDb2xsZWN0aW9uTGF0ZW5jeShsYXRlbmN5OiBDb2xsZWN0aW9uTGF0ZW5jeSwgdGltZUluU2Vjb25kcz86ID9udW1iZXIpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHRpbWVJblNlY29uZHMgPT09IHVuZGVmaW5lZCB8fCB0aW1lSW5TZWNvbmRzID09PSBudWxsIHx8IHRpbWVJblNlY29uZHMgPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB0aW1lID0gdGltZUluU2Vjb25kcyAqIDEwMDA7XG4gICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgICAgIGlmICh0aW1lID4gbGF0ZW5jeS5tYXhUaW1lKSB7XG4gICAgICAgICAgICBsYXRlbmN5Lm1heFRpbWUgPSB0aW1lO1xuICAgICAgICB9XG4gICAgICAgIGxhdGVuY3kubmV4dFVwZGF0ZVRpbWUgPSBub3cgKyAzMDAwMDsgLy8gTEFURU5DWV9VUERBVEVfRlJFUVVFTkNZXG4gICAgICAgIGxhdGVuY3kubGF0ZW5jeSA9IE1hdGgubWF4KDAsIG5vdyAtIGxhdGVuY3kubWF4VGltZSk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHVwZGF0ZUxhdGVuY3lTdW1tYXJ5KCkge1xuICAgICAgICBjb25zdCB7IGJsb2NrcywgbWVzc2FnZXMsIHRyYW5zYWN0aW9ucyB9ID0gdGhpcy5sYXRlbmN5O1xuICAgICAgICB0aGlzLmxhdGVuY3kubmV4dFVwZGF0ZVRpbWUgPSBNYXRoLm1pbihcbiAgICAgICAgICAgIGJsb2Nrcy5uZXh0VXBkYXRlVGltZSxcbiAgICAgICAgICAgIG1lc3NhZ2VzLm5leHRVcGRhdGVUaW1lLFxuICAgICAgICAgICAgdHJhbnNhY3Rpb25zLm5leHRVcGRhdGVUaW1lLFxuICAgICAgICApO1xuICAgICAgICB0aGlzLmxhdGVuY3kubGF0ZW5jeSA9IE1hdGgubWF4KFxuICAgICAgICAgICAgYmxvY2tzLmxhdGVuY3ksXG4gICAgICAgICAgICBtZXNzYWdlcy5sYXRlbmN5LFxuICAgICAgICAgICAgdHJhbnNhY3Rpb25zLmxhdGVuY3ksXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMubGF0ZW5jeS5sYXN0QmxvY2tUaW1lID0gYmxvY2tzLm1heFRpbWU7XG4gICAgfVxuXG4gICAgYXN5bmMgdXBkYXRlTWF4VGltZShsYXRlbmN5OiBDb2xsZWN0aW9uTGF0ZW5jeSwgY29sbGVjdGlvbjogUURhdGFDb2xsZWN0aW9uLCBmaWVsZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGlmIChEYXRlLm5vdygpIDw9IGxhdGVuY3kubmV4dFVwZGF0ZVRpbWUpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCByZXN1bHQgPSAoYXdhaXQgY29sbGVjdGlvbi5wcm92aWRlci5xdWVyeShcbiAgICAgICAgICAgIGBGT1IgZCBJTiAke2NvbGxlY3Rpb24ubmFtZX0gU09SVCBkLiR7ZmllbGR9IERFU0MgTElNSVQgMSBSRVRVUk4geyBtYXhUaW1lOiBkLiR7ZmllbGR9IH1gLFxuICAgICAgICAgICAge30sIFt7IHBhdGg6IGZpZWxkLCBkaXJlY3Rpb246IFwiREVTQ1wiIH1dXG4gICAgICAgICkpO1xuICAgICAgICBjb25zdCBtYXhUaW1lID0gKHJlc3VsdCAmJiByZXN1bHQubGVuZ3RoID4gMCAmJiByZXN1bHRbMF0pID8gKHJlc3VsdFswXS5tYXhUaW1lIHx8IDApIDogMDtcbiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlQ29sbGVjdGlvbkxhdGVuY3kobGF0ZW5jeSwgbWF4VGltZSk7XG5cbiAgICB9XG5cbiAgICBhc3luYyBnZXRMYXRlbmN5KCk6IFByb21pc2U8TGF0ZW5jeT4ge1xuICAgICAgICBjb25zdCBsYXRlbmN5ID0gdGhpcy5sYXRlbmN5O1xuICAgICAgICBpZiAoRGF0ZS5ub3coKSA+IGxhdGVuY3kubmV4dFVwZGF0ZVRpbWUpIHtcbiAgICAgICAgICAgIGxldCBoYXNVcGRhdGVzID0gYXdhaXQgdGhpcy51cGRhdGVNYXhUaW1lKGxhdGVuY3kuYmxvY2tzLCB0aGlzLmJsb2NrcywgXCJnZW5fdXRpbWVcIik7XG4gICAgICAgICAgICBpZiAoYXdhaXQgdGhpcy51cGRhdGVNYXhUaW1lKGxhdGVuY3kubWVzc2FnZXMsIHRoaXMubWVzc2FnZXMsIFwiY3JlYXRlZF9hdFwiKSkge1xuICAgICAgICAgICAgICAgIGhhc1VwZGF0ZXMgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGF3YWl0IHRoaXMudXBkYXRlTWF4VGltZShsYXRlbmN5LnRyYW5zYWN0aW9ucywgdGhpcy50cmFuc2FjdGlvbnMsIFwibm93XCIpKSB7XG4gICAgICAgICAgICAgICAgaGFzVXBkYXRlcyA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaGFzVXBkYXRlcykge1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTGF0ZW5jeVN1bW1hcnkoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbGF0ZW5jeTtcbiAgICB9XG59XG4iXX0=