"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.INDEXES = void 0;

var _counterparties = require("../graphql/counterparties");

var _data = _interopRequireDefault(require("./data"));

var _collection = require("./collection");

var _resolversGenerated = require("../graphql/resolvers-generated");

var _dataProvider = require("./data-provider");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const INDEXES = {
  blocks: {
    indexes: [(0, _dataProvider.sortedIndex)(['seq_no', 'gen_utime']), (0, _dataProvider.sortedIndex)(['gen_utime']), (0, _dataProvider.sortedIndex)(['workchain_id', 'shard', 'seq_no']), (0, _dataProvider.sortedIndex)(['workchain_id', 'shard', 'gen_utime']), (0, _dataProvider.sortedIndex)(['workchain_id', 'seq_no']), (0, _dataProvider.sortedIndex)(['workchain_id', 'gen_utime']), (0, _dataProvider.sortedIndex)(['master.min_shard_gen_utime']), (0, _dataProvider.sortedIndex)(['prev_ref.root_hash', '_key']), (0, _dataProvider.sortedIndex)(['prev_alt_ref.root_hash', '_key'])]
  },
  accounts: {
    indexes: [(0, _dataProvider.sortedIndex)(['last_trans_lt']), (0, _dataProvider.sortedIndex)(['balance'])]
  },
  messages: {
    indexes: [(0, _dataProvider.sortedIndex)(['block_id']), (0, _dataProvider.sortedIndex)(['value', 'created_at']), (0, _dataProvider.sortedIndex)(['src', 'value', 'created_at']), (0, _dataProvider.sortedIndex)(['dst', 'value', 'created_at']), (0, _dataProvider.sortedIndex)(['src', 'created_at']), (0, _dataProvider.sortedIndex)(['dst', 'created_at']), (0, _dataProvider.sortedIndex)(['created_lt']), (0, _dataProvider.sortedIndex)(['created_at'])]
  },
  transactions: {
    indexes: [(0, _dataProvider.sortedIndex)(['block_id']), (0, _dataProvider.sortedIndex)(['in_msg']), (0, _dataProvider.sortedIndex)(['out_msgs[*]']), (0, _dataProvider.sortedIndex)(['account_addr', 'now']), (0, _dataProvider.sortedIndex)(['now']), (0, _dataProvider.sortedIndex)(['lt']), (0, _dataProvider.sortedIndex)(['account_addr', 'orig_status', 'end_status']), (0, _dataProvider.sortedIndex)(['now', 'account_addr', 'lt'])]
  },
  blocks_signatures: {
    indexes: [(0, _dataProvider.sortedIndex)(['signatures[*].node_id', 'gen_utime'])]
  },
  zerostates: {
    indexes: []
  },
  counterparties: {
    indexes: []
  }
};
exports.INDEXES = INDEXES;
Object.values(INDEXES).forEach(collection => {
  collection.indexes = collection.indexes.concat({
    fields: ['_key']
  });
});

class QBlockchainData extends _data.default {
  constructor(options) {
    super(options);

    const add = (name, type, mutable) => {
      return this.addCollection(name, type, mutable, INDEXES[name].indexes);
    };

    this.accounts = add('accounts', _resolversGenerated.Account, _collection.QDataScope.mutable);
    this.transactions = add('transactions', _resolversGenerated.Transaction, _collection.QDataScope.immutable);
    this.messages = add('messages', _resolversGenerated.Message, _collection.QDataScope.immutable);
    this.blocks = add('blocks', _resolversGenerated.Block, _collection.QDataScope.immutable);
    this.blocks_signatures = add('blocks_signatures', _resolversGenerated.BlockSignatures, _collection.QDataScope.immutable);
    this.zerostates = add('zerostates', _resolversGenerated.Zerostate, _collection.QDataScope.immutable);
    this.counterparties = add('counterparties', _counterparties.Counterparty, _collection.QDataScope.counterparties);
    this.latency = {
      blocks: {
        maxTime: 0,
        nextUpdateTime: 0,
        latency: 0
      },
      messages: {
        maxTime: 0,
        nextUpdateTime: 0,
        latency: 0
      },
      transactions: {
        maxTime: 0,
        nextUpdateTime: 0,
        latency: 0
      },
      nextUpdateTime: 0,
      latency: 0,
      lastBlockTime: 0
    };
    this.blocks.docInsertOrUpdate.on("doc", async block => {
      this.updateLatency(this.latency.blocks, block.gen_utime);
    });
    this.transactions.docInsertOrUpdate.on("doc", async tr => {
      this.updateLatency(this.latency.transactions, tr.now);
    });
    this.messages.docInsertOrUpdate.on("doc", async msg => {
      this.updateLatency(this.latency.messages, msg.created_at);
    });
  }

  updateLatency(latency, timeInSeconds) {
    if (this.updateCollectionLatency(latency, timeInSeconds)) {
      this.updateLatencySummary();
    }
  }

  updateCollectionLatency(latency, timeInSeconds) {
    if (timeInSeconds === undefined || timeInSeconds === null || timeInSeconds === 0) {
      return false;
    }

    const time = timeInSeconds * 1000;
    const now = Date.now();

    if (time > latency.maxTime) {
      latency.maxTime = time;
    }

    latency.nextUpdateTime = now + 30000; // LATENCY_UPDATE_FREQUENCY

    latency.latency = Math.max(0, now - latency.maxTime);
    return true;
  }

  updateLatencySummary() {
    const {
      blocks,
      messages,
      transactions
    } = this.latency;
    this.latency.nextUpdateTime = Math.min(blocks.nextUpdateTime, messages.nextUpdateTime, transactions.nextUpdateTime);
    this.latency.latency = Math.max(blocks.latency, messages.latency, transactions.latency);
    this.latency.lastBlockTime = blocks.maxTime;
  }

  async updateMaxTime(latency, collection, field) {
    if (Date.now() <= latency.nextUpdateTime) {
      return false;
    }

    const result = await collection.provider.query(`FOR d IN ${collection.name} SORT d.${field} DESC LIMIT 1 RETURN { maxTime: d.${field} }`, {}, [{
      path: field,
      direction: "DESC"
    }]);
    const maxTime = result && result.length > 0 && result[0] ? result[0].maxTime || 0 : 0;
    return this.updateCollectionLatency(latency, maxTime);
  }

  async getLatency() {
    const latency = this.latency;

    if (Date.now() > latency.nextUpdateTime) {
      let hasUpdates = await this.updateMaxTime(latency.blocks, this.blocks, "gen_utime");

      if (await this.updateMaxTime(latency.messages, this.messages, "created_at")) {
        hasUpdates = true;
      }

      if (await this.updateMaxTime(latency.transactions, this.transactions, "now")) {
        hasUpdates = true;
      }

      if (hasUpdates) {
        this.updateLatencySummary();
      }
    }

    return latency;
  }

}

exports.default = QBlockchainData;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9ibG9ja2NoYWluLmpzIl0sIm5hbWVzIjpbIklOREVYRVMiLCJibG9ja3MiLCJpbmRleGVzIiwiYWNjb3VudHMiLCJtZXNzYWdlcyIsInRyYW5zYWN0aW9ucyIsImJsb2Nrc19zaWduYXR1cmVzIiwiemVyb3N0YXRlcyIsImNvdW50ZXJwYXJ0aWVzIiwiT2JqZWN0IiwidmFsdWVzIiwiZm9yRWFjaCIsImNvbGxlY3Rpb24iLCJjb25jYXQiLCJmaWVsZHMiLCJRQmxvY2tjaGFpbkRhdGEiLCJRRGF0YSIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImFkZCIsIm5hbWUiLCJ0eXBlIiwibXV0YWJsZSIsImFkZENvbGxlY3Rpb24iLCJBY2NvdW50IiwiUURhdGFTY29wZSIsIlRyYW5zYWN0aW9uIiwiaW1tdXRhYmxlIiwiTWVzc2FnZSIsIkJsb2NrIiwiQmxvY2tTaWduYXR1cmVzIiwiWmVyb3N0YXRlIiwiQ291bnRlcnBhcnR5IiwibGF0ZW5jeSIsIm1heFRpbWUiLCJuZXh0VXBkYXRlVGltZSIsImxhc3RCbG9ja1RpbWUiLCJkb2NJbnNlcnRPclVwZGF0ZSIsIm9uIiwiYmxvY2siLCJ1cGRhdGVMYXRlbmN5IiwiZ2VuX3V0aW1lIiwidHIiLCJub3ciLCJtc2ciLCJjcmVhdGVkX2F0IiwidGltZUluU2Vjb25kcyIsInVwZGF0ZUNvbGxlY3Rpb25MYXRlbmN5IiwidXBkYXRlTGF0ZW5jeVN1bW1hcnkiLCJ1bmRlZmluZWQiLCJ0aW1lIiwiRGF0ZSIsIk1hdGgiLCJtYXgiLCJtaW4iLCJ1cGRhdGVNYXhUaW1lIiwiZmllbGQiLCJyZXN1bHQiLCJwcm92aWRlciIsInF1ZXJ5IiwicGF0aCIsImRpcmVjdGlvbiIsImxlbmd0aCIsImdldExhdGVuY3kiLCJoYXNVcGRhdGVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBa0JBOztBQUVBOztBQUNBOztBQUNBOztBQVFBOzs7O0FBOUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFD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RCxXQUFoRCxDQUF2Qjs7QUFDQSxVQUFJLE1BQU0sS0FBS3NELGFBQUwsQ0FBbUJ0QixPQUFPLENBQUM3QixRQUEzQixFQUFxQyxLQUFLQSxRQUExQyxFQUFvRCxZQUFwRCxDQUFWLEVBQTZFO0FBQ3pFNEQsUUFBQUEsVUFBVSxHQUFHLElBQWI7QUFDSDs7QUFDRCxVQUFJLE1BQU0sS0FBS1QsYUFBTCxDQUFtQnRCLE9BQU8sQ0FBQzVCLFlBQTNCLEVBQXlDLEtBQUtBLFlBQTlDLEVBQTRELEtBQTVELENBQVYsRUFBOEU7QUFDMUUyRCxRQUFBQSxVQUFVLEdBQUcsSUFBYjtBQUNIOztBQUNELFVBQUlBLFVBQUosRUFBZ0I7QUFDWixhQUFLaEIsb0JBQUw7QUFDSDtBQUNKOztBQUNELFdBQU9mLE9BQVA7QUFDSDs7QUF2SDhDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE4LTIwMjAgVE9OIERFViBTT0xVVElPTlMgTFRELlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBTT0ZUV0FSRSBFVkFMVUFUSU9OIExpY2Vuc2UgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZVxuICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlXG4gKiBMaWNlbnNlIGF0OlxuICpcbiAqIGh0dHA6Ly93d3cudG9uLmRldi9saWNlbnNlc1xuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgVE9OIERFViBzb2Z0d2FyZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vLyBAZmxvd1xuXG5pbXBvcnQgeyBDb3VudGVycGFydHkgfSBmcm9tIFwiLi4vZ3JhcGhxbC9jb3VudGVycGFydGllc1wiO1xuaW1wb3J0IHR5cGUgeyBRRGF0YU9wdGlvbnMgfSBmcm9tICcuL2RhdGEnO1xuaW1wb3J0IFFEYXRhIGZyb20gJy4vZGF0YSc7XG5pbXBvcnQgeyBRRGF0YUNvbGxlY3Rpb24sIFFEYXRhU2NvcGUgfSBmcm9tICcuL2NvbGxlY3Rpb24nO1xuaW1wb3J0IHtcbiAgICBBY2NvdW50LFxuICAgIEJsb2NrLFxuICAgIEJsb2NrU2lnbmF0dXJlcyxcbiAgICBNZXNzYWdlLFxuICAgIFRyYW5zYWN0aW9uLFxuICAgIFplcm9zdGF0ZSxcbn0gZnJvbSAnLi4vZ3JhcGhxbC9yZXNvbHZlcnMtZ2VuZXJhdGVkJztcbmltcG9ydCB7IHNvcnRlZEluZGV4IH0gZnJvbSAnLi9kYXRhLXByb3ZpZGVyJztcblxuZXhwb3J0IGNvbnN0IElOREVYRVMgPSB7XG4gICAgYmxvY2tzOiB7XG4gICAgICAgIGluZGV4ZXM6IFtcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnc2VxX25vJywgJ2dlbl91dGltZSddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnZ2VuX3V0aW1lJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWyd3b3JrY2hhaW5faWQnLCAnc2hhcmQnLCAnc2VxX25vJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWyd3b3JrY2hhaW5faWQnLCAnc2hhcmQnLCAnZ2VuX3V0aW1lJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWyd3b3JrY2hhaW5faWQnLCAnc2VxX25vJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWyd3b3JrY2hhaW5faWQnLCAnZ2VuX3V0aW1lJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydtYXN0ZXIubWluX3NoYXJkX2dlbl91dGltZSddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsncHJldl9yZWYucm9vdF9oYXNoJywgJ19rZXknXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3ByZXZfYWx0X3JlZi5yb290X2hhc2gnLCAnX2tleSddKSxcbiAgICAgICAgXSxcbiAgICB9LFxuICAgIGFjY291bnRzOiB7XG4gICAgICAgIGluZGV4ZXM6IFtcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnbGFzdF90cmFuc19sdCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnYmFsYW5jZSddKSxcbiAgICAgICAgXSxcbiAgICB9LFxuICAgIG1lc3NhZ2VzOiB7XG4gICAgICAgIGluZGV4ZXM6IFtcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnYmxvY2tfaWQnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3ZhbHVlJywgJ2NyZWF0ZWRfYXQnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3NyYycsICd2YWx1ZScsICdjcmVhdGVkX2F0J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydkc3QnLCAndmFsdWUnLCAnY3JlYXRlZF9hdCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnc3JjJywgJ2NyZWF0ZWRfYXQnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2RzdCcsICdjcmVhdGVkX2F0J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydjcmVhdGVkX2x0J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydjcmVhdGVkX2F0J10pLFxuICAgICAgICBdLFxuICAgIH0sXG4gICAgdHJhbnNhY3Rpb25zOiB7XG4gICAgICAgIGluZGV4ZXM6IFtcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnYmxvY2tfaWQnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2luX21zZyddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnb3V0X21zZ3NbKl0nXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2FjY291bnRfYWRkcicsICdub3cnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ25vdyddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnbHQnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2FjY291bnRfYWRkcicsICdvcmlnX3N0YXR1cycsICdlbmRfc3RhdHVzJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydub3cnLCAnYWNjb3VudF9hZGRyJywgJ2x0J10pLFxuICAgICAgICBdLFxuICAgIH0sXG4gICAgYmxvY2tzX3NpZ25hdHVyZXM6IHtcbiAgICAgICAgaW5kZXhlczogW1xuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydzaWduYXR1cmVzWypdLm5vZGVfaWQnLCAnZ2VuX3V0aW1lJ10pLFxuICAgICAgICBdLFxuICAgIH0sXG4gICAgemVyb3N0YXRlczoge1xuICAgICAgICBpbmRleGVzOiBbXSxcbiAgICB9LFxuICAgIGNvdW50ZXJwYXJ0aWVzOiB7XG4gICAgICAgIGluZGV4ZXM6IFtdLFxuICAgIH0sXG59O1xuXG5cbk9iamVjdC52YWx1ZXMoSU5ERVhFUykuZm9yRWFjaCgoY29sbGVjdGlvbjogYW55KSA9PiB7XG4gICAgY29sbGVjdGlvbi5pbmRleGVzID0gY29sbGVjdGlvbi5pbmRleGVzLmNvbmNhdCh7IGZpZWxkczogWydfa2V5J10gfSk7XG59KTtcblxuZXhwb3J0IHR5cGUgQ29sbGVjdGlvbkxhdGVuY3kgPSB7XG4gICAgbWF4VGltZTogbnVtYmVyLFxuICAgIG5leHRVcGRhdGVUaW1lOiBudW1iZXIsXG4gICAgbGF0ZW5jeTogbnVtYmVyLFxufTtcblxuZXhwb3J0IHR5cGUgTGF0ZW5jeSA9IHtcbiAgICBibG9ja3M6IENvbGxlY3Rpb25MYXRlbmN5LFxuICAgIG1lc3NhZ2VzOiBDb2xsZWN0aW9uTGF0ZW5jeSxcbiAgICB0cmFuc2FjdGlvbnM6IENvbGxlY3Rpb25MYXRlbmN5LFxuICAgIG5leHRVcGRhdGVUaW1lOiBudW1iZXIsXG4gICAgbGF0ZW5jeTogbnVtYmVyLFxuICAgIGxhc3RCbG9ja1RpbWU6IG51bWJlcixcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFFCbG9ja2NoYWluRGF0YSBleHRlbmRzIFFEYXRhIHtcbiAgICB0cmFuc2FjdGlvbnM6IFFEYXRhQ29sbGVjdGlvbjtcbiAgICBtZXNzYWdlczogUURhdGFDb2xsZWN0aW9uO1xuICAgIGFjY291bnRzOiBRRGF0YUNvbGxlY3Rpb247XG4gICAgYmxvY2tzOiBRRGF0YUNvbGxlY3Rpb247XG4gICAgYmxvY2tzX3NpZ25hdHVyZXM6IFFEYXRhQ29sbGVjdGlvbjtcbiAgICB6ZXJvc3RhdGVzOiBRRGF0YUNvbGxlY3Rpb247XG4gICAgY291bnRlcnBhcnRpZXM6IFFEYXRhQ29sbGVjdGlvbjtcblxuICAgIGxhdGVuY3k6IExhdGVuY3k7XG5cbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiBRRGF0YU9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIob3B0aW9ucyk7XG4gICAgICAgIGNvbnN0IGFkZCA9IChuYW1lLCB0eXBlLCBtdXRhYmxlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRDb2xsZWN0aW9uKG5hbWUsIHR5cGUsIG11dGFibGUsIElOREVYRVNbbmFtZV0uaW5kZXhlcyk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuYWNjb3VudHMgPSBhZGQoJ2FjY291bnRzJywgQWNjb3VudCwgUURhdGFTY29wZS5tdXRhYmxlKTtcbiAgICAgICAgdGhpcy50cmFuc2FjdGlvbnMgPSBhZGQoJ3RyYW5zYWN0aW9ucycsIFRyYW5zYWN0aW9uLCBRRGF0YVNjb3BlLmltbXV0YWJsZSk7XG4gICAgICAgIHRoaXMubWVzc2FnZXMgPSBhZGQoJ21lc3NhZ2VzJywgTWVzc2FnZSwgUURhdGFTY29wZS5pbW11dGFibGUpO1xuICAgICAgICB0aGlzLmJsb2NrcyA9IGFkZCgnYmxvY2tzJywgQmxvY2ssIFFEYXRhU2NvcGUuaW1tdXRhYmxlKTtcbiAgICAgICAgdGhpcy5ibG9ja3Nfc2lnbmF0dXJlcyA9IGFkZCgnYmxvY2tzX3NpZ25hdHVyZXMnLCBCbG9ja1NpZ25hdHVyZXMsIFFEYXRhU2NvcGUuaW1tdXRhYmxlKTtcbiAgICAgICAgdGhpcy56ZXJvc3RhdGVzID0gYWRkKCd6ZXJvc3RhdGVzJywgWmVyb3N0YXRlLCBRRGF0YVNjb3BlLmltbXV0YWJsZSk7XG4gICAgICAgIHRoaXMuY291bnRlcnBhcnRpZXMgPSBhZGQoJ2NvdW50ZXJwYXJ0aWVzJywgQ291bnRlcnBhcnR5LCBRRGF0YVNjb3BlLmNvdW50ZXJwYXJ0aWVzKTtcblxuICAgICAgICB0aGlzLmxhdGVuY3kgPSB7XG4gICAgICAgICAgICBibG9ja3M6IHtcbiAgICAgICAgICAgICAgICBtYXhUaW1lOiAwLFxuICAgICAgICAgICAgICAgIG5leHRVcGRhdGVUaW1lOiAwLFxuICAgICAgICAgICAgICAgIGxhdGVuY3k6IDAsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbWVzc2FnZXM6IHtcbiAgICAgICAgICAgICAgICBtYXhUaW1lOiAwLFxuICAgICAgICAgICAgICAgIG5leHRVcGRhdGVUaW1lOiAwLFxuICAgICAgICAgICAgICAgIGxhdGVuY3k6IDAsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdHJhbnNhY3Rpb25zOiB7XG4gICAgICAgICAgICAgICAgbWF4VGltZTogMCxcbiAgICAgICAgICAgICAgICBuZXh0VXBkYXRlVGltZTogMCxcbiAgICAgICAgICAgICAgICBsYXRlbmN5OiAwLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG5leHRVcGRhdGVUaW1lOiAwLFxuICAgICAgICAgICAgbGF0ZW5jeTogMCxcbiAgICAgICAgICAgIGxhc3RCbG9ja1RpbWU6IDAsXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmJsb2Nrcy5kb2NJbnNlcnRPclVwZGF0ZS5vbihcImRvY1wiLCBhc3luYyAoYmxvY2spID0+IHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlTGF0ZW5jeSh0aGlzLmxhdGVuY3kuYmxvY2tzLCBibG9jay5nZW5fdXRpbWUpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy50cmFuc2FjdGlvbnMuZG9jSW5zZXJ0T3JVcGRhdGUub24oXCJkb2NcIiwgYXN5bmMgKHRyKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUxhdGVuY3kodGhpcy5sYXRlbmN5LnRyYW5zYWN0aW9ucywgdHIubm93KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMubWVzc2FnZXMuZG9jSW5zZXJ0T3JVcGRhdGUub24oXCJkb2NcIiwgYXN5bmMgKG1zZykgPT4ge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVMYXRlbmN5KHRoaXMubGF0ZW5jeS5tZXNzYWdlcywgbXNnLmNyZWF0ZWRfYXQpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICB1cGRhdGVMYXRlbmN5KGxhdGVuY3k6IENvbGxlY3Rpb25MYXRlbmN5LCB0aW1lSW5TZWNvbmRzPzogP251bWJlcikge1xuICAgICAgICBpZiAodGhpcy51cGRhdGVDb2xsZWN0aW9uTGF0ZW5jeShsYXRlbmN5LCB0aW1lSW5TZWNvbmRzKSkge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVMYXRlbmN5U3VtbWFyeSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdXBkYXRlQ29sbGVjdGlvbkxhdGVuY3kobGF0ZW5jeTogQ29sbGVjdGlvbkxhdGVuY3ksIHRpbWVJblNlY29uZHM/OiA/bnVtYmVyKTogYm9vbGVhbiB7XG4gICAgICAgIGlmICh0aW1lSW5TZWNvbmRzID09PSB1bmRlZmluZWQgfHwgdGltZUluU2Vjb25kcyA9PT0gbnVsbCB8fCB0aW1lSW5TZWNvbmRzID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdGltZSA9IHRpbWVJblNlY29uZHMgKiAxMDAwO1xuICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgICAgICBpZiAodGltZSA+IGxhdGVuY3kubWF4VGltZSkge1xuICAgICAgICAgICAgbGF0ZW5jeS5tYXhUaW1lID0gdGltZTtcbiAgICAgICAgfVxuICAgICAgICBsYXRlbmN5Lm5leHRVcGRhdGVUaW1lID0gbm93ICsgMzAwMDA7IC8vIExBVEVOQ1lfVVBEQVRFX0ZSRVFVRU5DWVxuICAgICAgICBsYXRlbmN5LmxhdGVuY3kgPSBNYXRoLm1heCgwLCBub3cgLSBsYXRlbmN5Lm1heFRpbWUpO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICB1cGRhdGVMYXRlbmN5U3VtbWFyeSgpIHtcbiAgICAgICAgY29uc3QgeyBibG9ja3MsIG1lc3NhZ2VzLCB0cmFuc2FjdGlvbnMgfSA9IHRoaXMubGF0ZW5jeTtcbiAgICAgICAgdGhpcy5sYXRlbmN5Lm5leHRVcGRhdGVUaW1lID0gTWF0aC5taW4oXG4gICAgICAgICAgICBibG9ja3MubmV4dFVwZGF0ZVRpbWUsXG4gICAgICAgICAgICBtZXNzYWdlcy5uZXh0VXBkYXRlVGltZSxcbiAgICAgICAgICAgIHRyYW5zYWN0aW9ucy5uZXh0VXBkYXRlVGltZSxcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5sYXRlbmN5LmxhdGVuY3kgPSBNYXRoLm1heChcbiAgICAgICAgICAgIGJsb2Nrcy5sYXRlbmN5LFxuICAgICAgICAgICAgbWVzc2FnZXMubGF0ZW5jeSxcbiAgICAgICAgICAgIHRyYW5zYWN0aW9ucy5sYXRlbmN5LFxuICAgICAgICApO1xuICAgICAgICB0aGlzLmxhdGVuY3kubGFzdEJsb2NrVGltZSA9IGJsb2Nrcy5tYXhUaW1lO1xuICAgIH1cblxuICAgIGFzeW5jIHVwZGF0ZU1heFRpbWUobGF0ZW5jeTogQ29sbGVjdGlvbkxhdGVuY3ksIGNvbGxlY3Rpb246IFFEYXRhQ29sbGVjdGlvbiwgZmllbGQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBpZiAoRGF0ZS5ub3coKSA8PSBsYXRlbmN5Lm5leHRVcGRhdGVUaW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcmVzdWx0ID0gKGF3YWl0IGNvbGxlY3Rpb24ucHJvdmlkZXIucXVlcnkoXG4gICAgICAgICAgICBgRk9SIGQgSU4gJHtjb2xsZWN0aW9uLm5hbWV9IFNPUlQgZC4ke2ZpZWxkfSBERVNDIExJTUlUIDEgUkVUVVJOIHsgbWF4VGltZTogZC4ke2ZpZWxkfSB9YCxcbiAgICAgICAgICAgIHt9LCBbeyBwYXRoOiBmaWVsZCwgZGlyZWN0aW9uOiBcIkRFU0NcIiB9XVxuICAgICAgICApKTtcbiAgICAgICAgY29uc3QgbWF4VGltZSA9IChyZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCA+IDAgJiYgcmVzdWx0WzBdKSA/IChyZXN1bHRbMF0ubWF4VGltZSB8fCAwKSA6IDA7XG4gICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZUNvbGxlY3Rpb25MYXRlbmN5KGxhdGVuY3ksIG1heFRpbWUpO1xuXG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0TGF0ZW5jeSgpOiBQcm9taXNlPExhdGVuY3k+IHtcbiAgICAgICAgY29uc3QgbGF0ZW5jeSA9IHRoaXMubGF0ZW5jeTtcbiAgICAgICAgaWYgKERhdGUubm93KCkgPiBsYXRlbmN5Lm5leHRVcGRhdGVUaW1lKSB7XG4gICAgICAgICAgICBsZXQgaGFzVXBkYXRlcyA9IGF3YWl0IHRoaXMudXBkYXRlTWF4VGltZShsYXRlbmN5LmJsb2NrcywgdGhpcy5ibG9ja3MsIFwiZ2VuX3V0aW1lXCIpO1xuICAgICAgICAgICAgaWYgKGF3YWl0IHRoaXMudXBkYXRlTWF4VGltZShsYXRlbmN5Lm1lc3NhZ2VzLCB0aGlzLm1lc3NhZ2VzLCBcImNyZWF0ZWRfYXRcIikpIHtcbiAgICAgICAgICAgICAgICBoYXNVcGRhdGVzID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhd2FpdCB0aGlzLnVwZGF0ZU1heFRpbWUobGF0ZW5jeS50cmFuc2FjdGlvbnMsIHRoaXMudHJhbnNhY3Rpb25zLCBcIm5vd1wiKSkge1xuICAgICAgICAgICAgICAgIGhhc1VwZGF0ZXMgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGhhc1VwZGF0ZXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxhdGVuY3lTdW1tYXJ5KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGxhdGVuY3k7XG4gICAgfVxufVxuIl19