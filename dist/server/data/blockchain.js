"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.INDEXES = void 0;

var _counterparties = require("../graphql/counterparties");

var _data = _interopRequireDefault(require("./data"));

var _collection = require("./collection");

var _resolversGenerated = require("../graphql/resolvers-generated");

var _dataProvider = require("./data-provider");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const INDEXES = {
  blocks: {
    indexes: [(0, _dataProvider.sortedIndex)(['seq_no', 'gen_utime']), (0, _dataProvider.sortedIndex)(['gen_utime']), (0, _dataProvider.sortedIndex)(['workchain_id', 'shard', 'seq_no']), (0, _dataProvider.sortedIndex)(['workchain_id', 'shard', 'gen_utime']), (0, _dataProvider.sortedIndex)(['workchain_id', 'seq_no']), (0, _dataProvider.sortedIndex)(['workchain_id', 'gen_utime']), (0, _dataProvider.sortedIndex)(['master.min_shard_gen_utime']), (0, _dataProvider.sortedIndex)(['prev_ref.root_hash', '_key']), (0, _dataProvider.sortedIndex)(['prev_alt_ref.root_hash', '_key'])]
  },
  accounts: {
    indexes: [(0, _dataProvider.sortedIndex)(['last_trans_lt']), (0, _dataProvider.sortedIndex)(['balance'])]
  },
  messages: {
    indexes: [(0, _dataProvider.sortedIndex)(['block_id']), (0, _dataProvider.sortedIndex)(['value', 'created_at']), (0, _dataProvider.sortedIndex)(['src', 'value', 'created_at']), (0, _dataProvider.sortedIndex)(['dst', 'value', 'created_at']), (0, _dataProvider.sortedIndex)(['src', 'created_at']), (0, _dataProvider.sortedIndex)(['dst', 'created_at']), (0, _dataProvider.sortedIndex)(['created_lt']), (0, _dataProvider.sortedIndex)(['created_at'])]
  },
  transactions: {
    indexes: [(0, _dataProvider.sortedIndex)(['block_id']), (0, _dataProvider.sortedIndex)(['in_msg']), (0, _dataProvider.sortedIndex)(['out_msgs[*]']), (0, _dataProvider.sortedIndex)(['account_addr', 'now']), (0, _dataProvider.sortedIndex)(['now']), (0, _dataProvider.sortedIndex)(['lt']), (0, _dataProvider.sortedIndex)(['account_addr', 'orig_status', 'end_status']), (0, _dataProvider.sortedIndex)(['now', 'account_addr', 'lt'])]
  },
  blocks_signatures: {
    indexes: [(0, _dataProvider.sortedIndex)(['signatures[*].node_id', 'gen_utime'])]
  },
  zerostates: {
    indexes: []
  },
  counterparties: {
    indexes: []
  }
};
exports.INDEXES = INDEXES;
Object.values(INDEXES).forEach(collection => {
  collection.indexes = collection.indexes.concat({
    fields: ['_key']
  });
});

class QBlockchainData extends _data.default {
  constructor(options) {
    super(options);

    const add = (name, type, mutable) => {
      return this.addCollection(name, type, mutable, INDEXES[name].indexes);
    };

    this.accounts = add('accounts', _resolversGenerated.Account, _collection.QDataScope.mutable);
    this.transactions = add('transactions', _resolversGenerated.Transaction, _collection.QDataScope.immutable);
    this.messages = add('messages', _resolversGenerated.Message, _collection.QDataScope.immutable);
    this.blocks = add('blocks', _resolversGenerated.Block, _collection.QDataScope.immutable);
    this.blocks_signatures = add('blocks_signatures', _resolversGenerated.BlockSignatures, _collection.QDataScope.immutable);
    this.zerostates = add('zerostates', _resolversGenerated.Zerostate, _collection.QDataScope.immutable);
    this.counterparties = add('counterparties', _counterparties.Counterparty, _collection.QDataScope.counterparties);
    this.lastBlockTime = null;
    this.lastBlockTimeUpdateTime = null;
    this.blocks.docInsertOrUpdate.on("doc", async block => {
      this.updateLastBlockTimeFromGenUTime(block.gen_utime);
    });
  }

  updateLastBlockTimeFromGenUTime(genUTime) {
    if (genUTime) {
      const time = genUTime * 1000;

      if (!this.lastBlockTime || time > this.lastBlockTime) {
        this.lastBlockTime = time;
        this.lastBlockTimeUpdateTime = Date.now();
      }
    }
  }

  async getLastBlockTime() {
    const isRefreshRequired = this.lastBlockTime === null || this.lastBlockTimeUpdateTime === null || Date.now() - (this.lastBlockTimeUpdateTime || 0) > 30000;

    if (isRefreshRequired) {
      const result = await this.blocks.provider.query("FOR b IN blocks COLLECT AGGREGATE m = MAX(b.gen_utime) RETURN { maxGenUTime: m }", {}, []);
      this.updateLastBlockTimeFromGenUTime(result[0].maxGenUTime);
    }

    return this.lastBlockTime || 0;
  }

}

exports.default = QBlockchainData;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9ibG9ja2NoYWluLmpzIl0sIm5hbWVzIjpbIklOREVYRVMiLCJibG9ja3MiLCJpbmRleGVzIiwiYWNjb3VudHMiLCJtZXNzYWdlcyIsInRyYW5zYWN0aW9ucyIsImJsb2Nrc19zaWduYXR1cmVzIiwiemVyb3N0YXRlcyIsImNvdW50ZXJwYXJ0aWVzIiwiT2JqZWN0IiwidmFsdWVzIiwiZm9yRWFjaCIsImNvbGxlY3Rpb24iLCJjb25jYXQiLCJmaWVsZHMiLCJRQmxvY2tjaGFpbkRhdGEiLCJRRGF0YSIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImFkZCIsIm5hbWUiLCJ0eXBlIiwibXV0YWJsZSIsImFkZENvbGxlY3Rpb24iLCJBY2NvdW50IiwiUURhdGFTY29wZSIsIlRyYW5zYWN0aW9uIiwiaW1tdXRhYmxlIiwiTWVzc2FnZSIsIkJsb2NrIiwiQmxvY2tTaWduYXR1cmVzIiwiWmVyb3N0YXRlIiwiQ291bnRlcnBhcnR5IiwibGFzdEJsb2NrVGltZSIsImxhc3RCbG9ja1RpbWVVcGRhdGVUaW1lIiwiZG9jSW5zZXJ0T3JVcGRhdGUiLCJvbiIsImJsb2NrIiwidXBkYXRlTGFzdEJsb2NrVGltZUZyb21HZW5VVGltZSIsImdlbl91dGltZSIsImdlblVUaW1lIiwidGltZSIsIkRhdGUiLCJub3ciLCJnZXRMYXN0QmxvY2tUaW1lIiwiaXNSZWZyZXNoUmVxdWlyZWQiLCJyZXN1bHQiLCJwcm92aWRlciIsInF1ZXJ5IiwibWF4R2VuVVRpbWUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFrQkE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBUUE7Ozs7QUE5QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBa0JPLE1BQU1BLE9BQU8sR0FBRztBQUNuQkMsRUFBQUEsTUFBTSxFQUFFO0FBQ0pDLElBQUFBLE9BQU8sRUFBRSxDQUNMLCtCQUFZLENBQUMsUUFBRCxFQUFXLFdBQVgsQ0FBWixDQURLLEVBRUwsK0JBQVksQ0FBQyxXQUFELENBQVosQ0FGSyxFQUdMLCtCQUFZLENBQUMsY0FBRCxFQUFpQixPQUFqQixFQUEwQixRQUExQixDQUFaLENBSEssRUFJTCwrQkFBWSxDQUFDLGNBQUQsRUFBaUIsT0FBakIsRUFBMEIsV0FBMUIsQ0FBWixDQUpLLEVBS0wsK0JBQVksQ0FBQyxjQUFELEVBQWlCLFFBQWpCLENBQVosQ0FMSyxFQU1MLCtCQUFZLENBQUMsY0FBRCxFQUFpQixXQUFqQixDQUFaLENBTkssRUFPTCwrQkFBWSxDQUFDLDRCQUFELENBQVosQ0FQSyxFQVFMLCtCQUFZLENBQUMsb0JBQUQsRUFBdUIsTUFBdkIsQ0FBWixDQVJLLEVBU0wsK0JBQVksQ0FBQyx3QkFBRCxFQUEyQixNQUEzQixDQUFaLENBVEs7QUFETCxHQURXO0FBY25CQyxFQUFBQSxRQUFRLEVBQUU7QUFDTkQsSUFBQUEsT0FBTyxFQUFFLENBQ0wsK0JBQVksQ0FBQyxlQUFELENBQVosQ0FESyxFQUVMLCtCQUFZLENBQUMsU0FBRCxDQUFaLENBRks7QUFESCxHQWRTO0FBb0JuQkUsRUFBQUEsUUFBUSxFQUFFO0FBQ05GLElBQUFBLE9BQU8sRUFBRSxDQUNMLCtCQUFZLENBQUMsVUFBRCxDQUFaLENBREssRUFFTCwrQkFBWSxDQUFDLE9BQUQsRUFBVSxZQUFWLENBQVosQ0FGSyxFQUdMLCtCQUFZLENBQUMsS0FBRCxFQUFRLE9BQVIsRUFBaUIsWUFBakIsQ0FBWixDQUhLLEVBSUwsK0JBQVksQ0FBQyxLQUFELEVBQVEsT0FBUixFQUFpQixZQUFqQixDQUFaLENBSkssRUFLTCwrQkFBWSxDQUFDLEtBQUQsRUFBUSxZQUFSLENBQVosQ0FMSyxFQU1MLCtCQUFZLENBQUMsS0FBRCxFQUFRLFlBQVIsQ0FBWixDQU5LLEVBT0wsK0JBQVksQ0FBQyxZQUFELENBQVosQ0FQSyxFQVFMLCtCQUFZLENBQUMsWUFBRCxDQUFaLENBUks7QUFESCxHQXBCUztBQWdDbkJHLEVBQUFBLFlBQVksRUFBRTtBQUNWSCxJQUFBQSxPQUFPLEVBQUUsQ0FDTCwrQkFBWSxDQUFDLFVBQUQsQ0FBWixDQURLLEVBRUwsK0JBQVksQ0FBQyxRQUFELENBQVosQ0FGSyxFQUdMLCtCQUFZLENBQUMsYUFBRCxDQUFaLENBSEssRUFJTCwrQkFBWSxDQUFDLGNBQUQsRUFBaUIsS0FBakIsQ0FBWixDQUpLLEVBS0wsK0JBQVksQ0FBQyxLQUFELENBQVosQ0FMSyxFQU1MLCtCQUFZLENBQUMsSUFBRCxDQUFaLENBTkssRUFPTCwrQkFBWSxDQUFDLGNBQUQsRUFBaUIsYUFBakIsRUFBZ0MsWUFBaEMsQ0FBWixDQVBLLEVBUUwsK0JBQVksQ0FBQyxLQUFELEVBQVEsY0FBUixFQUF3QixJQUF4QixDQUFaLENBUks7QUFEQyxHQWhDSztBQTRDbkJJLEVBQUFBLGlCQUFpQixFQUFFO0FBQ2ZKLElBQUFBLE9BQU8sRUFBRSxDQUNMLCtCQUFZLENBQUMsdUJBQUQsRUFBMEIsV0FBMUIsQ0FBWixDQURLO0FBRE0sR0E1Q0E7QUFpRG5CSyxFQUFBQSxVQUFVLEVBQUU7QUFDUkwsSUFBQUEsT0FBTyxFQUFFO0FBREQsR0FqRE87QUFvRG5CTSxFQUFBQSxjQUFjLEVBQUU7QUFDWk4sSUFBQUEsT0FBTyxFQUFFO0FBREc7QUFwREcsQ0FBaEI7O0FBMERQTyxNQUFNLENBQUNDLE1BQVAsQ0FBY1YsT0FBZCxFQUF1QlcsT0FBdkIsQ0FBZ0NDLFVBQUQsSUFBcUI7QUFDaERBLEVBQUFBLFVBQVUsQ0FBQ1YsT0FBWCxHQUFxQlUsVUFBVSxDQUFDVixPQUFYLENBQW1CVyxNQUFuQixDQUEwQjtBQUFFQyxJQUFBQSxNQUFNLEVBQUUsQ0FBQyxNQUFEO0FBQVYsR0FBMUIsQ0FBckI7QUFDSCxDQUZEOztBQUtlLE1BQU1DLGVBQU4sU0FBOEJDLGFBQTlCLENBQW9DO0FBWS9DQyxFQUFBQSxXQUFXLENBQUNDLE9BQUQsRUFBd0I7QUFDL0IsVUFBTUEsT0FBTjs7QUFDQSxVQUFNQyxHQUFHLEdBQUcsQ0FBQ0MsSUFBRCxFQUFPQyxJQUFQLEVBQWFDLE9BQWIsS0FBeUI7QUFDakMsYUFBTyxLQUFLQyxhQUFMLENBQW1CSCxJQUFuQixFQUF5QkMsSUFBekIsRUFBK0JDLE9BQS9CLEVBQXdDdEIsT0FBTyxDQUFDb0IsSUFBRCxDQUFQLENBQWNsQixPQUF0RCxDQUFQO0FBQ0gsS0FGRDs7QUFHQSxTQUFLQyxRQUFMLEdBQWdCZ0IsR0FBRyxDQUFDLFVBQUQsRUFBYUssMkJBQWIsRUFBc0JDLHVCQUFXSCxPQUFqQyxDQUFuQjtBQUNBLFNBQUtqQixZQUFMLEdBQW9CYyxHQUFHLENBQUMsY0FBRCxFQUFpQk8sK0JBQWpCLEVBQThCRCx1QkFBV0UsU0FBekMsQ0FBdkI7QUFDQSxTQUFLdkIsUUFBTCxHQUFnQmUsR0FBRyxDQUFDLFVBQUQsRUFBYVMsMkJBQWIsRUFBc0JILHVCQUFXRSxTQUFqQyxDQUFuQjtBQUNBLFNBQUsxQixNQUFMLEdBQWNrQixHQUFHLENBQUMsUUFBRCxFQUFXVSx5QkFBWCxFQUFrQkosdUJBQVdFLFNBQTdCLENBQWpCO0FBQ0EsU0FBS3JCLGlCQUFMLEdBQXlCYSxHQUFHLENBQUMsbUJBQUQsRUFBc0JXLG1DQUF0QixFQUF1Q0wsdUJBQVdFLFNBQWxELENBQTVCO0FBQ0EsU0FBS3BCLFVBQUwsR0FBa0JZLEdBQUcsQ0FBQyxZQUFELEVBQWVZLDZCQUFmLEVBQTBCTix1QkFBV0UsU0FBckMsQ0FBckI7QUFDQSxTQUFLbkIsY0FBTCxHQUFzQlcsR0FBRyxDQUFDLGdCQUFELEVBQW1CYSw0QkFBbkIsRUFBaUNQLHVCQUFXakIsY0FBNUMsQ0FBekI7QUFDQSxTQUFLeUIsYUFBTCxHQUFxQixJQUFyQjtBQUNBLFNBQUtDLHVCQUFMLEdBQStCLElBQS9CO0FBQ0EsU0FBS2pDLE1BQUwsQ0FBWWtDLGlCQUFaLENBQThCQyxFQUE5QixDQUFpQyxLQUFqQyxFQUF3QyxNQUFPQyxLQUFQLElBQWlCO0FBQ3JELFdBQUtDLCtCQUFMLENBQXFDRCxLQUFLLENBQUNFLFNBQTNDO0FBQ0gsS0FGRDtBQUdIOztBQUVERCxFQUFBQSwrQkFBK0IsQ0FBQ0UsUUFBRCxFQUFxQjtBQUNoRCxRQUFJQSxRQUFKLEVBQWM7QUFDVixZQUFNQyxJQUFJLEdBQUdELFFBQVEsR0FBRyxJQUF4Qjs7QUFDQSxVQUFJLENBQUMsS0FBS1AsYUFBTixJQUF1QlEsSUFBSSxHQUFHLEtBQUtSLGFBQXZDLEVBQXNEO0FBQ2xELGFBQUtBLGFBQUwsR0FBcUJRLElBQXJCO0FBQ0EsYUFBS1AsdUJBQUwsR0FBK0JRLElBQUksQ0FBQ0MsR0FBTCxFQUEvQjtBQUNIO0FBQ0o7QUFDSjs7QUFFcUIsUUFBaEJDLGdCQUFnQixHQUFvQjtBQUN0QyxVQUFNQyxpQkFBaUIsR0FDbEIsS0FBS1osYUFBTCxLQUF1QixJQUF2QixJQUErQixLQUFLQyx1QkFBTCxLQUFpQyxJQUFqRSxJQUNJUSxJQUFJLENBQUNDLEdBQUwsTUFBYyxLQUFLVCx1QkFBTCxJQUFnQyxDQUE5QyxDQUFELEdBQXFELEtBRjVEOztBQUdBLFFBQUlXLGlCQUFKLEVBQXVCO0FBQ25CLFlBQU1DLE1BQU0sR0FBRyxNQUFNLEtBQUs3QyxNQUFMLENBQVk4QyxRQUFaLENBQXFCQyxLQUFyQixDQUNqQixrRkFEaUIsRUFFakIsRUFGaUIsRUFFYixFQUZhLENBQXJCO0FBSUEsV0FBS1YsK0JBQUwsQ0FBcUNRLE1BQU0sQ0FBQyxDQUFELENBQU4sQ0FBVUcsV0FBL0M7QUFDSDs7QUFDRCxXQUFPLEtBQUtoQixhQUFMLElBQXNCLENBQTdCO0FBQ0g7O0FBckQ4QyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAxOC0yMDIwIFRPTiBERVYgU09MVVRJT05TIExURC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgU09GVFdBUkUgRVZBTFVBVElPTiBMaWNlbnNlICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2VcbiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZVxuICogTGljZW5zZSBhdDpcbiAqXG4gKiBodHRwOi8vd3d3LnRvbi5kZXYvbGljZW5zZXNcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIFRPTiBERVYgc29mdHdhcmUgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuLy8gQGZsb3dcblxuaW1wb3J0IHsgQ291bnRlcnBhcnR5IH0gZnJvbSBcIi4uL2dyYXBocWwvY291bnRlcnBhcnRpZXNcIjtcbmltcG9ydCB0eXBlIHsgUURhdGFPcHRpb25zIH0gZnJvbSAnLi9kYXRhJztcbmltcG9ydCBRRGF0YSBmcm9tICcuL2RhdGEnO1xuaW1wb3J0IHsgUURhdGFDb2xsZWN0aW9uLCBRRGF0YVNjb3BlIH0gZnJvbSAnLi9jb2xsZWN0aW9uJztcbmltcG9ydCB7XG4gICAgQWNjb3VudCxcbiAgICBCbG9jayxcbiAgICBCbG9ja1NpZ25hdHVyZXMsXG4gICAgTWVzc2FnZSxcbiAgICBUcmFuc2FjdGlvbixcbiAgICBaZXJvc3RhdGUsXG59IGZyb20gJy4uL2dyYXBocWwvcmVzb2x2ZXJzLWdlbmVyYXRlZCc7XG5pbXBvcnQgeyBzb3J0ZWRJbmRleCB9IGZyb20gJy4vZGF0YS1wcm92aWRlcic7XG5cbmV4cG9ydCBjb25zdCBJTkRFWEVTID0ge1xuICAgIGJsb2Nrczoge1xuICAgICAgICBpbmRleGVzOiBbXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3NlcV9ubycsICdnZW5fdXRpbWUnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2dlbl91dGltZSddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnd29ya2NoYWluX2lkJywgJ3NoYXJkJywgJ3NlcV9ubyddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnd29ya2NoYWluX2lkJywgJ3NoYXJkJywgJ2dlbl91dGltZSddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnd29ya2NoYWluX2lkJywgJ3NlcV9ubyddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnd29ya2NoYWluX2lkJywgJ2dlbl91dGltZSddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnbWFzdGVyLm1pbl9zaGFyZF9nZW5fdXRpbWUnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3ByZXZfcmVmLnJvb3RfaGFzaCcsICdfa2V5J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydwcmV2X2FsdF9yZWYucm9vdF9oYXNoJywgJ19rZXknXSksXG4gICAgICAgIF0sXG4gICAgfSxcbiAgICBhY2NvdW50czoge1xuICAgICAgICBpbmRleGVzOiBbXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2xhc3RfdHJhbnNfbHQnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2JhbGFuY2UnXSksXG4gICAgICAgIF0sXG4gICAgfSxcbiAgICBtZXNzYWdlczoge1xuICAgICAgICBpbmRleGVzOiBbXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2Jsb2NrX2lkJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWyd2YWx1ZScsICdjcmVhdGVkX2F0J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydzcmMnLCAndmFsdWUnLCAnY3JlYXRlZF9hdCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnZHN0JywgJ3ZhbHVlJywgJ2NyZWF0ZWRfYXQnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ3NyYycsICdjcmVhdGVkX2F0J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydkc3QnLCAnY3JlYXRlZF9hdCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnY3JlYXRlZF9sdCddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnY3JlYXRlZF9hdCddKSxcbiAgICAgICAgXSxcbiAgICB9LFxuICAgIHRyYW5zYWN0aW9uczoge1xuICAgICAgICBpbmRleGVzOiBbXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2Jsb2NrX2lkJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydpbl9tc2cnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ291dF9tc2dzWypdJ10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydhY2NvdW50X2FkZHInLCAnbm93J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydub3cnXSksXG4gICAgICAgICAgICBzb3J0ZWRJbmRleChbJ2x0J10pLFxuICAgICAgICAgICAgc29ydGVkSW5kZXgoWydhY2NvdW50X2FkZHInLCAnb3JpZ19zdGF0dXMnLCAnZW5kX3N0YXR1cyddKSxcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnbm93JywgJ2FjY291bnRfYWRkcicsICdsdCddKSxcbiAgICAgICAgXSxcbiAgICB9LFxuICAgIGJsb2Nrc19zaWduYXR1cmVzOiB7XG4gICAgICAgIGluZGV4ZXM6IFtcbiAgICAgICAgICAgIHNvcnRlZEluZGV4KFsnc2lnbmF0dXJlc1sqXS5ub2RlX2lkJywgJ2dlbl91dGltZSddKSxcbiAgICAgICAgXSxcbiAgICB9LFxuICAgIHplcm9zdGF0ZXM6IHtcbiAgICAgICAgaW5kZXhlczogW10sXG4gICAgfSxcbiAgICBjb3VudGVycGFydGllczoge1xuICAgICAgICBpbmRleGVzOiBbXSxcbiAgICB9LFxufTtcblxuXG5PYmplY3QudmFsdWVzKElOREVYRVMpLmZvckVhY2goKGNvbGxlY3Rpb246IGFueSkgPT4ge1xuICAgIGNvbGxlY3Rpb24uaW5kZXhlcyA9IGNvbGxlY3Rpb24uaW5kZXhlcy5jb25jYXQoeyBmaWVsZHM6IFsnX2tleSddIH0pO1xufSk7XG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUUJsb2NrY2hhaW5EYXRhIGV4dGVuZHMgUURhdGEge1xuICAgIHRyYW5zYWN0aW9uczogUURhdGFDb2xsZWN0aW9uO1xuICAgIG1lc3NhZ2VzOiBRRGF0YUNvbGxlY3Rpb247XG4gICAgYWNjb3VudHM6IFFEYXRhQ29sbGVjdGlvbjtcbiAgICBibG9ja3M6IFFEYXRhQ29sbGVjdGlvbjtcbiAgICBibG9ja3Nfc2lnbmF0dXJlczogUURhdGFDb2xsZWN0aW9uO1xuICAgIHplcm9zdGF0ZXM6IFFEYXRhQ29sbGVjdGlvbjtcbiAgICBjb3VudGVycGFydGllczogUURhdGFDb2xsZWN0aW9uO1xuXG4gICAgbGFzdEJsb2NrVGltZTogP251bWJlcjtcbiAgICBsYXN0QmxvY2tUaW1lVXBkYXRlVGltZTogP251bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IFFEYXRhT3B0aW9ucykge1xuICAgICAgICBzdXBlcihvcHRpb25zKTtcbiAgICAgICAgY29uc3QgYWRkID0gKG5hbWUsIHR5cGUsIG11dGFibGUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZENvbGxlY3Rpb24obmFtZSwgdHlwZSwgbXV0YWJsZSwgSU5ERVhFU1tuYW1lXS5pbmRleGVzKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5hY2NvdW50cyA9IGFkZCgnYWNjb3VudHMnLCBBY2NvdW50LCBRRGF0YVNjb3BlLm11dGFibGUpO1xuICAgICAgICB0aGlzLnRyYW5zYWN0aW9ucyA9IGFkZCgndHJhbnNhY3Rpb25zJywgVHJhbnNhY3Rpb24sIFFEYXRhU2NvcGUuaW1tdXRhYmxlKTtcbiAgICAgICAgdGhpcy5tZXNzYWdlcyA9IGFkZCgnbWVzc2FnZXMnLCBNZXNzYWdlLCBRRGF0YVNjb3BlLmltbXV0YWJsZSk7XG4gICAgICAgIHRoaXMuYmxvY2tzID0gYWRkKCdibG9ja3MnLCBCbG9jaywgUURhdGFTY29wZS5pbW11dGFibGUpO1xuICAgICAgICB0aGlzLmJsb2Nrc19zaWduYXR1cmVzID0gYWRkKCdibG9ja3Nfc2lnbmF0dXJlcycsIEJsb2NrU2lnbmF0dXJlcywgUURhdGFTY29wZS5pbW11dGFibGUpO1xuICAgICAgICB0aGlzLnplcm9zdGF0ZXMgPSBhZGQoJ3plcm9zdGF0ZXMnLCBaZXJvc3RhdGUsIFFEYXRhU2NvcGUuaW1tdXRhYmxlKTtcbiAgICAgICAgdGhpcy5jb3VudGVycGFydGllcyA9IGFkZCgnY291bnRlcnBhcnRpZXMnLCBDb3VudGVycGFydHksIFFEYXRhU2NvcGUuY291bnRlcnBhcnRpZXMpO1xuICAgICAgICB0aGlzLmxhc3RCbG9ja1RpbWUgPSBudWxsO1xuICAgICAgICB0aGlzLmxhc3RCbG9ja1RpbWVVcGRhdGVUaW1lID0gbnVsbDtcbiAgICAgICAgdGhpcy5ibG9ja3MuZG9jSW5zZXJ0T3JVcGRhdGUub24oXCJkb2NcIiwgYXN5bmMgKGJsb2NrKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUxhc3RCbG9ja1RpbWVGcm9tR2VuVVRpbWUoYmxvY2suZ2VuX3V0aW1lKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgdXBkYXRlTGFzdEJsb2NrVGltZUZyb21HZW5VVGltZShnZW5VVGltZT86ID9udW1iZXIpIHtcbiAgICAgICAgaWYgKGdlblVUaW1lKSB7XG4gICAgICAgICAgICBjb25zdCB0aW1lID0gZ2VuVVRpbWUgKiAxMDAwO1xuICAgICAgICAgICAgaWYgKCF0aGlzLmxhc3RCbG9ja1RpbWUgfHwgdGltZSA+IHRoaXMubGFzdEJsb2NrVGltZSkge1xuICAgICAgICAgICAgICAgIHRoaXMubGFzdEJsb2NrVGltZSA9IHRpbWU7XG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0QmxvY2tUaW1lVXBkYXRlVGltZSA9IERhdGUubm93KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBnZXRMYXN0QmxvY2tUaW1lKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGNvbnN0IGlzUmVmcmVzaFJlcXVpcmVkID1cbiAgICAgICAgICAgICh0aGlzLmxhc3RCbG9ja1RpbWUgPT09IG51bGwgfHwgdGhpcy5sYXN0QmxvY2tUaW1lVXBkYXRlVGltZSA9PT0gbnVsbClcbiAgICAgICAgICAgIHx8IChEYXRlLm5vdygpIC0gKHRoaXMubGFzdEJsb2NrVGltZVVwZGF0ZVRpbWUgfHwgMCkpID4gMzAwMDBcbiAgICAgICAgaWYgKGlzUmVmcmVzaFJlcXVpcmVkKSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmJsb2Nrcy5wcm92aWRlci5xdWVyeShcbiAgICAgICAgICAgICAgICBcIkZPUiBiIElOIGJsb2NrcyBDT0xMRUNUIEFHR1JFR0FURSBtID0gTUFYKGIuZ2VuX3V0aW1lKSBSRVRVUk4geyBtYXhHZW5VVGltZTogbSB9XCIsXG4gICAgICAgICAgICAgICAge30sIFtdXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVMYXN0QmxvY2tUaW1lRnJvbUdlblVUaW1lKHJlc3VsdFswXS5tYXhHZW5VVGltZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMubGFzdEJsb2NrVGltZSB8fCAwO1xuICAgIH1cbn1cbiJdfQ==