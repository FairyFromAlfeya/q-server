"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.AggregationHelperFactory = exports.AggregationFn = void 0;

var _resolversGenerated = require("../graphql/resolvers-generated");

const AggregationFn = {
  COUNT: 'COUNT',
  MIN: 'MIN',
  MAX: 'MAX',
  SUM: 'SUM',
  AVERAGE: 'AVERAGE'
};
exports.AggregationFn = AggregationFn;

// Query Builders

/**
 * Returns query parts in form of:
 * { collect: 'a<i> = <exprs0>', result: 'a<i>'} if exprs.length === 1
 * or
 * { collect: 'a<i> = <exprs0>, b<i> = <exprs1>, ..'., result: '{ a: a<i>, b: b<i>, ... }'}
 * if exprs.length > 1
 *
 * @param exprs
 * @param context
 * @return {{result: string, collects: string}}
 */
function queryParts(context, ...exprs) {
  const n = 'abcdef';

  const v = i => `${n[i]}${context.index}`; // 'a0' | 'b0' | ...


  const collectExpr = (x, i) => `${v(i)} = ${x}`; // 'a0 = expr[0]' | 'b0 = expr[1]' | ...


  const returnExpr = (x, i) => `${n[i]}: ${v(i)}`; // 'a: a0' | 'b: b0' | ...


  return {
    collect: exprs.map(collectExpr).join(', '),
    // 'a0 = expr[0], b0 = expr[1], ...'
    result: exprs.length === 1 ? `${v(0)}` // 'a0'
    : `{ ${exprs.map(returnExpr).join(', ')} }` // '{ a: a0, b: b0, ... }'

  };
}

const countField = {
  type: 'string',
  path: ''
};

function count(context) {
  return queryParts(context, 'COUNT(doc)');
}

function simple(context) {
  const fn = context.fn;
  return queryParts(context, context.isArray ? `${fn}(${fn}(${context.field.path}))` : `${fn}(${context.field.path})`);
}

function bigIntToNum(hex) {
  return `TO_NUMBER(CONCAT("0x", ${hex}))`;
}

function negBigIntToNum(hex) {
  return `-(EXP2(LENGTH(${hex}) * 4) - 1 - ${bigIntToNum(hex)})`;
}

function bigIntHiPart(path, prefix) {
  return `SUBSTRING(${path}, ${prefix}, LENGTH(${path}) - ${prefix + 8})`;
}

function bigIntLoPart(path, prefix) {
  return `RIGHT(SUBSTRING(${path}, ${prefix}), 8)`;
}

function signedBigIntPart(path, prefix, part) {
  return `SUBSTRING(${path}, 0, 1) == "-"
    ? ${negBigIntToNum(part(path, prefix + 1))}
    : ${bigIntToNum(part(path, prefix))}`;
}

function signedBigIntHiPart(path, prefix) {
  return signedBigIntPart(path, prefix, bigIntHiPart);
}

function signedBigIntLoPart(path, prefix) {
  return signedBigIntPart(path, prefix, bigIntLoPart);
}

function bigIntSumExpr(part, context) {
  const path = context.field.path;
  const prefix = context.bigIntPrefix;
  return context.isArray ? `SUM(SUM((${path})[* RETURN ${part('CURRENT', prefix)}]))` : `SUM(${part(path, prefix)})`;
}

function bigIntSum(context) {
  return queryParts(context, bigIntSumExpr(signedBigIntHiPart, context), bigIntSumExpr(signedBigIntLoPart, context));
}

function bigIntAvg(context) {
  return queryParts(context, bigIntSumExpr(signedBigIntHiPart, context), bigIntSumExpr(signedBigIntLoPart, context), context.isArray ? `SUM(COUNT(${context.field.path}))` : `COUNT(doc)`);
} // Converters


function reduce(context, values, fn) {
  let reduced = values[0];

  for (let i = 1; i < values.length; i += 1) {
    const value = values[i];

    if (fn === 'MIN') {
      if (value < reduced) {
        reduced = value;
      }
    } else if (fn === 'MAX') {
      if (value > reduced) {
        reduced = value;
      }
    } else {
      reduced += value;
    }
  }

  if (fn === 'AVERAGE') {
    if (context.bigIntPrefix > 0) {
      reduced = reduced / BigInt(values.length);
    } else {
      reduced = Math.trunc(reduced / values.length);
    }
  }

  return reduced;
}

function reducer(convert, convertBack, fn) {
  return (context, values) => {
    if (values.length === 0) {
      return undefined;
    }

    let reduced = reduce(context, values.map(x => convert(context, x)), fn);
    return convertBack(context, reduced);
  };
}

function noConversion(context, x) {
  return x;
}

function bigIntStringToDecimalString(context, value) {
  if (typeof value === 'number') {
    return value.toString();
  } //$FlowFixMe


  return value.substr(0, 1) === "-" ? BigInt(`-0x${value.substr(context.bigIntPrefix + 1)}`).toString() : BigInt(`0x${value.substr(context.bigIntPrefix)}`).toString();
} //$FlowFixMe


function bigIntPartsToBigInt(context, parts) {
  const h = parts.a >= 0 ? BigInt(`0x${Math.round(parts.a).toString(16)}00000000`) : -BigInt(`0x${Math.round(Math.abs(parts.a)).toString(16)}00000000`);
  const l = BigInt(Math.round(parts.b));
  return h + l;
}

function toString(context, value) {
  return value.toString();
}

function bigIntPartsToBigIntAvg(context, value) {
  const sum = bigIntPartsToBigInt(context, value);
  const count = Number(value.c || 0);
  return count > 0 ? sum / BigInt(Math.round(count)) : sum;
}

class AggregationHelperFactory {
  static create(collection, index, aggregation) {
    const field = _resolversGenerated.scalarFields.get(`${collection}.${aggregation.field || 'id'}`) || countField;
    const fn = aggregation.fn || AggregationFn.COUNT;
    const context = {
      index,
      field,
      fn,
      bigIntPrefix: field.type === 'uint1024' ? 2 : field.type === 'uint64' ? 1 : 0,
      isArray: field.path.includes('[*]')
    }; // Case of count

    if (context.fn === AggregationFn.COUNT) {
      return {
        context,
        buildQuery: count,
        convertResult: (context, values) => reduce(context, values, 'SUM')
      };
    }

    if (context.field.path === '') {
      throw new Error(`[${aggregation.field}] can't be aggregated`);
    } // Case of number fields or min/max fn


    if (field.type === 'number' || fn === AggregationFn.MIN || fn === AggregationFn.MAX) {
      return {
        context,
        buildQuery: simple,
        convertResult: context.bigIntPrefix > 0 // big integers
        ? reducer(noConversion, bigIntStringToDecimalString, fn) // numbers and strings
        : reducer(noConversion, noConversion, fn)
      };
    }

    if (context.bigIntPrefix > 0) {
      return context.fn === AggregationFn.AVERAGE ? {
        // big integer average
        context,
        buildQuery: bigIntAvg,
        convertResult: reducer(bigIntPartsToBigIntAvg, toString, fn)
      } : {
        // big integer sum
        context,
        buildQuery: bigIntSum,
        convertResult: reducer(bigIntPartsToBigInt, toString, fn)
      };
    }

    throw new Error(`[${aggregation.field}] can't be used with [${fn}]`);
  }

  static createQuery(collection, filter, fields) {
    const filterSection = filter ? `FILTER ${filter}` : '';
    const helpers = fields.map((aggregation, i) => {
      return AggregationHelperFactory.create(collection, i, aggregation);
    });
    let text;
    const isSingleCount = fields.length === 1 && fields[0].fn === AggregationFn.COUNT;

    if (isSingleCount) {
      if (filterSection !== '') {
        text = `
                    FOR doc IN ${collection}
                    ${filterSection}
                    COLLECT WITH COUNT INTO a0
                    RETURN [a0]`;
      } else {
        text = `RETURN [LENGTH(${collection})]`;
      }
    } else {
      const queries = helpers.map(x => x.buildQuery(x.context));
      text = `
                FOR doc IN ${collection}
                ${filterSection}
                COLLECT AGGREGATE ${queries.map(x => x.collect).join(', ')}
                RETURN [${queries.map(x => x.result).join(', ')}]`;
    }

    return {
      text,
      helpers
    };
  }

  static convertResults(results, helpers) {
    return helpers.map((helper, i) => {
      const values = results.map(x => x[i]).filter(x => x !== undefined && x !== null);
      return helper.convertResult(helper.context, values);
    });
  }

}

exports.AggregationHelperFactory = AggregationHelperFactory;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9hZ2dyZWdhdGlvbnMuanMiXSwibmFtZXMiOlsiQWdncmVnYXRpb25GbiIsIkNPVU5UIiwiTUlOIiwiTUFYIiwiU1VNIiwiQVZFUkFHRSIsInF1ZXJ5UGFydHMiLCJjb250ZXh0IiwiZXhwcnMiLCJuIiwidiIsImkiLCJpbmRleCIsImNvbGxlY3RFeHByIiwieCIsInJldHVybkV4cHIiLCJjb2xsZWN0IiwibWFwIiwiam9pbiIsInJlc3VsdCIsImxlbmd0aCIsImNvdW50RmllbGQiLCJ0eXBlIiwicGF0aCIsImNvdW50Iiwic2ltcGxlIiwiZm4iLCJpc0FycmF5IiwiZmllbGQiLCJiaWdJbnRUb051bSIsImhleCIsIm5lZ0JpZ0ludFRvTnVtIiwiYmlnSW50SGlQYXJ0IiwicHJlZml4IiwiYmlnSW50TG9QYXJ0Iiwic2lnbmVkQmlnSW50UGFydCIsInBhcnQiLCJzaWduZWRCaWdJbnRIaVBhcnQiLCJzaWduZWRCaWdJbnRMb1BhcnQiLCJiaWdJbnRTdW1FeHByIiwiYmlnSW50UHJlZml4IiwiYmlnSW50U3VtIiwiYmlnSW50QXZnIiwicmVkdWNlIiwidmFsdWVzIiwicmVkdWNlZCIsInZhbHVlIiwiQmlnSW50IiwiTWF0aCIsInRydW5jIiwicmVkdWNlciIsImNvbnZlcnQiLCJjb252ZXJ0QmFjayIsInVuZGVmaW5lZCIsIm5vQ29udmVyc2lvbiIsImJpZ0ludFN0cmluZ1RvRGVjaW1hbFN0cmluZyIsInRvU3RyaW5nIiwic3Vic3RyIiwiYmlnSW50UGFydHNUb0JpZ0ludCIsInBhcnRzIiwiaCIsImEiLCJyb3VuZCIsImFicyIsImwiLCJiIiwiYmlnSW50UGFydHNUb0JpZ0ludEF2ZyIsInN1bSIsIk51bWJlciIsImMiLCJBZ2dyZWdhdGlvbkhlbHBlckZhY3RvcnkiLCJjcmVhdGUiLCJjb2xsZWN0aW9uIiwiYWdncmVnYXRpb24iLCJzY2FsYXJGaWVsZHMiLCJnZXQiLCJpbmNsdWRlcyIsImJ1aWxkUXVlcnkiLCJjb252ZXJ0UmVzdWx0IiwiRXJyb3IiLCJjcmVhdGVRdWVyeSIsImZpbHRlciIsImZpZWxkcyIsImZpbHRlclNlY3Rpb24iLCJoZWxwZXJzIiwidGV4dCIsImlzU2luZ2xlQ291bnQiLCJxdWVyaWVzIiwiY29udmVydFJlc3VsdHMiLCJyZXN1bHRzIiwiaGVscGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBR0E7O0FBSU8sTUFBTUEsYUFBYSxHQUFHO0FBQ3pCQyxFQUFBQSxLQUFLLEVBQUUsT0FEa0I7QUFFekJDLEVBQUFBLEdBQUcsRUFBRSxLQUZvQjtBQUd6QkMsRUFBQUEsR0FBRyxFQUFFLEtBSG9CO0FBSXpCQyxFQUFBQSxHQUFHLEVBQUUsS0FKb0I7QUFLekJDLEVBQUFBLE9BQU8sRUFBRTtBQUxnQixDQUF0Qjs7O0FBa0NQOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTQyxVQUFULENBQW9CQyxPQUFwQixFQUFpRCxHQUFHQyxLQUFwRCxFQUE0RjtBQUN4RixRQUFNQyxDQUFDLEdBQUcsUUFBVjs7QUFDQSxRQUFNQyxDQUFDLEdBQUlDLENBQUQsSUFBUSxHQUFFRixDQUFDLENBQUNFLENBQUQsQ0FBSSxHQUFFSixPQUFPLENBQUNLLEtBQU0sRUFBekMsQ0FGd0YsQ0FFNUM7OztBQUM1QyxRQUFNQyxXQUFXLEdBQUcsQ0FBQ0MsQ0FBRCxFQUFJSCxDQUFKLEtBQVcsR0FBRUQsQ0FBQyxDQUFDQyxDQUFELENBQUksTUFBS0csQ0FBRSxFQUE3QyxDQUh3RixDQUd4Qzs7O0FBQ2hELFFBQU1DLFVBQVUsR0FBRyxDQUFDRCxDQUFELEVBQUlILENBQUosS0FBVyxHQUFFRixDQUFDLENBQUNFLENBQUQsQ0FBSSxLQUFJRCxDQUFDLENBQUNDLENBQUQsQ0FBSSxFQUE5QyxDQUp3RixDQUl2Qzs7O0FBQ2pELFNBQU87QUFDSEssSUFBQUEsT0FBTyxFQUFFUixLQUFLLENBQUNTLEdBQU4sQ0FBVUosV0FBVixFQUF1QkssSUFBdkIs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QjtBQUNBOEUsTUFBQUEsSUFBSSxHQUFJO0FBQ3BCLDZCQUE2QmIsVUFBVztBQUN4QyxrQkFBa0JXLGFBQWM7QUFDaEMsb0NBQW9DSSxPQUFPLENBQUN0RSxHQUFSLENBQVlILENBQUMsSUFBSUEsQ0FBQyxDQUFDRSxPQUFuQixFQUE0QkUsSUFBNUIsQ0FBaUMsSUFBakMsQ0FBdUM7QUFDM0UsMEJBQTBCcUUsT0FBTyxDQUFDdEUsR0FBUixDQUFZSCxDQUFDLElBQUlBLENBQUMsQ0FBQ0ssTUFBbkIsRUFBMkJELElBQTNCLENBQWdDLElBQWhDLENBQXNDLEdBSnBEO0FBS0g7O0FBQ0QsV0FBTztBQUNIbUUsTUFBQUEsSUFERztBQUVIRCxNQUFBQTtBQUZHLEtBQVA7QUFJSDs7QUFFRCxTQUFPSSxjQUFQLENBQXNCQyxPQUF0QixFQUF3Q0wsT0FBeEMsRUFBNkU7QUFDekUsV0FBT0EsT0FBTyxDQUFDbkUsR0FBUixDQUFZLENBQUN5RSxNQUFELEVBQVMvRSxDQUFULEtBQWU7QUFDOUIsWUFBTWlDLE1BQU0sR0FBRzZDLE9BQU8sQ0FBQ3hFLEdBQVIsQ0FBWUgsQ0FBQyxJQUFJQSxDQUFDLENBQUNILENBQUQsQ0FBbEIsRUFBdUJzRSxNQUF2QixDQUE4Qm5FLENBQUMsSUFBSUEsQ0FBQyxLQUFLdUMsU0FBTixJQUFtQnZDLENBQUMsS0FBSyxJQUE1RCxDQUFmO0FBQ0EsYUFBTzRFLE1BQU0sQ0FBQ1osYUFBUCxDQUFxQlksTUFBTSxDQUFDbkYsT0FBNUIsRUFBcUNxQyxNQUFyQyxDQUFQO0FBQ0gsS0FITSxDQUFQO0FBS0g7O0FBcEdpQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB0eXBlIHsgU2NhbGFyRmllbGQgfSBmcm9tICcuLi9maWx0ZXIvZmlsdGVycyc7XG5pbXBvcnQgeyBzY2FsYXJGaWVsZHMgfSBmcm9tICcuLi9ncmFwaHFsL3Jlc29sdmVycy1nZW5lcmF0ZWQnO1xuXG5kZWNsYXJlIGZ1bmN0aW9uIEJpZ0ludCh2YWx1ZTogYW55KTogYW55O1xuXG5leHBvcnQgY29uc3QgQWdncmVnYXRpb25GbiA9IHtcbiAgICBDT1VOVDogJ0NPVU5UJyxcbiAgICBNSU46ICdNSU4nLFxuICAgIE1BWDogJ01BWCcsXG4gICAgU1VNOiAnU1VNJyxcbiAgICBBVkVSQUdFOiAnQVZFUkFHRScsXG59XG5cbmV4cG9ydCB0eXBlIEFnZ3JlZ2F0aW9uRm5UeXBlID0gJEtleXM8dHlwZW9mIEFnZ3JlZ2F0aW9uRm4+O1xuXG5leHBvcnQgdHlwZSBGaWVsZEFnZ3JlZ2F0aW9uID0ge1xuICAgIGZpZWxkOiBzdHJpbmcsXG4gICAgZm46IEFnZ3JlZ2F0aW9uRm5UeXBlLFxufVxuXG50eXBlIEFnZ3JlZ2F0aW9uQ29udGV4dCA9IHtcbiAgICBpbmRleDogbnVtYmVyLFxuICAgIGZpZWxkOiBTY2FsYXJGaWVsZCxcbiAgICBmbjogQWdncmVnYXRpb25GblR5cGUsXG4gICAgYmlnSW50UHJlZml4OiBudW1iZXIsXG4gICAgaXNBcnJheTogYm9vbGVhbixcbn1cblxudHlwZSBBZ2dyZWdhdGlvblF1ZXJ5UGFydHMgPSB7XG4gICAgY29sbGVjdDogc3RyaW5nLFxuICAgIHJlc3VsdDogc3RyaW5nLFxufVxuXG5leHBvcnQgdHlwZSBBZ2dyZWdhdGlvbkhlbHBlciA9IHtcbiAgICBjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsXG4gICAgYnVpbGRRdWVyeTogKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCkgPT4gQWdncmVnYXRpb25RdWVyeVBhcnRzLFxuICAgIGNvbnZlcnRSZXN1bHQ6IChjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlOiBhbnkpID0+IGFueSxcbn1cblxuLy8gUXVlcnkgQnVpbGRlcnNcblxuLyoqXG4gKiBSZXR1cm5zIHF1ZXJ5IHBhcnRzIGluIGZvcm0gb2Y6XG4gKiB7IGNvbGxlY3Q6ICdhPGk+ID0gPGV4cHJzMD4nLCByZXN1bHQ6ICdhPGk+J30gaWYgZXhwcnMubGVuZ3RoID09PSAxXG4gKiBvclxuICogeyBjb2xsZWN0OiAnYTxpPiA9IDxleHByczA+LCBiPGk+ID0gPGV4cHJzMT4sIC4uJy4sIHJlc3VsdDogJ3sgYTogYTxpPiwgYjogYjxpPiwgLi4uIH0nfVxuICogaWYgZXhwcnMubGVuZ3RoID4gMVxuICpcbiAqIEBwYXJhbSBleHByc1xuICogQHBhcmFtIGNvbnRleHRcbiAqIEByZXR1cm4ge3tyZXN1bHQ6IHN0cmluZywgY29sbGVjdHM6IHN0cmluZ319XG4gKi9cbmZ1bmN0aW9uIHF1ZXJ5UGFydHMoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCAuLi5leHByczogc3RyaW5nW10pOiBBZ2dyZWdhdGlvblF1ZXJ5UGFydHMge1xuICAgIGNvbnN0IG4gPSAnYWJjZGVmJztcbiAgICBjb25zdCB2ID0gKGkpID0+IGAke25baV19JHtjb250ZXh0LmluZGV4fWA7IC8vICdhMCcgfCAnYjAnIHwgLi4uXG4gICAgY29uc3QgY29sbGVjdEV4cHIgPSAoeCwgaSkgPT4gYCR7dihpKX0gPSAke3h9YDsgLy8gJ2EwID0gZXhwclswXScgfCAnYjAgPSBleHByWzFdJyB8IC4uLlxuICAgIGNvbnN0IHJldHVybkV4cHIgPSAoeCwgaSkgPT4gYCR7bltpXX06ICR7dihpKX1gOyAvLyAnYTogYTAnIHwgJ2I6IGIwJyB8IC4uLlxuICAgIHJldHVybiB7XG4gICAgICAgIGNvbGxlY3Q6IGV4cHJzLm1hcChjb2xsZWN0RXhwcikuam9pbignLCAnKSwgLy8gJ2EwID0gZXhwclswXSwgYjAgPSBleHByWzFdLCAuLi4nXG4gICAgICAgIHJlc3VsdDogZXhwcnMubGVuZ3RoID09PSAxXG4gICAgICAgICAgICA/IGAke3YoMCl9YCAvLyAnYTAnXG4gICAgICAgICAgICA6IGB7ICR7ZXhwcnMubWFwKHJldHVybkV4cHIpLmpvaW4oJywgJyl9IH1gLCAvLyAneyBhOiBhMCwgYjogYjAsIC4uLiB9J1xuICAgIH1cbn1cblxuY29uc3QgY291bnRGaWVsZDogU2NhbGFyRmllbGQgPSB7XG4gICAgdHlwZTogJ3N0cmluZycsXG4gICAgcGF0aDogJycsXG59O1xuXG5mdW5jdGlvbiBjb3VudChjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQpOiBBZ2dyZWdhdGlvblF1ZXJ5UGFydHMge1xuICAgIHJldHVybiBxdWVyeVBhcnRzKGNvbnRleHQsICdDT1VOVChkb2MpJyk7XG59XG5cbmZ1bmN0aW9uIHNpbXBsZShjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQpOiBBZ2dyZWdhdGlvblF1ZXJ5UGFydHMge1xuICAgIGNvbnN0IGZuID0gY29udGV4dC5mbjtcbiAgICByZXR1cm4gcXVlcnlQYXJ0cyhjb250ZXh0LCBjb250ZXh0LmlzQXJyYXlcbiAgICAgICAgPyBgJHtmbn0oJHtmbn0oJHtjb250ZXh0LmZpZWxkLnBhdGh9KSlgXG4gICAgICAgIDogYCR7Zm59KCR7Y29udGV4dC5maWVsZC5wYXRofSlgLFxuICAgICk7XG59XG5cbmZ1bmN0aW9uIGJpZ0ludFRvTnVtKGhleDogYW55KTogc3RyaW5nIHtcbiAgICByZXR1cm4gYFRPX05VTUJFUihDT05DQVQoXCIweFwiLCAke2hleH0pKWBcbn1cblxuZnVuY3Rpb24gbmVnQmlnSW50VG9OdW0oaGV4OiBhbnkpOiBzdHJpbmcge1xuICAgIHJldHVybiBgLShFWFAyKExFTkdUSCgke2hleH0pICogNCkgLSAxIC0gJHtiaWdJbnRUb051bShoZXgpfSlgXG59XG5cbmZ1bmN0aW9uIGJpZ0ludEhpUGFydChwYXRoOiBzdHJpbmcsIHByZWZpeDogbnVtYmVyKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYFNVQlNUUklORygke3BhdGh9LCAke3ByZWZpeH0sIExFTkdUSCgke3BhdGh9KSAtICR7cHJlZml4ICsgOH0pYDtcbn1cblxuZnVuY3Rpb24gYmlnSW50TG9QYXJ0KHBhdGg6IHN0cmluZywgcHJlZml4OiBudW1iZXIpOiBzdHJpbmcge1xuICAgIHJldHVybiBgUklHSFQoU1VCU1RSSU5HKCR7cGF0aH0sICR7cHJlZml4fSksIDgpYDtcbn1cblxuZnVuY3Rpb24gc2lnbmVkQmlnSW50UGFydChwYXRoOiBzdHJpbmcsIHByZWZpeDogbnVtYmVyLCBwYXJ0OiAocGF0aDogc3RyaW5nLCBwcmVmaXg6IG51bWJlcikgPT4gc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYFNVQlNUUklORygke3BhdGh9LCAwLCAxKSA9PSBcIi1cIlxuICAgID8gJHtuZWdCaWdJbnRUb051bShwYXJ0KHBhdGgsIHByZWZpeCArIDEpKX1cbiAgICA6ICR7YmlnSW50VG9OdW0ocGFydChwYXRoLCBwcmVmaXgpKX1gO1xufVxuXG5mdW5jdGlvbiBzaWduZWRCaWdJbnRIaVBhcnQocGF0aDogc3RyaW5nLCBwcmVmaXg6IG51bWJlcik6IHN0cmluZyB7XG4gICAgcmV0dXJuIHNpZ25lZEJpZ0ludFBhcnQocGF0aCwgcHJlZml4LCBiaWdJbnRIaVBhcnQpO1xufVxuXG5mdW5jdGlvbiBzaWduZWRCaWdJbnRMb1BhcnQocGF0aDogc3RyaW5nLCBwcmVmaXg6IG51bWJlcik6IHN0cmluZyB7XG4gICAgcmV0dXJuIHNpZ25lZEJpZ0ludFBhcnQocGF0aCwgcHJlZml4LCBiaWdJbnRMb1BhcnQpO1xufVxuXG5mdW5jdGlvbiBiaWdJbnRTdW1FeHByKHBhcnQ6IChwYXRoOiBzdHJpbmcsIHByZWZpeDogbnVtYmVyKSA9PiBzdHJpbmcsIGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCkge1xuICAgIGNvbnN0IHBhdGggPSBjb250ZXh0LmZpZWxkLnBhdGg7XG4gICAgY29uc3QgcHJlZml4ID0gY29udGV4dC5iaWdJbnRQcmVmaXg7XG4gICAgcmV0dXJuIGNvbnRleHQuaXNBcnJheVxuICAgICAgICA/IGBTVU0oU1VNKCgke3BhdGh9KVsqIFJFVFVSTiAke3BhcnQoJ0NVUlJFTlQnLCBwcmVmaXgpfV0pKWBcbiAgICAgICAgOiBgU1VNKCR7cGFydChwYXRoLCBwcmVmaXgpfSlgO1xufVxuXG5mdW5jdGlvbiBiaWdJbnRTdW0oY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0KTogQWdncmVnYXRpb25RdWVyeVBhcnRzIHtcbiAgICByZXR1cm4gcXVlcnlQYXJ0cyhcbiAgICAgICAgY29udGV4dCxcbiAgICAgICAgYmlnSW50U3VtRXhwcihzaWduZWRCaWdJbnRIaVBhcnQsIGNvbnRleHQpLFxuICAgICAgICBiaWdJbnRTdW1FeHByKHNpZ25lZEJpZ0ludExvUGFydCwgY29udGV4dCksXG4gICAgKTtcbn1cblxuZnVuY3Rpb24gYmlnSW50QXZnKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCk6IEFnZ3JlZ2F0aW9uUXVlcnlQYXJ0cyB7XG4gICAgcmV0dXJuIHF1ZXJ5UGFydHMoXG4gICAgICAgIGNvbnRleHQsXG4gICAgICAgIGJpZ0ludFN1bUV4cHIoc2lnbmVkQmlnSW50SGlQYXJ0LCBjb250ZXh0KSxcbiAgICAgICAgYmlnSW50U3VtRXhwcihzaWduZWRCaWdJbnRMb1BhcnQsIGNvbnRleHQpLFxuICAgICAgICBjb250ZXh0LmlzQXJyYXlcbiAgICAgICAgICAgID8gYFNVTShDT1VOVCgke2NvbnRleHQuZmllbGQucGF0aH0pKWBcbiAgICAgICAgICAgIDogYENPVU5UKGRvYylgLFxuICAgICk7XG59XG5cbi8vIENvbnZlcnRlcnNcblxuZnVuY3Rpb24gcmVkdWNlKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgdmFsdWVzOiBhbnlbXSwgZm46IEFnZ3JlZ2F0aW9uRm5UeXBlKTogYW55IHtcbiAgICBsZXQgcmVkdWNlZCA9IHZhbHVlc1swXTtcbiAgICBmb3IgKGxldCBpID0gMTsgaSA8IHZhbHVlcy5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IHZhbHVlc1tpXTtcbiAgICAgICAgaWYgKGZuID09PSAnTUlOJykge1xuICAgICAgICAgICAgaWYgKHZhbHVlIDwgcmVkdWNlZCkge1xuICAgICAgICAgICAgICAgIHJlZHVjZWQgPSB2YWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChmbiA9PT0gJ01BWCcpIHtcbiAgICAgICAgICAgIGlmICh2YWx1ZSA+IHJlZHVjZWQpIHtcbiAgICAgICAgICAgICAgICByZWR1Y2VkID0gdmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZWR1Y2VkICs9IHZhbHVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChmbiA9PT0gJ0FWRVJBR0UnKSB7XG4gICAgICAgIGlmIChjb250ZXh0LmJpZ0ludFByZWZpeCA+IDApIHtcbiAgICAgICAgICAgIHJlZHVjZWQgPSByZWR1Y2VkIC8gQmlnSW50KHZhbHVlcy5sZW5ndGgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVkdWNlZCA9IE1hdGgudHJ1bmMocmVkdWNlZCAvIHZhbHVlcy5sZW5ndGgpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZWR1Y2VkO1xufVxuXG5mdW5jdGlvbiByZWR1Y2VyKFxuICAgIGNvbnZlcnQ6IChjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlOiBhbnkpID0+IGFueSxcbiAgICBjb252ZXJ0QmFjazogKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgdmFsdWU6IGFueSkgPT4gYW55LFxuICAgIGZuOiBBZ2dyZWdhdGlvbkZuVHlwZSxcbik6IChjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlczogYW55W10pID0+IGFueSB7XG4gICAgcmV0dXJuIChjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlczogYW55W10pID0+IHtcbiAgICAgICAgaWYgKHZhbHVlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHJlZHVjZWQgPSByZWR1Y2UoY29udGV4dCwgdmFsdWVzLm1hcCh4ID0+IGNvbnZlcnQoY29udGV4dCwgeCkpLCBmbik7XG4gICAgICAgIHJldHVybiBjb252ZXJ0QmFjayhjb250ZXh0LCByZWR1Y2VkKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIG5vQ29udmVyc2lvbihjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHgpIHtcbiAgICByZXR1cm4geDtcbn1cblxuZnVuY3Rpb24gYmlnSW50U3RyaW5nVG9EZWNpbWFsU3RyaW5nKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgdmFsdWU6IGFueSk6IGFueSB7XG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlLnRvU3RyaW5nKCk7XG4gICAgfVxuICAgIC8vJEZsb3dGaXhNZVxuICAgIHJldHVybiB2YWx1ZS5zdWJzdHIoMCwgMSkgPT09IFwiLVwiXG4gICAgICAgID8gQmlnSW50KGAtMHgke3ZhbHVlLnN1YnN0cihjb250ZXh0LmJpZ0ludFByZWZpeCArIDEpfWApLnRvU3RyaW5nKClcbiAgICAgICAgOiBCaWdJbnQoYDB4JHt2YWx1ZS5zdWJzdHIoY29udGV4dC5iaWdJbnRQcmVmaXgpfWApLnRvU3RyaW5nKCk7XG59XG5cbi8vJEZsb3dGaXhNZVxuZnVuY3Rpb24gYmlnSW50UGFydHNUb0JpZ0ludChjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHBhcnRzOiB7IGE6IG51bWJlciwgYjogbnVtYmVyIH0pOiBCaWdJbnQge1xuICAgIGNvbnN0IGggPSBwYXJ0cy5hID49IDBcbiAgICAgICAgPyBCaWdJbnQoYDB4JHtNYXRoLnJvdW5kKHBhcnRzLmEpLnRvU3RyaW5nKDE2KX0wMDAwMDAwMGApXG4gICAgICAgIDogLUJpZ0ludChgMHgke01hdGgucm91bmQoTWF0aC5hYnMocGFydHMuYSkpLnRvU3RyaW5nKDE2KX0wMDAwMDAwMGApO1xuICAgIGNvbnN0IGwgPSBCaWdJbnQoTWF0aC5yb3VuZChwYXJ0cy5iKSk7XG4gICAgcmV0dXJuIGggKyBsO1xufVxuXG5mdW5jdGlvbiB0b1N0cmluZyhjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlOiBhbnkpOiBhbnkge1xuICAgIHJldHVybiB2YWx1ZS50b1N0cmluZygpO1xufVxuXG5mdW5jdGlvbiBiaWdJbnRQYXJ0c1RvQmlnSW50QXZnKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgdmFsdWU6IGFueSk6IGFueSB7XG4gICAgY29uc3Qgc3VtID0gYmlnSW50UGFydHNUb0JpZ0ludChjb250ZXh0LCB2YWx1ZSk7XG4gICAgY29uc3QgY291bnQgPSBOdW1iZXIodmFsdWUuYyB8fCAwKTtcbiAgICByZXR1cm4gY291bnQgPiAwID8gKHN1bSAvIEJpZ0ludChNYXRoLnJvdW5kKGNvdW50KSkpIDogc3VtO1xufVxuXG5leHBvcnQgY2xhc3MgQWdncmVnYXRpb25IZWxwZXJGYWN0b3J5IHtcbiAgICBzdGF0aWMgY3JlYXRlKGNvbGxlY3Rpb246IHN0cmluZywgaW5kZXg6IG51bWJlciwgYWdncmVnYXRpb246IEZpZWxkQWdncmVnYXRpb24pOiBBZ2dyZWdhdGlvbkhlbHBlciB7XG4gICAgICAgIGNvbnN0IGZpZWxkID0gc2NhbGFyRmllbGRzLmdldChgJHtjb2xsZWN0aW9ufS4ke2FnZ3JlZ2F0aW9uLmZpZWxkIHx8ICdpZCd9YCkgfHwgY291bnRGaWVsZDtcbiAgICAgICAgY29uc3QgZm4gPSBhZ2dyZWdhdGlvbi5mbiB8fCBBZ2dyZWdhdGlvbkZuLkNPVU5UO1xuICAgICAgICBjb25zdCBjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQgPSB7XG4gICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgIGZpZWxkLFxuICAgICAgICAgICAgZm4sXG4gICAgICAgICAgICBiaWdJbnRQcmVmaXg6IChmaWVsZC50eXBlID09PSAndWludDEwMjQnKSA/IDIgOiAoZmllbGQudHlwZSA9PT0gJ3VpbnQ2NCcgPyAxIDogMCksXG4gICAgICAgICAgICBpc0FycmF5OiBmaWVsZC5wYXRoLmluY2x1ZGVzKCdbKl0nKSxcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBDYXNlIG9mIGNvdW50XG4gICAgICAgIGlmIChjb250ZXh0LmZuID09PSBBZ2dyZWdhdGlvbkZuLkNPVU5UKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgICAgYnVpbGRRdWVyeTogY291bnQsXG4gICAgICAgICAgICAgICAgY29udmVydFJlc3VsdDogKGNvbnRleHQsIHZhbHVlcykgPT4gcmVkdWNlKGNvbnRleHQsIHZhbHVlcywgJ1NVTScpLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb250ZXh0LmZpZWxkLnBhdGggPT09ICcnKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske2FnZ3JlZ2F0aW9uLmZpZWxkfV0gY2FuJ3QgYmUgYWdncmVnYXRlZGApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2FzZSBvZiBudW1iZXIgZmllbGRzIG9yIG1pbi9tYXggZm5cbiAgICAgICAgaWYgKGZpZWxkLnR5cGUgPT09ICdudW1iZXInIHx8IGZuID09PSBBZ2dyZWdhdGlvbkZuLk1JTiB8fCBmbiA9PT0gQWdncmVnYXRpb25Gbi5NQVgpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgICBidWlsZFF1ZXJ5OiBzaW1wbGUsXG4gICAgICAgICAgICAgICAgY29udmVydFJlc3VsdDogY29udGV4dC5iaWdJbnRQcmVmaXggPiAwXG4gICAgICAgICAgICAgICAgICAgIC8vIGJpZyBpbnRlZ2Vyc1xuICAgICAgICAgICAgICAgICAgICA/IHJlZHVjZXIobm9Db252ZXJzaW9uLCBiaWdJbnRTdHJpbmdUb0RlY2ltYWxTdHJpbmcsIGZuKVxuICAgICAgICAgICAgICAgICAgICAvLyBudW1iZXJzIGFuZCBzdHJpbmdzXG4gICAgICAgICAgICAgICAgICAgIDogcmVkdWNlcihub0NvbnZlcnNpb24sIG5vQ29udmVyc2lvbiwgZm4pLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb250ZXh0LmJpZ0ludFByZWZpeCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiAoY29udGV4dC5mbiA9PT0gQWdncmVnYXRpb25Gbi5BVkVSQUdFKVxuICAgICAgICAgICAgICAgID8geyAvLyBiaWcgaW50ZWdlciBhdmVyYWdlXG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgICAgICAgIGJ1aWxkUXVlcnk6IGJpZ0ludEF2ZyxcbiAgICAgICAgICAgICAgICAgICAgY29udmVydFJlc3VsdDogcmVkdWNlcihiaWdJbnRQYXJ0c1RvQmlnSW50QXZnLCB0b1N0cmluZywgZm4pLFxuICAgICAgICAgICAgICAgIH0gOiB7IC8vIGJpZyBpbnRlZ2VyIHN1bVxuICAgICAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICBidWlsZFF1ZXJ5OiBiaWdJbnRTdW0sXG4gICAgICAgICAgICAgICAgICAgIGNvbnZlcnRSZXN1bHQ6IHJlZHVjZXIoYmlnSW50UGFydHNUb0JpZ0ludCwgdG9TdHJpbmcsIGZuKSxcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgWyR7YWdncmVnYXRpb24uZmllbGR9XSBjYW4ndCBiZSB1c2VkIHdpdGggWyR7Zm59XWApO1xuICAgIH1cblxuICAgIHN0YXRpYyBjcmVhdGVRdWVyeShcbiAgICAgICAgY29sbGVjdGlvbjogc3RyaW5nLFxuICAgICAgICBmaWx0ZXI6IHN0cmluZyxcbiAgICAgICAgZmllbGRzOiBGaWVsZEFnZ3JlZ2F0aW9uW10sXG4gICAgKToge1xuICAgICAgICB0ZXh0OiBzdHJpbmcsXG4gICAgICAgIGhlbHBlcnM6IEFnZ3JlZ2F0aW9uSGVscGVyW10sXG4gICAgfSB7XG4gICAgICAgIGNvbnN0IGZpbHRlclNlY3Rpb24gPSBmaWx0ZXIgPyBgRklMVEVSICR7ZmlsdGVyfWAgOiAnJztcbiAgICAgICAgY29uc3QgaGVscGVyczogQWdncmVnYXRpb25IZWxwZXJbXSA9IGZpZWxkcy5tYXAoKGFnZ3JlZ2F0aW9uLCBpKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gQWdncmVnYXRpb25IZWxwZXJGYWN0b3J5LmNyZWF0ZShjb2xsZWN0aW9uLCBpLCBhZ2dyZWdhdGlvbik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCB0ZXh0O1xuICAgICAgICBjb25zdCBpc1NpbmdsZUNvdW50ID0gKGZpZWxkcy5sZW5ndGggPT09IDEpICYmIChmaWVsZHNbMF0uZm4gPT09IEFnZ3JlZ2F0aW9uRm4uQ09VTlQpO1xuICAgICAgICBpZiAoaXNTaW5nbGVDb3VudCkge1xuICAgICAgICAgICAgaWYgKGZpbHRlclNlY3Rpb24gIT09ICcnKSB7XG4gICAgICAgICAgICAgICAgdGV4dCA9IGBcbiAgICAgICAgICAgICAgICAgICAgRk9SIGRvYyBJTiAke2NvbGxlY3Rpb259XG4gICAgICAgICAgICAgICAgICAgICR7ZmlsdGVyU2VjdGlvbn1cbiAgICAgICAgICAgICAgICAgICAgQ09MTEVDVCBXSVRIIENPVU5UIElOVE8gYTBcbiAgICAgICAgICAgICAgICAgICAgUkVUVVJOIFthMF1gO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0ZXh0ID0gYFJFVFVSTiBbTEVOR1RIKCR7Y29sbGVjdGlvbn0pXWA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBxdWVyaWVzID0gaGVscGVycy5tYXAoeCA9PiB4LmJ1aWxkUXVlcnkoeC5jb250ZXh0KSk7XG4gICAgICAgICAgICB0ZXh0ID0gYFxuICAgICAgICAgICAgICAgIEZPUiBkb2MgSU4gJHtjb2xsZWN0aW9ufVxuICAgICAgICAgICAgICAgICR7ZmlsdGVyU2VjdGlvbn1cbiAgICAgICAgICAgICAgICBDT0xMRUNUIEFHR1JFR0FURSAke3F1ZXJpZXMubWFwKHggPT4geC5jb2xsZWN0KS5qb2luKCcsICcpfVxuICAgICAgICAgICAgICAgIFJFVFVSTiBbJHtxdWVyaWVzLm1hcCh4ID0+IHgucmVzdWx0KS5qb2luKCcsICcpfV1gO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0ZXh0LFxuICAgICAgICAgICAgaGVscGVycyxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBzdGF0aWMgY29udmVydFJlc3VsdHMocmVzdWx0czogYW55W11bXSwgaGVscGVyczogQWdncmVnYXRpb25IZWxwZXJbXSk6IGFueVtdIHtcbiAgICAgICAgcmV0dXJuIGhlbHBlcnMubWFwKChoZWxwZXIsIGkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlcyA9IHJlc3VsdHMubWFwKHggPT4geFtpXSkuZmlsdGVyKHggPT4geCAhPT0gdW5kZWZpbmVkICYmIHggIT09IG51bGwpO1xuICAgICAgICAgICAgcmV0dXJuIGhlbHBlci5jb252ZXJ0UmVzdWx0KGhlbHBlci5jb250ZXh0LCB2YWx1ZXMpO1xuICAgICAgICB9KTtcblxuICAgIH1cbn1cblxuIl19