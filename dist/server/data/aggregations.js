"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.AggregationHelperFactory = exports.AggregationFn = void 0;

var _resolversGenerated = require("../graphql/resolvers-generated");

const AggregationFn = {
  COUNT: 'COUNT',
  MIN: 'MIN',
  MAX: 'MAX',
  SUM: 'SUM',
  AVERAGE: 'AVERAGE'
};
exports.AggregationFn = AggregationFn;

// Query Builders

/**
 * Returns query parts in form of:
 * { collect: 'a<i> = <exprs0>', result: 'a<i>'} if exprs.length === 1
 * or
 * { collect: 'a<i> = <exprs0>, b<i> = <exprs1>, ..'., result: '{ a: a<i>, b: b<i>, ... }'}
 * if exprs.length > 1
 *
 * @param exprs
 * @param context
 * @return {{result: string, collects: string}}
 */
function queryParts(context, ...exprs) {
  const n = 'abcdef';

  const v = i => `${n[i]}${context.index}`; // 'a0' | 'b0' | ...


  const collectExpr = (x, i) => `${v(i)} = ${x}`; // 'a0 = expr[0]' | 'b0 = expr[1]' | ...


  const returnExpr = (x, i) => `${n[i]}: ${v(i)}`; // 'a: a0' | 'b: b0' | ...


  return {
    collect: exprs.map(collectExpr).join(', '),
    // 'a0 = expr[0], b0 = expr[1], ...'
    result: exprs.length === 1 ? `${v(0)}` // 'a0'
    : `{ ${exprs.map(returnExpr).join(', ')} }` // '{ a: a0, b: b0, ... }'

  };
}

const countField = {
  type: 'string',
  path: ''
};

function count(context) {
  return queryParts(context, 'COUNT(doc)');
}

function simple(context) {
  const fn = context.fn;
  return queryParts(context, context.isArray ? `${fn}(${fn}(${context.field.path}))` : `${fn}(${context.field.path})`);
}

function bigIntToNum(hex) {
  return `TO_NUMBER(CONCAT("0x", ${hex}))`;
}

function bigIntHiPart(path, prefix) {
  return bigIntToNum(`SUBSTRING(${path}, ${prefix}, LENGTH(${path}) - ${prefix + 8})`);
}

function bigIntLoPart(path, prefix) {
  return bigIntToNum(`RIGHT(SUBSTRING(${path}, ${prefix}), 8)`);
}

function bigIntSumExpr(part, context) {
  const path = context.field.path;
  const prefix = context.bigIntPrefix;
  return context.isArray ? `SUM(SUM((${path})[* RETURN ${part('CURRENT', prefix)}]))` : `SUM(${part(path, prefix)})`;
}

function bigIntSum(context) {
  return queryParts(context, bigIntSumExpr(bigIntHiPart, context), bigIntSumExpr(bigIntLoPart, context));
}

function bigIntAvg(context) {
  return queryParts(context, bigIntSumExpr(bigIntHiPart, context), bigIntSumExpr(bigIntLoPart, context), context.isArray ? `SUM(COUNT(${context.field.path}))` : `COUNT(doc)`);
} // Converters


function reduce(context, values, fn) {
  let reduced = values[0];

  for (let i = 1; i < values.length; i += 1) {
    const value = values[i];

    if (fn === 'MIN') {
      if (value < reduced) {
        reduced = value;
      }
    } else if (fn === 'MAX') {
      if (value > reduced) {
        reduced = value;
      }
    } else {
      reduced += value;
    }
  }

  if (fn === 'AVERAGE') {
    if (context.bigIntPrefix > 0) {
      reduced = reduced / BigInt(values.length);
    } else {
      reduced = Math.trunc(reduced / values.length);
    }
  }

  return reduced;
}

function reducer(convert, convertBack, fn) {
  return (context, values) => {
    if (values.length === 0) {
      return undefined;
    }

    let reduced = reduce(context, values.map(x => convert(context, x)), fn);
    return convertBack(context, reduced);
  };
}

function noConversion(context, x) {
  return x;
}

function bigIntStringToDecimalString(context, value) {
  if (typeof value === 'number') {
    return value.toString();
  } //$FlowFixMe


  return BigInt(`0x${value.substr(context.bigIntPrefix)}`).toString();
} //$FlowFixMe


function bigIntPartsToBigInt(context, parts) {
  const h = BigInt(`0x${Math.round(parts.a).toString(16)}00000000`);
  const l = BigInt(Math.round(parts.b));
  return h + l;
}

function toString(context, value) {
  return value.toString();
}

function bigIntPartsToBigIntAvg(context, value) {
  const sum = bigIntPartsToBigInt(context, value);
  const count = Number(value.c || 0);
  return count > 0 ? sum / BigInt(Math.round(count)) : sum;
}

class AggregationHelperFactory {
  static create(collection, index, aggregation) {
    const field = _resolversGenerated.scalarFields.get(`${collection}.${aggregation.field || 'id'}`) || countField;
    const fn = aggregation.fn || AggregationFn.COUNT;
    const context = {
      index,
      field,
      fn,
      bigIntPrefix: field.type === 'uint1024' ? 2 : field.type === 'uint64' ? 1 : 0,
      isArray: field.path.includes('[*]')
    }; // Case of count

    if (context.fn === AggregationFn.COUNT) {
      return {
        context,
        buildQuery: count,
        convertResult: (context, values) => reduce(context, values, 'SUM')
      };
    }

    if (context.field.path === '') {
      throw new Error(`[${aggregation.field}] can't be aggregated`);
    } // Case of number fields or min/max fn


    if (field.type === 'number' || fn === AggregationFn.MIN || fn === AggregationFn.MAX) {
      return {
        context,
        buildQuery: simple,
        convertResult: context.bigIntPrefix > 0 // big integers
        ? reducer(noConversion, bigIntStringToDecimalString, fn) // numbers and strings
        : reducer(noConversion, noConversion, fn)
      };
    }

    if (context.bigIntPrefix > 0) {
      return context.fn === AggregationFn.AVERAGE ? {
        // big integer average
        context,
        buildQuery: bigIntAvg,
        convertResult: reducer(bigIntPartsToBigIntAvg, toString, fn)
      } : {
        // big integer sum
        context,
        buildQuery: bigIntSum,
        convertResult: reducer(bigIntPartsToBigInt, toString, fn)
      };
    }

    throw new Error(`[${aggregation.field}] can't be used with [${fn}]`);
  }

  static createQuery(collection, filter, fields) {
    const filterSection = filter ? `FILTER ${filter}` : '';
    const helpers = fields.map((aggregation, i) => {
      return AggregationHelperFactory.create(collection, i, aggregation);
    });
    let text;
    const isSingleCount = fields.length === 1 && fields[0].fn === AggregationFn.COUNT;

    if (isSingleCount) {
      if (filterSection !== '') {
        text = `
                    FOR doc IN ${collection}
                    ${filterSection}
                    COLLECT WITH COUNT INTO a0
                    RETURN [a0]`;
      } else {
        text = `RETURN [LENGTH(${collection})]`;
      }
    } else {
      const queries = helpers.map(x => x.buildQuery(x.context));
      text = `
                FOR doc IN ${collection}
                ${filterSection}
                COLLECT AGGREGATE ${queries.map(x => x.collect).join(', ')}
                RETURN [${queries.map(x => x.result).join(', ')}]`;
    }

    return {
      text,
      helpers
    };
  }

  static convertResults(results, helpers) {
    return helpers.map((helper, i) => {
      const values = results.map(x => x[i]).filter(x => x !== undefined && x !== null);
      return helper.convertResult(helper.context, values);
    });
  }

}

exports.AggregationHelperFactory = AggregationHelperFactory;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9hZ2dyZWdhdGlvbnMuanMiXSwibmFtZXMiOlsiQWdncmVnYXRpb25GbiIsIkNPVU5UIiwiTUlOIiwiTUFYIiwiU1VNIiwiQVZFUkFHRSIsInF1ZXJ5UGFydHMiLCJjb250ZXh0IiwiZXhwcnMiLCJuIiwidiIsImkiLCJpbmRleCIsImNvbGxlY3RFeHByIiwieCIsInJldHVybkV4cHIiLCJjb2xsZWN0IiwibWFwIiwiam9pbiIsInJlc3VsdCIsImxlbmd0aCIsImNvdW50RmllbGQiLCJ0eXBlIiwicGF0aCIsImNvdW50Iiwic2ltcGxlIiwiZm4iLCJpc0FycmF5IiwiZmllbGQiLCJiaWdJbnRUb051bSIsImhleCIsImJpZ0ludEhpUGFydCIsInByZWZpeCIsImJpZ0ludExvUGFydCIsImJpZ0ludFN1bUV4cHIiLCJwYXJ0IiwiYmlnSW50UHJlZml4IiwiYmlnSW50U3VtIiwiYmlnSW50QXZnIiwicmVkdWNlIiwidmFsdWVzIiwicmVkdWNlZCIsInZhbHVlIiwiQmlnSW50IiwiTWF0aCIsInRydW5jIiwicmVkdWNlciIsImNvbnZlcnQiLCJjb252ZXJ0QmFjayIsInVuZGVmaW5lZCIsIm5vQ29udmVyc2lvbiIsImJpZ0ludFN0cmluZ1RvRGVjaW1hbFN0cmluZyIsInRvU3RyaW5nIiwic3Vic3RyIiwiYmlnSW50UGFydHNUb0JpZ0ludCIsInBhcnRzIiwiaCIsInJvdW5kIiwiYSIsImwiLCJiIiwiYmlnSW50UGFydHNUb0JpZ0ludEF2ZyIsInN1bSIsIk51bWJlciIsImMiLCJBZ2dyZWdhdGlvbkhlbHBlckZhY3RvcnkiLCJjcmVhdGUiLCJjb2xsZWN0aW9uIiwiYWdncmVnYXRpb24iLCJzY2FsYXJGaWVsZHMiLCJnZXQiLCJpbmNsdWRlcyIsImJ1aWxkUXVlcnkiLCJjb252ZXJ0UmVzdWx0IiwiRXJyb3IiLCJjcmVhdGVRdWVyeSIsImZpbHRlciIsImZpZWxkcyIsImZpbHRlclNlY3Rpb24iLCJoZWxwZXJzIiwidGV4dCIsImlzU2luZ2xlQ291bnQiLCJxdWVyaWVzIiwiY29udmVydFJlc3VsdHMiLCJyZXN1bHRzIiwiaGVscGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBR0E7O0FBSU8sTUFBTUEsYUFBYSxHQUFHO0FBQ3pCQyxFQUFBQSxLQUFLLEVBQUUsT0FEa0I7QUFFekJDLEVBQUFBLEdBQUcsRUFBRSxLQUZvQjtBQUd6QkMsRUFBQUEsR0FBRyxFQUFFLEtBSG9CO0FBSXpCQyxFQUFBQSxHQUFHLEVBQUUsS0FKb0I7QUFLekJDLEVBQUFBLE9BQU8sRUFBRTtBQUxnQixDQUF0Qjs7O0FBa0NQOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTQyxVQUFULENBQW9CQyxPQUFwQixFQUFpRCxHQUFHQyxLQUFwRCxFQUE0RjtBQUN4RixRQUFNQyxDQUFDLEdBQUcsUUFBVjs7QUFDQSxRQUFNQyxDQUFDLEdBQUlDLENBQUQsSUFBUSxHQUFFRixDQUFDLENBQUNFLENBQUQsQ0FBSSxHQUFFSixPQUFPLENBQUNLLEtBQU0sRUFBekMsQ0FGd0YsQ0FFNUM7OztBQUM1QyxRQUFNQyxXQUFXLEdBQUcsQ0FBQ0MsQ0FBRCxFQUFJSCxDQUFKLEtBQVcsR0FBRUQsQ0FBQyxDQUFDQyxDQUFELENBQUksTUFBS0csQ0FBRSxFQUE3QyxDQUh3RixDQUd4Qzs7O0FBQ2hELFFBQU1DLFVBQVUsR0FBRyxDQUFDRCxDQUFELEVBQUlILENBQUosS0FBVyxHQUFFRixDQUFDLENBQUNFLENBQUQsQ0FBSSxLQUFJRCxDQUFDLENBQUNDLENBQUQsQ0FBSSxFQUE5QyxDQUp3RixDQUl2Qzs7O0FBQ2pELFNBQU87QUFDSEssSUFBQUEsT0FBTyxFQUFFUixLQUFLLENBQUNTLEdBQU4sQ0FBVUosV0FBVixFQUF1QkssSUFBdkIsQ0FBNEIsSUFBNUIsQ0FETjtBQUN5QztBQUM1Q0MsSUFBQUEsTUFBTSxFQUFFWCxLQUFLLENBQUNZLE1BQU4sS0FBaUIsQ0FBakIsR0FDRCxHQUFF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a0JBQWtCVyxhQUFjO0FBQ2hDLG9DQUFvQ0ksT0FBTyxDQUFDakUsR0FBUixDQUFZSCxDQUFDLElBQUlBLENBQUMsQ0FBQ0UsT0FBbkIsRUFBNEJFLElBQTVCLENBQWlDLElBQWpDLENBQXVDO0FBQzNFLDBCQUEwQmdFLE9BQU8sQ0FBQ2pFLEdBQVIsQ0FBWUgsQ0FBQyxJQUFJQSxDQUFDLENBQUNLLE1BQW5CLEVBQTJCRCxJQUEzQixDQUFnQyxJQUFoQyxDQUFzQyxHQUpwRDtBQUtIOztBQUNELFdBQU87QUFDSDhELE1BQUFBLElBREc7QUFFSEQsTUFBQUE7QUFGRyxLQUFQO0FBSUg7O0FBRUQsU0FBT0ksY0FBUCxDQUFzQkMsT0FBdEIsRUFBd0NMLE9BQXhDLEVBQTZFO0FBQ3pFLFdBQU9BLE9BQU8sQ0FBQzlELEdBQVIsQ0FBWSxDQUFDb0UsTUFBRCxFQUFTMUUsQ0FBVCxLQUFlO0FBQzlCLFlBQU02QixNQUFNLEdBQUc0QyxPQUFPLENBQUNuRSxHQUFSLENBQVlILENBQUMsSUFBSUEsQ0FBQyxDQUFDSCxDQUFELENBQWxCLEVBQXVCaUUsTUFBdkIsQ0FBOEI5RCxDQUFDLElBQUlBLENBQUMsS0FBS21DLFNBQU4sSUFBbUJuQyxDQUFDLEtBQUssSUFBNUQsQ0FBZjtBQUNBLGFBQU91RSxNQUFNLENBQUNaLGFBQVAsQ0FBcUJZLE1BQU0sQ0FBQzlFLE9BQTVCLEVBQXFDaUMsTUFBckMsQ0FBUDtBQUNILEtBSE0sQ0FBUDtBQUtIOztBQXBHaUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgdHlwZSB7IFNjYWxhckZpZWxkIH0gZnJvbSAnLi4vZmlsdGVyL2ZpbHRlcnMnO1xuaW1wb3J0IHsgc2NhbGFyRmllbGRzIH0gZnJvbSAnLi4vZ3JhcGhxbC9yZXNvbHZlcnMtZ2VuZXJhdGVkJztcblxuZGVjbGFyZSBmdW5jdGlvbiBCaWdJbnQodmFsdWU6IGFueSk6IGFueTtcblxuZXhwb3J0IGNvbnN0IEFnZ3JlZ2F0aW9uRm4gPSB7XG4gICAgQ09VTlQ6ICdDT1VOVCcsXG4gICAgTUlOOiAnTUlOJyxcbiAgICBNQVg6ICdNQVgnLFxuICAgIFNVTTogJ1NVTScsXG4gICAgQVZFUkFHRTogJ0FWRVJBR0UnLFxufVxuXG5leHBvcnQgdHlwZSBBZ2dyZWdhdGlvbkZuVHlwZSA9ICRLZXlzPHR5cGVvZiBBZ2dyZWdhdGlvbkZuPjtcblxuZXhwb3J0IHR5cGUgRmllbGRBZ2dyZWdhdGlvbiA9IHtcbiAgICBmaWVsZDogc3RyaW5nLFxuICAgIGZuOiBBZ2dyZWdhdGlvbkZuVHlwZSxcbn1cblxudHlwZSBBZ2dyZWdhdGlvbkNvbnRleHQgPSB7XG4gICAgaW5kZXg6IG51bWJlcixcbiAgICBmaWVsZDogU2NhbGFyRmllbGQsXG4gICAgZm46IEFnZ3JlZ2F0aW9uRm5UeXBlLFxuICAgIGJpZ0ludFByZWZpeDogbnVtYmVyLFxuICAgIGlzQXJyYXk6IGJvb2xlYW4sXG59XG5cbnR5cGUgQWdncmVnYXRpb25RdWVyeVBhcnRzID0ge1xuICAgIGNvbGxlY3Q6IHN0cmluZyxcbiAgICByZXN1bHQ6IHN0cmluZyxcbn1cblxuZXhwb3J0IHR5cGUgQWdncmVnYXRpb25IZWxwZXIgPSB7XG4gICAgY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LFxuICAgIGJ1aWxkUXVlcnk6IChjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQpID0+IEFnZ3JlZ2F0aW9uUXVlcnlQYXJ0cyxcbiAgICBjb252ZXJ0UmVzdWx0OiAoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZTogYW55KSA9PiBhbnksXG59XG5cbi8vIFF1ZXJ5IEJ1aWxkZXJzXG5cbi8qKlxuICogUmV0dXJucyBxdWVyeSBwYXJ0cyBpbiBmb3JtIG9mOlxuICogeyBjb2xsZWN0OiAnYTxpPiA9IDxleHByczA+JywgcmVzdWx0OiAnYTxpPid9IGlmIGV4cHJzLmxlbmd0aCA9PT0gMVxuICogb3JcbiAqIHsgY29sbGVjdDogJ2E8aT4gPSA8ZXhwcnMwPiwgYjxpPiA9IDxleHByczE+LCAuLicuLCByZXN1bHQ6ICd7IGE6IGE8aT4sIGI6IGI8aT4sIC4uLiB9J31cbiAqIGlmIGV4cHJzLmxlbmd0aCA+IDFcbiAqXG4gKiBAcGFyYW0gZXhwcnNcbiAqIEBwYXJhbSBjb250ZXh0XG4gKiBAcmV0dXJuIHt7cmVzdWx0OiBzdHJpbmcsIGNvbGxlY3RzOiBzdHJpbmd9fVxuICovXG5mdW5jdGlvbiBxdWVyeVBhcnRzKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgLi4uZXhwcnM6IHN0cmluZ1tdKTogQWdncmVnYXRpb25RdWVyeVBhcnRzIHtcbiAgICBjb25zdCBuID0gJ2FiY2RlZic7XG4gICAgY29uc3QgdiA9IChpKSA9PiBgJHtuW2ldfSR7Y29udGV4dC5pbmRleH1gOyAvLyAnYTAnIHwgJ2IwJyB8IC4uLlxuICAgIGNvbnN0IGNvbGxlY3RFeHByID0gKHgsIGkpID0+IGAke3YoaSl9ID0gJHt4fWA7IC8vICdhMCA9IGV4cHJbMF0nIHwgJ2IwID0gZXhwclsxXScgfCAuLi5cbiAgICBjb25zdCByZXR1cm5FeHByID0gKHgsIGkpID0+IGAke25baV19OiAke3YoaSl9YDsgLy8gJ2E6IGEwJyB8ICdiOiBiMCcgfCAuLi5cbiAgICByZXR1cm4ge1xuICAgICAgICBjb2xsZWN0OiBleHBycy5tYXAoY29sbGVjdEV4cHIpLmpvaW4oJywgJyksIC8vICdhMCA9IGV4cHJbMF0sIGIwID0gZXhwclsxXSwgLi4uJ1xuICAgICAgICByZXN1bHQ6IGV4cHJzLmxlbmd0aCA9PT0gMVxuICAgICAgICAgICAgPyBgJHt2KDApfWAgLy8gJ2EwJ1xuICAgICAgICAgICAgOiBgeyAke2V4cHJzLm1hcChyZXR1cm5FeHByKS5qb2luKCcsICcpfSB9YCwgLy8gJ3sgYTogYTAsIGI6IGIwLCAuLi4gfSdcbiAgICB9XG59XG5cbmNvbnN0IGNvdW50RmllbGQ6IFNjYWxhckZpZWxkID0ge1xuICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgIHBhdGg6ICcnLFxufTtcblxuZnVuY3Rpb24gY291bnQoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0KTogQWdncmVnYXRpb25RdWVyeVBhcnRzIHtcbiAgICByZXR1cm4gcXVlcnlQYXJ0cyhjb250ZXh0LCAnQ09VTlQoZG9jKScpO1xufVxuXG5mdW5jdGlvbiBzaW1wbGUoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0KTogQWdncmVnYXRpb25RdWVyeVBhcnRzIHtcbiAgICBjb25zdCBmbiA9IGNvbnRleHQuZm47XG4gICAgcmV0dXJuIHF1ZXJ5UGFydHMoY29udGV4dCwgY29udGV4dC5pc0FycmF5XG4gICAgICAgID8gYCR7Zm59KCR7Zm59KCR7Y29udGV4dC5maWVsZC5wYXRofSkpYFxuICAgICAgICA6IGAke2ZufSgke2NvbnRleHQuZmllbGQucGF0aH0pYCxcbiAgICApO1xufVxuXG5mdW5jdGlvbiBiaWdJbnRUb051bShoZXg6IGFueSk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBUT19OVU1CRVIoQ09OQ0FUKFwiMHhcIiwgJHsoaGV4OiBhbnkpfSkpYFxufVxuXG5mdW5jdGlvbiBiaWdJbnRIaVBhcnQocGF0aDogc3RyaW5nLCBwcmVmaXg6IG51bWJlcik6IHN0cmluZyB7XG4gICAgcmV0dXJuIGJpZ0ludFRvTnVtKGBTVUJTVFJJTkcoJHtwYXRofSwgJHtwcmVmaXh9LCBMRU5HVEgoJHtwYXRofSkgLSAke3ByZWZpeCArIDh9KWApO1xufVxuXG5mdW5jdGlvbiBiaWdJbnRMb1BhcnQocGF0aDogc3RyaW5nLCBwcmVmaXg6IG51bWJlcik6IHN0cmluZyB7XG4gICAgcmV0dXJuIGJpZ0ludFRvTnVtKGBSSUdIVChTVUJTVFJJTkcoJHtwYXRofSwgJHtwcmVmaXh9KSwgOClgKTtcbn1cblxuZnVuY3Rpb24gYmlnSW50U3VtRXhwcihwYXJ0OiAocGF0aDogc3RyaW5nLCBwcmVmaXg6IG51bWJlcikgPT4gc3RyaW5nLCBjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQpIHtcbiAgICBjb25zdCBwYXRoID0gY29udGV4dC5maWVsZC5wYXRoO1xuICAgIGNvbnN0IHByZWZpeCA9IGNvbnRleHQuYmlnSW50UHJlZml4O1xuICAgIHJldHVybiBjb250ZXh0LmlzQXJyYXlcbiAgICAgICAgPyBgU1VNKFNVTSgoJHtwYXRofSlbKiBSRVRVUk4gJHtwYXJ0KCdDVVJSRU5UJywgcHJlZml4KX1dKSlgXG4gICAgICAgIDogYFNVTSgke3BhcnQocGF0aCwgcHJlZml4KX0pYDtcbn1cblxuZnVuY3Rpb24gYmlnSW50U3VtKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCk6IEFnZ3JlZ2F0aW9uUXVlcnlQYXJ0cyB7XG4gICAgcmV0dXJuIHF1ZXJ5UGFydHMoXG4gICAgICAgIGNvbnRleHQsXG4gICAgICAgIGJpZ0ludFN1bUV4cHIoYmlnSW50SGlQYXJ0LCBjb250ZXh0KSxcbiAgICAgICAgYmlnSW50U3VtRXhwcihiaWdJbnRMb1BhcnQsIGNvbnRleHQpLFxuICAgICk7XG59XG5cbmZ1bmN0aW9uIGJpZ0ludEF2Zyhjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQpOiBBZ2dyZWdhdGlvblF1ZXJ5UGFydHMge1xuICAgIHJldHVybiBxdWVyeVBhcnRzKFxuICAgICAgICBjb250ZXh0LFxuICAgICAgICBiaWdJbnRTdW1FeHByKGJpZ0ludEhpUGFydCwgY29udGV4dCksXG4gICAgICAgIGJpZ0ludFN1bUV4cHIoYmlnSW50TG9QYXJ0LCBjb250ZXh0KSxcbiAgICAgICAgY29udGV4dC5pc0FycmF5XG4gICAgICAgICAgICA/IGBTVU0oQ09VTlQoJHtjb250ZXh0LmZpZWxkLnBhdGh9KSlgXG4gICAgICAgICAgICA6IGBDT1VOVChkb2MpYCxcbiAgICApO1xufVxuXG4vLyBDb252ZXJ0ZXJzXG5cbmZ1bmN0aW9uIHJlZHVjZShjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlczogYW55W10sIGZuOiBBZ2dyZWdhdGlvbkZuVHlwZSk6IGFueSB7XG4gICAgbGV0IHJlZHVjZWQgPSB2YWx1ZXNbMF07XG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPCB2YWx1ZXMubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgY29uc3QgdmFsdWUgPSB2YWx1ZXNbaV07XG4gICAgICAgIGlmIChmbiA9PT0gJ01JTicpIHtcbiAgICAgICAgICAgIGlmICh2YWx1ZSA8IHJlZHVjZWQpIHtcbiAgICAgICAgICAgICAgICByZWR1Y2VkID0gdmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoZm4gPT09ICdNQVgnKSB7XG4gICAgICAgICAgICBpZiAodmFsdWUgPiByZWR1Y2VkKSB7XG4gICAgICAgICAgICAgICAgcmVkdWNlZCA9IHZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVkdWNlZCArPSB2YWx1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoZm4gPT09ICdBVkVSQUdFJykge1xuICAgICAgICBpZiAoY29udGV4dC5iaWdJbnRQcmVmaXggPiAwKSB7XG4gICAgICAgICAgICByZWR1Y2VkID0gcmVkdWNlZCAvIEJpZ0ludCh2YWx1ZXMubGVuZ3RoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlZHVjZWQgPSBNYXRoLnRydW5jKHJlZHVjZWQgLyB2YWx1ZXMubGVuZ3RoKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVkdWNlZDtcbn1cblxuZnVuY3Rpb24gcmVkdWNlcihcbiAgICBjb252ZXJ0OiAoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZTogYW55KSA9PiBhbnksXG4gICAgY29udmVydEJhY2s6IChjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlOiBhbnkpID0+IGFueSxcbiAgICBmbjogQWdncmVnYXRpb25GblR5cGUsXG4pOiAoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZXM6IGFueVtdKSA9PiBhbnkge1xuICAgIHJldHVybiAoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZXM6IGFueVtdKSA9PiB7XG4gICAgICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIGxldCByZWR1Y2VkID0gcmVkdWNlKGNvbnRleHQsIHZhbHVlcy5tYXAoeCA9PiBjb252ZXJ0KGNvbnRleHQsIHgpKSwgZm4pO1xuICAgICAgICByZXR1cm4gY29udmVydEJhY2soY29udGV4dCwgcmVkdWNlZCk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBub0NvbnZlcnNpb24oY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB4KSB7XG4gICAgcmV0dXJuIHg7XG59XG5cbmZ1bmN0aW9uIGJpZ0ludFN0cmluZ1RvRGVjaW1hbFN0cmluZyhjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlOiBhbnkpOiBhbnkge1xuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZS50b1N0cmluZygpO1xuICAgIH1cbiAgICAvLyRGbG93Rml4TWVcbiAgICByZXR1cm4gQmlnSW50KGAweCR7dmFsdWUuc3Vic3RyKGNvbnRleHQuYmlnSW50UHJlZml4KX1gKS50b1N0cmluZygpO1xufVxuXG4vLyRGbG93Rml4TWVcbmZ1bmN0aW9uIGJpZ0ludFBhcnRzVG9CaWdJbnQoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCBwYXJ0czogeyBhOiBudW1iZXIsIGI6IG51bWJlciB9KTogQmlnSW50IHtcbiAgICBjb25zdCBoID0gQmlnSW50KGAweCR7TWF0aC5yb3VuZChwYXJ0cy5hKS50b1N0cmluZygxNil9MDAwMDAwMDBgKTtcbiAgICBjb25zdCBsID0gQmlnSW50KE1hdGgucm91bmQocGFydHMuYikpO1xuICAgIHJldHVybiBoICsgbDtcbn1cblxuZnVuY3Rpb24gdG9TdHJpbmcoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZTogYW55KTogYW55IHtcbiAgICByZXR1cm4gdmFsdWUudG9TdHJpbmcoKTtcbn1cblxuZnVuY3Rpb24gYmlnSW50UGFydHNUb0JpZ0ludEF2Zyhjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlOiBhbnkpOiBhbnkge1xuICAgIGNvbnN0IHN1bSA9IGJpZ0ludFBhcnRzVG9CaWdJbnQoY29udGV4dCwgdmFsdWUpO1xuICAgIGNvbnN0IGNvdW50ID0gTnVtYmVyKHZhbHVlLmMgfHwgMCk7XG4gICAgcmV0dXJuIGNvdW50ID4gMCA/IChzdW0gLyBCaWdJbnQoTWF0aC5yb3VuZChjb3VudCkpKSA6IHN1bTtcbn1cblxuZXhwb3J0IGNsYXNzIEFnZ3JlZ2F0aW9uSGVscGVyRmFjdG9yeSB7XG4gICAgc3RhdGljIGNyZWF0ZShjb2xsZWN0aW9uOiBzdHJpbmcsIGluZGV4OiBudW1iZXIsIGFnZ3JlZ2F0aW9uOiBGaWVsZEFnZ3JlZ2F0aW9uKTogQWdncmVnYXRpb25IZWxwZXIge1xuICAgICAgICBjb25zdCBmaWVsZCA9IHNjYWxhckZpZWxkcy5nZXQoYCR7Y29sbGVjdGlvbn0uJHthZ2dyZWdhdGlvbi5maWVsZCB8fCAnaWQnfWApIHx8IGNvdW50RmllbGQ7XG4gICAgICAgIGNvbnN0IGZuID0gYWdncmVnYXRpb24uZm4gfHwgQWdncmVnYXRpb25Gbi5DT1VOVDtcbiAgICAgICAgY29uc3QgY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0ID0ge1xuICAgICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgICBmaWVsZCxcbiAgICAgICAgICAgIGZuLFxuICAgICAgICAgICAgYmlnSW50UHJlZml4OiAoZmllbGQudHlwZSA9PT0gJ3VpbnQxMDI0JykgPyAyIDogKGZpZWxkLnR5cGUgPT09ICd1aW50NjQnID8gMSA6IDApLFxuICAgICAgICAgICAgaXNBcnJheTogZmllbGQucGF0aC5pbmNsdWRlcygnWypdJyksXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gQ2FzZSBvZiBjb3VudFxuICAgICAgICBpZiAoY29udGV4dC5mbiA9PT0gQWdncmVnYXRpb25Gbi5DT1VOVCkge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICAgIGJ1aWxkUXVlcnk6IGNvdW50LFxuICAgICAgICAgICAgICAgIGNvbnZlcnRSZXN1bHQ6IChjb250ZXh0LCB2YWx1ZXMpID0+IHJlZHVjZShjb250ZXh0LCB2YWx1ZXMsICdTVU0nKSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29udGV4dC5maWVsZC5wYXRoID09PSAnJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBbJHthZ2dyZWdhdGlvbi5maWVsZH1dIGNhbid0IGJlIGFnZ3JlZ2F0ZWRgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENhc2Ugb2YgbnVtYmVyIGZpZWxkcyBvciBtaW4vbWF4IGZuXG4gICAgICAgIGlmIChmaWVsZC50eXBlID09PSAnbnVtYmVyJyB8fCBmbiA9PT0gQWdncmVnYXRpb25Gbi5NSU4gfHwgZm4gPT09IEFnZ3JlZ2F0aW9uRm4uTUFYKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgICAgYnVpbGRRdWVyeTogc2ltcGxlLFxuICAgICAgICAgICAgICAgIGNvbnZlcnRSZXN1bHQ6IGNvbnRleHQuYmlnSW50UHJlZml4ID4gMFxuICAgICAgICAgICAgICAgICAgICAvLyBiaWcgaW50ZWdlcnNcbiAgICAgICAgICAgICAgICAgICAgPyByZWR1Y2VyKG5vQ29udmVyc2lvbiwgYmlnSW50U3RyaW5nVG9EZWNpbWFsU3RyaW5nLCBmbilcbiAgICAgICAgICAgICAgICAgICAgLy8gbnVtYmVycyBhbmQgc3RyaW5nc1xuICAgICAgICAgICAgICAgICAgICA6IHJlZHVjZXIobm9Db252ZXJzaW9uLCBub0NvbnZlcnNpb24sIGZuKSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29udGV4dC5iaWdJbnRQcmVmaXggPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4gKGNvbnRleHQuZm4gPT09IEFnZ3JlZ2F0aW9uRm4uQVZFUkFHRSlcbiAgICAgICAgICAgICAgICA/IHsgLy8gYmlnIGludGVnZXIgYXZlcmFnZVxuICAgICAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICBidWlsZFF1ZXJ5OiBiaWdJbnRBdmcsXG4gICAgICAgICAgICAgICAgICAgIGNvbnZlcnRSZXN1bHQ6IHJlZHVjZXIoYmlnSW50UGFydHNUb0JpZ0ludEF2ZywgdG9TdHJpbmcsIGZuKSxcbiAgICAgICAgICAgICAgICB9IDogeyAvLyBiaWcgaW50ZWdlciBzdW1cbiAgICAgICAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgICAgICAgYnVpbGRRdWVyeTogYmlnSW50U3VtLFxuICAgICAgICAgICAgICAgICAgICBjb252ZXJ0UmVzdWx0OiByZWR1Y2VyKGJpZ0ludFBhcnRzVG9CaWdJbnQsIHRvU3RyaW5nLCBmbiksXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske2FnZ3JlZ2F0aW9uLmZpZWxkfV0gY2FuJ3QgYmUgdXNlZCB3aXRoIFske2ZufV1gKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgY3JlYXRlUXVlcnkoXG4gICAgICAgIGNvbGxlY3Rpb246IHN0cmluZyxcbiAgICAgICAgZmlsdGVyOiBzdHJpbmcsXG4gICAgICAgIGZpZWxkczogRmllbGRBZ2dyZWdhdGlvbltdLFxuICAgICk6IHtcbiAgICAgICAgdGV4dDogc3RyaW5nLFxuICAgICAgICBoZWxwZXJzOiBBZ2dyZWdhdGlvbkhlbHBlcltdLFxuICAgIH0ge1xuICAgICAgICBjb25zdCBmaWx0ZXJTZWN0aW9uID0gZmlsdGVyID8gYEZJTFRFUiAke2ZpbHRlcn1gIDogJyc7XG4gICAgICAgIGNvbnN0IGhlbHBlcnM6IEFnZ3JlZ2F0aW9uSGVscGVyW10gPSBmaWVsZHMubWFwKChhZ2dyZWdhdGlvbiwgaSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIEFnZ3JlZ2F0aW9uSGVscGVyRmFjdG9yeS5jcmVhdGUoY29sbGVjdGlvbiwgaSwgYWdncmVnYXRpb24pO1xuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgdGV4dDtcbiAgICAgICAgY29uc3QgaXNTaW5nbGVDb3VudCA9IChmaWVsZHMubGVuZ3RoID09PSAxKSAmJiAoZmllbGRzWzBdLmZuID09PSBBZ2dyZWdhdGlvbkZuLkNPVU5UKTtcbiAgICAgICAgaWYgKGlzU2luZ2xlQ291bnQpIHtcbiAgICAgICAgICAgIGlmIChmaWx0ZXJTZWN0aW9uICE9PSAnJykge1xuICAgICAgICAgICAgICAgIHRleHQgPSBgXG4gICAgICAgICAgICAgICAgICAgIEZPUiBkb2MgSU4gJHtjb2xsZWN0aW9ufVxuICAgICAgICAgICAgICAgICAgICAke2ZpbHRlclNlY3Rpb259XG4gICAgICAgICAgICAgICAgICAgIENPTExFQ1QgV0lUSCBDT1VOVCBJTlRPIGEwXG4gICAgICAgICAgICAgICAgICAgIFJFVFVSTiBbYTBdYDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGV4dCA9IGBSRVRVUk4gW0xFTkdUSCgke2NvbGxlY3Rpb259KV1gO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgcXVlcmllcyA9IGhlbHBlcnMubWFwKHggPT4geC5idWlsZFF1ZXJ5KHguY29udGV4dCkpO1xuICAgICAgICAgICAgdGV4dCA9IGBcbiAgICAgICAgICAgICAgICBGT1IgZG9jIElOICR7Y29sbGVjdGlvbn1cbiAgICAgICAgICAgICAgICAke2ZpbHRlclNlY3Rpb259XG4gICAgICAgICAgICAgICAgQ09MTEVDVCBBR0dSRUdBVEUgJHtxdWVyaWVzLm1hcCh4ID0+IHguY29sbGVjdCkuam9pbignLCAnKX1cbiAgICAgICAgICAgICAgICBSRVRVUk4gWyR7cXVlcmllcy5tYXAoeCA9PiB4LnJlc3VsdCkuam9pbignLCAnKX1dYDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGV4dCxcbiAgICAgICAgICAgIGhlbHBlcnMsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgc3RhdGljIGNvbnZlcnRSZXN1bHRzKHJlc3VsdHM6IGFueVtdW10sIGhlbHBlcnM6IEFnZ3JlZ2F0aW9uSGVscGVyW10pOiBhbnlbXSB7XG4gICAgICAgIHJldHVybiBoZWxwZXJzLm1hcCgoaGVscGVyLCBpKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZXMgPSByZXN1bHRzLm1hcCh4ID0+IHhbaV0pLmZpbHRlcih4ID0+IHggIT09IHVuZGVmaW5lZCAmJiB4ICE9PSBudWxsKTtcbiAgICAgICAgICAgIHJldHVybiBoZWxwZXIuY29udmVydFJlc3VsdChoZWxwZXIuY29udGV4dCwgdmFsdWVzKTtcbiAgICAgICAgfSk7XG5cbiAgICB9XG59XG5cbiJdfQ==