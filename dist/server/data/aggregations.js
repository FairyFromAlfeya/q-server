"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.AggregationHelperFactory = exports.AggregationFn = void 0;

var _resolversGenerated = require("../graphql/resolvers-generated");

const AggregationFn = {
  COUNT: 'COUNT',
  MIN: 'MIN',
  MAX: 'MAX',
  SUM: 'SUM',
  AVERAGE: 'AVERAGE'
};
exports.AggregationFn = AggregationFn;

// Query Builders

/**
 * Returns query parts in form of:
 * { collect: 'a<i> = <exprs0>', result: 'a<i>'} if exprs.length === 1
 * or
 * { collect: 'a<i> = <exprs0>, b<i> = <exprs1>, ..'., result: '{ a: a<i>, b: b<i>, ... }'}
 * if exprs.length > 1
 *
 * @param exprs
 * @param context
 * @return {{result: string, collects: string}}
 */
function queryParts(context, ...exprs) {
  const n = 'abcdef';

  const v = i => `${n[i]}${context.index}`; // 'a0' | 'b0' | ...


  const collectExpr = (x, i) => `${v(i)} = ${x}`; // 'a0 = expr[0]' | 'b0 = expr[1]' | ...


  const returnExpr = (x, i) => `${n[i]}: ${v(i)}`; // 'a: a0' | 'b: b0' | ...


  return {
    collect: exprs.map(collectExpr).join(', '),
    // 'a0 = expr[0], b0 = expr[1], ...'
    result: exprs.length === 1 ? `${v(0)}` // 'a0'
    : `{ ${exprs.map(returnExpr).join(', ')} }` // '{ a: a0, b: b0, ... }'

  };
}

const countField = {
  type: 'string',
  path: ''
};

function count(context) {
  return queryParts(context, 'COUNT(doc)');
}

function simple(context) {
  const fn = context.fn;
  return queryParts(context, context.isArray ? `${fn}(${fn}(${context.field.path}))` : `${fn}(${context.field.path})`);
}

function bigIntToNum(hex) {
  return `TO_NUMBER(CONCAT("0x", ${hex}))`;
}

function bigIntHiPart(path, prefix) {
  return bigIntToNum(`SUBSTRING(${path}, ${prefix}, LENGTH(${path}) - ${prefix + 8})`);
}

function bigIntLoPart(path, prefix) {
  return bigIntToNum(`RIGHT(SUBSTRING(${path}, ${prefix}), 8)`);
}

function bigIntSumExpr(part, context) {
  const path = context.field.path;
  const prefix = context.bigIntPrefix;
  return context.isArray ? `SUM(SUM((${path})[* RETURN ${part('CURRENT', prefix)}]))` : `SUM(${part(path, prefix)})`;
}

function bigIntSum(context) {
  return queryParts(context, bigIntSumExpr(bigIntHiPart, context), bigIntSumExpr(bigIntLoPart, context));
}

function bigIntAvg(context) {
  return queryParts(context, bigIntSumExpr(bigIntHiPart, context), bigIntSumExpr(bigIntLoPart, context), context.isArray ? `SUM(COUNT(${context.field.path}))` : `COUNT(doc)`);
} // Converters


function reduce(context, values, fn) {
  let reduced = values[0];

  for (let i = 1; i < values.length; i += 1) {
    const value = values[i];

    if (fn === 'MIN') {
      if (value < reduced) {
        reduced = value;
      }
    } else if (fn === 'MAX') {
      if (value > reduced) {
        reduced = value;
      }
    } else {
      reduced += value;
    }
  }

  if (fn === 'AVERAGE') {
    if (context.bigIntPrefix > 0) {
      reduced = reduced / BigInt(values.length);
    } else {
      reduced = Math.trunc(reduced / values.length);
    }
  }

  return reduced;
}

function reducer(convert, convertBack, fn) {
  return (context, values) => {
    if (values.length === 0) {
      return undefined;
    }

    let reduced = reduce(context, values.map(x => convert(context, x)), fn);
    return convertBack(context, reduced);
  };
}

function noConversion(context, x) {
  return x;
}

function bigIntStringToDecimalString(context, value) {
  if (typeof value === 'number') {
    return value.toString();
  } //$FlowFixMe


  return BigInt(`0x${value.substr(context.bigIntPrefix)}`).toString();
} //$FlowFixMe


function bigIntPartsToBigInt(context, parts) {
  const h = BigInt(`0x${Math.round(parts.a).toString(16)}00000000`);
  const l = BigInt(Math.round(parts.b));
  return h + l;
}

function toString(context, value) {
  return value.toString();
}

function bigIntPartsToBigIntAvg(context, value) {
  const sum = bigIntPartsToBigInt(context, value);
  const count = Number(value.c || 0);
  return count > 0 ? sum / BigInt(Math.round(count)) : sum;
}

class AggregationHelperFactory {
  static create(collection, index, aggregation) {
    const field = _resolversGenerated.scalarFields.get(`${collection}.${aggregation.field || 'id'}`) || countField;
    const fn = aggregation.fn || AggregationFn.COUNT;
    const context = {
      index,
      field,
      fn,
      bigIntPrefix: field.type === 'uint1024' ? 2 : field.type === 'uint64' ? 1 : 0,
      isArray: field.path.includes('[*]')
    }; // Case of count

    if (context.fn === AggregationFn.COUNT) {
      return {
        context,
        buildQuery: count,
        convertResult: (context, values) => reduce(context, values, 'SUM')
      };
    }

    if (context.field.path === '') {
      throw new Error(`[${aggregation.field}] can't be aggregated`);
    } // Case of number fields or min/max fn


    if (field.type === 'number' || fn === AggregationFn.MIN || fn === AggregationFn.MAX) {
      return {
        context,
        buildQuery: simple,
        convertResult: context.bigIntPrefix > 0 // big integers
        ? reducer(noConversion, bigIntStringToDecimalString, fn) // numbers and strings
        : reducer(noConversion, noConversion, fn)
      };
    }

    if (context.bigIntPrefix > 0) {
      return context.fn === AggregationFn.AVERAGE ? {
        // big integer average
        context,
        buildQuery: bigIntAvg,
        convertResult: reducer(bigIntPartsToBigIntAvg, toString, fn)
      } : {
        // big integer sum
        context,
        buildQuery: bigIntSum,
        convertResult: reducer(bigIntPartsToBigInt, toString, fn)
      };
    }

    throw new Error(`[${aggregation.field}] can't be used with [${fn}]`);
  }

  static createQuery(collection, filter, fields) {
    const filterSection = filter ? `FILTER ${filter}` : '';
    const helpers = fields.map((aggregation, i) => {
      return AggregationHelperFactory.create(collection, i, aggregation);
    });
    let text;
    const isSingleCount = fields.length === 1 && fields[0].fn === AggregationFn.COUNT;

    if (isSingleCount) {
      if (filterSection !== '') {
        text = `
                    FOR doc IN ${collection}
                    ${filterSection}
                    COLLECT WITH COUNT INTO a0
                    RETURN [a0]`;
      } else {
        text = `RETURN [LENGTH(${collection})]`;
      }
    } else {
      const queries = helpers.map(x => x.buildQuery(x.context));
      text = `
                FOR doc IN ${collection}
                ${filterSection}
                COLLECT AGGREGATE ${queries.map(x => x.collect).join(', ')}
                RETURN [${queries.map(x => x.result).join(', ')}]`;
    }

    return {
      text,
      helpers
    };
  }

  static convertResults(results, helpers) {
    return helpers.map((helper, i) => {
      const values = results.map(x => x[i]).filter(x => x !== undefined && x !== null);
      return helper.convertResult(helper.context, values);
    });
  }

}

exports.AggregationHelperFactory = AggregationHelperFactory;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9hZ2dyZWdhdGlvbnMuanMiXSwibmFtZXMiOlsiQWdncmVnYXRpb25GbiIsIkNPVU5UIiwiTUlOIiwiTUFYIiwiU1VNIiwiQVZFUkFHRSIsInF1ZXJ5UGFydHMiLCJjb250ZXh0IiwiZXhwcnMiLCJuIiwidiIsImkiLCJpbmRleCIsImNvbGxlY3RFeHByIiwieCIsInJldHVybkV4cHIiLCJjb2xsZWN0IiwibWFwIiwiam9pbiIsInJlc3VsdCIsImxlbmd0aCIsImNvdW50RmllbGQiLCJ0eXBlIiwicGF0aCIsImNvdW50Iiwic2ltcGxlIiwiZm4iLCJpc0FycmF5IiwiZmllbGQiLCJiaWdJbnRUb051bSIsImhleCIsImJpZ0ludEhpUGFydCIsInByZWZpeCIsImJpZ0ludExvUGFydCIsImJpZ0ludFN1bUV4cHIiLCJwYXJ0IiwiYmlnSW50UHJlZml4IiwiYmlnSW50U3VtIiwiYmlnSW50QXZnIiwicmVkdWNlIiwidmFsdWVzIiwicmVkdWNlZCIsInZhbHVlIiwiQmlnSW50IiwiTWF0aCIsInRydW5jIiwicmVkdWNlciIsImNvbnZlcnQiLCJjb252ZXJ0QmFjayIsInVuZGVmaW5lZCIsIm5vQ29udmVyc2lvbiIsImJpZ0ludFN0cmluZ1RvRGVjaW1hbFN0cmluZyIsInRvU3RyaW5nIiwic3Vic3RyIiwiYmlnSW50UGFydHNUb0JpZ0ludCIsInBhcnRzIiwiaCIsInJvdW5kIiwiYSIsImwiLCJiIiwiYmlnSW50UGFydHNUb0JpZ0ludEF2ZyIsInN1bSIsIk51bWJlciIsImMiLCJBZ2dyZWdhdGlvbkhlbHBlckZhY3RvcnkiLCJjcmVhdGUiLCJjb2xsZWN0aW9uIiwiYWdncmVnYXRpb24iLCJzY2FsYXJGaWVsZHMiLCJnZXQiLCJpbmNsdWRlcyIsImJ1aWxkUXVlcnkiLCJjb252ZXJ0UmVzdWx0IiwiRXJyb3IiLCJjcmVhdGVRdWVyeSIsImZpbHRlciIsImZpZWxkcyIsImZpbHRlclNlY3Rpb24iLCJoZWxwZXJzIiwidGV4dCIsImlzU2luZ2xlQ291bnQiLCJxdWVyaWVzIiwiY29udmVydFJlc3VsdHMiLCJyZXN1bHRzIiwiaGVscGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBR0E7O0FBSU8sTUFBTUEsYUFBYSxHQUFHO0FBQ3pCQyxFQUFBQSxLQUFLLEVBQUUsT0FEa0I7QUFFekJDLEVBQUFBLEdBQUcsRUFBRSxLQUZvQjtBQUd6QkMsRUFBQUEsR0FBRyxFQUFFLEtBSG9CO0FBSXpCQyxFQUFBQSxHQUFHLEVBQUUsS0FKb0I7QUFLekJDLEVBQUFBLE9BQU8sRUFBRTtBQUxnQixDQUF0Qjs7O0FBa0NQOztBQUVBOzs7Ozs7Ozs7OztBQVdBLFNBQVNDLFVBQVQsQ0FBb0JDLE9BQXBCLEVBQWlELEdBQUdDLEtBQXBELEVBQTRGO0FBQ3hGLFFBQU1DLENBQUMsR0FBRyxRQUFWOztBQUNBLFFBQU1DLENBQUMsR0FBSUMsQ0FBRCxJQUFRLEdBQUVGLENBQUMsQ0FBQ0UsQ0FBRCxDQUFJLEdBQUVKLE9BQU8sQ0FBQ0ssS0FBTSxFQUF6QyxDQUZ3RixDQUU1Qzs7O0FBQzVDLFFBQU1DLFdBQVcsR0FBRyxDQUFDQyxDQUFELEVBQUlILENBQUosS0FBVyxHQUFFRCxDQUFDLENBQUNDLENBQUQsQ0FBSSxNQUFLRyxDQUFFLEVBQTdDLENBSHdGLENBR3hDOzs7QUFDaEQsUUFBTUMsVUFBVSxHQUFHLENBQUNELENBQUQsRUFBSUgsQ0FBSixLQUFXLEdBQUVGLENBQUMsQ0FBQ0UsQ0FBRCxDQUFJLEtBQUlELENBQUMsQ0FBQ0MsQ0FBRCxDQUFJLEVBQTlDLENBSndGLENBSXZDOzs7QUFDakQsU0FBTztBQUNISyxJQUFBQSxPQUFPLEVBQUVSLEtBQUssQ0FBQ1MsR0FBTixDQUFVSixXQUFWLEVBQXVCSyxJQUF2QixDQUE0QixJQUE1QixDQUROO0FBQ3lDO0FBQzVDQyxJQUFBQSxNQUFNLEVBQUVYLEtBQUssQ0FBQ1ksTUFBTixLQUFpQixDQUFqQixHQUNELEdBQUVWLENBQUMsQ0FBQyxDQUFELENBQUksRUFETixDQUNRO0FBRFIsTUFF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RSxJQUE1QixDQUFpQyxJQUFqQyxDQUF1QzswQkFDakRnRSxPQUFPLENBQUNqRSxHQUFSLENBQVlILENBQUMsSUFBSUEsQ0FBQyxDQUFDSyxNQUFuQixFQUEyQkQsSUFBM0IsQ0FBZ0MsSUFBaEMsQ0FBc0MsR0FKcEQ7QUFLSDs7QUFDRCxXQUFPO0FBQ0g4RCxNQUFBQSxJQURHO0FBRUhELE1BQUFBO0FBRkcsS0FBUDtBQUlIOztBQUVELFNBQU9JLGNBQVAsQ0FBc0JDLE9BQXRCLEVBQXdDTCxPQUF4QyxFQUE2RTtBQUN6RSxXQUFPQSxPQUFPLENBQUM5RCxHQUFSLENBQVksQ0FBQ29FLE1BQUQsRUFBUzFFLENBQVQsS0FBZTtBQUM5QixZQUFNNkIsTUFBTSxHQUFHNEMsT0FBTyxDQUFDbkUsR0FBUixDQUFZSCxDQUFDLElBQUlBLENBQUMsQ0FBQ0gsQ0FBRCxDQUFsQixFQUF1QmlFLE1BQXZCLENBQThCOUQsQ0FBQyxJQUFJQSxDQUFDLEtBQUttQyxTQUFOLElBQW1CbkMsQ0FBQyxLQUFLLElBQTVELENBQWY7QUFDQSxhQUFPdUUsTUFBTSxDQUFDWixhQUFQLENBQXFCWSxNQUFNLENBQUM5RSxPQUE1QixFQUFxQ2lDLE1BQXJDLENBQVA7QUFDSCxLQUhNLENBQVA7QUFLSDs7QUFwR2lDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHR5cGUgeyBTY2FsYXJGaWVsZCB9IGZyb20gJy4uL2ZpbHRlci9maWx0ZXJzJztcbmltcG9ydCB7IHNjYWxhckZpZWxkcyB9IGZyb20gJy4uL2dyYXBocWwvcmVzb2x2ZXJzLWdlbmVyYXRlZCc7XG5cbmRlY2xhcmUgZnVuY3Rpb24gQmlnSW50KHZhbHVlOiBhbnkpOiBhbnk7XG5cbmV4cG9ydCBjb25zdCBBZ2dyZWdhdGlvbkZuID0ge1xuICAgIENPVU5UOiAnQ09VTlQnLFxuICAgIE1JTjogJ01JTicsXG4gICAgTUFYOiAnTUFYJyxcbiAgICBTVU06ICdTVU0nLFxuICAgIEFWRVJBR0U6ICdBVkVSQUdFJyxcbn1cblxuZXhwb3J0IHR5cGUgQWdncmVnYXRpb25GblR5cGUgPSAkS2V5czx0eXBlb2YgQWdncmVnYXRpb25Gbj47XG5cbmV4cG9ydCB0eXBlIEZpZWxkQWdncmVnYXRpb24gPSB7XG4gICAgZmllbGQ6IHN0cmluZyxcbiAgICBmbjogQWdncmVnYXRpb25GblR5cGUsXG59XG5cbnR5cGUgQWdncmVnYXRpb25Db250ZXh0ID0ge1xuICAgIGluZGV4OiBudW1iZXIsXG4gICAgZmllbGQ6IFNjYWxhckZpZWxkLFxuICAgIGZuOiBBZ2dyZWdhdGlvbkZuVHlwZSxcbiAgICBiaWdJbnRQcmVmaXg6IG51bWJlcixcbiAgICBpc0FycmF5OiBib29sZWFuLFxufVxuXG50eXBlIEFnZ3JlZ2F0aW9uUXVlcnlQYXJ0cyA9IHtcbiAgICBjb2xsZWN0OiBzdHJpbmcsXG4gICAgcmVzdWx0OiBzdHJpbmcsXG59XG5cbmV4cG9ydCB0eXBlIEFnZ3JlZ2F0aW9uSGVscGVyID0ge1xuICAgIGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCxcbiAgICBidWlsZFF1ZXJ5OiAoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0KSA9PiBBZ2dyZWdhdGlvblF1ZXJ5UGFydHMsXG4gICAgY29udmVydFJlc3VsdDogKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgdmFsdWU6IGFueSkgPT4gYW55LFxufVxuXG4vLyBRdWVyeSBCdWlsZGVyc1xuXG4vKipcbiAqIFJldHVybnMgcXVlcnkgcGFydHMgaW4gZm9ybSBvZjpcbiAqIHsgY29sbGVjdDogJ2E8aT4gPSA8ZXhwcnMwPicsIHJlc3VsdDogJ2E8aT4nfSBpZiBleHBycy5sZW5ndGggPT09IDFcbiAqIG9yXG4gKiB7IGNvbGxlY3Q6ICdhPGk+ID0gPGV4cHJzMD4sIGI8aT4gPSA8ZXhwcnMxPiwgLi4nLiwgcmVzdWx0OiAneyBhOiBhPGk+LCBiOiBiPGk+LCAuLi4gfSd9XG4gKiBpZiBleHBycy5sZW5ndGggPiAxXG4gKlxuICogQHBhcmFtIGV4cHJzXG4gKiBAcGFyYW0gY29udGV4dFxuICogQHJldHVybiB7e3Jlc3VsdDogc3RyaW5nLCBjb2xsZWN0czogc3RyaW5nfX1cbiAqL1xuZnVuY3Rpb24gcXVlcnlQYXJ0cyhjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIC4uLmV4cHJzOiBzdHJpbmdbXSk6IEFnZ3JlZ2F0aW9uUXVlcnlQYXJ0cyB7XG4gICAgY29uc3QgbiA9ICdhYmNkZWYnO1xuICAgIGNvbnN0IHYgPSAoaSkgPT4gYCR7bltpXX0ke2NvbnRleHQuaW5kZXh9YDsgLy8gJ2EwJyB8ICdiMCcgfCAuLi5cbiAgICBjb25zdCBjb2xsZWN0RXhwciA9ICh4LCBpKSA9PiBgJHt2KGkpfSA9ICR7eH1gOyAvLyAnYTAgPSBleHByWzBdJyB8ICdiMCA9IGV4cHJbMV0nIHwgLi4uXG4gICAgY29uc3QgcmV0dXJuRXhwciA9ICh4LCBpKSA9PiBgJHtuW2ldfTogJHt2KGkpfWA7IC8vICdhOiBhMCcgfCAnYjogYjAnIHwgLi4uXG4gICAgcmV0dXJuIHtcbiAgICAgICAgY29sbGVjdDogZXhwcnMubWFwKGNvbGxlY3RFeHByKS5qb2luKCcsICcpLCAvLyAnYTAgPSBleHByWzBdLCBiMCA9IGV4cHJbMV0sIC4uLidcbiAgICAgICAgcmVzdWx0OiBleHBycy5sZW5ndGggPT09IDFcbiAgICAgICAgICAgID8gYCR7digwKX1gIC8vICdhMCdcbiAgICAgICAgICAgIDogYHsgJHtleHBycy5tYXAocmV0dXJuRXhwcikuam9pbignLCAnKX0gfWAsIC8vICd7IGE6IGEwLCBiOiBiMCwgLi4uIH0nXG4gICAgfVxufVxuXG5jb25zdCBjb3VudEZpZWxkOiBTY2FsYXJGaWVsZCA9IHtcbiAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICBwYXRoOiAnJyxcbn07XG5cbmZ1bmN0aW9uIGNvdW50KGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCk6IEFnZ3JlZ2F0aW9uUXVlcnlQYXJ0cyB7XG4gICAgcmV0dXJuIHF1ZXJ5UGFydHMoY29udGV4dCwgJ0NPVU5UKGRvYyknKTtcbn1cblxuZnVuY3Rpb24gc2ltcGxlKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCk6IEFnZ3JlZ2F0aW9uUXVlcnlQYXJ0cyB7XG4gICAgY29uc3QgZm4gPSBjb250ZXh0LmZuO1xuICAgIHJldHVybiBxdWVyeVBhcnRzKGNvbnRleHQsIGNvbnRleHQuaXNBcnJheVxuICAgICAgICA/IGAke2ZufSgke2ZufSgke2NvbnRleHQuZmllbGQucGF0aH0pKWBcbiAgICAgICAgOiBgJHtmbn0oJHtjb250ZXh0LmZpZWxkLnBhdGh9KWAsXG4gICAgKTtcbn1cblxuZnVuY3Rpb24gYmlnSW50VG9OdW0oaGV4OiBhbnkpOiBzdHJpbmcge1xuICAgIHJldHVybiBgVE9fTlVNQkVSKENPTkNBVChcIjB4XCIsICR7KGhleDogYW55KX0pKWBcbn1cblxuZnVuY3Rpb24gYmlnSW50SGlQYXJ0KHBhdGg6IHN0cmluZywgcHJlZml4OiBudW1iZXIpOiBzdHJpbmcge1xuICAgIHJldHVybiBiaWdJbnRUb051bShgU1VCU1RSSU5HKCR7cGF0aH0sICR7cHJlZml4fSwgTEVOR1RIKCR7cGF0aH0pIC0gJHtwcmVmaXggKyA4fSlgKTtcbn1cblxuZnVuY3Rpb24gYmlnSW50TG9QYXJ0KHBhdGg6IHN0cmluZywgcHJlZml4OiBudW1iZXIpOiBzdHJpbmcge1xuICAgIHJldHVybiBiaWdJbnRUb051bShgUklHSFQoU1VCU1RSSU5HKCR7cGF0aH0sICR7cHJlZml4fSksIDgpYCk7XG59XG5cbmZ1bmN0aW9uIGJpZ0ludFN1bUV4cHIocGFydDogKHBhdGg6IHN0cmluZywgcHJlZml4OiBudW1iZXIpID0+IHN0cmluZywgY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0KSB7XG4gICAgY29uc3QgcGF0aCA9IGNvbnRleHQuZmllbGQucGF0aDtcbiAgICBjb25zdCBwcmVmaXggPSBjb250ZXh0LmJpZ0ludFByZWZpeDtcbiAgICByZXR1cm4gY29udGV4dC5pc0FycmF5XG4gICAgICAgID8gYFNVTShTVU0oKCR7cGF0aH0pWyogUkVUVVJOICR7cGFydCgnQ1VSUkVOVCcsIHByZWZpeCl9XSkpYFxuICAgICAgICA6IGBTVU0oJHtwYXJ0KHBhdGgsIHByZWZpeCl9KWA7XG59XG5cbmZ1bmN0aW9uIGJpZ0ludFN1bShjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQpOiBBZ2dyZWdhdGlvblF1ZXJ5UGFydHMge1xuICAgIHJldHVybiBxdWVyeVBhcnRzKFxuICAgICAgICBjb250ZXh0LFxuICAgICAgICBiaWdJbnRTdW1FeHByKGJpZ0ludEhpUGFydCwgY29udGV4dCksXG4gICAgICAgIGJpZ0ludFN1bUV4cHIoYmlnSW50TG9QYXJ0LCBjb250ZXh0KSxcbiAgICApO1xufVxuXG5mdW5jdGlvbiBiaWdJbnRBdmcoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0KTogQWdncmVnYXRpb25RdWVyeVBhcnRzIHtcbiAgICByZXR1cm4gcXVlcnlQYXJ0cyhcbiAgICAgICAgY29udGV4dCxcbiAgICAgICAgYmlnSW50U3VtRXhwcihiaWdJbnRIaVBhcnQsIGNvbnRleHQpLFxuICAgICAgICBiaWdJbnRTdW1FeHByKGJpZ0ludExvUGFydCwgY29udGV4dCksXG4gICAgICAgIGNvbnRleHQuaXNBcnJheVxuICAgICAgICAgICAgPyBgU1VNKENPVU5UKCR7Y29udGV4dC5maWVsZC5wYXRofSkpYFxuICAgICAgICAgICAgOiBgQ09VTlQoZG9jKWAsXG4gICAgKTtcbn1cblxuLy8gQ29udmVydGVyc1xuXG5mdW5jdGlvbiByZWR1Y2UoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZXM6IGFueVtdLCBmbjogQWdncmVnYXRpb25GblR5cGUpOiBhbnkge1xuICAgIGxldCByZWR1Y2VkID0gdmFsdWVzWzBdO1xuICAgIGZvciAobGV0IGkgPSAxOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gdmFsdWVzW2ldO1xuICAgICAgICBpZiAoZm4gPT09ICdNSU4nKSB7XG4gICAgICAgICAgICBpZiAodmFsdWUgPCByZWR1Y2VkKSB7XG4gICAgICAgICAgICAgICAgcmVkdWNlZCA9IHZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGZuID09PSAnTUFYJykge1xuICAgICAgICAgICAgaWYgKHZhbHVlID4gcmVkdWNlZCkge1xuICAgICAgICAgICAgICAgIHJlZHVjZWQgPSB2YWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlZHVjZWQgKz0gdmFsdWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGZuID09PSAnQVZFUkFHRScpIHtcbiAgICAgICAgaWYgKGNvbnRleHQuYmlnSW50UHJlZml4ID4gMCkge1xuICAgICAgICAgICAgcmVkdWNlZCA9IHJlZHVjZWQgLyBCaWdJbnQodmFsdWVzLmxlbmd0aCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZWR1Y2VkID0gTWF0aC50cnVuYyhyZWR1Y2VkIC8gdmFsdWVzLmxlbmd0aCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlZHVjZWQ7XG59XG5cbmZ1bmN0aW9uIHJlZHVjZXIoXG4gICAgY29udmVydDogKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgdmFsdWU6IGFueSkgPT4gYW55LFxuICAgIGNvbnZlcnRCYWNrOiAoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZTogYW55KSA9PiBhbnksXG4gICAgZm46IEFnZ3JlZ2F0aW9uRm5UeXBlLFxuKTogKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgdmFsdWVzOiBhbnlbXSkgPT4gYW55IHtcbiAgICByZXR1cm4gKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgdmFsdWVzOiBhbnlbXSkgPT4ge1xuICAgICAgICBpZiAodmFsdWVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICBsZXQgcmVkdWNlZCA9IHJlZHVjZShjb250ZXh0LCB2YWx1ZXMubWFwKHggPT4gY29udmVydChjb250ZXh0LCB4KSksIGZuKTtcbiAgICAgICAgcmV0dXJuIGNvbnZlcnRCYWNrKGNvbnRleHQsIHJlZHVjZWQpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gbm9Db252ZXJzaW9uKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgeCkge1xuICAgIHJldHVybiB4O1xufVxuXG5mdW5jdGlvbiBiaWdJbnRTdHJpbmdUb0RlY2ltYWxTdHJpbmcoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZTogYW55KTogYW55IHtcbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykge1xuICAgICAgICByZXR1cm4gdmFsdWUudG9TdHJpbmcoKTtcbiAgICB9XG4gICAgLy8kRmxvd0ZpeE1lXG4gICAgcmV0dXJuIEJpZ0ludChgMHgke3ZhbHVlLnN1YnN0cihjb250ZXh0LmJpZ0ludFByZWZpeCl9YCkudG9TdHJpbmcoKTtcbn1cblxuLy8kRmxvd0ZpeE1lXG5mdW5jdGlvbiBiaWdJbnRQYXJ0c1RvQmlnSW50KGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgcGFydHM6IHsgYTogbnVtYmVyLCBiOiBudW1iZXIgfSk6IEJpZ0ludCB7XG4gICAgY29uc3QgaCA9IEJpZ0ludChgMHgke01hdGgucm91bmQocGFydHMuYSkudG9TdHJpbmcoMTYpfTAwMDAwMDAwYCk7XG4gICAgY29uc3QgbCA9IEJpZ0ludChNYXRoLnJvdW5kKHBhcnRzLmIpKTtcbiAgICByZXR1cm4gaCArIGw7XG59XG5cbmZ1bmN0aW9uIHRvU3RyaW5nKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgdmFsdWU6IGFueSk6IGFueSB7XG4gICAgcmV0dXJuIHZhbHVlLnRvU3RyaW5nKCk7XG59XG5cbmZ1bmN0aW9uIGJpZ0ludFBhcnRzVG9CaWdJbnRBdmcoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZTogYW55KTogYW55IHtcbiAgICBjb25zdCBzdW0gPSBiaWdJbnRQYXJ0c1RvQmlnSW50KGNvbnRleHQsIHZhbHVlKTtcbiAgICBjb25zdCBjb3VudCA9IE51bWJlcih2YWx1ZS5jIHx8IDApO1xuICAgIHJldHVybiBjb3VudCA+IDAgPyAoc3VtIC8gQmlnSW50KE1hdGgucm91bmQoY291bnQpKSkgOiBzdW07XG59XG5cbmV4cG9ydCBjbGFzcyBBZ2dyZWdhdGlvbkhlbHBlckZhY3Rvcnkge1xuICAgIHN0YXRpYyBjcmVhdGUoY29sbGVjdGlvbjogc3RyaW5nLCBpbmRleDogbnVtYmVyLCBhZ2dyZWdhdGlvbjogRmllbGRBZ2dyZWdhdGlvbik6IEFnZ3JlZ2F0aW9uSGVscGVyIHtcbiAgICAgICAgY29uc3QgZmllbGQgPSBzY2FsYXJGaWVsZHMuZ2V0KGAke2NvbGxlY3Rpb259LiR7YWdncmVnYXRpb24uZmllbGQgfHwgJ2lkJ31gKSB8fCBjb3VudEZpZWxkO1xuICAgICAgICBjb25zdCBmbiA9IGFnZ3JlZ2F0aW9uLmZuIHx8IEFnZ3JlZ2F0aW9uRm4uQ09VTlQ7XG4gICAgICAgIGNvbnN0IGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCA9IHtcbiAgICAgICAgICAgIGluZGV4LFxuICAgICAgICAgICAgZmllbGQsXG4gICAgICAgICAgICBmbixcbiAgICAgICAgICAgIGJpZ0ludFByZWZpeDogKGZpZWxkLnR5cGUgPT09ICd1aW50MTAyNCcpID8gMiA6IChmaWVsZC50eXBlID09PSAndWludDY0JyA/IDEgOiAwKSxcbiAgICAgICAgICAgIGlzQXJyYXk6IGZpZWxkLnBhdGguaW5jbHVkZXMoJ1sqXScpLFxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIENhc2Ugb2YgY291bnRcbiAgICAgICAgaWYgKGNvbnRleHQuZm4gPT09IEFnZ3JlZ2F0aW9uRm4uQ09VTlQpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgICBidWlsZFF1ZXJ5OiBjb3VudCxcbiAgICAgICAgICAgICAgICBjb252ZXJ0UmVzdWx0OiAoY29udGV4dCwgdmFsdWVzKSA9PiByZWR1Y2UoY29udGV4dCwgdmFsdWVzLCAnU1VNJyksXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbnRleHQuZmllbGQucGF0aCA9PT0gJycpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgWyR7YWdncmVnYXRpb24uZmllbGR9XSBjYW4ndCBiZSBhZ2dyZWdhdGVkYCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDYXNlIG9mIG51bWJlciBmaWVsZHMgb3IgbWluL21heCBmblxuICAgICAgICBpZiAoZmllbGQudHlwZSA9PT0gJ251bWJlcicgfHwgZm4gPT09IEFnZ3JlZ2F0aW9uRm4uTUlOIHx8IGZuID09PSBBZ2dyZWdhdGlvbkZuLk1BWCkge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICAgIGJ1aWxkUXVlcnk6IHNpbXBsZSxcbiAgICAgICAgICAgICAgICBjb252ZXJ0UmVzdWx0OiBjb250ZXh0LmJpZ0ludFByZWZpeCA+IDBcbiAgICAgICAgICAgICAgICAgICAgLy8gYmlnIGludGVnZXJzXG4gICAgICAgICAgICAgICAgICAgID8gcmVkdWNlcihub0NvbnZlcnNpb24sIGJpZ0ludFN0cmluZ1RvRGVjaW1hbFN0cmluZywgZm4pXG4gICAgICAgICAgICAgICAgICAgIC8vIG51bWJlcnMgYW5kIHN0cmluZ3NcbiAgICAgICAgICAgICAgICAgICAgOiByZWR1Y2VyKG5vQ29udmVyc2lvbiwgbm9Db252ZXJzaW9uLCBmbiksXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbnRleHQuYmlnSW50UHJlZml4ID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuIChjb250ZXh0LmZuID09PSBBZ2dyZWdhdGlvbkZuLkFWRVJBR0UpXG4gICAgICAgICAgICAgICAgPyB7IC8vIGJpZyBpbnRlZ2VyIGF2ZXJhZ2VcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgICAgICAgYnVpbGRRdWVyeTogYmlnSW50QXZnLFxuICAgICAgICAgICAgICAgICAgICBjb252ZXJ0UmVzdWx0OiByZWR1Y2VyKGJpZ0ludFBhcnRzVG9CaWdJbnRBdmcsIHRvU3RyaW5nLCBmbiksXG4gICAgICAgICAgICAgICAgfSA6IHsgLy8gYmlnIGludGVnZXIgc3VtXG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgICAgICAgIGJ1aWxkUXVlcnk6IGJpZ0ludFN1bSxcbiAgICAgICAgICAgICAgICAgICAgY29udmVydFJlc3VsdDogcmVkdWNlcihiaWdJbnRQYXJ0c1RvQmlnSW50LCB0b1N0cmluZywgZm4pLFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICB9XG5cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBbJHthZ2dyZWdhdGlvbi5maWVsZH1dIGNhbid0IGJlIHVzZWQgd2l0aCBbJHtmbn1dYCk7XG4gICAgfVxuXG4gICAgc3RhdGljIGNyZWF0ZVF1ZXJ5KFxuICAgICAgICBjb2xsZWN0aW9uOiBzdHJpbmcsXG4gICAgICAgIGZpbHRlcjogc3RyaW5nLFxuICAgICAgICBmaWVsZHM6IEZpZWxkQWdncmVnYXRpb25bXSxcbiAgICApOiB7XG4gICAgICAgIHRleHQ6IHN0cmluZyxcbiAgICAgICAgaGVscGVyczogQWdncmVnYXRpb25IZWxwZXJbXSxcbiAgICB9IHtcbiAgICAgICAgY29uc3QgZmlsdGVyU2VjdGlvbiA9IGZpbHRlciA/IGBGSUxURVIgJHtmaWx0ZXJ9YCA6ICcnO1xuICAgICAgICBjb25zdCBoZWxwZXJzOiBBZ2dyZWdhdGlvbkhlbHBlcltdID0gZmllbGRzLm1hcCgoYWdncmVnYXRpb24sIGkpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBBZ2dyZWdhdGlvbkhlbHBlckZhY3RvcnkuY3JlYXRlKGNvbGxlY3Rpb24sIGksIGFnZ3JlZ2F0aW9uKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IHRleHQ7XG4gICAgICAgIGNvbnN0IGlzU2luZ2xlQ291bnQgPSAoZmllbGRzLmxlbmd0aCA9PT0gMSkgJiYgKGZpZWxkc1swXS5mbiA9PT0gQWdncmVnYXRpb25Gbi5DT1VOVCk7XG4gICAgICAgIGlmIChpc1NpbmdsZUNvdW50KSB7XG4gICAgICAgICAgICBpZiAoZmlsdGVyU2VjdGlvbiAhPT0gJycpIHtcbiAgICAgICAgICAgICAgICB0ZXh0ID0gYFxuICAgICAgICAgICAgICAgICAgICBGT1IgZG9jIElOICR7Y29sbGVjdGlvbn1cbiAgICAgICAgICAgICAgICAgICAgJHtmaWx0ZXJTZWN0aW9ufVxuICAgICAgICAgICAgICAgICAgICBDT0xMRUNUIFdJVEggQ09VTlQgSU5UTyBhMFxuICAgICAgICAgICAgICAgICAgICBSRVRVUk4gW2EwXWA7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRleHQgPSBgUkVUVVJOIFtMRU5HVEgoJHtjb2xsZWN0aW9ufSldYDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHF1ZXJpZXMgPSBoZWxwZXJzLm1hcCh4ID0+IHguYnVpbGRRdWVyeSh4LmNvbnRleHQpKTtcbiAgICAgICAgICAgIHRleHQgPSBgXG4gICAgICAgICAgICAgICAgRk9SIGRvYyBJTiAke2NvbGxlY3Rpb259XG4gICAgICAgICAgICAgICAgJHtmaWx0ZXJTZWN0aW9ufVxuICAgICAgICAgICAgICAgIENPTExFQ1QgQUdHUkVHQVRFICR7cXVlcmllcy5tYXAoeCA9PiB4LmNvbGxlY3QpLmpvaW4oJywgJyl9XG4gICAgICAgICAgICAgICAgUkVUVVJOIFske3F1ZXJpZXMubWFwKHggPT4geC5yZXN1bHQpLmpvaW4oJywgJyl9XWA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRleHQsXG4gICAgICAgICAgICBoZWxwZXJzLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHN0YXRpYyBjb252ZXJ0UmVzdWx0cyhyZXN1bHRzOiBhbnlbXVtdLCBoZWxwZXJzOiBBZ2dyZWdhdGlvbkhlbHBlcltdKTogYW55W10ge1xuICAgICAgICByZXR1cm4gaGVscGVycy5tYXAoKGhlbHBlciwgaSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdmFsdWVzID0gcmVzdWx0cy5tYXAoeCA9PiB4W2ldKS5maWx0ZXIoeCA9PiB4ICE9PSB1bmRlZmluZWQgJiYgeCAhPT0gbnVsbCk7XG4gICAgICAgICAgICByZXR1cm4gaGVscGVyLmNvbnZlcnRSZXN1bHQoaGVscGVyLmNvbnRleHQsIHZhbHVlcyk7XG4gICAgICAgIH0pO1xuXG4gICAgfVxufVxuXG4iXX0=