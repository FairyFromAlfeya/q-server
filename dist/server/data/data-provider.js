"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.sortedIndex = sortedIndex;
exports.missingDataCache = exports.QDataPrecachedCombiner = exports.QDataCombiner = exports.dataEvent = void 0;
const dataEvent = {
  UPSERT: 'insert/update',
  INSERT: 'insert',
  UPDATE: 'update'
};
exports.dataEvent = dataEvent;

class QDataCombiner {
  constructor(providers) {
    this.providers = providers;
  }

  start(collectionsForSubscribe) {
    this.providers.forEach((x, i) => x.start(i === 0 ? collectionsForSubscribe : []));
  }

  getCollectionIndexes(collection) {
    return this.providers[0].getCollectionIndexes(collection);
  }

  async query(text, vars, orderBy) {
    const results = await Promise.all(this.providers.map(x => x.query(text, vars, orderBy)));
    return combineResults(results, orderBy);
  }

  subscribe(collection, listener) {
    return this.providers[0].subscribe(collection, listener);
  }

  unsubscribe(subscription) {
    this.providers[0].unsubscribe(subscription);
  }

}

exports.QDataCombiner = QDataCombiner;

class QDataPrecachedCombiner extends QDataCombiner {
  constructor(cache, providers) {
    super(providers);
    this.cache = cache;
  }

  async query(text, vars, orderBy) {
    const key = JSON.stringify({
      text: text,
      vars: vars,
      orderBy: orderBy
    });
    let docs = await this.cache.get(key);

    if (isNullOrUndefined(docs)) {
      docs = await super.query(text, vars, orderBy);
      await this.cache.set(key, docs);
    }

    return docs;
  }

}

exports.QDataPrecachedCombiner = QDataPrecachedCombiner;

function combineResults(results, orderBy) {
  const docs = collectDistinctDocs(results);

  if (orderBy.length > 0) {
    docs.sort((a, b) => compareDocs(a, b, orderBy));
  }

  return docs;
}

function collectDistinctDocs(source) {
  const distinctDocs = [];
  const distinctKeys = new Set();
  source.forEach(docs => {
    docs.forEach(doc => {
      if (!doc._key) {
        distinctDocs.push(doc);
      } else if (!distinctKeys.has(doc._key)) {
        distinctDocs.push(doc);
        distinctKeys.add(doc._key);
      }
    });
  });
  return distinctDocs;
}

function compareDocs(a, b, orderBy) {
  for (let i = 0; i < orderBy.length; i += 1) {
    const field = orderBy[i];
    const path = field.path.split('.');
    const aValue = getValue(a, path, 0);
    const bValue = getValue(b, path, 0);
    let comparison = compareValues(aValue, bValue);

    if (comparison !== 0) {
      return field.direction === 'DESC' ? -comparison : comparison;
    }
  }

  return 0;
}

function getValue(value, path, pathIndex) {
  if (isNullOrUndefined(value) || pathIndex >= path.length) {
    return value;
  }

  const name = path[pathIndex] === 'id' ? '_key' : path[pathIndex];
  return getValue(value[name], path, pathIndex + 1);
}

function compareValues(a, b) {
  const aHasValue = !isNullOrUndefined(a);
  const bHasValue = !isNullOrUndefined(b);

  if (!aHasValue) {
    return bHasValue ? -1 : 0;
  }

  if (!bHasValue) {
    return 1;
  }

  return a === b ? 0 : a < b ? -1 : 0;
}

function isNullOrUndefined(v) {
  return v === null || typeof v === 'undefined';
}

function sortedIndex(fields) {
  return {
    type: 'persistent',
    fields
  };
}

const missingDataCache = {
  get(_key) {
    return Promise.resolve(null);
  },

  set(_key, _value) {
    return Promise.resolve();
  }

};
exports.missingDataCache = missingDataCache;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9kYXRhLXByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbImRhdGFFdmVudCIsIlVQU0VSVCIsIklOU0VSVCIsIlVQREFURSIsIlFEYXRhQ29tYmluZXIiLCJjb25zdHJ1Y3RvciIsInByb3ZpZGVycyIsInN0YXJ0IiwiY29sbGVjdGlvbnNGb3JTdWJzY3JpYmUiLCJmb3JFYWNoIiwieCIsImkiLCJnZXRDb2xsZWN0aW9uSW5kZXhlcyIsImNvbGxlY3Rpb24iLCJxdWVyeSIsInRleHQiLCJ2YXJzIiwib3JkZXJCeSIsInJlc3VsdHMiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwiY29tYmluZVJlc3VsdHMiLCJzdWJzY3JpYmUiLCJsaXN0ZW5lciIsInVuc3Vic2NyaWJlIiwic3Vic2NyaXB0aW9uIiwiUURhdGFQcmVjYWNoZWRDb21iaW5lciIsImNhY2hlIiwia2V5IiwiSlNPTiIsInN0cmluZ2lmeSIsImRvY3MiLCJnZXQiLCJpc051bGxPclVuZGVmaW5lZCIsInNldCIsImNvbGxlY3REaXN0aW5jdERvY3MiLCJsZW5ndGgiLCJzb3J0IiwiYSIsImIiLCJjb21wYXJlRG9jcyIsInNvdXJjZSIsImRpc3RpbmN0RG9jcyIsImRpc3RpbmN0S2V5cyIsIlNldCIsImRvYyIsIl9rZXkiLCJwdXNoIiwiaGFzIiwiYWRkIiwiZmllbGQiLCJwYXRoIiwic3BsaXQiLCJhVmFsdWUiLCJnZXRWYWx1ZSIsImJWYWx1ZSIsImNvbXBhcmlzb24iLCJjb21wYXJlVmFsdWVzIiwiZGlyZWN0aW9uIiwidmFsdWUiLCJwYXRoSW5kZXgiLCJuYW1lIiwiYUhhc1ZhbHVlIiwiYkhhc1ZhbHVlIiwidiIsInNvcnRlZEluZGV4IiwiZmllbGRzIiwidHlwZSIsIm1pc3NpbmdEYXRhQ2FjaGUiLCJyZXNvbHZlIiwiX3ZhbHVlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBaUJPLE1BQU1BLFNBQVMsR0FBRztBQUNyQkMsRUFBQUEsTUFBTSxFQUFFLGVBRGE7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Q0FBVixHQUFlRCxDQUFDLEdBQUdDLENBQUosR0FBUSxDQUFDLENBQVQsR0FBYSxDQUFuQztBQUNIOztBQUdELFNBQVNOLGlCQUFULENBQTJCK0IsQ0FBM0IsRUFBbUM7QUFDL0IsU0FBT0EsQ0FBQyxLQUFLLElBQU4sSUFBYyxPQUFPQSxDQUFQLEtBQWEsV0FBbEM7QUFDSDs7QUFFTSxTQUFTQyxXQUFULENBQXFCQyxNQUFyQixFQUFtRDtBQUN0RCxTQUFPO0FBQUVDLElBQUFBLElBQUksRUFBRSxZQUFSO0FBQXNCRCxJQUFBQTtBQUF0QixHQUFQO0FBQ0g7O0FBRU0sTUFBTUUsZ0JBQTRCLEdBQUc7QUFDeENwQyxFQUFBQSxHQUFHLENBQUNjLElBQUQsRUFBNkI7QUFDNUIsV0FBTzVCLE9BQU8sQ0FBQ21ELE9BQVIsQ0FBZ0IsSUFBaEIsQ0FBUDtBQUNILEdBSHVDOztBQUt4Q25DLEVBQUFBLEdBQUcsQ0FBQ1ksSUFBRCxFQUFld0IsTUFBZixFQUEyQztBQUMxQyxXQUFPcEQsT0FBTyxDQUFDbUQsT0FBUixFQUFQO0FBQ0g7O0FBUHVDLENBQXJDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHR5cGUgeyBPcmRlckJ5IH0gZnJvbSAnLi4vZmlsdGVyL2ZpbHRlcnMnO1xuXG5leHBvcnQgdHlwZSBRSW5kZXhJbmZvID0ge1xuICAgIGZpZWxkczogc3RyaW5nW10sXG4gICAgdHlwZT86IHN0cmluZyxcbn1cblxuXG5leHBvcnQgdHlwZSBRRG9jID0ge1xuICAgIF9rZXk6IHN0cmluZztcbiAgICBbc3RyaW5nXTogYW55O1xufTtcblxuXG5leHBvcnQgdHlwZSBRRGF0YUV2ZW50ID0gJ2luc2VydC91cGRhdGUnIHwgJ2luc2VydCcgfCAndXBkYXRlJztcbmV4cG9ydCBjb25zdCBkYXRhRXZlbnQgPSB7XG4gICAgVVBTRVJUOiAnaW5zZXJ0L3VwZGF0ZScsXG4gICAgSU5TRVJUOiAnaW5zZXJ0JyxcbiAgICBVUERBVEU6ICd1cGRhdGUnLFxufTtcblxuXG5leHBvcnQgaW50ZXJmYWNlIFFEYXRhUHJvdmlkZXIge1xuICAgIHN0YXJ0KGNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlOiBzdHJpbmdbXSk6IHZvaWQ7XG5cbiAgICBnZXRDb2xsZWN0aW9uSW5kZXhlcyhjb2xsZWN0aW9uOiBzdHJpbmcpOiBQcm9taXNlPFFJbmRleEluZm9bXT47XG5cbiAgICBxdWVyeSh0ZXh0OiBzdHJpbmcsIHZhcnM6IHsgW3N0cmluZ106IGFueSB9LCBvcmRlckJ5OiBPcmRlckJ5W10pOiBQcm9taXNlPGFueT47XG5cbiAgICBzdWJzY3JpYmUoY29sbGVjdGlvbjogc3RyaW5nLCBsaXN0ZW5lcjogKGRvYzogYW55LCBldmVudDogUURhdGFFdmVudCkgPT4gdm9pZCk6IGFueTtcblxuICAgIHVuc3Vic2NyaWJlKHN1YnNjcmlwdGlvbjogYW55KTogdm9pZDtcbn1cblxuXG5leHBvcnQgaW50ZXJmYWNlIFFEYXRhQ2FjaGUge1xuICAgIGdldChrZXk6IHN0cmluZyk6IFByb21pc2U8YW55PjtcblxuICAgIHNldChrZXk6IHN0cmluZywgdmFsdWU6IGFueSk6IFByb21pc2U8dm9pZD47XG59XG5cbmV4cG9ydCBjbGFzcyBRRGF0YUNvbWJpbmVyIGltcGxlbWVudHMgUURhdGFQcm92aWRlciB7XG4gICAgcHJvdmlkZXJzOiBRRGF0YVByb3ZpZGVyW107XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm92aWRlcnM6IFFEYXRhUHJvdmlkZXJbXSkge1xuICAgICAgICB0aGlzLnByb3ZpZGVycyA9IHByb3ZpZGVycztcbiAgICB9XG5cbiAgICBzdGFydChjb2xsZWN0aW9uc0ZvclN1YnNjcmliZTogc3RyaW5nW10pOiB2b2lkIHtcbiAgICAgICAgdGhpcy5wcm92aWRlcnMuZm9yRWFjaCgoeCwgaSkgPT4geC5zdGFydChpID09PSAwID8gY29sbGVjdGlvbnNGb3JTdWJzY3JpYmUgOiBbXSkpO1xuICAgIH1cblxuICAgIGdldENvbGxlY3Rpb25JbmRleGVzKGNvbGxlY3Rpb246IHN0cmluZyk6IFByb21pc2U8UUluZGV4SW5mb1tdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3ZpZGVyc1swXS5nZXRDb2xsZWN0aW9uSW5kZXhlcyhjb2xsZWN0aW9uKTtcbiAgICB9XG5cbiAgICBhc3luYyBxdWVyeSh0ZXh0OiBzdHJpbmcsIHZhcnM6IHsgW3N0cmluZ106IGFueSB9LCBvcmRlckJ5OiBPcmRlckJ5W10pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwodGhpcy5wcm92aWRlcnMubWFwKHggPT4geC5xdWVyeSh0ZXh0LCB2YXJzLCBvcmRlckJ5KSkpO1xuICAgICAgICByZXR1cm4gY29tYmluZVJlc3VsdHMocmVzdWx0cywgb3JkZXJCeSk7XG4gICAgfVxuXG4gICAgc3Vic2NyaWJlKGNvbGxlY3Rpb246IHN0cmluZywgbGlzdGVuZXI6IChkb2M6IGFueSwgZXZlbnQ6IFFEYXRhRXZlbnQpID0+IHZvaWQpOiBhbnkge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm92aWRlcnNbMF0uc3Vic2NyaWJlKGNvbGxlY3Rpb24sIGxpc3RlbmVyKTtcbiAgICB9XG5cbiAgICB1bnN1YnNjcmliZShzdWJzY3JpcHRpb246IGFueSk6IHZvaWQge1xuICAgICAgICB0aGlzLnByb3ZpZGVyc1swXS51bnN1YnNjcmliZShzdWJzY3JpcHRpb24pO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFFEYXRhUHJlY2FjaGVkQ29tYmluZXIgZXh0ZW5kcyBRRGF0YUNvbWJpbmVyIHtcbiAgICBjYWNoZTogUURhdGFDYWNoZTtcblxuICAgIGNvbnN0cnVjdG9yKGNhY2hlOiBRRGF0YUNhY2hlLCBwcm92aWRlcnM6IFFEYXRhUHJvdmlkZXJbXSkge1xuICAgICAgICBzdXBlcihwcm92aWRlcnMpO1xuICAgICAgICB0aGlzLmNhY2hlID0gY2FjaGU7XG4gICAgfVxuXG4gICAgYXN5bmMgcXVlcnkodGV4dDogc3RyaW5nLCB2YXJzOiB7IFtzdHJpbmddOiBhbnkgfSwgb3JkZXJCeTogT3JkZXJCeVtdKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3Qga2V5ID0gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgdGV4dDogdGV4dCxcbiAgICAgICAgICAgIHZhcnM6IHZhcnMsXG4gICAgICAgICAgICBvcmRlckJ5OiBvcmRlckJ5LFxuICAgICAgICB9KTtcbiAgICAgICAgbGV0IGRvY3MgPSBhd2FpdCB0aGlzLmNhY2hlLmdldChrZXkpO1xuICAgICAgICBpZiAoaXNOdWxsT3JVbmRlZmluZWQoZG9jcykpIHtcbiAgICAgICAgICAgIGRvY3MgPSBhd2FpdCBzdXBlci5xdWVyeSh0ZXh0LCB2YXJzLCBvcmRlckJ5KTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY2FjaGUuc2V0KGtleSwgZG9jcyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGRvY3M7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBjb21iaW5lUmVzdWx0cyhyZXN1bHRzOiBhbnlbXVtdLCBvcmRlckJ5OiBPcmRlckJ5W10pOiBhbnlbXSB7XG4gICAgY29uc3QgZG9jcyA9IGNvbGxlY3REaXN0aW5jdERvY3MocmVzdWx0cyk7XG4gICAgaWYgKG9yZGVyQnkubGVuZ3RoID4gMCkge1xuICAgICAgICBkb2NzLnNvcnQoKGE6IFFEb2MsIGI6IFFEb2MpID0+IGNvbXBhcmVEb2NzKGEsIGIsIG9yZGVyQnkpKTtcbiAgICB9XG4gICAgcmV0dXJuIGRvY3M7XG59XG5cblxuZnVuY3Rpb24gY29sbGVjdERpc3RpbmN0RG9jcyhzb3VyY2U6IFFEb2NbXVtdKTogUURvY1tdIHtcbiAgICBjb25zdCBkaXN0aW5jdERvY3MgPSAoW106IFFEb2NbXSk7XG4gICAgY29uc3QgZGlzdGluY3RLZXlzID0gbmV3IFNldCgpO1xuICAgIHNvdXJjZS5mb3JFYWNoKChkb2NzKSA9PiB7XG4gICAgICAgIGRvY3MuZm9yRWFjaCgoZG9jKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWRvYy5fa2V5KSB7XG4gICAgICAgICAgICAgICAgZGlzdGluY3REb2NzLnB1c2goZG9jKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWRpc3RpbmN0S2V5cy5oYXMoZG9jLl9rZXkpKSB7XG4gICAgICAgICAgICAgICAgZGlzdGluY3REb2NzLnB1c2goZG9jKTtcbiAgICAgICAgICAgICAgICBkaXN0aW5jdEtleXMuYWRkKGRvYy5fa2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGRpc3RpbmN0RG9jcztcbn1cblxuXG5mdW5jdGlvbiBjb21wYXJlRG9jcyhhOiBRRG9jLCBiOiBRRG9jLCBvcmRlckJ5OiBPcmRlckJ5W10pIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9yZGVyQnkubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgY29uc3QgZmllbGQgPSBvcmRlckJ5W2ldO1xuICAgICAgICBjb25zdCBwYXRoID0gZmllbGQucGF0aC5zcGxpdCgnLicpO1xuICAgICAgICBjb25zdCBhVmFsdWUgPSBnZXRWYWx1ZShhLCBwYXRoLCAwKTtcbiAgICAgICAgY29uc3QgYlZhbHVlID0gZ2V0VmFsdWUoYiwgcGF0aCwgMCk7XG4gICAgICAgIGxldCBjb21wYXJpc29uID0gY29tcGFyZVZhbHVlcyhhVmFsdWUsIGJWYWx1ZSk7XG4gICAgICAgIGlmIChjb21wYXJpc29uICE9PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gZmllbGQuZGlyZWN0aW9uID09PSAnREVTQycgPyAtY29tcGFyaXNvbiA6IGNvbXBhcmlzb247XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIDA7XG59XG5cblxuZnVuY3Rpb24gZ2V0VmFsdWUodmFsdWU6IGFueSwgcGF0aDogc3RyaW5nW10sIHBhdGhJbmRleDogbnVtYmVyKTogYW55IHtcbiAgICBpZiAoaXNOdWxsT3JVbmRlZmluZWQodmFsdWUpIHx8IHBhdGhJbmRleCA+PSBwYXRoLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuICAgIGNvbnN0IG5hbWUgPSBwYXRoW3BhdGhJbmRleF0gPT09ICdpZCcgPyAnX2tleScgOiBwYXRoW3BhdGhJbmRleF07XG4gICAgcmV0dXJuIGdldFZhbHVlKHZhbHVlW25hbWVdLCBwYXRoLCBwYXRoSW5kZXggKyAxKTtcbn1cblxuXG5mdW5jdGlvbiBjb21wYXJlVmFsdWVzKGE6IGFueSwgYjogYW55KTogbnVtYmVyIHtcbiAgICBjb25zdCBhSGFzVmFsdWUgPSAhaXNOdWxsT3JVbmRlZmluZWQoYSk7XG4gICAgY29uc3QgYkhhc1ZhbHVlID0gIWlzTnVsbE9yVW5kZWZpbmVkKGIpO1xuICAgIGlmICghYUhhc1ZhbHVlKSB7XG4gICAgICAgIHJldHVybiBiSGFzVmFsdWUgPyAtMSA6IDA7XG4gICAgfVxuICAgIGlmICghYkhhc1ZhbHVlKSB7XG4gICAgICAgIHJldHVybiAxO1xuICAgIH1cbiAgICByZXR1cm4gYSA9PT0gYiA/IDAgOiAoYSA8IGIgPyAtMSA6IDApO1xufVxuXG5cbmZ1bmN0aW9uIGlzTnVsbE9yVW5kZWZpbmVkKHY6IGFueSkge1xuICAgIHJldHVybiB2ID09PSBudWxsIHx8IHR5cGVvZiB2ID09PSAndW5kZWZpbmVkJztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNvcnRlZEluZGV4KGZpZWxkczogc3RyaW5nW10pOiBRSW5kZXhJbmZvIHtcbiAgICByZXR1cm4geyB0eXBlOiAncGVyc2lzdGVudCcsIGZpZWxkcyB9O1xufVxuXG5leHBvcnQgY29uc3QgbWlzc2luZ0RhdGFDYWNoZTogUURhdGFDYWNoZSA9IHtcbiAgICBnZXQoX2tleTogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcbiAgICB9LFxuXG4gICAgc2V0KF9rZXk6IHN0cmluZywgX3ZhbHVlOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH0sXG59XG5cbiJdfQ==