"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.sortedIndex = sortedIndex;
exports.missingDataCache = exports.QDataPrecachedCombiner = exports.QDataCombiner = exports.dataEvent = void 0;

var _utils = require("../utils");

const dataEvent = {
  UPSERT: 'insert/update',
  INSERT: 'insert',
  UPDATE: 'update'
};
exports.dataEvent = dataEvent;

class QDataCombiner {
  constructor(providers) {
    this.providers = providers;
  }

  async start(collectionsForSubscribe) {
    await Promise.all(this.providers.map((x, i) => x.start(i === 0 ? collectionsForSubscribe : [])));
  }

  getCollectionIndexes(collection) {
    return this.providers[0].getCollectionIndexes(collection);
  }

  async loadFingerprint() {
    /** TODO: remove
     * Do not build fingerprint from a `hot` database (index=0).
     * We make fingerprints about the size of collections only on `cold` storages (index>0).
     * The updated fingerprint will change the cache key and the old keys will be removed using by DataCache itself.
     */
    return await Promise.all(this.providers.map(provider => provider.loadFingerprint()));
  }

  async hotUpdate() {
    await Promise.all(this.providers.map(provider => provider.hotUpdate()));
  }

  async query(text, vars, orderBy) {
    const results = await Promise.all(this.providers.map(x => x.query(text, vars, orderBy)));
    return combineResults(results, orderBy);
  }

  subscribe(collection, listener) {
    return this.providers[0].subscribe(collection, listener);
  }

  unsubscribe(subscription) {
    this.providers[0].unsubscribe(subscription);
  }

}

exports.QDataCombiner = QDataCombiner;

class QDataPrecachedCombiner extends QDataCombiner {
  constructor(log, cache, providers, networkName, cacheKeyPrefix) {
    super(providers);
    this.log = log;
    this.cache = cache;
    this.networkName = networkName;
    this.cacheKeyPrefix = cacheKeyPrefix;
    this.configHash = '';
  }

  async hotUpdate() {
    const fingerprint = JSON.stringify(await this.loadFingerprint());
    this.log.debug('FINGERPRINT', fingerprint);
    this.configHash = (0, _utils.hash)(this.networkName, fingerprint);
    await super.hotUpdate();
  }

  cacheKey(aql) {
    return this.cacheKeyPrefix + (0, _utils.hash)(this.configHash, aql);
  }

  async query(text, vars, orderBy) {
    const aql = JSON.stringify({
      text,
      vars,
      orderBy
    });
    const key = this.cacheKey(aql);
    let docs = await this.cache.get(key);

    if (isNullOrUndefined(docs)) {
      docs = await super.query(text, vars, orderBy);
      await this.cache.set(key, docs);
    }

    return docs;
  }

}

exports.QDataPrecachedCombiner = QDataPrecachedCombiner;

function combineResults(results, orderBy) {
  const docs = collectDistinctDocs(results);

  if (orderBy.length > 0) {
    docs.sort((a, b) => compareDocs(a, b, orderBy));
  }

  return docs;
}

function collectDistinctDocs(source) {
  const distinctDocs = [];
  const distinctKeys = new Set();
  source.forEach(docs => {
    docs.forEach(doc => {
      if (!doc._key) {
        distinctDocs.push(doc);
      } else if (!distinctKeys.has(doc._key)) {
        distinctDocs.push(doc);
        distinctKeys.add(doc._key);
      }
    });
  });
  return distinctDocs;
}

function compareDocs(a, b, orderBy) {
  for (let i = 0; i < orderBy.length; i += 1) {
    const field = orderBy[i];
    const path = field.path.split('.');
    const aValue = getValue(a, path, 0);
    const bValue = getValue(b, path, 0);
    let comparison = compareValues(aValue, bValue);

    if (comparison !== 0) {
      return field.direction === 'DESC' ? -comparison : comparison;
    }
  }

  return 0;
}

function getValue(value, path, pathIndex) {
  if (isNullOrUndefined(value) || pathIndex >= path.length) {
    return value;
  }

  const isCollection = pathIndex === 0;
  const name = isCollection && path[pathIndex] === 'id' ? '_key' : path[pathIndex];
  return getValue(value[name], path, pathIndex + 1);
}

function compareValues(a, b) {
  const aHasValue = !isNullOrUndefined(a);
  const bHasValue = !isNullOrUndefined(b);

  if (!aHasValue) {
    return bHasValue ? -1 : 0;
  }

  if (!bHasValue) {
    return 1;
  }

  return a === b ? 0 : a < b ? -1 : 0;
}

function isNullOrUndefined(v) {
  return v === null || typeof v === 'undefined';
}

function sortedIndex(fields) {
  return {
    type: 'persistent',
    fields
  };
}

const missingDataCache = {
  get(_key) {
    return Promise.resolve(null);
  },

  set(_key, _value) {
    return Promise.resolve();
  }

};
exports.missingDataCache = missingDataCache;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9kYXRhLXByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbImRhdGFFdmVudCIsIlVQU0VSVCIsIklOU0VSVCIsIlVQREFURSIsIlFEYXRhQ29tYmluZXIiLCJjb25zdHJ1Y3RvciIsInByb3ZpZGVycyIsInN0YXJ0IiwiY29sbGVjdGlvbnNGb3JTdWJzY3JpYmUiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwieCIsImkiLCJnZXRDb2xsZWN0aW9uSW5kZXhlcyIsImNvbGxlY3Rpb24iLCJsb2FkRmluZ2VycHJpbnQiLCJwcm92aWRlciIsImhvdFVwZGF0ZSIsInF1ZXJ5IiwidGV4dCIsInZhcnMiLCJvcmRlckJ5IiwicmVzdWx0cyIsImNvbWJpbmVSZXN1bHRzIiwic3Vic2NyaWJlIiwibGlzdGVuZXIiLCJ1bnN1YnNjcmliZSIsInN1YnNjcmlwdGlvbiIsIlFEYXRhUHJlY2FjaGVkQ29tYmluZXIiLCJsb2ciLCJjYWNoZSIsIm5ldHdvcmtOYW1lIiwiY2FjaGVLZXlQcmVmaXgiLCJjb25maWdIYXNoIiwiZmluZ2VycHJpbnQiLCJKU09OIiwic3RyaW5naWZ5IiwiZGVidWciLCJjYWNoZUtleSIsImFxbCIsImtleSIsImRvY3MiLCJnZXQiLCJpc051bGxPclVuZGVmaW5lZCIsInNldCIsImNvbGxlY3REaXN0aW5jdERvY3MiLCJsZW5ndGgiLCJzb3J0IiwiYSIsImIiLCJjb21wYXJlRG9jcyIsInNvdXJjZSIsImRpc3RpbmN0RG9jcyIsImRpc3RpbmN0S2V5cyIsIlNldCIsImZvckVhY2giLCJkb2MiLCJfa2V5IiwicHVzaCIsImhhcyIsImFkZCIsImZpZWxkIiwicGF0aCIsInNwbGl0IiwiYVZhbHVlIiwiZ2V0VmFsdWUiLCJiVmFsdWUiLCJjb21wYXJpc29uIiwiY29tcGFyZVZhbHVlcyIsImRpcmVjdGlvbiIsInZhbHVlIiwicGF0aEluZGV4IiwiaXNDb2xsZWN0aW9uIiwibmFtZSIsImFIYXNWYWx1ZSIsImJIYXNWYWx1ZSIsInYiLCJzb3J0ZWRJbmRleCIsImZpZWxkcyIsInR5cGUiLCJtaXNzaW5nRGF0YUNhY2hlIiwicmVzb2x2ZSIsIl92YWx1ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFHQTs7QUFnQk8sTUFBTUEsU0FBUyxHQUFHO0FBQ3JCQyxFQUFBQSxNQUFNLEVBQUUsZUFEYTtBQUVyQkMsRUFBQUEsTUFBTSxFQUFFLFFBRmE7QUFHckJDLEVBQUFBLE1BQU0sRUFBRTtBQUhhLENBQWxCOzs7QUE4QkEsTUFBTUMsYUFBTixDQUE2QztBQUdoREMsRUFBQUEsV0FBVyxDQUFDQyxTQUFELEVBQTZCO0FBQ3BDLFNBQUtBLFNBQUwsR0FBaUJBLFNBQWpCO0FBQ0g7O0FBRUQsUUFBTUMsS0FBTixDQUFZQyx1QkFBWixFQUE2RDtBQUN6RCxVQUFNQyxPQUFPLENBQUNDLEdBQVIsQ0FBWSxLQUFLSixTQUFMLENBQWVLLEdBQWYsQ0FBbUIsQ0FBQ0MsQ0FBRCxFQUFJQyxDQUFKLEtBQVVELENBQUMsQ0FBQ0wsS0FBRixDQUFRTSxDQUFDLEtBQUssQ0FBTixHQUFVTCx1QkFBVixHQUFvQyxFQUE1QyxDQUE3QixDQUFaLENBQU47QUFDSDs7QUFFRE0sRUFBQUEsb0JBQW9CLENBQUNDLFVBQUQsRUFBNEM7QUFDNUQsV0FBTyxLQUFLVCxTQUFMLENBQWUsQ0FBZixFQUFrQlEsb0JBQWxCLENBQXVDQyxVQUF2QyxDQUFQO0FBQ0g7O0FBRUQsUUFBTUMsZUFBTixHQUFzQztBQUNsQzs7Ozs7QUFLQSxXQUFPLE1BQU1QLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLEtBQUtKLFNBQUwsQ0FBZUssR0FBZixDQUFtQk0sUUFBUSxJQUFJQSxRQUFRLENBQUNELGVBQVQsRUFBL0IsQ0FBWixDQUFiO0FBQ0g7O0FBRUQsUUFBTUUsU0FBTixHQUFnQztBQUM1QixVQUFNVCxPQUFPLENBQUNDLEdBQVIsQ0FBWSxLQUFLSixTQUFMLENBQWVLLEdBQWYsQ0FBbUJNLFFBQVEsSUFBSUEsUUFBUSxDQUFDQyxTQUFULEVBQS9CLENBQVosQ0FBTjtBQUNIOztBQUVELFFBQU1DLEtBQU4sQ0FBWUMsSUFBWixFQUEwQkMsSUFBMUIsRUFBbURDLE9BQW5ELEVBQXFGO0FBQ2pGLFVBQU1DLE9BQU8sR0FBRyxNQUFNZCxPQUFPLENBQUNDLEdBQVIsQ0FBWSxLQUFLSixTQUFMLENBQWVLLEdBQWYsQ0FBbUJDLENBQUMsSUFBSUEsQ0FBQyxDQUFDTyxLQUFGLENBQVFDLElBQVIsRUFBY0MsSUFBZCxFQUFvQkMsT0FBcEIsQ0FBeEIsQ0FBWixDQUF0QjtBQUNBLFdBQU9FLGNBQWMsQ0FBQ0QsT0FBRCxFQUFVRCxPQUFWLENBQXJCO0FBQ0g7O0FBRURHLEVBQUFBLFNBQVMsQ0FBQ1YsVUFBRCxFQUFxQlcsUUFBckIsRUFBMkU7QUFDaEYsV0FBTyxLQUFLcEIsU0FBTCxDQUFlLENBQWYsRUFBa0JtQixTQUFsQixDQUE0QlYsVUFBNUIsRUFBd0NXLFFBQXhDLENBQVA7QUFDSDs7QUFFREMsRUFBQUEsV0FBVyxDQUFDQyxZQUFELEVBQTBCO0FBQ2pDLFNBQUt0QixTQUFMLENBQWUsQ0FBZixFQUFrQnFCLFdBQWxCLENBQThCQyxZQUE5QjtBQUNIOztBQXZDK0M7Ozs7QUEwQzdDLE1BQU1DLHNCQUFOLFNBQXFDekIsYUFBckMsQ0FBbUQ7QUFPdERDLEVBQUFBLFdBQVcsQ0FBQ3lCLEdBQUQsRUFBWUMsS0FBWixFQUErQnpCLFNBQS9CLEVBQTJEMEIsV0FBM0QsRUFBZ0ZDLGNBQWhGLEVBQXdHO0FBQy9HLFVBQU0zQixTQUFOO0FBQ0EsU0FBS3dCLEdBQUwsR0FBV0EsR0FBWDtBQUNBLFNBQUtDLEtBQUwsR0FBYUEsS0FBYjtBQUNBLFNBQUtDLFdBQUwsR0FBbUJBLFdBQW5CO0FBQ0EsU0FBS0MsY0FBTCxHQUFzQkEsY0FBdEI7QUFDQSxTQUFLQyxVQUFMLEdBQWtCLEVBQWxCO0FBQ0g7O0FBRUQsUUFBTWhCLFNBQU4sR0FBZ0M7QUFDNUIsVUFBTWlCLFdBQVcsR0FBR0MsSUFBSSxDQUFDQyxTQUFMLENBQWUsTUFBTSxLQUFLckIsZUFBTCxFQUFyQixDQUFwQjtBQUNBLFNBQUtjLEdBQUwsQ0FBU1EsS0FBVCxDQUFlLGFBQWYsRUFBOEJILFdBQTlCO0FBQ0EsU0FBS0QsVUFBTCxHQUFrQixpQkFBSyxLQUFLRixXQUFWLEVBQXVCRyxXQUF2QixDQUFsQjtBQUNBLFVBQU0sTUFBTWpCLFNBQU4sRUFBTjtBQUNIOztBQUVEcUIsRUFBQUEsUUFBUSxDQUFDQyxHQUFELEVBQXNCO0FBQzFCLFdBQU8sS0FBS1AsY0FBTCxHQUFzQixpQkFBSyxLQUFLQyxVQUFWLEVBQXNCTSxHQUF0QixDQUE3QjtBQUNIOztBQUVELFFBQU1yQixLQUFOLENBQVlDLElBQVosRUFBMEJDLElBQTFCLEVBQW1EQyxPQUFuRCxFQUFxRjtBQUNqRixVQUFNa0IsR0FBRyxHQUFHSixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFFakIsTUFBQUEsSUFBRjtBQUFRQyxNQUFBQSxJQUFSO0FBQWNDLE1BQUFBO0FBQWQsS0FBZixDQUFaO0FBQ0EsVUFBTW1CLEdBQUcsR0FBRyxLQUFLRixRQUFMLENBQWNDLEdBQWQsQ0FBWjtBQUNBLFFBQUlFLElBQUksR0FBRyxNQUFNLEtBQUtYLEtBQUwsQ0FBV1ksR0FBWCxDQUFlRixHQUFmLENBQWpCOztBQUNBLFFBQUlHLGlCQUFpQixDQUFDRixJQUFELENBQXJCLEVBQTZCO0FBQ3pCQSxNQUFBQSxJQUFJLEdBQUcsTUFBTSxNQUFNdkIsS0FBTixDQUFZQyxJQUFaLEVBQWtCQyxJQUFsQixFQUF3QkMsT0FBeEIsQ0FBYjtBQUNBLFlBQU0sS0FBS1MsS0FBTCxDQUFXYyxHQUFYLENBQWVKLEdBQWYsRUFBb0JDLElBQXBCLENBQU47QUFDSDs7QUFDRCxXQUFPQSxJQUFQO0FBQ0g7O0FBcENxRDs7OztBQXVDMUQsU0FBU2xCLGNBQVQsQ0FBd0JELE9BQXhCLEVBQTBDRCxPQUExQyxFQUFxRTtBQUNqRSxRQUFNb0IsSUFBSSxHQUFHSSxtQkFBbUIsQ0FBQ3ZCLE9BQUQsQ0FBaEM7O0FBQ0EsTUFBSUQsT0FBTyxDQUFDeUIsTUFBUixHQUFpQixDQUFyQixFQUF3QjtBQUNwQkwsSUFBQUEsSUFBSSxDQUFDTSxJQUFMLENBQVUsQ0FBQ0MsQ0FBRCxFQUFVQyxDQUFWLEtBQXNCQyxXQUFXLENBQUNGLENBQUQsRUFBSUMsQ0FBSixFQUFPNUIsT0FBUCxDQUEzQztBQUNIOztBQUNELFNBQU9vQixJQUFQO0FBQ0g7O0FBR0QsU0FBU0ksbUJBQVQsQ0FBNkJNLE1BQTdCLEVBQXVEO0FBQ25ELFFBQU1DLFlBQVksR0FBSSxFQUF0QjtBQUNBLFFBQU1DLFlBQVksR0FBRyxJQUFJQyxHQUFKLEVBQXJCO0FBQ0FILEVBQUFBLE1BQU0sQ0FBQ0ksT0FBUCxDQUFnQmQsSUFBRCxJQUFVO0FBQ3JCQSxJQUFBQSxJQUFJLENBQUNjLE9BQUwsQ0FBY0MsR0FBRCxJQUFTO0FBQ2xCLFVBQUksQ0FBQ0EsR0FBRyxDQUFDQyxJQUFULEVBQWU7QUFDWEwsUUFBQUEsWUFBWSxDQUFDTSxJQUFiLENBQWtCRixHQUFsQjtBQUNILE9BRkQsTUFFTyxJQUFJLENBQUNILFlBQVksQ0FBQ00sR0FBYixDQUFpQkgsR0FBRyxDQUFDQyxJQUFyQixDQUFMLEVBQWlDO0FBQ3BDTCxRQUFBQSxZQUFZLENBQUNNLElBQWIsQ0FBa0JGLEdBQWxCO0FBQ0FILFFBQUFBLFlBQVksQ0FBQ08sR0FBYixDQUFpQkosR0FBRyxDQUFDQyxJQUFyQjtBQUNIO0FBQ0osS0FQRDtBQVFILEdBVEQ7QUFVQSxTQUFPTCxZQUFQO0FBQ0g7O0FBR0QsU0FBU0YsV0FBVCxDQUFxQkYsQ0FBckIsRUFBOEJDLENBQTlCLEVBQXVDNUIsT0FBdkMsRUFBMkQ7QUFDdkQsT0FBSyxJQUFJVCxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHUyxPQUFPLENBQUN5QixNQUE1QixFQUFvQ2xDLENBQUMsSUFBSSxDQUF6QyxFQUE0QztBQUN4QyxVQUFNaUQsS0FBSyxHQUFHeEMsT0FBTyxDQUFDVCxDQUFELENBQXJCO0FBQ0EsVUFBTWtELElBQUksR0FBR0QsS0FBSyxDQUFDQyxJQUFOLENBQVdDLEtBQVgsQ0FBaUIsR0FBakIsQ0FBYjtBQUNBLFVBQU1DLE1BQU0sR0FBR0MsUUFBUSxDQUFDakIsQ0FBRCxFQUFJYyxJQUFKLEVBQVUsQ0FBVixDQUF2QjtBQUNBLFVBQU1JLE1BQU0sR0FBR0QsUUFBUSxDQUFDaEIsQ0FBRCxFQUFJYSxJQUFKLEVBQVUsQ0FBVixDQUF2QjtBQUNBLFFBQUlLLFVBQVUsR0FBR0MsYUFBYSxDQUFDSixNQUFELEVBQVNFLE1BQVQsQ0FBOUI7O0FBQ0EsUUFBSUMsVUFBVSxLQUFLLENBQW5CLEVBQXNCO0FBQ2xCLGFBQU9OLEtBQUssQ0FBQ1EsU0FBTixLQUFvQixNQUFwQixHQUE2QixDQUFDRixVQUE5QixHQUEyQ0EsVUFBbEQ7QUFDSDtBQUNKOztBQUNELFNBQU8sQ0FBUDtBQUNIOztBQUdELFNBQVNGLFFBQVQsQ0FBa0JLLEtBQWxCLEVBQThCUixJQUE5QixFQUE4Q1MsU0FBOUMsRUFBc0U7QUFDbEUsTUFBSTVCLGlCQUFpQixDQUFDMkIsS0FBRCxDQUFqQixJQUE0QkMsU0FBUyxJQUFJVCxJQUFJLENBQUNoQixNQUFsRCxFQUEwRDtBQUN0RCxXQUFPd0IsS0FBUDtBQUNIOztBQUNELFFBQU1FLFlBQVksR0FBR0QsU0FBUyxLQUFLLENBQW5DO0FBQ0EsUUFBTUUsSUFBSSxHQUFHRCxZQUFZLElBQUlWLElBQUksQ0FBQ1MsU0FBRCxDQUFKLEtBQW9CLElBQXBDLEdBQTJDLE1BQTNDLEdBQW9EVCxJQUFJLENBQUNTLFNBQUQsQ0FBckU7QUFDQSxTQUFPTixRQUFRLENBQUNLLEtBQUssQ0FBQ0csSUFBRCxDQUFOLEVBQWNYLElBQWQsRUFBb0JTLFNBQVMsR0FBRyxDQUFoQyxDQUFmO0FBQ0g7O0FBR0QsU0FBU0gsYUFBVCxDQUF1QnBCLENBQXZCLEVBQStCQyxDQUEvQixFQUErQztBQUMzQyxRQUFNeUIsU0FBUyxHQUFHLENBQUMvQixpQkFBaUIsQ0FBQ0ssQ0FBRCxDQUFwQztBQUNBLFFBQU0yQixTQUFTLEdBQUcsQ0FBQ2hDLGlCQUFpQixDQUFDTSxDQUFELENBQXBDOztBQUNBLE1BQUksQ0FBQ3lCLFNBQUwsRUFBZ0I7QUFDWixXQUFPQyxTQUFTLEdBQUcsQ0FBQyxDQUFKLEdBQVEsQ0FBeEI7QUFDSDs7QUFDRCxNQUFJLENBQUNBLFNBQUwsRUFBZ0I7QUFDWixXQUFPLENBQVA7QUFDSDs7QUFDRCxTQUFPM0IsQ0FBQyxLQUFLQyxDQUFOLEdBQVUsQ0FBVixHQUFlRCxDQUFDLEdBQUdDLENBQUosR0FBUSxDQUFDLENBQVQsR0FBYSxDQUFuQztBQUNIOztBQUdELFNBQVNOLGlCQUFULENBQTJCaUMsQ0FBM0IsRUFBNEM7QUFDeEMsU0FBT0EsQ0FBQyxLQUFLLElBQU4sSUFBYyxPQUFPQSxDQUFQLEtBQWEsV0FBbEM7QUFDSDs7QUFFTSxTQUFTQyxXQUFULENBQXFCQyxNQUFyQixFQUFtRDtBQUN0RCxTQUFPO0FBQUVDLElBQUFBLElBQUksRUFBRSxZQUFSO0FBQXNCRCxJQUFBQTtBQUF0QixHQUFQO0FBQ0g7O0FBRU0sTUFBTUUsZ0JBQTRCLEdBQUc7QUFDeEN0QyxFQUFBQSxHQUFHLENBQUNlLElBQUQsRUFBNkI7QUFDNUIsV0FBT2pELE9BQU8sQ0FBQ3lFLE9BQVIsQ0FBZ0IsSUFBaEIsQ0FBUDtBQUNILEdBSHVDOztBQUt4Q3JDLEVBQUFBLEdBQUcsQ0FBQ2EsSUFBRCxFQUFleUIsTUFBZixFQUEyQztBQUMxQyxXQUFPMUUsT0FBTyxDQUFDeUUsT0FBUixFQUFQO0FBQ0g7O0FBUHVDLENBQXJDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHR5cGUgeyBPcmRlckJ5IH0gZnJvbSAnLi4vZmlsdGVyL2ZpbHRlcnMnO1xuaW1wb3J0IHsgaGFzaCB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB0eXBlIHsgUUxvZyB9IGZyb20gJy4uL2xvZ3MnO1xuXG5leHBvcnQgdHlwZSBRSW5kZXhJbmZvID0ge1xuICAgIGZpZWxkczogc3RyaW5nW10sXG4gICAgdHlwZT86IHN0cmluZyxcbn1cblxuXG5leHBvcnQgdHlwZSBRRG9jID0ge1xuICAgIF9rZXk6IHN0cmluZztcbiAgICBbc3RyaW5nXTogYW55O1xufTtcblxuXG5leHBvcnQgdHlwZSBRRGF0YUV2ZW50ID0gJ2luc2VydC91cGRhdGUnIHwgJ2luc2VydCcgfCAndXBkYXRlJztcbmV4cG9ydCBjb25zdCBkYXRhRXZlbnQgPSB7XG4gICAgVVBTRVJUOiAnaW5zZXJ0L3VwZGF0ZScsXG4gICAgSU5TRVJUOiAnaW5zZXJ0JyxcbiAgICBVUERBVEU6ICd1cGRhdGUnLFxufTtcblxuXG5leHBvcnQgaW50ZXJmYWNlIFFEYXRhUHJvdmlkZXIge1xuICAgIHN0YXJ0KGNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlOiBzdHJpbmdbXSk6IFByb21pc2U8YW55PjtcblxuICAgIGdldENvbGxlY3Rpb25JbmRleGVzKGNvbGxlY3Rpb246IHN0cmluZyk6IFByb21pc2U8UUluZGV4SW5mb1tdPjtcblxuICAgIGxvYWRGaW5nZXJwcmludCgpOiBQcm9taXNlPGFueT47XG5cbiAgICBob3RVcGRhdGUoKTogUHJvbWlzZTxhbnk+O1xuXG4gICAgcXVlcnkodGV4dDogc3RyaW5nLCB2YXJzOiB7IFtzdHJpbmddOiBhbnkgfSwgb3JkZXJCeTogT3JkZXJCeVtdKTogUHJvbWlzZTxhbnk+O1xuXG4gICAgc3Vic2NyaWJlKGNvbGxlY3Rpb246IHN0cmluZywgbGlzdGVuZXI6IChkb2M6IGFueSwgZXZlbnQ6IFFEYXRhRXZlbnQpID0+IHZvaWQpOiBhbnk7XG5cbiAgICB1bnN1YnNjcmliZShzdWJzY3JpcHRpb246IGFueSk6IHZvaWQ7XG59XG5cblxuZXhwb3J0IGludGVyZmFjZSBRRGF0YUNhY2hlIHtcbiAgICBnZXQoa2V5OiBzdHJpbmcpOiBQcm9taXNlPGFueT47XG5cbiAgICBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpOiBQcm9taXNlPHZvaWQ+O1xufVxuXG5leHBvcnQgY2xhc3MgUURhdGFDb21iaW5lciBpbXBsZW1lbnRzIFFEYXRhUHJvdmlkZXIge1xuICAgIHByb3ZpZGVyczogUURhdGFQcm92aWRlcltdO1xuXG4gICAgY29uc3RydWN0b3IocHJvdmlkZXJzOiBRRGF0YVByb3ZpZGVyW10pIHtcbiAgICAgICAgdGhpcy5wcm92aWRlcnMgPSBwcm92aWRlcnM7XG4gICAgfVxuXG4gICAgYXN5bmMgc3RhcnQoY29sbGVjdGlvbnNGb3JTdWJzY3JpYmU6IHN0cmluZ1tdKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwodGhpcy5wcm92aWRlcnMubWFwKCh4LCBpKSA9PiB4LnN0YXJ0KGkgPT09IDAgPyBjb2xsZWN0aW9uc0ZvclN1YnNjcmliZSA6IFtdKSkpO1xuICAgIH1cblxuICAgIGdldENvbGxlY3Rpb25JbmRleGVzKGNvbGxlY3Rpb246IHN0cmluZyk6IFByb21pc2U8UUluZGV4SW5mb1tdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3ZpZGVyc1swXS5nZXRDb2xsZWN0aW9uSW5kZXhlcyhjb2xsZWN0aW9uKTtcbiAgICB9XG5cbiAgICBhc3luYyBsb2FkRmluZ2VycHJpbnQoKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgLyoqIFRPRE86IHJlbW92ZVxuICAgICAgICAgKiBEbyBub3QgYnVpbGQgZmluZ2VycHJpbnQgZnJvbSBhIGBob3RgIGRhdGFiYXNlIChpbmRleD0wKS5cbiAgICAgICAgICogV2UgbWFrZSBmaW5nZXJwcmludHMgYWJvdXQgdGhlIHNpemUgb2YgY29sbGVjdGlvbnMgb25seSBvbiBgY29sZGAgc3RvcmFnZXMgKGluZGV4PjApLlxuICAgICAgICAgKiBUaGUgdXBkYXRlZCBmaW5nZXJwcmludCB3aWxsIGNoYW5nZSB0aGUgY2FjaGUga2V5IGFuZCB0aGUgb2xkIGtleXMgd2lsbCBiZSByZW1vdmVkIHVzaW5nIGJ5IERhdGFDYWNoZSBpdHNlbGYuXG4gICAgICAgICAqL1xuICAgICAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5hbGwodGhpcy5wcm92aWRlcnMubWFwKHByb3ZpZGVyID0+IHByb3ZpZGVyLmxvYWRGaW5nZXJwcmludCgpKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgaG90VXBkYXRlKCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKHRoaXMucHJvdmlkZXJzLm1hcChwcm92aWRlciA9PiBwcm92aWRlci5ob3RVcGRhdGUoKSkpO1xuICAgIH1cblxuICAgIGFzeW5jIHF1ZXJ5KHRleHQ6IHN0cmluZywgdmFyczogeyBbc3RyaW5nXTogYW55IH0sIG9yZGVyQnk6IE9yZGVyQnlbXSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbCh0aGlzLnByb3ZpZGVycy5tYXAoeCA9PiB4LnF1ZXJ5KHRleHQsIHZhcnMsIG9yZGVyQnkpKSk7XG4gICAgICAgIHJldHVybiBjb21iaW5lUmVzdWx0cyhyZXN1bHRzLCBvcmRlckJ5KTtcbiAgICB9XG5cbiAgICBzdWJzY3JpYmUoY29sbGVjdGlvbjogc3RyaW5nLCBsaXN0ZW5lcjogKGRvYzogYW55LCBldmVudDogUURhdGFFdmVudCkgPT4gdm9pZCk6IGFueSB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3ZpZGVyc1swXS5zdWJzY3JpYmUoY29sbGVjdGlvbiwgbGlzdGVuZXIpO1xuICAgIH1cblxuICAgIHVuc3Vic2NyaWJlKHN1YnNjcmlwdGlvbjogYW55KTogdm9pZCB7XG4gICAgICAgIHRoaXMucHJvdmlkZXJzWzBdLnVuc3Vic2NyaWJlKHN1YnNjcmlwdGlvbik7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgUURhdGFQcmVjYWNoZWRDb21iaW5lciBleHRlbmRzIFFEYXRhQ29tYmluZXIge1xuICAgIGxvZzogUUxvZztcbiAgICBjYWNoZTogUURhdGFDYWNoZTtcbiAgICBuZXR3b3JrTmFtZTogc3RyaW5nO1xuICAgIGNhY2hlS2V5UHJlZml4OiBzdHJpbmc7XG4gICAgY29uZmlnSGFzaDogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IobG9nOiBRTG9nLCBjYWNoZTogUURhdGFDYWNoZSwgcHJvdmlkZXJzOiBRRGF0YVByb3ZpZGVyW10sIG5ldHdvcmtOYW1lOiBzdHJpbmcsIGNhY2hlS2V5UHJlZml4OiBzdHJpbmcpIHtcbiAgICAgICAgc3VwZXIocHJvdmlkZXJzKTtcbiAgICAgICAgdGhpcy5sb2cgPSBsb2c7XG4gICAgICAgIHRoaXMuY2FjaGUgPSBjYWNoZTtcbiAgICAgICAgdGhpcy5uZXR3b3JrTmFtZSA9IG5ldHdvcmtOYW1lO1xuICAgICAgICB0aGlzLmNhY2hlS2V5UHJlZml4ID0gY2FjaGVLZXlQcmVmaXg7XG4gICAgICAgIHRoaXMuY29uZmlnSGFzaCA9ICcnO1xuICAgIH1cblxuICAgIGFzeW5jIGhvdFVwZGF0ZSgpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCBmaW5nZXJwcmludCA9IEpTT04uc3RyaW5naWZ5KGF3YWl0IHRoaXMubG9hZEZpbmdlcnByaW50KCkpO1xuICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnRklOR0VSUFJJTlQnLCBmaW5nZXJwcmludCk7XG4gICAgICAgIHRoaXMuY29uZmlnSGFzaCA9IGhhc2godGhpcy5uZXR3b3JrTmFtZSwgZmluZ2VycHJpbnQpO1xuICAgICAgICBhd2FpdCBzdXBlci5ob3RVcGRhdGUoKTtcbiAgICB9XG5cbiAgICBjYWNoZUtleShhcWw6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmNhY2hlS2V5UHJlZml4ICsgaGFzaCh0aGlzLmNvbmZpZ0hhc2gsIGFxbCk7XG4gICAgfVxuXG4gICAgYXN5bmMgcXVlcnkodGV4dDogc3RyaW5nLCB2YXJzOiB7IFtzdHJpbmddOiBhbnkgfSwgb3JkZXJCeTogT3JkZXJCeVtdKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgYXFsID0gSlNPTi5zdHJpbmdpZnkoeyB0ZXh0LCB2YXJzLCBvcmRlckJ5IH0pO1xuICAgICAgICBjb25zdCBrZXkgPSB0aGlzLmNhY2hlS2V5KGFxbCk7XG4gICAgICAgIGxldCBkb2NzID0gYXdhaXQgdGhpcy5jYWNoZS5nZXQoa2V5KTtcbiAgICAgICAgaWYgKGlzTnVsbE9yVW5kZWZpbmVkKGRvY3MpKSB7XG4gICAgICAgICAgICBkb2NzID0gYXdhaXQgc3VwZXIucXVlcnkodGV4dCwgdmFycywgb3JkZXJCeSk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNhY2hlLnNldChrZXksIGRvY3MpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkb2NzO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gY29tYmluZVJlc3VsdHMocmVzdWx0czogYW55W11bXSwgb3JkZXJCeTogT3JkZXJCeVtdKTogYW55W10ge1xuICAgIGNvbnN0IGRvY3MgPSBjb2xsZWN0RGlzdGluY3REb2NzKHJlc3VsdHMpO1xuICAgIGlmIChvcmRlckJ5Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgZG9jcy5zb3J0KChhOiBRRG9jLCBiOiBRRG9jKSA9PiBjb21wYXJlRG9jcyhhLCBiLCBvcmRlckJ5KSk7XG4gICAgfVxuICAgIHJldHVybiBkb2NzO1xufVxuXG5cbmZ1bmN0aW9uIGNvbGxlY3REaXN0aW5jdERvY3Moc291cmNlOiBRRG9jW11bXSk6IFFEb2NbXSB7XG4gICAgY29uc3QgZGlzdGluY3REb2NzID0gKFtdOiBRRG9jW10pO1xuICAgIGNvbnN0IGRpc3RpbmN0S2V5cyA9IG5ldyBTZXQoKTtcbiAgICBzb3VyY2UuZm9yRWFjaCgoZG9jcykgPT4ge1xuICAgICAgICBkb2NzLmZvckVhY2goKGRvYykgPT4ge1xuICAgICAgICAgICAgaWYgKCFkb2MuX2tleSkge1xuICAgICAgICAgICAgICAgIGRpc3RpbmN0RG9jcy5wdXNoKGRvYyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCFkaXN0aW5jdEtleXMuaGFzKGRvYy5fa2V5KSkge1xuICAgICAgICAgICAgICAgIGRpc3RpbmN0RG9jcy5wdXNoKGRvYyk7XG4gICAgICAgICAgICAgICAgZGlzdGluY3RLZXlzLmFkZChkb2MuX2tleSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiBkaXN0aW5jdERvY3M7XG59XG5cblxuZnVuY3Rpb24gY29tcGFyZURvY3MoYTogUURvYywgYjogUURvYywgb3JkZXJCeTogT3JkZXJCeVtdKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvcmRlckJ5Lmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgIGNvbnN0IGZpZWxkID0gb3JkZXJCeVtpXTtcbiAgICAgICAgY29uc3QgcGF0aCA9IGZpZWxkLnBhdGguc3BsaXQoJy4nKTtcbiAgICAgICAgY29uc3QgYVZhbHVlID0gZ2V0VmFsdWUoYSwgcGF0aCwgMCk7XG4gICAgICAgIGNvbnN0IGJWYWx1ZSA9IGdldFZhbHVlKGIsIHBhdGgsIDApO1xuICAgICAgICBsZXQgY29tcGFyaXNvbiA9IGNvbXBhcmVWYWx1ZXMoYVZhbHVlLCBiVmFsdWUpO1xuICAgICAgICBpZiAoY29tcGFyaXNvbiAhPT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIGZpZWxkLmRpcmVjdGlvbiA9PT0gJ0RFU0MnID8gLWNvbXBhcmlzb24gOiBjb21wYXJpc29uO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiAwO1xufVxuXG5cbmZ1bmN0aW9uIGdldFZhbHVlKHZhbHVlOiBhbnksIHBhdGg6IHN0cmluZ1tdLCBwYXRoSW5kZXg6IG51bWJlcik6IGFueSB7XG4gICAgaWYgKGlzTnVsbE9yVW5kZWZpbmVkKHZhbHVlKSB8fCBwYXRoSW5kZXggPj0gcGF0aC5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgICBjb25zdCBpc0NvbGxlY3Rpb24gPSBwYXRoSW5kZXggPT09IDA7XG4gICAgY29uc3QgbmFtZSA9IGlzQ29sbGVjdGlvbiAmJiBwYXRoW3BhdGhJbmRleF0gPT09ICdpZCcgPyAnX2tleScgOiBwYXRoW3BhdGhJbmRleF07XG4gICAgcmV0dXJuIGdldFZhbHVlKHZhbHVlW25hbWVdLCBwYXRoLCBwYXRoSW5kZXggKyAxKTtcbn1cblxuXG5mdW5jdGlvbiBjb21wYXJlVmFsdWVzKGE6IGFueSwgYjogYW55KTogbnVtYmVyIHtcbiAgICBjb25zdCBhSGFzVmFsdWUgPSAhaXNOdWxsT3JVbmRlZmluZWQoYSk7XG4gICAgY29uc3QgYkhhc1ZhbHVlID0gIWlzTnVsbE9yVW5kZWZpbmVkKGIpO1xuICAgIGlmICghYUhhc1ZhbHVlKSB7XG4gICAgICAgIHJldHVybiBiSGFzVmFsdWUgPyAtMSA6IDA7XG4gICAgfVxuICAgIGlmICghYkhhc1ZhbHVlKSB7XG4gICAgICAgIHJldHVybiAxO1xuICAgIH1cbiAgICByZXR1cm4gYSA9PT0gYiA/IDAgOiAoYSA8IGIgPyAtMSA6IDApO1xufVxuXG5cbmZ1bmN0aW9uIGlzTnVsbE9yVW5kZWZpbmVkKHY6IGFueSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB2ID09PSBudWxsIHx8IHR5cGVvZiB2ID09PSAndW5kZWZpbmVkJztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNvcnRlZEluZGV4KGZpZWxkczogc3RyaW5nW10pOiBRSW5kZXhJbmZvIHtcbiAgICByZXR1cm4geyB0eXBlOiAncGVyc2lzdGVudCcsIGZpZWxkcyB9O1xufVxuXG5leHBvcnQgY29uc3QgbWlzc2luZ0RhdGFDYWNoZTogUURhdGFDYWNoZSA9IHtcbiAgICBnZXQoX2tleTogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcbiAgICB9LFxuXG4gICAgc2V0KF9rZXk6IHN0cmluZywgX3ZhbHVlOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH0sXG59XG4iXX0=