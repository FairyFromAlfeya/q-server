"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.sortedIndex = sortedIndex;
exports.missingDataCache = exports.QDataPrecachedCombiner = exports.QDataCombiner = exports.dataEvent = void 0;

var _utils = require("../utils");

const dataEvent = {
  UPSERT: 'insert/update',
  INSERT: 'insert',
  UPDATE: 'update'
};
exports.dataEvent = dataEvent;

class QDataCombiner {
  constructor(providers) {
    this.providers = providers;
  }

  async start(collectionsForSubscribe) {
    await Promise.all(this.providers.map((x, i) => x.start(i === 0 ? collectionsForSubscribe : [])));
  }

  getCollectionIndexes(collection) {
    return this.providers[0].getCollectionIndexes(collection);
  }

  async loadFingerprint() {
    /** TODO: remove
     * Do not build fingerprint from a `hot` database (index=0).
     * We make fingerprints about the size of collections only on `cold` storages (index>0).
     * The updated fingerprint will change the cache key and the old keys will be removed using by DataCache itself.
     */
    return await Promise.all(this.providers.map(provider => provider.loadFingerprint()));
  }

  async hotUpdate() {
    await Promise.all(this.providers.map(provider => provider.hotUpdate()));
  }

  async query(text, vars, orderBy) {
    const results = await Promise.all(this.providers.map(x => x.query(text, vars, orderBy)));
    return combineResults(results, orderBy);
  }

  subscribe(collection, listener) {
    return this.providers[0].subscribe(collection, listener);
  }

  unsubscribe(subscription) {
    this.providers[0].unsubscribe(subscription);
  }

}

exports.QDataCombiner = QDataCombiner;

class QDataPrecachedCombiner extends QDataCombiner {
  constructor(log, cache, providers, networkName, cacheKeyPrefix) {
    super(providers);
    this.log = log;
    this.cache = cache;
    this.networkName = networkName;
    this.cacheKeyPrefix = cacheKeyPrefix;
    this.configHash = '';
  }

  async hotUpdate() {
    const fingerprint = JSON.stringify(await this.loadFingerprint());
    this.log.debug('FINGERPRINT', fingerprint);
    this.configHash = (0, _utils.hash)(this.networkName, fingerprint);
    await super.hotUpdate();
  }

  cacheKey(aql) {
    return this.cacheKeyPrefix + (0, _utils.hash)(this.configHash, aql);
  }

  async query(text, vars, orderBy) {
    const aql = JSON.stringify({
      text,
      vars,
      orderBy
    });
    const key = this.cacheKey(aql);
    let docs = await this.cache.get(key);

    if (isNullOrUndefined(docs)) {
      docs = await super.query(text, vars, orderBy);
      await this.cache.set(key, docs);
    }

    return docs;
  }

}

exports.QDataPrecachedCombiner = QDataPrecachedCombiner;

function combineResults(results, orderBy) {
  const docs = collectDistinctDocs(results);

  if (orderBy.length > 0) {
    docs.sort((a, b) => compareDocs(a, b, orderBy));
  }

  return docs;
}

function collectDistinctDocs(source) {
  const distinctDocs = [];
  const distinctKeys = new Set();
  source.forEach(docs => {
    docs.forEach(doc => {
      if (!doc._key) {
        distinctDocs.push(doc);
      } else if (!distinctKeys.has(doc._key)) {
        distinctDocs.push(doc);
        distinctKeys.add(doc._key);
      }
    });
  });
  return distinctDocs;
}

function compareDocs(a, b, orderBy) {
  for (let i = 0; i < orderBy.length; i += 1) {
    const field = orderBy[i];
    const path = field.path.split('.');
    const aValue = getValue(a, path, 0);
    const bValue = getValue(b, path, 0);
    let comparison = compareValues(aValue, bValue);

    if (comparison !== 0) {
      return field.direction === 'DESC' ? -comparison : comparison;
    }
  }

  return 0;
}

function getValue(value, path, pathIndex) {
  if (isNullOrUndefined(value) || pathIndex >= path.length) {
    return value;
  }

  const isCollection = pathIndex === 0;
  const name = isCollection && path[pathIndex] === 'id' ? '_key' : path[pathIndex];
  return getValue(value[name], path, pathIndex + 1);
}

function compareValues(a, b) {
  const aHasValue = !isNullOrUndefined(a);
  const bHasValue = !isNullOrUndefined(b);

  if (!aHasValue) {
    return bHasValue ? -1 : 0;
  }

  if (!bHasValue) {
    return 1;
  }

  return a === b ? 0 : a < b ? -1 : 0;
}

function isNullOrUndefined(v) {
  return v === null || typeof v === 'undefined';
}

function sortedIndex(fields) {
  return {
    type: 'persistent',
    fields
  };
}

const missingDataCache = {
  get(_key) {
    return Promise.resolve(null);
  },

  set(_key, _value) {
    return Promise.resolve();
  }

};
exports.missingDataCache = missingDataCache;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9kYXRhLXByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbImRhdGFFdmVudCIsIlVQU0VSVCIsIklOU0VSVCIsIlVQREFURSIsIlFEYXRhQ29tYmluZXIiLCJjb25zdHJ1Y3RvciIsInByb3ZpZGVycyIsInN0YXJ0IiwiY29sbGVjdGlvbnNGb3JTdWJzY3JpYmUiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwieCIsImkiLCJnZXRDb2xsZWN0aW9uSW5kZXhlcyIsImNvbGxlY3Rpb24iLCJsb2FkRmluZ2VycHJpbnQiLCJwcm92aWRlciIsImhvdFVwZGF0ZSIsInF1ZXJ5IiwidGV4dCIsInZhcnMiLCJvcmRlckJ5IiwicmVzdWx0cyIsImNvbWJpbmVSZXN1bHRzIiwic3Vic2NyaWJlIiwibGlzdGVuZXIiLCJ1bnN1YnNjcmliZSIsInN1YnNjcmlwdGlvbiIsIlFEYXRhUHJlY2FjaGVkQ29tYmluZXIiLCJsb2ciLCJjYWNoZSIsIm5ldHdvcmtOYW1lIiwiY2FjaGVLZXlQcmVmaXgiLCJjb25maWdIYXNoIiwiZmluZ2VycHJpbnQiLCJKU09OIiwic3RyaW5naWZ5IiwiZGVidWciLCJjYWNoZUtleSIsImFxbCIsImtleSIsImRvY3MiLCJnZXQiLCJpc051bGxPclVuZGVmaW5lZCIsInNldCIsImNvbGxlY3REaXN0aW5jdERvY3MiLCJsZW5ndGgiLCJzb3J0IiwiYSIsImIiLCJjb21wYXJlRG9jcyIsInNvdXJjZSIsImRpc3RpbmN0RG9jcyIsImRpc3RpbmN0S2V5cyIsIlNldCIsImZvckVhY2giLCJkb2MiLCJfa2V5IiwicHVzaCIsImhhcyIsImFkZCIsImZpZWxkIiwicGF0aCIsInNwbGl0IiwiYVZhbHVlIiwiZ2V0VmFsdWUiLCJiVmFsdWUiLCJjb21wYXJpc29uIiwiY29tcGFyZVZhbHVlcyIsImRpcmVjdGlvbiIsInZhbHVlIiwicGF0aEluZGV4IiwiaXNDb2xsZWN0aW9uIiwibmFtZSIsImFIYXNWYWx1ZSIsImJIYXNWYWx1ZSIsInYiLCJzb3J0ZWRJbmRleCIsImZpZWxkcyIsInR5cGUiLCJtaXNzaW5nRGF0YUNhY2hlIiwicmVzb2x2ZSIsIl92YWx1ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFHQTs7QUFnQk8sTUFBTUEsU0FBUyxHQUFHO0FBQ3JCQyxFQUFBQSxNQUFNLEVBQUUsZUFEYTtBQUVyQkMsRUFBQUEsTUFBTSxFQUFFLFFBRmE7QUFHckJDLEVBQUFBLE1BQU0sRUFBRTtBQUhhLENBQWxCOzs7QUE4QkEsTUFBTUMsYUFBTixDQUE2QztBQUdoREMsRUFBQUEsV0FBVyxDQUFDQyxTQUFELEVBQTZCO0FBQ3BDLFNBQUtBLFNBQUwsR0FBaUJBLFNBQWpCO0FBQ0g7O0FBRVUsUUFBTEMsS0FBSyxDQUFDQyx1QkFBRCxFQUFrRDtBQUN6RCxVQUFNQyxPQUFPLENBQUNDLEdBQVIsQ0FBWSxLQUFLSixTQUFMLENBQWVLLEdBQWYsQ0FBbUIsQ0FBQ0MsQ0FBRCxFQUFJQyxDQUFKLEtBQVVELENBQUMsQ0FBQ0wsS0FBRixDQUFRTSxDQUFDLEtBQUssQ0FBTixHQUFVTCx1QkFBVixHQUFvQyxFQUE1QyxDQUE3QixDQUFaLENBQU47QUFDSDs7QUFFRE0sRUFBQUEsb0JBQW9CLENBQUNDLFVBQUQsRUFBNEM7QUFDNUQsV0FBTyxLQUFLVCxTQUFMLENBQWUsQ0FBZixFQUFrQlEsb0JBQWxCLENBQXVDQyxVQUF2QyxDQUFQO0FBQ0g7O0FBRW9CLFFBQWZDLGVBQWUsR0FBaUI7QUFDbEM7QUFDUjtBQUNBO0FBQ0E7QUFDQTtBQUNRLFdBQU8sTUFBTVAsT0FBTyxDQUFDQyxHQUFSLENBQVksS0FBS0osU0FBTCxDQUFlSyxHQUFmLENBQW1CTSxRQUFRLElBQUlBLFFBQVEsQ0FBQ0QsZUFBVCxFQUEvQixDQUFaLENBQWI7QUFDSDs7QUFFYyxRQUFURSxTQUFTLEdBQWlCO0FBQzVCLFVBQU1ULE9BQU8sQ0FBQ0MsR0FBUixDQUFZLEtBQUtKLFNBQUwsQ0FBZUssR0FBZixDQUFtQk0sUUFBUSxJQUFJQSxRQUFRLENBQUNDLFNBQVQsRUFB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QUFMLEVBQWdCO0FBQ1osV0FBT0MsU0FBUyxHQUFHLENBQUMsQ0FBSixHQUFRLENBQXhCO0FBQ0g7O0FBQ0QsTUFBSSxDQUFDQSxTQUFMLEVBQWdCO0FBQ1osV0FBTyxDQUFQO0FBQ0g7O0FBQ0QsU0FBTzNCLENBQUMsS0FBS0MsQ0FBTixHQUFVLENBQVYsR0FBZUQsQ0FBQyxHQUFHQyxDQUFKLEdBQVEsQ0FBQyxDQUFULEdBQWEsQ0FBbkM7QUFDSDs7QUFHRCxTQUFTTixpQkFBVCxDQUEyQmlDLENBQTNCLEVBQTRDO0FBQ3hDLFNBQU9BLENBQUMsS0FBSyxJQUFOLElBQWMsT0FBT0EsQ0FBUCxLQUFhLFdBQWxDO0FBQ0g7O0FBRU0sU0FBU0MsV0FBVCxDQUFxQkMsTUFBckIsRUFBbUQ7QUFDdEQsU0FBTztBQUFFQyxJQUFBQSxJQUFJLEVBQUUsWUFBUjtBQUFzQkQsSUFBQUE7QUFBdEIsR0FBUDtBQUNIOztBQUVNLE1BQU1FLGdCQUE0QixHQUFHO0FBQ3hDdEMsRUFBQUEsR0FBRyxDQUFDZSxJQUFELEVBQTZCO0FBQzVCLFdBQU9qRCxPQUFPLENBQUN5RSxPQUFSLENBQWdCLElBQWhCLENBQVA7QUFDSCxHQUh1Qzs7QUFLeENyQyxFQUFBQSxHQUFHLENBQUNhLElBQUQsRUFBZXlCLE1BQWYsRUFBMkM7QUFDMUMsV0FBTzFFLE9BQU8sQ0FBQ3lFLE9BQVIsRUFBUDtBQUNIOztBQVB1QyxDQUFyQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB0eXBlIHsgT3JkZXJCeSB9IGZyb20gJy4uL2ZpbHRlci9maWx0ZXJzJztcbmltcG9ydCB7IGhhc2ggfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgdHlwZSB7IFFMb2cgfSBmcm9tICcuLi9sb2dzJztcblxuZXhwb3J0IHR5cGUgUUluZGV4SW5mbyA9IHtcbiAgICBmaWVsZHM6IHN0cmluZ1tdLFxuICAgIHR5cGU/OiBzdHJpbmcsXG59XG5cblxuZXhwb3J0IHR5cGUgUURvYyA9IHtcbiAgICBfa2V5OiBzdHJpbmc7XG4gICAgW3N0cmluZ106IGFueTtcbn07XG5cblxuZXhwb3J0IHR5cGUgUURhdGFFdmVudCA9ICdpbnNlcnQvdXBkYXRlJyB8ICdpbnNlcnQnIHwgJ3VwZGF0ZSc7XG5leHBvcnQgY29uc3QgZGF0YUV2ZW50ID0ge1xuICAgIFVQU0VSVDogJ2luc2VydC91cGRhdGUnLFxuICAgIElOU0VSVDogJ2luc2VydCcsXG4gICAgVVBEQVRFOiAndXBkYXRlJyxcbn07XG5cblxuZXhwb3J0IGludGVyZmFjZSBRRGF0YVByb3ZpZGVyIHtcbiAgICBzdGFydChjb2xsZWN0aW9uc0ZvclN1YnNjcmliZTogc3RyaW5nW10pOiBQcm9taXNlPGFueT47XG5cbiAgICBnZXRDb2xsZWN0aW9uSW5kZXhlcyhjb2xsZWN0aW9uOiBzdHJpbmcpOiBQcm9taXNlPFFJbmRleEluZm9bXT47XG5cbiAgICBsb2FkRmluZ2VycHJpbnQoKTogUHJvbWlzZTxhbnk+O1xuXG4gICAgaG90VXBkYXRlKCk6IFByb21pc2U8YW55PjtcblxuICAgIHF1ZXJ5KHRleHQ6IHN0cmluZywgdmFyczogeyBbc3RyaW5nXTogYW55IH0sIG9yZGVyQnk6IE9yZGVyQnlbXSk6IFByb21pc2U8YW55PjtcblxuICAgIHN1YnNjcmliZShjb2xsZWN0aW9uOiBzdHJpbmcsIGxpc3RlbmVyOiAoZG9jOiBhbnksIGV2ZW50OiBRRGF0YUV2ZW50KSA9PiB2b2lkKTogYW55O1xuXG4gICAgdW5zdWJzY3JpYmUoc3Vic2NyaXB0aW9uOiBhbnkpOiB2b2lkO1xufVxuXG5cbmV4cG9ydCBpbnRlcmZhY2UgUURhdGFDYWNoZSB7XG4gICAgZ2V0KGtleTogc3RyaW5nKTogUHJvbWlzZTxhbnk+O1xuXG4gICAgc2V0KGtleTogc3RyaW5nLCB2YWx1ZTogYW55KTogUHJvbWlzZTx2b2lkPjtcbn1cblxuZXhwb3J0IGNsYXNzIFFEYXRhQ29tYmluZXIgaW1wbGVtZW50cyBRRGF0YVByb3ZpZGVyIHtcbiAgICBwcm92aWRlcnM6IFFEYXRhUHJvdmlkZXJbXTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3ZpZGVyczogUURhdGFQcm92aWRlcltdKSB7XG4gICAgICAgIHRoaXMucHJvdmlkZXJzID0gcHJvdmlkZXJzO1xuICAgIH1cblxuICAgIGFzeW5jIHN0YXJ0KGNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlOiBzdHJpbmdbXSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKHRoaXMucHJvdmlkZXJzLm1hcCgoeCwgaSkgPT4geC5zdGFydChpID09PSAwID8gY29sbGVjdGlvbnNGb3JTdWJzY3JpYmUgOiBbXSkpKTtcbiAgICB9XG5cbiAgICBnZXRDb2xsZWN0aW9uSW5kZXhlcyhjb2xsZWN0aW9uOiBzdHJpbmcpOiBQcm9taXNlPFFJbmRleEluZm9bXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm92aWRlcnNbMF0uZ2V0Q29sbGVjdGlvbkluZGV4ZXMoY29sbGVjdGlvbik7XG4gICAgfVxuXG4gICAgYXN5bmMgbG9hZEZpbmdlcnByaW50KCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIC8qKiBUT0RPOiByZW1vdmVcbiAgICAgICAgICogRG8gbm90IGJ1aWxkIGZpbmdlcnByaW50IGZyb20gYSBgaG90YCBkYXRhYmFzZSAoaW5kZXg9MCkuXG4gICAgICAgICAqIFdlIG1ha2UgZmluZ2VycHJpbnRzIGFib3V0IHRoZSBzaXplIG9mIGNvbGxlY3Rpb25zIG9ubHkgb24gYGNvbGRgIHN0b3JhZ2VzIChpbmRleD4wKS5cbiAgICAgICAgICogVGhlIHVwZGF0ZWQgZmluZ2VycHJpbnQgd2lsbCBjaGFuZ2UgdGhlIGNhY2hlIGtleSBhbmQgdGhlIG9sZCBrZXlzIHdpbGwgYmUgcmVtb3ZlZCB1c2luZyBieSBEYXRhQ2FjaGUgaXRzZWxmLlxuICAgICAgICAgKi9cbiAgICAgICAgcmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKHRoaXMucHJvdmlkZXJzLm1hcChwcm92aWRlciA9PiBwcm92aWRlci5sb2FkRmluZ2VycHJpbnQoKSkpO1xuICAgIH1cblxuICAgIGFzeW5jIGhvdFVwZGF0ZSgpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbCh0aGlzLnByb3ZpZGVycy5tYXAocHJvdmlkZXIgPT4gcHJvdmlkZXIuaG90VXBkYXRlKCkpKTtcbiAgICB9XG5cbiAgICBhc3luYyBxdWVyeSh0ZXh0OiBzdHJpbmcsIHZhcnM6IHsgW3N0cmluZ106IGFueSB9LCBvcmRlckJ5OiBPcmRlckJ5W10pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwodGhpcy5wcm92aWRlcnMubWFwKHggPT4geC5xdWVyeSh0ZXh0LCB2YXJzLCBvcmRlckJ5KSkpO1xuICAgICAgICByZXR1cm4gY29tYmluZVJlc3VsdHMocmVzdWx0cywgb3JkZXJCeSk7XG4gICAgfVxuXG4gICAgc3Vic2NyaWJlKGNvbGxlY3Rpb246IHN0cmluZywgbGlzdGVuZXI6IChkb2M6IGFueSwgZXZlbnQ6IFFEYXRhRXZlbnQpID0+IHZvaWQpOiBhbnkge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm92aWRlcnNbMF0uc3Vic2NyaWJlKGNvbGxlY3Rpb24sIGxpc3RlbmVyKTtcbiAgICB9XG5cbiAgICB1bnN1YnNjcmliZShzdWJzY3JpcHRpb246IGFueSk6IHZvaWQge1xuICAgICAgICB0aGlzLnByb3ZpZGVyc1swXS51bnN1YnNjcmliZShzdWJzY3JpcHRpb24pO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFFEYXRhUHJlY2FjaGVkQ29tYmluZXIgZXh0ZW5kcyBRRGF0YUNvbWJpbmVyIHtcbiAgICBsb2c6IFFMb2c7XG4gICAgY2FjaGU6IFFEYXRhQ2FjaGU7XG4gICAgbmV0d29ya05hbWU6IHN0cmluZztcbiAgICBjYWNoZUtleVByZWZpeDogc3RyaW5nO1xuICAgIGNvbmZpZ0hhc2g6IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKGxvZzogUUxvZywgY2FjaGU6IFFEYXRhQ2FjaGUsIHByb3ZpZGVyczogUURhdGFQcm92aWRlcltdLCBuZXR3b3JrTmFtZTogc3RyaW5nLCBjYWNoZUtleVByZWZpeDogc3RyaW5nKSB7XG4gICAgICAgIHN1cGVyKHByb3ZpZGVycyk7XG4gICAgICAgIHRoaXMubG9nID0gbG9nO1xuICAgICAgICB0aGlzLmNhY2hlID0gY2FjaGU7XG4gICAgICAgIHRoaXMubmV0d29ya05hbWUgPSBuZXR3b3JrTmFtZTtcbiAgICAgICAgdGhpcy5jYWNoZUtleVByZWZpeCA9IGNhY2hlS2V5UHJlZml4O1xuICAgICAgICB0aGlzLmNvbmZpZ0hhc2ggPSAnJztcbiAgICB9XG5cbiAgICBhc3luYyBob3RVcGRhdGUoKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgZmluZ2VycHJpbnQgPSBKU09OLnN0cmluZ2lmeShhd2FpdCB0aGlzLmxvYWRGaW5nZXJwcmludCgpKTtcbiAgICAgICAgdGhpcy5sb2cuZGVidWcoJ0ZJTkdFUlBSSU5UJywgZmluZ2VycHJpbnQpO1xuICAgICAgICB0aGlzLmNvbmZpZ0hhc2ggPSBoYXNoKHRoaXMubmV0d29ya05hbWUsIGZpbmdlcnByaW50KTtcbiAgICAgICAgYXdhaXQgc3VwZXIuaG90VXBkYXRlKCk7XG4gICAgfVxuXG4gICAgY2FjaGVLZXkoYXFsOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5jYWNoZUtleVByZWZpeCArIGhhc2godGhpcy5jb25maWdIYXNoLCBhcWwpO1xuICAgIH1cblxuICAgIGFzeW5jIHF1ZXJ5KHRleHQ6IHN0cmluZywgdmFyczogeyBbc3RyaW5nXTogYW55IH0sIG9yZGVyQnk6IE9yZGVyQnlbXSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IGFxbCA9IEpTT04uc3RyaW5naWZ5KHsgdGV4dCwgdmFycywgb3JkZXJCeSB9KTtcbiAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5jYWNoZUtleShhcWwpO1xuICAgICAgICBsZXQgZG9jcyA9IGF3YWl0IHRoaXMuY2FjaGUuZ2V0KGtleSk7XG4gICAgICAgIGlmIChpc051bGxPclVuZGVmaW5lZChkb2NzKSkge1xuICAgICAgICAgICAgZG9jcyA9IGF3YWl0IHN1cGVyLnF1ZXJ5KHRleHQsIHZhcnMsIG9yZGVyQnkpO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5jYWNoZS5zZXQoa2V5LCBkb2NzKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZG9jcztcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGNvbWJpbmVSZXN1bHRzKHJlc3VsdHM6IGFueVtdW10sIG9yZGVyQnk6IE9yZGVyQnlbXSk6IGFueVtdIHtcbiAgICBjb25zdCBkb2NzID0gY29sbGVjdERpc3RpbmN0RG9jcyhyZXN1bHRzKTtcbiAgICBpZiAob3JkZXJCeS5sZW5ndGggPiAwKSB7XG4gICAgICAgIGRvY3Muc29ydCgoYTogUURvYywgYjogUURvYykgPT4gY29tcGFyZURvY3MoYSwgYiwgb3JkZXJCeSkpO1xuICAgIH1cbiAgICByZXR1cm4gZG9jcztcbn1cblxuXG5mdW5jdGlvbiBjb2xsZWN0RGlzdGluY3REb2NzKHNvdXJjZTogUURvY1tdW10pOiBRRG9jW10ge1xuICAgIGNvbnN0IGRpc3RpbmN0RG9jcyA9IChbXTogUURvY1tdKTtcbiAgICBjb25zdCBkaXN0aW5jdEtleXMgPSBuZXcgU2V0KCk7XG4gICAgc291cmNlLmZvckVhY2goKGRvY3MpID0+IHtcbiAgICAgICAgZG9jcy5mb3JFYWNoKChkb2MpID0+IHtcbiAgICAgICAgICAgIGlmICghZG9jLl9rZXkpIHtcbiAgICAgICAgICAgICAgICBkaXN0aW5jdERvY3MucHVzaChkb2MpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICghZGlzdGluY3RLZXlzLmhhcyhkb2MuX2tleSkpIHtcbiAgICAgICAgICAgICAgICBkaXN0aW5jdERvY3MucHVzaChkb2MpO1xuICAgICAgICAgICAgICAgIGRpc3RpbmN0S2V5cy5hZGQoZG9jLl9rZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gZGlzdGluY3REb2NzO1xufVxuXG5cbmZ1bmN0aW9uIGNvbXBhcmVEb2NzKGE6IFFEb2MsIGI6IFFEb2MsIG9yZGVyQnk6IE9yZGVyQnlbXSkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3JkZXJCeS5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICBjb25zdCBmaWVsZCA9IG9yZGVyQnlbaV07XG4gICAgICAgIGNvbnN0IHBhdGggPSBmaWVsZC5wYXRoLnNwbGl0KCcuJyk7XG4gICAgICAgIGNvbnN0IGFWYWx1ZSA9IGdldFZhbHVlKGEsIHBhdGgsIDApO1xuICAgICAgICBjb25zdCBiVmFsdWUgPSBnZXRWYWx1ZShiLCBwYXRoLCAwKTtcbiAgICAgICAgbGV0IGNvbXBhcmlzb24gPSBjb21wYXJlVmFsdWVzKGFWYWx1ZSwgYlZhbHVlKTtcbiAgICAgICAgaWYgKGNvbXBhcmlzb24gIT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBmaWVsZC5kaXJlY3Rpb24gPT09ICdERVNDJyA/IC1jb21wYXJpc29uIDogY29tcGFyaXNvbjtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gMDtcbn1cblxuXG5mdW5jdGlvbiBnZXRWYWx1ZSh2YWx1ZTogYW55LCBwYXRoOiBzdHJpbmdbXSwgcGF0aEluZGV4OiBudW1iZXIpOiBhbnkge1xuICAgIGlmIChpc051bGxPclVuZGVmaW5lZCh2YWx1ZSkgfHwgcGF0aEluZGV4ID49IHBhdGgubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG4gICAgY29uc3QgaXNDb2xsZWN0aW9uID0gcGF0aEluZGV4ID09PSAwO1xuICAgIGNvbnN0IG5hbWUgPSBpc0NvbGxlY3Rpb24gJiYgcGF0aFtwYXRoSW5kZXhdID09PSAnaWQnID8gJ19rZXknIDogcGF0aFtwYXRoSW5kZXhdO1xuICAgIHJldHVybiBnZXRWYWx1ZSh2YWx1ZVtuYW1lXSwgcGF0aCwgcGF0aEluZGV4ICsgMSk7XG59XG5cblxuZnVuY3Rpb24gY29tcGFyZVZhbHVlcyhhOiBhbnksIGI6IGFueSk6IG51bWJlciB7XG4gICAgY29uc3QgYUhhc1ZhbHVlID0gIWlzTnVsbE9yVW5kZWZpbmVkKGEpO1xuICAgIGNvbnN0IGJIYXNWYWx1ZSA9ICFpc051bGxPclVuZGVmaW5lZChiKTtcbiAgICBpZiAoIWFIYXNWYWx1ZSkge1xuICAgICAgICByZXR1cm4gYkhhc1ZhbHVlID8gLTEgOiAwO1xuICAgIH1cbiAgICBpZiAoIWJIYXNWYWx1ZSkge1xuICAgICAgICByZXR1cm4gMTtcbiAgICB9XG4gICAgcmV0dXJuIGEgPT09IGIgPyAwIDogKGEgPCBiID8gLTEgOiAwKTtcbn1cblxuXG5mdW5jdGlvbiBpc051bGxPclVuZGVmaW5lZCh2OiBhbnkpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdiA9PT0gbnVsbCB8fCB0eXBlb2YgdiA9PT0gJ3VuZGVmaW5lZCc7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzb3J0ZWRJbmRleChmaWVsZHM6IHN0cmluZ1tdKTogUUluZGV4SW5mbyB7XG4gICAgcmV0dXJuIHsgdHlwZTogJ3BlcnNpc3RlbnQnLCBmaWVsZHMgfTtcbn1cblxuZXhwb3J0IGNvbnN0IG1pc3NpbmdEYXRhQ2FjaGU6IFFEYXRhQ2FjaGUgPSB7XG4gICAgZ2V0KF9rZXk6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobnVsbCk7XG4gICAgfSxcblxuICAgIHNldChfa2V5OiBzdHJpbmcsIF92YWx1ZTogYW55KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9LFxufVxuIl19