"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.isFastQuery = isFastQuery;

var _dataTypes = require("./data-types");

function setIs1(s, a) {
  return s.size === 1 && s.has(a);
}

function setIs2(s, a, b) {
  return s.size === 2 && s.has(a) && s.has(b);
}

function canUseIndexedRange(ops) {
  return setIs1(ops, '==') || setIs1(ops, '!=') || setIs1(ops, '>') || setIs2(ops, '>', '<') || setIs2(ops, '>', '<=') || setIs1(ops, '>=') || setIs2(ops, '>=', '<') || setIs2(ops, '>=', '<=') || setIs1(ops, '<') || setIs1(ops, '<=');
}

function canUseConditionsForIndexedRange(fields) {
  for (const explanation of fields.values()) {
    if (!canUseIndexedRange(explanation.operations)) {
      return false;
    }
  }

  return true;
}

function fieldsCanUseIndex(fields, index) {
  if (fields.size > index.fields.length) {
    return false;
  }

  for (let i = 0; i < fields.size; i += 1) {
    if (!fields.has(index.fields[i])) {
      return false;
    }
  }

  return true;
}

function getUsedIndexes(fields, collection) {
  const indexes = collection.indexes.filter(x => fieldsCanUseIndex(fields, x));
  return indexes.length > 0 ? indexes : null;
}

function orderByCanUseIndex(orderBy, fields, index) {
  if (orderBy.length === 0) {
    return true;
  }

  let iOrderBy = 0;

  for (let iIndex = 0; iIndex < index.fields.length; iIndex += 1) {
    const indexField = index.fields[iIndex];

    if (indexField === orderBy[iOrderBy].path) {
      iOrderBy += 1;

      if (iOrderBy >= orderBy.length) {
        return true;
      }
    } else {
      if (iOrderBy > 0) {
        return false;
      }

      const field = fields.get(indexField);

      if (!field) {
        return false;
      }

      if (!setIs1(field.operations, '==')) {
        return false;
      }
    }
  }

  return true;
}

function orderByCanUseAllIndexes(orderBy, fields, indexes) {
  for (let i = 0; i < indexes.length; i += 1) {
    if (!orderByCanUseIndex(orderBy, fields, indexes[i])) {
      return false;
    }
  }

  return indexes.length > 0;
}

function orderByCanUseAnyIndex(orderBy, fields, indexes) {
  for (let i = 0; i < indexes.length; i += 1) {
    if (orderByCanUseIndex(orderBy, fields, indexes[i])) {
      return true;
    }
  }

  return false;
}

function hasKeyEq(fields) {
  const key = fields.get('_key');
  return !!(key && setIs1(key.operations, '=='));
}

function logSlowReason(message, log, filter, orderBy, fields, collection, selectedIndexes) {
  const logFields = [];

  for (const [name, explanation] of fields.entries()) {
    logFields.push(`${name} ${Array.from(explanation.operations).join(' AND ')}`);
  }

  log.debug(message, {
    collection: collection.name,
    filter,
    orderBy: (0, _dataTypes.orderByToString)(orderBy),
    fields: logFields,
    ...(selectedIndexes ? {
      selectedIndexes: selectedIndexes.map(_dataTypes.indexToString)
    } : {}),
    availableIndexes: collection.indexes.map(_dataTypes.indexToString)
  });
}

function isFastQueryOrOperand(collection, type, filter, orderBy, log) {
  const params = new _dataTypes.QParams({
    explain: true
  });
  type.filterCondition(params, '', filter);

  if (!params.explanation) {
    return false;
  }

  const fields = new Map();

  for (const [field, explanation] of params.explanation.fields) {
    if (field !== 'status') {
      fields.set(field, explanation);
    }
  }

  if (hasKeyEq(fields)) {
    return true;
  }

  if (!canUseConditionsForIndexedRange(fields)) {
    if (log) {
      logSlowReason('Filter operations can\'t be used in ranged queries', log, filter, orderBy, fields, collection);
    }

    return false;
  }

  const indexes = getUsedIndexes(fields, collection);

  if (!indexes) {
    if (log) {
      logSlowReason('Available indexes can\'t be used for filter fields', log, filter, orderBy, fields, collection);
    }

    return false;
  }

  if (orderBy.length > 0) {
    if (!orderByCanUseAnyIndex(orderBy, fields, indexes)) {
      if (log) {
        logSlowReason('Order by can\'t use any selected index', log, filter, orderBy, fields, collection, indexes);
      }

      return false;
    }
  }

  return true;
}

function isFastQuery(collection, type, filter, orderBy, log) {
  const orOperands = (0, _dataTypes.splitOr)(filter);

  for (let i = 0; i < orOperands.length; i += 1) {
    if (!isFastQueryOrOperand(collection, type, orOperands[i], orderBy, log)) {
      return false;
    }
  }

  return true;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZmlsdGVyL3Nsb3ctZGV0ZWN0b3IuanMiXSwibmFtZXMiOlsic2V0SXMxIiwicyIsImEiLCJzaXplIiwiaGFzIiwic2V0SXMyIiwiYiIsImNhblVzZUluZGV4ZWRSYW5nZSIsIm9wcyIsImNhblVzZUNvbmRpdGlvbnNGb3JJbmRleGVkUmFuZ2UiLCJmaWVsZHMiLCJleHBsYW5hdGlvbiIsInZhbHVlcyIsIm9wZXJhdGlvbnMiLCJmaWVsZHNDYW5Vc2VJbmRleCIsImluZGV4IiwibGVuZ3RoIiwiaSIsImdldFVzZWRJbmRleGVzIiwiY29sbGVjdGlvbiIsImluZGV4ZXMiLCJmaWx0ZXIiLCJ4Iiwib3JkZXJCeUNhblVzZUluZGV4Iiwib3JkZXJCeSIsImlPcmRlckJ5IiwiaUluZGV4IiwiaW5kZXhGaWVsZCIsInBhdGgiLCJmaWVsZCIsImdldCIsIm9yZGVyQnlDYW5Vc2VBbGxJbmRleGVzIiwib3JkZXJCeUNhblVzZUFueUluZGV4IiwiaGFzS2V5RXEiLCJrZXkiLCJsb2dTbG93UmVhc29uIiwibWVzc2FnZSIsImxvZyIsInNlbGVjdGVkSW5kZXhlcyIsImxvZ0ZpZWxkcyIsIm5hbWUiLCJlbnRyaWVzIiwicHVzaCIsIkFycmF5IiwiZnJvbSIsImpvaW4iLCJkZWJ1ZyIsIm1hcCIsImluZGV4VG9TdHJpbmciLCJhdmFpbGFibGVJbmRleGVzIiwiaXNGYXN0UXVlcnlPck9wZXJhbmQiLCJ0eXBlIiwicGFyYW1zIiwiUVBhcmFtcyIsImV4cGxhaW4iLCJmaWx0ZXJDb25kaXRpb24iLCJNYXAiLCJzZXQiLCJpc0Zhc3RRdWVyeSIsIm9yT3BlcmFuZHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFLQTs7QUFJQSxTQUFTQSxNQUFULENBQWdCQyxDQUFoQixFQUFnQ0MsQ0FBaEMsRUFBb0Q7QUFDaEQsU0FBT0QsQ0FBQyxDQUFDRSxJQUFGLEtBQVcsQ0FBWCxJQUFnQkYsQ0FBQyxDQUFDRyxHQUFGLENBQU1GLENBQU4sQ0FBdkI7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ZSB7Q29sbGVjdGlvbkluZm99IGZyb20gXCIuLi9jb25maWdcIjtcbmltcG9ydCB0eXBlIHsgUUluZGV4SW5mbyB9IGZyb20gJy4uL2RhdGEvZGF0YS1wcm92aWRlcic7XG5pbXBvcnQge2luZGV4VG9TdHJpbmcsIG9yZGVyQnlUb1N0cmluZywgUVBhcmFtcywgc3BsaXRPcn0gZnJvbSBcIi4vZGF0YS10eXBlc1wiO1xuaW1wb3J0IHR5cGUge09yZGVyQnksIFFGaWVsZEV4cGxhbmF0aW9uLCBRVHlwZX0gZnJvbSBcIi4vZGF0YS10eXBlc1wiO1xuaW1wb3J0IHR5cGUge1FMb2d9IGZyb20gJy4uL2xvZ3MnO1xuXG5mdW5jdGlvbiBzZXRJczEoczogU2V0PHN0cmluZz4sIGE6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBzLnNpemUgPT09IDEgJiYgcy5oYXMoYSk7XG59XG5cbmZ1bmN0aW9uIHNldElzMihzOiBTZXQ8c3RyaW5nPiwgYTogc3RyaW5nLCBiOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gcy5zaXplID09PSAyICYmIHMuaGFzKGEpICYmIHMuaGFzKGIpO1xufVxuXG5mdW5jdGlvbiBjYW5Vc2VJbmRleGVkUmFuZ2Uob3BzOiBTZXQ8c3RyaW5nPik6IGJvb2xlYW4ge1xuICAgIHJldHVybiBzZXRJczEob3BzLCAnPT0nKVxuICAgICAgICB8fCBzZXRJczEob3BzLCAnIT0nKVxuICAgICAgICB8fCBzZXRJczEob3BzLCAnPicpXG4gICAgICAgIHx8IHNldElzMihvcHMsICc+JywgJzwnKVxuICAgICAgICB8fCBzZXRJczIob3BzLCAnPicsICc8PScpXG4gICAgICAgIHx8IHNldElzMShvcHMsICc+PScpXG4gICAgICAgIHx8IHNldElzMihvcHMsICc+PScsICc8JylcbiAgICAgICAgfHwgc2V0SXMyKG9wcywgJz49JywgJzw9JylcbiAgICAgICAgfHwgc2V0SXMxKG9wcywgJzwnKVxuICAgICAgICB8fCBzZXRJczEob3BzLCAnPD0nKTtcbn1cblxuZnVuY3Rpb24gY2FuVXNlQ29uZGl0aW9uc0ZvckluZGV4ZWRSYW5nZShmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPik6IGJvb2xlYW4ge1xuICAgIGZvciAoY29uc3QgZXhwbGFuYXRpb24gb2YgZmllbGRzLnZhbHVlcygpKSB7XG4gICAgICAgIGlmICghY2FuVXNlSW5kZXhlZFJhbmdlKGV4cGxhbmF0aW9uLm9wZXJhdGlvbnMpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG59XG5cbmZ1bmN0aW9uIGZpZWxkc0NhblVzZUluZGV4KGZpZWxkczogTWFwPHN0cmluZywgUUZpZWxkRXhwbGFuYXRpb24+LCBpbmRleDogUUluZGV4SW5mbyk6IGJvb2xlYW4ge1xuICAgIGlmIChmaWVsZHMuc2l6ZSA+IGluZGV4LmZpZWxkcy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpZWxkcy5zaXplOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKCFmaWVsZHMuaGFzKGluZGV4LmZpZWxkc1tpXSkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbn1cblxuZnVuY3Rpb24gZ2V0VXNlZEluZGV4ZXMoZmllbGRzOiBNYXA8c3RyaW5nLCBRRmllbGRFeHBsYW5hdGlvbj4sIGNvbGxlY3Rpb246IENvbGxlY3Rpb25JbmZvKTogPyhRSW5kZXhJbmZvW10pIHtcbiAgICBjb25zdCBpbmRleGVzID0gY29sbGVjdGlvbi5pbmRleGVzLmZpbHRlcih4ID0+IGZpZWxkc0NhblVzZUluZGV4KGZpZWxkcywgeCkpO1xuICAgIHJldHVybiBpbmRleGVzLmxlbmd0aCA+IDAgPyBpbmRleGVzIDogbnVsbDtcbn1cblxuZnVuY3Rpb24gb3JkZXJCeUNhblVzZUluZGV4KFxuICAgIG9yZGVyQnk6IE9yZGVyQnlbXSxcbiAgICBmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPixcbiAgICBpbmRleDogUUluZGV4SW5mbyxcbik6IGJvb2xlYW4ge1xuICAgIGlmIChvcmRlckJ5Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgbGV0IGlPcmRlckJ5ID0gMDtcbiAgICBmb3IgKGxldCBpSW5kZXggPSAwOyBpSW5kZXggPCBpbmRleC5maWVsZHMubGVuZ3RoOyBpSW5kZXggKz0gMSkge1xuICAgICAgICBjb25zdCBpbmRleEZpZWxkID0gaW5kZXguZmllbGRzW2lJbmRleF07XG4gICAgICAgIGlmIChpbmRleEZpZWxkID09PSBvcmRlckJ5W2lPcmRlckJ5XS5wYXRoKSB7XG4gICAgICAgICAgICBpT3JkZXJCeSArPSAxO1xuICAgICAgICAgICAgaWYgKGlPcmRlckJ5ID49IG9yZGVyQnkubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoaU9yZGVyQnkgPiAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgZmllbGQgPSBmaWVsZHMuZ2V0KGluZGV4RmllbGQpO1xuICAgICAgICAgICAgaWYgKCFmaWVsZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghc2V0SXMxKGZpZWxkLm9wZXJhdGlvbnMsICc9PScpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xufVxuXG5mdW5jdGlvbiBvcmRlckJ5Q2FuVXNlQWxsSW5kZXhlcyhcbiAgICBvcmRlckJ5OiBPcmRlckJ5W10sXG4gICAgZmllbGRzOiBNYXA8c3RyaW5nLCBRRmllbGRFeHBsYW5hdGlvbj4sXG4gICAgaW5kZXhlczogUUluZGV4SW5mb1tdLFxuKTogYm9vbGVhbiB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRleGVzLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgIGlmICghb3JkZXJCeUNhblVzZUluZGV4KG9yZGVyQnksIGZpZWxkcywgaW5kZXhlc1tpXSkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gaW5kZXhlcy5sZW5ndGggPiAwO1xufVxuXG5mdW5jdGlvbiBvcmRlckJ5Q2FuVXNlQW55SW5kZXgoXG4gICAgb3JkZXJCeTogT3JkZXJCeVtdLFxuICAgIGZpZWxkczogTWFwPHN0cmluZywgUUZpZWxkRXhwbGFuYXRpb24+LFxuICAgIGluZGV4ZXM6IFFJbmRleEluZm9bXSxcbik6IGJvb2xlYW4ge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXhlcy5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICBpZiAob3JkZXJCeUNhblVzZUluZGV4KG9yZGVyQnksIGZpZWxkcywgaW5kZXhlc1tpXSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn1cblxuZnVuY3Rpb24gaGFzS2V5RXEoZmllbGRzOiBNYXA8c3RyaW5nLCBRRmllbGRFeHBsYW5hdGlvbj4pOiBib29sZWFuIHtcbiAgICBjb25zdCBrZXkgPSBmaWVsZHMuZ2V0KCdfa2V5Jyk7XG4gICAgcmV0dXJuICEhKGtleSAmJiBzZXRJczEoa2V5Lm9wZXJhdGlvbnMsICc9PScpKTtcbn1cblxuZnVuY3Rpb24gbG9nU2xvd1JlYXNvbihcbiAgICBtZXNzYWdlOiBzdHJpbmcsXG4gICAgbG9nOiBRTG9nLFxuICAgIGZpbHRlcjogYW55LFxuICAgIG9yZGVyQnk6IE9yZGVyQnlbXSxcbiAgICBmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPixcbiAgICBjb2xsZWN0aW9uOiBDb2xsZWN0aW9uSW5mbyxcbiAgICBzZWxlY3RlZEluZGV4ZXM/OiBRSW5kZXhJbmZvW10sXG4pIHtcbiAgICBjb25zdCBsb2dGaWVsZHM6IHN0cmluZ1tdID0gW107XG4gICAgZm9yIChjb25zdCBbbmFtZSwgZXhwbGFuYXRpb25dIG9mIGZpZWxkcy5lbnRyaWVzKCkpIHtcbiAgICAgICAgbG9nRmllbGRzLnB1c2goYCR7bmFtZX0gJHtBcnJheS5mcm9tKGV4cGxhbmF0aW9uLm9wZXJhdGlvbnMpLmpvaW4oJyBBTkQgJyl9YCk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhtZXNzYWdlLCB7XG4gICAgICAgIGNvbGxlY3Rpb246IGNvbGxlY3Rpb24ubmFtZSxcbiAgICAgICAgZmlsdGVyLFxuICAgICAgICBvcmRlckJ5OiBvcmRlckJ5VG9TdHJpbmcob3JkZXJCeSksXG4gICAgICAgIGZpZWxkczogbG9nRmllbGRzLFxuICAgICAgICAuLi4oc2VsZWN0ZWRJbmRleGVzID8ge3NlbGVjdGVkSW5kZXhlczogc2VsZWN0ZWRJbmRleGVzLm1hcChpbmRleFRvU3RyaW5nKX0gOiB7fSksXG4gICAgICAgIGF2YWlsYWJsZUluZGV4ZXM6IGNvbGxlY3Rpb24uaW5kZXhlcy5tYXAoaW5kZXhUb1N0cmluZyksXG4gICAgfSk7XG5cbn1cblxuZnVuY3Rpb24gaXNGYXN0UXVlcnlPck9wZXJhbmQoXG4gICAgY29sbGVjdGlvbjogQ29sbGVjdGlvbkluZm8sXG4gICAgdHlwZTogUVR5cGUsXG4gICAgZmlsdGVyOiBhbnksXG4gICAgb3JkZXJCeTogT3JkZXJCeVtdLFxuICAgIGxvZzogP1FMb2csXG4pOiBib29sZWFuIHtcbiAgICBjb25zdCBwYXJhbXMgPSBuZXcgUVBhcmFtcyh7XG4gICAgICAgIGV4cGxhaW46IHRydWUsXG4gICAgfSk7XG4gICAgdHlwZS5maWx0ZXJDb25kaXRpb24ocGFyYW1zLCAnJywgZmlsdGVyKTtcbiAgICBpZiAoIXBhcmFtcy5leHBsYW5hdGlvbikge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IGZpZWxkcyA9IG5ldyBNYXA8c3RyaW5nLCBRRmllbGRFeHBsYW5hdGlvbj4oKTtcbiAgICBmb3IgKGNvbnN0IFtmaWVsZCwgZXhwbGFuYXRpb25dIG9mIHBhcmFtcy5leHBsYW5hdGlvbi5maWVsZHMpIHtcbiAgICAgICAgaWYgKGZpZWxkICE9PSAnc3RhdHVzJykge1xuICAgICAgICAgICAgZmllbGRzLnNldChmaWVsZCwgZXhwbGFuYXRpb24pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChoYXNLZXlFcShmaWVsZHMpKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBpZiAoIWNhblVzZUNvbmRpdGlvbnNGb3JJbmRleGVkUmFuZ2UoZmllbGRzKSkge1xuICAgICAgICBpZiAobG9nKSB7XG4gICAgICAgICAgICBsb2dTbG93UmVhc29uKFxuICAgICAgICAgICAgICAgICdGaWx0ZXIgb3BlcmF0aW9ucyBjYW5cXCd0IGJlIHVzZWQgaW4gcmFuZ2VkIHF1ZXJpZXMnLFxuICAgICAgICAgICAgICAgIGxvZywgZmlsdGVyLCBvcmRlckJ5LCBmaWVsZHMsIGNvbGxlY3Rpb24sXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBpbmRleGVzID0gZ2V0VXNlZEluZGV4ZXMoZmllbGRzLCBjb2xsZWN0aW9uKTtcbiAgICBpZiAoIWluZGV4ZXMpIHtcbiAgICAgICAgaWYgKGxvZykge1xuICAgICAgICAgICAgbG9nU2xvd1JlYXNvbihcbiAgICAgICAgICAgICAgICAnQXZhaWxhYmxlIGluZGV4ZXMgY2FuXFwndCBiZSB1c2VkIGZvciBmaWx0ZXIgZmllbGRzJyxcbiAgICAgICAgICAgICAgICBsb2csIGZpbHRlciwgb3JkZXJCeSwgZmllbGRzLCBjb2xsZWN0aW9uLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKG9yZGVyQnkubGVuZ3RoID4gMCkge1xuICAgICAgICBpZiAoIW9yZGVyQnlDYW5Vc2VBbnlJbmRleChvcmRlckJ5LCBmaWVsZHMsIGluZGV4ZXMpKSB7XG4gICAgICAgICAgICBpZiAobG9nKSB7XG4gICAgICAgICAgICAgICAgbG9nU2xvd1JlYXNvbihcbiAgICAgICAgICAgICAgICAgICAgJ09yZGVyIGJ5IGNhblxcJ3QgdXNlIGFueSBzZWxlY3RlZCBpbmRleCcsXG4gICAgICAgICAgICAgICAgICAgIGxvZywgZmlsdGVyLCBvcmRlckJ5LCBmaWVsZHMsIGNvbGxlY3Rpb24sIGluZGV4ZXMsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNGYXN0UXVlcnkoXG4gICAgY29sbGVjdGlvbjogQ29sbGVjdGlvbkluZm8sXG4gICAgdHlwZTogUVR5cGUsXG4gICAgZmlsdGVyOiBhbnksXG4gICAgb3JkZXJCeTogT3JkZXJCeVtdLFxuICAgIGxvZzogP1FMb2csXG4pOiBib29sZWFuIHtcbiAgICBjb25zdCBvck9wZXJhbmRzID0gc3BsaXRPcihmaWx0ZXIpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3JPcGVyYW5kcy5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICBpZiAoIWlzRmFzdFF1ZXJ5T3JPcGVyYW5kKGNvbGxlY3Rpb24sIHR5cGUsIG9yT3BlcmFuZHNbaV0sIG9yZGVyQnksIGxvZykpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbn1cbiJdfQ==