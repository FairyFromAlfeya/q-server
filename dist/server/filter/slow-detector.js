"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.explainSlowReason = explainSlowReason;
exports.isFastQuery = isFastQuery;

var _filters = require("./filters");

function setIs1(s, a) {
  return s.size === 1 && s.has(a);
}

function setIs2(s, a, b) {
  return s.size === 2 && s.has(a) && s.has(b);
}

function canUseIndexedRange(ops) {
  return setIs1(ops, '==') || setIs1(ops, '!=') || setIs1(ops, '>') || setIs2(ops, '>', '<') || setIs2(ops, '>', '<=') || setIs1(ops, '>=') || setIs2(ops, '>=', '<') || setIs2(ops, '>=', '<=') || setIs1(ops, '<') || setIs1(ops, '<=');
}

function canUseConditionsForIndexedRange(fields) {
  for (const explanation of fields.values()) {
    if (!canUseIndexedRange(explanation.operations)) {
      return false;
    }
  }

  return true;
}

function fieldsCanUseIndex(fields, index) {
  if (fields.size > index.fields.length) {
    return false;
  }

  for (let i = 0; i < fields.size; i += 1) {
    if (!fields.has(index.fields[i])) {
      return false;
    }
  }

  return true;
}

function getUsedIndexes(fields, collectionIndexes) {
  const indexes = collectionIndexes.filter(x => fieldsCanUseIndex(fields, x));
  return indexes.length > 0 ? indexes : null;
}

function orderByCanUseIndex(orderBy, fields, index) {
  if (orderBy.length === 0) {
    return true;
  }

  let iOrderBy = 0;

  for (let iIndex = 0; iIndex < index.fields.length; iIndex += 1) {
    const indexField = index.fields[iIndex];

    if (indexField === orderBy[iOrderBy].path) {
      iOrderBy += 1;

      if (iOrderBy >= orderBy.length) {
        return true;
      }
    } else {
      if (iOrderBy > 0) {
        return false;
      }

      const field = fields.get(indexField);

      if (!field) {
        return false;
      }

      if (!setIs1(field.operations, '==')) {
        return false;
      }
    }
  }

  return true;
}

function orderByCanUseAllIndexes(orderBy, fields, indexes) {
  for (let i = 0; i < indexes.length; i += 1) {
    if (!orderByCanUseIndex(orderBy, fields, indexes[i])) {
      return false;
    }
  }

  return indexes.length > 0;
}

function orderByCanUseAnyIndex(orderBy, fields, indexes) {
  for (let i = 0; i < indexes.length; i += 1) {
    if (orderByCanUseIndex(orderBy, fields, indexes[i])) {
      return true;
    }
  }

  return false;
}

function hasKeyEq(fields) {
  const key = fields.get('_key');
  return !!(key && setIs1(key.operations, '=='));
}

function getSlowReason(summary, fields, collectionIndexes, selectedIndexes) {
  const logFields = [];

  for (const [name, explanation] of fields.entries()) {
    logFields.push(`${name} ${Array.from(explanation.operations).join(' AND ')}`);
  }

  return {
    summary,
    fields: logFields,
    availableIndexes: collectionIndexes.map(_filters.indexToString),
    selectedIndexes: selectedIndexes.map(_filters.indexToString)
  };
}

function getSlowReasonForOrOperand(collectionIndexes, type, filter, orderBy) {
  const params = new _filters.QParams({
    explain: true
  });
  type.filterCondition(params, '', filter);

  if (!params.explanation) {
    return getSlowReason("No filter", new Map(), collectionIndexes, []);
  }

  const fields = new Map();

  for (const [field, explanation] of params.explanation.fields) {
    if (field !== 'status') {
      fields.set(field, explanation);
    }
  }

  if (hasKeyEq(fields)) {
    return null;
  }

  if (!canUseConditionsForIndexedRange(fields)) {
    return getSlowReason("Filter operations can't be used in ranged queries", fields, collectionIndexes, []);
  }

  const indexes = getUsedIndexes(fields, collectionIndexes);

  if (!indexes) {
    return getSlowReason("Available indexes can't be used for filter fields", fields, collectionIndexes, []);
  }

  if (orderBy.length > 0) {
    if (!orderByCanUseAnyIndex(orderBy, fields, indexes)) {
      return getSlowReason("Order by can't use any selected index", fields, collectionIndexes, indexes);
    }
  }

  return null;
}

function explainSlowReason(collectionName, collectionIndexes, type, filter, orderBy) {
  const orOperands = (0, _filters.splitOr)(filter);

  for (let i = 0; i < orOperands.length; i += 1) {
    const slowReason = getSlowReasonForOrOperand(collectionIndexes, type, orOperands[i], orderBy);

    if (slowReason) {
      return slowReason;
    }
  }

  return null;
}

function isFastQuery(collectionName, collectionIndexes, type, filter, orderBy, log) {
  const slowReason = explainSlowReason(collectionName, collectionIndexes, type, filter, orderBy);

  if (slowReason && log) {
    log.debug(slowReason.summary, { ...slowReason,
      collection: collectionName,
      filter,
      orderBy: (0, _filters.orderByToString)(orderBy)
    });
  }

  return slowReason === null;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZmlsdGVyL3Nsb3ctZGV0ZWN0b3IuanMiXSwibmFtZXMiOlsic2V0SXMxIiwicyIsImEiLCJzaXplIiwiaGFzIiwic2V0SXMyIiwiYiIsImNhblVzZUluZGV4ZWRSYW5nZSIsIm9wcyIsImNhblVzZUNvbmRpdGlvbnNGb3JJbmRleGVkUmFuZ2UiLCJmaWVsZHMiLCJleHBsYW5hdGlvbiIsInZhbHVlcyIsIm9wZXJhdGlvbnMiLCJmaWVsZHNDYW5Vc2VJbmRleCIsImluZGV4IiwibGVuZ3RoIiwiaSIsImdldFVzZWRJbmRleGVzIiwiY29sbGVjdGlvbkluZGV4ZXMiLCJpbmRleGVzIiwiZmlsdGVyIiwieCIsIm9yZGVyQnlDYW5Vc2VJbmRleCIsIm9yZGVyQnkiLCJpT3JkZXJCeSIsImlJbmRleCIsImluZGV4RmllbGQiLCJwYXRoIiwiZmllbGQiLCJnZXQiLCJvcmRlckJ5Q2FuVXNlQWxsSW5kZXhlcyIsIm9yZGVyQnlDYW5Vc2VBbnlJbmRleCIsImhhc0tleUVxIiwia2V5IiwiZ2V0U2xvd1JlYXNvbiIsInN1bW1hcnkiLCJzZWxlY3RlZEluZGV4ZXMiLCJsb2dGaWVsZHMiLCJuYW1lIiwiZW50cmllcyIsInB1c2giLCJBcnJheSIsImZyb20iLCJqb2luIiwiYXZhaWxhYmxlSW5kZXhlcyIsIm1hcCIsImluZGV4VG9TdHJpbmciLCJnZXRTbG93UmVhc29uRm9yT3JPcGVyYW5kIiwidHlwZSIsInBhcmFtcyIsIlFQYXJhbXMiLCJleHBsYWluIiwiZmlsdGVyQ29uZGl0aW9uIiwiTWFwIiwic2V0IiwiZXhwbGFpblNsb3dSZWFzb24iLCJjb2xsZWN0aW9uTmFtZSIsIm9yT3BlcmFuZHMiLCJzbG93UmVhc29uIiwiaXNGYXN0UXVlcnkiLCJsb2ciLCJkZWJ1ZyIsImNvbGxlY3Rpb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBSUE7O0FBSUEsU0FBU0EsTUFBVCxDQUFnQkMsQ0FBaEIsRUFBZ0NDLENBQWhDLEVBQW9EO0FB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QUR1QjtBQUUxQkksTUFBQUEsVUFBVSxFQUFFTixjQUZjO0FBRzFCcEMsTUFBQUEsTUFIMEI7QUFJMUJHLE1BQUFBLE9BQU8sRUFBRSw4QkFBZ0JBLE9BQWhCO0FBSmlCLEtBQTlCO0FBTUg7O0FBQ0QsU0FBT21DLFVBQVUsS0FBSyxJQUF0QjtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuXG5pbXBvcnQgdHlwZSB7IFFJbmRleEluZm8gfSBmcm9tICcuLi9kYXRhL2RhdGEtcHJvdmlkZXInO1xuaW1wb3J0IHsgaW5kZXhUb1N0cmluZywgb3JkZXJCeVRvU3RyaW5nLCBRUGFyYW1zLCBzcGxpdE9yIH0gZnJvbSBcIi4vZmlsdGVyc1wiO1xuaW1wb3J0IHR5cGUgeyBPcmRlckJ5LCBRRmllbGRFeHBsYW5hdGlvbiwgUVR5cGUgfSBmcm9tIFwiLi9maWx0ZXJzXCI7XG5pbXBvcnQgdHlwZSB7IFFMb2cgfSBmcm9tICcuLi9sb2dzJztcblxuZnVuY3Rpb24gc2V0SXMxKHM6IFNldDxzdHJpbmc+LCBhOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gcy5zaXplID09PSAxICYmIHMuaGFzKGEpO1xufVxuXG5mdW5jdGlvbiBzZXRJczIoczogU2V0PHN0cmluZz4sIGE6IHN0cmluZywgYjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHMuc2l6ZSA9PT0gMiAmJiBzLmhhcyhhKSAmJiBzLmhhcyhiKTtcbn1cblxuZnVuY3Rpb24gY2FuVXNlSW5kZXhlZFJhbmdlKG9wczogU2V0PHN0cmluZz4pOiBib29sZWFuIHtcbiAgICByZXR1cm4gc2V0SXMxKG9wcywgJz09JylcbiAgICAgICAgfHwgc2V0SXMxKG9wcywgJyE9JylcbiAgICAgICAgfHwgc2V0SXMxKG9wcywgJz4nKVxuICAgICAgICB8fCBzZXRJczIob3BzLCAnPicsICc8JylcbiAgICAgICAgfHwgc2V0SXMyKG9wcywgJz4nLCAnPD0nKVxuICAgICAgICB8fCBzZXRJczEob3BzLCAnPj0nKVxuICAgICAgICB8fCBzZXRJczIob3BzLCAnPj0nLCAnPCcpXG4gICAgICAgIHx8IHNldElzMihvcHMsICc+PScsICc8PScpXG4gICAgICAgIHx8IHNldElzMShvcHMsICc8JylcbiAgICAgICAgfHwgc2V0SXMxKG9wcywgJzw9Jyk7XG59XG5cbmZ1bmN0aW9uIGNhblVzZUNvbmRpdGlvbnNGb3JJbmRleGVkUmFuZ2UoZmllbGRzOiBNYXA8c3RyaW5nLCBRRmllbGRFeHBsYW5hdGlvbj4pOiBib29sZWFuIHtcbiAgICBmb3IgKGNvbnN0IGV4cGxhbmF0aW9uIG9mIGZpZWxkcy52YWx1ZXMoKSkge1xuICAgICAgICBpZiAoIWNhblVzZUluZGV4ZWRSYW5nZShleHBsYW5hdGlvbi5vcGVyYXRpb25zKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xufVxuXG5mdW5jdGlvbiBmaWVsZHNDYW5Vc2VJbmRleChmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPiwgaW5kZXg6IFFJbmRleEluZm8pOiBib29sZWFuIHtcbiAgICBpZiAoZmllbGRzLnNpemUgPiBpbmRleC5maWVsZHMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaWVsZHMuc2l6ZTsgaSArPSAxKSB7XG4gICAgICAgIGlmICghZmllbGRzLmhhcyhpbmRleC5maWVsZHNbaV0pKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG59XG5cbmZ1bmN0aW9uIGdldFVzZWRJbmRleGVzKGZpZWxkczogTWFwPHN0cmluZywgUUZpZWxkRXhwbGFuYXRpb24+LCBjb2xsZWN0aW9uSW5kZXhlczogUUluZGV4SW5mb1tdKTogPyhRSW5kZXhJbmZvW10pIHtcbiAgICBjb25zdCBpbmRleGVzID0gY29sbGVjdGlvbkluZGV4ZXMuZmlsdGVyKHggPT4gZmllbGRzQ2FuVXNlSW5kZXgoZmllbGRzLCB4KSk7XG4gICAgcmV0dXJuIGluZGV4ZXMubGVuZ3RoID4gMCA/IGluZGV4ZXMgOiBudWxsO1xufVxuXG5mdW5jdGlvbiBvcmRlckJ5Q2FuVXNlSW5kZXgoXG4gICAgb3JkZXJCeTogT3JkZXJCeVtdLFxuICAgIGZpZWxkczogTWFwPHN0cmluZywgUUZpZWxkRXhwbGFuYXRpb24+LFxuICAgIGluZGV4OiBRSW5kZXhJbmZvLFxuKTogYm9vbGVhbiB7XG4gICAgaWYgKG9yZGVyQnkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBsZXQgaU9yZGVyQnkgPSAwO1xuICAgIGZvciAobGV0IGlJbmRleCA9IDA7IGlJbmRleCA8IGluZGV4LmZpZWxkcy5sZW5ndGg7IGlJbmRleCArPSAxKSB7XG4gICAgICAgIGNvbnN0IGluZGV4RmllbGQgPSBpbmRleC5maWVsZHNbaUluZGV4XTtcbiAgICAgICAgaWYgKGluZGV4RmllbGQgPT09IG9yZGVyQnlbaU9yZGVyQnldLnBhdGgpIHtcbiAgICAgICAgICAgIGlPcmRlckJ5ICs9IDE7XG4gICAgICAgICAgICBpZiAoaU9yZGVyQnkgPj0gb3JkZXJCeS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChpT3JkZXJCeSA+IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBmaWVsZCA9IGZpZWxkcy5nZXQoaW5kZXhGaWVsZCk7XG4gICAgICAgICAgICBpZiAoIWZpZWxkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFzZXRJczEoZmllbGQub3BlcmF0aW9ucywgJz09JykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG59XG5cbmZ1bmN0aW9uIG9yZGVyQnlDYW5Vc2VBbGxJbmRleGVzKFxuICAgIG9yZGVyQnk6IE9yZGVyQnlbXSxcbiAgICBmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPixcbiAgICBpbmRleGVzOiBRSW5kZXhJbmZvW10sXG4pOiBib29sZWFuIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZGV4ZXMubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKCFvcmRlckJ5Q2FuVXNlSW5kZXgob3JkZXJCeSwgZmllbGRzLCBpbmRleGVzW2ldKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBpbmRleGVzLmxlbmd0aCA+IDA7XG59XG5cbmZ1bmN0aW9uIG9yZGVyQnlDYW5Vc2VBbnlJbmRleChcbiAgICBvcmRlckJ5OiBPcmRlckJ5W10sXG4gICAgZmllbGRzOiBNYXA8c3RyaW5nLCBRRmllbGRFeHBsYW5hdGlvbj4sXG4gICAgaW5kZXhlczogUUluZGV4SW5mb1tdLFxuKTogYm9vbGVhbiB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRleGVzLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgIGlmIChvcmRlckJ5Q2FuVXNlSW5kZXgob3JkZXJCeSwgZmllbGRzLCBpbmRleGVzW2ldKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuXG5mdW5jdGlvbiBoYXNLZXlFcShmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGtleSA9IGZpZWxkcy5nZXQoJ19rZXknKTtcbiAgICByZXR1cm4gISEoa2V5ICYmIHNldElzMShrZXkub3BlcmF0aW9ucywgJz09JykpO1xufVxuXG5mdW5jdGlvbiBnZXRTbG93UmVhc29uKFxuICAgIHN1bW1hcnk6IHN0cmluZyxcbiAgICBmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPixcbiAgICBjb2xsZWN0aW9uSW5kZXhlczogUUluZGV4SW5mb1tdLFxuICAgIHNlbGVjdGVkSW5kZXhlczogUUluZGV4SW5mb1tdLFxuKTogU2xvd1JlYXNvbiB7XG4gICAgY29uc3QgbG9nRmllbGRzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGZvciAoY29uc3QgW25hbWUsIGV4cGxhbmF0aW9uXSBvZiBmaWVsZHMuZW50cmllcygpKSB7XG4gICAgICAgIGxvZ0ZpZWxkcy5wdXNoKGAke25hbWV9ICR7QXJyYXkuZnJvbShleHBsYW5hdGlvbi5vcGVyYXRpb25zKS5qb2luKCcgQU5EICcpfWApO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgICBzdW1tYXJ5LFxuICAgICAgICBmaWVsZHM6IGxvZ0ZpZWxkcyxcbiAgICAgICAgYXZhaWxhYmxlSW5kZXhlczogY29sbGVjdGlvbkluZGV4ZXMubWFwKGluZGV4VG9TdHJpbmcpLFxuICAgICAgICBzZWxlY3RlZEluZGV4ZXM6IHNlbGVjdGVkSW5kZXhlcy5tYXAoaW5kZXhUb1N0cmluZyksXG4gICAgfVxufVxuXG5mdW5jdGlvbiBnZXRTbG93UmVhc29uRm9yT3JPcGVyYW5kKFxuICAgIGNvbGxlY3Rpb25JbmRleGVzOiBRSW5kZXhJbmZvW10sXG4gICAgdHlwZTogUVR5cGUsXG4gICAgZmlsdGVyOiBhbnksXG4gICAgb3JkZXJCeTogT3JkZXJCeVtdLFxuKTogP1Nsb3dSZWFzb24ge1xuICAgIGNvbnN0IHBhcmFtcyA9IG5ldyBRUGFyYW1zKHtcbiAgICAgICAgZXhwbGFpbjogdHJ1ZSxcbiAgICB9KTtcbiAgICB0eXBlLmZpbHRlckNvbmRpdGlvbihwYXJhbXMsICcnLCBmaWx0ZXIpO1xuICAgIGlmICghcGFyYW1zLmV4cGxhbmF0aW9uKSB7XG4gICAgICAgIHJldHVybiBnZXRTbG93UmVhc29uKFwiTm8gZmlsdGVyXCIsIG5ldyBNYXAoKSwgY29sbGVjdGlvbkluZGV4ZXMsIFtdKTtcbiAgICB9XG4gICAgY29uc3QgZmllbGRzID0gbmV3IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPigpO1xuICAgIGZvciAoY29uc3QgW2ZpZWxkLCBleHBsYW5hdGlvbl0gb2YgcGFyYW1zLmV4cGxhbmF0aW9uLmZpZWxkcykge1xuICAgICAgICBpZiAoZmllbGQgIT09ICdzdGF0dXMnKSB7XG4gICAgICAgICAgICBmaWVsZHMuc2V0KGZpZWxkLCBleHBsYW5hdGlvbik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGhhc0tleUVxKGZpZWxkcykpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGlmICghY2FuVXNlQ29uZGl0aW9uc0ZvckluZGV4ZWRSYW5nZShmaWVsZHMpKSB7XG4gICAgICAgIHJldHVybiBnZXRTbG93UmVhc29uKFxuICAgICAgICAgICAgXCJGaWx0ZXIgb3BlcmF0aW9ucyBjYW4ndCBiZSB1c2VkIGluIHJhbmdlZCBxdWVyaWVzXCIsXG4gICAgICAgICAgICBmaWVsZHMsIGNvbGxlY3Rpb25JbmRleGVzLCBbXSk7XG4gICAgfVxuXG4gICAgY29uc3QgaW5kZXhlcyA9IGdldFVzZWRJbmRleGVzKGZpZWxkcywgY29sbGVjdGlvbkluZGV4ZXMpO1xuICAgIGlmICghaW5kZXhlcykge1xuICAgICAgICByZXR1cm4gZ2V0U2xvd1JlYXNvbihcbiAgICAgICAgICAgIFwiQXZhaWxhYmxlIGluZGV4ZXMgY2FuJ3QgYmUgdXNlZCBmb3IgZmlsdGVyIGZpZWxkc1wiLFxuICAgICAgICAgICAgZmllbGRzLCBjb2xsZWN0aW9uSW5kZXhlcywgW10sXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKG9yZGVyQnkubGVuZ3RoID4gMCkge1xuICAgICAgICBpZiAoIW9yZGVyQnlDYW5Vc2VBbnlJbmRleChvcmRlckJ5LCBmaWVsZHMsIGluZGV4ZXMpKSB7XG4gICAgICAgICAgICByZXR1cm4gZ2V0U2xvd1JlYXNvbihcbiAgICAgICAgICAgICAgICBcIk9yZGVyIGJ5IGNhbid0IHVzZSBhbnkgc2VsZWN0ZWQgaW5kZXhcIixcbiAgICAgICAgICAgICAgICBmaWVsZHMsIGNvbGxlY3Rpb25JbmRleGVzLCBpbmRleGVzLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xufVxuXG5leHBvcnQgdHlwZSBTbG93UmVhc29uID0ge1xuICAgIHN1bW1hcnk6IHN0cmluZyxcbiAgICBmaWVsZHM6IHN0cmluZ1tdLFxuICAgIHNlbGVjdGVkSW5kZXhlczogc3RyaW5nW10sXG4gICAgYXZhaWxhYmxlSW5kZXhlczogc3RyaW5nW10sXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBleHBsYWluU2xvd1JlYXNvbihcbiAgICBjb2xsZWN0aW9uTmFtZTogc3RyaW5nLFxuICAgIGNvbGxlY3Rpb25JbmRleGVzOiBRSW5kZXhJbmZvW10sXG4gICAgdHlwZTogUVR5cGUsXG4gICAgZmlsdGVyOiBhbnksXG4gICAgb3JkZXJCeTogT3JkZXJCeVtdLFxuKTogP1Nsb3dSZWFzb24ge1xuICAgIGNvbnN0IG9yT3BlcmFuZHMgPSBzcGxpdE9yKGZpbHRlcik7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvck9wZXJhbmRzLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgIGNvbnN0IHNsb3dSZWFzb24gPSBnZXRTbG93UmVhc29uRm9yT3JPcGVyYW5kKFxuICAgICAgICAgICAgY29sbGVjdGlvbkluZGV4ZXMsXG4gICAgICAgICAgICB0eXBlLFxuICAgICAgICAgICAgb3JPcGVyYW5kc1tpXSxcbiAgICAgICAgICAgIG9yZGVyQnlcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKHNsb3dSZWFzb24pIHtcbiAgICAgICAgICAgIHJldHVybiBzbG93UmVhc29uO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNGYXN0UXVlcnkoXG4gICAgY29sbGVjdGlvbk5hbWU6IHN0cmluZyxcbiAgICBjb2xsZWN0aW9uSW5kZXhlczogUUluZGV4SW5mb1tdLFxuICAgIHR5cGU6IFFUeXBlLFxuICAgIGZpbHRlcjogYW55LFxuICAgIG9yZGVyQnk6IE9yZGVyQnlbXSxcbiAgICBsb2c6ID9RTG9nLFxuKTogYm9vbGVhbiB7XG4gICAgY29uc3Qgc2xvd1JlYXNvbiA9IGV4cGxhaW5TbG93UmVhc29uKGNvbGxlY3Rpb25OYW1lLCBjb2xsZWN0aW9uSW5kZXhlcywgdHlwZSwgZmlsdGVyLCBvcmRlckJ5KTtcbiAgICBpZiAoc2xvd1JlYXNvbiAmJiBsb2cpIHtcbiAgICAgICAgbG9nLmRlYnVnKHNsb3dSZWFzb24uc3VtbWFyeSwge1xuICAgICAgICAgICAgLi4uc2xvd1JlYXNvbixcbiAgICAgICAgICAgIGNvbGxlY3Rpb246IGNvbGxlY3Rpb25OYW1lLFxuICAgICAgICAgICAgZmlsdGVyLFxuICAgICAgICAgICAgb3JkZXJCeTogb3JkZXJCeVRvU3RyaW5nKG9yZGVyQnkpLFxuICAgICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHNsb3dSZWFzb24gPT09IG51bGw7XG59XG4iXX0=