"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.isFastQuery = isFastQuery;

var _filters = require("./filters");

function setIs1(s, a) {
  return s.size === 1 && s.has(a);
}

function setIs2(s, a, b) {
  return s.size === 2 && s.has(a) && s.has(b);
}

function canUseIndexedRange(ops) {
  return setIs1(ops, '==') || setIs1(ops, '!=') || setIs1(ops, '>') || setIs2(ops, '>', '<') || setIs2(ops, '>', '<=') || setIs1(ops, '>=') || setIs2(ops, '>=', '<') || setIs2(ops, '>=', '<=') || setIs1(ops, '<') || setIs1(ops, '<=');
}

function canUseConditionsForIndexedRange(fields) {
  for (const explanation of fields.values()) {
    if (!canUseIndexedRange(explanation.operations)) {
      return false;
    }
  }

  return true;
}

function fieldsCanUseIndex(fields, index) {
  if (fields.size > index.fields.length) {
    return false;
  }

  for (let i = 0; i < fields.size; i += 1) {
    if (!fields.has(index.fields[i])) {
      return false;
    }
  }

  return true;
}

function getUsedIndexes(fields, collectionIndexes) {
  const indexes = collectionIndexes.filter(x => fieldsCanUseIndex(fields, x));
  return indexes.length > 0 ? indexes : null;
}

function orderByCanUseIndex(orderBy, fields, index) {
  if (orderBy.length === 0) {
    return true;
  }

  let iOrderBy = 0;

  for (let iIndex = 0; iIndex < index.fields.length; iIndex += 1) {
    const indexField = index.fields[iIndex];

    if (indexField === orderBy[iOrderBy].path) {
      iOrderBy += 1;

      if (iOrderBy >= orderBy.length) {
        return true;
      }
    } else {
      if (iOrderBy > 0) {
        return false;
      }

      const field = fields.get(indexField);

      if (!field) {
        return false;
      }

      if (!setIs1(field.operations, '==')) {
        return false;
      }
    }
  }

  return true;
}

function orderByCanUseAllIndexes(orderBy, fields, indexes) {
  for (let i = 0; i < indexes.length; i += 1) {
    if (!orderByCanUseIndex(orderBy, fields, indexes[i])) {
      return false;
    }
  }

  return indexes.length > 0;
}

function orderByCanUseAnyIndex(orderBy, fields, indexes) {
  for (let i = 0; i < indexes.length; i += 1) {
    if (orderByCanUseIndex(orderBy, fields, indexes[i])) {
      return true;
    }
  }

  return false;
}

function hasKeyEq(fields) {
  const key = fields.get('_key');
  return !!(key && setIs1(key.operations, '=='));
}

function logSlowReason(message, log, filter, orderBy, fields, collectionName, collectionIndexes, selectedIndexes) {
  const logFields = [];

  for (const [name, explanation] of fields.entries()) {
    logFields.push(`${name} ${Array.from(explanation.operations).join(' AND ')}`);
  }

  log.debug(message, {
    collection: collectionName,
    filter,
    orderBy: (0, _filters.orderByToString)(orderBy),
    fields: logFields,
    ...(selectedIndexes ? {
      selectedIndexes: selectedIndexes.map(_filters.indexToString)
    } : {}),
    availableIndexes: collectionIndexes.map(_filters.indexToString)
  });
}

function isFastQueryOrOperand(collectionName, collectionIndexes, type, filter, orderBy, log) {
  const params = new _filters.QParams({
    explain: true
  });
  type.filterCondition(params, '', filter);

  if (!params.explanation) {
    return false;
  }

  const fields = new Map();

  for (const [field, explanation] of params.explanation.fields) {
    if (field !== 'status') {
      fields.set(field, explanation);
    }
  }

  if (hasKeyEq(fields)) {
    return true;
  }

  if (!canUseConditionsForIndexedRange(fields)) {
    if (log) {
      logSlowReason('Filter operations can\'t be used in ranged queries', log, filter, orderBy, fields, collectionName, collectionIndexes);
    }

    return false;
  }

  const indexes = getUsedIndexes(fields, collectionIndexes);

  if (!indexes) {
    if (log) {
      logSlowReason('Available indexes can\'t be used for filter fields', log, filter, orderBy, fields, collectionName, collectionIndexes);
    }

    return false;
  }

  if (orderBy.length > 0) {
    if (!orderByCanUseAnyIndex(orderBy, fields, indexes)) {
      if (log) {
        logSlowReason('Order by can\'t use any selected index', log, filter, orderBy, fields, collectionName, collectionIndexes, indexes);
      }

      return false;
    }
  }

  return true;
}

function isFastQuery(collectionName, collectionIndexes, type, filter, orderBy, log) {
  const orOperands = (0, _filters.splitOr)(filter);

  for (let i = 0; i < orOperands.length; i += 1) {
    if (!isFastQueryOrOperand(collectionName, collectionIndexes, type, orOperands[i], orderBy, log)) {
      return false;
    }
  }

  return true;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZmlsdGVyL3Nsb3ctZGV0ZWN0b3IuanMiXSwibmFtZXMiOlsic2V0SXMxIiwicyIsImEiLCJzaXplIiwiaGFzIiwic2V0SXMyIiwiYiIsImNhblVzZUluZGV4ZWRSYW5nZSIsIm9wcyIsImNhblVzZUNvbmRpdGlvbnNGb3JJbmRleGVkUmFuZ2UiLCJmaWVsZHMiLCJleHBsYW5hdGlvbiIsInZhbHVlcyIsIm9wZXJhdGlvbnMiLCJmaWVsZHNDYW5Vc2VJbmRleCIsImluZGV4IiwibGVuZ3RoIiwiaSIsImdldFVzZWRJbmRleGVzIiwiY29sbGVjdGlvbkluZGV4ZXMiLCJpbmRleGVzIiwiZmlsdGVyIiwieCIsIm9yZGVyQnlDYW5Vc2VJbmRleCIsIm9yZGVyQnkiLCJpT3JkZXJCeSIsImlJbmRleCIsImluZGV4RmllbGQiLCJwYXRoIiwiZmllbGQiLCJnZXQiLCJvcmRlckJ5Q2FuVXNlQWxsSW5kZXhlcyIsIm9yZGVyQnlDYW5Vc2VBbnlJbmRleCIsImhhc0tleUVxIiwia2V5IiwibG9nU2xvd1JlYXNvbiIsIm1lc3NhZ2UiLCJsb2ciLCJjb2xsZWN0aW9uTmFtZSIsInNlbGVjdGVkSW5kZXhlcyIsImxvZ0ZpZWxkcyIsIm5hbWUiLCJlbnRyaWVzIiwicHVzaCIsIkFycmF5IiwiZnJvbSIsImpvaW4iLCJkZWJ1ZyIsImNvbGxlY3Rpb24iLCJtYXAiLCJpbmRleFRvU3RyaW5nIiwiYXZhaWxhYmxlSW5kZXhlcyIsImlzRmFzdFF1ZXJ5T3JPcGVyYW5kIiwidHlwZSIsInBhcmFtcyIsIlFQYXJhbXMiLCJleHBsYWluIiwiZmlsdGVyQ29uZGl0aW9uIiwiTWFwIiwic2V0IiwiaXNGYXN0UXVlcnkiLCJvck9wZXJhbmRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBSUE7O0FBSUEsU0FBU0EsTUFBVCxDQUFnQkMsQ0FBaEIsRUFBZ0NDLENBQWhDLEVBQW9EO0FBQ2hELFNBQU9ELENBQUMsQ0FBQ0UsSUFBRixLQUFXLENBQVgsSUFB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LEdBQWxFLENBQXpCLEVBQWlHO0FBQzdGLGFBQU8sS0FBUDtBQUNIO0FBQ0o7O0FBQ0QsU0FBTyxJQUFQO0FBQ0giLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5cbmltcG9ydCB0eXBlIHsgUUluZGV4SW5mbyB9IGZyb20gJy4uL2RhdGEvZGF0YS1wcm92aWRlcic7XG5pbXBvcnQge2luZGV4VG9TdHJpbmcsIG9yZGVyQnlUb1N0cmluZywgUVBhcmFtcywgc3BsaXRPcn0gZnJvbSBcIi4vZmlsdGVyc1wiO1xuaW1wb3J0IHR5cGUge09yZGVyQnksIFFGaWVsZEV4cGxhbmF0aW9uLCBRVHlwZX0gZnJvbSBcIi4vZmlsdGVyc1wiO1xuaW1wb3J0IHR5cGUge1FMb2d9IGZyb20gJy4uL2xvZ3MnO1xuXG5mdW5jdGlvbiBzZXRJczEoczogU2V0PHN0cmluZz4sIGE6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBzLnNpemUgPT09IDEgJiYgcy5oYXMoYSk7XG59XG5cbmZ1bmN0aW9uIHNldElzMihzOiBTZXQ8c3RyaW5nPiwgYTogc3RyaW5nLCBiOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gcy5zaXplID09PSAyICYmIHMuaGFzKGEpICYmIHMuaGFzKGIpO1xufVxuXG5mdW5jdGlvbiBjYW5Vc2VJbmRleGVkUmFuZ2Uob3BzOiBTZXQ8c3RyaW5nPik6IGJvb2xlYW4ge1xuICAgIHJldHVybiBzZXRJczEob3BzLCAnPT0nKVxuICAgICAgICB8fCBzZXRJczEob3BzLCAnIT0nKVxuICAgICAgICB8fCBzZXRJczEob3BzLCAnPicpXG4gICAgICAgIHx8IHNldElzMihvcHMsICc+JywgJzwnKVxuICAgICAgICB8fCBzZXRJczIob3BzLCAnPicsICc8PScpXG4gICAgICAgIHx8IHNldElzMShvcHMsICc+PScpXG4gICAgICAgIHx8IHNldElzMihvcHMsICc+PScsICc8JylcbiAgICAgICAgfHwgc2V0SXMyKG9wcywgJz49JywgJzw9JylcbiAgICAgICAgfHwgc2V0SXMxKG9wcywgJzwnKVxuICAgICAgICB8fCBzZXRJczEob3BzLCAnPD0nKTtcbn1cblxuZnVuY3Rpb24gY2FuVXNlQ29uZGl0aW9uc0ZvckluZGV4ZWRSYW5nZShmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPik6IGJvb2xlYW4ge1xuICAgIGZvciAoY29uc3QgZXhwbGFuYXRpb24gb2YgZmllbGRzLnZhbHVlcygpKSB7XG4gICAgICAgIGlmICghY2FuVXNlSW5kZXhlZFJhbmdlKGV4cGxhbmF0aW9uLm9wZXJhdGlvbnMpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG59XG5cbmZ1bmN0aW9uIGZpZWxkc0NhblVzZUluZGV4KGZpZWxkczogTWFwPHN0cmluZywgUUZpZWxkRXhwbGFuYXRpb24+LCBpbmRleDogUUluZGV4SW5mbyk6IGJvb2xlYW4ge1xuICAgIGlmIChmaWVsZHMuc2l6ZSA+IGluZGV4LmZpZWxkcy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpZWxkcy5zaXplOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKCFmaWVsZHMuaGFzKGluZGV4LmZpZWxkc1tpXSkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbn1cblxuZnVuY3Rpb24gZ2V0VXNlZEluZGV4ZXMoZmllbGRzOiBNYXA8c3RyaW5nLCBRRmllbGRFeHBsYW5hdGlvbj4sIGNvbGxlY3Rpb25JbmRleGVzOiBRSW5kZXhJbmZvW10pOiA/KFFJbmRleEluZm9bXSkge1xuICAgIGNvbnN0IGluZGV4ZXMgPSBjb2xsZWN0aW9uSW5kZXhlcy5maWx0ZXIoeCA9PiBmaWVsZHNDYW5Vc2VJbmRleChmaWVsZHMsIHgpKTtcbiAgICByZXR1cm4gaW5kZXhlcy5sZW5ndGggPiAwID8gaW5kZXhlcyA6IG51bGw7XG59XG5cbmZ1bmN0aW9uIG9yZGVyQnlDYW5Vc2VJbmRleChcbiAgICBvcmRlckJ5OiBPcmRlckJ5W10sXG4gICAgZmllbGRzOiBNYXA8c3RyaW5nLCBRRmllbGRFeHBsYW5hdGlvbj4sXG4gICAgaW5kZXg6IFFJbmRleEluZm8sXG4pOiBib29sZWFuIHtcbiAgICBpZiAob3JkZXJCeS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGxldCBpT3JkZXJCeSA9IDA7XG4gICAgZm9yIChsZXQgaUluZGV4ID0gMDsgaUluZGV4IDwgaW5kZXguZmllbGRzLmxlbmd0aDsgaUluZGV4ICs9IDEpIHtcbiAgICAgICAgY29uc3QgaW5kZXhGaWVsZCA9IGluZGV4LmZpZWxkc1tpSW5kZXhdO1xuICAgICAgICBpZiAoaW5kZXhGaWVsZCA9PT0gb3JkZXJCeVtpT3JkZXJCeV0ucGF0aCkge1xuICAgICAgICAgICAgaU9yZGVyQnkgKz0gMTtcbiAgICAgICAgICAgIGlmIChpT3JkZXJCeSA+PSBvcmRlckJ5Lmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGlPcmRlckJ5ID4gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGZpZWxkID0gZmllbGRzLmdldChpbmRleEZpZWxkKTtcbiAgICAgICAgICAgIGlmICghZmllbGQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXNldElzMShmaWVsZC5vcGVyYXRpb25zLCAnPT0nKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbn1cblxuZnVuY3Rpb24gb3JkZXJCeUNhblVzZUFsbEluZGV4ZXMoXG4gICAgb3JkZXJCeTogT3JkZXJCeVtdLFxuICAgIGZpZWxkczogTWFwPHN0cmluZywgUUZpZWxkRXhwbGFuYXRpb24+LFxuICAgIGluZGV4ZXM6IFFJbmRleEluZm9bXSxcbik6IGJvb2xlYW4ge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXhlcy5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICBpZiAoIW9yZGVyQnlDYW5Vc2VJbmRleChvcmRlckJ5LCBmaWVsZHMsIGluZGV4ZXNbaV0pKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGluZGV4ZXMubGVuZ3RoID4gMDtcbn1cblxuZnVuY3Rpb24gb3JkZXJCeUNhblVzZUFueUluZGV4KFxuICAgIG9yZGVyQnk6IE9yZGVyQnlbXSxcbiAgICBmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPixcbiAgICBpbmRleGVzOiBRSW5kZXhJbmZvW10sXG4pOiBib29sZWFuIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZGV4ZXMubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKG9yZGVyQnlDYW5Vc2VJbmRleChvcmRlckJ5LCBmaWVsZHMsIGluZGV4ZXNbaV0pKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59XG5cbmZ1bmN0aW9uIGhhc0tleUVxKGZpZWxkczogTWFwPHN0cmluZywgUUZpZWxkRXhwbGFuYXRpb24+KTogYm9vbGVhbiB7XG4gICAgY29uc3Qga2V5ID0gZmllbGRzLmdldCgnX2tleScpO1xuICAgIHJldHVybiAhIShrZXkgJiYgc2V0SXMxKGtleS5vcGVyYXRpb25zLCAnPT0nKSk7XG59XG5cbmZ1bmN0aW9uIGxvZ1Nsb3dSZWFzb24oXG4gICAgbWVzc2FnZTogc3RyaW5nLFxuICAgIGxvZzogUUxvZyxcbiAgICBmaWx0ZXI6IGFueSxcbiAgICBvcmRlckJ5OiBPcmRlckJ5W10sXG4gICAgZmllbGRzOiBNYXA8c3RyaW5nLCBRRmllbGRFeHBsYW5hdGlvbj4sXG4gICAgY29sbGVjdGlvbk5hbWU6IHN0cmluZyxcbiAgICBjb2xsZWN0aW9uSW5kZXhlczogUUluZGV4SW5mb1tdLFxuICAgIHNlbGVjdGVkSW5kZXhlcz86IFFJbmRleEluZm9bXSxcbikge1xuICAgIGNvbnN0IGxvZ0ZpZWxkczogc3RyaW5nW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IFtuYW1lLCBleHBsYW5hdGlvbl0gb2YgZmllbGRzLmVudHJpZXMoKSkge1xuICAgICAgICBsb2dGaWVsZHMucHVzaChgJHtuYW1lfSAke0FycmF5LmZyb20oZXhwbGFuYXRpb24ub3BlcmF0aW9ucykuam9pbignIEFORCAnKX1gKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKG1lc3NhZ2UsIHtcbiAgICAgICAgY29sbGVjdGlvbjogY29sbGVjdGlvbk5hbWUsXG4gICAgICAgIGZpbHRlcixcbiAgICAgICAgb3JkZXJCeTogb3JkZXJCeVRvU3RyaW5nKG9yZGVyQnkpLFxuICAgICAgICBmaWVsZHM6IGxvZ0ZpZWxkcyxcbiAgICAgICAgLi4uKHNlbGVjdGVkSW5kZXhlcyA/IHtzZWxlY3RlZEluZGV4ZXM6IHNlbGVjdGVkSW5kZXhlcy5tYXAoaW5kZXhUb1N0cmluZyl9IDoge30pLFxuICAgICAgICBhdmFpbGFibGVJbmRleGVzOiBjb2xsZWN0aW9uSW5kZXhlcy5tYXAoaW5kZXhUb1N0cmluZyksXG4gICAgfSk7XG5cbn1cblxuZnVuY3Rpb24gaXNGYXN0UXVlcnlPck9wZXJhbmQoXG4gICAgY29sbGVjdGlvbk5hbWU6IHN0cmluZyxcbiAgICBjb2xsZWN0aW9uSW5kZXhlczogUUluZGV4SW5mb1tdLFxuICAgIHR5cGU6IFFUeXBlLFxuICAgIGZpbHRlcjogYW55LFxuICAgIG9yZGVyQnk6IE9yZGVyQnlbXSxcbiAgICBsb2c6ID9RTG9nLFxuKTogYm9vbGVhbiB7XG4gICAgY29uc3QgcGFyYW1zID0gbmV3IFFQYXJhbXMoe1xuICAgICAgICBleHBsYWluOiB0cnVlLFxuICAgIH0pO1xuICAgIHR5cGUuZmlsdGVyQ29uZGl0aW9uKHBhcmFtcywgJycsIGZpbHRlcik7XG4gICAgaWYgKCFwYXJhbXMuZXhwbGFuYXRpb24pIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBjb25zdCBmaWVsZHMgPSBuZXcgTWFwPHN0cmluZywgUUZpZWxkRXhwbGFuYXRpb24+KCk7XG4gICAgZm9yIChjb25zdCBbZmllbGQsIGV4cGxhbmF0aW9uXSBvZiBwYXJhbXMuZXhwbGFuYXRpb24uZmllbGRzKSB7XG4gICAgICAgIGlmIChmaWVsZCAhPT0gJ3N0YXR1cycpIHtcbiAgICAgICAgICAgIGZpZWxkcy5zZXQoZmllbGQsIGV4cGxhbmF0aW9uKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoaGFzS2V5RXEoZmllbGRzKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKCFjYW5Vc2VDb25kaXRpb25zRm9ySW5kZXhlZFJhbmdlKGZpZWxkcykpIHtcbiAgICAgICAgaWYgKGxvZykge1xuICAgICAgICAgICAgbG9nU2xvd1JlYXNvbihcbiAgICAgICAgICAgICAgICAnRmlsdGVyIG9wZXJhdGlvbnMgY2FuXFwndCBiZSB1c2VkIGluIHJhbmdlZCBxdWVyaWVzJyxcbiAgICAgICAgICAgICAgICBsb2csIGZpbHRlciwgb3JkZXJCeSwgZmllbGRzLCBjb2xsZWN0aW9uTmFtZSwgY29sbGVjdGlvbkluZGV4ZXMsXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBpbmRleGVzID0gZ2V0VXNlZEluZGV4ZXMoZmllbGRzLCBjb2xsZWN0aW9uSW5kZXhlcyk7XG4gICAgaWYgKCFpbmRleGVzKSB7XG4gICAgICAgIGlmIChsb2cpIHtcbiAgICAgICAgICAgIGxvZ1Nsb3dSZWFzb24oXG4gICAgICAgICAgICAgICAgJ0F2YWlsYWJsZSBpbmRleGVzIGNhblxcJ3QgYmUgdXNlZCBmb3IgZmlsdGVyIGZpZWxkcycsXG4gICAgICAgICAgICAgICAgbG9nLCBmaWx0ZXIsIG9yZGVyQnksIGZpZWxkcywgY29sbGVjdGlvbk5hbWUsIGNvbGxlY3Rpb25JbmRleGVzXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAob3JkZXJCeS5sZW5ndGggPiAwKSB7XG4gICAgICAgIGlmICghb3JkZXJCeUNhblVzZUFueUluZGV4KG9yZGVyQnksIGZpZWxkcywgaW5kZXhlcykpIHtcbiAgICAgICAgICAgIGlmIChsb2cpIHtcbiAgICAgICAgICAgICAgICBsb2dTbG93UmVhc29uKFxuICAgICAgICAgICAgICAgICAgICAnT3JkZXIgYnkgY2FuXFwndCB1c2UgYW55IHNlbGVjdGVkIGluZGV4JyxcbiAgICAgICAgICAgICAgICAgICAgbG9nLCBmaWx0ZXIsIG9yZGVyQnksIGZpZWxkcywgY29sbGVjdGlvbk5hbWUsIGNvbGxlY3Rpb25JbmRleGVzLCBpbmRleGVzLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRmFzdFF1ZXJ5KFxuICAgIGNvbGxlY3Rpb25OYW1lOiBzdHJpbmcsXG4gICAgY29sbGVjdGlvbkluZGV4ZXM6IFFJbmRleEluZm9bXSxcbiAgICB0eXBlOiBRVHlwZSxcbiAgICBmaWx0ZXI6IGFueSxcbiAgICBvcmRlckJ5OiBPcmRlckJ5W10sXG4gICAgbG9nOiA/UUxvZyxcbik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG9yT3BlcmFuZHMgPSBzcGxpdE9yKGZpbHRlcik7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvck9wZXJhbmRzLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgIGlmICghaXNGYXN0UXVlcnlPck9wZXJhbmQoY29sbGVjdGlvbk5hbWUsIGNvbGxlY3Rpb25JbmRleGVzLCB0eXBlLCBvck9wZXJhbmRzW2ldLCBvcmRlckJ5LCBsb2cpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG59XG4iXX0=