"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Auth = void 0;

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const grantedAccess = Object.freeze({
  granted: true,
  restrictToAccounts: []
});
const deniedAccess = Object.freeze({
  granted: false,
  restrictToAccounts: []
});

class Auth {
  constructor(config) {
    this.config = config;
  }

  static extractAccessKey(req, connection) {
    return req && req.headers && (req.headers.accessKey || req.headers.accesskey) || connection && connection.context && connection.context.accessKey;
  }

  static unauthorizedError() {
    return (0, _utils.createError)(401, 'Unauthorized');
  }

  authServiceRequired() {
    if (!this.config.authorization.endpoint) {
      throw (0, _utils.createError)(500, 'Auth service unavailable');
    }
  }

  async requireGrantedAccess(accessKey) {
    const access = await this.getAccessRights(accessKey);

    if (!access.granted) {
      throw Auth.unauthorizedError();
    }

    return access;
  }

  async getAccessRights(accessKey) {
    if (!this.config.authorization.endpoint) {
      return grantedAccess;
    }

    if ((accessKey || '') === '') {
      return deniedAccess;
    }

    const rights = await this.invokeAuth('getAccessRights', {
      accessKey
    });

    if (!rights.restrictToAccounts) {
      rights.restrictToAccounts = [];
    }

    return rights;
  }

  async getManagementAccessKey() {
    this.authServiceRequired();
    return this.invokeAuth('getManagementAccessKey', {});
  }

  async registerAccessKeys(account, keys, signedManagementAccessKey) {
    this.authServiceRequired();
    return this.invokeAuth('registerAccessKeys', {
      account,
      keys,
      signedManagementAccessKey
    });
  }

  async revokeAccessKeys(account, keys, signedManagementAccessKey) {
    this.authServiceRequired();
    return this.invokeAuth('revokeAccessKeys', {
      account,
      keys,
      signedManagementAccessKey
    });
  }

  async invokeAuth(method, params) {
    const res = await (0, _nodeFetch.default)(this.config.authorization.endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        jsonrpc: '2.0',
        id: '1',
        method,
        params
      })
    });

    if (res.status !== 200) {
      throw new Error(`Auth service failed: ${await res.text()}`);
    }

    const response = await res.json();

    if (response.error) {
      const error = new Error(response.error.message || response.error.description);
      error.source = response.error.source || 'graphql';
      error.code = response.error.code || 500;
      throw error;
    }

    return response.result;
  }

}

exports.Auth = Auth;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hdXRoLmpzIl0sIm5hbWVzIjpbImdyYW50ZWRBY2Nlc3MiLCJPYmplY3QiLCJmcmVlemUiLCJncmFudGVkIiwicmVzdHJpY3RUb0FjY291bnRzIiwiZGVuaWVkQWNjZXNzIiwiQXV0aCIsImNvbnN0cnVjdG9yIiwiY29uZmlnIiwiZXh0cmFjdEFjY2Vzc0tleSIsInJlcSIsImNvbm5lY3Rpb24iLCJoZWFkZXJzIiwiYWNjZXNzS2V5IiwiYWNjZXNza2V5IiwiY29udGV4dCIsInVuYXV0aG9yaXplZEVycm9yIiwiYXV0aFNlcnZpY2VSZXF1aXJlZCIsImF1dGhvcml6YXRpb24iLCJlbmRwb2ludCIsInJlcXVpcmVHcmFudGVkQWNjZXNzIiwiYWNjZXNzIiwiZ2V0QWNjZXNzUmlnaHRzIiwicmlnaHRzIiwiaW52b2tlQXV0aCIsImdldE1hbmFnZW1lbnRBY2Nlc3NLZXkiLCJyZWdpc3RlckFjY2Vzc0tleXMiLCJhY2NvdW50Iiwia2V5cyIsInNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXkiLCJyZXZva2VBY2Nlc3NLZXlzIiwibWV0aG9kIiwicGFyYW1zIiwicmVzIiwiYm9keSIsIkpTT04iLCJzdHJpbmdpZnkiLCJqc29ucnBjIiwiaWQiLCJzdGF0dXMiLCJFcnJvciIsInRleHQiLCJyZXNwb25zZSIsImpzb24iLCJlcnJvciIsIm1lc3NhZ2UiLCJkZXNjcmlwdGlvbiIsInNvdXJjZSIsImNvZGUiLCJyZXN1bHQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFHQTs7QUFDQTs7OztBQVlBLE1BQU1BLGFBQTJCLEdBQUdDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjO0FBQzlDQyxFQUFBQSxPQUFPLEVBQUUsSUFEcUM7QUFFOUNDLEVBQUFBLGtCQUFrQixFQUFFO0FBRjBCLENBQWQsQ0FBcEM7QUFLQSxNQUFNQyxZQUEwQixHQUFHSixNQUFNLENBQUNDLE1BQVAsQ0FBYztBQUM3Q0MsRUFBQUEsT0FBTyxFQUFFLEtBRG9DO0FBRTdDQyxFQUFBQSxr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Z0I7QUFEWCxPQUYrQztBQUt4RHNCLE1BQUFBLElBQUksRUFBRUMsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFDakJDLFFBQUFBLE9BQU8sRUFBRSxLQURRO0FBRWpCQyxRQUFBQSxFQUFFLEVBQUUsR0FGYTtBQUdqQlAsUUFBQUEsTUFIaUI7QUFJakJDLFFBQUFBO0FBSmlCLE9BQWY7QUFMa0QsS0FBMUMsQ0FBbEI7O0FBYUEsUUFBSUMsR0FBRyxDQUFDTSxNQUFKLEtBQWUsR0FBbkIsRUFBd0I7QUFDcEIsWUFBTSxJQUFJQyxLQUFKLENBQVcsd0JBQXVCLE1BQU1QLEdBQUcsQ0FBQ1EsSUFBSixFQUFXLEVBQW5ELENBQU47QUFDSDs7QUFFRCxVQUFNQyxRQUFRLEdBQUcsTUFBTVQsR0FBRyxDQUFDVSxJQUFKLEVBQXZCOztBQUNBLFFBQUlELFFBQVEsQ0FBQ0UsS0FBYixFQUFvQjtBQUNoQixZQUFNQSxLQUFLLEdBQUcsSUFBSUosS0FBSixDQUFVRSxRQUFRLENBQUNFLEtBQVQsQ0FBZUMsT0FBZixJQUEwQkgsUUFBUSxDQUFDRSxLQUFULENBQWVFLFdBQW5ELENBQWQ7QUFDQ0YsTUFBQUEsS0FBRCxDQUFhRyxNQUFiLEdBQXNCTCxRQUFRLENBQUNFLEtBQVQsQ0FBZUcsTUFBZixJQUF5QixTQUEvQztBQUNDSCxNQUFBQSxLQUFELENBQWFJLElBQWIsR0FBb0JOLFFBQVEsQ0FBQ0UsS0FBVCxDQUFlSSxJQUFmLElBQXVCLEdBQTNDO0FBQ0EsWUFBTUosS0FBTjtBQUNIOztBQUVELFdBQU9GLFFBQVEsQ0FBQ08sTUFBaEI7QUFDSDs7QUF4R2EiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgdHlwZSB7IFFDb25maWcgfSBmcm9tIFwiLi9jb25maWdcIjtcbmltcG9ydCBmZXRjaCBmcm9tICdub2RlLWZldGNoJztcbmltcG9ydCB7IGNyZWF0ZUVycm9yIH0gZnJvbSBcIi4vdXRpbHNcIjtcblxuZXhwb3J0IHR5cGUgQWNjZXNzS2V5ID0ge1xuICAgIGtleTogc3RyaW5nLFxuICAgIHJlc3RyaWN0VG9BY2NvdW50cz86IHN0cmluZ1tdLFxufVxuXG5leHBvcnQgdHlwZSBBY2Nlc3NSaWdodHMgPSB7XG4gICAgZ3JhbnRlZDogYm9vbCxcbiAgICByZXN0cmljdFRvQWNjb3VudHM6IHN0cmluZ1tdLFxufVxuXG5jb25zdCBncmFudGVkQWNjZXNzOiBBY2Nlc3NSaWdodHMgPSBPYmplY3QuZnJlZXplKHtcbiAgICBncmFudGVkOiB0cnVlLFxuICAgIHJlc3RyaWN0VG9BY2NvdW50czogW10sXG59KTtcblxuY29uc3QgZGVuaWVkQWNjZXNzOiBBY2Nlc3NSaWdodHMgPSBPYmplY3QuZnJlZXplKHtcbiAgICBncmFudGVkOiBmYWxzZSxcbiAgICByZXN0cmljdFRvQWNjb3VudHM6IFtdLFxufSk7XG5cbmV4cG9ydCBjbGFzcyBBdXRoIHtcbiAgICBjb25maWc6IFFDb25maWc7XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IFFDb25maWcpIHtcbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgfVxuXG4gICAgc3RhdGljIGV4dHJhY3RBY2Nlc3NLZXkocmVxOiBhbnksIGNvbm5lY3Rpb246IGFueSk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiAocmVxICYmIHJlcS5oZWFkZXJzICYmIChyZXEuaGVhZGVycy5hY2Nlc3NLZXkgfHwgcmVxLmhlYWRlcnMuYWNjZXNza2V5KSlcbiAgICAgICAgICAgIHx8IChjb25uZWN0aW9uICYmIGNvbm5lY3Rpb24uY29udGV4dCAmJiBjb25uZWN0aW9uLmNvbnRleHQuYWNjZXNzS2V5KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgdW5hdXRob3JpemVkRXJyb3IoKTogRXJyb3Ige1xuICAgICAgICByZXR1cm4gY3JlYXRlRXJyb3IoNDAxLCAnVW5hdXRob3JpemVkJyk7XG4gICAgfVxuXG4gICAgYXV0aFNlcnZpY2VSZXF1aXJlZCgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNvbmZpZy5hdXRob3JpemF0aW9uLmVuZHBvaW50KSB7XG4gICAgICAgICAgICB0aHJvdyBjcmVhdGVFcnJvcig1MDAsICdBdXRoIHNlcnZpY2UgdW5hdmFpbGFibGUnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIHJlcXVpcmVHcmFudGVkQWNjZXNzKGFjY2Vzc0tleTogc3RyaW5nIHwgdHlwZW9mIHVuZGVmaW5lZCk6IFByb21pc2U8QWNjZXNzUmlnaHRzPiB7XG4gICAgICAgIGNvbnN0IGFjY2VzcyA9IGF3YWl0IHRoaXMuZ2V0QWNjZXNzUmlnaHRzKGFjY2Vzc0tleSk7XG4gICAgICAgIGlmICghYWNjZXNzLmdyYW50ZWQpIHtcbiAgICAgICAgICAgIHRocm93IEF1dGgudW5hdXRob3JpemVkRXJyb3IoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWNjZXNzO1xuICAgIH1cblxuICAgIGFzeW5jIGdldEFjY2Vzc1JpZ2h0cyhhY2Nlc3NLZXk6IHN0cmluZyB8IHR5cGVvZiB1bmRlZmluZWQpOiBQcm9taXNlPEFjY2Vzc1JpZ2h0cz4ge1xuICAgICAgICBpZiAoIXRoaXMuY29uZmlnLmF1dGhvcml6YXRpb24uZW5kcG9pbnQpIHtcbiAgICAgICAgICAgIHJldHVybiBncmFudGVkQWNjZXNzO1xuICAgICAgICB9XG4gICAgICAgIGlmICgoYWNjZXNzS2V5IHx8ICcnKSA9PT0gJycpIHtcbiAgICAgICAgICAgIHJldHVybiBkZW5pZWRBY2Nlc3M7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcmlnaHRzID0gYXdhaXQgdGhpcy5pbnZva2VBdXRoKCdnZXRBY2Nlc3NSaWdodHMnLCB7XG4gICAgICAgICAgICBhY2Nlc3NLZXksXG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoIXJpZ2h0cy5yZXN0cmljdFRvQWNjb3VudHMpIHtcbiAgICAgICAgICAgIHJpZ2h0cy5yZXN0cmljdFRvQWNjb3VudHMgPSBbXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmlnaHRzO1xuICAgIH1cblxuICAgIGFzeW5jIGdldE1hbmFnZW1lbnRBY2Nlc3NLZXkoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgdGhpcy5hdXRoU2VydmljZVJlcXVpcmVkKCk7XG4gICAgICAgIHJldHVybiB0aGlzLmludm9rZUF1dGgoJ2dldE1hbmFnZW1lbnRBY2Nlc3NLZXknLCB7fSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVnaXN0ZXJBY2Nlc3NLZXlzKFxuICAgICAgICBhY2NvdW50OiBzdHJpbmcsXG4gICAgICAgIGtleXM6IEFjY2Vzc0tleVtdLFxuICAgICAgICBzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5OiBzdHJpbmdcbiAgICApOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICB0aGlzLmF1dGhTZXJ2aWNlUmVxdWlyZWQoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW52b2tlQXV0aCgncmVnaXN0ZXJBY2Nlc3NLZXlzJywge1xuICAgICAgICAgICAgYWNjb3VudCxcbiAgICAgICAgICAgIGtleXMsXG4gICAgICAgICAgICBzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIHJldm9rZUFjY2Vzc0tleXMoXG4gICAgICAgIGFjY291bnQ6IHN0cmluZyxcbiAgICAgICAga2V5czogc3RyaW5nW10sXG4gICAgICAgIHNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXk6IHN0cmluZ1xuICAgICk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIHRoaXMuYXV0aFNlcnZpY2VSZXF1aXJlZCgpO1xuICAgICAgICByZXR1cm4gdGhpcy5pbnZva2VBdXRoKCdyZXZva2VBY2Nlc3NLZXlzJywge1xuICAgICAgICAgICAgYWNjb3VudCxcbiAgICAgICAgICAgIGtleXMsXG4gICAgICAgICAgICBzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGludm9rZUF1dGgobWV0aG9kOiBzdHJpbmcsIHBhcmFtczogYW55KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2godGhpcy5jb25maWcuYXV0aG9yaXphdGlvbi5lbmRwb2ludCwge1xuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAganNvbnJwYzogJzIuMCcsXG4gICAgICAgICAgICAgICAgaWQ6ICcxJyxcbiAgICAgICAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgICAgICAgcGFyYW1zXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKHJlcy5zdGF0dXMgIT09IDIwMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBdXRoIHNlcnZpY2UgZmFpbGVkOiAke2F3YWl0IHJlcy50ZXh0KCl9YCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcy5qc29uKCk7XG4gICAgICAgIGlmIChyZXNwb25zZS5lcnJvcikge1xuICAgICAgICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IocmVzcG9uc2UuZXJyb3IubWVzc2FnZSB8fCByZXNwb25zZS5lcnJvci5kZXNjcmlwdGlvbik7XG4gICAgICAgICAgICAoZXJyb3I6IGFueSkuc291cmNlID0gcmVzcG9uc2UuZXJyb3Iuc291cmNlIHx8ICdncmFwaHFsJztcbiAgICAgICAgICAgIChlcnJvcjogYW55KS5jb2RlID0gcmVzcG9uc2UuZXJyb3IuY29kZSB8fCA1MDA7XG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXNwb25zZS5yZXN1bHQ7XG4gICAgfVxuXG59XG4iXX0=