"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Auth = void 0;

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const grantedAccess = Object.freeze({
  granted: true,
  restrictToAccounts: []
});
const deniedAccess = Object.freeze({
  granted: false,
  restrictToAccounts: []
});

class Auth {
  constructor(config) {
    this.config = config;
  }

  static extractAccessKey(req, connection) {
    return req && req.headers && (req.headers.accessKey || req.headers.accesskey) || connection && connection.context && connection.context.accessKey;
  }

  static unauthorizedError() {
    return _utils.QError.unauthorized();
  }

  authServiceRequired() {
    if (!this.config.authorization.endpoint) {
      throw _utils.QError.authServiceUnavailable();
    }
  }

  async requireGrantedAccess(accessKey) {
    const access = await this.getAccessRights(accessKey);

    if (!access.granted) {
      throw Auth.unauthorizedError();
    }

    return access;
  }

  async getAccessRights(accessKey) {
    if (!this.config.authorization.endpoint) {
      return grantedAccess;
    }

    if ((accessKey || '') === '') {
      return deniedAccess;
    }

    const rights = await this.invokeAuth('getAccessRights', {
      accessKey
    });

    if (!rights.restrictToAccounts) {
      rights.restrictToAccounts = [];
    }

    return rights;
  }

  async getManagementAccessKey() {
    this.authServiceRequired();
    return this.invokeAuth('getManagementAccessKey', {});
  }

  async registerAccessKeys(account, keys, signedManagementAccessKey) {
    this.authServiceRequired();
    return this.invokeAuth('registerAccessKeys', {
      account,
      keys,
      signedManagementAccessKey
    });
  }

  async revokeAccessKeys(account, keys, signedManagementAccessKey) {
    this.authServiceRequired();
    return this.invokeAuth('revokeAccessKeys', {
      account,
      keys,
      signedManagementAccessKey
    });
  }

  async invokeAuth(method, params) {
    const res = await (0, _nodeFetch.default)(this.config.authorization.endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        jsonrpc: '2.0',
        id: '1',
        method,
        params
      })
    });

    if (res.status !== 200) {
      throw new Error(`Auth service failed: ${await res.text()}`);
    }

    const response = await res.json();

    if (response.error) {
      throw _utils.QError.auth(response.error);
    }

    return response.result;
  }

}

exports.Auth = Auth;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hdXRoLmpzIl0sIm5hbWVzIjpbImdyYW50ZWRBY2Nlc3MiLCJPYmplY3QiLCJmcmVlemUiLCJncmFudGVkIiwicmVzdHJpY3RUb0FjY291bnRzIiwiZGVuaWVkQWNjZXNzIiwiQXV0aCIsImNvbnN0cnVjdG9yIiwiY29uZmlnIiwiZXh0cmFjdEFjY2Vzc0tleSIsInJlcSIsImNvbm5lY3Rpb24iLCJoZWFkZXJzIiwiYWNjZXNzS2V5IiwiYWNjZXNza2V5IiwiY29udGV4dCIsInVuYXV0aG9yaXplZEVycm9yIiwiUUVycm9yIiwidW5hdXRob3JpemVkIiwiYXV0aFNlcnZpY2VSZXF1aXJlZCIsImF1dGhvcml6YXRpb24iLCJlbmRwb2ludCIsImF1dGhTZXJ2aWNlVW5hdmFpbGFibGUiLCJyZXF1aXJlR3JhbnRlZEFjY2VzcyIsImFjY2VzcyIsImdldEFjY2Vzc1JpZ2h0cyIsInJpZ2h0cyIsImludm9rZUF1dGgiLCJnZXRNYW5hZ2VtZW50QWNjZXNzS2V5IiwicmVnaXN0ZXJBY2Nlc3NLZXlzIiwiYWNjb3VudCIsImtleXMiLCJzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5IiwicmV2b2tlQWNjZXNzS2V5cyIsIm1ldGhvZCIsInBhcmFtcyIsInJlcyIsImJvZHkiLCJKU09OIiwic3RyaW5naWZ5IiwianNvbnJwYyIsImlkIiwic3RhdHVzIiwiRXJyb3IiLCJ0ZXh0IiwicmVzcG9uc2UiLCJqc29uIiwiZXJyb3IiLCJhdXRoIiwicmVzdWx0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBR0E7O0FBQ0E7Ozs7QUFZQSxNQUFNQSxhQUEyQixHQUFHQyxNQUFNLENBQUNDLE1BQVAsQ0FBYztBQUM5Q0MsRUFBQUEsT0FBTyxFQUFFLElBRHFDO0FBRTlDQyxFQUFBQSxrQkFBa0IsRUFBRTtBQUYwQixDQUFkLENBQXBDO0FBS0EsTUFBTUMsWUFBMEIsR0FBR0osTUFBTSxDQUFDQyxNQUFQLENBQWM7QUFDN0NDLEVBQUFBLE9BQU8sRUFBRSxLQURv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WCxPQUYrQztBQUt4RHlCLE1BQUFBLElBQUksRUFBRUMsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFDakJDLFFBQUFBLE9BQU8sRUFBRSxLQURRO0FBRWpCQyxRQUFBQSxFQUFFLEVBQUUsR0FGYTtBQUdqQlAsUUFBQUEsTUFIaUI7QUFJakJDLFFBQUFBO0FBSmlCLE9BQWY7QUFMa0QsS0FBMUMsQ0FBbEI7O0FBYUEsUUFBSUMsR0FBRyxDQUFDTSxNQUFKLEtBQWUsR0FBbkIsRUFBd0I7QUFDcEIsWUFBTSxJQUFJQyxLQUFKLENBQVcsd0JBQXVCLE1BQU1QLEdBQUcsQ0FBQ1EsSUFBSixFQUFXLEVBQW5ELENBQU47QUFDSDs7QUFFRCxVQUFNQyxRQUFRLEdBQUcsTUFBTVQsR0FBRyxDQUFDVSxJQUFKLEVBQXZCOztBQUNBLFFBQUlELFFBQVEsQ0FBQ0UsS0FBYixFQUFvQjtBQUNoQixZQUFNOUIsY0FBTytCLElBQVAsQ0FBWUgsUUFBUSxDQUFDRSxLQUFyQixDQUFOO0FBQ0g7O0FBRUQsV0FBT0YsUUFBUSxDQUFDSSxNQUFoQjtBQUNIOztBQXJHYSIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB0eXBlIHsgUUNvbmZpZyB9IGZyb20gXCIuL2NvbmZpZ1wiO1xuaW1wb3J0IGZldGNoIGZyb20gJ25vZGUtZmV0Y2gnO1xuaW1wb3J0IHsgUUVycm9yIH0gZnJvbSBcIi4vdXRpbHNcIjtcblxuZXhwb3J0IHR5cGUgQWNjZXNzS2V5ID0ge1xuICAgIGtleTogc3RyaW5nLFxuICAgIHJlc3RyaWN0VG9BY2NvdW50cz86IHN0cmluZ1tdLFxufVxuXG5leHBvcnQgdHlwZSBBY2Nlc3NSaWdodHMgPSB7XG4gICAgZ3JhbnRlZDogYm9vbCxcbiAgICByZXN0cmljdFRvQWNjb3VudHM6IHN0cmluZ1tdLFxufVxuXG5jb25zdCBncmFudGVkQWNjZXNzOiBBY2Nlc3NSaWdodHMgPSBPYmplY3QuZnJlZXplKHtcbiAgICBncmFudGVkOiB0cnVlLFxuICAgIHJlc3RyaWN0VG9BY2NvdW50czogW10sXG59KTtcblxuY29uc3QgZGVuaWVkQWNjZXNzOiBBY2Nlc3NSaWdodHMgPSBPYmplY3QuZnJlZXplKHtcbiAgICBncmFudGVkOiBmYWxzZSxcbiAgICByZXN0cmljdFRvQWNjb3VudHM6IFtdLFxufSk7XG5cbmV4cG9ydCBjbGFzcyBBdXRoIHtcbiAgICBjb25maWc6IFFDb25maWc7XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IFFDb25maWcpIHtcbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgfVxuXG4gICAgc3RhdGljIGV4dHJhY3RBY2Nlc3NLZXkocmVxOiBhbnksIGNvbm5lY3Rpb246IGFueSk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiAocmVxICYmIHJlcS5oZWFkZXJzICYmIChyZXEuaGVhZGVycy5hY2Nlc3NLZXkgfHwgcmVxLmhlYWRlcnMuYWNjZXNza2V5KSlcbiAgICAgICAgICAgIHx8IChjb25uZWN0aW9uICYmIGNvbm5lY3Rpb24uY29udGV4dCAmJiBjb25uZWN0aW9uLmNvbnRleHQuYWNjZXNzS2V5KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgdW5hdXRob3JpemVkRXJyb3IoKTogRXJyb3Ige1xuICAgICAgICByZXR1cm4gUUVycm9yLnVuYXV0aG9yaXplZCgpO1xuICAgIH1cblxuICAgIGF1dGhTZXJ2aWNlUmVxdWlyZWQoKSB7XG4gICAgICAgIGlmICghdGhpcy5jb25maWcuYXV0aG9yaXphdGlvbi5lbmRwb2ludCkge1xuICAgICAgICAgICAgdGhyb3cgUUVycm9yLmF1dGhTZXJ2aWNlVW5hdmFpbGFibGUoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIHJlcXVpcmVHcmFudGVkQWNjZXNzKGFjY2Vzc0tleTogc3RyaW5nIHwgdHlwZW9mIHVuZGVmaW5lZCk6IFByb21pc2U8QWNjZXNzUmlnaHRzPiB7XG4gICAgICAgIGNvbnN0IGFjY2VzcyA9IGF3YWl0IHRoaXMuZ2V0QWNjZXNzUmlnaHRzKGFjY2Vzc0tleSk7XG4gICAgICAgIGlmICghYWNjZXNzLmdyYW50ZWQpIHtcbiAgICAgICAgICAgIHRocm93IEF1dGgudW5hdXRob3JpemVkRXJyb3IoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWNjZXNzO1xuICAgIH1cblxuICAgIGFzeW5jIGdldEFjY2Vzc1JpZ2h0cyhhY2Nlc3NLZXk6IHN0cmluZyB8IHR5cGVvZiB1bmRlZmluZWQpOiBQcm9taXNlPEFjY2Vzc1JpZ2h0cz4ge1xuICAgICAgICBpZiAoIXRoaXMuY29uZmlnLmF1dGhvcml6YXRpb24uZW5kcG9pbnQpIHtcbiAgICAgICAgICAgIHJldHVybiBncmFudGVkQWNjZXNzO1xuICAgICAgICB9XG4gICAgICAgIGlmICgoYWNjZXNzS2V5IHx8ICcnKSA9PT0gJycpIHtcbiAgICAgICAgICAgIHJldHVybiBkZW5pZWRBY2Nlc3M7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcmlnaHRzID0gYXdhaXQgdGhpcy5pbnZva2VBdXRoKCdnZXRBY2Nlc3NSaWdodHMnLCB7XG4gICAgICAgICAgICBhY2Nlc3NLZXksXG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoIXJpZ2h0cy5yZXN0cmljdFRvQWNjb3VudHMpIHtcbiAgICAgICAgICAgIHJpZ2h0cy5yZXN0cmljdFRvQWNjb3VudHMgPSBbXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmlnaHRzO1xuICAgIH1cblxuICAgIGFzeW5jIGdldE1hbmFnZW1lbnRBY2Nlc3NLZXkoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgdGhpcy5hdXRoU2VydmljZVJlcXVpcmVkKCk7XG4gICAgICAgIHJldHVybiB0aGlzLmludm9rZUF1dGgoJ2dldE1hbmFnZW1lbnRBY2Nlc3NLZXknLCB7fSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVnaXN0ZXJBY2Nlc3NLZXlzKFxuICAgICAgICBhY2NvdW50OiBzdHJpbmcsXG4gICAgICAgIGtleXM6IEFjY2Vzc0tleVtdLFxuICAgICAgICBzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5OiBzdHJpbmdcbiAgICApOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICB0aGlzLmF1dGhTZXJ2aWNlUmVxdWlyZWQoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW52b2tlQXV0aCgncmVnaXN0ZXJBY2Nlc3NLZXlzJywge1xuICAgICAgICAgICAgYWNjb3VudCxcbiAgICAgICAgICAgIGtleXMsXG4gICAgICAgICAgICBzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIHJldm9rZUFjY2Vzc0tleXMoXG4gICAgICAgIGFjY291bnQ6IHN0cmluZyxcbiAgICAgICAga2V5czogc3RyaW5nW10sXG4gICAgICAgIHNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXk6IHN0cmluZ1xuICAgICk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIHRoaXMuYXV0aFNlcnZpY2VSZXF1aXJlZCgpO1xuICAgICAgICByZXR1cm4gdGhpcy5pbnZva2VBdXRoKCdyZXZva2VBY2Nlc3NLZXlzJywge1xuICAgICAgICAgICAgYWNjb3VudCxcbiAgICAgICAgICAgIGtleXMsXG4gICAgICAgICAgICBzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGludm9rZUF1dGgobWV0aG9kOiBzdHJpbmcsIHBhcmFtczogYW55KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2godGhpcy5jb25maWcuYXV0aG9yaXphdGlvbi5lbmRwb2ludCwge1xuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAganNvbnJwYzogJzIuMCcsXG4gICAgICAgICAgICAgICAgaWQ6ICcxJyxcbiAgICAgICAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgICAgICAgcGFyYW1zXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKHJlcy5zdGF0dXMgIT09IDIwMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBdXRoIHNlcnZpY2UgZmFpbGVkOiAke2F3YWl0IHJlcy50ZXh0KCl9YCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcy5qc29uKCk7XG4gICAgICAgIGlmIChyZXNwb25zZS5lcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgUUVycm9yLmF1dGgocmVzcG9uc2UuZXJyb3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlc3VsdDtcbiAgICB9XG5cbn1cbiJdfQ==