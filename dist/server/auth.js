"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Auth = void 0;

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const grantedAccess = Object.freeze({
  granted: true,
  restrictToAccounts: []
});
const deniedAccess = Object.freeze({
  granted: false,
  restrictToAccounts: []
});

class Auth {
  constructor(config) {
    this.config = config;
  }

  static extractAccessKey(req, connection) {
    return req && req.headers && (req.headers.accessKey || req.headers.accesskey) || connection && connection.context && connection.context.accessKey;
  }

  static error(code, message) {
    const error = new Error(message);
    error.source = 'graphql';
    error.code = code;
    return error;
  }

  static unauthorizedError() {
    return Auth.error(401, 'Unauthorized');
  }

  authServiceRequired() {
    if (!this.config.authorization.endpoint) {
      throw Auth.error(500, 'Auth service unavailable');
    }
  }

  async requireGrantedAccess(accessKey) {
    const access = await this.getAccessRights(accessKey);

    if (!access.granted) {
      throw Auth.unauthorizedError();
    }

    return access;
  }

  async getAccessRights(accessKey) {
    if (!this.config.authorization.endpoint) {
      return grantedAccess;
    }

    if ((accessKey || '') === '') {
      return deniedAccess;
    }

    const rights = await this.invokeAuth('getAccessRights', {
      accessKey
    });

    if (!rights.restrictToAccounts) {
      rights.restrictToAccounts = [];
    }

    return rights;
  }

  async getManagementAccessKey() {
    this.authServiceRequired();
    return this.invokeAuth('getManagementAccessKey', {});
  }

  async registerAccessKeys(account, keys, signedManagementAccessKey) {
    this.authServiceRequired();
    return this.invokeAuth('registerAccessKeys', {
      account,
      keys,
      signedManagementAccessKey
    });
  }

  async revokeAccessKeys(account, keys, signedManagementAccessKey) {
    this.authServiceRequired();
    return this.invokeAuth('revokeAccessKeys', {
      account,
      keys,
      signedManagementAccessKey
    });
  }

  async invokeAuth(method, params) {
    const res = await (0, _nodeFetch.default)(this.config.authorization.endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        jsonrpc: '2.0',
        id: '1',
        method,
        params
      })
    });

    if (res.status !== 200) {
      throw new Error(`Auth service failed: ${await res.text()}`);
    }

    const response = await res.json();

    if (response.error) {
      const error = new Error(response.error.message || response.error.description);
      error.source = response.error.source || 'graphql';
      error.code = response.error.code || 500;
      throw error;
    }

    return response.result;
  }

}

exports.Auth = Auth;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hdXRoLmpzIl0sIm5hbWVzIjpbImdyYW50ZWRBY2Nlc3MiLCJPYmplY3QiLCJmcmVlemUiLCJncmFudGVkIiwicmVzdHJpY3RUb0FjY291bnRzIiwiZGVuaWVkQWNjZXNzIiwiQXV0aCIsImNvbnN0cnVjdG9yIiwiY29uZmlnIiwiZXh0cmFjdEFjY2Vzc0tleSIsInJlcSIsImNvbm5lY3Rpb24iLCJoZWFkZXJzIiwiYWNjZXNzS2V5IiwiYWNjZXNza2V5IiwiY29udGV4dCIsImVycm9yIiwiY29kZSIsIm1lc3NhZ2UiLCJFcnJvciIsInNvdXJjZSIsInVuYXV0aG9yaXplZEVycm9yIiwiYXV0aFNlcnZpY2VSZXF1aXJlZCIsImF1dGhvcml6YXRpb24iLCJlbmRwb2ludCIsInJlcXVpcmVHcmFudGVkQWNjZXNzIiwiYWNjZXNzIiwiZ2V0QWNjZXNzUmlnaHRzIiwicmlnaHRzIiwiaW52b2tlQXV0aCIsImdldE1hbmFnZW1lbnRBY2Nlc3NLZXkiLCJyZWdpc3RlckFjY2Vzc0tleXMiLCJhY2NvdW50Iiwia2V5cyIsInNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXkiLCJyZXZva2VBY2Nlc3NLZXlzIiwibWV0aG9kIiwicGFyYW1zIiwicmVzIiwiYm9keSIsIkpTT04iLCJzdHJpbmdpZnkiLCJqc29ucnBjIiwiaWQiLCJzdGF0dXMiLCJ0ZXh0IiwicmVzcG9uc2UiLCJqc29uIiwiZGVzY3JpcHRpb24iLCJyZXN1bHQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFHQTs7OztBQVlBLE1BQU1BLGFBQTJCLEdBQUdDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjO0FBQzlDQyxFQUFBQSxPQUFPLEVBQUUsSUFEcUM7QUFFOUNDLEVBQUFBLGtCQUFrQixFQUFFO0FBRjBCLENBQWQsQ0FBcEM7QUFLQSxNQUFNQyxZQUEwQixHQUFHSixNQUFNLENBQUNDLE1BQVAsQ0FBYztBQUM3Q0MsRUFBQUEsT0FBTyxFQUFFLEtBRG9DO0FBRTdDQyxFQUFBQSxrQkFBa0Is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RUQsV0FBTzhCLFFBQVEsQ0FBQ0csTUFBaEI7QUFDSDs7QUEvR2EiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgdHlwZSB7IFFDb25maWcgfSBmcm9tIFwiLi9jb25maWdcIjtcbmltcG9ydCBmZXRjaCBmcm9tICdub2RlLWZldGNoJztcblxuZXhwb3J0IHR5cGUgQWNjZXNzS2V5ID0ge1xuICAgIGtleTogc3RyaW5nLFxuICAgIHJlc3RyaWN0VG9BY2NvdW50cz86IHN0cmluZ1tdLFxufVxuXG5leHBvcnQgdHlwZSBBY2Nlc3NSaWdodHMgPSB7XG4gICAgZ3JhbnRlZDogYm9vbCxcbiAgICByZXN0cmljdFRvQWNjb3VudHM6IHN0cmluZ1tdLFxufVxuXG5jb25zdCBncmFudGVkQWNjZXNzOiBBY2Nlc3NSaWdodHMgPSBPYmplY3QuZnJlZXplKHtcbiAgICBncmFudGVkOiB0cnVlLFxuICAgIHJlc3RyaWN0VG9BY2NvdW50czogW10sXG59KTtcblxuY29uc3QgZGVuaWVkQWNjZXNzOiBBY2Nlc3NSaWdodHMgPSBPYmplY3QuZnJlZXplKHtcbiAgICBncmFudGVkOiBmYWxzZSxcbiAgICByZXN0cmljdFRvQWNjb3VudHM6IFtdLFxufSk7XG5cbmV4cG9ydCBjbGFzcyBBdXRoIHtcbiAgICBjb25maWc6IFFDb25maWc7XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IFFDb25maWcpIHtcbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgfVxuXG4gICAgc3RhdGljIGV4dHJhY3RBY2Nlc3NLZXkocmVxOiBhbnksIGNvbm5lY3Rpb246IGFueSk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiAocmVxICYmIHJlcS5oZWFkZXJzICYmIChyZXEuaGVhZGVycy5hY2Nlc3NLZXkgfHwgcmVxLmhlYWRlcnMuYWNjZXNza2V5KSlcbiAgICAgICAgICAgIHx8IChjb25uZWN0aW9uICYmIGNvbm5lY3Rpb24uY29udGV4dCAmJiBjb25uZWN0aW9uLmNvbnRleHQuYWNjZXNzS2V5KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZXJyb3IoY29kZTogbnVtYmVyLCBtZXNzYWdlOiBzdHJpbmcpOiBFcnJvciB7XG4gICAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKG1lc3NhZ2UpO1xuICAgICAgICAoZXJyb3I6IGFueSkuc291cmNlID0gJ2dyYXBocWwnO1xuICAgICAgICAoZXJyb3I6IGFueSkuY29kZSA9IGNvZGU7XG4gICAgICAgIHJldHVybiBlcnJvcjtcbiAgICB9XG5cbiAgICBzdGF0aWMgdW5hdXRob3JpemVkRXJyb3IoKTogRXJyb3Ige1xuICAgICAgICByZXR1cm4gQXV0aC5lcnJvcig0MDEsICdVbmF1dGhvcml6ZWQnKTtcbiAgICB9XG5cbiAgICBhdXRoU2VydmljZVJlcXVpcmVkKCkge1xuICAgICAgICBpZiAoIXRoaXMuY29uZmlnLmF1dGhvcml6YXRpb24uZW5kcG9pbnQpIHtcbiAgICAgICAgICAgIHRocm93IEF1dGguZXJyb3IoNTAwLCAnQXV0aCBzZXJ2aWNlIHVuYXZhaWxhYmxlJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyByZXF1aXJlR3JhbnRlZEFjY2VzcyhhY2Nlc3NLZXk6IHN0cmluZyB8IHR5cGVvZiB1bmRlZmluZWQpOiBQcm9taXNlPEFjY2Vzc1JpZ2h0cz4ge1xuICAgICAgICBjb25zdCBhY2Nlc3MgPSBhd2FpdCB0aGlzLmdldEFjY2Vzc1JpZ2h0cyhhY2Nlc3NLZXkpO1xuICAgICAgICBpZiAoIWFjY2Vzcy5ncmFudGVkKSB7XG4gICAgICAgICAgICB0aHJvdyBBdXRoLnVuYXV0aG9yaXplZEVycm9yKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFjY2VzcztcbiAgICB9XG5cbiAgICBhc3luYyBnZXRBY2Nlc3NSaWdodHMoYWNjZXNzS2V5OiBzdHJpbmcgfCB0eXBlb2YgdW5kZWZpbmVkKTogUHJvbWlzZTxBY2Nlc3NSaWdodHM+IHtcbiAgICAgICAgaWYgKCF0aGlzLmNvbmZpZy5hdXRob3JpemF0aW9uLmVuZHBvaW50KSB7XG4gICAgICAgICAgICByZXR1cm4gZ3JhbnRlZEFjY2VzcztcbiAgICAgICAgfVxuICAgICAgICBpZiAoKGFjY2Vzc0tleSB8fCAnJykgPT09ICcnKSB7XG4gICAgICAgICAgICByZXR1cm4gZGVuaWVkQWNjZXNzO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJpZ2h0cyA9IGF3YWl0IHRoaXMuaW52b2tlQXV0aCgnZ2V0QWNjZXNzUmlnaHRzJywge1xuICAgICAgICAgICAgYWNjZXNzS2V5LFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKCFyaWdodHMucmVzdHJpY3RUb0FjY291bnRzKSB7XG4gICAgICAgICAgICByaWdodHMucmVzdHJpY3RUb0FjY291bnRzID0gW107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJpZ2h0cztcbiAgICB9XG5cbiAgICBhc3luYyBnZXRNYW5hZ2VtZW50QWNjZXNzS2V5KCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIHRoaXMuYXV0aFNlcnZpY2VSZXF1aXJlZCgpO1xuICAgICAgICByZXR1cm4gdGhpcy5pbnZva2VBdXRoKCdnZXRNYW5hZ2VtZW50QWNjZXNzS2V5Jywge30pO1xuICAgIH1cblxuICAgIGFzeW5jIHJlZ2lzdGVyQWNjZXNzS2V5cyhcbiAgICAgICAgYWNjb3VudDogc3RyaW5nLFxuICAgICAgICBrZXlzOiBBY2Nlc3NLZXlbXSxcbiAgICAgICAgc2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleTogc3RyaW5nXG4gICAgKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICAgICAgdGhpcy5hdXRoU2VydmljZVJlcXVpcmVkKCk7XG4gICAgICAgIHJldHVybiB0aGlzLmludm9rZUF1dGgoJ3JlZ2lzdGVyQWNjZXNzS2V5cycsIHtcbiAgICAgICAgICAgIGFjY291bnQsXG4gICAgICAgICAgICBrZXlzLFxuICAgICAgICAgICAgc2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyByZXZva2VBY2Nlc3NLZXlzKFxuICAgICAgICBhY2NvdW50OiBzdHJpbmcsXG4gICAgICAgIGtleXM6IHN0cmluZ1tdLFxuICAgICAgICBzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5OiBzdHJpbmdcbiAgICApOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICB0aGlzLmF1dGhTZXJ2aWNlUmVxdWlyZWQoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW52b2tlQXV0aCgncmV2b2tlQWNjZXNzS2V5cycsIHtcbiAgICAgICAgICAgIGFjY291bnQsXG4gICAgICAgICAgICBrZXlzLFxuICAgICAgICAgICAgc2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBpbnZva2VBdXRoKG1ldGhvZDogc3RyaW5nLCBwYXJhbXM6IGFueSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKHRoaXMuY29uZmlnLmF1dGhvcml6YXRpb24uZW5kcG9pbnQsIHtcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgIGlkOiAnMScsXG4gICAgICAgICAgICAgICAgbWV0aG9kLFxuICAgICAgICAgICAgICAgIHBhcmFtc1xuICAgICAgICAgICAgfSksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQXV0aCBzZXJ2aWNlIGZhaWxlZDogJHthd2FpdCByZXMudGV4dCgpfWApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXMuanNvbigpO1xuICAgICAgICBpZiAocmVzcG9uc2UuZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKHJlc3BvbnNlLmVycm9yLm1lc3NhZ2UgfHwgcmVzcG9uc2UuZXJyb3IuZGVzY3JpcHRpb24pO1xuICAgICAgICAgICAgKGVycm9yOiBhbnkpLnNvdXJjZSA9IHJlc3BvbnNlLmVycm9yLnNvdXJjZSB8fCAnZ3JhcGhxbCc7XG4gICAgICAgICAgICAoZXJyb3I6IGFueSkuY29kZSA9IHJlc3BvbnNlLmVycm9yLmNvZGUgfHwgNTAwO1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVzdWx0O1xuICAgIH1cblxufVxuIl19