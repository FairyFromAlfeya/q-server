"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Auth = exports.deniedAccess = exports.grantedAccess = void 0;

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const grantedAccess = Object.freeze({
  granted: true,
  restrictToAccounts: []
});
exports.grantedAccess = grantedAccess;
const deniedAccess = Object.freeze({
  granted: false,
  restrictToAccounts: []
});
exports.deniedAccess = deniedAccess;

class Auth {
  constructor(config) {
    this.config = config;
  }

  static extractAccessKey(req, connection) {
    return req && req.headers && (req.headers.accessKey || req.headers.accesskey) || connection && connection.context && connection.context.accessKey;
  }

  static unauthorizedError() {
    return _utils.QError.unauthorized();
  }

  authServiceRequired() {
    if (!this.config.authorization.endpoint) {
      throw _utils.QError.authServiceUnavailable();
    }
  }

  async requireGrantedAccess(accessKey) {
    const access = await this.getAccessRights(accessKey);

    if (!access.granted) {
      throw Auth.unauthorizedError();
    }

    return access;
  }

  async getAccessRights(accessKey) {
    if (!this.config.authorization.endpoint) {
      return grantedAccess;
    }

    if ((accessKey || '') === '') {
      return deniedAccess;
    }

    const rights = await this.invokeAuth('getAccessRights', {
      accessKey
    });

    if (!rights.restrictToAccounts) {
      rights.restrictToAccounts = [];
    }

    return rights;
  }

  async getManagementAccessKey() {
    this.authServiceRequired();
    return this.invokeAuth('getManagementAccessKey', {});
  }

  async registerAccessKeys(account, keys, signedManagementAccessKey) {
    this.authServiceRequired();
    return this.invokeAuth('registerAccessKeys', {
      account,
      keys,
      signedManagementAccessKey
    });
  }

  async revokeAccessKeys(account, keys, signedManagementAccessKey) {
    this.authServiceRequired();
    return this.invokeAuth('revokeAccessKeys', {
      account,
      keys,
      signedManagementAccessKey
    });
  }

  async invokeAuth(method, params) {
    const res = await (0, _nodeFetch.default)(this.config.authorization.endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        jsonrpc: '2.0',
        id: '1',
        method,
        params
      })
    });

    if (res.status !== 200) {
      throw new Error(`Auth service failed: ${await res.text()}`);
    }

    const response = await res.json();

    if (response.error) {
      throw _utils.QError.auth(response.error);
    }

    return response.result;
  }

}

exports.Auth = Auth;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvYXV0aC5qcyJdLCJuYW1lcyI6WyJncmFudGVkQWNjZXNzIiwiT2JqZWN0IiwiZnJlZXplIiwiZ3JhbnRlZCIsInJlc3RyaWN0VG9BY2NvdW50cyIsImRlbmllZEFjY2VzcyIsIkF1dGgiLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsImV4dHJhY3RBY2Nlc3NLZXkiLCJyZXEiLCJjb25uZWN0aW9uIiwiaGVhZGVycyIsImFjY2Vzc0tleSIsImFjY2Vzc2tleSIsImNvbnRleHQiLCJ1bmF1dGhvcml6ZWRFcnJvciIsIlFFcnJvciIsInVuYXV0aG9yaXplZCIsImF1dGhTZXJ2aWNlUmVxdWlyZWQiLCJhdXRob3JpemF0aW9uIiwiZW5kcG9pbnQiLCJhdXRoU2VydmljZVVuYXZhaWxhYmxlIiwicmVxdWlyZUdyYW50ZWRBY2Nlc3MiLCJhY2Nlc3MiLCJnZXRBY2Nlc3NSaWdodHMiLCJyaWdodHMiLCJpbnZva2VBdXRoIiwiZ2V0TWFuYWdlbWVudEFjY2Vzc0tleSIsInJlZ2lzdGVyQWNjZXNzS2V5cyIsImFjY291bnQiLCJrZXlzIiwic2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleSIsInJldm9rZUFjY2Vzc0tleXMiLCJtZXRob2QiLCJwYXJhbXMiLCJyZXMiLCJib2R5IiwiSlNPTiIsInN0cmluZ2lmeSIsImpzb25ycGMiLCJpZCIsInN0YXR1cyIsIkVycm9yIiwidGV4dCIsInJlc3BvbnNlIiwianNvbiIsImVycm9yIiwiYXV0aCIsInJlc3VsdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUdBOztBQUNBOzs7O0FBWU8sTUFBTUEsYUFBMkIsR0FBR0MsTUFBTSxDQUFDQyxNQUFQLENBQWM7QUFDckRDLEVBQUFBLE9BQU8sRUFBRSxJQUQ0QztBQUVyREMsRUFBQUEsa0JBQWtCLEVBQUU7QUFGaUMsQ0FBZCxDQUFwQzs7QUFLQSxNQUFNQyxZQUEwQixHQUFHSixNQUFNLENBQUNDLE1BQVAsQ0FBYztBQUNwREMsRUFBQUEsT0FBTyxFQUFF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QUFPLEVBQUU7QUFDTCx3QkFBZ0I7QUFEWCxPQUYrQztBQUt4RHlCLE1BQUFBLElBQUksRUFBRUMsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFDakJDLFFBQUFBLE9BQU8sRUFBRSxLQURRO0FBRWpCQyxRQUFBQSxFQUFFLEVBQUUsR0FGYTtBQUdqQlAsUUFBQUEsTUFIaUI7QUFJakJDLFFBQUFBO0FBSmlCLE9BQWY7QUFMa0QsS0FBMUMsQ0FBbEI7O0FBYUEsUUFBSUMsR0FBRyxDQUFDTSxNQUFKLEtBQWUsR0FBbkIsRUFBd0I7QUFDcEIsWUFBTSxJQUFJQyxLQUFKLENBQVcsd0JBQXVCLE1BQU1QLEdBQUcsQ0FBQ1EsSUFBSixFQUFXLEVBQW5ELENBQU47QUFDSDs7QUFFRCxVQUFNQyxRQUFRLEdBQUcsTUFBTVQsR0FBRyxDQUFDVSxJQUFKLEVBQXZCOztBQUNBLFFBQUlELFFBQVEsQ0FBQ0UsS0FBYixFQUFvQjtBQUNoQixZQUFNOUIsY0FBTytCLElBQVAsQ0FBWUgsUUFBUSxDQUFDRSxLQUFyQixDQUFOO0FBQ0g7O0FBRUQsV0FBT0YsUUFBUSxDQUFDSSxNQUFoQjtBQUNIOztBQXJHYSIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB0eXBlIHsgUUNvbmZpZyB9IGZyb20gXCIuL2NvbmZpZ1wiO1xuaW1wb3J0IGZldGNoIGZyb20gJ25vZGUtZmV0Y2gnO1xuaW1wb3J0IHsgUUVycm9yIH0gZnJvbSBcIi4vdXRpbHNcIjtcblxuZXhwb3J0IHR5cGUgQWNjZXNzS2V5ID0ge1xuICAgIGtleTogc3RyaW5nLFxuICAgIHJlc3RyaWN0VG9BY2NvdW50cz86IHN0cmluZ1tdLFxufVxuXG5leHBvcnQgdHlwZSBBY2Nlc3NSaWdodHMgPSB7XG4gICAgZ3JhbnRlZDogYm9vbCxcbiAgICByZXN0cmljdFRvQWNjb3VudHM6IHN0cmluZ1tdLFxufVxuXG5leHBvcnQgY29uc3QgZ3JhbnRlZEFjY2VzczogQWNjZXNzUmlnaHRzID0gT2JqZWN0LmZyZWV6ZSh7XG4gICAgZ3JhbnRlZDogdHJ1ZSxcbiAgICByZXN0cmljdFRvQWNjb3VudHM6IFtdLFxufSk7XG5cbmV4cG9ydCBjb25zdCBkZW5pZWRBY2Nlc3M6IEFjY2Vzc1JpZ2h0cyA9IE9iamVjdC5mcmVlemUoe1xuICAgIGdyYW50ZWQ6IGZhbHNlLFxuICAgIHJlc3RyaWN0VG9BY2NvdW50czogW10sXG59KTtcblxuZXhwb3J0IGNsYXNzIEF1dGgge1xuICAgIGNvbmZpZzogUUNvbmZpZztcblxuICAgIGNvbnN0cnVjdG9yKGNvbmZpZzogUUNvbmZpZykge1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICB9XG5cbiAgICBzdGF0aWMgZXh0cmFjdEFjY2Vzc0tleShyZXE6IGFueSwgY29ubmVjdGlvbjogYW55KTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIChyZXEgJiYgcmVxLmhlYWRlcnMgJiYgKHJlcS5oZWFkZXJzLmFjY2Vzc0tleSB8fCByZXEuaGVhZGVycy5hY2Nlc3NrZXkpKVxuICAgICAgICAgICAgfHwgKGNvbm5lY3Rpb24gJiYgY29ubmVjdGlvbi5jb250ZXh0ICYmIGNvbm5lY3Rpb24uY29udGV4dC5hY2Nlc3NLZXkpO1xuICAgIH1cblxuICAgIHN0YXRpYyB1bmF1dGhvcml6ZWRFcnJvcigpOiBFcnJvciB7XG4gICAgICAgIHJldHVybiBRRXJyb3IudW5hdXRob3JpemVkKCk7XG4gICAgfVxuXG4gICAgYXV0aFNlcnZpY2VSZXF1aXJlZCgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNvbmZpZy5hdXRob3JpemF0aW9uLmVuZHBvaW50KSB7XG4gICAgICAgICAgICB0aHJvdyBRRXJyb3IuYXV0aFNlcnZpY2VVbmF2YWlsYWJsZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgcmVxdWlyZUdyYW50ZWRBY2Nlc3MoYWNjZXNzS2V5OiBzdHJpbmcgfCB0eXBlb2YgdW5kZWZpbmVkKTogUHJvbWlzZTxBY2Nlc3NSaWdodHM+IHtcbiAgICAgICAgY29uc3QgYWNjZXNzID0gYXdhaXQgdGhpcy5nZXRBY2Nlc3NSaWdodHMoYWNjZXNzS2V5KTtcbiAgICAgICAgaWYgKCFhY2Nlc3MuZ3JhbnRlZCkge1xuICAgICAgICAgICAgdGhyb3cgQXV0aC51bmF1dGhvcml6ZWRFcnJvcigpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhY2Nlc3M7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0QWNjZXNzUmlnaHRzKGFjY2Vzc0tleTogc3RyaW5nIHwgdHlwZW9mIHVuZGVmaW5lZCk6IFByb21pc2U8QWNjZXNzUmlnaHRzPiB7XG4gICAgICAgIGlmICghdGhpcy5jb25maWcuYXV0aG9yaXphdGlvbi5lbmRwb2ludCkge1xuICAgICAgICAgICAgcmV0dXJuIGdyYW50ZWRBY2Nlc3M7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKChhY2Nlc3NLZXkgfHwgJycpID09PSAnJykge1xuICAgICAgICAgICAgcmV0dXJuIGRlbmllZEFjY2VzcztcbiAgICAgICAgfVxuICAgICAgICBjb25zdCByaWdodHMgPSBhd2FpdCB0aGlzLmludm9rZUF1dGgoJ2dldEFjY2Vzc1JpZ2h0cycsIHtcbiAgICAgICAgICAgIGFjY2Vzc0tleSxcbiAgICAgICAgfSk7XG4gICAgICAgIGlmICghcmlnaHRzLnJlc3RyaWN0VG9BY2NvdW50cykge1xuICAgICAgICAgICAgcmlnaHRzLnJlc3RyaWN0VG9BY2NvdW50cyA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByaWdodHM7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0TWFuYWdlbWVudEFjY2Vzc0tleSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICB0aGlzLmF1dGhTZXJ2aWNlUmVxdWlyZWQoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW52b2tlQXV0aCgnZ2V0TWFuYWdlbWVudEFjY2Vzc0tleScsIHt9KTtcbiAgICB9XG5cbiAgICBhc3luYyByZWdpc3RlckFjY2Vzc0tleXMoXG4gICAgICAgIGFjY291bnQ6IHN0cmluZyxcbiAgICAgICAga2V5czogQWNjZXNzS2V5W10sXG4gICAgICAgIHNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXk6IHN0cmluZ1xuICAgICk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIHRoaXMuYXV0aFNlcnZpY2VSZXF1aXJlZCgpO1xuICAgICAgICByZXR1cm4gdGhpcy5pbnZva2VBdXRoKCdyZWdpc3RlckFjY2Vzc0tleXMnLCB7XG4gICAgICAgICAgICBhY2NvdW50LFxuICAgICAgICAgICAga2V5cyxcbiAgICAgICAgICAgIHNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXlcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmV2b2tlQWNjZXNzS2V5cyhcbiAgICAgICAgYWNjb3VudDogc3RyaW5nLFxuICAgICAgICBrZXlzOiBzdHJpbmdbXSxcbiAgICAgICAgc2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleTogc3RyaW5nXG4gICAgKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICAgICAgdGhpcy5hdXRoU2VydmljZVJlcXVpcmVkKCk7XG4gICAgICAgIHJldHVybiB0aGlzLmludm9rZUF1dGgoJ3Jldm9rZUFjY2Vzc0tleXMnLCB7XG4gICAgICAgICAgICBhY2NvdW50LFxuICAgICAgICAgICAga2V5cyxcbiAgICAgICAgICAgIHNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXlcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgaW52b2tlQXV0aChtZXRob2Q6IHN0cmluZywgcGFyYW1zOiBhbnkpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaCh0aGlzLmNvbmZpZy5hdXRob3JpemF0aW9uLmVuZHBvaW50LCB7XG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcbiAgICAgICAgICAgICAgICBpZDogJzEnLFxuICAgICAgICAgICAgICAgIG1ldGhvZCxcbiAgICAgICAgICAgICAgICBwYXJhbXNcbiAgICAgICAgICAgIH0pLFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAocmVzLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEF1dGggc2VydmljZSBmYWlsZWQ6ICR7YXdhaXQgcmVzLnRleHQoKX1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVzLmpzb24oKTtcbiAgICAgICAgaWYgKHJlc3BvbnNlLmVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBRRXJyb3IuYXV0aChyZXNwb25zZS5lcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVzdWx0O1xuICAgIH1cblxufVxuIl19