"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.attachCustomResolvers = attachCustomResolvers;

var _fs = _interopRequireDefault(require("fs"));

var _kafkajs = require("kafkajs");

var _opentracing = require("opentracing");

var _arango = _interopRequireDefault(require("./arango"));

var _arangoCollection = require("./arango-collection");

var _auth = require("./auth");

var _config = require("./config");

var _path = _interopRequireDefault(require("path"));

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _tracer = require("./tracer");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function isObject(test) {
  return typeof test === 'object' && test !== null;
}

function overrideObject(original, overrides) {
  Object.entries(overrides).forEach(([name, overrideValue]) => {
    if (name in original && isObject(overrideValue) && isObject(original[name])) {
      overrideObject(original[name], overrideValue);
    } else {
      original[name] = overrideValue;
    }
  });
}

//------------------------------------------------------------- Query
function info() {
  const pkg = JSON.parse(_fs.default.readFileSync(_path.default.resolve(__dirname, '..', '..', 'package.json')));
  return {
    version: pkg.version
  };
}

async function getAccountsCount(_parent, args, context) {
  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, 'getAccountsCount', async () => {
    await (0, _arangoCollection.requireGrantedAccess)(context, args);
    const result = await context.db.query(`RETURN LENGTH(accounts)`, {});
    const counts = result;
    return counts.length > 0 ? counts[0] : 0;
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getTransactionsCount(_parent, args, context) {
  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, 'getTransactionsCount', async () => {
    await (0, _arangoCollection.requireGrantedAccess)(context, args);
    const result = await context.db.query(`RETURN LENGTH(transactions)`, {});
    const counts = result;
    return counts.length > 0 ? counts[0] : 0;
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getAccountsTotalBalance(_parent, args, context) {
  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, 'getAccountsTotalBalance', async () => {
    await (0, _arangoCollection.requireGrantedAccess)(context, args);
    /*
    Because arango can not sum BigInt's we need to sum separately:
    hs = SUM of high bits (from 24-bit and higher)
    ls = SUM of lower 24 bits
    And the total result is (hs << 24) + ls
     */

    const result = await context.db.query(`
            LET d = 16777216
            FOR a in accounts
            LET b = TO_NUMBER(CONCAT("0x", SUBSTRING(a.balance, 2)))
            COLLECT AGGREGATE
                hs = SUM(FLOOR(b / d)),
                ls = SUM(b % (d - 1))
            RETURN { hs, ls }
        `, {});
    const parts = result[0]; //$FlowFixMe

    return (BigInt(parts.hs) * BigInt(0x1000000) + BigInt(parts.ls)).toString();
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getManagementAccessKey(_parent, args, context) {
  return context.auth.getManagementAccessKey();
} //------------------------------------------------------------- Mutation


async function postRequestsUsingRest(requests, context, _span) {
  const config = context.config.requests;
  const url = `${(0, _config.ensureProtocol)(config.server, 'http')}/topics/${config.topic}`;
  const response = await (0, _nodeFetch.default)(url, {
    method: 'POST',
    mode: 'cors',
    cache: 'no-cache',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json'
    },
    redirect: 'follow',
    referrer: 'no-referrer',
    body: JSON.stringify({
      records: requests.map(request => ({
        key: request.id,
        value: request.body
      }))
    })
  });

  if (response.status !== 200) {
    const message = `Post requests failed: ${await response.text()}`;
    throw new Error(message);
  }
}

async function postRequestsUsingKafka(requests, context, span) {
  const ensureShared = async (name, createValue) => {
    if (context.shared.has(name)) {
      return context.shared.get(name);
    }

    const value = await createValue();
    context.shared.set(name, value);
    return value;
  };

  const config = context.config.requests;
  const producer = await ensureShared('producer', async () => {
    const kafka = await ensureShared('kafka', async () => new _kafkajs.Kafka({
      clientId: 'q-server',
      brokers: [config.server]
    }));
    const newProducer = kafka.producer();
    await newProducer.connect();
    return newProducer;
  });
  const messages = requests.map(request => {
    const traceInfo = {};
    context.db.tracer.inject(span, _opentracing.FORMAT_TEXT_MAP, traceInfo);
    const keyBuffer = Buffer.from(request.id, 'base64');
    const traceBuffer = Object.keys(traceInfo).length > 0 ? Buffer.from(JSON.stringify(traceInfo), 'utf8') : Buffer.from([]);
    const key = Buffer.concat([keyBuffer, traceBuffer]);
    return {
      key,
      value: Buffer.from(request.body, 'base64')
    };
  });
  await producer.send({
    topic: config.topic,
    messages
  });
}

async function checkPostRestrictions(contracts, requests, accessRights) {
  if (accessRights.restrictToAccounts.length === 0) {
    return;
  }

  const accounts = new Set(accessRights.restrictToAccounts);

  for (const request of requests) {
    const message = await contracts.parseMessage({
      bocBase64: request.body
    });

    if (!accounts.has(message.dst)) {
      throw _auth.Auth.unauthorizedError();
    }
  }
}

async function postRequests(_, args, context) {
  const requests = args.requests;

  if (!requests) {
    return [];
  }

  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, "postRequests", async span => {
    span.setTag('params', requests);
    const accessRights = await (0, _arangoCollection.requireGrantedAccess)(context, args);
    await checkPostRestrictions(context.client.contracts, requests, accessRights);
    const expired = requests.find(x => x.expireAt && Date.now() > x.expireAt);

    if (expired) {
      throw _utils.QError.messageExpired(expired.id, expired.expireAt);
    }

    try {
      if (context.config.requests.mode === 'rest') {
        await postRequestsUsingRest(requests, context, span);
      } else {
        await postRequestsUsingKafka(requests, context, span);
      }

      context.db.statPostCount.increment();
      context.db.log.debug('postRequests', 'POSTED', args, context.remoteAddress);
    } catch (error) {
      context.db.statPostFailed.increment();
      context.db.log.debug('postRequests', 'FAILED', args, context.remoteAddress);
      throw error;
    }

    return requests.map(x => x.id);
  }, context.parentSpan);
} //------------------------------------------------------------- Access Management


async function registerAccessKeys(_, args, context) {
  return context.auth.registerAccessKeys(args.account || '', args.keys || [], args.signedManagementAccessKey || '');
}

async function revokeAccessKeys(_, args, context) {
  return context.auth.revokeAccessKeys(args.account || '', args.keys || [], args.signedManagementAccessKey || '');
}

async function finishOperations(_, args, context) {
  const operationIds = new Set(args.operationIds || []);

  if (operationIds.size === 0) {
    return 0;
  }

  return context.db.finishOperations(operationIds);
}

function attachCustomResolvers(db, original) {
  overrideObject(original, {
    Query: {
      info,
      getAccountsCount,
      getTransactionsCount,
      getAccountsTotalBalance,
      getManagementAccessKey,
      aggregateBlockSignatures: db.blocks_signatures.aggregationResolver(),
      aggregateBlocks: db.blocks.aggregationResolver(),
      aggregateTransactions: db.transactions.aggregationResolver(),
      aggregateMessages: db.messages.aggregationResolver(),
      aggregateAccounts: db.accounts.aggregationResolver()
    },
    Mutation: {
      postRequests,
      registerAccessKeys,
      revokeAccessKeys,
      finishOperations
    }
  });
  return original;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9yZXNvbHZlcnMtY3VzdG9tLmpzIl0sIm5hbWVzIjpbImlzT2JqZWN0IiwidGVzdCIsIm92ZXJyaWRlT2JqZWN0Iiwib3JpZ2luYWwiLCJvdmVycmlkZXMiLCJPYmplY3QiLCJlbnRyaWVzIiwiZm9yRWFjaCIsIm5hbWUiLCJvdmVycmlkZVZhbHVlIiwiaW5mbyIsInBrZyIsIkpTT04iLCJwYXJzZSIsImZzIiwicmVhZEZpbGVTeW5jIiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJ2ZXJzaW9uIiwiZ2V0QWNjb3VudHNDb3VudCIsIl9wYXJlbnQiLCJhcmdzIiwiY29udGV4dCIsInRyYWNlciIsImRiIiwiUVRyYWNlciIsInRyYWNlIiwicmVzdWx0IiwicXVlcnkiLCJjb3VudHMiLCJsZW5ndGgiLCJnZXRQYXJlbnRTcGFuIiwiZ2V0VHJhbnNhY3Rpb25zQ291bnQiLCJnZXRBY2NvdW50c1RvdGFsQmFsYW5jZSIsInBhcnRzIiwiQmlnSW50IiwiaHMiLCJscyIsInRvU3RyaW5nIiwiZ2V0TWFuYWdlbWVudEFjY2Vzc0tleSIsImF1dGgiLCJwb3N0UmVxdWVzdHNVc2luZ1Jlc3QiLCJyZXF1ZXN0cyIsIl9zcGFuIiwiY29uZmlnIiwidXJsIiwic2VydmVyIiwidG9waWMiLCJyZXNwb25zZSIsIm1ldGhvZCIsIm1vZGUiLCJjYWNoZSIsImNyZWRlbnRpYWxzIiwiaGVhZGVycyIsInJlZGlyZWN0IiwicmVmZXJyZXIiLCJib2R5Iiwic3RyaW5naWZ5IiwicmVjb3JkcyIsIm1hcCIsInJlcXVlc3QiLCJrZXkiLCJpZCIsInZhbHVlIiwic3RhdHVzIiwibWVzc2FnZSIsInRleHQiLCJFcnJvciIsInBvc3RSZXF1ZXN0c1VzaW5nS2Fma2EiLCJzcGFuIiwiZW5zdXJlU2hhcmVkIiwiY3JlYXRlVmFsdWUiLCJzaGFyZWQiLCJoYXMiLCJnZXQiLCJzZXQiLCJwcm9kdWNlciIsImthZmthIiwiS2Fma2EiLCJjbGllbnRJZCIsImJyb2tlcnMiLCJuZXdQcm9kdWNlciIsImNvbm5lY3QiLCJtZXNzYWdlcyIsInRyYWNlSW5mbyIsImluamVjdCIsIkZPUk1BVF9URVhUX01BUCIsImtleUJ1ZmZlciIsIkJ1ZmZlciIsImZyb20iLCJ0cmFjZUJ1ZmZlciIsImtleXMiLCJjb25jYXQiLCJzZW5kIiwiY2hlY2tQb3N0UmVzdHJpY3Rpb25zIiwiY29udHJhY3RzIiwiYWNjZXNzUmlnaHRzIiwicmVzdHJpY3RUb0FjY291bnRzIiwiYWNjb3VudHMiLCJTZXQiLCJwYXJzZU1lc3NhZ2UiLCJib2NCYXNlNjQiLCJkc3QiLCJBdXRoIiwidW5hdXRob3JpemVkRXJyb3IiLCJwb3N0UmVxdWVzdHMiLCJfIiwic2V0VGFnIiwiY2xpZW50IiwiZXhwaXJlZCIsImZpbmQiLCJ4IiwiZXhwaXJlQXQiLCJEYXRlIiwibm93IiwiUUVycm9yIiwibWVzc2FnZUV4cGlyZWQiLCJzdGF0UG9zdENvdW50IiwiaW5jcmVtZW50IiwibG9nIiwiZGVidWciLCJyZW1vdGVBZGRyZXNzIiwiZXJyb3IiLCJzdGF0UG9zdEZhaWxlZCIsInBhcmVudFNwYW4iLCJyZWdpc3RlckFjY2Vzc0tleXMiLCJhY2NvdW50Iiwic2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleSIsInJldm9rZUFjY2Vzc0tleXMiLCJmaW5pc2hPcGVyYXRpb25zIiwib3BlcmF0aW9uSWRzIiwic2l6ZSIsImF0dGFjaEN1c3RvbVJlc29sdmVycyIsIlF1ZXJ5IiwiYWdncmVnYXRlQmxvY2tTaWduYXR1cmVzIiwiYmxvY2tzX3NpZ25hdHVyZXMiLCJhZ2dyZWdhdGlvblJlc29sdmVyIiwiYWdncmVnYXRlQmxvY2tzIiwiYmxvY2tzIiwiYWdncmVnYXRlVHJhbnNhY3Rpb25zIiwidHJhbnNhY3Rpb25zIiwiYWdncmVnYXRlTWVzc2FnZXMiLCJhZ2dyZWdhdGVBY2NvdW50cyIsIk11dGF0aW9uIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBSUE7O0FBQ0E7O0FBQ0E7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IFwiZnNcIjtcbmltcG9ydCB7IEthZmthLCBQcm9kdWNlciB9IGZyb20gXCJrYWZrYWpzXCI7XG5pbXBvcnQgeyBTcGFuLCBGT1JNQVRfVEVYVF9NQVAgfSBmcm9tICdvcGVudHJhY2luZyc7XG5pbXBvcnQgdHlwZSB7IFRPTkNvbnRyYWN0cyB9IGZyb20gXCJ0b24tY2xpZW50LWpzL3R5cGVzXCI7XG5pbXBvcnQgQXJhbmdvIGZyb20gXCIuL2FyYW5nb1wiO1xuaW1wb3J0IHsgcmVxdWlyZUdyYW50ZWRBY2Nlc3MgfSBmcm9tIFwiLi9hcmFuZ28tY29sbGVjdGlvblwiO1xuaW1wb3J0IHR5cGUge1xuICAgIEdyYXBoUUxSZXF1ZXN0Q29udGV4dFxufSBmcm9tIFwiLi9hcmFuZ28tY29sbGVjdGlvblwiO1xuaW1wb3J0IHsgQXV0aCB9IGZyb20gXCIuL2F1dGhcIjtcbmltcG9ydCB7IGVuc3VyZVByb3RvY29sIH0gZnJvbSBcIi4vY29uZmlnXCI7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBmZXRjaCBmcm9tICdub2RlLWZldGNoJztcbmltcG9ydCB0eXBlIHsgQWNjZXNzS2V5LCBBY2Nlc3NSaWdodHMgfSBmcm9tIFwiLi9hdXRoXCI7XG5pbXBvcnQgeyBRVHJhY2VyIH0gZnJvbSBcIi4vdHJhY2VyXCI7XG5pbXBvcnQgeyBRRXJyb3IgfSBmcm9tIFwiLi91dGlsc1wiO1xuXG5mdW5jdGlvbiBpc09iamVjdCh0ZXN0OiBhbnkpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdHlwZW9mIHRlc3QgPT09ICdvYmplY3QnICYmIHRlc3QgIT09IG51bGw7XG59XG5cbmZ1bmN0aW9uIG92ZXJyaWRlT2JqZWN0KG9yaWdpbmFsOiBhbnksIG92ZXJyaWRlczogYW55KSB7XG4gICAgT2JqZWN0LmVudHJpZXMob3ZlcnJpZGVzKS5mb3JFYWNoKChbbmFtZSwgb3ZlcnJpZGVWYWx1ZV0pID0+IHtcbiAgICAgICAgaWYgKChuYW1lIGluIG9yaWdpbmFsKSAmJiBpc09iamVjdChvdmVycmlkZVZhbHVlKSAmJiBpc09iamVjdChvcmlnaW5hbFtuYW1lXSkpIHtcbiAgICAgICAgICAgIG92ZXJyaWRlT2JqZWN0KG9yaWdpbmFsW25hbWVdLCBvdmVycmlkZVZhbHVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG9yaWdpbmFsW25hbWVdID0gb3ZlcnJpZGVWYWx1ZTtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuXG50eXBlIEluZm8gPSB7XG4gICAgdmVyc2lvbjogc3RyaW5nLFxufVxuXG50eXBlIFJlcXVlc3QgPSB7XG4gICAgaWQ6IHN0cmluZyxcbiAgICBib2R5OiBzdHJpbmcsXG4gICAgZXhwaXJlQXQ6IG51bWJlcixcbn1cblxuZXhwb3J0IHR5cGUgR3JhcGhRTFJlcXVlc3RDb250ZXh0RXggPSBHcmFwaFFMUmVxdWVzdENvbnRleHQgJiB7XG4gICAgZGI6IEFyYW5nbyxcbn1cblxuLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIFF1ZXJ5XG5cbmZ1bmN0aW9uIGluZm8oKTogSW5mbyB7XG4gICAgY29uc3QgcGtnID0gSlNPTi5wYXJzZSgoZnMucmVhZEZpbGVTeW5jKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdwYWNrYWdlLmpzb24nKSk6IGFueSkpO1xuICAgIHJldHVybiB7XG4gICAgICAgIHZlcnNpb246IHBrZy52ZXJzaW9uLFxuICAgIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFjY291bnRzQ291bnQoX3BhcmVudCwgYXJncywgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IHRyYWNlciA9IGNvbnRleHQuZGIudHJhY2VyO1xuICAgIHJldHVybiBRVHJhY2VyLnRyYWNlKHRyYWNlciwgJ2dldEFjY291bnRzQ291bnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IHJlcXVpcmVHcmFudGVkQWNjZXNzKGNvbnRleHQsIGFyZ3MpO1xuICAgICAgICBjb25zdCByZXN1bHQ6IGFueSA9IGF3YWl0IGNvbnRleHQuZGIucXVlcnkoYFJFVFVSTiBMRU5HVEgoYWNjb3VudHMpYCwge30pO1xuICAgICAgICBjb25zdCBjb3VudHMgPSAocmVzdWx0OiBudW1iZXJbXSk7XG4gICAgICAgIHJldHVybiBjb3VudHMubGVuZ3RoID4gMCA/IGNvdW50c1swXSA6IDA7XG4gICAgfSwgUVRyYWNlci5nZXRQYXJlbnRTcGFuKHRyYWNlciwgY29udGV4dCkpXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFRyYW5zYWN0aW9uc0NvdW50KF9wYXJlbnQsIGFyZ3MsIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4KTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBjb25zdCB0cmFjZXIgPSBjb250ZXh0LmRiLnRyYWNlcjtcbiAgICByZXR1cm4gUVRyYWNlci50cmFjZSh0cmFjZXIsICdnZXRUcmFuc2FjdGlvbnNDb3VudCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgcmVxdWlyZUdyYW50ZWRBY2Nlc3MoY29udGV4dCwgYXJncyk7XG4gICAgICAgIGNvbnN0IHJlc3VsdDogYW55ID0gYXdhaXQgY29udGV4dC5kYi5xdWVyeShgUkVUVVJOIExFTkdUSCh0cmFuc2FjdGlvbnMpYCwge30pO1xuICAgICAgICBjb25zdCBjb3VudHMgPSAocmVzdWx0OiBudW1iZXJbXSk7XG4gICAgICAgIHJldHVybiBjb3VudHMubGVuZ3RoID4gMCA/IGNvdW50c1swXSA6IDA7XG4gICAgfSwgUVRyYWNlci5nZXRQYXJlbnRTcGFuKHRyYWNlciwgY29udGV4dCkpXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFjY291bnRzVG90YWxCYWxhbmNlKF9wYXJlbnQsIGFyZ3MsIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4KTogUHJvbWlzZTxTdHJpbmc+IHtcbiAgICBjb25zdCB0cmFjZXIgPSBjb250ZXh0LmRiLnRyYWNlcjtcbiAgICByZXR1cm4gUVRyYWNlci50cmFjZSh0cmFjZXIsICdnZXRBY2NvdW50c1RvdGFsQmFsYW5jZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgcmVxdWlyZUdyYW50ZWRBY2Nlc3MoY29udGV4dCwgYXJncyk7XG4gICAgICAgIC8qXG4gICAgICAgIEJlY2F1c2UgYXJhbmdvIGNhbiBub3Qgc3VtIEJpZ0ludCdzIHdlIG5lZWQgdG8gc3VtIHNlcGFyYXRlbHk6XG4gICAgICAgIGhzID0gU1VNIG9mIGhpZ2ggYml0cyAoZnJvbSAyNC1iaXQgYW5kIGhpZ2hlcilcbiAgICAgICAgbHMgPSBTVU0gb2YgbG93ZXIgMjQgYml0c1xuICAgICAgICBBbmQgdGhlIHRvdGFsIHJlc3VsdCBpcyAoaHMgPDwgMjQpICsgbHNcbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IHJlc3VsdDogYW55ID0gYXdhaXQgY29udGV4dC5kYi5xdWVyeShgXG4gICAgICAgICAgICBMRVQgZCA9IDE2Nzc3MjE2XG4gICAgICAgICAgICBGT1IgYSBpbiBhY2NvdW50c1xuICAgICAgICAgICAgTEVUIGIgPSBUT19OVU1CRVIoQ09OQ0FUKFwiMHhcIiwgU1VCU1RSSU5HKGEuYmFsYW5jZSwgMikpKVxuICAgICAgICAgICAgQ09MTEVDVCBBR0dSRUdBVEVcbiAgICAgICAgICAgICAgICBocyA9IFNVTShGTE9PUihiIC8gZCkpLFxuICAgICAgICAgICAgICAgIGxzID0gU1VNKGIgJSAoZCAtIDEpKVxuICAgICAgICAgICAgUkVUVVJOIHsgaHMsIGxzIH1cbiAgICAgICAgYCwge30pO1xuICAgICAgICBjb25zdCBwYXJ0cyA9IChyZXN1bHQ6IHsgaHM6IG51bWJlciwgbHM6IG51bWJlciB9W10pWzBdO1xuICAgICAgICAvLyRGbG93Rml4TWVcbiAgICAgICAgcmV0dXJuIChCaWdJbnQocGFydHMuaHMpICogQmlnSW50KDB4MTAwMDAwMCkgKyBCaWdJbnQocGFydHMubHMpKS50b1N0cmluZygpO1xuICAgIH0sIFFUcmFjZXIuZ2V0UGFyZW50U3Bhbih0cmFjZXIsIGNvbnRleHQpKVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRNYW5hZ2VtZW50QWNjZXNzS2V5KF9wYXJlbnQsIGFyZ3MsIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4KTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gY29udGV4dC5hdXRoLmdldE1hbmFnZW1lbnRBY2Nlc3NLZXkoKTtcbn1cblxuXG4vLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gTXV0YXRpb25cblxuXG5hc3luYyBmdW5jdGlvbiBwb3N0UmVxdWVzdHNVc2luZ1Jlc3QocmVxdWVzdHM6IFJlcXVlc3RbXSwgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsIF9zcGFuOiBTcGFuKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY29uZmlnID0gY29udGV4dC5jb25maWcucmVxdWVzdHM7XG4gICAgY29uc3QgdXJsID0gYCR7ZW5zdXJlUHJvdG9jb2woY29uZmlnLnNlcnZlciwgJ2h0dHAnKX0vdG9waWNzLyR7Y29uZmlnLnRvcGljfWA7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHtcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIG1vZGU6ICdjb3JzJyxcbiAgICAgICAgY2FjaGU6ICduby1jYWNoZScsXG4gICAgICAgIGNyZWRlbnRpYWxzOiAnc2FtZS1vcmlnaW4nLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICB9LFxuICAgICAgICByZWRpcmVjdDogJ2ZvbGxvdycsXG4gICAgICAgIHJlZmVycmVyOiAnbm8tcmVmZXJyZXInLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICByZWNvcmRzOiByZXF1ZXN0cy5tYXAoKHJlcXVlc3QpID0+ICh7XG4gICAgICAgICAgICAgICAga2V5OiByZXF1ZXN0LmlkLFxuICAgICAgICAgICAgICAgIHZhbHVlOiByZXF1ZXN0LmJvZHksXG4gICAgICAgICAgICB9KSksXG4gICAgICAgIH0pLFxuICAgIH0pO1xuICAgIGlmIChyZXNwb25zZS5zdGF0dXMgIT09IDIwMCkge1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gYFBvc3QgcmVxdWVzdHMgZmFpbGVkOiAke2F3YWl0IHJlc3BvbnNlLnRleHQoKX1gO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IobWVzc2FnZSk7XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBwb3N0UmVxdWVzdHNVc2luZ0thZmthKHJlcXVlc3RzOiBSZXF1ZXN0W10sIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4LCBzcGFuOiBTcGFuKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZW5zdXJlU2hhcmVkID0gYXN5bmMgKG5hbWUsIGNyZWF0ZVZhbHVlOiAoKSA9PiBQcm9taXNlPGFueT4pID0+IHtcbiAgICAgICAgaWYgKGNvbnRleHQuc2hhcmVkLmhhcyhuYW1lKSkge1xuICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuc2hhcmVkLmdldChuYW1lKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IGNyZWF0ZVZhbHVlKCk7XG4gICAgICAgIGNvbnRleHQuc2hhcmVkLnNldChuYW1lLCB2YWx1ZSk7XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9O1xuXG4gICAgY29uc3QgY29uZmlnID0gY29udGV4dC5jb25maWcucmVxdWVzdHM7XG4gICAgY29uc3QgcHJvZHVjZXI6IFByb2R1Y2VyID0gYXdhaXQgZW5zdXJlU2hhcmVkKCdwcm9kdWNlcicsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3Qga2Fma2E6IEthZmthID0gYXdhaXQgZW5zdXJlU2hhcmVkKCdrYWZrYScsIGFzeW5jICgpID0+IG5ldyBLYWZrYSh7XG4gICAgICAgICAgICBjbGllbnRJZDogJ3Etc2VydmVyJyxcbiAgICAgICAgICAgIGJyb2tlcnM6IFtjb25maWcuc2VydmVyXVxuICAgICAgICB9KSk7XG4gICAgICAgIGNvbnN0IG5ld1Byb2R1Y2VyID0ga2Fma2EucHJvZHVjZXIoKTtcbiAgICAgICAgYXdhaXQgbmV3UHJvZHVjZXIuY29ubmVjdCgpO1xuICAgICAgICByZXR1cm4gbmV3UHJvZHVjZXI7XG5cbiAgICB9KTtcblxuICAgIGNvbnN0IG1lc3NhZ2VzID0gcmVxdWVzdHMubWFwKChyZXF1ZXN0KSA9PiB7XG4gICAgICAgIGNvbnN0IHRyYWNlSW5mbyA9IHt9O1xuICAgICAgICBjb250ZXh0LmRiLnRyYWNlci5pbmplY3Qoc3BhbiwgRk9STUFUX1RFWFRfTUFQLCB0cmFjZUluZm8pO1xuICAgICAgICBjb25zdCBrZXlCdWZmZXIgPSBCdWZmZXIuZnJvbShyZXF1ZXN0LmlkLCAnYmFzZTY0Jyk7XG4gICAgICAgIGNvbnN0IHRyYWNlQnVmZmVyID0gKE9iamVjdC5rZXlzKHRyYWNlSW5mbykubGVuZ3RoID4gMClcbiAgICAgICAgICAgID8gQnVmZmVyLmZyb20oSlNPTi5zdHJpbmdpZnkodHJhY2VJbmZvKSwgJ3V0ZjgnKVxuICAgICAgICAgICAgOiBCdWZmZXIuZnJvbShbXSk7XG4gICAgICAgIGNvbnN0IGtleSA9IEJ1ZmZlci5jb25jYXQoW2tleUJ1ZmZlciwgdHJhY2VCdWZmZXJdKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGtleSxcbiAgICAgICAgICAgIHZhbHVlOiBCdWZmZXIuZnJvbShyZXF1ZXN0LmJvZHksICdiYXNlNjQnKSxcbiAgICAgICAgfTtcbiAgICB9KTtcbiAgICBhd2FpdCBwcm9kdWNlci5zZW5kKHtcbiAgICAgICAgdG9waWM6IGNvbmZpZy50b3BpYyxcbiAgICAgICAgbWVzc2FnZXMsXG4gICAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNoZWNrUG9zdFJlc3RyaWN0aW9ucyhcbiAgICBjb250cmFjdHM6IFRPTkNvbnRyYWN0cyxcbiAgICByZXF1ZXN0czogUmVxdWVzdFtdLFxuICAgIGFjY2Vzc1JpZ2h0czogQWNjZXNzUmlnaHRzLFxuKSB7XG4gICAgaWYgKGFjY2Vzc1JpZ2h0cy5yZXN0cmljdFRvQWNjb3VudHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgYWNjb3VudHMgPSBuZXcgU2V0KGFjY2Vzc1JpZ2h0cy5yZXN0cmljdFRvQWNjb3VudHMpO1xuICAgIGZvciAoY29uc3QgcmVxdWVzdDogUmVxdWVzdCBvZiByZXF1ZXN0cykge1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gYXdhaXQgY29udHJhY3RzLnBhcnNlTWVzc2FnZSh7XG4gICAgICAgICAgICBib2NCYXNlNjQ6IHJlcXVlc3QuYm9keSxcbiAgICAgICAgfSk7XG4gICAgICAgIGlmICghYWNjb3VudHMuaGFzKG1lc3NhZ2UuZHN0KSkge1xuICAgICAgICAgICAgdGhyb3cgQXV0aC51bmF1dGhvcml6ZWRFcnJvcigpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBwb3N0UmVxdWVzdHMoXG4gICAgXyxcbiAgICBhcmdzOiB7IHJlcXVlc3RzOiBSZXF1ZXN0W10sIGFjY2Vzc0tleT86IHN0cmluZyB9LFxuICAgIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4LFxuKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IHJlcXVlc3RzOiA/KFJlcXVlc3RbXSkgPSBhcmdzLnJlcXVlc3RzO1xuICAgIGlmICghcmVxdWVzdHMpIHtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIGNvbnN0IHRyYWNlciA9IGNvbnRleHQuZGIudHJhY2VyO1xuICAgIHJldHVybiBRVHJhY2VyLnRyYWNlKHRyYWNlciwgXCJwb3N0UmVxdWVzdHNcIiwgYXN5bmMgKHNwYW46IFNwYW4pID0+IHtcbiAgICAgICAgc3Bhbi5zZXRUYWcoJ3BhcmFtcycsIHJlcXVlc3RzKTtcbiAgICAgICAgY29uc3QgYWNjZXNzUmlnaHRzID0gYXdhaXQgcmVxdWlyZUdyYW50ZWRBY2Nlc3MoY29udGV4dCwgYXJncyk7XG4gICAgICAgIGF3YWl0IGNoZWNrUG9zdFJlc3RyaWN0aW9ucyhjb250ZXh0LmNsaWVudC5jb250cmFjdHMsIHJlcXVlc3RzLCBhY2Nlc3NSaWdodHMpO1xuXG4gICAgICAgIGNvbnN0IGV4cGlyZWQ6ID9SZXF1ZXN0ID0gcmVxdWVzdHMuZmluZCh4ID0+IHguZXhwaXJlQXQgJiYgKERhdGUubm93KCkgPiB4LmV4cGlyZUF0KSk7XG4gICAgICAgIGlmIChleHBpcmVkKSB7XG4gICAgICAgICAgICB0aHJvdyBRRXJyb3IubWVzc2FnZUV4cGlyZWQoZXhwaXJlZC5pZCwgZXhwaXJlZC5leHBpcmVBdCk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKGNvbnRleHQuY29uZmlnLnJlcXVlc3RzLm1vZGUgPT09ICdyZXN0Jykge1xuICAgICAgICAgICAgICAgIGF3YWl0IHBvc3RSZXF1ZXN0c1VzaW5nUmVzdChyZXF1ZXN0cywgY29udGV4dCwgc3Bhbik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGF3YWl0IHBvc3RSZXF1ZXN0c1VzaW5nS2Fma2EocmVxdWVzdHMsIGNvbnRleHQsIHNwYW4pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29udGV4dC5kYi5zdGF0UG9zdENvdW50LmluY3JlbWVudCgpO1xuICAgICAgICAgICAgY29udGV4dC5kYi5sb2cuZGVidWcoJ3Bvc3RSZXF1ZXN0cycsICdQT1NURUQnLCBhcmdzLCBjb250ZXh0LnJlbW90ZUFkZHJlc3MpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29udGV4dC5kYi5zdGF0UG9zdEZhaWxlZC5pbmNyZW1lbnQoKTtcbiAgICAgICAgICAgIGNvbnRleHQuZGIubG9nLmRlYnVnKCdwb3N0UmVxdWVzdHMnLCAnRkFJTEVEJywgYXJncywgY29udGV4dC5yZW1vdGVBZGRyZXNzKTtcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXF1ZXN0cy5tYXAoeCA9PiB4LmlkKTtcbiAgICB9LCBjb250ZXh0LnBhcmVudFNwYW4pO1xufVxuXG4vLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gQWNjZXNzIE1hbmFnZW1lbnRcblxudHlwZSBNYW5hZ2VtZW50QXJncyA9IHtcbiAgICBhY2NvdW50Pzogc3RyaW5nLFxuICAgIHNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXk/OiBzdHJpbmcsXG59XG5cbnR5cGUgUmVnaXN0ZXJBY2Nlc3NLZXlzQXJncyA9IE1hbmFnZW1lbnRBcmdzICYge1xuICAgIGtleXM6IEFjY2Vzc0tleVtdLFxufVxuXG50eXBlIFJldm9rZUFjY2Vzc0tleXNBcmdzID0gTWFuYWdlbWVudEFyZ3MgJiB7XG4gICAga2V5czogc3RyaW5nW10sXG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlZ2lzdGVyQWNjZXNzS2V5cyhcbiAgICBfLFxuICAgIGFyZ3M6IFJlZ2lzdGVyQWNjZXNzS2V5c0FyZ3MsXG4gICAgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsXG4pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIHJldHVybiBjb250ZXh0LmF1dGgucmVnaXN0ZXJBY2Nlc3NLZXlzKFxuICAgICAgICBhcmdzLmFjY291bnQgfHwgJycsXG4gICAgICAgIGFyZ3Mua2V5cyB8fCBbXSxcbiAgICAgICAgYXJncy5zaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5IHx8ICcnKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmV2b2tlQWNjZXNzS2V5cyhcbiAgICBfLFxuICAgIGFyZ3M6IFJldm9rZUFjY2Vzc0tleXNBcmdzLFxuICAgIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4LFxuKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICByZXR1cm4gY29udGV4dC5hdXRoLnJldm9rZUFjY2Vzc0tleXMoXG4gICAgICAgIGFyZ3MuYWNjb3VudCB8fCAnJyxcbiAgICAgICAgYXJncy5rZXlzIHx8IFtdLFxuICAgICAgICBhcmdzLnNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXkgfHwgJycpO1xufVxuXG50eXBlIEZpbmlzaE9wZXJhdGlvbnNBcmdzID0ge1xuICAgIG9wZXJhdGlvbklkcz86IHN0cmluZ1tdLFxufVxuXG5hc3luYyBmdW5jdGlvbiBmaW5pc2hPcGVyYXRpb25zKFxuICAgIF8sXG4gICAgYXJnczogRmluaXNoT3BlcmF0aW9uc0FyZ3MsXG4gICAgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsXG4pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IG9wZXJhdGlvbklkcyA9IG5ldyBTZXQoYXJncy5vcGVyYXRpb25JZHMgfHwgW10pO1xuICAgIGlmIChvcGVyYXRpb25JZHMuc2l6ZSA9PT0gMCkge1xuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnRleHQuZGIuZmluaXNoT3BlcmF0aW9ucyhvcGVyYXRpb25JZHMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYXR0YWNoQ3VzdG9tUmVzb2x2ZXJzKGRiOiBBcmFuZ28sIG9yaWdpbmFsOiBhbnkpOiBhbnkge1xuICAgIG92ZXJyaWRlT2JqZWN0KG9yaWdpbmFsLCB7XG4gICAgICAgIFF1ZXJ5OiB7XG4gICAgICAgICAgICBpbmZvLFxuICAgICAgICAgICAgZ2V0QWNjb3VudHNDb3VudCxcbiAgICAgICAgICAgIGdldFRyYW5zYWN0aW9uc0NvdW50LFxuICAgICAgICAgICAgZ2V0QWNjb3VudHNUb3RhbEJhbGFuY2UsXG4gICAgICAgICAgICBnZXRNYW5hZ2VtZW50QWNjZXNzS2V5LFxuICAgICAgICAgICAgYWdncmVnYXRlQmxvY2tTaWduYXR1cmVzOiBkYi5ibG9ja3Nfc2lnbmF0dXJlcy5hZ2dyZWdhdGlvblJlc29sdmVyKCksXG4gICAgICAgICAgICBhZ2dyZWdhdGVCbG9ja3M6IGRiLmJsb2Nrcy5hZ2dyZWdhdGlvblJlc29sdmVyKCksXG4gICAgICAgICAgICBhZ2dyZWdhdGVUcmFuc2FjdGlvbnM6IGRiLnRyYW5zYWN0aW9ucy5hZ2dyZWdhdGlvblJlc29sdmVyKCksXG4gICAgICAgICAgICBhZ2dyZWdhdGVNZXNzYWdlczogZGIubWVzc2FnZXMuYWdncmVnYXRpb25SZXNvbHZlcigpLFxuICAgICAgICAgICAgYWdncmVnYXRlQWNjb3VudHM6IGRiLmFjY291bnRzLmFnZ3JlZ2F0aW9uUmVzb2x2ZXIoKSxcbiAgICAgICAgfSxcbiAgICAgICAgTXV0YXRpb246IHtcbiAgICAgICAgICAgIHBvc3RSZXF1ZXN0cyxcbiAgICAgICAgICAgIHJlZ2lzdGVyQWNjZXNzS2V5cyxcbiAgICAgICAgICAgIHJldm9rZUFjY2Vzc0tleXMsXG4gICAgICAgICAgICBmaW5pc2hPcGVyYXRpb25zLFxuICAgICAgICB9LFxuICAgIH0pO1xuICAgIHJldHVybiBvcmlnaW5hbDtcbn1cbiJdfQ==