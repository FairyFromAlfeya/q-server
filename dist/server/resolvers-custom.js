"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.attachCustomResolvers = attachCustomResolvers;

var _fs = _interopRequireDefault(require("fs"));

var _kafkajs = require("kafkajs");

var _opentracing = require("opentracing");

var _arango = _interopRequireDefault(require("./arango"));

var _auth = require("./auth");

var _config = require("./config");

var _path = _interopRequireDefault(require("path"));

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _tracer = require("./tracer");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function isObject(test) {
  return typeof test === 'object' && test !== null;
}

function overrideObject(original, overrides) {
  Object.entries(overrides).forEach(([name, overrideValue]) => {
    if (name in original && isObject(overrideValue) && isObject(original[name])) {
      overrideObject(original[name], overrideValue);
    } else {
      original[name] = overrideValue;
    }
  });
}

// Query
function info() {
  const pkg = JSON.parse(_fs.default.readFileSync(_path.default.resolve(__dirname, '..', '..', 'package.json')));
  return {
    version: pkg.version
  };
}

async function getAccountsCount(_parent, args, context) {
  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, 'getAccountsCount', async () => {
    await context.auth.requireGrantedAccess(context.accessKey || args.accessKey);
    const result = await context.db.query(`RETURN LENGTH(accounts)`, {});
    const counts = result;
    return counts.length > 0 ? counts[0] : 0;
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getTransactionsCount(_parent, args, context) {
  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, 'getTransactionsCount', async () => {
    await context.auth.requireGrantedAccess(context.accessKey || args.accessKey);
    const result = await context.db.query(`RETURN LENGTH(transactions)`, {});
    const counts = result;
    return counts.length > 0 ? counts[0] : 0;
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getAccountsTotalBalance(_parent, args, context) {
  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, 'getAccountsTotalBalance', async () => {
    await context.auth.requireGrantedAccess(context.accessKey || args.accessKey);
    /*
    Because arango can not sum BigInt's we need to sum separately:
    hs = SUM of high bits (from 24-bit and higher)
    ls = SUM of lower 24 bits
    And the total result is (hs << 24) + ls
     */

    const result = await context.db.query(`
            LET d = 16777216
            FOR a in accounts
            LET b = TO_NUMBER(CONCAT("0x", SUBSTRING(a.balance, 2)))
            COLLECT AGGREGATE
                hs = SUM(FLOOR(b / d)),
                ls = SUM(b % (d - 1))
            RETURN { hs, ls }
        `, {});
    const parts = result[0]; //$FlowFixMe

    return (BigInt(parts.hs) * BigInt(0x1000000) + BigInt(parts.ls)).toString();
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getManagementAccessKey(_parent, args, context) {
  return context.auth.getManagementAccessKey();
} // Mutation


async function postRequestsUsingRest(requests, context) {
  const config = context.config.requests;
  const url = `${(0, _config.ensureProtocol)(config.server, 'http')}/topics/${config.topic}`;
  const response = await (0, _nodeFetch.default)(url, {
    method: 'POST',
    mode: 'cors',
    cache: 'no-cache',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json'
    },
    redirect: 'follow',
    referrer: 'no-referrer',
    body: JSON.stringify({
      records: requests.map(request => ({
        key: request.id,
        value: request.body
      }))
    })
  });

  if (response.status !== 200) {
    const message = `Post requests failed: ${await response.text()}`;
    throw new Error(message);
  }
}

async function postRequestsUsingKafka(requests, context, span) {
  const ensureShared = async (name, createValue) => {
    if (context.shared.has(name)) {
      return context.shared.get(name);
    }

    const value = await createValue();
    context.shared.set(name, value);
    return value;
  };

  const config = context.config.requests;
  const producer = await ensureShared('producer', async () => {
    const kafka = await ensureShared('kafka', async () => new _kafkajs.Kafka({
      clientId: 'q-server',
      brokers: [config.server]
    }));
    const newProducer = kafka.producer();
    await newProducer.connect();
    return newProducer;
  });
  const messages = requests.map(request => {
    const keyBuffer = Buffer.from(request.id, 'base64');
    const traceBuffer = Buffer.from([]);
    context.db.tracer.inject(span, _opentracing.FORMAT_BINARY, traceBuffer);
    return {
      key: Buffer.concat([keyBuffer, traceBuffer]),
      value: Buffer.from(request.body, 'base64')
    };
  });
  await producer.send({
    topic: config.topic,
    messages
  });
}

async function checkPostRestrictions(contracts, requests, accessRights) {
  if (accessRights.restrictToAccounts.length === 0) {
    return;
  }

  const accounts = new Set(accessRights.restrictToAccounts);

  for (const request of requests) {
    const message = await contracts.parseMessage({
      bocBase64: request.body
    });

    if (!accounts.has(message.dst)) {
      throw _auth.Auth.unauthorizedError();
    }
  }
}

async function postRequests(_, args, context) {
  const requests = args.requests;

  if (!requests) {
    return [];
  }

  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, "postRequests", async span => {
    span.setTag('params', requests);
    const accessRights = await context.auth.requireGrantedAccess(context.accessKey || args.accessKey);
    await checkPostRestrictions(context.client.contracts, requests, accessRights);

    try {
      if (context.config.requests.mode === 'rest') {
        await postRequestsUsingRest(requests, context);
      } else {
        await postRequestsUsingKafka(requests, context, span);
      }

      context.db.log.debug('postRequests', 'POSTED', args, context.remoteAddress);
    } catch (error) {
      context.db.log.debug('postRequests', 'FAILED', args, context.remoteAddress);
      throw error;
    }

    return requests.map(x => x.id);
  }, context.parentSpan);
}

async function registerAccessKeys(_, args, context) {
  return context.auth.registerAccessKeys(args.account || '', args.keys || [], args.signedManagementAccessKey || '');
}

async function revokeAccessKeys(_, args, context) {
  return context.auth.revokeAccessKeys(args.account || '', args.keys || [], args.signedManagementAccessKey || '');
}

const resolversCustom = {
  Query: {
    info,
    getAccountsCount,
    getTransactionsCount,
    getAccountsTotalBalance,
    getManagementAccessKey
  },
  Mutation: {
    postRequests,
    registerAccessKeys,
    revokeAccessKeys
  }
};

function attachCustomResolvers(original) {
  overrideObject(original, resolversCustom);
  return original;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9yZXNvbHZlcnMtY3VzdG9tLmpzIl0sIm5hbWVzIjpbImlzT2JqZWN0IiwidGVzdCIsIm92ZXJyaWRlT2JqZWN0Iiwib3JpZ2luYWwiLCJvdmVycmlkZXMiLCJPYmplY3QiLCJlbnRyaWVzIiwiZm9yRWFjaCIsIm5hbWUiLCJvdmVycmlkZVZhbHVlIiwiaW5mbyIsInBrZyIsIkpTT04iLCJwYXJzZSIsImZzIiwicmVhZEZpbGVTeW5jIiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJ2ZXJzaW9uIiwiZ2V0QWNjb3VudHNDb3VudCIsIl9wYXJlbnQiLCJhcmdzIiwiY29udGV4dCIsInRyYWNlciIsImRiIiwiUVRyYWNlciIsInRyYWNlIiwiYXV0aCIsInJlcXVpcmVHcmFudGVkQWNjZXNzIiwiYWNjZXNzS2V5IiwicmVzdWx0IiwicXVlcnkiLCJjb3VudHMiLCJsZW5ndGgiLCJnZXRQYXJlbnRTcGFuIiwiZ2V0VHJhbnNhY3Rpb25zQ291bnQiLCJnZXRBY2NvdW50c1RvdGFsQmFsYW5jZSIsInBhcnRzIiwiQmlnSW50IiwiaHMiLCJscyIsInRvU3RyaW5nIiwiZ2V0TWFuYWdlbWVudEFjY2Vzc0tleSIsInBvc3RSZXF1ZXN0c1VzaW5nUmVzdCIsInJlcXVlc3RzIiwiY29uZmlnIiwidXJsIiwic2VydmVyIiwidG9waWMiLCJyZXNwb25zZSIsIm1ldGhvZCIsIm1vZGUiLCJjYWNoZSIsImNyZWRlbnRpYWxzIiwiaGVhZGVycyIsInJlZGlyZWN0IiwicmVmZXJyZXIiLCJib2R5Iiwic3RyaW5naWZ5IiwicmVjb3JkcyIsIm1hcCIsInJlcXVlc3QiLCJrZXkiLCJpZCIsInZhbHVlIiwic3RhdHVzIiwibWVzc2FnZSIsInRleHQiLCJFcnJvciIsInBvc3RSZXF1ZXN0c1VzaW5nS2Fma2EiLCJzcGFuIiwiZW5zdXJlU2hhcmVkIiwiY3JlYXRlVmFsdWUiLCJzaGFyZWQiLCJoYXMiLCJnZXQiLCJzZXQiLCJwcm9kdWNlciIsImthZmthIiwiS2Fma2EiLCJjbGllbnRJZCIsImJyb2tlcnMiLCJuZXdQcm9kdWNlciIsImNvbm5lY3QiLCJtZXNzYWdlcyIsImtleUJ1ZmZlciIsIkJ1ZmZlciIsImZyb20iLCJ0cmFjZUJ1ZmZlciIsImluamVjdCIsIkZPUk1BVF9CSU5BUlkiLCJjb25jYXQiLCJzZW5kIiwiY2hlY2tQb3N0UmVzdHJpY3Rpb25zIiwiY29udHJhY3RzIiwiYWNjZXNzUmlnaHRzIiwicmVzdHJpY3RUb0FjY291bnRzIiwiYWNjb3VudHMiLCJTZXQiLCJwYXJzZU1lc3NhZ2UiLCJib2NCYXNlNjQiLCJkc3QiLCJBdXRoIiwidW5hdXRob3JpemVkRXJyb3IiLCJwb3N0UmVxdWVzdHMiLCJfIiwic2V0VGFnIiwiY2xpZW50IiwibG9nIiwiZGVidWciLCJyZW1vdGVBZGRyZXNzIiwiZXJyb3IiLCJ4IiwicGFyZW50U3BhbiIsInJlZ2lzdGVyQWNjZXNzS2V5cyIsImFjY291bnQiLCJrZXlzIiwic2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleSIsInJldm9rZUFjY2Vzc0tleXMiLCJyZXNvbHZlcnNDdXN0b20iLCJRdWVyeSIsIk11dGF0aW9uIiwiYXR0YWNoQ3VzdG9tUmVzb2x2ZXJzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7QUFFQSxTQUFTQSxRQUFULENBQWtCQyxJQUFsQixFQUFzQztBQUNsQyxTQUFPLE9BQU9BLElBQVAsS0FBZ0IsUUFBaEIsSUFBNEJBLElBQUksS0FBSyxJQUE1QztBQUNIOztBQUVELFNBQVNDLGNBQVQsQ0FBd0JDLFFBQXhCLEVBQXVDQyxTQUF2QyxFQUF1RDtBQUNuREMsRUFBQUEsTUFBTSxDQUFDQyxPQUFQLENBQWVGLFNBQWYsRUFBMEJHLE9BQTFCLENBQWtDLENBQUMsQ0FBQ0MsSUFBRCxFQUFPQyxhQUFQLENBQUQsS0FBMkI7QUFDekQsUUFBS0QsSUFBSSxJQUFJTCxRQUFULElBQXNCSCxRQUFRLENBQUNT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SixFQUltQjtBQUNmLFNBQU9BLE9BQU8sQ0FBQ0ssSUFBUixDQUFhMkYsZ0JBQWIsQ0FDSGpHLElBQUksQ0FBQzhGLE9BQUwsSUFBZ0IsRUFEYixFQUVIOUYsSUFBSSxDQUFDK0YsSUFBTCxJQUFhLEVBRlYsRUFHSC9GLElBQUksQ0FBQ2dHLHlCQUFMLElBQWtDLEVBSC9CLENBQVA7QUFJSDs7QUFFRCxNQUFNRSxlQUFlLEdBQUc7QUFDcEJDLEVBQUFBLEtBQUssRUFBRTtBQUNIL0csSUFBQUEsSUFERztBQUVIVSxJQUFBQSxnQkFGRztBQUdIZ0IsSUFBQUEsb0JBSEc7QUFJSEMsSUFBQUEsdUJBSkc7QUFLSE0sSUFBQUE7QUFMRyxHQURhO0FBUXBCK0UsRUFBQUEsUUFBUSxFQUFFO0FBQ05qQixJQUFBQSxZQURNO0FBRU5VLElBQUFBLGtCQUZNO0FBR05JLElBQUFBO0FBSE07QUFSVSxDQUF4Qjs7QUFlTyxTQUFTSSxxQkFBVCxDQUErQnhILFFBQS9CLEVBQW1EO0FBQ3RERCxFQUFBQSxjQUFjLENBQUNDLFFBQUQsRUFBV3FILGVBQVgsQ0FBZDtBQUNBLFNBQU9ySCxRQUFQO0FBQ0giLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgeyBLYWZrYSwgUHJvZHVjZXIgfSBmcm9tIFwia2Fma2Fqc1wiO1xuaW1wb3J0IHsgU3BhbiwgRk9STUFUX0JJTkFSWSB9IGZyb20gJ29wZW50cmFjaW5nJztcbmltcG9ydCB0eXBlIHsgVE9OQ29udHJhY3RzIH0gZnJvbSBcInRvbi1jbGllbnQtanMvdHlwZXNcIjtcbmltcG9ydCBBcmFuZ28gZnJvbSBcIi4vYXJhbmdvXCI7XG5pbXBvcnQgdHlwZSB7IEdyYXBoUUxSZXF1ZXN0Q29udGV4dCB9IGZyb20gXCIuL2FyYW5nby1jb2xsZWN0aW9uXCI7XG5pbXBvcnQgeyBBdXRoIH0gZnJvbSBcIi4vYXV0aFwiO1xuaW1wb3J0IHsgZW5zdXJlUHJvdG9jb2wgfSBmcm9tIFwiLi9jb25maWdcIjtcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGZldGNoIGZyb20gJ25vZGUtZmV0Y2gnO1xuaW1wb3J0IHR5cGUgeyBBY2Nlc3NLZXksIEFjY2Vzc1JpZ2h0cyB9IGZyb20gXCIuL2F1dGhcIjtcbmltcG9ydCB7IFFUcmFjZXIgfSBmcm9tIFwiLi90cmFjZXJcIjtcblxuZnVuY3Rpb24gaXNPYmplY3QodGVzdDogYW55KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHR5cGVvZiB0ZXN0ID09PSAnb2JqZWN0JyAmJiB0ZXN0ICE9PSBudWxsO1xufVxuXG5mdW5jdGlvbiBvdmVycmlkZU9iamVjdChvcmlnaW5hbDogYW55LCBvdmVycmlkZXM6IGFueSkge1xuICAgIE9iamVjdC5lbnRyaWVzKG92ZXJyaWRlcykuZm9yRWFjaCgoW25hbWUsIG92ZXJyaWRlVmFsdWVdKSA9PiB7XG4gICAgICAgIGlmICgobmFtZSBpbiBvcmlnaW5hbCkgJiYgaXNPYmplY3Qob3ZlcnJpZGVWYWx1ZSkgJiYgaXNPYmplY3Qob3JpZ2luYWxbbmFtZV0pKSB7XG4gICAgICAgICAgICBvdmVycmlkZU9iamVjdChvcmlnaW5hbFtuYW1lXSwgb3ZlcnJpZGVWYWx1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvcmlnaW5hbFtuYW1lXSA9IG92ZXJyaWRlVmFsdWU7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxudHlwZSBJbmZvID0ge1xuICAgIHZlcnNpb246IHN0cmluZyxcbn1cblxudHlwZSBSZXF1ZXN0ID0ge1xuICAgIGlkOiBzdHJpbmcsXG4gICAgYm9keTogc3RyaW5nLFxufVxuXG50eXBlIEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4ID0gR3JhcGhRTFJlcXVlc3RDb250ZXh0ICYge1xuICAgIGRiOiBBcmFuZ28sXG59XG5cbi8vIFF1ZXJ5XG5cbmZ1bmN0aW9uIGluZm8oKTogSW5mbyB7XG4gICAgY29uc3QgcGtnID0gSlNPTi5wYXJzZSgoZnMucmVhZEZpbGVTeW5jKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdwYWNrYWdlLmpzb24nKSk6IGFueSkpO1xuICAgIHJldHVybiB7XG4gICAgICAgIHZlcnNpb246IHBrZy52ZXJzaW9uLFxuICAgIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFjY291bnRzQ291bnQoX3BhcmVudCwgYXJncywgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IHRyYWNlciA9IGNvbnRleHQuZGIudHJhY2VyO1xuICAgIHJldHVybiBRVHJhY2VyLnRyYWNlKHRyYWNlciwgJ2dldEFjY291bnRzQ291bnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IGNvbnRleHQuYXV0aC5yZXF1aXJlR3JhbnRlZEFjY2Vzcyhjb250ZXh0LmFjY2Vzc0tleSB8fCBhcmdzLmFjY2Vzc0tleSk7XG4gICAgICAgIGNvbnN0IHJlc3VsdDogYW55ID0gYXdhaXQgY29udGV4dC5kYi5xdWVyeShgUkVUVVJOIExFTkdUSChhY2NvdW50cylgLCB7fSk7XG4gICAgICAgIGNvbnN0IGNvdW50cyA9IChyZXN1bHQ6IG51bWJlcltdKTtcbiAgICAgICAgcmV0dXJuIGNvdW50cy5sZW5ndGggPiAwID8gY291bnRzWzBdIDogMDtcbiAgICB9LCBRVHJhY2VyLmdldFBhcmVudFNwYW4odHJhY2VyLCBjb250ZXh0KSlcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0VHJhbnNhY3Rpb25zQ291bnQoX3BhcmVudCwgYXJncywgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IHRyYWNlciA9IGNvbnRleHQuZGIudHJhY2VyO1xuICAgIHJldHVybiBRVHJhY2VyLnRyYWNlKHRyYWNlciwgJ2dldFRyYW5zYWN0aW9uc0NvdW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCBjb250ZXh0LmF1dGgucmVxdWlyZUdyYW50ZWRBY2Nlc3MoY29udGV4dC5hY2Nlc3NLZXkgfHwgYXJncy5hY2Nlc3NLZXkpO1xuICAgICAgICBjb25zdCByZXN1bHQ6IGFueSA9IGF3YWl0IGNvbnRleHQuZGIucXVlcnkoYFJFVFVSTiBMRU5HVEgodHJhbnNhY3Rpb25zKWAsIHt9KTtcbiAgICAgICAgY29uc3QgY291bnRzID0gKHJlc3VsdDogbnVtYmVyW10pO1xuICAgICAgICByZXR1cm4gY291bnRzLmxlbmd0aCA+IDAgPyBjb3VudHNbMF0gOiAwO1xuICAgIH0sIFFUcmFjZXIuZ2V0UGFyZW50U3Bhbih0cmFjZXIsIGNvbnRleHQpKVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBY2NvdW50c1RvdGFsQmFsYW5jZShfcGFyZW50LCBhcmdzLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCk6IFByb21pc2U8U3RyaW5nPiB7XG4gICAgY29uc3QgdHJhY2VyID0gY29udGV4dC5kYi50cmFjZXI7XG4gICAgcmV0dXJuIFFUcmFjZXIudHJhY2UodHJhY2VyLCAnZ2V0QWNjb3VudHNUb3RhbEJhbGFuY2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IGNvbnRleHQuYXV0aC5yZXF1aXJlR3JhbnRlZEFjY2Vzcyhjb250ZXh0LmFjY2Vzc0tleSB8fCBhcmdzLmFjY2Vzc0tleSk7XG4gICAgICAgIC8qXG4gICAgICAgIEJlY2F1c2UgYXJhbmdvIGNhbiBub3Qgc3VtIEJpZ0ludCdzIHdlIG5lZWQgdG8gc3VtIHNlcGFyYXRlbHk6XG4gICAgICAgIGhzID0gU1VNIG9mIGhpZ2ggYml0cyAoZnJvbSAyNC1iaXQgYW5kIGhpZ2hlcilcbiAgICAgICAgbHMgPSBTVU0gb2YgbG93ZXIgMjQgYml0c1xuICAgICAgICBBbmQgdGhlIHRvdGFsIHJlc3VsdCBpcyAoaHMgPDwgMjQpICsgbHNcbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IHJlc3VsdDogYW55ID0gYXdhaXQgY29udGV4dC5kYi5xdWVyeShgXG4gICAgICAgICAgICBMRVQgZCA9IDE2Nzc3MjE2XG4gICAgICAgICAgICBGT1IgYSBpbiBhY2NvdW50c1xuICAgICAgICAgICAgTEVUIGIgPSBUT19OVU1CRVIoQ09OQ0FUKFwiMHhcIiwgU1VCU1RSSU5HKGEuYmFsYW5jZSwgMikpKVxuICAgICAgICAgICAgQ09MTEVDVCBBR0dSRUdBVEVcbiAgICAgICAgICAgICAgICBocyA9IFNVTShGTE9PUihiIC8gZCkpLFxuICAgICAgICAgICAgICAgIGxzID0gU1VNKGIgJSAoZCAtIDEpKVxuICAgICAgICAgICAgUkVUVVJOIHsgaHMsIGxzIH1cbiAgICAgICAgYCwge30pO1xuICAgICAgICBjb25zdCBwYXJ0cyA9IChyZXN1bHQ6IHsgaHM6IG51bWJlciwgbHM6IG51bWJlciB9W10pWzBdO1xuICAgICAgICAvLyRGbG93Rml4TWVcbiAgICAgICAgcmV0dXJuIChCaWdJbnQocGFydHMuaHMpICogQmlnSW50KDB4MTAwMDAwMCkgKyBCaWdJbnQocGFydHMubHMpKS50b1N0cmluZygpO1xuICAgIH0sIFFUcmFjZXIuZ2V0UGFyZW50U3Bhbih0cmFjZXIsIGNvbnRleHQpKVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRNYW5hZ2VtZW50QWNjZXNzS2V5KF9wYXJlbnQsIGFyZ3MsIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4KTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gY29udGV4dC5hdXRoLmdldE1hbmFnZW1lbnRBY2Nlc3NLZXkoKTtcbn1cblxuLy8gTXV0YXRpb25cblxuYXN5bmMgZnVuY3Rpb24gcG9zdFJlcXVlc3RzVXNpbmdSZXN0KHJlcXVlc3RzOiBSZXF1ZXN0W10sIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY29uZmlnID0gY29udGV4dC5jb25maWcucmVxdWVzdHM7XG4gICAgY29uc3QgdXJsID0gYCR7ZW5zdXJlUHJvdG9jb2woY29uZmlnLnNlcnZlciwgJ2h0dHAnKX0vdG9waWNzLyR7Y29uZmlnLnRvcGljfWA7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHtcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIG1vZGU6ICdjb3JzJyxcbiAgICAgICAgY2FjaGU6ICduby1jYWNoZScsXG4gICAgICAgIGNyZWRlbnRpYWxzOiAnc2FtZS1vcmlnaW4nLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICB9LFxuICAgICAgICByZWRpcmVjdDogJ2ZvbGxvdycsXG4gICAgICAgIHJlZmVycmVyOiAnbm8tcmVmZXJyZXInLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICByZWNvcmRzOiByZXF1ZXN0cy5tYXAoKHJlcXVlc3QpID0+ICh7XG4gICAgICAgICAgICAgICAga2V5OiByZXF1ZXN0LmlkLFxuICAgICAgICAgICAgICAgIHZhbHVlOiByZXF1ZXN0LmJvZHksXG4gICAgICAgICAgICB9KSksXG4gICAgICAgIH0pLFxuICAgIH0pO1xuICAgIGlmIChyZXNwb25zZS5zdGF0dXMgIT09IDIwMCkge1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gYFBvc3QgcmVxdWVzdHMgZmFpbGVkOiAke2F3YWl0IHJlc3BvbnNlLnRleHQoKX1gO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IobWVzc2FnZSk7XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBwb3N0UmVxdWVzdHNVc2luZ0thZmthKHJlcXVlc3RzOiBSZXF1ZXN0W10sIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4LCBzcGFuOiBTcGFuKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZW5zdXJlU2hhcmVkID0gYXN5bmMgKG5hbWUsIGNyZWF0ZVZhbHVlOiAoKSA9PiBQcm9taXNlPGFueT4pID0+IHtcbiAgICAgICAgaWYgKGNvbnRleHQuc2hhcmVkLmhhcyhuYW1lKSkge1xuICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuc2hhcmVkLmdldChuYW1lKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IGNyZWF0ZVZhbHVlKCk7XG4gICAgICAgIGNvbnRleHQuc2hhcmVkLnNldChuYW1lLCB2YWx1ZSk7XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9O1xuXG4gICAgY29uc3QgY29uZmlnID0gY29udGV4dC5jb25maWcucmVxdWVzdHM7XG4gICAgY29uc3QgcHJvZHVjZXI6IFByb2R1Y2VyID0gYXdhaXQgZW5zdXJlU2hhcmVkKCdwcm9kdWNlcicsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3Qga2Fma2E6IEthZmthID0gYXdhaXQgZW5zdXJlU2hhcmVkKCdrYWZrYScsIGFzeW5jICgpID0+IG5ldyBLYWZrYSh7XG4gICAgICAgICAgICBjbGllbnRJZDogJ3Etc2VydmVyJyxcbiAgICAgICAgICAgIGJyb2tlcnM6IFtjb25maWcuc2VydmVyXVxuICAgICAgICB9KSk7XG4gICAgICAgIGNvbnN0IG5ld1Byb2R1Y2VyID0ga2Fma2EucHJvZHVjZXIoKTtcbiAgICAgICAgYXdhaXQgbmV3UHJvZHVjZXIuY29ubmVjdCgpO1xuICAgICAgICByZXR1cm4gbmV3UHJvZHVjZXI7XG5cbiAgICB9KTtcbiAgICBjb25zdCBtZXNzYWdlcyA9IHJlcXVlc3RzLm1hcCgocmVxdWVzdCkgPT4ge1xuICAgICAgICBjb25zdCBrZXlCdWZmZXIgPSBCdWZmZXIuZnJvbShyZXF1ZXN0LmlkLCAnYmFzZTY0Jyk7XG4gICAgICAgIGNvbnN0IHRyYWNlQnVmZmVyID0gQnVmZmVyLmZyb20oW10pO1xuICAgICAgICBjb250ZXh0LmRiLnRyYWNlci5pbmplY3Qoc3BhbiwgRk9STUFUX0JJTkFSWSwgdHJhY2VCdWZmZXIpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAga2V5OiBCdWZmZXIuY29uY2F0KFtrZXlCdWZmZXIsIHRyYWNlQnVmZmVyXSksXG4gICAgICAgICAgICB2YWx1ZTogQnVmZmVyLmZyb20ocmVxdWVzdC5ib2R5LCAnYmFzZTY0JyksXG4gICAgICAgIH07XG4gICAgfSk7XG4gICAgYXdhaXQgcHJvZHVjZXIuc2VuZCh7XG4gICAgICAgIHRvcGljOiBjb25maWcudG9waWMsXG4gICAgICAgIG1lc3NhZ2VzLFxuICAgIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjaGVja1Bvc3RSZXN0cmljdGlvbnMoXG4gICAgY29udHJhY3RzOiBUT05Db250cmFjdHMsXG4gICAgcmVxdWVzdHM6IFJlcXVlc3RbXSxcbiAgICBhY2Nlc3NSaWdodHM6IEFjY2Vzc1JpZ2h0cyxcbikge1xuICAgIGlmIChhY2Nlc3NSaWdodHMucmVzdHJpY3RUb0FjY291bnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGFjY291bnRzID0gbmV3IFNldChhY2Nlc3NSaWdodHMucmVzdHJpY3RUb0FjY291bnRzKTtcbiAgICBmb3IgKGNvbnN0IHJlcXVlc3Q6IFJlcXVlc3Qgb2YgcmVxdWVzdHMpIHtcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IGF3YWl0IGNvbnRyYWN0cy5wYXJzZU1lc3NhZ2Uoe1xuICAgICAgICAgICAgYm9jQmFzZTY0OiByZXF1ZXN0LmJvZHksXG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoIWFjY291bnRzLmhhcyhtZXNzYWdlLmRzdCkpIHtcbiAgICAgICAgICAgIHRocm93IEF1dGgudW5hdXRob3JpemVkRXJyb3IoKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcG9zdFJlcXVlc3RzKFxuICAgIF8sXG4gICAgYXJnczogeyByZXF1ZXN0czogUmVxdWVzdFtdLCBhY2Nlc3NLZXk/OiBzdHJpbmcgfSxcbiAgICBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCxcbik6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCByZXF1ZXN0czogPyhSZXF1ZXN0W10pID0gYXJncy5yZXF1ZXN0cztcbiAgICBpZiAoIXJlcXVlc3RzKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBjb25zdCB0cmFjZXIgPSBjb250ZXh0LmRiLnRyYWNlcjtcbiAgICByZXR1cm4gUVRyYWNlci50cmFjZSh0cmFjZXIsIFwicG9zdFJlcXVlc3RzXCIsIGFzeW5jIChzcGFuOiBTcGFuKSA9PiB7XG4gICAgICAgIHNwYW4uc2V0VGFnKCdwYXJhbXMnLCByZXF1ZXN0cyk7XG4gICAgICAgIGNvbnN0IGFjY2Vzc1JpZ2h0cyA9IGF3YWl0IGNvbnRleHQuYXV0aC5yZXF1aXJlR3JhbnRlZEFjY2VzcyhcbiAgICAgICAgICAgIGNvbnRleHQuYWNjZXNzS2V5IHx8IGFyZ3MuYWNjZXNzS2V5LFxuICAgICAgICApO1xuICAgICAgICBhd2FpdCBjaGVja1Bvc3RSZXN0cmljdGlvbnMoY29udGV4dC5jbGllbnQuY29udHJhY3RzLCByZXF1ZXN0cywgYWNjZXNzUmlnaHRzKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmIChjb250ZXh0LmNvbmZpZy5yZXF1ZXN0cy5tb2RlID09PSAncmVzdCcpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBwb3N0UmVxdWVzdHNVc2luZ1Jlc3QocmVxdWVzdHMsIGNvbnRleHQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBwb3N0UmVxdWVzdHNVc2luZ0thZmthKHJlcXVlc3RzLCBjb250ZXh0LCBzcGFuKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnRleHQuZGIubG9nLmRlYnVnKCdwb3N0UmVxdWVzdHMnLCAnUE9TVEVEJywgYXJncywgY29udGV4dC5yZW1vdGVBZGRyZXNzKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnRleHQuZGIubG9nLmRlYnVnKCdwb3N0UmVxdWVzdHMnLCAnRkFJTEVEJywgYXJncywgY29udGV4dC5yZW1vdGVBZGRyZXNzKTtcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXF1ZXN0cy5tYXAoeCA9PiB4LmlkKTtcbiAgICB9LCBjb250ZXh0LnBhcmVudFNwYW4pO1xufVxuXG50eXBlIE1hbmFnZW1lbnRBcmdzID0ge1xuICAgIGFjY291bnQ/OiBzdHJpbmcsXG4gICAgc2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleT86IHN0cmluZyxcbn1cblxudHlwZSBSZWdpc3RlckFjY2Vzc0tleXNBcmdzID0gTWFuYWdlbWVudEFyZ3MgJiB7XG4gICAga2V5czogQWNjZXNzS2V5W10sXG59XG5cbnR5cGUgUmV2b2tlQWNjZXNzS2V5c0FyZ3MgPSBNYW5hZ2VtZW50QXJncyAmIHtcbiAgICBrZXlzOiBzdHJpbmdbXSxcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVnaXN0ZXJBY2Nlc3NLZXlzKFxuICAgIF8sXG4gICAgYXJnczogUmVnaXN0ZXJBY2Nlc3NLZXlzQXJncyxcbiAgICBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCxcbik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgcmV0dXJuIGNvbnRleHQuYXV0aC5yZWdpc3RlckFjY2Vzc0tleXMoXG4gICAgICAgIGFyZ3MuYWNjb3VudCB8fCAnJyxcbiAgICAgICAgYXJncy5rZXlzIHx8IFtdLFxuICAgICAgICBhcmdzLnNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXkgfHwgJycpO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZXZva2VBY2Nlc3NLZXlzKFxuICAgIF8sXG4gICAgYXJnczogUmV2b2tlQWNjZXNzS2V5c0FyZ3MsXG4gICAgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsXG4pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIHJldHVybiBjb250ZXh0LmF1dGgucmV2b2tlQWNjZXNzS2V5cyhcbiAgICAgICAgYXJncy5hY2NvdW50IHx8ICcnLFxuICAgICAgICBhcmdzLmtleXMgfHwgW10sXG4gICAgICAgIGFyZ3Muc2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleSB8fCAnJyk7XG59XG5cbmNvbnN0IHJlc29sdmVyc0N1c3RvbSA9IHtcbiAgICBRdWVyeToge1xuICAgICAgICBpbmZvLFxuICAgICAgICBnZXRBY2NvdW50c0NvdW50LFxuICAgICAgICBnZXRUcmFuc2FjdGlvbnNDb3VudCxcbiAgICAgICAgZ2V0QWNjb3VudHNUb3RhbEJhbGFuY2UsXG4gICAgICAgIGdldE1hbmFnZW1lbnRBY2Nlc3NLZXksXG4gICAgfSxcbiAgICBNdXRhdGlvbjoge1xuICAgICAgICBwb3N0UmVxdWVzdHMsXG4gICAgICAgIHJlZ2lzdGVyQWNjZXNzS2V5cyxcbiAgICAgICAgcmV2b2tlQWNjZXNzS2V5cyxcbiAgICB9LFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGF0dGFjaEN1c3RvbVJlc29sdmVycyhvcmlnaW5hbDogYW55KTogYW55IHtcbiAgICBvdmVycmlkZU9iamVjdChvcmlnaW5hbCwgcmVzb2x2ZXJzQ3VzdG9tKTtcbiAgICByZXR1cm4gb3JpZ2luYWw7XG59XG4iXX0=