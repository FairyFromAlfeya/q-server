"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.attachCustomResolvers = attachCustomResolvers;

var _kafkajs = require("kafkajs");

var _opentracing = require("opentracing");

var _arango = _interopRequireDefault(require("./arango"));

var _arangoCollection = require("./arango-collection");

var _auth = require("./auth");

var _config = require("./config");

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _tracer = require("./tracer");

var _package = require("../package.json");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function isObject(test) {
  return typeof test === 'object' && test !== null;
}

function overrideObject(original, overrides) {
  Object.entries(overrides).forEach(([name, overrideValue]) => {
    if (name in original && isObject(overrideValue) && isObject(original[name])) {
      overrideObject(original[name], overrideValue);
    } else {
      original[name] = overrideValue;
    }
  });
}

//------------------------------------------------------------- Query
function info() {
  return {
    version: _package.version
  };
}

async function getAccountsCount(_parent, args, context) {
  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, 'getAccountsCount', async () => {
    await (0, _arangoCollection.requireGrantedAccess)(context, args);
    const result = await context.db.query(`RETURN LENGTH(accounts)`, {});
    const counts = result;
    return counts.length > 0 ? counts[0] : 0;
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getTransactionsCount(_parent, args, context) {
  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, 'getTransactionsCount', async () => {
    await (0, _arangoCollection.requireGrantedAccess)(context, args);
    const result = await context.db.query(`RETURN LENGTH(transactions)`, {});
    const counts = result;
    return counts.length > 0 ? counts[0] : 0;
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getAccountsTotalBalance(_parent, args, context) {
  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, 'getAccountsTotalBalance', async () => {
    await (0, _arangoCollection.requireGrantedAccess)(context, args);
    /*
    Because arango can not sum BigInt's we need to sum separately:
    hs = SUM of high bits (from 24-bit and higher)
    ls = SUM of lower 24 bits
    And the total result is (hs << 24) + ls
     */

    const result = await context.db.query(`
            LET d = 16777216
            FOR a in accounts
            LET b = TO_NUMBER(CONCAT("0x", SUBSTRING(a.balance, 2)))
            COLLECT AGGREGATE
                hs = SUM(FLOOR(b / d)),
                ls = SUM(b % (d - 1))
            RETURN { hs, ls }
        `, {});
    const parts = result[0]; //$FlowFixMe

    return (BigInt(parts.hs) * BigInt(0x1000000) + BigInt(parts.ls)).toString();
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getManagementAccessKey(_parent, args, context) {
  return context.auth.getManagementAccessKey();
} //------------------------------------------------------------- Mutation


async function postRequestsUsingRest(requests, context, _span) {
  const config = context.config.requests;
  const url = `${(0, _config.ensureProtocol)(config.server, 'http')}/topics/${config.topic}`;
  const response = await (0, _nodeFetch.default)(url, {
    method: 'POST',
    mode: 'cors',
    cache: 'no-cache',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json'
    },
    redirect: 'follow',
    referrer: 'no-referrer',
    body: JSON.stringify({
      records: requests.map(request => ({
        key: request.id,
        value: request.body
      }))
    })
  });

  if (response.status !== 200) {
    const message = `Post requests failed: ${await response.text()}`;
    throw new Error(message);
  }
}

async function postRequestsUsingKafka(requests, context, span) {
  const ensureShared = async (name, createValue) => {
    if (context.shared.has(name)) {
      return context.shared.get(name);
    }

    const value = await createValue();
    context.shared.set(name, value);
    return value;
  };

  const config = context.config.requests;
  const producer = await ensureShared('producer', async () => {
    const kafka = await ensureShared('kafka', async () => new _kafkajs.Kafka({
      clientId: 'q-server',
      brokers: [config.server]
    }));
    const newProducer = kafka.producer();
    await newProducer.connect();
    return newProducer;
  });
  const messages = requests.map(request => {
    const traceInfo = {};
    context.db.tracer.inject(span, _opentracing.FORMAT_TEXT_MAP, traceInfo);
    const keyBuffer = Buffer.from(request.id, 'base64');
    const traceBuffer = Object.keys(traceInfo).length > 0 ? Buffer.from(JSON.stringify(traceInfo), 'utf8') : Buffer.from([]);
    const key = Buffer.concat([keyBuffer, traceBuffer]);
    return {
      key,
      value: Buffer.from(request.body, 'base64')
    };
  });
  await producer.send({
    topic: config.topic,
    messages
  });
}

async function checkPostRestrictions(contracts, requests, accessRights) {
  if (accessRights.restrictToAccounts.length === 0) {
    return;
  }

  const accounts = new Set(accessRights.restrictToAccounts);

  for (const request of requests) {
    const message = await contracts.parseMessage({
      bocBase64: request.body
    });

    if (!accounts.has(message.dst)) {
      throw _auth.Auth.unauthorizedError();
    }
  }
}

async function postRequests(_, args, context) {
  const requests = args.requests;

  if (!requests) {
    return [];
  }

  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, "postRequests", async span => {
    span.setTag('params', requests);
    const accessRights = await (0, _arangoCollection.requireGrantedAccess)(context, args);
    await checkPostRestrictions(context.client.contracts, requests, accessRights);

    try {
      if (context.config.requests.mode === 'rest') {
        await postRequestsUsingRest(requests, context, span);
      } else {
        await postRequestsUsingKafka(requests, context, span);
      }

      context.db.statPostCount.increment();
      context.db.log.debug('postRequests', 'POSTED', args, context.remoteAddress);
    } catch (error) {
      context.db.statPostFailed.increment();
      context.db.log.debug('postRequests', 'FAILED', args, context.remoteAddress);
      throw error;
    }

    return requests.map(x => x.id);
  }, context.parentSpan);
} //------------------------------------------------------------- Access Management


async function registerAccessKeys(_, args, context) {
  return context.auth.registerAccessKeys(args.account || '', args.keys || [], args.signedManagementAccessKey || '');
}

async function revokeAccessKeys(_, args, context) {
  return context.auth.revokeAccessKeys(args.account || '', args.keys || [], args.signedManagementAccessKey || '');
}

async function finishOperations(_, args, context) {
  const operationIds = new Set(args.operationIds || []);

  if (operationIds.size === 0) {
    return 0;
  }

  return context.db.finishOperations(operationIds);
}

function attachCustomResolvers(db, original) {
  overrideObject(original, {
    Query: {
      info,
      getAccountsCount,
      getTransactionsCount,
      getAccountsTotalBalance,
      getManagementAccessKey,
      aggregateBlockSignatures: db.blocks_signatures.aggregationResolver(),
      aggregateBlocks: db.blocks.aggregationResolver(),
      aggregateTransactions: db.transactions.aggregationResolver(),
      aggregateMessages: db.messages.aggregationResolver(),
      aggregateAccounts: db.accounts.aggregationResolver()
    },
    Mutation: {
      postRequests,
      registerAccessKeys,
      revokeAccessKeys,
      finishOperations
    }
  });
  return original;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9yZXNvbHZlcnMtY3VzdG9tLmpzIl0sIm5hbWVzIjpbImlzT2JqZWN0IiwidGVzdCIsIm92ZXJyaWRlT2JqZWN0Iiwib3JpZ2luYWwiLCJvdmVycmlkZXMiLCJPYmplY3QiLCJlbnRyaWVzIiwiZm9yRWFjaCIsIm5hbWUiLCJvdmVycmlkZVZhbHVlIiwiaW5mbyIsInZlcnNpb24iLCJnZXRBY2NvdW50c0NvdW50IiwiX3BhcmVudCIsImFyZ3MiLCJjb250ZXh0IiwidHJhY2VyIiwiZGIiLCJRVHJhY2VyIiwidHJhY2UiLCJyZXN1bHQiLCJxdWVyeSIsImNvdW50cyIsImxlbmd0aCIsImdldFBhcmVudFNwYW4iLCJnZXRUcmFuc2FjdGlvbnNDb3VudCIsImdldEFjY291bnRzVG90YWxCYWxhbmNlIiwicGFydHMiLCJCaWdJbnQiLCJocyIsImxzIiwidG9TdHJpbmciLCJnZXRNYW5hZ2VtZW50QWNjZXNzS2V5IiwiYXV0aCIsInBvc3RSZXF1ZXN0c1VzaW5nUmVzdCIsInJlcXVlc3RzIiwiX3NwYW4iLCJjb25maWciLCJ1cmwiLCJzZXJ2ZXIiLCJ0b3BpYyIsInJlc3BvbnNlIiwibWV0aG9kIiwibW9kZSIsImNhY2hlIiwiY3JlZGVudGlhbHMiLCJoZWFkZXJzIiwicmVkaXJlY3QiLCJyZWZlcnJlciIsImJvZHkiLCJKU09OIiwic3RyaW5naWZ5IiwicmVjb3JkcyIsIm1hcCIsInJlcXVlc3QiLCJrZXkiLCJpZCIsInZhbHVlIiwic3RhdHVzIiwibWVzc2FnZSIsInRleHQiLCJFcnJvciIsInBvc3RSZXF1ZXN0c1VzaW5nS2Fma2EiLCJzcGFuIiwiZW5zdXJlU2hhcmVkIiwiY3JlYXRlVmFsdWUiLCJzaGFyZWQiLCJoYXMiLCJnZXQiLCJzZXQiLCJwcm9kdWNlciIsImthZmthIiwiS2Fma2EiLCJjbGllbnRJZCIsImJyb2tlcnMiLCJuZXdQcm9kdWNlciIsImNvbm5lY3QiLCJtZXNzYWdlcyIsInRyYWNlSW5mbyIsImluamVjdCIsIkZPUk1BVF9URVhUX01BUCIsImtleUJ1ZmZlciIsIkJ1ZmZlciIsImZyb20iLCJ0cmFjZUJ1ZmZlciIsImtleXMiLCJjb25jYXQiLCJzZW5kIiwiY2hlY2tQb3N0UmVzdHJpY3Rpb25zIiwiY29udHJhY3RzIiwiYWNjZXNzUmlnaHRzIiwicmVzdHJpY3RUb0FjY291bnRzIiwiYWNjb3VudHMiLCJTZXQiLCJwYXJzZU1lc3NhZ2UiLCJib2NCYXNlNjQiLCJkc3QiLCJBdXRoIiwidW5hdXRob3JpemVkRXJyb3IiLCJwb3N0UmVxdWVzdHMiLCJfIiwic2V0VGFnIiwiY2xpZW50Iiwic3RhdFBvc3RDb3VudCIsImluY3JlbWVudCIsImxvZyIsImRlYnVnIiwicmVtb3RlQWRkcmVzcyIsImVycm9yIiwic3RhdFBvc3RGYWlsZWQiLCJ4IiwicGFyZW50U3BhbiIsInJlZ2lzdGVyQWNjZXNzS2V5cyIsImFjY291bnQiLCJzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5IiwicmV2b2tlQWNjZXNzS2V5cyIsImZpbmlzaE9wZXJhdGlvbnMiLCJvcGVyYXRpb25JZHMiLCJzaXplIiwiYXR0YWNoQ3VzdG9tUmVzb2x2ZXJzIiwiUXVlcnkiLCJhZ2dyZWdhdGVCbG9ja1NpZ25hdHVyZXMiLCJibG9ja3Nfc2lnbmF0dXJlcyIsImFnZ3JlZ2F0aW9uUmVzb2x2ZXIiLCJhZ2dyZWdhdGVCbG9ja3MiLCJibG9ja3MiLCJhZ2dyZWdhdGVUcmFuc2FjdGlvbnMiLCJ0cmFuc2FjdGlvbnMiLCJhZ2dyZWdhdGVNZXNzYWdlcyIsImFnZ3JlZ2F0ZUFjY291bnRzIiwiTXV0YXRpb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFJQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7OztBQUVBLFNBQVNBLFFBQVQsQ0FBa0JDLElBQWxCLEVBQXNDO0FBQ2xDLFNBQU8sT0FBT0EsSUFBUCxLQUFnQixRQUFoQixJQUE0QkEsSUFBSSxLQUFLLElBQTVDO0FBQ0g7O0FBRUQsU0FBU0MsY0FBVCxDQUF3QkMs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QVBkO0FBUUhHLE1BQUFBLHFCQUFxQixFQUFFN0csRUFBRSxDQUFDOEcsWUFBSCxDQUFnQkosbUJBQWhCLEVBUnBCO0FBU0hLLE1BQUFBLGlCQUFpQixFQUFFL0csRUFBRSxDQUFDNEQsUUFBSCxDQUFZOEMsbUJBQVosRUFUaEI7QUFVSE0sTUFBQUEsaUJBQWlCLEVBQUVoSCxFQUFFLENBQUMyRSxRQUFILENBQVkrQixtQkFBWjtBQVZoQixLQURjO0FBYXJCTyxJQUFBQSxRQUFRLEVBQUU7QUFDTi9CLE1BQUFBLFlBRE07QUFFTmEsTUFBQUEsa0JBRk07QUFHTkcsTUFBQUEsZ0JBSE07QUFJTkMsTUFBQUE7QUFKTTtBQWJXLEdBQVgsQ0FBZDtBQW9CQSxTQUFPakgsUUFBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHsgS2Fma2EsIFByb2R1Y2VyIH0gZnJvbSBcImthZmthanNcIjtcbmltcG9ydCB7IFNwYW4sIEZPUk1BVF9URVhUX01BUCB9IGZyb20gJ29wZW50cmFjaW5nJztcbmltcG9ydCB0eXBlIHsgVE9OQ29udHJhY3RzIH0gZnJvbSBcInRvbi1jbGllbnQtanMvdHlwZXNcIjtcbmltcG9ydCBBcmFuZ28gZnJvbSBcIi4vYXJhbmdvXCI7XG5pbXBvcnQgeyByZXF1aXJlR3JhbnRlZEFjY2VzcyB9IGZyb20gXCIuL2FyYW5nby1jb2xsZWN0aW9uXCI7XG5pbXBvcnQgdHlwZSB7XG4gICAgR3JhcGhRTFJlcXVlc3RDb250ZXh0XG59IGZyb20gXCIuL2FyYW5nby1jb2xsZWN0aW9uXCI7XG5pbXBvcnQgeyBBdXRoIH0gZnJvbSBcIi4vYXV0aFwiO1xuaW1wb3J0IHsgZW5zdXJlUHJvdG9jb2wgfSBmcm9tIFwiLi9jb25maWdcIjtcbmltcG9ydCBmZXRjaCBmcm9tICdub2RlLWZldGNoJztcbmltcG9ydCB0eXBlIHsgQWNjZXNzS2V5LCBBY2Nlc3NSaWdodHMgfSBmcm9tIFwiLi9hdXRoXCI7XG5pbXBvcnQgeyBRVHJhY2VyIH0gZnJvbSBcIi4vdHJhY2VyXCI7XG5pbXBvcnQge3ZlcnNpb259IGZyb20gJy4uL3BhY2thZ2UuanNvbic7XG5cbmZ1bmN0aW9uIGlzT2JqZWN0KHRlc3Q6IGFueSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0eXBlb2YgdGVzdCA9PT0gJ29iamVjdCcgJiYgdGVzdCAhPT0gbnVsbDtcbn1cblxuZnVuY3Rpb24gb3ZlcnJpZGVPYmplY3Qob3JpZ2luYWw6IGFueSwgb3ZlcnJpZGVzOiBhbnkpIHtcbiAgICBPYmplY3QuZW50cmllcyhvdmVycmlkZXMpLmZvckVhY2goKFtuYW1lLCBvdmVycmlkZVZhbHVlXSkgPT4ge1xuICAgICAgICBpZiAoKG5hbWUgaW4gb3JpZ2luYWwpICYmIGlzT2JqZWN0KG92ZXJyaWRlVmFsdWUpICYmIGlzT2JqZWN0KG9yaWdpbmFsW25hbWVdKSkge1xuICAgICAgICAgICAgb3ZlcnJpZGVPYmplY3Qob3JpZ2luYWxbbmFtZV0sIG92ZXJyaWRlVmFsdWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb3JpZ2luYWxbbmFtZV0gPSBvdmVycmlkZVZhbHVlO1xuICAgICAgICB9XG4gICAgfSk7XG59XG5cbnR5cGUgSW5mbyA9IHtcbiAgICB2ZXJzaW9uOiBzdHJpbmcsXG59XG5cbnR5cGUgUmVxdWVzdCA9IHtcbiAgICBpZDogc3RyaW5nLFxuICAgIGJvZHk6IHN0cmluZyxcbn1cblxuZXhwb3J0IHR5cGUgR3JhcGhRTFJlcXVlc3RDb250ZXh0RXggPSBHcmFwaFFMUmVxdWVzdENvbnRleHQgJiB7XG4gICAgZGI6IEFyYW5nbyxcbn1cblxuLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIFF1ZXJ5XG5cbmZ1bmN0aW9uIGluZm8oKTogSW5mbyB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgdmVyc2lvbixcbiAgICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBY2NvdW50c0NvdW50KF9wYXJlbnQsIGFyZ3MsIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4KTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBjb25zdCB0cmFjZXIgPSBjb250ZXh0LmRiLnRyYWNlcjtcbiAgICByZXR1cm4gUVRyYWNlci50cmFjZSh0cmFjZXIsICdnZXRBY2NvdW50c0NvdW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCByZXF1aXJlR3JhbnRlZEFjY2Vzcyhjb250ZXh0LCBhcmdzKTtcbiAgICAgICAgY29uc3QgcmVzdWx0OiBhbnkgPSBhd2FpdCBjb250ZXh0LmRiLnF1ZXJ5KGBSRVRVUk4gTEVOR1RIKGFjY291bnRzKWAsIHt9KTtcbiAgICAgICAgY29uc3QgY291bnRzID0gKHJlc3VsdDogbnVtYmVyW10pO1xuICAgICAgICByZXR1cm4gY291bnRzLmxlbmd0aCA+IDAgPyBjb3VudHNbMF0gOiAwO1xuICAgIH0sIFFUcmFjZXIuZ2V0UGFyZW50U3Bhbih0cmFjZXIsIGNvbnRleHQpKVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRUcmFuc2FjdGlvbnNDb3VudChfcGFyZW50LCBhcmdzLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgdHJhY2VyID0gY29udGV4dC5kYi50cmFjZXI7XG4gICAgcmV0dXJuIFFUcmFjZXIudHJhY2UodHJhY2VyLCAnZ2V0VHJhbnNhY3Rpb25zQ291bnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IHJlcXVpcmVHcmFudGVkQWNjZXNzKGNvbnRleHQsIGFyZ3MpO1xuICAgICAgICBjb25zdCByZXN1bHQ6IGFueSA9IGF3YWl0IGNvbnRleHQuZGIucXVlcnkoYFJFVFVSTiBMRU5HVEgodHJhbnNhY3Rpb25zKWAsIHt9KTtcbiAgICAgICAgY29uc3QgY291bnRzID0gKHJlc3VsdDogbnVtYmVyW10pO1xuICAgICAgICByZXR1cm4gY291bnRzLmxlbmd0aCA+IDAgPyBjb3VudHNbMF0gOiAwO1xuICAgIH0sIFFUcmFjZXIuZ2V0UGFyZW50U3Bhbih0cmFjZXIsIGNvbnRleHQpKVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBY2NvdW50c1RvdGFsQmFsYW5jZShfcGFyZW50LCBhcmdzLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCk6IFByb21pc2U8U3RyaW5nPiB7XG4gICAgY29uc3QgdHJhY2VyID0gY29udGV4dC5kYi50cmFjZXI7XG4gICAgcmV0dXJuIFFUcmFjZXIudHJhY2UodHJhY2VyLCAnZ2V0QWNjb3VudHNUb3RhbEJhbGFuY2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IHJlcXVpcmVHcmFudGVkQWNjZXNzKGNvbnRleHQsIGFyZ3MpO1xuICAgICAgICAvKlxuICAgICAgICBCZWNhdXNlIGFyYW5nbyBjYW4gbm90IHN1bSBCaWdJbnQncyB3ZSBuZWVkIHRvIHN1bSBzZXBhcmF0ZWx5OlxuICAgICAgICBocyA9IFNVTSBvZiBoaWdoIGJpdHMgKGZyb20gMjQtYml0IGFuZCBoaWdoZXIpXG4gICAgICAgIGxzID0gU1VNIG9mIGxvd2VyIDI0IGJpdHNcbiAgICAgICAgQW5kIHRoZSB0b3RhbCByZXN1bHQgaXMgKGhzIDw8IDI0KSArIGxzXG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCByZXN1bHQ6IGFueSA9IGF3YWl0IGNvbnRleHQuZGIucXVlcnkoYFxuICAgICAgICAgICAgTEVUIGQgPSAxNjc3NzIxNlxuICAgICAgICAgICAgRk9SIGEgaW4gYWNjb3VudHNcbiAgICAgICAgICAgIExFVCBiID0gVE9fTlVNQkVSKENPTkNBVChcIjB4XCIsIFNVQlNUUklORyhhLmJhbGFuY2UsIDIpKSlcbiAgICAgICAgICAgIENPTExFQ1QgQUdHUkVHQVRFXG4gICAgICAgICAgICAgICAgaHMgPSBTVU0oRkxPT1IoYiAvIGQpKSxcbiAgICAgICAgICAgICAgICBscyA9IFNVTShiICUgKGQgLSAxKSlcbiAgICAgICAgICAgIFJFVFVSTiB7IGhzLCBscyB9XG4gICAgICAgIGAsIHt9KTtcbiAgICAgICAgY29uc3QgcGFydHMgPSAocmVzdWx0OiB7IGhzOiBudW1iZXIsIGxzOiBudW1iZXIgfVtdKVswXTtcbiAgICAgICAgLy8kRmxvd0ZpeE1lXG4gICAgICAgIHJldHVybiAoQmlnSW50KHBhcnRzLmhzKSAqIEJpZ0ludCgweDEwMDAwMDApICsgQmlnSW50KHBhcnRzLmxzKSkudG9TdHJpbmcoKTtcbiAgICB9LCBRVHJhY2VyLmdldFBhcmVudFNwYW4odHJhY2VyLCBjb250ZXh0KSlcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0TWFuYWdlbWVudEFjY2Vzc0tleShfcGFyZW50LCBhcmdzLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIGNvbnRleHQuYXV0aC5nZXRNYW5hZ2VtZW50QWNjZXNzS2V5KCk7XG59XG5cblxuLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIE11dGF0aW9uXG5cblxuYXN5bmMgZnVuY3Rpb24gcG9zdFJlcXVlc3RzVXNpbmdSZXN0KHJlcXVlc3RzOiBSZXF1ZXN0W10sIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4LCBfc3BhbjogU3Bhbik6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGNvbmZpZyA9IGNvbnRleHQuY29uZmlnLnJlcXVlc3RzO1xuICAgIGNvbnN0IHVybCA9IGAke2Vuc3VyZVByb3RvY29sKGNvbmZpZy5zZXJ2ZXIsICdodHRwJyl9L3RvcGljcy8ke2NvbmZpZy50b3BpY31gO1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsLCB7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBtb2RlOiAnY29ycycsXG4gICAgICAgIGNhY2hlOiAnbm8tY2FjaGUnLFxuICAgICAgICBjcmVkZW50aWFsczogJ3NhbWUtb3JpZ2luJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgfSxcbiAgICAgICAgcmVkaXJlY3Q6ICdmb2xsb3cnLFxuICAgICAgICByZWZlcnJlcjogJ25vLXJlZmVycmVyJyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgcmVjb3JkczogcmVxdWVzdHMubWFwKChyZXF1ZXN0KSA9PiAoe1xuICAgICAgICAgICAgICAgIGtleTogcmVxdWVzdC5pZCxcbiAgICAgICAgICAgICAgICB2YWx1ZTogcmVxdWVzdC5ib2R5LFxuICAgICAgICAgICAgfSkpLFxuICAgICAgICB9KSxcbiAgICB9KTtcbiAgICBpZiAocmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IGBQb3N0IHJlcXVlc3RzIGZhaWxlZDogJHthd2FpdCByZXNwb25zZS50ZXh0KCl9YDtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1lc3NhZ2UpO1xuICAgIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcG9zdFJlcXVlc3RzVXNpbmdLYWZrYShyZXF1ZXN0czogUmVxdWVzdFtdLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCwgc3BhbjogU3Bhbik6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGVuc3VyZVNoYXJlZCA9IGFzeW5jIChuYW1lLCBjcmVhdGVWYWx1ZTogKCkgPT4gUHJvbWlzZTxhbnk+KSA9PiB7XG4gICAgICAgIGlmIChjb250ZXh0LnNoYXJlZC5oYXMobmFtZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBjb250ZXh0LnNoYXJlZC5nZXQobmFtZSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdmFsdWUgPSBhd2FpdCBjcmVhdGVWYWx1ZSgpO1xuICAgICAgICBjb250ZXh0LnNoYXJlZC5zZXQobmFtZSwgdmFsdWUpO1xuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfTtcblxuICAgIGNvbnN0IGNvbmZpZyA9IGNvbnRleHQuY29uZmlnLnJlcXVlc3RzO1xuICAgIGNvbnN0IHByb2R1Y2VyOiBQcm9kdWNlciA9IGF3YWl0IGVuc3VyZVNoYXJlZCgncHJvZHVjZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGthZmthOiBLYWZrYSA9IGF3YWl0IGVuc3VyZVNoYXJlZCgna2Fma2EnLCBhc3luYyAoKSA9PiBuZXcgS2Fma2Eoe1xuICAgICAgICAgICAgY2xpZW50SWQ6ICdxLXNlcnZlcicsXG4gICAgICAgICAgICBicm9rZXJzOiBbY29uZmlnLnNlcnZlcl1cbiAgICAgICAgfSkpO1xuICAgICAgICBjb25zdCBuZXdQcm9kdWNlciA9IGthZmthLnByb2R1Y2VyKCk7XG4gICAgICAgIGF3YWl0IG5ld1Byb2R1Y2VyLmNvbm5lY3QoKTtcbiAgICAgICAgcmV0dXJuIG5ld1Byb2R1Y2VyO1xuXG4gICAgfSk7XG4gICAgY29uc3QgbWVzc2FnZXMgPSByZXF1ZXN0cy5tYXAoKHJlcXVlc3QpID0+IHtcbiAgICAgICAgY29uc3QgdHJhY2VJbmZvID0ge307XG4gICAgICAgIGNvbnRleHQuZGIudHJhY2VyLmluamVjdChzcGFuLCBGT1JNQVRfVEVYVF9NQVAsIHRyYWNlSW5mbyk7XG4gICAgICAgIGNvbnN0IGtleUJ1ZmZlciA9IEJ1ZmZlci5mcm9tKHJlcXVlc3QuaWQsICdiYXNlNjQnKTtcbiAgICAgICAgY29uc3QgdHJhY2VCdWZmZXIgPSAoT2JqZWN0LmtleXModHJhY2VJbmZvKS5sZW5ndGggPiAwKVxuICAgICAgICAgICAgPyBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeSh0cmFjZUluZm8pLCAndXRmOCcpXG4gICAgICAgICAgICA6IEJ1ZmZlci5mcm9tKFtdKTtcbiAgICAgICAgY29uc3Qga2V5ID0gQnVmZmVyLmNvbmNhdChba2V5QnVmZmVyLCB0cmFjZUJ1ZmZlcl0pO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgdmFsdWU6IEJ1ZmZlci5mcm9tKHJlcXVlc3QuYm9keSwgJ2Jhc2U2NCcpLFxuICAgICAgICB9O1xuICAgIH0pO1xuICAgIGF3YWl0IHByb2R1Y2VyLnNlbmQoe1xuICAgICAgICB0b3BpYzogY29uZmlnLnRvcGljLFxuICAgICAgICBtZXNzYWdlcyxcbiAgICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tQb3N0UmVzdHJpY3Rpb25zKFxuICAgIGNvbnRyYWN0czogVE9OQ29udHJhY3RzLFxuICAgIHJlcXVlc3RzOiBSZXF1ZXN0W10sXG4gICAgYWNjZXNzUmlnaHRzOiBBY2Nlc3NSaWdodHMsXG4pIHtcbiAgICBpZiAoYWNjZXNzUmlnaHRzLnJlc3RyaWN0VG9BY2NvdW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBhY2NvdW50cyA9IG5ldyBTZXQoYWNjZXNzUmlnaHRzLnJlc3RyaWN0VG9BY2NvdW50cyk7XG4gICAgZm9yIChjb25zdCByZXF1ZXN0OiBSZXF1ZXN0IG9mIHJlcXVlc3RzKSB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBhd2FpdCBjb250cmFjdHMucGFyc2VNZXNzYWdlKHtcbiAgICAgICAgICAgIGJvY0Jhc2U2NDogcmVxdWVzdC5ib2R5LFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKCFhY2NvdW50cy5oYXMobWVzc2FnZS5kc3QpKSB7XG4gICAgICAgICAgICB0aHJvdyBBdXRoLnVuYXV0aG9yaXplZEVycm9yKCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBvc3RSZXF1ZXN0cyhcbiAgICBfLFxuICAgIGFyZ3M6IHsgcmVxdWVzdHM6IFJlcXVlc3RbXSwgYWNjZXNzS2V5Pzogc3RyaW5nIH0sXG4gICAgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsXG4pOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgcmVxdWVzdHM6ID8oUmVxdWVzdFtdKSA9IGFyZ3MucmVxdWVzdHM7XG4gICAgaWYgKCFyZXF1ZXN0cykge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgY29uc3QgdHJhY2VyID0gY29udGV4dC5kYi50cmFjZXI7XG4gICAgcmV0dXJuIFFUcmFjZXIudHJhY2UodHJhY2VyLCBcInBvc3RSZXF1ZXN0c1wiLCBhc3luYyAoc3BhbjogU3BhbikgPT4ge1xuICAgICAgICBzcGFuLnNldFRhZygncGFyYW1zJywgcmVxdWVzdHMpO1xuICAgICAgICBjb25zdCBhY2Nlc3NSaWdodHMgPSBhd2FpdCByZXF1aXJlR3JhbnRlZEFjY2Vzcyhjb250ZXh0LCBhcmdzKTtcbiAgICAgICAgYXdhaXQgY2hlY2tQb3N0UmVzdHJpY3Rpb25zKGNvbnRleHQuY2xpZW50LmNvbnRyYWN0cywgcmVxdWVzdHMsIGFjY2Vzc1JpZ2h0cyk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoY29udGV4dC5jb25maWcucmVxdWVzdHMubW9kZSA9PT0gJ3Jlc3QnKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgcG9zdFJlcXVlc3RzVXNpbmdSZXN0KHJlcXVlc3RzLCBjb250ZXh0LCBzcGFuKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgcG9zdFJlcXVlc3RzVXNpbmdLYWZrYShyZXF1ZXN0cywgY29udGV4dCwgc3Bhbik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb250ZXh0LmRiLnN0YXRQb3N0Q291bnQuaW5jcmVtZW50KCk7XG4gICAgICAgICAgICBjb250ZXh0LmRiLmxvZy5kZWJ1ZygncG9zdFJlcXVlc3RzJywgJ1BPU1RFRCcsIGFyZ3MsIGNvbnRleHQucmVtb3RlQWRkcmVzcyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb250ZXh0LmRiLnN0YXRQb3N0RmFpbGVkLmluY3JlbWVudCgpO1xuICAgICAgICAgICAgY29udGV4dC5kYi5sb2cuZGVidWcoJ3Bvc3RSZXF1ZXN0cycsICdGQUlMRUQnLCBhcmdzLCBjb250ZXh0LnJlbW90ZUFkZHJlc3MpO1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlcXVlc3RzLm1hcCh4ID0+IHguaWQpO1xuICAgIH0sIGNvbnRleHQucGFyZW50U3Bhbik7XG59XG5cbi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBBY2Nlc3MgTWFuYWdlbWVudFxuXG50eXBlIE1hbmFnZW1lbnRBcmdzID0ge1xuICAgIGFjY291bnQ/OiBzdHJpbmcsXG4gICAgc2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleT86IHN0cmluZyxcbn1cblxudHlwZSBSZWdpc3RlckFjY2Vzc0tleXNBcmdzID0gTWFuYWdlbWVudEFyZ3MgJiB7XG4gICAga2V5czogQWNjZXNzS2V5W10sXG59XG5cbnR5cGUgUmV2b2tlQWNjZXNzS2V5c0FyZ3MgPSBNYW5hZ2VtZW50QXJncyAmIHtcbiAgICBrZXlzOiBzdHJpbmdbXSxcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVnaXN0ZXJBY2Nlc3NLZXlzKFxuICAgIF8sXG4gICAgYXJnczogUmVnaXN0ZXJBY2Nlc3NLZXlzQXJncyxcbiAgICBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCxcbik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgcmV0dXJuIGNvbnRleHQuYXV0aC5yZWdpc3RlckFjY2Vzc0tleXMoXG4gICAgICAgIGFyZ3MuYWNjb3VudCB8fCAnJyxcbiAgICAgICAgYXJncy5rZXlzIHx8IFtdLFxuICAgICAgICBhcmdzLnNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXkgfHwgJycpO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZXZva2VBY2Nlc3NLZXlzKFxuICAgIF8sXG4gICAgYXJnczogUmV2b2tlQWNjZXNzS2V5c0FyZ3MsXG4gICAgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsXG4pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIHJldHVybiBjb250ZXh0LmF1dGgucmV2b2tlQWNjZXNzS2V5cyhcbiAgICAgICAgYXJncy5hY2NvdW50IHx8ICcnLFxuICAgICAgICBhcmdzLmtleXMgfHwgW10sXG4gICAgICAgIGFyZ3Muc2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleSB8fCAnJyk7XG59XG5cbnR5cGUgRmluaXNoT3BlcmF0aW9uc0FyZ3MgPSB7XG4gICAgb3BlcmF0aW9uSWRzPzogc3RyaW5nW10sXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpbmlzaE9wZXJhdGlvbnMoXG4gICAgXyxcbiAgICBhcmdzOiBGaW5pc2hPcGVyYXRpb25zQXJncyxcbiAgICBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCxcbik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3Qgb3BlcmF0aW9uSWRzID0gbmV3IFNldChhcmdzLm9wZXJhdGlvbklkcyB8fCBbXSk7XG4gICAgaWYgKG9wZXJhdGlvbklkcy5zaXplID09PSAwKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgICByZXR1cm4gY29udGV4dC5kYi5maW5pc2hPcGVyYXRpb25zKG9wZXJhdGlvbklkcyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhdHRhY2hDdXN0b21SZXNvbHZlcnMoZGI6IEFyYW5nbywgb3JpZ2luYWw6IGFueSk6IGFueSB7XG4gICAgb3ZlcnJpZGVPYmplY3Qob3JpZ2luYWwsIHtcbiAgICAgICAgUXVlcnk6IHtcbiAgICAgICAgICAgIGluZm8sXG4gICAgICAgICAgICBnZXRBY2NvdW50c0NvdW50LFxuICAgICAgICAgICAgZ2V0VHJhbnNhY3Rpb25zQ291bnQsXG4gICAgICAgICAgICBnZXRBY2NvdW50c1RvdGFsQmFsYW5jZSxcbiAgICAgICAgICAgIGdldE1hbmFnZW1lbnRBY2Nlc3NLZXksXG4gICAgICAgICAgICBhZ2dyZWdhdGVCbG9ja1NpZ25hdHVyZXM6IGRiLmJsb2Nrc19zaWduYXR1cmVzLmFnZ3JlZ2F0aW9uUmVzb2x2ZXIoKSxcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZUJsb2NrczogZGIuYmxvY2tzLmFnZ3JlZ2F0aW9uUmVzb2x2ZXIoKSxcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZVRyYW5zYWN0aW9uczogZGIudHJhbnNhY3Rpb25zLmFnZ3JlZ2F0aW9uUmVzb2x2ZXIoKSxcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZU1lc3NhZ2VzOiBkYi5tZXNzYWdlcy5hZ2dyZWdhdGlvblJlc29sdmVyKCksXG4gICAgICAgICAgICBhZ2dyZWdhdGVBY2NvdW50czogZGIuYWNjb3VudHMuYWdncmVnYXRpb25SZXNvbHZlcigpLFxuICAgICAgICB9LFxuICAgICAgICBNdXRhdGlvbjoge1xuICAgICAgICAgICAgcG9zdFJlcXVlc3RzLFxuICAgICAgICAgICAgcmVnaXN0ZXJBY2Nlc3NLZXlzLFxuICAgICAgICAgICAgcmV2b2tlQWNjZXNzS2V5cyxcbiAgICAgICAgICAgIGZpbmlzaE9wZXJhdGlvbnMsXG4gICAgICAgIH0sXG4gICAgfSk7XG4gICAgcmV0dXJuIG9yaWdpbmFsO1xufVxuIl19