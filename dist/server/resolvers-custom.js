"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.attachCustomResolvers = attachCustomResolvers;

var _fs = _interopRequireDefault(require("fs"));

var _kafkajs = require("kafkajs");

var _opentracing = require("opentracing");

var _arango = _interopRequireDefault(require("./arango"));

var _arangoCollection = require("./arango-collection");

var _auth = require("./auth");

var _config = require("./config");

var _path = _interopRequireDefault(require("path"));

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _tracer = require("./tracer");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function isObject(test) {
  return typeof test === 'object' && test !== null;
}

function overrideObject(original, overrides) {
  Object.entries(overrides).forEach(([name, overrideValue]) => {
    if (name in original && isObject(overrideValue) && isObject(original[name])) {
      overrideObject(original[name], overrideValue);
    } else {
      original[name] = overrideValue;
    }
  });
}

// Query
function info() {
  const pkg = JSON.parse(_fs.default.readFileSync(_path.default.resolve(__dirname, '..', '..', 'package.json')));
  return {
    version: pkg.version
  };
}

async function getAccountsCount(_parent, args, context) {
  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, 'getAccountsCount', async () => {
    await (0, _arangoCollection.requireGrantedAccess)(context, args);
    const result = await context.db.query(`RETURN LENGTH(accounts)`, {});
    const counts = result;
    return counts.length > 0 ? counts[0] : 0;
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getTransactionsCount(_parent, args, context) {
  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, 'getTransactionsCount', async () => {
    await (0, _arangoCollection.requireGrantedAccess)(context, args);
    const result = await context.db.query(`RETURN LENGTH(transactions)`, {});
    const counts = result;
    return counts.length > 0 ? counts[0] : 0;
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getAccountsTotalBalance(_parent, args, context) {
  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, 'getAccountsTotalBalance', async () => {
    await (0, _arangoCollection.requireGrantedAccess)(context, args);
    /*
    Because arango can not sum BigInt's we need to sum separately:
    hs = SUM of high bits (from 24-bit and higher)
    ls = SUM of lower 24 bits
    And the total result is (hs << 24) + ls
     */

    const result = await context.db.query(`
            LET d = 16777216
            FOR a in accounts
            LET b = TO_NUMBER(CONCAT("0x", SUBSTRING(a.balance, 2)))
            COLLECT AGGREGATE
                hs = SUM(FLOOR(b / d)),
                ls = SUM(b % (d - 1))
            RETURN { hs, ls }
        `, {});
    const parts = result[0]; //$FlowFixMe

    return (BigInt(parts.hs) * BigInt(0x1000000) + BigInt(parts.ls)).toString();
  }, _tracer.QTracer.getParentSpan(tracer, context));
}

async function getManagementAccessKey(_parent, args, context) {
  return context.auth.getManagementAccessKey();
} // Mutation


async function postRequestsUsingRest(requests, context, _span) {
  const config = context.config.requests;
  const url = `${(0, _config.ensureProtocol)(config.server, 'http')}/topics/${config.topic}`;
  const response = await (0, _nodeFetch.default)(url, {
    method: 'POST',
    mode: 'cors',
    cache: 'no-cache',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json'
    },
    redirect: 'follow',
    referrer: 'no-referrer',
    body: JSON.stringify({
      records: requests.map(request => ({
        key: request.id,
        value: request.body
      }))
    })
  });

  if (response.status !== 200) {
    const message = `Post requests failed: ${await response.text()}`;
    throw new Error(message);
  }
}

async function postRequestsUsingKafka(requests, context, span) {
  const ensureShared = async (name, createValue) => {
    if (context.shared.has(name)) {
      return context.shared.get(name);
    }

    const value = await createValue();
    context.shared.set(name, value);
    return value;
  };

  const config = context.config.requests;
  const producer = await ensureShared('producer', async () => {
    const kafka = await ensureShared('kafka', async () => new _kafkajs.Kafka({
      clientId: 'q-server',
      brokers: [config.server]
    }));
    const newProducer = kafka.producer();
    await newProducer.connect();
    return newProducer;
  });
  const messages = requests.map(request => {
    const traceInfo = {};
    context.db.tracer.inject(span, _opentracing.FORMAT_TEXT_MAP, traceInfo);
    const keyBuffer = Buffer.from(request.id, 'base64');
    const traceBuffer = Buffer.from(JSON.stringify(traceInfo), 'utf8');
    const key = Buffer.concat([keyBuffer, traceBuffer]);
    return {
      key,
      value: Buffer.from(request.body, 'base64')
    };
  });
  await producer.send({
    topic: config.topic,
    messages
  });
}

async function checkPostRestrictions(contracts, requests, accessRights) {
  if (accessRights.restrictToAccounts.length === 0) {
    return;
  }

  const accounts = new Set(accessRights.restrictToAccounts);

  for (const request of requests) {
    const message = await contracts.parseMessage({
      bocBase64: request.body
    });

    if (!accounts.has(message.dst)) {
      throw _auth.Auth.unauthorizedError();
    }
  }
}

async function postRequests(_, args, context) {
  const requests = args.requests;

  if (!requests) {
    return [];
  }

  const tracer = context.db.tracer;
  return _tracer.QTracer.trace(tracer, "postRequests", async span => {
    span.setTag('params', requests);
    const accessRights = await (0, _arangoCollection.requireGrantedAccess)(context, args);
    await checkPostRestrictions(context.client.contracts, requests, accessRights);

    try {
      if (context.config.requests.mode === 'rest') {
        await postRequestsUsingRest(requests, context, span);
      } else {
        await postRequestsUsingKafka(requests, context, span);
      }

      context.db.log.debug('postRequests', 'POSTED', args, context.remoteAddress);
    } catch (error) {
      context.db.log.debug('postRequests', 'FAILED', args, context.remoteAddress);
      throw error;
    }

    return requests.map(x => x.id);
  }, context.parentSpan);
}

async function registerAccessKeys(_, args, context) {
  return context.auth.registerAccessKeys(args.account || '', args.keys || [], args.signedManagementAccessKey || '');
}

async function revokeAccessKeys(_, args, context) {
  return context.auth.revokeAccessKeys(args.account || '', args.keys || [], args.signedManagementAccessKey || '');
}

async function finishOperations(_, args, context) {
  const operationIds = new Set(args.operationIds || []);

  if (operationIds.size === 0) {
    return 0;
  }

  return context.db.finishOperations(operationIds);
}

const resolversCustom = {
  Query: {
    info,
    getAccountsCount,
    getTransactionsCount,
    getAccountsTotalBalance,
    getManagementAccessKey
  },
  Mutation: {
    postRequests,
    registerAccessKeys,
    revokeAccessKeys,
    finishOperations
  }
};

function attachCustomResolvers(original) {
  overrideObject(original, resolversCustom);
  return original;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9yZXNvbHZlcnMtY3VzdG9tLmpzIl0sIm5hbWVzIjpbImlzT2JqZWN0IiwidGVzdCIsIm92ZXJyaWRlT2JqZWN0Iiwib3JpZ2luYWwiLCJvdmVycmlkZXMiLCJPYmplY3QiLCJlbnRyaWVzIiwiZm9yRWFjaCIsIm5hbWUiLCJvdmVycmlkZVZhbHVlIiwiaW5mbyIsInBrZyIsIkpTT04iLCJwYXJzZSIsImZzIiwicmVhZEZpbGVTeW5jIiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJ2ZXJzaW9uIiwiZ2V0QWNjb3VudHNDb3VudCIsIl9wYXJlbnQiLCJhcmdzIiwiY29udGV4dCIsInRyYWNlciIsImRiIiwiUVRyYWNlciIsInRyYWNlIiwicmVzdWx0IiwicXVlcnkiLCJjb3VudHMiLCJsZW5ndGgiLCJnZXRQYXJlbnRTcGFuIiwiZ2V0VHJhbnNhY3Rpb25zQ291bnQiLCJnZXRBY2NvdW50c1RvdGFsQmFsYW5jZSIsInBhcnRzIiwiQmlnSW50IiwiaHMiLCJscyIsInRvU3RyaW5nIiwiZ2V0TWFuYWdlbWVudEFjY2Vzc0tleSIsImF1dGgiLCJwb3N0UmVxdWVzdHNVc2luZ1Jlc3QiLCJyZXF1ZXN0cyIsIl9zcGFuIiwiY29uZmlnIiwidXJsIiwic2VydmVyIiwidG9waWMiLCJyZXNwb25zZSIsIm1ldGhvZCIsIm1vZGUiLCJjYWNoZSIsImNyZWRlbnRpYWxzIiwiaGVhZGVycyIsInJlZGlyZWN0IiwicmVmZXJyZXIiLCJib2R5Iiwic3RyaW5naWZ5IiwicmVjb3JkcyIsIm1hcCIsInJlcXVlc3QiLCJrZXkiLCJpZCIsInZhbHVlIiwic3RhdHVzIiwibWVzc2FnZSIsInRleHQiLCJFcnJvciIsInBvc3RSZXF1ZXN0c1VzaW5nS2Fma2EiLCJzcGFuIiwiZW5zdXJlU2hhcmVkIiwiY3JlYXRlVmFsdWUiLCJzaGFyZWQiLCJoYXMiLCJnZXQiLCJzZXQiLCJwcm9kdWNlciIsImthZmthIiwiS2Fma2EiLCJjbGllbnRJZCIsImJyb2tlcnMiLCJuZXdQcm9kdWNlciIsImNvbm5lY3QiLCJtZXNzYWdlcyIsInRyYWNlSW5mbyIsImluamVjdCIsIkZPUk1BVF9URVhUX01BUCIsImtleUJ1ZmZlciIsIkJ1ZmZlciIsImZyb20iLCJ0cmFjZUJ1ZmZlciIsImNvbmNhdCIsInNlbmQiLCJjaGVja1Bvc3RSZXN0cmljdGlvbnMiLCJjb250cmFjdHMiLCJhY2Nlc3NSaWdodHMiLCJyZXN0cmljdFRvQWNjb3VudHMiLCJhY2NvdW50cyIsIlNldCIsInBhcnNlTWVzc2FnZSIsImJvY0Jhc2U2NCIsImRzdCIsIkF1dGgiLCJ1bmF1dGhvcml6ZWRFcnJvciIsInBvc3RSZXF1ZXN0cyIsIl8iLCJzZXRUYWciLCJjbGllbnQiLCJsb2ciLCJkZWJ1ZyIsInJlbW90ZUFkZHJlc3MiLCJlcnJvciIsIngiLCJwYXJlbnRTcGFuIiwicmVnaXN0ZXJBY2Nlc3NLZXlzIiwiYWNjb3VudCIsImtleXMiLCJzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5IiwicmV2b2tlQWNjZXNzS2V5cyIsImZpbmlzaE9wZXJhdGlvbnMiLCJvcGVyYXRpb25JZHMiLCJzaXplIiwicmVzb2x2ZXJzQ3VzdG9tIiwiUXVlcnkiLCJNdXRhdGlvbiIsImF0dGFjaEN1c3RvbVJlc29sdmVycyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOzs7O0FBRUEsU0FBU0EsUUFBVCxDQUFrQkMsSUFBbEIsRUFBc0M7QUFDbEMsU0FBTyxPQUFPQSxJQUFQLEtBQWdCLFFBQWhCLElBQTRCQSxJQUFJLEtBQUssSUFBNUM7QUFDSDs7QUFFRCxTQUFTQyxjQUFULENBQXdCQyxRQUF4QixFQUF1Q0MsU0FBdkMsRUFBdUQ7QUFDbkRDLEVBQUFBLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlRixTQUFmLEVBQTBCRyxPQUExQixDQUFrQyxDQUFDLENBQUNDLElBQUQsRUFBT0MsYUFBUCxDQUFELEtBQTJCO0FBQ3pELFFBQUtE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YixDQUNIakcsSUFBSSxDQUFDOEYsT0FBTCxJQUFnQixFQURiLEVBRUg5RixJQUFJLENBQUMrRixJQUFMLElBQWEsRUFGVixFQUdIL0YsSUFBSSxDQUFDZ0cseUJBQUwsSUFBa0MsRUFIL0IsQ0FBUDtBQUlIOztBQU1ELGVBQWVFLGdCQUFmLENBQ0lkLENBREosRUFFSXBGLElBRkosRUFHSUMsT0FISixFQUltQjtBQUNmLFFBQU1rRyxZQUFZLEdBQUcsSUFBSXRCLEdBQUosQ0FBUTdFLElBQUksQ0FBQ21HLFlBQUwsSUFBcUIsRUFBN0IsQ0FBckI7O0FBQ0EsTUFBSUEsWUFBWSxDQUFDQyxJQUFiLEtBQXNCLENBQTFCLEVBQTZCO0FBQ3pCLFdBQU8sQ0FBUDtBQUNIOztBQUNELFNBQU9uRyxPQUFPLENBQUNFLEVBQVIsQ0FBVytGLGdCQUFYLENBQTRCQyxZQUE1QixDQUFQO0FBQ0g7O0FBRUQsTUFBTUUsZUFBZSxHQUFHO0FBQ3BCQyxFQUFBQSxLQUFLLEVBQUU7QUFDSGxILElBQUFBLElBREc7QUFFSFUsSUFBQUEsZ0JBRkc7QUFHSGEsSUFBQUEsb0JBSEc7QUFJSEMsSUFBQUEsdUJBSkc7QUFLSE0sSUFBQUE7QUFMRyxHQURhO0FBUXBCcUYsRUFBQUEsUUFBUSxFQUFFO0FBQ05wQixJQUFBQSxZQURNO0FBRU5VLElBQUFBLGtCQUZNO0FBR05JLElBQUFBLGdCQUhNO0FBSU5DLElBQUFBO0FBSk07QUFSVSxDQUF4Qjs7QUFnQk8sU0FBU00scUJBQVQsQ0FBK0IzSCxRQUEvQixFQUFtRDtBQUN0REQsRUFBQUEsY0FBYyxDQUFDQyxRQUFELEVBQVd3SCxlQUFYLENBQWQ7QUFDQSxTQUFPeEgsUUFBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0IHsgS2Fma2EsIFByb2R1Y2VyIH0gZnJvbSBcImthZmthanNcIjtcbmltcG9ydCB7IFNwYW4sIEZPUk1BVF9URVhUX01BUCB9IGZyb20gJ29wZW50cmFjaW5nJztcbmltcG9ydCB0eXBlIHsgVE9OQ29udHJhY3RzIH0gZnJvbSBcInRvbi1jbGllbnQtanMvdHlwZXNcIjtcbmltcG9ydCBBcmFuZ28gZnJvbSBcIi4vYXJhbmdvXCI7XG5pbXBvcnQgeyByZXF1aXJlR3JhbnRlZEFjY2VzcyB9IGZyb20gXCIuL2FyYW5nby1jb2xsZWN0aW9uXCI7XG5pbXBvcnQgdHlwZSB7IEdyYXBoUUxSZXF1ZXN0Q29udGV4dCB9IGZyb20gXCIuL2FyYW5nby1jb2xsZWN0aW9uXCI7XG5pbXBvcnQgeyBBdXRoIH0gZnJvbSBcIi4vYXV0aFwiO1xuaW1wb3J0IHsgZW5zdXJlUHJvdG9jb2wgfSBmcm9tIFwiLi9jb25maWdcIjtcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGZldGNoIGZyb20gJ25vZGUtZmV0Y2gnO1xuaW1wb3J0IHR5cGUgeyBBY2Nlc3NLZXksIEFjY2Vzc1JpZ2h0cyB9IGZyb20gXCIuL2F1dGhcIjtcbmltcG9ydCB7IFFUcmFjZXIgfSBmcm9tIFwiLi90cmFjZXJcIjtcblxuZnVuY3Rpb24gaXNPYmplY3QodGVzdDogYW55KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHR5cGVvZiB0ZXN0ID09PSAnb2JqZWN0JyAmJiB0ZXN0ICE9PSBudWxsO1xufVxuXG5mdW5jdGlvbiBvdmVycmlkZU9iamVjdChvcmlnaW5hbDogYW55LCBvdmVycmlkZXM6IGFueSkge1xuICAgIE9iamVjdC5lbnRyaWVzKG92ZXJyaWRlcykuZm9yRWFjaCgoW25hbWUsIG92ZXJyaWRlVmFsdWVdKSA9PiB7XG4gICAgICAgIGlmICgobmFtZSBpbiBvcmlnaW5hbCkgJiYgaXNPYmplY3Qob3ZlcnJpZGVWYWx1ZSkgJiYgaXNPYmplY3Qob3JpZ2luYWxbbmFtZV0pKSB7XG4gICAgICAgICAgICBvdmVycmlkZU9iamVjdChvcmlnaW5hbFtuYW1lXSwgb3ZlcnJpZGVWYWx1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvcmlnaW5hbFtuYW1lXSA9IG92ZXJyaWRlVmFsdWU7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxudHlwZSBJbmZvID0ge1xuICAgIHZlcnNpb246IHN0cmluZyxcbn1cblxudHlwZSBSZXF1ZXN0ID0ge1xuICAgIGlkOiBzdHJpbmcsXG4gICAgYm9keTogc3RyaW5nLFxufVxuXG5leHBvcnQgdHlwZSBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCA9IEdyYXBoUUxSZXF1ZXN0Q29udGV4dCAmIHtcbiAgICBkYjogQXJhbmdvLFxufVxuXG4vLyBRdWVyeVxuXG5mdW5jdGlvbiBpbmZvKCk6IEluZm8ge1xuICAgIGNvbnN0IHBrZyA9IEpTT04ucGFyc2UoKGZzLnJlYWRGaWxlU3luYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAncGFja2FnZS5qc29uJykpOiBhbnkpKTtcbiAgICByZXR1cm4ge1xuICAgICAgICB2ZXJzaW9uOiBwa2cudmVyc2lvbixcbiAgICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBY2NvdW50c0NvdW50KF9wYXJlbnQsIGFyZ3MsIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4KTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBjb25zdCB0cmFjZXIgPSBjb250ZXh0LmRiLnRyYWNlcjtcbiAgICByZXR1cm4gUVRyYWNlci50cmFjZSh0cmFjZXIsICdnZXRBY2NvdW50c0NvdW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCByZXF1aXJlR3JhbnRlZEFjY2Vzcyhjb250ZXh0LCBhcmdzKTtcbiAgICAgICAgY29uc3QgcmVzdWx0OiBhbnkgPSBhd2FpdCBjb250ZXh0LmRiLnF1ZXJ5KGBSRVRVUk4gTEVOR1RIKGFjY291bnRzKWAsIHt9KTtcbiAgICAgICAgY29uc3QgY291bnRzID0gKHJlc3VsdDogbnVtYmVyW10pO1xuICAgICAgICByZXR1cm4gY291bnRzLmxlbmd0aCA+IDAgPyBjb3VudHNbMF0gOiAwO1xuICAgIH0sIFFUcmFjZXIuZ2V0UGFyZW50U3Bhbih0cmFjZXIsIGNvbnRleHQpKVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRUcmFuc2FjdGlvbnNDb3VudChfcGFyZW50LCBhcmdzLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgdHJhY2VyID0gY29udGV4dC5kYi50cmFjZXI7XG4gICAgcmV0dXJuIFFUcmFjZXIudHJhY2UodHJhY2VyLCAnZ2V0VHJhbnNhY3Rpb25zQ291bnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IHJlcXVpcmVHcmFudGVkQWNjZXNzKGNvbnRleHQsIGFyZ3MpO1xuICAgICAgICBjb25zdCByZXN1bHQ6IGFueSA9IGF3YWl0IGNvbnRleHQuZGIucXVlcnkoYFJFVFVSTiBMRU5HVEgodHJhbnNhY3Rpb25zKWAsIHt9KTtcbiAgICAgICAgY29uc3QgY291bnRzID0gKHJlc3VsdDogbnVtYmVyW10pO1xuICAgICAgICByZXR1cm4gY291bnRzLmxlbmd0aCA+IDAgPyBjb3VudHNbMF0gOiAwO1xuICAgIH0sIFFUcmFjZXIuZ2V0UGFyZW50U3Bhbih0cmFjZXIsIGNvbnRleHQpKVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBY2NvdW50c1RvdGFsQmFsYW5jZShfcGFyZW50LCBhcmdzLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCk6IFByb21pc2U8U3RyaW5nPiB7XG4gICAgY29uc3QgdHJhY2VyID0gY29udGV4dC5kYi50cmFjZXI7XG4gICAgcmV0dXJuIFFUcmFjZXIudHJhY2UodHJhY2VyLCAnZ2V0QWNjb3VudHNUb3RhbEJhbGFuY2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IHJlcXVpcmVHcmFudGVkQWNjZXNzKGNvbnRleHQsIGFyZ3MpO1xuICAgICAgICAvKlxuICAgICAgICBCZWNhdXNlIGFyYW5nbyBjYW4gbm90IHN1bSBCaWdJbnQncyB3ZSBuZWVkIHRvIHN1bSBzZXBhcmF0ZWx5OlxuICAgICAgICBocyA9IFNVTSBvZiBoaWdoIGJpdHMgKGZyb20gMjQtYml0IGFuZCBoaWdoZXIpXG4gICAgICAgIGxzID0gU1VNIG9mIGxvd2VyIDI0IGJpdHNcbiAgICAgICAgQW5kIHRoZSB0b3RhbCByZXN1bHQgaXMgKGhzIDw8IDI0KSArIGxzXG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCByZXN1bHQ6IGFueSA9IGF3YWl0IGNvbnRleHQuZGIucXVlcnkoYFxuICAgICAgICAgICAgTEVUIGQgPSAxNjc3NzIxNlxuICAgICAgICAgICAgRk9SIGEgaW4gYWNjb3VudHNcbiAgICAgICAgICAgIExFVCBiID0gVE9fTlVNQkVSKENPTkNBVChcIjB4XCIsIFNVQlNUUklORyhhLmJhbGFuY2UsIDIpKSlcbiAgICAgICAgICAgIENPTExFQ1QgQUdHUkVHQVRFXG4gICAgICAgICAgICAgICAgaHMgPSBTVU0oRkxPT1IoYiAvIGQpKSxcbiAgICAgICAgICAgICAgICBscyA9IFNVTShiICUgKGQgLSAxKSlcbiAgICAgICAgICAgIFJFVFVSTiB7IGhzLCBscyB9XG4gICAgICAgIGAsIHt9KTtcbiAgICAgICAgY29uc3QgcGFydHMgPSAocmVzdWx0OiB7IGhzOiBudW1iZXIsIGxzOiBudW1iZXIgfVtdKVswXTtcbiAgICAgICAgLy8kRmxvd0ZpeE1lXG4gICAgICAgIHJldHVybiAoQmlnSW50KHBhcnRzLmhzKSAqIEJpZ0ludCgweDEwMDAwMDApICsgQmlnSW50KHBhcnRzLmxzKSkudG9TdHJpbmcoKTtcbiAgICB9LCBRVHJhY2VyLmdldFBhcmVudFNwYW4odHJhY2VyLCBjb250ZXh0KSlcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0TWFuYWdlbWVudEFjY2Vzc0tleShfcGFyZW50LCBhcmdzLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIGNvbnRleHQuYXV0aC5nZXRNYW5hZ2VtZW50QWNjZXNzS2V5KCk7XG59XG5cbi8vIE11dGF0aW9uXG5cbmFzeW5jIGZ1bmN0aW9uIHBvc3RSZXF1ZXN0c1VzaW5nUmVzdChyZXF1ZXN0czogUmVxdWVzdFtdLCBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHRFeCwgX3NwYW46IFNwYW4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBjb25maWcgPSBjb250ZXh0LmNvbmZpZy5yZXF1ZXN0cztcbiAgICBjb25zdCB1cmwgPSBgJHtlbnN1cmVQcm90b2NvbChjb25maWcuc2VydmVyLCAnaHR0cCcpfS90b3BpY3MvJHtjb25maWcudG9waWN9YDtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCwge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgbW9kZTogJ2NvcnMnLFxuICAgICAgICBjYWNoZTogJ25vLWNhY2hlJyxcbiAgICAgICAgY3JlZGVudGlhbHM6ICdzYW1lLW9yaWdpbicsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgIH0sXG4gICAgICAgIHJlZGlyZWN0OiAnZm9sbG93JyxcbiAgICAgICAgcmVmZXJyZXI6ICduby1yZWZlcnJlcicsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIHJlY29yZHM6IHJlcXVlc3RzLm1hcCgocmVxdWVzdCkgPT4gKHtcbiAgICAgICAgICAgICAgICBrZXk6IHJlcXVlc3QuaWQsXG4gICAgICAgICAgICAgICAgdmFsdWU6IHJlcXVlc3QuYm9keSxcbiAgICAgICAgICAgIH0pKSxcbiAgICAgICAgfSksXG4gICAgfSk7XG4gICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgUG9zdCByZXF1ZXN0cyBmYWlsZWQ6ICR7YXdhaXQgcmVzcG9uc2UudGV4dCgpfWA7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBvc3RSZXF1ZXN0c1VzaW5nS2Fma2EocmVxdWVzdHM6IFJlcXVlc3RbXSwgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsIHNwYW46IFNwYW4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBlbnN1cmVTaGFyZWQgPSBhc3luYyAobmFtZSwgY3JlYXRlVmFsdWU6ICgpID0+IFByb21pc2U8YW55PikgPT4ge1xuICAgICAgICBpZiAoY29udGV4dC5zaGFyZWQuaGFzKG5hbWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gY29udGV4dC5zaGFyZWQuZ2V0KG5hbWUpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgY3JlYXRlVmFsdWUoKTtcbiAgICAgICAgY29udGV4dC5zaGFyZWQuc2V0KG5hbWUsIHZhbHVlKTtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH07XG5cbiAgICBjb25zdCBjb25maWcgPSBjb250ZXh0LmNvbmZpZy5yZXF1ZXN0cztcbiAgICBjb25zdCBwcm9kdWNlcjogUHJvZHVjZXIgPSBhd2FpdCBlbnN1cmVTaGFyZWQoJ3Byb2R1Y2VyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBrYWZrYTogS2Fma2EgPSBhd2FpdCBlbnN1cmVTaGFyZWQoJ2thZmthJywgYXN5bmMgKCkgPT4gbmV3IEthZmthKHtcbiAgICAgICAgICAgIGNsaWVudElkOiAncS1zZXJ2ZXInLFxuICAgICAgICAgICAgYnJva2VyczogW2NvbmZpZy5zZXJ2ZXJdXG4gICAgICAgIH0pKTtcbiAgICAgICAgY29uc3QgbmV3UHJvZHVjZXIgPSBrYWZrYS5wcm9kdWNlcigpO1xuICAgICAgICBhd2FpdCBuZXdQcm9kdWNlci5jb25uZWN0KCk7XG4gICAgICAgIHJldHVybiBuZXdQcm9kdWNlcjtcblxuICAgIH0pO1xuICAgIGNvbnN0IG1lc3NhZ2VzID0gcmVxdWVzdHMubWFwKChyZXF1ZXN0KSA9PiB7XG4gICAgICAgIGNvbnN0IHRyYWNlSW5mbyA9IHt9O1xuICAgICAgICBjb250ZXh0LmRiLnRyYWNlci5pbmplY3Qoc3BhbiwgRk9STUFUX1RFWFRfTUFQLCB0cmFjZUluZm8pO1xuICAgICAgICBjb25zdCBrZXlCdWZmZXIgPSBCdWZmZXIuZnJvbShyZXF1ZXN0LmlkLCAnYmFzZTY0Jyk7XG4gICAgICAgIGNvbnN0IHRyYWNlQnVmZmVyID0gQnVmZmVyLmZyb20oSlNPTi5zdHJpbmdpZnkodHJhY2VJbmZvKSwgJ3V0ZjgnKTtcbiAgICAgICAgY29uc3Qga2V5ID0gQnVmZmVyLmNvbmNhdChba2V5QnVmZmVyLCB0cmFjZUJ1ZmZlcl0pO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgdmFsdWU6IEJ1ZmZlci5mcm9tKHJlcXVlc3QuYm9keSwgJ2Jhc2U2NCcpLFxuICAgICAgICB9O1xuICAgIH0pO1xuICAgIGF3YWl0IHByb2R1Y2VyLnNlbmQoe1xuICAgICAgICB0b3BpYzogY29uZmlnLnRvcGljLFxuICAgICAgICBtZXNzYWdlcyxcbiAgICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tQb3N0UmVzdHJpY3Rpb25zKFxuICAgIGNvbnRyYWN0czogVE9OQ29udHJhY3RzLFxuICAgIHJlcXVlc3RzOiBSZXF1ZXN0W10sXG4gICAgYWNjZXNzUmlnaHRzOiBBY2Nlc3NSaWdodHMsXG4pIHtcbiAgICBpZiAoYWNjZXNzUmlnaHRzLnJlc3RyaWN0VG9BY2NvdW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBhY2NvdW50cyA9IG5ldyBTZXQoYWNjZXNzUmlnaHRzLnJlc3RyaWN0VG9BY2NvdW50cyk7XG4gICAgZm9yIChjb25zdCByZXF1ZXN0OiBSZXF1ZXN0IG9mIHJlcXVlc3RzKSB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBhd2FpdCBjb250cmFjdHMucGFyc2VNZXNzYWdlKHtcbiAgICAgICAgICAgIGJvY0Jhc2U2NDogcmVxdWVzdC5ib2R5LFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKCFhY2NvdW50cy5oYXMobWVzc2FnZS5kc3QpKSB7XG4gICAgICAgICAgICB0aHJvdyBBdXRoLnVuYXV0aG9yaXplZEVycm9yKCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBvc3RSZXF1ZXN0cyhcbiAgICBfLFxuICAgIGFyZ3M6IHsgcmVxdWVzdHM6IFJlcXVlc3RbXSwgYWNjZXNzS2V5Pzogc3RyaW5nIH0sXG4gICAgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsXG4pOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgcmVxdWVzdHM6ID8oUmVxdWVzdFtdKSA9IGFyZ3MucmVxdWVzdHM7XG4gICAgaWYgKCFyZXF1ZXN0cykge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgY29uc3QgdHJhY2VyID0gY29udGV4dC5kYi50cmFjZXI7XG4gICAgcmV0dXJuIFFUcmFjZXIudHJhY2UodHJhY2VyLCBcInBvc3RSZXF1ZXN0c1wiLCBhc3luYyAoc3BhbjogU3BhbikgPT4ge1xuICAgICAgICBzcGFuLnNldFRhZygncGFyYW1zJywgcmVxdWVzdHMpO1xuICAgICAgICBjb25zdCBhY2Nlc3NSaWdodHMgPSBhd2FpdCByZXF1aXJlR3JhbnRlZEFjY2Vzcyhjb250ZXh0LCBhcmdzKTtcbiAgICAgICAgYXdhaXQgY2hlY2tQb3N0UmVzdHJpY3Rpb25zKGNvbnRleHQuY2xpZW50LmNvbnRyYWN0cywgcmVxdWVzdHMsIGFjY2Vzc1JpZ2h0cyk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoY29udGV4dC5jb25maWcucmVxdWVzdHMubW9kZSA9PT0gJ3Jlc3QnKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgcG9zdFJlcXVlc3RzVXNpbmdSZXN0KHJlcXVlc3RzLCBjb250ZXh0LCBzcGFuKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgcG9zdFJlcXVlc3RzVXNpbmdLYWZrYShyZXF1ZXN0cywgY29udGV4dCwgc3Bhbik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb250ZXh0LmRiLmxvZy5kZWJ1ZygncG9zdFJlcXVlc3RzJywgJ1BPU1RFRCcsIGFyZ3MsIGNvbnRleHQucmVtb3RlQWRkcmVzcyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb250ZXh0LmRiLmxvZy5kZWJ1ZygncG9zdFJlcXVlc3RzJywgJ0ZBSUxFRCcsIGFyZ3MsIGNvbnRleHQucmVtb3RlQWRkcmVzcyk7XG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVxdWVzdHMubWFwKHggPT4geC5pZCk7XG4gICAgfSwgY29udGV4dC5wYXJlbnRTcGFuKTtcbn1cblxudHlwZSBNYW5hZ2VtZW50QXJncyA9IHtcbiAgICBhY2NvdW50Pzogc3RyaW5nLFxuICAgIHNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXk/OiBzdHJpbmcsXG59XG5cbnR5cGUgUmVnaXN0ZXJBY2Nlc3NLZXlzQXJncyA9IE1hbmFnZW1lbnRBcmdzICYge1xuICAgIGtleXM6IEFjY2Vzc0tleVtdLFxufVxuXG50eXBlIFJldm9rZUFjY2Vzc0tleXNBcmdzID0gTWFuYWdlbWVudEFyZ3MgJiB7XG4gICAga2V5czogc3RyaW5nW10sXG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlZ2lzdGVyQWNjZXNzS2V5cyhcbiAgICBfLFxuICAgIGFyZ3M6IFJlZ2lzdGVyQWNjZXNzS2V5c0FyZ3MsXG4gICAgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsXG4pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIHJldHVybiBjb250ZXh0LmF1dGgucmVnaXN0ZXJBY2Nlc3NLZXlzKFxuICAgICAgICBhcmdzLmFjY291bnQgfHwgJycsXG4gICAgICAgIGFyZ3Mua2V5cyB8fCBbXSxcbiAgICAgICAgYXJncy5zaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5IHx8ICcnKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmV2b2tlQWNjZXNzS2V5cyhcbiAgICBfLFxuICAgIGFyZ3M6IFJldm9rZUFjY2Vzc0tleXNBcmdzLFxuICAgIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dEV4LFxuKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICByZXR1cm4gY29udGV4dC5hdXRoLnJldm9rZUFjY2Vzc0tleXMoXG4gICAgICAgIGFyZ3MuYWNjb3VudCB8fCAnJyxcbiAgICAgICAgYXJncy5rZXlzIHx8IFtdLFxuICAgICAgICBhcmdzLnNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXkgfHwgJycpO1xufVxuXG50eXBlIEZpbmlzaE9wZXJhdGlvbnNBcmdzID0ge1xuICAgIG9wZXJhdGlvbklkcz86IHN0cmluZ1tdLFxufVxuXG5hc3luYyBmdW5jdGlvbiBmaW5pc2hPcGVyYXRpb25zKFxuICAgIF8sXG4gICAgYXJnczogRmluaXNoT3BlcmF0aW9uc0FyZ3MsXG4gICAgY29udGV4dDogR3JhcGhRTFJlcXVlc3RDb250ZXh0RXgsXG4pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IG9wZXJhdGlvbklkcyA9IG5ldyBTZXQoYXJncy5vcGVyYXRpb25JZHMgfHwgW10pO1xuICAgIGlmIChvcGVyYXRpb25JZHMuc2l6ZSA9PT0gMCkge1xuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnRleHQuZGIuZmluaXNoT3BlcmF0aW9ucyhvcGVyYXRpb25JZHMpO1xufVxuXG5jb25zdCByZXNvbHZlcnNDdXN0b20gPSB7XG4gICAgUXVlcnk6IHtcbiAgICAgICAgaW5mbyxcbiAgICAgICAgZ2V0QWNjb3VudHNDb3VudCxcbiAgICAgICAgZ2V0VHJhbnNhY3Rpb25zQ291bnQsXG4gICAgICAgIGdldEFjY291bnRzVG90YWxCYWxhbmNlLFxuICAgICAgICBnZXRNYW5hZ2VtZW50QWNjZXNzS2V5LFxuICAgIH0sXG4gICAgTXV0YXRpb246IHtcbiAgICAgICAgcG9zdFJlcXVlc3RzLFxuICAgICAgICByZWdpc3RlckFjY2Vzc0tleXMsXG4gICAgICAgIHJldm9rZUFjY2Vzc0tleXMsXG4gICAgICAgIGZpbmlzaE9wZXJhdGlvbnMsXG4gICAgfSxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBhdHRhY2hDdXN0b21SZXNvbHZlcnMob3JpZ2luYWw6IGFueSk6IGFueSB7XG4gICAgb3ZlcnJpZGVPYmplY3Qob3JpZ2luYWwsIHJlc29sdmVyc0N1c3RvbSk7XG4gICAgcmV0dXJuIG9yaWdpbmFsO1xufVxuIl19