"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.packageJson = packageJson;
exports.cleanError = cleanError;
exports.wrap = wrap;
exports.toLog = toLog;
exports.hash = hash;
exports.RegistryMap = exports.QError = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _crypto = require("crypto");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function packageJson() {
  let testPath = _path.default.resolve(__dirname);

  const packagePath = () => _path.default.resolve(testPath, 'package.json');

  while (testPath && !_fs.default.existsSync(packagePath())) {
    testPath = _path.default.dirname(testPath);
  }

  return JSON.parse(_fs.default.readFileSync(packagePath(), 'utf8'));
}

function cleanError(error) {
  if ('ArangoError' in error) {
    return error.ArangoError;
  }

  delete error.request;
  delete error.response;
  return error;
}

const QErrorCode = {
  MESSAGE_EXPIRED: 10001,
  MULTIPLE_ACCESS_KEYS: 10002,
  UNAUTHORIZED: 10003,
  AUTH_SERVICE_UNAVAILABLE: 10004,
  AUTH_FAILED: 10005,
  QUERY_TERMINATED_ON_TIMEOUT: 10006
};

class QError {
  static messageExpired(id, expiredAt) {
    return QError.create(QErrorCode.MESSAGE_EXPIRED, `Message expired`, {
      id,
      expiredAt,
      now: Date.now()
    });
  }

  static queryTerminatedOnTimeout() {
    return QError.create(QErrorCode.QUERY_TERMINATED_ON_TIMEOUT, `Query terminated on timeout`, {
      now: Date.now()
    });
  }

  static create(code, message, data) {
    const error = new Error(message);
    error.source = 'graphql';
    error.code = code;

    if (data !== undefined) {
      error.data = data;
    }

    return error;
  }

  static multipleAccessKeys() {
    return QError.create(QErrorCode.MULTIPLE_ACCESS_KEYS, 'Request must use the same access key for all queries and mutations');
  }

  static unauthorized() {
    return QError.create(QErrorCode.UNAUTHORIZED, 'Unauthorized');
  }

  static authServiceUnavailable() {
    return QError.create(QErrorCode.AUTH_SERVICE_UNAVAILABLE, 'Auth service unavailable');
  }

  static auth(error) {
    return QError.create(QErrorCode.AUTH_FAILED, error.message || error.description, {
      authErrorCode: error.code
    });
  }

}

exports.QError = QError;

function isInternalServerError(error) {
  if ('type' in error && error.type === 'system') {
    return true;
  }

  if ('errno' in error && 'syscall' in error) {
    return true;
  }
}

async function wrap(log, op, args, fetch) {
  try {
    return await fetch();
  } catch (err) {
    let cleaned = cleanError(err);
    log.error('FAILED', op, args, cleaned);

    if (isInternalServerError(cleaned)) {
      cleaned = QError.create(500, 'Service temporary unavailable');
    }

    throw cleaned;
  }
}

class RegistryMap {
  constructor(name) {
    this.name = name;
    this.lastId = 0;
    this.items = new Map();
  }

  add(item) {
    let id = this.lastId;

    do {
      id = id < Number.MAX_SAFE_INTEGER ? id + 1 : 1;
    } while (this.items.has(id));

    this.lastId = id;
    this.items.set(id, item);
    return id;
  }

  remove(id) {
    if (!this.items.delete(id)) {
      console.error(`Failed to remove ${this.name}: item with id [${id}] does not exists`);
    }
  }

  entries() {
    return [...this.items.entries()];
  }

  values() {
    return [...this.items.values()];
  }

}

exports.RegistryMap = RegistryMap;

function toLog(value, objs) {
  const typeOf = typeof value;

  switch (typeOf) {
    case "undefined":
    case "boolean":
    case "number":
    case "bigint":
    case "symbol":
      return value;

    case "string":
      if (value.length > 80) {
        return `${value.substr(0, 50)}â€¦ [${value.length}]`;
      }

      return value;

    case "function":
      return undefined;

    default:
      if (value === null) {
        return value;
      }

      if (objs && objs.includes(value)) {
        return undefined;
      }

      const newObjs = objs ? [...objs, value] : [value];

      if (Array.isArray(value)) {
        return value.map(x => toLog(x, newObjs));
      }

      const valueToLog = {};
      Object.entries(value).forEach(([n, v]) => {
        const propertyValueToLog = toLog(v, newObjs);

        if (propertyValueToLog !== undefined) {
          valueToLog[n] = propertyValueToLog;
        }
      });
      return valueToLog;
  }
}

function hash(...keys) {
  return (0, _crypto.createHash)('md5').update(keys.join('')).digest("hex");
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvdXRpbHMuanMiXSwibmFtZXMiOlsicGFja2FnZUpzb24iLCJ0ZXN0UGF0aCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwicGFja2FnZVBhdGgiLCJmcyIsImV4aXN0c1N5bmMiLCJkaXJuYW1lIiwiSlNPTiIsInBhcnNlIiwicmVhZEZpbGVTeW5jIiwiY2xlYW5FcnJvciIsImVycm9yIiwiQXJhbmdvRXJyb3IiLCJyZXF1ZXN0IiwicmVzcG9uc2UiLCJRRXJyb3JDb2RlIiwiTUVTU0FHRV9FWFBJUkVEIiwiTVVMVElQTEVfQUNDRVNTX0tFWVMiLCJVTkFVVEhPUklaRUQiLCJBVVRIX1NFUlZJQ0VfVU5BVkFJTEFCTEUiLCJBVVRIX0ZBSUxFRCIsIlFVRVJZX1RFUk1JTkFURURfT05fVElNRU9VVCIsIlFFcnJvciIsIm1lc3NhZ2VFeHBpcmVkIiwiaWQiLCJleHBpcmVkQXQiLCJjcmVhdGUiLCJub3ciLCJEYXRlIiwicXVlcnlUZXJtaW5hdGVkT25UaW1lb3V0IiwiY29kZSIsIm1lc3NhZ2UiLCJkYXRhIiwiRXJyb3IiLCJzb3VyY2UiLCJ1bmRlZmluZWQiLCJtdWx0aXBsZUFjY2Vzc0tleXMiLCJ1bmF1dGhvcml6ZWQiLCJhdXRoU2VydmljZVVuYXZhaWxhYmxlIiwiYXV0aCIsImRlc2NyaXB0aW9uIiwiYXV0aEVycm9yQ29kZSIsImlzSW50ZXJuYWxTZXJ2ZXJFcnJvciIsInR5cGUiLCJ3cmFwIiwibG9nIiwib3AiLCJhcmdzIiwiZmV0Y2giLCJlcnIiLCJjbGVhbmVkIiwiUmVnaXN0cnlNYXAiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJsYXN0SWQiLCJpdGVtcyIsIk1hcCIsImFkZCIsIml0ZW0iLCJOdW1iZXIiLCJNQVhfU0FGRV9JTlRFR0VSIiwiaGFzIiwic2V0IiwicmVtb3ZlIiwiZGVsZXRlIiwiY29uc29sZSIsImVudHJpZXMiLCJ2YWx1ZXMiLCJ0b0xvZyIsInZhbHVlIiwib2JqcyIsInR5cGVPZiIsImxlbmd0aCIsInN1YnN0ciIsImluY2x1ZGVzIiwibmV3T2JqcyIsIkFycmF5IiwiaXNBcnJheSIsIm1hcCIsIngiLCJ2YWx1ZVRvTG9nIiwiT2JqZWN0IiwiZm9yRWFjaCIsIm4iLCJ2IiwicHJvcGVydHlWYWx1ZVRvTG9nIiwiaGFzaCIsImtleXMiLCJ1cGRhdGUiLCJqb2luIiwiZGlnZXN0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVPLFNBQVNBLFdBQVQsR0FBNEI7QUFDL0IsTUFBSUMsUUFBUSxHQUFHQyxjQUFLQyxPQUFMLENBQWFDLFNBQWIsQ0FBZjs7QUFDQSxRQUFNQyxXQUFXLEdBQUcsTUFBTUgsY0FBS0MsT0FBTCxDQUFhRixRQUFiLEVBQXVCLGNBQXZCLENBQTFCOztBQUNBLFNBQU9BLFFBQVEsSUFBSSxDQUFDSyxZQUFHQyxVQUFILENBQWNGLFdBQVcsRUFBekIsQ0FBcEIsRUFBa0Q7QUFDOUNKLElBQUFBLFFBQVEsR0FBR0MsY0FBS00sT0FBTCxDQUFhUCxRQUFiLENBQVg7QUFDSDs7QUFDRCxTQUFPUSxJQUFJLENBQUNDLEtBQUwsQ0FBV0osWUFBR0ssWUFBSCxDQUFnQk4sV0FBVyxFQUEzQixFQUErQixNQUEvQixDQUFYLENBQVA7QUFDSDs7QUFFTSxTQUFTTyxVQUFULENBQW9CQyxLQUFwQixFQUFxQztBQUN4QyxNQUFJLGlCQUFpQkEsS0FBckIsRUFBNEI7QUFDeEIsV0FBT0EsS0FBSyxDQUFDQyxXQUFiO0FBQ0g7O0FBQ0QsU0FBT0QsS0FBSyxDQUFDRSxPQUFiO0FBQ0EsU0FBT0YsS0FBSyxDQUFDRyxRQUFiO0FBQ0EsU0FBT0gsS0FBUDtBQUNIOztBQUVELE1BQU1JLFVBQVUsR0FBRztBQUNmQyxFQUFBQSxlQUFlLEVBQUUsS0FERjtBQUVmQyxFQUFBQSxvQkFBb0IsRUFBRSxLQUZQO0FBR2ZDLEVBQUFBLFlBQVksRUFBRSxLQUhDO0FBSWZDLEVBQUFBLHdCQUF3QixFQUFFLEtBSlg7QUFLZkMsRUFBQUEsV0FBVyxFQUFFLEtBTEU7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LEtBQUssQ0FBQ2dCLENBQUQsRUFBSVQsT0FBSixDQUFoQzs7QUFDQSxZQUFJVSxrQkFBa0IsS0FBS2xELFNBQTNCLEVBQXNDO0FBQ2xDNkMsVUFBQUEsVUFBVSxDQUFDRyxDQUFELENBQVYsR0FBZ0JFLGtCQUFoQjtBQUNIO0FBQ0osT0FMRDtBQU1BLGFBQU9MLFVBQVA7QUFoQ0o7QUFrQ0g7O0FBRU0sU0FBU00sSUFBVCxDQUFjLEdBQUdDLElBQWpCLEVBQXlDO0FBQzVDLFNBQU8sd0JBQVcsS0FBWCxFQUFrQkMsTUFBbEIsQ0FBeUJELElBQUksQ0FBQ0UsSUFBTCxDQUFVLEVBQVYsQ0FBekIsRUFBd0NDLE1BQXhDLENBQStDLEtBQS9DLENBQVA7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgUUxvZyB9IGZyb20gJy4vbG9ncyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBjcmVhdGVIYXNoIH0gZnJvbSAnY3J5cHRvJ1xuXG5leHBvcnQgZnVuY3Rpb24gcGFja2FnZUpzb24oKTogYW55IHtcbiAgICBsZXQgdGVzdFBhdGggPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lKTtcbiAgICBjb25zdCBwYWNrYWdlUGF0aCA9ICgpID0+IHBhdGgucmVzb2x2ZSh0ZXN0UGF0aCwgJ3BhY2thZ2UuanNvbicpO1xuICAgIHdoaWxlICh0ZXN0UGF0aCAmJiAhZnMuZXhpc3RzU3luYyhwYWNrYWdlUGF0aCgpKSkge1xuICAgICAgICB0ZXN0UGF0aCA9IHBhdGguZGlybmFtZSh0ZXN0UGF0aCk7XG4gICAgfVxuICAgIHJldHVybiBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhwYWNrYWdlUGF0aCgpLCAndXRmOCcpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsZWFuRXJyb3IoZXJyb3I6IGFueSk6IGFueSB7XG4gICAgaWYgKCdBcmFuZ29FcnJvcicgaW4gZXJyb3IpIHtcbiAgICAgICAgcmV0dXJuIGVycm9yLkFyYW5nb0Vycm9yO1xuICAgIH1cbiAgICBkZWxldGUgZXJyb3IucmVxdWVzdDtcbiAgICBkZWxldGUgZXJyb3IucmVzcG9uc2U7XG4gICAgcmV0dXJuIGVycm9yO1xufVxuXG5jb25zdCBRRXJyb3JDb2RlID0ge1xuICAgIE1FU1NBR0VfRVhQSVJFRDogMTAwMDEsXG4gICAgTVVMVElQTEVfQUNDRVNTX0tFWVM6IDEwMDAyLFxuICAgIFVOQVVUSE9SSVpFRDogMTAwMDMsXG4gICAgQVVUSF9TRVJWSUNFX1VOQVZBSUxBQkxFOiAxMDAwNCxcbiAgICBBVVRIX0ZBSUxFRDogMTAwMDUsXG4gICAgUVVFUllfVEVSTUlOQVRFRF9PTl9USU1FT1VUOiAxMDAwNixcbn07XG5cbmV4cG9ydCBjbGFzcyBRRXJyb3Ige1xuICAgIHN0YXRpYyBtZXNzYWdlRXhwaXJlZChpZDogc3RyaW5nLCBleHBpcmVkQXQ6IG51bWJlcik6IEVycm9yIHtcbiAgICAgICAgcmV0dXJuIFFFcnJvci5jcmVhdGUoUUVycm9yQ29kZS5NRVNTQUdFX0VYUElSRUQsIGBNZXNzYWdlIGV4cGlyZWRgLCB7XG4gICAgICAgICAgICBpZCxcbiAgICAgICAgICAgIGV4cGlyZWRBdCxcbiAgICAgICAgICAgIG5vdzogRGF0ZS5ub3coKSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3RhdGljIHF1ZXJ5VGVybWluYXRlZE9uVGltZW91dCgpOiBFcnJvciB7XG4gICAgICAgIHJldHVybiBRRXJyb3IuY3JlYXRlKFFFcnJvckNvZGUuUVVFUllfVEVSTUlOQVRFRF9PTl9USU1FT1VULCBgUXVlcnkgdGVybWluYXRlZCBvbiB0aW1lb3V0YCwge1xuICAgICAgICAgICAgbm93OiBEYXRlLm5vdygpLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgY3JlYXRlKGNvZGU6IG51bWJlciwgbWVzc2FnZTogc3RyaW5nLCBkYXRhPzogYW55KTogRXJyb3Ige1xuICAgICAgICBjb25zdCBlcnJvcjogYW55ID0gbmV3IEVycm9yKG1lc3NhZ2UpO1xuICAgICAgICBlcnJvci5zb3VyY2UgPSAnZ3JhcGhxbCc7XG4gICAgICAgIGVycm9yLmNvZGUgPSBjb2RlO1xuICAgICAgICBpZiAoZGF0YSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBlcnJvci5kYXRhID0gZGF0YTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZXJyb3I7XG4gICAgfVxuXG4gICAgc3RhdGljIG11bHRpcGxlQWNjZXNzS2V5cygpIHtcbiAgICAgICAgcmV0dXJuIFFFcnJvci5jcmVhdGUoXG4gICAgICAgICAgICBRRXJyb3JDb2RlLk1VTFRJUExFX0FDQ0VTU19LRVlTLFxuICAgICAgICAgICAgJ1JlcXVlc3QgbXVzdCB1c2UgdGhlIHNhbWUgYWNjZXNzIGtleSBmb3IgYWxsIHF1ZXJpZXMgYW5kIG11dGF0aW9ucycsXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgc3RhdGljIHVuYXV0aG9yaXplZCgpIHtcbiAgICAgICAgcmV0dXJuIFFFcnJvci5jcmVhdGUoUUVycm9yQ29kZS5VTkFVVEhPUklaRUQsICdVbmF1dGhvcml6ZWQnKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXV0aFNlcnZpY2VVbmF2YWlsYWJsZSgpIHtcbiAgICAgICAgcmV0dXJuIFFFcnJvci5jcmVhdGUoUUVycm9yQ29kZS5BVVRIX1NFUlZJQ0VfVU5BVkFJTEFCTEUsICdBdXRoIHNlcnZpY2UgdW5hdmFpbGFibGUnKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXV0aChlcnJvcikge1xuICAgICAgICByZXR1cm4gUUVycm9yLmNyZWF0ZShRRXJyb3JDb2RlLkFVVEhfRkFJTEVELFxuICAgICAgICAgICAgZXJyb3IubWVzc2FnZSB8fCBlcnJvci5kZXNjcmlwdGlvbixcbiAgICAgICAgICAgIHsgYXV0aEVycm9yQ29kZTogZXJyb3IuY29kZSB9LFxuICAgICAgICApXG4gICAgfVxufVxuXG5mdW5jdGlvbiBpc0ludGVybmFsU2VydmVyRXJyb3IoZXJyb3I6IEVycm9yKTogYm9vbGVhbiB7XG4gICAgaWYgKCd0eXBlJyBpbiBlcnJvciAmJiBlcnJvci50eXBlID09PSAnc3lzdGVtJykge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKCdlcnJubycgaW4gZXJyb3IgJiYgJ3N5c2NhbGwnIGluIGVycm9yKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHdyYXA8Uj4obG9nOiBRTG9nLCBvcDogc3RyaW5nLCBhcmdzOiBhbnksIGZldGNoOiAoKSA9PiBQcm9taXNlPFI+KSB7XG4gICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IGZldGNoKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxldCBjbGVhbmVkID0gY2xlYW5FcnJvcihlcnIpO1xuICAgICAgICBsb2cuZXJyb3IoJ0ZBSUxFRCcsIG9wLCBhcmdzLCBjbGVhbmVkKTtcbiAgICAgICAgaWYgKGlzSW50ZXJuYWxTZXJ2ZXJFcnJvcihjbGVhbmVkKSkge1xuICAgICAgICAgICAgY2xlYW5lZCA9IFFFcnJvci5jcmVhdGUoNTAwLCAnU2VydmljZSB0ZW1wb3JhcnkgdW5hdmFpbGFibGUnKTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBjbGVhbmVkO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFJlZ2lzdHJ5TWFwPFQ+IHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgaXRlbXM6IE1hcDxudW1iZXIsIFQ+O1xuICAgIGxhc3RJZDogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3IobmFtZTogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHRoaXMubGFzdElkID0gMDtcbiAgICAgICAgdGhpcy5pdGVtcyA9IG5ldyBNYXAoKTtcbiAgICB9XG5cbiAgICBhZGQoaXRlbTogVCk6IG51bWJlciB7XG4gICAgICAgIGxldCBpZCA9IHRoaXMubGFzdElkO1xuICAgICAgICBkbyB7XG4gICAgICAgICAgICBpZCA9IGlkIDwgTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIgPyBpZCArIDEgOiAxO1xuICAgICAgICB9IHdoaWxlICh0aGlzLml0ZW1zLmhhcyhpZCkpO1xuICAgICAgICB0aGlzLmxhc3RJZCA9IGlkO1xuICAgICAgICB0aGlzLml0ZW1zLnNldChpZCwgaXRlbSk7XG4gICAgICAgIHJldHVybiBpZDtcbiAgICB9XG5cbiAgICByZW1vdmUoaWQ6IG51bWJlcikge1xuICAgICAgICBpZiAoIXRoaXMuaXRlbXMuZGVsZXRlKGlkKSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIHJlbW92ZSAke3RoaXMubmFtZX06IGl0ZW0gd2l0aCBpZCBbJHtpZH1dIGRvZXMgbm90IGV4aXN0c2ApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZW50cmllcygpOiBbbnVtYmVyLCBUXVtdIHtcbiAgICAgICAgcmV0dXJuIFsuLi50aGlzLml0ZW1zLmVudHJpZXMoKV07XG4gICAgfVxuXG4gICAgdmFsdWVzKCk6IFRbXSB7XG4gICAgICAgIHJldHVybiBbLi4udGhpcy5pdGVtcy52YWx1ZXMoKV07XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdG9Mb2codmFsdWU6IGFueSwgb2Jqcz86IE9iamVjdFtdKTogYW55IHtcbiAgICBjb25zdCB0eXBlT2YgPSB0eXBlb2YgdmFsdWU7XG4gICAgc3dpdGNoICh0eXBlT2YpIHtcbiAgICBjYXNlIFwidW5kZWZpbmVkXCI6XG4gICAgY2FzZSBcImJvb2xlYW5cIjpcbiAgICBjYXNlIFwibnVtYmVyXCI6XG4gICAgY2FzZSBcImJpZ2ludFwiOlxuICAgIGNhc2UgXCJzeW1ib2xcIjpcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIGNhc2UgXCJzdHJpbmdcIjpcbiAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCA+IDgwKSB7XG4gICAgICAgICAgICByZXR1cm4gYCR7dmFsdWUuc3Vic3RyKDAsIDUwKX3igKYgWyR7dmFsdWUubGVuZ3RofV1gXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIGNhc2UgXCJmdW5jdGlvblwiOlxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIGRlZmF1bHQ6XG4gICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChvYmpzICYmIG9ianMuaW5jbHVkZXModmFsdWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG5ld09ianMgPSBvYmpzID8gWy4uLm9ianMsIHZhbHVlXSA6IFt2YWx1ZV07XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlLm1hcCh4ID0+IHRvTG9nKHgsIG5ld09ianMpKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB2YWx1ZVRvTG9nOiB7IFtzdHJpbmddOiBhbnkgfSA9IHt9O1xuICAgICAgICBPYmplY3QuZW50cmllcyh2YWx1ZSkuZm9yRWFjaCgoW24sIHZdKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwcm9wZXJ0eVZhbHVlVG9Mb2cgPSB0b0xvZyh2LCBuZXdPYmpzKTtcbiAgICAgICAgICAgIGlmIChwcm9wZXJ0eVZhbHVlVG9Mb2cgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHZhbHVlVG9Mb2dbbl0gPSBwcm9wZXJ0eVZhbHVlVG9Mb2c7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdmFsdWVUb0xvZ1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhc2goLi4ua2V5czogc3RyaW5nW10pOiBzdHJpbmcge1xuICAgIHJldHVybiBjcmVhdGVIYXNoKCdtZDUnKS51cGRhdGUoa2V5cy5qb2luKCcnKSkuZGlnZXN0KFwiaGV4XCIpO1xufVxuIl19