"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.cleanError = cleanError;
exports.wrap = wrap;
exports.parseSelectionSet = parseSelectionSet;
exports.selectionToString = selectionToString;
exports.selectFields = selectFields;
exports.RegistryMap = void 0;

function cleanError(err) {
  delete err.response;
  return err.ArangoError || err;
}

async function wrap(log, op, args, fetch) {
  try {
    return await fetch();
  } catch (err) {
    const cleaned = cleanError(err);
    log.error('FAILED', op, args, cleaned.message || err.toString());
    throw cleaned;
  }
}

class RegistryMap {
  constructor(name) {
    this.name = name;
    this.lastId = 0;
    this.items = new Map();
  }

  add(item) {
    let id = this.lastId;

    do {
      id = id < Number.MAX_SAFE_INTEGER ? id + 1 : 1;
    } while (this.items.has(id));

    this.lastId = id;
    this.items.set(id, item);
    return id;
  }

  remove(id) {
    if (!this.items.delete(id)) {
      console.error(`Failed to remove ${this.name}: item with id [${id}] does not exists`);
    }
  }

  entries() {
    return [...this.items.entries()];
  }

  values() {
    return [...this.items.values()];
  }

}

exports.RegistryMap = RegistryMap;

function parseSelectionSet(selectionSet, returnFieldSelection) {
  const fields = [];
  const selections = selectionSet && selectionSet.selections;

  if (selections) {
    for (const item of selections) {
      const name = item.name && item.name.value || '';

      if (name) {
        const field = {
          name,
          selection: parseSelectionSet(item.selectionSet, '')
        };

        if (returnFieldSelection !== '' && field.name === returnFieldSelection) {
          return field.selection;
        }

        fields.push(field);
      }
    }
  }

  return fields;
}

function selectionToString(selection) {
  return selection.filter(x => x.name !== '__typename').map(field => {
    const fieldSelection = selectionToString(field.selection);
    return `${field.name}${fieldSelection !== '' ? ` { ${fieldSelection} }` : ''}`;
  }).join(' ');
}

function selectFields(doc, selection) {
  if (selection.length === 0) {
    return doc;
  }

  const selected = {};

  if (doc._key) {
    selected._key = doc._key;
    selected.id = doc._key;
  }

  for (const item of selection) {
    const onField = {
      in_message: 'in_msg',
      out_messages: 'out_msg',
      signatures: 'id'
    }[item.name];

    if (onField !== undefined && doc[onField] !== undefined) {
      selected[onField] = doc[onField];
    }

    const value = doc[item.name];

    if (value !== undefined) {
      selected[item.name] = item.selection.length > 0 ? selectFields(value, item.selection) : value;
    }
  }

  return selected;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci91dGlscy5qcyJdLCJuYW1lcyI6WyJjbGVhbkVycm9yIiwiZXJyIiwicmVzcG9uc2UiLCJBcmFuZ29FcnJvciIsIndyYXAiLCJsb2ciLCJvcCIsImFyZ3MiLCJmZXRjaCIsImNsZWFuZWQiLCJlcnJvciIsIm1lc3NhZ2UiLCJ0b1N0cmluZyIsIlJlZ2lzdHJ5TWFwIiwiY29uc3RydWN0b3IiLCJuYW1lIiwibGFzdElkIiwiaXRlbXMiLCJNYXAiLCJhZGQiLCJpdGVtIiwiaWQiLCJOdW1iZXIiLCJNQVhfU0FGRV9JTlRFR0VSIiwiaGFzIiwic2V0IiwicmVtb3ZlIiwiZGVsZXRlIiwiY29uc29sZSIsImVudHJpZXMiLCJ2YWx1ZXMiLCJwYXJzZVNlbGVjdGlvblNldCIsInNlbGVjdGlvblNldCIsInJldHVybkZpZWxkU2VsZWN0aW9uIiwiZmllbGRzIiwic2VsZWN0aW9ucyIsInZhbHVlIiwiZmllbGQiLCJzZWxlY3Rpb24iLCJwdXNoIiwic2VsZWN0aW9uVG9TdHJpbmciLCJmaWx0ZXIiLCJ4IiwibWFwIiwiZmllbGRTZWxlY3Rpb24iLCJqb2luIiwic2VsZWN0RmllbGRzIiwiZG9jIiwibGVuZ3RoIiwic2VsZWN0ZWQiLCJfa2V5Iiwib25GaWVsZCIsImluX21lc3NhZ2UiLCJvdXRfbWVzc2FnZXMiLCJzaWduYXR1cmVzIiwidW5kZWZpbmVkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFFTyxTQUFTQSxVQUFULENBQW9CQyxHQUFwQixFQUFtQztBQUN0QyxTQUFPQSxHQUFHLENBQUNDLFFBQVg7QUFDQSxTQUFPRCxHQUFHLENBQUNFLFdBQUosSUFBbUJGLEdBQTFCO0FBQ0g7O0FBRU0sZUFBZUcsSUFBZixDQUF1QkMsR0FBdkIsRUFBa0NDLEVBQWxDLEVBQThDQyxJQUE5QyxFQUF5REMsS0FBekQsRUFBa0Y7QUFDckYsTUFBSTtBQUNBLFdBQU8sTUFBTUEsS0FBSyxFQUFsQjtBQUNILEdBRkQsQ0FFRSxPQUFPUCxHQUFQLEVB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R0FBc0JLLElBQUksQ0FBQ2tCLFNBQUwsQ0FBZVUsTUFBZixHQUF3QixDQUF4QixHQUNoQkYsWUFBWSxDQUFDVixLQUFELEVBQVFoQixJQUFJLENBQUNrQixTQUFiLENBREksR0FFaEJGLEtBRk47QUFHSDtBQUNKOztBQUNELFNBQU9hLFFBQVA7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgUUxvZyB9IGZyb20gJy4vbG9ncyc7XG5cbmV4cG9ydCBmdW5jdGlvbiBjbGVhbkVycm9yKGVycjogYW55KTogYW55IHtcbiAgICBkZWxldGUgZXJyLnJlc3BvbnNlO1xuICAgIHJldHVybiBlcnIuQXJhbmdvRXJyb3IgfHwgZXJyO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd3JhcDxSPihsb2c6IFFMb2csIG9wOiBzdHJpbmcsIGFyZ3M6IGFueSwgZmV0Y2g6ICgpID0+IFByb21pc2U8Uj4pIHtcbiAgICB0cnkge1xuICAgICAgICByZXR1cm4gYXdhaXQgZmV0Y2goKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgY29uc3QgY2xlYW5lZCA9IGNsZWFuRXJyb3IoZXJyKTtcbiAgICAgICAgbG9nLmVycm9yKCdGQUlMRUQnLCBvcCwgYXJncywgY2xlYW5lZC5tZXNzYWdlIHx8IGVyci50b1N0cmluZygpKTtcbiAgICAgICAgdGhyb3cgY2xlYW5lZDtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSZWdpc3RyeU1hcDxUPiB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGl0ZW1zOiBNYXA8bnVtYmVyLCBUPjtcbiAgICBsYXN0SWQ6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKG5hbWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICB0aGlzLmxhc3RJZCA9IDA7XG4gICAgICAgIHRoaXMuaXRlbXMgPSBuZXcgTWFwKCk7XG4gICAgfVxuXG4gICAgYWRkKGl0ZW06IFQpOiBudW1iZXIge1xuICAgICAgICBsZXQgaWQgPSB0aGlzLmxhc3RJZDtcbiAgICAgICAgZG8ge1xuICAgICAgICAgICAgaWQgPSBpZCA8IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSID8gaWQgKyAxIDogMTtcbiAgICAgICAgfSB3aGlsZSAodGhpcy5pdGVtcy5oYXMoaWQpKTtcbiAgICAgICAgdGhpcy5sYXN0SWQgPSBpZDtcbiAgICAgICAgdGhpcy5pdGVtcy5zZXQoaWQsIGl0ZW0pO1xuICAgICAgICByZXR1cm4gaWQ7XG4gICAgfVxuXG4gICAgcmVtb3ZlKGlkOiBudW1iZXIpIHtcbiAgICAgICAgaWYgKCF0aGlzLml0ZW1zLmRlbGV0ZShpZCkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byByZW1vdmUgJHt0aGlzLm5hbWV9OiBpdGVtIHdpdGggaWQgWyR7aWR9XSBkb2VzIG5vdCBleGlzdHNgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGVudHJpZXMoKTogW251bWJlciwgVF1bXSB7XG4gICAgICAgIHJldHVybiBbLi4udGhpcy5pdGVtcy5lbnRyaWVzKCldO1xuICAgIH1cblxuICAgIHZhbHVlcygpOiBUW10ge1xuICAgICAgICByZXR1cm4gWy4uLnRoaXMuaXRlbXMudmFsdWVzKCldO1xuICAgIH1cbn1cblxuZXhwb3J0IHR5cGUgRmllbGRTZWxlY3Rpb24gPSB7XG4gICAgbmFtZTogc3RyaW5nLFxuICAgIHNlbGVjdGlvbjogRmllbGRTZWxlY3Rpb25bXSxcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlU2VsZWN0aW9uU2V0KHNlbGVjdGlvblNldDogYW55LCByZXR1cm5GaWVsZFNlbGVjdGlvbjogc3RyaW5nKTogRmllbGRTZWxlY3Rpb25bXSB7XG4gICAgY29uc3QgZmllbGRzOiBGaWVsZFNlbGVjdGlvbltdID0gW107XG4gICAgY29uc3Qgc2VsZWN0aW9ucyA9IHNlbGVjdGlvblNldCAmJiBzZWxlY3Rpb25TZXQuc2VsZWN0aW9ucztcbiAgICBpZiAoc2VsZWN0aW9ucykge1xuICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2Ygc2VsZWN0aW9ucykge1xuICAgICAgICAgICAgY29uc3QgbmFtZSA9IChpdGVtLm5hbWUgJiYgaXRlbS5uYW1lLnZhbHVlKSB8fCAnJztcbiAgICAgICAgICAgIGlmIChuYW1lKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZmllbGQ6IEZpZWxkU2VsZWN0aW9uID0ge1xuICAgICAgICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb246IHBhcnNlU2VsZWN0aW9uU2V0KGl0ZW0uc2VsZWN0aW9uU2V0LCAnJyksXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBpZiAocmV0dXJuRmllbGRTZWxlY3Rpb24gIT09ICcnICYmIGZpZWxkLm5hbWUgPT09IHJldHVybkZpZWxkU2VsZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWVsZC5zZWxlY3Rpb247XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZpZWxkcy5wdXNoKGZpZWxkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmllbGRzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2VsZWN0aW9uVG9TdHJpbmcoc2VsZWN0aW9uOiBGaWVsZFNlbGVjdGlvbltdKTogc3RyaW5nIHtcbiAgICByZXR1cm4gc2VsZWN0aW9uXG4gICAgICAgIC5maWx0ZXIoeCA9PiB4Lm5hbWUgIT09ICdfX3R5cGVuYW1lJylcbiAgICAgICAgLm1hcCgoZmllbGQ6IEZpZWxkU2VsZWN0aW9uKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBmaWVsZFNlbGVjdGlvbiA9IHNlbGVjdGlvblRvU3RyaW5nKGZpZWxkLnNlbGVjdGlvbik7XG4gICAgICAgICAgICByZXR1cm4gYCR7ZmllbGQubmFtZX0ke2ZpZWxkU2VsZWN0aW9uICE9PSAnJyA/IGAgeyAke2ZpZWxkU2VsZWN0aW9ufSB9YCA6ICcnfWA7XG4gICAgICAgIH0pLmpvaW4oJyAnKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlbGVjdEZpZWxkcyhkb2M6IGFueSwgc2VsZWN0aW9uOiBGaWVsZFNlbGVjdGlvbltdKTogYW55IHtcbiAgICBpZiAoc2VsZWN0aW9uLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gZG9jO1xuICAgIH1cbiAgICBjb25zdCBzZWxlY3RlZDogYW55ID0ge307XG4gICAgaWYgKGRvYy5fa2V5KSB7XG4gICAgICAgIHNlbGVjdGVkLl9rZXkgPSBkb2MuX2tleTtcbiAgICAgICAgc2VsZWN0ZWQuaWQgPSBkb2MuX2tleTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIHNlbGVjdGlvbikge1xuICAgICAgICBjb25zdCBvbkZpZWxkID0ge1xuICAgICAgICAgICAgaW5fbWVzc2FnZTogJ2luX21zZycsXG4gICAgICAgICAgICBvdXRfbWVzc2FnZXM6ICdvdXRfbXNnJyxcbiAgICAgICAgICAgIHNpZ25hdHVyZXM6ICdpZCcsXG4gICAgICAgIH1baXRlbS5uYW1lXTtcbiAgICAgICAgaWYgKG9uRmllbGQgIT09IHVuZGVmaW5lZCAmJiBkb2Nbb25GaWVsZF0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgc2VsZWN0ZWRbb25GaWVsZF0gPSBkb2Nbb25GaWVsZF07XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdmFsdWUgPSBkb2NbaXRlbS5uYW1lXTtcbiAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHNlbGVjdGVkW2l0ZW0ubmFtZV0gPSBpdGVtLnNlbGVjdGlvbi5sZW5ndGggPiAwXG4gICAgICAgICAgICAgICAgPyBzZWxlY3RGaWVsZHModmFsdWUsIGl0ZW0uc2VsZWN0aW9uKVxuICAgICAgICAgICAgICAgIDogdmFsdWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHNlbGVjdGVkO1xufVxuIl19