"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.cleanError = cleanError;
exports.createError = createError;
exports.wrap = wrap;
exports.parseSelectionSet = parseSelectionSet;
exports.selectionToString = selectionToString;
exports.selectFields = selectFields;
exports.toLog = toLog;
exports.RegistryMap = void 0;

function cleanError(error) {
  if ('ArangoError' in error) {
    return error.ArangoError;
  }

  delete error.request;
  delete error.response;
  error.stack = '...';
  return error;
}

function createError(code, message, source = 'graphql') {
  const error = new Error(message);
  error.source = source;
  error.code = code;
  error.stack = '...';
  return error;
}

function isInternalServerError(error) {
  if ('type' in error && error.type === 'system') {
    return true;
  }

  if ('errno' in error && 'syscall' in error) {
    return true;
  }
}

async function wrap(log, op, args, fetch) {
  try {
    return await fetch();
  } catch (err) {
    let cleaned = cleanError(err);
    log.error('FAILED', op, args, cleaned);

    if (isInternalServerError(cleaned)) {
      cleaned = createError(500, 'Service temporary unavailable');
    }

    throw cleaned;
  }
}

class RegistryMap {
  constructor(name) {
    this.name = name;
    this.lastId = 0;
    this.items = new Map();
  }

  add(item) {
    let id = this.lastId;

    do {
      id = id < Number.MAX_SAFE_INTEGER ? id + 1 : 1;
    } while (this.items.has(id));

    this.lastId = id;
    this.items.set(id, item);
    return id;
  }

  remove(id) {
    if (!this.items.delete(id)) {
      console.error(`Failed to remove ${this.name}: item with id [${id}] does not exists`);
    }
  }

  entries() {
    return [...this.items.entries()];
  }

  values() {
    return [...this.items.values()];
  }

}

exports.RegistryMap = RegistryMap;

function parseSelectionSet(selectionSet, returnFieldSelection) {
  const fields = [];
  const selections = selectionSet && selectionSet.selections;

  if (selections) {
    for (const item of selections) {
      const name = item.name && item.name.value || '';

      if (name) {
        const field = {
          name,
          selection: parseSelectionSet(item.selectionSet, '')
        };

        if (returnFieldSelection !== '' && field.name === returnFieldSelection) {
          return field.selection;
        }

        fields.push(field);
      }
    }
  }

  return fields;
}

function selectionToString(selection) {
  return selection.filter(x => x.name !== '__typename').map(field => {
    const fieldSelection = selectionToString(field.selection);
    return `${field.name}${fieldSelection !== '' ? ` { ${fieldSelection} }` : ''}`;
  }).join(' ');
}

function selectFields(doc, selection) {
  if (selection.length === 0) {
    return doc;
  }

  const selected = {};

  if (doc._key) {
    selected._key = doc._key;
    selected.id = doc._key;
  }

  for (const item of selection) {
    const onField = {
      in_message: 'in_msg',
      out_messages: 'out_msg',
      signatures: 'id'
    }[item.name];

    if (onField !== undefined && doc[onField] !== undefined) {
      selected[onField] = doc[onField];
    }

    const value = doc[item.name];

    if (value !== undefined) {
      selected[item.name] = item.selection.length > 0 ? selectFields(value, item.selection) : value;
    }
  }

  return selected;
}

function toLog(value, objs) {
  const typeOf = typeof value;

  switch (typeOf) {
    case "undefined":
    case "boolean":
    case "number":
    case "bigint":
    case "symbol":
      return value;

    case "string":
      if (value.length > 80) {
        return `${value.substr(0, 50)}â€¦ [${value.length}]`;
      }

      return value;

    case "function":
      return undefined;

    default:
      if (value === null) {
        return value;
      }

      if (objs && objs.includes(value)) {
        return undefined;
      }

      const newObjs = objs ? [...objs, value] : [value];

      if (Array.isArray(value)) {
        return value.map(x => toLog(x, newObjs));
      }

      const valueToLog = {};
      Object.entries(value).forEach(([n, v]) => {
        const propertyValueToLog = toLog(v, newObjs);

        if (propertyValueToLog !== undefined) {
          valueToLog[n] = propertyValueToLog;
        }
      });
      return valueToLog;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci91dGlscy5qcyJdLCJuYW1lcyI6WyJjbGVhbkVycm9yIiwiZXJyb3IiLCJBcmFuZ29FcnJvciIsInJlcXVlc3QiLCJyZXNwb25zZSIsInN0YWNrIiwiY3JlYXRlRXJyb3IiLCJjb2RlIiwibWVzc2FnZSIsInNvdXJjZSIsIkVycm9yIiwiaXNJbnRlcm5hbFNlcnZlckVycm9yIiwidHlwZSIsIndyYXAiLCJsb2ciLCJvcCIsImFyZ3MiLCJmZXRjaCIsImVyciIsImNsZWFuZWQiLCJSZWdpc3RyeU1hcCIsImNvbnN0cnVjdG9yIiwibmFtZSIsImxhc3RJZCIsIml0ZW1zIiwiTWFwIiwiYWRkIiwiaXRlbSIsImlkIiwiTnVtYmVyIiwiTUFYX1NBRkVfSU5URUdFUiIsImhhcyIsInNldCIsInJlbW92ZSIsImRlbGV0ZSIsImNvbnNvbGUiLCJlbnRyaWVzIiwidmFsdWVzIiwicGFyc2VTZWxlY3Rpb25TZXQiLCJzZWxlY3Rpb25TZXQiLCJyZXR1cm5GaWVsZFNlbGVjdGlvbiIsImZpZWxkcyIsInNlbGVjdGlvbnMiLCJ2YWx1ZSIsImZpZWxkIiwic2VsZWN0aW9uIiwicHVzaCIsInNlbGVjdGlvblRvU3RyaW5nIiwiZmlsdGVyIiwieCIsIm1hcCIsImZpZWxkU2VsZWN0aW9uIiwiam9pbiIsInNlbGVjdEZpZWxkcyIsImRvYyIsImxlbmd0aCIsInNlbGVjdGVkIiwiX2tleSIsIm9uRmllbGQiLCJpbl9tZXNzYWdlIiwib3V0X21lc3NhZ2VzIiwic2lnbmF0dXJlcyIsInVuZGVmaW5lZCIsInRvTG9nIiwib2JqcyIsInR5cGVPZiIsInN1YnN0ciIsImluY2x1ZGVzIiwibmV3T2JqcyIsIkFycmF5IiwiaXNBcnJheSIsInZhbHVlVG9Mb2ciLCJPYmplY3QiLCJmb3JFYWNoIiwibiIsInYiLCJwcm9wZXJ0eVZhbHVlVG9Mb2ciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBRU8sU0FBU0EsVUFBVCxDQUFvQkMsS0FBcEIsRUFBcUM7QUFD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QUFNLENBQUNwQyxPQUFQLENBQWVPLEtBQWYsRUFBc0I4QixPQUF0QixDQUE4QixDQUFDLENBQUNDLENBQUQsRUFBSUMsQ0FBSixDQUFELEtBQVk7QUFDdEMsY0FBTUMsa0JBQWtCLEdBQUdiLEtBQUssQ0FBQ1ksQ0FBRCxFQUFJUCxPQUFKLENBQWhDOztBQUNBLFlBQUlRLGtCQUFrQixLQUFLZCxTQUEzQixFQUFzQztBQUNsQ1MsVUFBQUEsVUFBVSxDQUFDRyxDQUFELENBQVYsR0FBZ0JFLGtCQUFoQjtBQUNIO0FBQ0osT0FMRDtBQU1BLGFBQU9MLFVBQVA7QUFoQ0o7QUFrQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IFFMb2cgfSBmcm9tICcuL2xvZ3MnO1xuXG5leHBvcnQgZnVuY3Rpb24gY2xlYW5FcnJvcihlcnJvcjogYW55KTogYW55IHtcbiAgICBpZiAoJ0FyYW5nb0Vycm9yJyBpbiBlcnJvcikge1xuICAgICAgICByZXR1cm4gZXJyb3IuQXJhbmdvRXJyb3I7XG4gICAgfVxuICAgIGRlbGV0ZSBlcnJvci5yZXF1ZXN0O1xuICAgIGRlbGV0ZSBlcnJvci5yZXNwb25zZTtcbiAgICBlcnJvci5zdGFjayA9ICcuLi4nO1xuICAgIHJldHVybiBlcnJvcjtcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRXJyb3IoY29kZTogbnVtYmVyLCBtZXNzYWdlOiBzdHJpbmcsIHNvdXJjZTogc3RyaW5nID0gJ2dyYXBocWwnKTogRXJyb3Ige1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKG1lc3NhZ2UpO1xuICAgIChlcnJvcjogYW55KS5zb3VyY2UgPSBzb3VyY2U7XG4gICAgKGVycm9yOiBhbnkpLmNvZGUgPSBjb2RlO1xuICAgIGVycm9yLnN0YWNrID0gJy4uLic7XG4gICAgcmV0dXJuIGVycm9yO1xufVxuXG5mdW5jdGlvbiBpc0ludGVybmFsU2VydmVyRXJyb3IoZXJyb3I6IEVycm9yKTogYm9vbGVhbiB7XG4gICAgaWYgKCd0eXBlJyBpbiBlcnJvciAmJiBlcnJvci50eXBlID09PSAnc3lzdGVtJykge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKCdlcnJubycgaW4gZXJyb3IgJiYgJ3N5c2NhbGwnIGluIGVycm9yKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHdyYXA8Uj4obG9nOiBRTG9nLCBvcDogc3RyaW5nLCBhcmdzOiBhbnksIGZldGNoOiAoKSA9PiBQcm9taXNlPFI+KSB7XG4gICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IGZldGNoKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxldCBjbGVhbmVkID0gY2xlYW5FcnJvcihlcnIpO1xuICAgICAgICBsb2cuZXJyb3IoJ0ZBSUxFRCcsIG9wLCBhcmdzLCBjbGVhbmVkKTtcbiAgICAgICAgaWYgKGlzSW50ZXJuYWxTZXJ2ZXJFcnJvcihjbGVhbmVkKSkge1xuICAgICAgICAgICAgY2xlYW5lZCA9IGNyZWF0ZUVycm9yKDUwMCwgJ1NlcnZpY2UgdGVtcG9yYXJ5IHVuYXZhaWxhYmxlJyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgY2xlYW5lZDtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSZWdpc3RyeU1hcDxUPiB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGl0ZW1zOiBNYXA8bnVtYmVyLCBUPjtcbiAgICBsYXN0SWQ6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKG5hbWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICB0aGlzLmxhc3RJZCA9IDA7XG4gICAgICAgIHRoaXMuaXRlbXMgPSBuZXcgTWFwKCk7XG4gICAgfVxuXG4gICAgYWRkKGl0ZW06IFQpOiBudW1iZXIge1xuICAgICAgICBsZXQgaWQgPSB0aGlzLmxhc3RJZDtcbiAgICAgICAgZG8ge1xuICAgICAgICAgICAgaWQgPSBpZCA8IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSID8gaWQgKyAxIDogMTtcbiAgICAgICAgfSB3aGlsZSAodGhpcy5pdGVtcy5oYXMoaWQpKTtcbiAgICAgICAgdGhpcy5sYXN0SWQgPSBpZDtcbiAgICAgICAgdGhpcy5pdGVtcy5zZXQoaWQsIGl0ZW0pO1xuICAgICAgICByZXR1cm4gaWQ7XG4gICAgfVxuXG4gICAgcmVtb3ZlKGlkOiBudW1iZXIpIHtcbiAgICAgICAgaWYgKCF0aGlzLml0ZW1zLmRlbGV0ZShpZCkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byByZW1vdmUgJHt0aGlzLm5hbWV9OiBpdGVtIHdpdGggaWQgWyR7aWR9XSBkb2VzIG5vdCBleGlzdHNgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGVudHJpZXMoKTogW251bWJlciwgVF1bXSB7XG4gICAgICAgIHJldHVybiBbLi4udGhpcy5pdGVtcy5lbnRyaWVzKCldO1xuICAgIH1cblxuICAgIHZhbHVlcygpOiBUW10ge1xuICAgICAgICByZXR1cm4gWy4uLnRoaXMuaXRlbXMudmFsdWVzKCldO1xuICAgIH1cbn1cblxuZXhwb3J0IHR5cGUgRmllbGRTZWxlY3Rpb24gPSB7XG4gICAgbmFtZTogc3RyaW5nLFxuICAgIHNlbGVjdGlvbjogRmllbGRTZWxlY3Rpb25bXSxcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlU2VsZWN0aW9uU2V0KHNlbGVjdGlvblNldDogYW55LCByZXR1cm5GaWVsZFNlbGVjdGlvbjogc3RyaW5nKTogRmllbGRTZWxlY3Rpb25bXSB7XG4gICAgY29uc3QgZmllbGRzOiBGaWVsZFNlbGVjdGlvbltdID0gW107XG4gICAgY29uc3Qgc2VsZWN0aW9ucyA9IHNlbGVjdGlvblNldCAmJiBzZWxlY3Rpb25TZXQuc2VsZWN0aW9ucztcbiAgICBpZiAoc2VsZWN0aW9ucykge1xuICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2Ygc2VsZWN0aW9ucykge1xuICAgICAgICAgICAgY29uc3QgbmFtZSA9IChpdGVtLm5hbWUgJiYgaXRlbS5uYW1lLnZhbHVlKSB8fCAnJztcbiAgICAgICAgICAgIGlmIChuYW1lKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZmllbGQ6IEZpZWxkU2VsZWN0aW9uID0ge1xuICAgICAgICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb246IHBhcnNlU2VsZWN0aW9uU2V0KGl0ZW0uc2VsZWN0aW9uU2V0LCAnJyksXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBpZiAocmV0dXJuRmllbGRTZWxlY3Rpb24gIT09ICcnICYmIGZpZWxkLm5hbWUgPT09IHJldHVybkZpZWxkU2VsZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWVsZC5zZWxlY3Rpb247XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZpZWxkcy5wdXNoKGZpZWxkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmllbGRzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2VsZWN0aW9uVG9TdHJpbmcoc2VsZWN0aW9uOiBGaWVsZFNlbGVjdGlvbltdKTogc3RyaW5nIHtcbiAgICByZXR1cm4gc2VsZWN0aW9uXG4gICAgICAgIC5maWx0ZXIoeCA9PiB4Lm5hbWUgIT09ICdfX3R5cGVuYW1lJylcbiAgICAgICAgLm1hcCgoZmllbGQ6IEZpZWxkU2VsZWN0aW9uKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBmaWVsZFNlbGVjdGlvbiA9IHNlbGVjdGlvblRvU3RyaW5nKGZpZWxkLnNlbGVjdGlvbik7XG4gICAgICAgICAgICByZXR1cm4gYCR7ZmllbGQubmFtZX0ke2ZpZWxkU2VsZWN0aW9uICE9PSAnJyA/IGAgeyAke2ZpZWxkU2VsZWN0aW9ufSB9YCA6ICcnfWA7XG4gICAgICAgIH0pLmpvaW4oJyAnKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlbGVjdEZpZWxkcyhkb2M6IGFueSwgc2VsZWN0aW9uOiBGaWVsZFNlbGVjdGlvbltdKTogYW55IHtcbiAgICBpZiAoc2VsZWN0aW9uLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gZG9jO1xuICAgIH1cbiAgICBjb25zdCBzZWxlY3RlZDogYW55ID0ge307XG4gICAgaWYgKGRvYy5fa2V5KSB7XG4gICAgICAgIHNlbGVjdGVkLl9rZXkgPSBkb2MuX2tleTtcbiAgICAgICAgc2VsZWN0ZWQuaWQgPSBkb2MuX2tleTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIHNlbGVjdGlvbikge1xuICAgICAgICBjb25zdCBvbkZpZWxkID0ge1xuICAgICAgICAgICAgaW5fbWVzc2FnZTogJ2luX21zZycsXG4gICAgICAgICAgICBvdXRfbWVzc2FnZXM6ICdvdXRfbXNnJyxcbiAgICAgICAgICAgIHNpZ25hdHVyZXM6ICdpZCcsXG4gICAgICAgIH1baXRlbS5uYW1lXTtcbiAgICAgICAgaWYgKG9uRmllbGQgIT09IHVuZGVmaW5lZCAmJiBkb2Nbb25GaWVsZF0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgc2VsZWN0ZWRbb25GaWVsZF0gPSBkb2Nbb25GaWVsZF07XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdmFsdWUgPSBkb2NbaXRlbS5uYW1lXTtcbiAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHNlbGVjdGVkW2l0ZW0ubmFtZV0gPSBpdGVtLnNlbGVjdGlvbi5sZW5ndGggPiAwXG4gICAgICAgICAgICAgICAgPyBzZWxlY3RGaWVsZHModmFsdWUsIGl0ZW0uc2VsZWN0aW9uKVxuICAgICAgICAgICAgICAgIDogdmFsdWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHNlbGVjdGVkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdG9Mb2codmFsdWU6IGFueSwgb2Jqcz86IE9iamVjdFtdKTogYW55IHtcbiAgICBjb25zdCB0eXBlT2YgPSB0eXBlb2YgdmFsdWU7XG4gICAgc3dpdGNoICh0eXBlT2YpIHtcbiAgICBjYXNlIFwidW5kZWZpbmVkXCI6XG4gICAgY2FzZSBcImJvb2xlYW5cIjpcbiAgICBjYXNlIFwibnVtYmVyXCI6XG4gICAgY2FzZSBcImJpZ2ludFwiOlxuICAgIGNhc2UgXCJzeW1ib2xcIjpcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIGNhc2UgXCJzdHJpbmdcIjpcbiAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCA+IDgwKSB7XG4gICAgICAgICAgICByZXR1cm4gYCR7dmFsdWUuc3Vic3RyKDAsIDUwKX3igKYgWyR7dmFsdWUubGVuZ3RofV1gXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIGNhc2UgXCJmdW5jdGlvblwiOlxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIGRlZmF1bHQ6XG4gICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChvYmpzICYmIG9ianMuaW5jbHVkZXModmFsdWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG5ld09ianMgPSBvYmpzID8gWy4uLm9ianMsIHZhbHVlXSA6IFt2YWx1ZV07XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlLm1hcCh4ID0+IHRvTG9nKHgsIG5ld09ianMpKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB2YWx1ZVRvTG9nOiB7IFtzdHJpbmddOiBhbnkgfSA9IHt9O1xuICAgICAgICBPYmplY3QuZW50cmllcyh2YWx1ZSkuZm9yRWFjaCgoW24sIHZdKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwcm9wZXJ0eVZhbHVlVG9Mb2cgPSB0b0xvZyh2LCBuZXdPYmpzKTtcbiAgICAgICAgICAgIGlmIChwcm9wZXJ0eVZhbHVlVG9Mb2cgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHZhbHVlVG9Mb2dbbl0gPSBwcm9wZXJ0eVZhbHVlVG9Mb2c7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdmFsdWVUb0xvZ1xuICAgIH1cbn1cbiJdfQ==