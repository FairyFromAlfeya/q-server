"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.packageJson = packageJson;
exports.cleanError = cleanError;
exports.wrap = wrap;
exports.toLog = toLog;
exports.hash = hash;
exports.RegistryMap = exports.QError = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _crypto = require("crypto");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function packageJson() {
  let testPath = _path.default.resolve(__dirname);

  const packagePath = () => _path.default.resolve(testPath, 'package.json');

  while (testPath && !_fs.default.existsSync(packagePath())) {
    testPath = _path.default.dirname(testPath);
  }

  return JSON.parse(_fs.default.readFileSync(packagePath(), 'utf8'));
}

function cleanError(error) {
  if ('ArangoError' in error) {
    return error.ArangoError;
  }

  delete error.request;
  delete error.response;
  return error;
}

const QErrorCode = {
  MESSAGE_EXPIRED: 10001,
  MULTIPLE_ACCESS_KEYS: 10002,
  UNAUTHORIZED: 10003,
  AUTH_SERVICE_UNAVAILABLE: 10004,
  AUTH_FAILED: 10005,
  QUERY_TERMINATED_ON_TIMEOUT: 10006
};

class QError {
  static messageExpired(id, expiredAt) {
    return QError.create(QErrorCode.MESSAGE_EXPIRED, `Message expired`, {
      id,
      expiredAt,
      now: Date.now()
    });
  }

  static queryTerminatedOnTimeout() {
    return QError.create(QErrorCode.QUERY_TERMINATED_ON_TIMEOUT, `Query terminated on timeout`, {
      now: Date.now()
    });
  }

  static create(code, message, data) {
    const error = new Error(message);
    error.source = 'graphql';
    error.code = code;

    if (data !== undefined) {
      error.data = data;
    }

    return error;
  }

  static multipleAccessKeys() {
    return QError.create(QErrorCode.MULTIPLE_ACCESS_KEYS, 'Request must use the same access key for all queries and mutations');
  }

  static unauthorized() {
    return QError.create(QErrorCode.UNAUTHORIZED, 'Unauthorized');
  }

  static authServiceUnavailable() {
    return QError.create(QErrorCode.AUTH_SERVICE_UNAVAILABLE, 'Auth service unavailable');
  }

  static auth(error) {
    return QError.create(QErrorCode.AUTH_FAILED, error.message || error.description, {
      authErrorCode: error.code
    });
  }

}

exports.QError = QError;

function isInternalServerError(error) {
  if ('type' in error && error.type === 'system') {
    return true;
  }

  if ('errno' in error && 'syscall' in error) {
    return true;
  }
}

async function wrap(log, op, args, fetch) {
  try {
    return await fetch();
  } catch (err) {
    let cleaned = cleanError(err);
    log.error('FAILED', op, args, cleaned);

    if (isInternalServerError(cleaned)) {
      cleaned = QError.create(500, 'Service temporary unavailable');
    }

    throw cleaned;
  }
}

class RegistryMap {
  constructor(name) {
    this.name = name;
    this.lastId = 0;
    this.items = new Map();
  }

  add(item) {
    let id = this.lastId;

    do {
      id = id < Number.MAX_SAFE_INTEGER ? id + 1 : 1;
    } while (this.items.has(id));

    this.lastId = id;
    this.items.set(id, item);
    return id;
  }

  remove(id) {
    if (!this.items.delete(id)) {
      console.error(`Failed to remove ${this.name}: item with id [${id}] does not exists`);
    }
  }

  entries() {
    return [...this.items.entries()];
  }

  values() {
    return [...this.items.values()];
  }

}

exports.RegistryMap = RegistryMap;

function toLog(value, objs) {
  const typeOf = typeof value;

  switch (typeOf) {
    case "undefined":
    case "boolean":
    case "number":
    case "bigint":
    case "symbol":
      return value;

    case "string":
      if (value.length > 80) {
        return `${value.substr(0, 50)}â€¦ [${value.length}]`;
      }

      return value;

    case "function":
      return undefined;

    default:
      if (value === null) {
        return value;
      }

      if (objs && objs.includes(value)) {
        return undefined;
      }

      const newObjs = objs ? [...objs, value] : [value];

      if (Array.isArray(value)) {
        return value.map(x => toLog(x, newObjs));
      }

      const valueToLog = {};
      Object.entries(value).forEach(([n, v]) => {
        const propertyValueToLog = toLog(v, newObjs);

        if (propertyValueToLog !== undefined) {
          valueToLog[n] = propertyValueToLog;
        }
      });
      return valueToLog;
  }
}

function hash(...keys) {
  return (0, _crypto.createHash)('md5').update(keys.join('')).digest("hex");
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvdXRpbHMuanMiXSwibmFtZXMiOlsicGFja2FnZUpzb24iLCJ0ZXN0UGF0aCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwicGFja2FnZVBhdGgiLCJmcyIsImV4aXN0c1N5bmMiLCJkaXJuYW1lIiwiSlNPTiIsInBhcnNlIiwicmVhZEZpbGVTeW5jIiwiY2xlYW5FcnJvciIsImVycm9yIiwiQXJhbmdvRXJyb3IiLCJyZXF1ZXN0IiwicmVzcG9uc2UiLCJRRXJyb3JDb2RlIiwiTUVTU0FHRV9FWFBJUkVEIiwiTVVMVElQTEVfQUNDRVNTX0tFWVMiLCJVTkFVVEhPUklaRUQiLCJBVVRIX1NFUlZJQ0VfVU5BVkFJTEFCTEUiLCJBVVRIX0ZBSUxFRCIsIlFVRVJZX1RFUk1JTkFURURfT05fVElNRU9VVCIsIlFFcnJvciIsIm1lc3NhZ2VFeHBpcmVkIiwiaWQiLCJleHBpcmVkQXQiLCJjcmVhdGUiLCJub3ciLCJEYXRlIiwicXVlcnlUZXJtaW5hdGVkT25UaW1lb3V0IiwiY29kZSIsIm1lc3NhZ2UiLCJkYXRhIiwiRXJyb3IiLCJzb3VyY2UiLCJ1bmRlZmluZWQiLCJtdWx0aXBsZUFjY2Vzc0tleXMiLCJ1bmF1dGhvcml6ZWQiLCJhdXRoU2VydmljZVVuYXZhaWxhYmxlIiwiYXV0aCIsImRlc2NyaXB0aW9uIiwiYXV0aEVycm9yQ29kZSIsImlzSW50ZXJuYWxTZXJ2ZXJFcnJvciIsInR5cGUiLCJ3cmFwIiwibG9nIiwib3AiLCJhcmdzIiwiZmV0Y2giLCJlcnIiLCJjbGVhbmVkIiwiUmVnaXN0cnlNYXAiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJsYXN0SWQiLCJpdGVtcyIsIk1hcCIsImFkZCIsIml0ZW0iLCJOdW1iZXIiLCJNQVhfU0FGRV9JTlRFR0VSIiwiaGFzIiwic2V0IiwicmVtb3ZlIiwiZGVsZXRlIiwiY29uc29sZSIsImVudHJpZXMiLCJ2YWx1ZXMiLCJ0b0xvZyIsInZhbHVlIiwib2JqcyIsInR5cGVPZiIsImxlbmd0aCIsInN1YnN0ciIsImluY2x1ZGVzIiwibmV3T2JqcyIsIkFycmF5IiwiaXNBcnJheSIsIm1hcCIsIngiLCJ2YWx1ZVRvTG9nIiwiT2JqZWN0IiwiZm9yRWFjaCIsIm4iLCJ2IiwicHJvcGVydHlWYWx1ZVRvTG9nIiwiaGFzaCIsImtleXMiLCJ1cGRhdGUiLCJqb2luIiwiZGlnZXN0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVPLFNBQVNBLFdBQVQsR0FBNEI7QUFDL0IsTUFBSUMsUUFBUSxHQUFHQyxjQUFLQyxPQUFMLENBQWFDLFNBQWIsQ0FBZjs7QUFDQSxRQUFNQyxXQUFXLEdBQUcsTUFBTUgsY0FBS0MsT0FBTCxDQUFhRixRQUFiLEVBQXVCLGNBQXZCLENBQTFCOztBQUNBLFNBQU9BLFFBQVEsSUFBSSxDQUFDSyxZQUFHQyxVQUFILENBQWNGLFdBQVcsRUFBekIsQ0FBcEIsRUFBa0Q7QUFDOUNKLElBQUFBLFFBQVEsR0FBR0MsY0FBS00sT0FBTCxDQUFhUCxRQUFiLENBQVg7QUFDSDs7QUFDRCxTQUFPUSxJQUFJLENBQUNDLEtBQUwsQ0FBV0osWUFBR0ssWUFBSCxDQUFnQk4sV0FBVyxFQUEzQixFQUErQixNQUEvQixDQUFYLENBQVA7QUFDSDs7QUFFTSxTQUFTTyxVQUFULENBQW9CQyxLQUFwQixFQUFxQztBQUN4QyxNQUFJLGlCQUFpQkEsS0FBckIsRUFBNEI7QUFDeEIsV0FBT0EsS0FBSyxDQUFDQyxXQUFiO0FBQ0g7O0FBQ0QsU0FBT0QsS0FBSyxDQUFDRSxPQUFiO0FBQ0EsU0FBT0YsS0FBSyxDQUFDRyxRQUFiO0FBQ0EsU0FBT0gsS0FBUDtBQUNIOztBQUVELE1BQU1JLFVBQVUsR0FBRztBQUNmQyxFQUFBQSxlQUFlLEVBQUUsS0FERjtBQUVmQyxFQUFBQSxvQkFBb0IsRUFBRSxLQUZQO0FBR2ZDLEVBQUFBLFlBQVksRUFBRSxLQUhDO0FBSWZDLEVBQUFBLHdCQUF3QixFQUFFLEtBSlg7QUFLZkMsRUFBQUEsV0FBVyxFQUFFLEtBTEU7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QUFLLENBQUNnQixDQUFELEVBQUlULE9BQUosQ0FBaEM7O0FBQ0EsWUFBSVUsa0JBQWtCLEtBQUtsRCxTQUEzQixFQUFzQztBQUNsQzZDLFVBQUFBLFVBQVUsQ0FBQ0csQ0FBRCxDQUFWLEdBQWdCRSxrQkFBaEI7QUFDSDtBQUNKLE9BTEQ7QUFNQSxhQUFPTCxVQUFQO0FBaENKO0FBa0NIOztBQUVNLFNBQVNNLElBQVQsQ0FBYyxHQUFHQyxJQUFqQixFQUF5QztBQUM1QyxTQUFPLHdCQUFXLEtBQVgsRUFBa0JDLE1BQWxCLENBQXlCRCxJQUFJLENBQUNFLElBQUwsQ0FBVSxFQUFWLENBQXpCLEVBQXdDQyxNQUF4QyxDQUErQyxLQUEvQyxDQUFQO0FBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IFFMb2cgfSBmcm9tICcuL2xvZ3MnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgY3JlYXRlSGFzaCB9IGZyb20gJ2NyeXB0bydcblxuZXhwb3J0IGZ1bmN0aW9uIHBhY2thZ2VKc29uKCk6IGFueSB7XG4gICAgbGV0IHRlc3RQYXRoID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSk7XG4gICAgY29uc3QgcGFja2FnZVBhdGggPSAoKSA9PiBwYXRoLnJlc29sdmUodGVzdFBhdGgsICdwYWNrYWdlLmpzb24nKTtcbiAgICB3aGlsZSAodGVzdFBhdGggJiYgIWZzLmV4aXN0c1N5bmMocGFja2FnZVBhdGgoKSkpIHtcbiAgICAgICAgdGVzdFBhdGggPSBwYXRoLmRpcm5hbWUodGVzdFBhdGgpO1xuICAgIH1cbiAgICByZXR1cm4gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMocGFja2FnZVBhdGgoKSwgJ3V0ZjgnKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjbGVhbkVycm9yKGVycm9yOiBhbnkpOiBhbnkge1xuICAgIGlmICgnQXJhbmdvRXJyb3InIGluIGVycm9yKSB7XG4gICAgICAgIHJldHVybiBlcnJvci5BcmFuZ29FcnJvcjtcbiAgICB9XG4gICAgZGVsZXRlIGVycm9yLnJlcXVlc3Q7XG4gICAgZGVsZXRlIGVycm9yLnJlc3BvbnNlO1xuICAgIHJldHVybiBlcnJvcjtcbn1cblxuY29uc3QgUUVycm9yQ29kZSA9IHtcbiAgICBNRVNTQUdFX0VYUElSRUQ6IDEwMDAxLFxuICAgIE1VTFRJUExFX0FDQ0VTU19LRVlTOiAxMDAwMixcbiAgICBVTkFVVEhPUklaRUQ6IDEwMDAzLFxuICAgIEFVVEhfU0VSVklDRV9VTkFWQUlMQUJMRTogMTAwMDQsXG4gICAgQVVUSF9GQUlMRUQ6IDEwMDA1LFxuICAgIFFVRVJZX1RFUk1JTkFURURfT05fVElNRU9VVDogMTAwMDYsXG59O1xuXG5leHBvcnQgY2xhc3MgUUVycm9yIHtcbiAgICBzdGF0aWMgbWVzc2FnZUV4cGlyZWQoaWQ6IHN0cmluZywgZXhwaXJlZEF0OiBudW1iZXIpOiBFcnJvciB7XG4gICAgICAgIHJldHVybiBRRXJyb3IuY3JlYXRlKFFFcnJvckNvZGUuTUVTU0FHRV9FWFBJUkVELCBgTWVzc2FnZSBleHBpcmVkYCwge1xuICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICBleHBpcmVkQXQsXG4gICAgICAgICAgICBub3c6IERhdGUubm93KCksXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHN0YXRpYyBxdWVyeVRlcm1pbmF0ZWRPblRpbWVvdXQoKTogRXJyb3Ige1xuICAgICAgICByZXR1cm4gUUVycm9yLmNyZWF0ZShRRXJyb3JDb2RlLlFVRVJZX1RFUk1JTkFURURfT05fVElNRU9VVCwgYFF1ZXJ5IHRlcm1pbmF0ZWQgb24gdGltZW91dGAsIHtcbiAgICAgICAgICAgIG5vdzogRGF0ZS5ub3coKSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGNyZWF0ZShjb2RlOiBudW1iZXIsIG1lc3NhZ2U6IHN0cmluZywgZGF0YT86IGFueSk6IEVycm9yIHtcbiAgICAgICAgY29uc3QgZXJyb3I6IGFueSA9IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgICAgICAgZXJyb3Iuc291cmNlID0gJ2dyYXBocWwnO1xuICAgICAgICBlcnJvci5jb2RlID0gY29kZTtcbiAgICAgICAgaWYgKGRhdGEgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgZXJyb3IuZGF0YSA9IGRhdGE7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGVycm9yO1xuICAgIH1cblxuICAgIHN0YXRpYyBtdWx0aXBsZUFjY2Vzc0tleXMoKSB7XG4gICAgICAgIHJldHVybiBRRXJyb3IuY3JlYXRlKFxuICAgICAgICAgICAgUUVycm9yQ29kZS5NVUxUSVBMRV9BQ0NFU1NfS0VZUyxcbiAgICAgICAgICAgICdSZXF1ZXN0IG11c3QgdXNlIHRoZSBzYW1lIGFjY2VzcyBrZXkgZm9yIGFsbCBxdWVyaWVzIGFuZCBtdXRhdGlvbnMnLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIHN0YXRpYyB1bmF1dGhvcml6ZWQoKSB7XG4gICAgICAgIHJldHVybiBRRXJyb3IuY3JlYXRlKFFFcnJvckNvZGUuVU5BVVRIT1JJWkVELCAnVW5hdXRob3JpemVkJyk7XG4gICAgfVxuXG4gICAgc3RhdGljIGF1dGhTZXJ2aWNlVW5hdmFpbGFibGUoKSB7XG4gICAgICAgIHJldHVybiBRRXJyb3IuY3JlYXRlKFFFcnJvckNvZGUuQVVUSF9TRVJWSUNFX1VOQVZBSUxBQkxFLCAnQXV0aCBzZXJ2aWNlIHVuYXZhaWxhYmxlJyk7XG4gICAgfVxuXG4gICAgc3RhdGljIGF1dGgoZXJyb3IpIHtcbiAgICAgICAgcmV0dXJuIFFFcnJvci5jcmVhdGUoUUVycm9yQ29kZS5BVVRIX0ZBSUxFRCxcbiAgICAgICAgICAgIGVycm9yLm1lc3NhZ2UgfHwgZXJyb3IuZGVzY3JpcHRpb24sXG4gICAgICAgICAgICB7IGF1dGhFcnJvckNvZGU6IGVycm9yLmNvZGUgfSxcbiAgICAgICAgKVxuICAgIH1cbn1cblxuZnVuY3Rpb24gaXNJbnRlcm5hbFNlcnZlckVycm9yKGVycm9yOiBFcnJvcik6IGJvb2xlYW4ge1xuICAgIGlmICgndHlwZScgaW4gZXJyb3IgJiYgZXJyb3IudHlwZSA9PT0gJ3N5c3RlbScpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGlmICgnZXJybm8nIGluIGVycm9yICYmICdzeXNjYWxsJyBpbiBlcnJvcikge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3cmFwPFI+KGxvZzogUUxvZywgb3A6IHN0cmluZywgYXJnczogYW55LCBmZXRjaDogKCkgPT4gUHJvbWlzZTxSPikge1xuICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBmZXRjaCgpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsZXQgY2xlYW5lZCA9IGNsZWFuRXJyb3IoZXJyKTtcbiAgICAgICAgbG9nLmVycm9yKCdGQUlMRUQnLCBvcCwgYXJncywgY2xlYW5lZCk7XG4gICAgICAgIGlmIChpc0ludGVybmFsU2VydmVyRXJyb3IoY2xlYW5lZCkpIHtcbiAgICAgICAgICAgIGNsZWFuZWQgPSBRRXJyb3IuY3JlYXRlKDUwMCwgJ1NlcnZpY2UgdGVtcG9yYXJ5IHVuYXZhaWxhYmxlJyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgY2xlYW5lZDtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSZWdpc3RyeU1hcDxUPiB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGl0ZW1zOiBNYXA8bnVtYmVyLCBUPjtcbiAgICBsYXN0SWQ6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKG5hbWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICB0aGlzLmxhc3RJZCA9IDA7XG4gICAgICAgIHRoaXMuaXRlbXMgPSBuZXcgTWFwKCk7XG4gICAgfVxuXG4gICAgYWRkKGl0ZW06IFQpOiBudW1iZXIge1xuICAgICAgICBsZXQgaWQgPSB0aGlzLmxhc3RJZDtcbiAgICAgICAgZG8ge1xuICAgICAgICAgICAgaWQgPSBpZCA8IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSID8gaWQgKyAxIDogMTtcbiAgICAgICAgfSB3aGlsZSAodGhpcy5pdGVtcy5oYXMoaWQpKTtcbiAgICAgICAgdGhpcy5sYXN0SWQgPSBpZDtcbiAgICAgICAgdGhpcy5pdGVtcy5zZXQoaWQsIGl0ZW0pO1xuICAgICAgICByZXR1cm4gaWQ7XG4gICAgfVxuXG4gICAgcmVtb3ZlKGlkOiBudW1iZXIpIHtcbiAgICAgICAgaWYgKCF0aGlzLml0ZW1zLmRlbGV0ZShpZCkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byByZW1vdmUgJHt0aGlzLm5hbWV9OiBpdGVtIHdpdGggaWQgWyR7aWR9XSBkb2VzIG5vdCBleGlzdHNgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGVudHJpZXMoKTogW251bWJlciwgVF1bXSB7XG4gICAgICAgIHJldHVybiBbLi4udGhpcy5pdGVtcy5lbnRyaWVzKCldO1xuICAgIH1cblxuICAgIHZhbHVlcygpOiBUW10ge1xuICAgICAgICByZXR1cm4gWy4uLnRoaXMuaXRlbXMudmFsdWVzKCldO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRvTG9nKHZhbHVlOiBhbnksIG9ianM/OiBPYmplY3RbXSk6IGFueSB7XG4gICAgY29uc3QgdHlwZU9mID0gdHlwZW9mIHZhbHVlO1xuICAgIHN3aXRjaCAodHlwZU9mKSB7XG4gICAgY2FzZSBcInVuZGVmaW5lZFwiOlxuICAgIGNhc2UgXCJib29sZWFuXCI6XG4gICAgY2FzZSBcIm51bWJlclwiOlxuICAgIGNhc2UgXCJiaWdpbnRcIjpcbiAgICBjYXNlIFwic3ltYm9sXCI6XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICBjYXNlIFwic3RyaW5nXCI6XG4gICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPiA4MCkge1xuICAgICAgICAgICAgcmV0dXJuIGAke3ZhbHVlLnN1YnN0cigwLCA1MCl94oCmIFske3ZhbHVlLmxlbmd0aH1dYFxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICBjYXNlIFwiZnVuY3Rpb25cIjpcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICBkZWZhdWx0OlxuICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAob2JqcyAmJiBvYmpzLmluY2x1ZGVzKHZhbHVlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBuZXdPYmpzID0gb2JqcyA/IFsuLi5vYmpzLCB2YWx1ZV0gOiBbdmFsdWVdO1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5tYXAoeCA9PiB0b0xvZyh4LCBuZXdPYmpzKSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdmFsdWVUb0xvZzogeyBbc3RyaW5nXTogYW55IH0gPSB7fTtcbiAgICAgICAgT2JqZWN0LmVudHJpZXModmFsdWUpLmZvckVhY2goKFtuLCB2XSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcHJvcGVydHlWYWx1ZVRvTG9nID0gdG9Mb2codiwgbmV3T2Jqcyk7XG4gICAgICAgICAgICBpZiAocHJvcGVydHlWYWx1ZVRvTG9nICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZVRvTG9nW25dID0gcHJvcGVydHlWYWx1ZVRvTG9nO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHZhbHVlVG9Mb2dcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNoKC4uLmtleXM6IHN0cmluZ1tdKTogc3RyaW5nIHtcbiAgICByZXR1cm4gY3JlYXRlSGFzaCgnbWQ1JykudXBkYXRlKGtleXMuam9pbignJykpLmRpZ2VzdChcImhleFwiKTtcbn1cbiJdfQ==