"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.cleanError = cleanError;
exports.createError = createError;
exports.wrap = wrap;
exports.toLog = toLog;
exports.RegistryMap = exports.QError = void 0;

function cleanError(error) {
  if ('ArangoError' in error) {
    return error.ArangoError;
  }

  delete error.request;
  delete error.response;
  return error;
}

const QErrorCode = {
  MESSAGE_EXPIRED: 1006
};

class QError {
  static messageExpired(id, expiredAt) {
    return QError.create(QErrorCode.MESSAGE_EXPIRED, `Message expired`, {
      id,
      expiredAt,
      now: Date.now()
    });
  }

  static create(code, message, data) {
    const error = new Error(message);
    error.source = 'graphql';
    error.code = code;

    if (data !== undefined) {
      error.data = data;
    }

    return error;
  }

}

exports.QError = QError;

function createError(code, message, source = 'graphql') {
  const error = new Error(message);
  error.source = source;
  error.code = code;
  return error;
}

function isInternalServerError(error) {
  if ('type' in error && error.type === 'system') {
    return true;
  }

  if ('errno' in error && 'syscall' in error) {
    return true;
  }
}

async function wrap(log, op, args, fetch) {
  try {
    return await fetch();
  } catch (err) {
    let cleaned = cleanError(err);
    log.error('FAILED', op, args, cleaned);

    if (isInternalServerError(cleaned)) {
      cleaned = createError(500, 'Service temporary unavailable');
    }

    throw cleaned;
  }
}

class RegistryMap {
  constructor(name) {
    this.name = name;
    this.lastId = 0;
    this.items = new Map();
  }

  add(item) {
    let id = this.lastId;

    do {
      id = id < Number.MAX_SAFE_INTEGER ? id + 1 : 1;
    } while (this.items.has(id));

    this.lastId = id;
    this.items.set(id, item);
    return id;
  }

  remove(id) {
    if (!this.items.delete(id)) {
      console.error(`Failed to remove ${this.name}: item with id [${id}] does not exists`);
    }
  }

  entries() {
    return [...this.items.entries()];
  }

  values() {
    return [...this.items.values()];
  }

}

exports.RegistryMap = RegistryMap;

function toLog(value, objs) {
  const typeOf = typeof value;

  switch (typeOf) {
    case "undefined":
    case "boolean":
    case "number":
    case "bigint":
    case "symbol":
      return value;

    case "string":
      if (value.length > 80) {
        return `${value.substr(0, 50)}â€¦ [${value.length}]`;
      }

      return value;

    case "function":
      return undefined;

    default:
      if (value === null) {
        return value;
      }

      if (objs && objs.includes(value)) {
        return undefined;
      }

      const newObjs = objs ? [...objs, value] : [value];

      if (Array.isArray(value)) {
        return value.map(x => toLog(x, newObjs));
      }

      const valueToLog = {};
      Object.entries(value).forEach(([n, v]) => {
        const propertyValueToLog = toLog(v, newObjs);

        if (propertyValueToLog !== undefined) {
          valueToLog[n] = propertyValueToLog;
        }
      });
      return valueToLog;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci91dGlscy5qcyJdLCJuYW1lcyI6WyJjbGVhbkVycm9yIiwiZXJyb3IiLCJBcmFuZ29FcnJvciIsInJlcXVlc3QiLCJyZXNwb25zZSIsIlFFcnJvckNvZGUiLCJNRVNTQUdFX0VYUElSRUQiLCJRRXJyb3IiLCJtZXNzYWdlRXhwaXJlZCIsImlkIiwiZXhwaXJlZEF0IiwiY3JlYXRlIiwibm93IiwiRGF0ZSIsImNvZGUiLCJtZXNzYWdlIiwiZGF0YSIsIkVycm9yIiwic291cmNlIiwidW5kZWZpbmVkIiwiY3JlYXRlRXJyb3IiLCJpc0ludGVybmFsU2VydmVyRXJyb3IiLCJ0eXBlIiwid3JhcCIsImxvZyIsIm9wIiwiYXJncyIsImZldGNoIiwiZXJyIiwiY2xlYW5lZCIsIlJlZ2lzdHJ5TWFwIiwiY29uc3RydWN0b3IiLCJuYW1lIiwibGFzdElkIiwiaXRlbXMiLCJNYXAiLCJhZGQiLCJpdGVtIiwiTnVtYmVyIiwiTUFYX1NBRkVfSU5URUdFUiIsImhhcyIsInNldCIsInJlbW92ZSIsImRlbGV0ZSIsImNvbnNvbGUiLCJlbnRyaWVzIiwidmFsdWVzIiwidG9Mb2ciLCJ2YWx1ZSIsIm9ianMiLCJ0eXBlT2YiLCJsZW5ndGgiLCJzdWJzdHIiLCJpbmNsdWRlcyIsIm5ld09ianMiLCJBcnJheSIsImlzQXJyYXkiLCJtYXAiLCJ4IiwidmFsdWVUb0xvZyIsIk9iamVjdCIsImZvckVhY2giLCJuIiwidiIsInByb3BlcnR5VmFsdWVUb0xvZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFFTyxTQUFTQSxVQUFULENBQW9CQyxLQUFwQixFQUFxQztBQUN4QyxNQUFJLGlCQUFpQkEsS0FBckIsRUFBNEI7QUFDeEIsV0FBT0EsS0FBSyxDQUFDQyxXQUFiO0FBQ0g7O0FBQ0QsU0FBT0QsS0FBSyxDQUFDRSxPQUFiO0FBQ0EsU0FBT0YsS0FBSyxDQUFDRyxRQUFiO0FBQ0EsU0FBT0gsS0FBUDtBQUNIOztBQUVELE1BQU1JLFVBQVUsR0FBRztBQUNm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LFVBQUlDLElBQUksSUFBSUEsSUFBSSxDQUFDSSxRQUFMLENBQWNMLEtBQWQsQ0FBWixFQUFrQztBQUM5QixlQUFPN0IsU0FBUDtBQUNIOztBQUNELFlBQU1tQyxPQUFPLEdBQUdMLElBQUksR0FBRyxDQUFDLEdBQUdBLElBQUosRUFBVUQsS0FBVixDQUFILEdBQXNCLENBQUNBLEtBQUQsQ0FBMUM7O0FBQ0EsVUFBSU8sS0FBSyxDQUFDQyxPQUFOLENBQWNSLEtBQWQsQ0FBSixFQUEwQjtBQUN0QixlQUFPQSxLQUFLLENBQUNTLEdBQU4sQ0FBVUMsQ0FBQyxJQUFJWCxLQUFLLENBQUNXLENBQUQsRUFBSUosT0FBSixDQUFwQixDQUFQO0FBQ0g7O0FBQ0QsWUFBTUssVUFBNkIsR0FBRyxFQUF0QztBQUNBQyxNQUFBQSxNQUFNLENBQUNmLE9BQVAsQ0FBZUcsS0FBZixFQUFzQmEsT0FBdEIsQ0FBOEIsQ0FBQyxDQUFDQyxDQUFELEVBQUlDLENBQUosQ0FBRCxLQUFZO0FBQ3RDLGNBQU1DLGtCQUFrQixHQUFHakIsS0FBSyxDQUFDZ0IsQ0FBRCxFQUFJVCxPQUFKLENBQWhDOztBQUNBLFlBQUlVLGtCQUFrQixLQUFLN0MsU0FBM0IsRUFBc0M7QUFDbEN3QyxVQUFBQSxVQUFVLENBQUNHLENBQUQsQ0FBVixHQUFnQkUsa0JBQWhCO0FBQ0g7QUFDSixPQUxEO0FBTUEsYUFBT0wsVUFBUDtBQWhDSjtBQWtDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgUUxvZyB9IGZyb20gJy4vbG9ncyc7XG5cbmV4cG9ydCBmdW5jdGlvbiBjbGVhbkVycm9yKGVycm9yOiBhbnkpOiBhbnkge1xuICAgIGlmICgnQXJhbmdvRXJyb3InIGluIGVycm9yKSB7XG4gICAgICAgIHJldHVybiBlcnJvci5BcmFuZ29FcnJvcjtcbiAgICB9XG4gICAgZGVsZXRlIGVycm9yLnJlcXVlc3Q7XG4gICAgZGVsZXRlIGVycm9yLnJlc3BvbnNlO1xuICAgIHJldHVybiBlcnJvcjtcbn1cblxuY29uc3QgUUVycm9yQ29kZSA9IHtcbiAgICBNRVNTQUdFX0VYUElSRUQ6IDEwMDYsXG59O1xuXG5leHBvcnQgY2xhc3MgUUVycm9yIHtcbiAgICBzdGF0aWMgbWVzc2FnZUV4cGlyZWQoaWQ6IHN0cmluZywgZXhwaXJlZEF0OiBudW1iZXIpOiBFcnJvciB7XG4gICAgICAgIHJldHVybiBRRXJyb3IuY3JlYXRlKFFFcnJvckNvZGUuTUVTU0FHRV9FWFBJUkVELCBgTWVzc2FnZSBleHBpcmVkYCwge1xuICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICBleHBpcmVkQXQsXG4gICAgICAgICAgICBub3c6IERhdGUubm93KCksXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHN0YXRpYyBjcmVhdGUoY29kZTogbnVtYmVyLCBtZXNzYWdlOiBzdHJpbmcsIGRhdGE/OiBhbnkpOiBFcnJvciB7XG4gICAgICAgIGNvbnN0IGVycm9yOiBhbnkgPSBuZXcgRXJyb3IobWVzc2FnZSk7XG4gICAgICAgIGVycm9yLnNvdXJjZSA9ICdncmFwaHFsJztcbiAgICAgICAgZXJyb3IuY29kZSA9IGNvZGU7XG4gICAgICAgIGlmIChkYXRhICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGVycm9yLmRhdGEgPSBkYXRhO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBlcnJvcjtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVFcnJvcihjb2RlOiBudW1iZXIsIG1lc3NhZ2U6IHN0cmluZywgc291cmNlOiBzdHJpbmcgPSAnZ3JhcGhxbCcpOiBFcnJvciB7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IobWVzc2FnZSk7XG4gICAgKGVycm9yOiBhbnkpLnNvdXJjZSA9IHNvdXJjZTtcbiAgICAoZXJyb3I6IGFueSkuY29kZSA9IGNvZGU7XG4gICAgcmV0dXJuIGVycm9yO1xufVxuXG5mdW5jdGlvbiBpc0ludGVybmFsU2VydmVyRXJyb3IoZXJyb3I6IEVycm9yKTogYm9vbGVhbiB7XG4gICAgaWYgKCd0eXBlJyBpbiBlcnJvciAmJiBlcnJvci50eXBlID09PSAnc3lzdGVtJykge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKCdlcnJubycgaW4gZXJyb3IgJiYgJ3N5c2NhbGwnIGluIGVycm9yKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHdyYXA8Uj4obG9nOiBRTG9nLCBvcDogc3RyaW5nLCBhcmdzOiBhbnksIGZldGNoOiAoKSA9PiBQcm9taXNlPFI+KSB7XG4gICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IGZldGNoKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxldCBjbGVhbmVkID0gY2xlYW5FcnJvcihlcnIpO1xuICAgICAgICBsb2cuZXJyb3IoJ0ZBSUxFRCcsIG9wLCBhcmdzLCBjbGVhbmVkKTtcbiAgICAgICAgaWYgKGlzSW50ZXJuYWxTZXJ2ZXJFcnJvcihjbGVhbmVkKSkge1xuICAgICAgICAgICAgY2xlYW5lZCA9IGNyZWF0ZUVycm9yKDUwMCwgJ1NlcnZpY2UgdGVtcG9yYXJ5IHVuYXZhaWxhYmxlJyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgY2xlYW5lZDtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSZWdpc3RyeU1hcDxUPiB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGl0ZW1zOiBNYXA8bnVtYmVyLCBUPjtcbiAgICBsYXN0SWQ6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKG5hbWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICB0aGlzLmxhc3RJZCA9IDA7XG4gICAgICAgIHRoaXMuaXRlbXMgPSBuZXcgTWFwKCk7XG4gICAgfVxuXG4gICAgYWRkKGl0ZW06IFQpOiBudW1iZXIge1xuICAgICAgICBsZXQgaWQgPSB0aGlzLmxhc3RJZDtcbiAgICAgICAgZG8ge1xuICAgICAgICAgICAgaWQgPSBpZCA8IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSID8gaWQgKyAxIDogMTtcbiAgICAgICAgfSB3aGlsZSAodGhpcy5pdGVtcy5oYXMoaWQpKTtcbiAgICAgICAgdGhpcy5sYXN0SWQgPSBpZDtcbiAgICAgICAgdGhpcy5pdGVtcy5zZXQoaWQsIGl0ZW0pO1xuICAgICAgICByZXR1cm4gaWQ7XG4gICAgfVxuXG4gICAgcmVtb3ZlKGlkOiBudW1iZXIpIHtcbiAgICAgICAgaWYgKCF0aGlzLml0ZW1zLmRlbGV0ZShpZCkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byByZW1vdmUgJHt0aGlzLm5hbWV9OiBpdGVtIHdpdGggaWQgWyR7aWR9XSBkb2VzIG5vdCBleGlzdHNgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGVudHJpZXMoKTogW251bWJlciwgVF1bXSB7XG4gICAgICAgIHJldHVybiBbLi4udGhpcy5pdGVtcy5lbnRyaWVzKCldO1xuICAgIH1cblxuICAgIHZhbHVlcygpOiBUW10ge1xuICAgICAgICByZXR1cm4gWy4uLnRoaXMuaXRlbXMudmFsdWVzKCldO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRvTG9nKHZhbHVlOiBhbnksIG9ianM/OiBPYmplY3RbXSk6IGFueSB7XG4gICAgY29uc3QgdHlwZU9mID0gdHlwZW9mIHZhbHVlO1xuICAgIHN3aXRjaCAodHlwZU9mKSB7XG4gICAgY2FzZSBcInVuZGVmaW5lZFwiOlxuICAgIGNhc2UgXCJib29sZWFuXCI6XG4gICAgY2FzZSBcIm51bWJlclwiOlxuICAgIGNhc2UgXCJiaWdpbnRcIjpcbiAgICBjYXNlIFwic3ltYm9sXCI6XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICBjYXNlIFwic3RyaW5nXCI6XG4gICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPiA4MCkge1xuICAgICAgICAgICAgcmV0dXJuIGAke3ZhbHVlLnN1YnN0cigwLCA1MCl94oCmIFske3ZhbHVlLmxlbmd0aH1dYFxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICBjYXNlIFwiZnVuY3Rpb25cIjpcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICBkZWZhdWx0OlxuICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAob2JqcyAmJiBvYmpzLmluY2x1ZGVzKHZhbHVlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBuZXdPYmpzID0gb2JqcyA/IFsuLi5vYmpzLCB2YWx1ZV0gOiBbdmFsdWVdO1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5tYXAoeCA9PiB0b0xvZyh4LCBuZXdPYmpzKSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdmFsdWVUb0xvZzogeyBbc3RyaW5nXTogYW55IH0gPSB7fTtcbiAgICAgICAgT2JqZWN0LmVudHJpZXModmFsdWUpLmZvckVhY2goKFtuLCB2XSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcHJvcGVydHlWYWx1ZVRvTG9nID0gdG9Mb2codiwgbmV3T2Jqcyk7XG4gICAgICAgICAgICBpZiAocHJvcGVydHlWYWx1ZVRvTG9nICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZVRvTG9nW25dID0gcHJvcGVydHlWYWx1ZVRvTG9nO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHZhbHVlVG9Mb2dcbiAgICB9XG59XG4iXX0=