"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.cleanError = cleanError;
exports.wrap = wrap;
exports.parseSelectionSet = parseSelectionSet;
exports.selectionToString = selectionToString;
exports.selectFields = selectFields;
exports.toLog = toLog;
exports.RegistryMap = void 0;

function cleanError(err) {
  delete err.response;
  return err.ArangoError || err;
}

async function wrap(log, op, args, fetch) {
  try {
    return await fetch();
  } catch (err) {
    const cleaned = cleanError(err);
    log.error('FAILED', op, args, cleaned.message || err.toString());
    throw cleaned;
  }
}

class RegistryMap {
  constructor(name) {
    this.name = name;
    this.lastId = 0;
    this.items = new Map();
  }

  add(item) {
    let id = this.lastId;

    do {
      id = id < Number.MAX_SAFE_INTEGER ? id + 1 : 1;
    } while (this.items.has(id));

    this.lastId = id;
    this.items.set(id, item);
    return id;
  }

  remove(id) {
    if (!this.items.delete(id)) {
      console.error(`Failed to remove ${this.name}: item with id [${id}] does not exists`);
    }
  }

  entries() {
    return [...this.items.entries()];
  }

  values() {
    return [...this.items.values()];
  }

}

exports.RegistryMap = RegistryMap;

function parseSelectionSet(selectionSet, returnFieldSelection) {
  const fields = [];
  const selections = selectionSet && selectionSet.selections;

  if (selections) {
    for (const item of selections) {
      const name = item.name && item.name.value || '';

      if (name) {
        const field = {
          name,
          selection: parseSelectionSet(item.selectionSet, '')
        };

        if (returnFieldSelection !== '' && field.name === returnFieldSelection) {
          return field.selection;
        }

        fields.push(field);
      }
    }
  }

  return fields;
}

function selectionToString(selection) {
  return selection.filter(x => x.name !== '__typename').map(field => {
    const fieldSelection = selectionToString(field.selection);
    return `${field.name}${fieldSelection !== '' ? ` { ${fieldSelection} }` : ''}`;
  }).join(' ');
}

function selectFields(doc, selection) {
  if (selection.length === 0) {
    return doc;
  }

  const selected = {};

  if (doc._key) {
    selected._key = doc._key;
    selected.id = doc._key;
  }

  for (const item of selection) {
    const onField = {
      in_message: 'in_msg',
      out_messages: 'out_msg',
      signatures: 'id'
    }[item.name];

    if (onField !== undefined && doc[onField] !== undefined) {
      selected[onField] = doc[onField];
    }

    const value = doc[item.name];

    if (value !== undefined) {
      selected[item.name] = item.selection.length > 0 ? selectFields(value, item.selection) : value;
    }
  }

  return selected;
}

function toLog(value) {
  const typeOf = typeof value;

  switch (typeOf) {
    case "undefined":
    case "boolean":
    case "number":
    case "bigint":
    case "symbol":
      return value;

    case "string":
      if (value.length > 80) {
        return `${value.substr(0, 50)}â€¦ [${value.length}]`;
      }

      return value;

    case "function":
      return undefined;

    default:
      if (value === null) {
        return value;
      }

      if (Array.isArray(value)) {
        return value.map(toLog);
      }

      const valueToLog = {};
      Object.entries(value).forEach(([n, v]) => {
        const propertyValueToLog = toLog(v);

        if (propertyValueToLog !== undefined) {
          valueToLog[n] = propertyValueToLog;
        }
      });
      return valueToLog;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci91dGlscy5qcyJdLCJuYW1lcyI6WyJjbGVhbkVycm9yIiwiZXJyIiwicmVzcG9uc2UiLCJBcmFuZ29FcnJvciIsIndyYXAiLCJsb2ciLCJvcCIsImFyZ3MiLCJmZXRjaCIsImNsZWFuZWQiLCJlcnJvciIsIm1lc3NhZ2UiLCJ0b1N0cmluZyIsIlJlZ2lzdHJ5TWFwIiwiY29uc3RydWN0b3IiLCJuYW1lIiwibGFzdElkIiwiaXRlbXMiLCJNYXAiLCJhZGQiLCJpdGVtIiwiaWQiLCJOdW1iZXIiLCJNQVhfU0FGRV9JTlRFR0VSIiwiaGFzIiwic2V0IiwicmVtb3ZlIiwiZGVsZXRlIiwiY29uc29sZSIsImVudHJpZXMiLCJ2YWx1ZXMiLCJwYXJzZVNlbGVjdGlvblNldCIsInNlbGVjdGlvblNldCIsInJldHVybkZpZWxkU2VsZWN0aW9uIiwiZmllbGRzIiwic2VsZWN0aW9ucyIsInZhbHVlIiwiZmllbGQiLCJzZWxlY3Rpb24iLCJwdXNoIiwic2VsZWN0aW9uVG9TdHJpbmciLCJmaWx0ZXIiLCJ4IiwibWFwIiwiZmllbGRTZWxlY3Rpb24iLCJqb2luIiwic2VsZWN0RmllbGRzIiwiZG9jIiwibGVuZ3RoIiwic2VsZWN0ZWQiLCJfa2V5Iiwib25GaWVsZCIsImluX21lc3NhZ2UiLCJvdXRfbWVzc2FnZXMiLCJzaWduYXR1cmVzIiwidW5kZWZpbmVkIiwidG9Mb2ciLCJ0eXBlT2YiLCJzdWJzdHIiLCJBcnJheSIsImlzQXJyYXkiLCJ2YWx1ZVRvTG9nIiwiT2JqZWN0IiwiZm9yRWFjaCIsIm4iLCJ2IiwicHJvcGVydHlWYWx1ZVRvTG9nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBRU8sU0FBU0EsVUFBVCxDQUFvQkMsR0FBcEIsRUFBbUM7QUFDdEMsU0FBT0EsR0FBRyxDQUFDQyxRQUFYO0FBQ0EsU0FBT0QsR0FBRyxDQUFDRSxXQUFKLElBQW1CRixHQUExQjtBQUNIOztBQUVNLGVBQWVHLElBQWYsQ0FBdUJDLEdBQXZCLEVBQWtD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QUQsRUFBSUMsQ0FBSixDQUFELEtBQVk7QUFDdEMsY0FBTUMsa0JBQWtCLEdBQUdWLEtBQUssQ0FBQ1MsQ0FBRCxDQUFoQzs7QUFDQSxZQUFJQyxrQkFBa0IsS0FBS1gsU0FBM0IsRUFBc0M7QUFDbENNLFVBQUFBLFVBQVUsQ0FBQ0csQ0FBRCxDQUFWLEdBQWdCRSxrQkFBaEI7QUFDSDtBQUNKLE9BTEQ7QUFNQSxhQUFPTCxVQUFQO0FBNUJKO0FBOEJIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBRTG9nIH0gZnJvbSAnLi9sb2dzJztcblxuZXhwb3J0IGZ1bmN0aW9uIGNsZWFuRXJyb3IoZXJyOiBhbnkpOiBhbnkge1xuICAgIGRlbGV0ZSBlcnIucmVzcG9uc2U7XG4gICAgcmV0dXJuIGVyci5BcmFuZ29FcnJvciB8fCBlcnI7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3cmFwPFI+KGxvZzogUUxvZywgb3A6IHN0cmluZywgYXJnczogYW55LCBmZXRjaDogKCkgPT4gUHJvbWlzZTxSPikge1xuICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBmZXRjaCgpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBjb25zdCBjbGVhbmVkID0gY2xlYW5FcnJvcihlcnIpO1xuICAgICAgICBsb2cuZXJyb3IoJ0ZBSUxFRCcsIG9wLCBhcmdzLCBjbGVhbmVkLm1lc3NhZ2UgfHwgZXJyLnRvU3RyaW5nKCkpO1xuICAgICAgICB0aHJvdyBjbGVhbmVkO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFJlZ2lzdHJ5TWFwPFQ+IHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgaXRlbXM6IE1hcDxudW1iZXIsIFQ+O1xuICAgIGxhc3RJZDogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3IobmFtZTogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHRoaXMubGFzdElkID0gMDtcbiAgICAgICAgdGhpcy5pdGVtcyA9IG5ldyBNYXAoKTtcbiAgICB9XG5cbiAgICBhZGQoaXRlbTogVCk6IG51bWJlciB7XG4gICAgICAgIGxldCBpZCA9IHRoaXMubGFzdElkO1xuICAgICAgICBkbyB7XG4gICAgICAgICAgICBpZCA9IGlkIDwgTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIgPyBpZCArIDEgOiAxO1xuICAgICAgICB9IHdoaWxlICh0aGlzLml0ZW1zLmhhcyhpZCkpO1xuICAgICAgICB0aGlzLmxhc3RJZCA9IGlkO1xuICAgICAgICB0aGlzLml0ZW1zLnNldChpZCwgaXRlbSk7XG4gICAgICAgIHJldHVybiBpZDtcbiAgICB9XG5cbiAgICByZW1vdmUoaWQ6IG51bWJlcikge1xuICAgICAgICBpZiAoIXRoaXMuaXRlbXMuZGVsZXRlKGlkKSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIHJlbW92ZSAke3RoaXMubmFtZX06IGl0ZW0gd2l0aCBpZCBbJHtpZH1dIGRvZXMgbm90IGV4aXN0c2ApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZW50cmllcygpOiBbbnVtYmVyLCBUXVtdIHtcbiAgICAgICAgcmV0dXJuIFsuLi50aGlzLml0ZW1zLmVudHJpZXMoKV07XG4gICAgfVxuXG4gICAgdmFsdWVzKCk6IFRbXSB7XG4gICAgICAgIHJldHVybiBbLi4udGhpcy5pdGVtcy52YWx1ZXMoKV07XG4gICAgfVxufVxuXG5leHBvcnQgdHlwZSBGaWVsZFNlbGVjdGlvbiA9IHtcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgc2VsZWN0aW9uOiBGaWVsZFNlbGVjdGlvbltdLFxufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VTZWxlY3Rpb25TZXQoc2VsZWN0aW9uU2V0OiBhbnksIHJldHVybkZpZWxkU2VsZWN0aW9uOiBzdHJpbmcpOiBGaWVsZFNlbGVjdGlvbltdIHtcbiAgICBjb25zdCBmaWVsZHM6IEZpZWxkU2VsZWN0aW9uW10gPSBbXTtcbiAgICBjb25zdCBzZWxlY3Rpb25zID0gc2VsZWN0aW9uU2V0ICYmIHNlbGVjdGlvblNldC5zZWxlY3Rpb25zO1xuICAgIGlmIChzZWxlY3Rpb25zKSB7XG4gICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBzZWxlY3Rpb25zKSB7XG4gICAgICAgICAgICBjb25zdCBuYW1lID0gKGl0ZW0ubmFtZSAmJiBpdGVtLm5hbWUudmFsdWUpIHx8ICcnO1xuICAgICAgICAgICAgaWYgKG5hbWUpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaWVsZDogRmllbGRTZWxlY3Rpb24gPSB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGlvbjogcGFyc2VTZWxlY3Rpb25TZXQoaXRlbS5zZWxlY3Rpb25TZXQsICcnKSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGlmIChyZXR1cm5GaWVsZFNlbGVjdGlvbiAhPT0gJycgJiYgZmllbGQubmFtZSA9PT0gcmV0dXJuRmllbGRTZWxlY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpZWxkLnNlbGVjdGlvbjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZmllbGRzLnB1c2goZmllbGQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmaWVsZHM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZWxlY3Rpb25Ub1N0cmluZyhzZWxlY3Rpb246IEZpZWxkU2VsZWN0aW9uW10pOiBzdHJpbmcge1xuICAgIHJldHVybiBzZWxlY3Rpb25cbiAgICAgICAgLmZpbHRlcih4ID0+IHgubmFtZSAhPT0gJ19fdHlwZW5hbWUnKVxuICAgICAgICAubWFwKChmaWVsZDogRmllbGRTZWxlY3Rpb24pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGZpZWxkU2VsZWN0aW9uID0gc2VsZWN0aW9uVG9TdHJpbmcoZmllbGQuc2VsZWN0aW9uKTtcbiAgICAgICAgICAgIHJldHVybiBgJHtmaWVsZC5uYW1lfSR7ZmllbGRTZWxlY3Rpb24gIT09ICcnID8gYCB7ICR7ZmllbGRTZWxlY3Rpb259IH1gIDogJyd9YDtcbiAgICAgICAgfSkuam9pbignICcpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2VsZWN0RmllbGRzKGRvYzogYW55LCBzZWxlY3Rpb246IEZpZWxkU2VsZWN0aW9uW10pOiBhbnkge1xuICAgIGlmIChzZWxlY3Rpb24ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBkb2M7XG4gICAgfVxuICAgIGNvbnN0IHNlbGVjdGVkOiBhbnkgPSB7fTtcbiAgICBpZiAoZG9jLl9rZXkpIHtcbiAgICAgICAgc2VsZWN0ZWQuX2tleSA9IGRvYy5fa2V5O1xuICAgICAgICBzZWxlY3RlZC5pZCA9IGRvYy5fa2V5O1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2Ygc2VsZWN0aW9uKSB7XG4gICAgICAgIGNvbnN0IG9uRmllbGQgPSB7XG4gICAgICAgICAgICBpbl9tZXNzYWdlOiAnaW5fbXNnJyxcbiAgICAgICAgICAgIG91dF9tZXNzYWdlczogJ291dF9tc2cnLFxuICAgICAgICAgICAgc2lnbmF0dXJlczogJ2lkJyxcbiAgICAgICAgfVtpdGVtLm5hbWVdO1xuICAgICAgICBpZiAob25GaWVsZCAhPT0gdW5kZWZpbmVkICYmIGRvY1tvbkZpZWxkXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBzZWxlY3RlZFtvbkZpZWxkXSA9IGRvY1tvbkZpZWxkXTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB2YWx1ZSA9IGRvY1tpdGVtLm5hbWVdO1xuICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgc2VsZWN0ZWRbaXRlbS5uYW1lXSA9IGl0ZW0uc2VsZWN0aW9uLmxlbmd0aCA+IDBcbiAgICAgICAgICAgICAgICA/IHNlbGVjdEZpZWxkcyh2YWx1ZSwgaXRlbS5zZWxlY3Rpb24pXG4gICAgICAgICAgICAgICAgOiB2YWx1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gc2VsZWN0ZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0b0xvZyh2YWx1ZTogYW55KTogYW55IHtcbiAgICBjb25zdCB0eXBlT2YgPSB0eXBlb2YgdmFsdWU7XG4gICAgc3dpdGNoICh0eXBlT2YpIHtcbiAgICBjYXNlIFwidW5kZWZpbmVkXCI6XG4gICAgY2FzZSBcImJvb2xlYW5cIjpcbiAgICBjYXNlIFwibnVtYmVyXCI6XG4gICAgY2FzZSBcImJpZ2ludFwiOlxuICAgIGNhc2UgXCJzeW1ib2xcIjpcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIGNhc2UgXCJzdHJpbmdcIjpcbiAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCA+IDgwKSB7XG4gICAgICAgICAgICByZXR1cm4gYCR7dmFsdWUuc3Vic3RyKDAsIDUwKX3igKYgWyR7dmFsdWUubGVuZ3RofV1gXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIGNhc2UgXCJmdW5jdGlvblwiOlxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIGRlZmF1bHQ6XG4gICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlLm1hcCh0b0xvZyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdmFsdWVUb0xvZzogeyBbc3RyaW5nXTogYW55IH0gPSB7fTtcbiAgICAgICAgT2JqZWN0LmVudHJpZXModmFsdWUpLmZvckVhY2goKFtuLCB2XSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcHJvcGVydHlWYWx1ZVRvTG9nID0gdG9Mb2codik7XG4gICAgICAgICAgICBpZiAocHJvcGVydHlWYWx1ZVRvTG9nICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZVRvTG9nW25dID0gcHJvcGVydHlWYWx1ZVRvTG9nO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHZhbHVlVG9Mb2dcbiAgICB9XG59XG4iXX0=