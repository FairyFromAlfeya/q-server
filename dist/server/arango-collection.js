"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Collection = void 0;

var _arangojs = require("arangojs");

var _opentracing = require("opentracing");

var _arangoListeners = require("./arango-listeners");

var _logs = _interopRequireDefault(require("./logs"));

var _auth = require("./auth");

var _dbTypes = require("./db-types");

var _tracer = require("./tracer");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const accessGranted = {
  granted: true,
  restrictToAccounts: []
};

class Collection {
  constructor(name, docType, logs, auth, tracer, db, slowDb) {
    this.name = name;
    this.docType = docType;
    this.log = logs.create(name);
    this.auth = auth;
    this.tracer = tracer;
    this.db = db;
    this.slowDb = slowDb;
    this.listeners = new _utils.RegistryMap(`${name} listeners`);
    this.queryStats = new Map();
    this.maxQueueSize = 0;
  } // Subscriptions


  onDocumentInsertOrUpdate(doc) {
    for (const listener of this.listeners.values()) {
      if (listener.isFiltered(doc)) {
        listener.onDocumentInsertOrUpdate(doc);
      }
    }
  }

  subscriptionResolver() {
    return {
      subscribe: async (_, args, context, info) => {
        const accessRights = await this.auth.requireGrantedAccess(context.accessKey || args.accessKey);
        return new _arangoListeners.SubscriptionListener(this.name, this.docType, this.listeners, accessRights, args.filter || {}, (0, _utils.parseSelectionSet)(info.operation.selectionSet, this.name));
      }
    };
  } // Queries


  getAdditionalCondition(accessRights, params) {
    const accounts = accessRights.restrictToAccounts;

    if (accounts.length === 0) {
      return '';
    }

    const condition = accounts.length === 1 ? `== @${params.add(accounts[0])}` : `IN [${accounts.map(x => `@${params.add(x)}`).join(',')}]`;

    switch (this.name) {
      case 'accounts':
        return `doc._key ${condition}`;

      case 'transactions':
        return `doc.account_addr ${condition}`;

      case 'messages':
        return `(doc.src ${condition}) OR (doc.dst ${condition})`;

      default:
        return 'false';
    }
  }

  createDatabaseQuery(args, selectionInfo, accessRights) {
    const filter = args.filter || {};
    const params = new _dbTypes.QParams();
    const primaryCondition = Object.keys(filter).length > 0 ? this.docType.ql(params, 'doc', filter) : '';
    const additionalCondition = this.getAdditionalCondition(accessRights, params);

    if (primaryCondition === 'false' || additionalCondition === 'false') {
      return null;
    }

    let condition = primaryCondition && additionalCondition ? `(${primaryCondition}) AND (${additionalCondition})` : primaryCondition || additionalCondition;
    const filterSection = condition ? `FILTER ${condition}` : '';
    const selection = (0, _utils.parseSelectionSet)(selectionInfo, this.name);
    const orderBy = args.orderBy || [];
    const limit = args.limit || 50;
    const timeout = Number(args.timeout) || 0;
    const orderByText = orderBy.map(field => {
      const direction = field.direction && field.direction.toLowerCase() === 'desc' ? ' DESC' : '';
      return `doc.${field.path.replace(/\bid\b/gi, '_key')}${direction}`;
    }).join(', ');
    const sortSection = orderByText !== '' ? `SORT ${orderByText}` : '';
    const limitText = Math.min(limit, 50);
    const limitSection = `LIMIT ${limitText}`;
    const text = `
            FOR doc IN ${this.name}
            ${filterSection}
            ${sortSection}
            ${limitSection}
            RETURN doc`;
    return {
      filter,
      selection,
      orderBy,
      limit,
      timeout,
      text,
      params: params.values,
      accessRights
    };
  }

  async ensureQueryStat(q) {
    const existing = this.queryStats.get(q.text);

    if (existing !== undefined) {
      return existing;
    }

    const plan = (await this.db.explain(q.text, q.params)).plan;
    const stat = {
      estimatedCost: plan.estimatedCost,
      slow: false,
      times: []
    };

    if (plan.nodes.find(node => node.type === 'EnumerateCollectionNode')) {
      stat.slow = true;
    }

    this.queryStats.set(q.text, stat);
    return stat;
  }

  queryResolver() {
    return async (parent, args, context, info) => (0, _utils.wrap)(this.log, 'QUERY', args, async () => {
      const accessRights = await context.auth.requireGrantedAccess(context.accessKey || args.accessKey);
      const q = this.createDatabaseQuery(args, info.operation.selectionSet, accessRights);

      if (!q) {
        this.log.debug('QUERY', args, 0, 'SKIPPED', context.remoteAddress);
        return [];
      }

      const stat = await this.ensureQueryStat(q);
      const start = Date.now();
      const result = q.timeout > 0 ? await this.queryWaitFor(q, stat, context.parentSpan) : await this.query(q, stat, context.parentSpan);
      this.log.debug('QUERY', args, (Date.now() - start) / 1000, stat.slow ? 'SLOW' : 'FAST', context.remoteAddress);
      return result;
    });
  }

  static setQueryTraceParams(q, span) {
    const params = {
      filter: q.filter,
      selection: (0, _utils.selectionToString)(q.selection)
    };

    if (q.orderBy.length > 0) {
      params.orderBy = q.orderBy;
    }

    if (q.limit !== 50) {
      params.limit = q.limit;
    }

    if (q.timeout > 0) {
      params.timeout = q.timeout;
    }

    span.setTag('params', params);
  }

  async query(q, stat, parentSpan) {
    return _tracer.QTracer.trace(this.tracer, `${this.name}.query`, async span => {
      Collection.setQueryTraceParams(q, span);
      return this.queryDatabase(q, stat);
    }, parentSpan);
  }

  async queryDatabase(q, stat) {
    const db = stat && stat.slow ? this.slowDb : this.db;
    const start = Date.now();
    const cursor = await db.query(q.text, q.params);
    const result = await cursor.all();

    if (stat) {
      stat.times.push(Date.now() - start);

      if (stat.times.length > 100) {
        stat.times.shift();
      }
    }

    return result;
  }

  async queryWaitFor(q, stat, parentSpan) {
    return _tracer.QTracer.trace(this.tracer, `${this.name}.waitFor`, async span => {
      Collection.setQueryTraceParams(q, span);
      let waitFor = null;
      let forceTimerId = null;
      let resolvedBy = null;

      try {
        const onQuery = new Promise((resolve, reject) => {
          const check = () => {
            this.queryDatabase(q, stat).then(docs => {
              if (!resolvedBy) {
                if (docs.length > 0) {
                  forceTimerId = null;
                  resolvedBy = 'query';
                  resolve(docs);
                } else {
                  forceTimerId = setTimeout(check, 5000);
                }
              }
            }, reject);
          };

          check();
        });
        const onChangesFeed = new Promise(resolve => {
          waitFor = new _arangoListeners.WaitForListener(this.name, this.docType, this.listeners, q.accessRights, q.filter, q.selection, doc => {
            if (!resolvedBy) {
              resolvedBy = 'listener';
              resolve([doc]);
            }
          });
        });
        const onTimeout = new Promise(resolve => {
          setTimeout(() => {
            if (!resolvedBy) {
              resolvedBy = 'timeout';
              resolve([]);
            }
          }, q.timeout);
        });
        const result = await Promise.race([onQuery, onChangesFeed, onTimeout]);
        span.setTag('resolved', resolvedBy);
        return result;
      } finally {
        if (waitFor !== null && waitFor !== undefined) {
          waitFor.close();
          waitFor = null;
        }

        if (forceTimerId !== null) {
          clearTimeout(forceTimerId);
          forceTimerId = null;
        }
      }
    }, parentSpan);
  }

  dbCollection() {
    return this.db.collection(this.name);
  }

  async waitForDoc(key) {
    if (!key) {
      return Promise.resolve(null);
    }

    const docs = await this.queryWaitFor({
      filter: {
        id: {
          eq: key
        }
      },
      selection: [],
      orderBy: [],
      limit: 1,
      timeout: 40000,
      text: `FOR doc IN ${this.name} FILTER doc._key == @key RETURN doc`,
      params: {
        key
      },
      accessRights: accessGranted
    }, null, null);
    return docs[0];
  }

  async waitForDocs(keys) {
    if (!keys || keys.length === 0) {
      return Promise.resolve([]);
    }

    return Promise.all(keys.map(key => this.waitForDoc(key)));
  }

}

exports.Collection = Collection;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hcmFuZ28tY29sbGVjdGlvbi5qcyJdLCJuYW1lcyI6WyJhY2Nlc3NHcmFudGVkIiwiZ3JhbnRlZCIsInJlc3RyaWN0VG9BY2NvdW50cyIsIkNvbGxlY3Rpb24iLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJkb2NUeXBlIiwibG9ncyIsImF1dGgiLCJ0cmFjZXIiLCJkYiIsInNsb3dEYiIsImxvZyIsImNyZWF0ZSIsImxpc3RlbmVycyIsIlJlZ2lzdHJ5TWFwIiwicXVlcnlTdGF0cyIsIk1hcCIsIm1heFF1ZXVlU2l6ZSIsIm9uRG9jdW1lbnRJbnNlcnRPclVwZGF0ZSIsImRvYyIsImxpc3RlbmVyIiwidmFsdWVzIiwiaXNGaWx0ZXJlZCIsInN1YnNjcmlwdGlvblJlc29sdmVyIiwic3Vic2NyaWJlIiwiXyIsImFyZ3MiLCJjb250ZXh0IiwiaW5mbyIsImFjY2Vzc1JpZ2h0cyIsInJlcXVpcmVHcmFudGVkQWNjZXNzIiwiYWNjZXNzS2V5IiwiU3Vic2NyaXB0aW9uTGlzdGVuZXIiLCJmaWx0ZXIiLCJvcGVyYXRpb24iLCJzZWxlY3Rpb25TZXQiLCJnZXRBZGRpdGlvbmFsQ29uZGl0aW9uIiwicGFyYW1zIiwiYWNjb3VudHMiLCJsZW5ndGgiLCJjb25kaXRpb24iLCJhZGQiLCJtYXAiLCJ4Iiwiam9pbiIsImNyZWF0ZURhdGFiYXNlUXVlcnkiLCJzZWxlY3Rpb25JbmZvIiwiUVBhcmFtcyIsInByaW1hcnlDb25kaXRpb24iLCJPYmplY3QiLCJrZXlzIiwicWwiLCJhZGRpdGlvbmFsQ29uZGl0aW9uIiwiZmlsdGVyU2VjdGlvbiIsInNlbGVjdGlvbiIsIm9yZGVyQnkiLCJsaW1pdCIsInRpbWVvdXQiLCJOdW1iZXIiLCJvcmRlckJ5VGV4dCIsImZpZWxkIiwiZGlyZWN0aW9uIiwidG9Mb3dlckNhc2UiLCJwYXRoIiwicmVwbGFjZSIsInNvcnRTZWN0aW9uIiwibGltaXRUZXh0IiwiTWF0aCIsIm1pbiIsImxpbWl0U2VjdGlvbiIsInRleHQiLCJlbnN1cmVRdWVyeVN0YXQiLCJxIiwiZXhpc3RpbmciLCJnZXQiLCJ1bmRlZmluZWQiLCJwbGFuIiwiZXhwbGFpbiIsInN0YXQiLCJlc3RpbWF0ZWRDb3N0Iiwic2xvdyIsInRpbWVzIiwibm9kZXMiLCJmaW5kIiwibm9kZSIsInR5cGUiLCJzZXQiLCJxdWVyeVJlc29sdmVyIiwicGFyZW50IiwiZGVidWciLCJyZW1vdGVBZGRyZXNzIiwic3RhcnQiLCJEYXRlIiwibm93IiwicmVzdWx0IiwicXVlcnlXYWl0Rm9yIiwicGFyZW50U3BhbiIsInF1ZXJ5Iiwic2V0UXVlcnlUcmFjZVBhcmFtcyIsInNwYW4iLCJzZXRUYWciLCJRVHJhY2VyIiwidHJhY2UiLCJxdWVyeURhdGFiYXNlIiwiY3Vyc29yIiwiYWxsIiwicHVzaCIsInNoaWZ0Iiwid2FpdEZvciIsImZvcmNlVGltZXJJZCIsInJlc29sdmVkQnkiLCJvblF1ZXJ5IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJjaGVjayIsInRoZW4iLCJkb2NzIiwic2V0VGltZW91dCIsIm9uQ2hhbmdlc0ZlZWQiLCJXYWl0Rm9yTGlzdGVuZXIiLCJvblRpbWVvdXQiLCJyYWNlIiwiY2xvc2UiLCJjbGVhclRpbWVvdXQiLCJkYkNvbGxlY3Rpb24iLCJjb2xsZWN0aW9uIiwid2FpdEZvckRvYyIsImtleSIsImlkIiwiZXEiLCJ3YWl0Rm9yRG9jcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQWtCQTs7QUFDQTs7QUFFQTs7QUFHQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUFFQTs7OztBQS9CQTs7Ozs7Ozs7Ozs7Ozs7O0FBcUVBLE1BQU1BLGFBQTJCLEdBQUc7QUFDaENDLEVBQUFBLE9BQU8sRUFBRSxJQUR1QjtBQUVoQ0MsRUFBQUEsa0JBQWtCLEVBQUU7QUFGWSxDQUFwQzs7QUFLTyxNQUFNQyxVQUFOLENBQWlCO0FBZXBCQyxFQUFBQSxXQUFXLENBQ1BDLElBRE8sRUFFUEMsT0FGTyxFQUdQQyxJQUhPLEVBSVBDLElBSk8sRUFLUEMsTUFMTyxFQU1QQyxF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VUFBTCxDQUFnQkMsR0FBaEIsQ0FBaEIsQ0FBWixDQUFQO0FBQ0g7O0FBOVVtQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAxOC0yMDIwIFRPTiBERVYgU09MVVRJT05TIExURC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgU09GVFdBUkUgRVZBTFVBVElPTiBMaWNlbnNlICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2VcbiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZVxuICogTGljZW5zZSBhdDpcbiAqXG4gKiBodHRwOi8vd3d3LnRvbi5kZXYvbGljZW5zZXNcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIFRPTiBERVYgc29mdHdhcmUgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuLy8gQGZsb3dcblxuaW1wb3J0IHsgRGF0YWJhc2UsIERvY3VtZW50Q29sbGVjdGlvbiB9IGZyb20gXCJhcmFuZ29qc1wiO1xuaW1wb3J0IHsgU3BhbiwgU3BhbkNvbnRleHQsIFRyYWNlciB9IGZyb20gXCJvcGVudHJhY2luZ1wiO1xuaW1wb3J0IHR5cGUgeyBUT05DbGllbnQgfSBmcm9tIFwidG9uLWNsaWVudC1qcy90eXBlc1wiO1xuaW1wb3J0IHsgQ29sbGVjdGlvbkxpc3RlbmVyLCBTdWJzY3JpcHRpb25MaXN0ZW5lciwgV2FpdEZvckxpc3RlbmVyIH0gZnJvbSBcIi4vYXJhbmdvLWxpc3RlbmVyc1wiO1xuaW1wb3J0IHR5cGUgeyBRQ29uZmlnIH0gZnJvbSBcIi4vY29uZmlnXCI7XG5pbXBvcnQgdHlwZSB7IFFMb2cgfSBmcm9tIFwiLi9sb2dzXCI7XG5pbXBvcnQgUUxvZ3MgZnJvbSBcIi4vbG9nc1wiO1xuaW1wb3J0IHR5cGUgeyBBY2Nlc3NSaWdodHMgfSBmcm9tIFwiLi9hdXRoXCI7XG5pbXBvcnQgeyBBdXRoIH0gZnJvbSBcIi4vYXV0aFwiO1xuaW1wb3J0IHR5cGUgeyBRVHlwZSB9IGZyb20gXCIuL2RiLXR5cGVzXCI7XG5pbXBvcnQgeyBRUGFyYW1zIH0gZnJvbSBcIi4vZGItdHlwZXNcIjtcbmltcG9ydCB7IFFUcmFjZXIgfSBmcm9tIFwiLi90cmFjZXJcIjtcbmltcG9ydCB0eXBlIHsgRmllbGRTZWxlY3Rpb24gfSBmcm9tIFwiLi91dGlsc1wiO1xuaW1wb3J0IHsgcGFyc2VTZWxlY3Rpb25TZXQsIFJlZ2lzdHJ5TWFwLCBzZWxlY3Rpb25Ub1N0cmluZywgd3JhcCB9IGZyb20gXCIuL3V0aWxzXCI7XG5cblxuZXhwb3J0IHR5cGUgR3JhcGhRTFJlcXVlc3RDb250ZXh0ID0ge1xuICAgIGNvbmZpZzogUUNvbmZpZyxcbiAgICBhdXRoOiBBdXRoLFxuICAgIHRyYWNlcjogVHJhY2VyLFxuICAgIGNsaWVudDogVE9OQ2xpZW50LFxuXG4gICAgcmVtb3RlQWRkcmVzcz86IHN0cmluZyxcbiAgICBhY2Nlc3NLZXk6IHN0cmluZyxcbiAgICBwYXJlbnRTcGFuOiAoU3BhbiB8IFNwYW5Db250ZXh0IHwgdHlwZW9mIHVuZGVmaW5lZCksXG5cbiAgICBzaGFyZWQ6IE1hcDxzdHJpbmcsIGFueT4sXG59XG5cbnR5cGUgT3JkZXJCeSA9IHtcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgZGlyZWN0aW9uOiBzdHJpbmcsXG59XG5cbnR5cGUgRGF0YWJhc2VRdWVyeSA9IHtcbiAgICBmaWx0ZXI6IGFueSxcbiAgICBzZWxlY3Rpb246IEZpZWxkU2VsZWN0aW9uW10sXG4gICAgb3JkZXJCeTogT3JkZXJCeVtdLFxuICAgIGxpbWl0OiBudW1iZXIsXG4gICAgdGltZW91dDogbnVtYmVyLFxuICAgIHRleHQ6IHN0cmluZyxcbiAgICBwYXJhbXM6IHsgW3N0cmluZ106IGFueSB9LFxuICAgIGFjY2Vzc1JpZ2h0czogQWNjZXNzUmlnaHRzLFxufVxuXG5leHBvcnQgdHlwZSBRdWVyeVN0YXQgPSB7XG4gICAgZXN0aW1hdGVkQ29zdDogbnVtYmVyLFxuICAgIHNsb3c6IGJvb2xlYW4sXG4gICAgdGltZXM6IG51bWJlcltdLFxufVxuXG5jb25zdCBhY2Nlc3NHcmFudGVkOiBBY2Nlc3NSaWdodHMgPSB7XG4gICAgZ3JhbnRlZDogdHJ1ZSxcbiAgICByZXN0cmljdFRvQWNjb3VudHM6IFtdXG59O1xuXG5leHBvcnQgY2xhc3MgQ29sbGVjdGlvbiB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGRvY1R5cGU6IFFUeXBlO1xuXG4gICAgbG9nOiBRTG9nO1xuICAgIGF1dGg6IEF1dGg7XG4gICAgdHJhY2VyOiBUcmFjZXI7XG4gICAgZGI6IERhdGFiYXNlO1xuICAgIHNsb3dEYjogRGF0YWJhc2U7XG5cbiAgICBsaXN0ZW5lcnM6IFJlZ2lzdHJ5TWFwPENvbGxlY3Rpb25MaXN0ZW5lcj47XG4gICAgcXVlcnlTdGF0czogTWFwPHN0cmluZywgUXVlcnlTdGF0PjtcblxuICAgIG1heFF1ZXVlU2l6ZTogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIG5hbWU6IHN0cmluZyxcbiAgICAgICAgZG9jVHlwZTogUVR5cGUsXG4gICAgICAgIGxvZ3M6IFFMb2dzLFxuICAgICAgICBhdXRoOiBBdXRoLFxuICAgICAgICB0cmFjZXI6IFRyYWNlcixcbiAgICAgICAgZGI6IERhdGFiYXNlLFxuICAgICAgICBzbG93RGI6IERhdGFiYXNlLFxuICAgICkge1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICB0aGlzLmRvY1R5cGUgPSBkb2NUeXBlO1xuXG4gICAgICAgIHRoaXMubG9nID0gbG9ncy5jcmVhdGUobmFtZSk7XG4gICAgICAgIHRoaXMuYXV0aCA9IGF1dGg7XG4gICAgICAgIHRoaXMudHJhY2VyID0gdHJhY2VyO1xuICAgICAgICB0aGlzLmRiID0gZGI7XG4gICAgICAgIHRoaXMuc2xvd0RiID0gc2xvd0RiO1xuXG4gICAgICAgIHRoaXMubGlzdGVuZXJzID0gbmV3IFJlZ2lzdHJ5TWFwPENvbGxlY3Rpb25MaXN0ZW5lcj4oYCR7bmFtZX0gbGlzdGVuZXJzYCk7XG4gICAgICAgIHRoaXMucXVlcnlTdGF0cyA9IG5ldyBNYXA8c3RyaW5nLCBRdWVyeVN0YXQ+KCk7XG4gICAgICAgIHRoaXMubWF4UXVldWVTaXplID0gMDtcbiAgICB9XG5cbiAgICAvLyBTdWJzY3JpcHRpb25zXG5cbiAgICBvbkRvY3VtZW50SW5zZXJ0T3JVcGRhdGUoZG9jOiBhbnkpIHtcbiAgICAgICAgZm9yIChjb25zdCBsaXN0ZW5lciBvZiB0aGlzLmxpc3RlbmVycy52YWx1ZXMoKSkge1xuICAgICAgICAgICAgaWYgKGxpc3RlbmVyLmlzRmlsdGVyZWQoZG9jKSkge1xuICAgICAgICAgICAgICAgIGxpc3RlbmVyLm9uRG9jdW1lbnRJbnNlcnRPclVwZGF0ZShkb2MpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3Vic2NyaXB0aW9uUmVzb2x2ZXIoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBzdWJzY3JpYmU6IGFzeW5jIChfOiBhbnksIGFyZ3M6IHsgZmlsdGVyOiBhbnksIGFjY2Vzc0tleT86IHN0cmluZyB9LCBjb250ZXh0OiBhbnksIGluZm86IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFjY2Vzc1JpZ2h0cyA9IGF3YWl0IHRoaXMuYXV0aC5yZXF1aXJlR3JhbnRlZEFjY2VzcyhcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5hY2Nlc3NLZXkgfHwgYXJncy5hY2Nlc3NLZXlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgU3Vic2NyaXB0aW9uTGlzdGVuZXIoXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kb2NUeXBlLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxpc3RlbmVycyxcbiAgICAgICAgICAgICAgICAgICAgYWNjZXNzUmlnaHRzLFxuICAgICAgICAgICAgICAgICAgICBhcmdzLmZpbHRlciB8fCB7fSxcbiAgICAgICAgICAgICAgICAgICAgcGFyc2VTZWxlY3Rpb25TZXQoaW5mby5vcGVyYXRpb24uc2VsZWN0aW9uU2V0LCB0aGlzLm5hbWUpLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gUXVlcmllc1xuXG4gICAgZ2V0QWRkaXRpb25hbENvbmRpdGlvbihhY2Nlc3NSaWdodHM6IEFjY2Vzc1JpZ2h0cywgcGFyYW1zOiBRUGFyYW1zKSB7XG4gICAgICAgIGNvbnN0IGFjY291bnRzID0gYWNjZXNzUmlnaHRzLnJlc3RyaWN0VG9BY2NvdW50cztcbiAgICAgICAgaWYgKGFjY291bnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGNvbmRpdGlvbiA9IGFjY291bnRzLmxlbmd0aCA9PT0gMVxuICAgICAgICAgICAgPyBgPT0gQCR7cGFyYW1zLmFkZChhY2NvdW50c1swXSl9YFxuICAgICAgICAgICAgOiBgSU4gWyR7YWNjb3VudHMubWFwKHggPT4gYEAke3BhcmFtcy5hZGQoeCl9YCkuam9pbignLCcpfV1gO1xuICAgICAgICBzd2l0Y2ggKHRoaXMubmFtZSkge1xuICAgICAgICBjYXNlICdhY2NvdW50cyc6XG4gICAgICAgICAgICByZXR1cm4gYGRvYy5fa2V5ICR7Y29uZGl0aW9ufWA7XG4gICAgICAgIGNhc2UgJ3RyYW5zYWN0aW9ucyc6XG4gICAgICAgICAgICByZXR1cm4gYGRvYy5hY2NvdW50X2FkZHIgJHtjb25kaXRpb259YDtcbiAgICAgICAgY2FzZSAnbWVzc2FnZXMnOlxuICAgICAgICAgICAgcmV0dXJuIGAoZG9jLnNyYyAke2NvbmRpdGlvbn0pIE9SIChkb2MuZHN0ICR7Y29uZGl0aW9ufSlgO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgcmV0dXJuICdmYWxzZSc7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjcmVhdGVEYXRhYmFzZVF1ZXJ5KFxuICAgICAgICBhcmdzOiB7XG4gICAgICAgICAgICBmaWx0ZXI/OiBhbnksXG4gICAgICAgICAgICBvcmRlckJ5PzogT3JkZXJCeVtdLFxuICAgICAgICAgICAgbGltaXQ/OiBudW1iZXIsXG4gICAgICAgICAgICB0aW1lb3V0PzogbnVtYmVyLFxuICAgICAgICB9LFxuICAgICAgICBzZWxlY3Rpb25JbmZvOiBhbnksXG4gICAgICAgIGFjY2Vzc1JpZ2h0czogQWNjZXNzUmlnaHRzLFxuICAgICk6ID9EYXRhYmFzZVF1ZXJ5IHtcbiAgICAgICAgY29uc3QgZmlsdGVyID0gYXJncy5maWx0ZXIgfHwge307XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IG5ldyBRUGFyYW1zKCk7XG4gICAgICAgIGNvbnN0IHByaW1hcnlDb25kaXRpb24gPSBPYmplY3Qua2V5cyhmaWx0ZXIpLmxlbmd0aCA+IDBcbiAgICAgICAgICAgID8gdGhpcy5kb2NUeXBlLnFsKHBhcmFtcywgJ2RvYycsIGZpbHRlcilcbiAgICAgICAgICAgIDogJyc7XG4gICAgICAgIGNvbnN0IGFkZGl0aW9uYWxDb25kaXRpb24gPSB0aGlzLmdldEFkZGl0aW9uYWxDb25kaXRpb24oYWNjZXNzUmlnaHRzLCBwYXJhbXMpO1xuICAgICAgICBpZiAocHJpbWFyeUNvbmRpdGlvbiA9PT0gJ2ZhbHNlJyB8fCBhZGRpdGlvbmFsQ29uZGl0aW9uID09PSAnZmFsc2UnKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBsZXQgY29uZGl0aW9uID0gKHByaW1hcnlDb25kaXRpb24gJiYgYWRkaXRpb25hbENvbmRpdGlvbilcbiAgICAgICAgICAgID8gYCgke3ByaW1hcnlDb25kaXRpb259KSBBTkQgKCR7YWRkaXRpb25hbENvbmRpdGlvbn0pYFxuICAgICAgICAgICAgOiAocHJpbWFyeUNvbmRpdGlvbiB8fCBhZGRpdGlvbmFsQ29uZGl0aW9uKTtcbiAgICAgICAgY29uc3QgZmlsdGVyU2VjdGlvbiA9IGNvbmRpdGlvbiA/IGBGSUxURVIgJHtjb25kaXRpb259YCA6ICcnO1xuICAgICAgICBjb25zdCBzZWxlY3Rpb24gPSBwYXJzZVNlbGVjdGlvblNldChzZWxlY3Rpb25JbmZvLCB0aGlzLm5hbWUpO1xuICAgICAgICBjb25zdCBvcmRlckJ5OiBPcmRlckJ5W10gPSBhcmdzLm9yZGVyQnkgfHwgW107XG4gICAgICAgIGNvbnN0IGxpbWl0OiBudW1iZXIgPSBhcmdzLmxpbWl0IHx8IDUwO1xuICAgICAgICBjb25zdCB0aW1lb3V0ID0gTnVtYmVyKGFyZ3MudGltZW91dCkgfHwgMDtcbiAgICAgICAgY29uc3Qgb3JkZXJCeVRleHQgPSBvcmRlckJ5XG4gICAgICAgICAgICAubWFwKChmaWVsZCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGRpcmVjdGlvbiA9IChmaWVsZC5kaXJlY3Rpb24gJiYgZmllbGQuZGlyZWN0aW9uLnRvTG93ZXJDYXNlKCkgPT09ICdkZXNjJylcbiAgICAgICAgICAgICAgICAgICAgPyAnIERFU0MnXG4gICAgICAgICAgICAgICAgICAgIDogJyc7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGBkb2MuJHtmaWVsZC5wYXRoLnJlcGxhY2UoL1xcYmlkXFxiL2dpLCAnX2tleScpfSR7ZGlyZWN0aW9ufWA7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmpvaW4oJywgJyk7XG5cbiAgICAgICAgY29uc3Qgc29ydFNlY3Rpb24gPSBvcmRlckJ5VGV4dCAhPT0gJycgPyBgU09SVCAke29yZGVyQnlUZXh0fWAgOiAnJztcbiAgICAgICAgY29uc3QgbGltaXRUZXh0ID0gTWF0aC5taW4obGltaXQsIDUwKTtcbiAgICAgICAgY29uc3QgbGltaXRTZWN0aW9uID0gYExJTUlUICR7bGltaXRUZXh0fWA7XG5cbiAgICAgICAgY29uc3QgdGV4dCA9IGBcbiAgICAgICAgICAgIEZPUiBkb2MgSU4gJHt0aGlzLm5hbWV9XG4gICAgICAgICAgICAke2ZpbHRlclNlY3Rpb259XG4gICAgICAgICAgICAke3NvcnRTZWN0aW9ufVxuICAgICAgICAgICAgJHtsaW1pdFNlY3Rpb259XG4gICAgICAgICAgICBSRVRVUk4gZG9jYDtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZmlsdGVyLFxuICAgICAgICAgICAgc2VsZWN0aW9uLFxuICAgICAgICAgICAgb3JkZXJCeSxcbiAgICAgICAgICAgIGxpbWl0LFxuICAgICAgICAgICAgdGltZW91dCxcbiAgICAgICAgICAgIHRleHQsXG4gICAgICAgICAgICBwYXJhbXM6IHBhcmFtcy52YWx1ZXMsXG4gICAgICAgICAgICBhY2Nlc3NSaWdodHMsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgYXN5bmMgZW5zdXJlUXVlcnlTdGF0KHE6IERhdGFiYXNlUXVlcnkpOiBQcm9taXNlPFF1ZXJ5U3RhdD4ge1xuICAgICAgICBjb25zdCBleGlzdGluZyA9IHRoaXMucXVlcnlTdGF0cy5nZXQocS50ZXh0KTtcbiAgICAgICAgaWYgKGV4aXN0aW5nICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBleGlzdGluZztcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBwbGFuID0gKGF3YWl0IHRoaXMuZGIuZXhwbGFpbihxLnRleHQsIHEucGFyYW1zKSkucGxhbjtcbiAgICAgICAgY29uc3Qgc3RhdCA9IHtcbiAgICAgICAgICAgIGVzdGltYXRlZENvc3Q6IHBsYW4uZXN0aW1hdGVkQ29zdCxcbiAgICAgICAgICAgIHNsb3c6IGZhbHNlLFxuICAgICAgICAgICAgdGltZXM6IFtdLFxuICAgICAgICB9O1xuICAgICAgICBpZiAocGxhbi5ub2Rlcy5maW5kKG5vZGUgPT4gbm9kZS50eXBlID09PSAnRW51bWVyYXRlQ29sbGVjdGlvbk5vZGUnKSkge1xuICAgICAgICAgICAgc3RhdC5zbG93ID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnF1ZXJ5U3RhdHMuc2V0KHEudGV4dCwgc3RhdCk7XG4gICAgICAgIHJldHVybiBzdGF0O1xuICAgIH1cblxuICAgIHF1ZXJ5UmVzb2x2ZXIoKSB7XG4gICAgICAgIHJldHVybiBhc3luYyAoXG4gICAgICAgICAgICBwYXJlbnQ6IGFueSxcbiAgICAgICAgICAgIGFyZ3M6IGFueSxcbiAgICAgICAgICAgIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dCxcbiAgICAgICAgICAgIGluZm86IGFueVxuICAgICAgICApID0+IHdyYXAodGhpcy5sb2csICdRVUVSWScsIGFyZ3MsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGFjY2Vzc1JpZ2h0cyA9IGF3YWl0IGNvbnRleHQuYXV0aC5yZXF1aXJlR3JhbnRlZEFjY2VzcyhcbiAgICAgICAgICAgICAgICBjb250ZXh0LmFjY2Vzc0tleSB8fCBhcmdzLmFjY2Vzc0tleSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBjb25zdCBxID0gdGhpcy5jcmVhdGVEYXRhYmFzZVF1ZXJ5KGFyZ3MsIGluZm8ub3BlcmF0aW9uLnNlbGVjdGlvblNldCwgYWNjZXNzUmlnaHRzKTtcbiAgICAgICAgICAgIGlmICghcSkge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCdRVUVSWScsIGFyZ3MsIDAsICdTS0lQUEVEJywgY29udGV4dC5yZW1vdGVBZGRyZXNzKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBzdGF0ID0gYXdhaXQgdGhpcy5lbnN1cmVRdWVyeVN0YXQocSk7XG4gICAgICAgICAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBxLnRpbWVvdXQgPiAwXG4gICAgICAgICAgICAgICAgPyBhd2FpdCB0aGlzLnF1ZXJ5V2FpdEZvcihxLCBzdGF0LCBjb250ZXh0LnBhcmVudFNwYW4pXG4gICAgICAgICAgICAgICAgOiBhd2FpdCB0aGlzLnF1ZXJ5KHEsIHN0YXQsIGNvbnRleHQucGFyZW50U3Bhbik7XG4gICAgICAgICAgICB0aGlzLmxvZy5kZWJ1ZyhcbiAgICAgICAgICAgICAgICAnUVVFUlknLFxuICAgICAgICAgICAgICAgIGFyZ3MsXG4gICAgICAgICAgICAgICAgKERhdGUubm93KCkgLSBzdGFydCkgLyAxMDAwLFxuICAgICAgICAgICAgICAgIHN0YXQuc2xvdyA/ICdTTE9XJyA6ICdGQVNUJywgY29udGV4dC5yZW1vdGVBZGRyZXNzLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHN0YXRpYyBzZXRRdWVyeVRyYWNlUGFyYW1zKHE6IERhdGFiYXNlUXVlcnksIHNwYW46IFNwYW4pIHtcbiAgICAgICAgY29uc3QgcGFyYW1zOiBhbnkgPSB7XG4gICAgICAgICAgICBmaWx0ZXI6IHEuZmlsdGVyLFxuICAgICAgICAgICAgc2VsZWN0aW9uOiBzZWxlY3Rpb25Ub1N0cmluZyhxLnNlbGVjdGlvbiksXG4gICAgICAgIH07XG4gICAgICAgIGlmIChxLm9yZGVyQnkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcGFyYW1zLm9yZGVyQnkgPSBxLm9yZGVyQnk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHEubGltaXQgIT09IDUwKSB7XG4gICAgICAgICAgICBwYXJhbXMubGltaXQgPSBxLmxpbWl0O1xuICAgICAgICB9XG4gICAgICAgIGlmIChxLnRpbWVvdXQgPiAwKSB7XG4gICAgICAgICAgICBwYXJhbXMudGltZW91dCA9IHEudGltZW91dDtcbiAgICAgICAgfVxuICAgICAgICBzcGFuLnNldFRhZygncGFyYW1zJywgcGFyYW1zKTtcbiAgICB9XG5cbiAgICBhc3luYyBxdWVyeShcbiAgICAgICAgcTogRGF0YWJhc2VRdWVyeSxcbiAgICAgICAgc3RhdDogUXVlcnlTdGF0LFxuICAgICAgICBwYXJlbnRTcGFuPzogKFNwYW4gfCBTcGFuQ29udGV4dCksXG4gICAgKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIFFUcmFjZXIudHJhY2UodGhpcy50cmFjZXIsIGAke3RoaXMubmFtZX0ucXVlcnlgLCBhc3luYyAoc3BhbjogU3BhbikgPT4ge1xuICAgICAgICAgICAgQ29sbGVjdGlvbi5zZXRRdWVyeVRyYWNlUGFyYW1zKHEsIHNwYW4pO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucXVlcnlEYXRhYmFzZShxLCBzdGF0KTtcbiAgICAgICAgfSwgcGFyZW50U3Bhbik7XG4gICAgfVxuXG4gICAgYXN5bmMgcXVlcnlEYXRhYmFzZShxOiBEYXRhYmFzZVF1ZXJ5LCBzdGF0OiA/UXVlcnlTdGF0KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgZGIgPSAoc3RhdCAmJiBzdGF0LnNsb3cpID8gdGhpcy5zbG93RGIgOiB0aGlzLmRiO1xuICAgICAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7XG4gICAgICAgIGNvbnN0IGN1cnNvciA9IGF3YWl0IGRiLnF1ZXJ5KHEudGV4dCwgcS5wYXJhbXMpO1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjdXJzb3IuYWxsKCk7XG4gICAgICAgIGlmIChzdGF0KSB7XG4gICAgICAgICAgICBzdGF0LnRpbWVzLnB1c2goRGF0ZS5ub3coKSAtIHN0YXJ0KTtcbiAgICAgICAgICAgIGlmIChzdGF0LnRpbWVzLmxlbmd0aCA+IDEwMCkge1xuICAgICAgICAgICAgICAgIHN0YXQudGltZXMuc2hpZnQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuXG4gICAgYXN5bmMgcXVlcnlXYWl0Rm9yKFxuICAgICAgICBxOiBEYXRhYmFzZVF1ZXJ5LFxuICAgICAgICBzdGF0OiA/UXVlcnlTdGF0LFxuICAgICAgICBwYXJlbnRTcGFuPzogKFNwYW4gfCBTcGFuQ29udGV4dCksXG4gICAgKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIFFUcmFjZXIudHJhY2UodGhpcy50cmFjZXIsIGAke3RoaXMubmFtZX0ud2FpdEZvcmAsIGFzeW5jIChzcGFuOiBTcGFuKSA9PiB7XG4gICAgICAgICAgICBDb2xsZWN0aW9uLnNldFF1ZXJ5VHJhY2VQYXJhbXMocSwgc3Bhbik7XG4gICAgICAgICAgICBsZXQgd2FpdEZvcjogP1dhaXRGb3JMaXN0ZW5lciA9IG51bGw7XG4gICAgICAgICAgICBsZXQgZm9yY2VUaW1lcklkOiA/VGltZW91dElEID0gbnVsbDtcbiAgICAgICAgICAgIGxldCByZXNvbHZlZEJ5OiA/c3RyaW5nID0gbnVsbDtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgb25RdWVyeSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hlY2sgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5RGF0YWJhc2UocSwgc3RhdCkudGhlbigoZG9jcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVzb2x2ZWRCeSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG9jcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JjZVRpbWVySWQgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRCeSA9ICdxdWVyeSc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRvY3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yY2VUaW1lcklkID0gc2V0VGltZW91dChjaGVjaywgNV8wMDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSwgcmVqZWN0KTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgY2hlY2soKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCBvbkNoYW5nZXNGZWVkID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgd2FpdEZvciA9IG5ldyBXYWl0Rm9yTGlzdGVuZXIoXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRvY1R5cGUsXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxpc3RlbmVycyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHEuYWNjZXNzUmlnaHRzLFxuICAgICAgICAgICAgICAgICAgICAgICAgcS5maWx0ZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICBxLnNlbGVjdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgIChkb2MpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc29sdmVkQnkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRCeSA9ICdsaXN0ZW5lcic7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoW2RvY10pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGNvbnN0IG9uVGltZW91dCA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXNvbHZlZEJ5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRCeSA9ICd0aW1lb3V0JztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKFtdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSwgcS50aW1lb3V0KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBQcm9taXNlLnJhY2UoW1xuICAgICAgICAgICAgICAgICAgICBvblF1ZXJ5LFxuICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZXNGZWVkLFxuICAgICAgICAgICAgICAgICAgICBvblRpbWVvdXQsXG4gICAgICAgICAgICAgICAgXSk7XG4gICAgICAgICAgICAgICAgc3Bhbi5zZXRUYWcoJ3Jlc29sdmVkJywgcmVzb2x2ZWRCeSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICAgICAgaWYgKHdhaXRGb3IgIT09IG51bGwgJiYgd2FpdEZvciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHdhaXRGb3IuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgd2FpdEZvciA9IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChmb3JjZVRpbWVySWQgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGZvcmNlVGltZXJJZCk7XG4gICAgICAgICAgICAgICAgICAgIGZvcmNlVGltZXJJZCA9IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LCBwYXJlbnRTcGFuKTtcbiAgICB9XG5cbiAgICBkYkNvbGxlY3Rpb24oKTogRG9jdW1lbnRDb2xsZWN0aW9uIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIuY29sbGVjdGlvbih0aGlzLm5hbWUpO1xuICAgIH1cblxuICAgIGFzeW5jIHdhaXRGb3JEb2Moa2V5OiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBpZiAoIWtleSkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBkb2NzID0gYXdhaXQgdGhpcy5xdWVyeVdhaXRGb3Ioe1xuICAgICAgICAgICAgZmlsdGVyOiB7IGlkOiB7IGVxOiBrZXkgfSB9LFxuICAgICAgICAgICAgc2VsZWN0aW9uOiBbXSxcbiAgICAgICAgICAgIG9yZGVyQnk6IFtdLFxuICAgICAgICAgICAgbGltaXQ6IDEsXG4gICAgICAgICAgICB0aW1lb3V0OiA0MDAwMCxcbiAgICAgICAgICAgIHRleHQ6IGBGT1IgZG9jIElOICR7dGhpcy5uYW1lfSBGSUxURVIgZG9jLl9rZXkgPT0gQGtleSBSRVRVUk4gZG9jYCxcbiAgICAgICAgICAgIHBhcmFtczogeyBrZXkgfSxcbiAgICAgICAgICAgIGFjY2Vzc1JpZ2h0czogYWNjZXNzR3JhbnRlZCxcbiAgICAgICAgfSwgbnVsbCwgbnVsbCk7XG4gICAgICAgIHJldHVybiBkb2NzWzBdO1xuICAgIH1cblxuICAgIGFzeW5jIHdhaXRGb3JEb2NzKGtleXM6IHN0cmluZ1tdKTogUHJvbWlzZTxhbnlbXT4ge1xuICAgICAgICBpZiAoIWtleXMgfHwga2V5cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW10pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChrZXlzLm1hcChrZXkgPT4gdGhpcy53YWl0Rm9yRG9jKGtleSkpKTtcbiAgICB9XG59XG5cbiJdfQ==