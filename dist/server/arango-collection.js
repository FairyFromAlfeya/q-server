"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Collection = void 0;

var _arangojs = require("arangojs");

var _opentracing = require("opentracing");

var _arangoListeners = require("./arango-listeners");

var _logs = _interopRequireDefault(require("./logs"));

var _auth = require("./auth");

var _dbTypes = require("./db-types");

var _tracer = require("./tracer");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
class Collection {
  constructor(name, docType, logs, auth, tracer, db, slowDb) {
    this.name = name;
    this.docType = docType;
    this.log = logs.create(name);
    this.auth = auth;
    this.tracer = tracer;
    this.db = db;
    this.slowDb = slowDb;
    this.listeners = new _utils.RegistryMap(`${name} listeners`);
    this.queryStats = new Map();
    this.maxQueueSize = 0;
  } // Subscriptions


  onDocumentInsertOrUpdate(doc) {
    for (const listener of this.listeners.values()) {
      if (listener.isFiltered(doc)) {
        listener.onDocumentInsertOrUpdate(doc);
      }
    }
  }

  subscriptionResolver() {
    return {
      subscribe: async (_, args, context, info) => {
        const accessRights = await this.auth.getAccessRights(context.accessKey);
        return new _arangoListeners.SubscriptionListener(this.name, this.docType, this.listeners, accessRights, args.filter || {}, (0, _utils.parseSelectionSet)(info.operation.selectionSet, this.name));
      }
    };
  } // Queries


  getAdditionalCondition(accessRights, params) {
    const accounts = accessRights.restrictToAccounts;

    if (accounts.length === 0) {
      return '';
    }

    const condition = accounts.length === 1 ? `== @${params.add(accounts[0])}` : `IN [${accounts.map(x => `@${params.add(x)}`).join(',')}]`;

    switch (this.name) {
      case 'accounts':
        return `doc._key ${condition}`;

      case 'transactions':
        return `doc.account_addr ${condition}`;

      case 'messages':
        return `(doc.src ${condition}) OR (doc.dst ${condition})`;

      default:
        return 'false';
    }
  }

  createDatabaseQuery(args, selectionInfo, accessRights) {
    const filter = args.filter || {};
    const params = new _dbTypes.QParams();
    const primaryCondition = Object.keys(filter).length > 0 ? this.docType.ql(params, 'doc', filter) : '';
    const additionalCondition = this.getAdditionalCondition(accessRights, params);

    if (primaryCondition === 'false' || additionalCondition === 'false') {
      return null;
    }

    let condition = primaryCondition && additionalCondition ? `(${primaryCondition}) AND (${additionalCondition})` : primaryCondition || additionalCondition;
    const filterSection = condition ? `FILTER ${condition}` : '';
    const selection = (0, _utils.parseSelectionSet)(selectionInfo, this.name);
    const orderBy = args.orderBy || [];
    const limit = args.limit || 50;
    const timeout = Number(args.timeout) || 0;
    const orderByText = orderBy.map(field => {
      const direction = field.direction && field.direction.toLowerCase() === 'desc' ? ' DESC' : '';
      return `doc.${field.path.replace(/\bid\b/gi, '_key')}${direction}`;
    }).join(', ');
    const sortSection = orderByText !== '' ? `SORT ${orderByText}` : '';
    const limitText = Math.min(limit, 50);
    const limitSection = `LIMIT ${limitText}`;
    const text = `
            FOR doc IN ${this.name}
            ${filterSection}
            ${sortSection}
            ${limitSection}
            RETURN doc`;
    return {
      filter,
      selection,
      orderBy,
      limit,
      timeout,
      text,
      params: params.values,
      accessRights
    };
  }

  async ensureQueryStat(q) {
    const existing = this.queryStats.get(q.text);

    if (existing !== undefined) {
      return existing;
    }

    const plan = (await this.db.explain(q.text, q.params)).plan;
    const stat = {
      estimatedCost: plan.estimatedCost,
      slow: false,
      times: []
    };

    if (plan.nodes.find(node => node.type === 'EnumerateCollectionNode')) {
      stat.slow = true;
    }

    this.queryStats.set(q.text, stat);
    return stat;
  }

  queryResolver() {
    return async (parent, args, context, info) => (0, _utils.wrap)(this.log, 'QUERY', args, async () => {
      const accessRights = await context.auth.requireGrantedAccess(context.accessKey || args.accessKey);
      const q = this.createDatabaseQuery(args, info.operation.selectionSet, accessRights);

      if (!q) {
        this.log.debug('QUERY', args, 0, 'SKIPPED', context.remoteAddress);
        return [];
      }

      const stat = await this.ensureQueryStat(q);
      const start = Date.now();
      const result = q.timeout > 0 ? await this.queryWaitFor(q, stat, context.parentSpan) : await this.query(q, stat, context.parentSpan);
      this.log.debug('QUERY', args, (Date.now() - start) / 1000, stat.slow ? 'SLOW' : 'FAST', context.remoteAddress);
      return result;
    });
  }

  static setQueryTraceParams(q, span) {
    const params = {
      filter: q.filter,
      selection: (0, _utils.selectionToString)(q.selection)
    };

    if (q.orderBy.length > 0) {
      params.orderBy = q.orderBy;
    }

    if (q.limit !== 50) {
      params.limit = q.limit;
    }

    if (q.timeout > 0) {
      params.timeout = q.timeout;
    }

    span.setTag('params', params);
  }

  async query(q, stat, parentSpan) {
    return _tracer.QTracer.trace(this.tracer, `${this.name}.query`, async span => {
      Collection.setQueryTraceParams(q, span);
      return this.queryDatabase(q, stat);
    }, parentSpan);
  }

  async queryDatabase(q, stat) {
    const db = stat.slow ? this.slowDb : this.db;
    const start = Date.now();
    const cursor = await db.query(q.text, q.params);
    const result = await cursor.all();
    stat.times.push(Date.now() - start);

    if (stat.times.length > 100) {
      stat.times.shift();
    }

    return result;
  }

  async queryWaitFor(q, stat, parentSpan) {
    return _tracer.QTracer.trace(this.tracer, `${this.name}.waitFor`, async span => {
      Collection.setQueryTraceParams(q, span);
      let waitFor = null;
      let forceTimerId = null;
      let resolvedBy = null;

      try {
        const onQuery = new Promise((resolve, reject) => {
          const check = () => {
            this.queryDatabase(q, stat).then(docs => {
              if (!resolvedBy) {
                if (docs.length > 0) {
                  forceTimerId = null;
                  resolvedBy = 'query';
                  resolve(docs);
                } else {
                  forceTimerId = setTimeout(check, 5000);
                }
              }
            }, reject);
          };

          check();
        });
        const onChangesFeed = new Promise(resolve => {
          waitFor = new _arangoListeners.WaitForListener(this.name, this.docType, this.listeners, q.accessRights, q.filter, q.selection, doc => {
            if (!resolvedBy) {
              resolvedBy = 'listener';
              resolve([doc]);
            }
          });
        });
        const onTimeout = new Promise(resolve => {
          setTimeout(() => {
            if (!resolvedBy) {
              resolvedBy = 'timeout';
              resolve([]);
            }
          }, q.timeout);
        });
        const result = await Promise.race([onQuery, onChangesFeed, onTimeout]);
        span.setTag('resolved', resolvedBy);
        return result;
      } finally {
        if (waitFor !== null && waitFor !== undefined) {
          waitFor.close();
          waitFor = null;
        }

        if (forceTimerId !== null) {
          clearTimeout(forceTimerId);
          forceTimerId = null;
        }
      }
    }, parentSpan);
  }

  dbCollection() {
    return this.db.collection(this.name);
  }

  async fetchDocByKey(key) {
    if (!key) {
      return Promise.resolve(null);
    }

    return (0, _utils.wrap)(this.log, 'FETCH_DOC_BY_KEY', key, async () => {
      return this.dbCollection().document(key, true);
    });
  }

  async fetchDocsByKeys(keys) {
    if (!keys || keys.length === 0) {
      return Promise.resolve([]);
    }

    return Promise.all(keys.map(key => this.fetchDocByKey(key)));
  }

}

exports.Collection = Collection;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hcmFuZ28tY29sbGVjdGlvbi5qcyJdLCJuYW1lcyI6WyJDb2xsZWN0aW9uIiwiY29uc3RydWN0b3IiLCJuYW1lIiwiZG9jVHlwZSIsImxvZ3MiLCJhdXRoIiwidHJhY2VyIiwiZGIiLCJzbG93RGIiLCJsb2ciLCJjcmVhdGUiLCJsaXN0ZW5lcnMiLCJSZWdpc3RyeU1hcCIsInF1ZXJ5U3RhdHMiLCJNYXAiLCJtYXhRdWV1ZVNpemUiLCJvbkRvY3VtZW50SW5zZXJ0T3JVcGRhdGUiLCJkb2MiLCJsaXN0ZW5lciIsInZhbHVlcyIsImlzRmlsdGVyZWQiLCJzdWJzY3JpcHRpb25SZXNvbHZlciIsInN1YnNjcmliZSIsIl8iLCJhcmdzIiwiY29udGV4dCIsImluZm8iLCJhY2Nlc3NSaWdodHMiLCJnZXRBY2Nlc3NSaWdodHMiLCJhY2Nlc3NLZXkiLCJTdWJzY3JpcHRpb25MaXN0ZW5lciIsImZpbHRlciIsIm9wZXJhdGlvbiIsInNlbGVjdGlvblNldCIsImdldEFkZGl0aW9uYWxDb25kaXRpb24iLCJwYXJhbXMiLCJhY2NvdW50cyIsInJlc3RyaWN0VG9BY2NvdW50cyIsImxlbmd0aCIsImNvbmRpdGlvbiIsImFkZCIsIm1hcCIsIngiLCJqb2luIiwiY3JlYXRlRGF0YWJhc2VRdWVyeSIsInNlbGVjdGlvbkluZm8iLCJRUGFyYW1zIiwicHJpbWFyeUNvbmRpdGlvbiIsIk9iamVjdCIsImtleXMiLCJxbCIsImFkZGl0aW9uYWxDb25kaXRpb24iLCJmaWx0ZXJTZWN0aW9uIiwic2VsZWN0aW9uIiwib3JkZXJCeSIsImxpbWl0IiwidGltZW91dCIsIk51bWJlciIsIm9yZGVyQnlUZXh0IiwiZmllbGQiLCJkaXJlY3Rpb24iLCJ0b0xvd2VyQ2FzZSIsInBhdGgiLCJyZXBsYWNlIiwic29ydFNlY3Rpb24iLCJsaW1pdFRleHQiLCJNYXRoIiwibWluIiwibGltaXRTZWN0aW9uIiwidGV4dCIsImVuc3VyZVF1ZXJ5U3RhdCIsInEiLCJleGlzdGluZyIsImdldCIsInVuZGVmaW5lZCIsInBsYW4iLCJleHBsYWluIiwic3RhdCIsImVzdGltYXRlZENvc3QiLCJzbG93IiwidGltZXMiLCJub2RlcyIsImZpbmQiLCJub2RlIiwidHlwZSIsInNldCIsInF1ZXJ5UmVzb2x2ZXIiLCJwYXJlbnQiLCJyZXF1aXJlR3JhbnRlZEFjY2VzcyIsImRlYnVnIiwicmVtb3RlQWRkcmVzcyIsInN0YXJ0IiwiRGF0ZSIsIm5vdyIsInJlc3VsdCIsInF1ZXJ5V2FpdEZvciIsInBhcmVudFNwYW4iLCJxdWVyeSIsInNldFF1ZXJ5VHJhY2VQYXJhbXMiLCJzcGFuIiwic2V0VGFnIiwiUVRyYWNlciIsInRyYWNlIiwicXVlcnlEYXRhYmFzZSIsImN1cnNvciIsImFsbCIsInB1c2giLCJzaGlmdCIsIndhaXRGb3IiLCJmb3JjZVRpbWVySWQiLCJyZXNvbHZlZEJ5Iiwib25RdWVyeSIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiY2hlY2siLCJ0aGVuIiwiZG9jcyIsInNldFRpbWVvdXQiLCJvbkNoYW5nZXNGZWVkIiwiV2FpdEZvckxpc3RlbmVyIiwib25UaW1lb3V0IiwicmFjZSIsImNsb3NlIiwiY2xlYXJUaW1lb3V0IiwiZGJDb2xsZWN0aW9uIiwiY29sbGVjdGlvbiIsImZldGNoRG9jQnlLZXkiLCJrZXkiLCJkb2N1bWVudCIsImZldGNoRG9jc0J5S2V5cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQWtCQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUFFQTs7OztBQTlCQTs7Ozs7Ozs7Ozs7Ozs7O0FBbUVPLE1BQU1BLFVBQU4sQ0FBaUI7QUFlcEJDLEVBQUFBLFdBQVcsQ0FDUEMsSUFETyxFQUVQQyxPQUZPLEVBR1BDLElBSE8sRUFJUEMsSUFKTyxFQUtQQyxNQUxPLEVBTVBDLEVBTk8sRUFPUEMsTUFQTyxFQVFUO0FBQ0UsU0FBS04sSUFBTCxHQUFZQSxJQUFaO0FBQ0EsU0FBS0MsT0FBTCxHQUFlQSxPQUFmO0FBRUEsU0FBS00sR0FB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TTZILGFBQU4sQ0FBb0JDLEdBQXBCLEVBQStDO0FBQzNDLFFBQUksQ0FBQ0EsR0FBTCxFQUFVO0FBQ04sYUFBT2hCLE9BQU8sQ0FBQ0MsT0FBUixDQUFnQixJQUFoQixDQUFQO0FBQ0g7O0FBQ0QsV0FBTyxpQkFBSyxLQUFLeEcsR0FBVixFQUFlLGtCQUFmLEVBQW1DdUgsR0FBbkMsRUFBd0MsWUFBWTtBQUN2RCxhQUFPLEtBQUtILFlBQUwsR0FBb0JJLFFBQXBCLENBQTZCRCxHQUE3QixFQUFrQyxJQUFsQyxDQUFQO0FBQ0gsS0FGTSxDQUFQO0FBR0g7O0FBRUQsUUFBTUUsZUFBTixDQUFzQmpGLElBQXRCLEVBQXNEO0FBQ2xELFFBQUksQ0FBQ0EsSUFBRCxJQUFTQSxJQUFJLENBQUNYLE1BQUwsS0FBZ0IsQ0FBN0IsRUFBZ0M7QUFDNUIsYUFBTzBFLE9BQU8sQ0FBQ0MsT0FBUixDQUFnQixFQUFoQixDQUFQO0FBQ0g7O0FBQ0QsV0FBT0QsT0FBTyxDQUFDUCxHQUFSLENBQVl4RCxJQUFJLENBQUNSLEdBQUwsQ0FBU3VGLEdBQUcsSUFBSSxLQUFLRCxhQUFMLENBQW1CQyxHQUFuQixDQUFoQixDQUFaLENBQVA7QUFDSDs7QUE3U21CIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE4LTIwMjAgVE9OIERFViBTT0xVVElPTlMgTFRELlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBTT0ZUV0FSRSBFVkFMVUFUSU9OIExpY2Vuc2UgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZVxuICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlXG4gKiBMaWNlbnNlIGF0OlxuICpcbiAqIGh0dHA6Ly93d3cudG9uLmRldi9saWNlbnNlc1xuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgVE9OIERFViBzb2Z0d2FyZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vLyBAZmxvd1xuXG5pbXBvcnQgeyBEYXRhYmFzZSwgRG9jdW1lbnRDb2xsZWN0aW9uIH0gZnJvbSBcImFyYW5nb2pzXCI7XG5pbXBvcnQgeyBTcGFuLCBTcGFuQ29udGV4dCwgVHJhY2VyIH0gZnJvbSBcIm9wZW50cmFjaW5nXCI7XG5pbXBvcnQgeyBDb2xsZWN0aW9uTGlzdGVuZXIsIFN1YnNjcmlwdGlvbkxpc3RlbmVyLCBXYWl0Rm9yTGlzdGVuZXIgfSBmcm9tIFwiLi9hcmFuZ28tbGlzdGVuZXJzXCI7XG5pbXBvcnQgdHlwZSB7IFFDb25maWcgfSBmcm9tIFwiLi9jb25maWdcIjtcbmltcG9ydCB0eXBlIHsgUUxvZyB9IGZyb20gXCIuL2xvZ3NcIjtcbmltcG9ydCBRTG9ncyBmcm9tIFwiLi9sb2dzXCI7XG5pbXBvcnQgdHlwZSB7IEFjY2Vzc1JpZ2h0cyB9IGZyb20gXCIuL2F1dGhcIjtcbmltcG9ydCB7IEF1dGggfSBmcm9tIFwiLi9hdXRoXCI7XG5pbXBvcnQgdHlwZSB7IFFUeXBlIH0gZnJvbSBcIi4vZGItdHlwZXNcIjtcbmltcG9ydCB7IFFQYXJhbXMgfSBmcm9tIFwiLi9kYi10eXBlc1wiO1xuaW1wb3J0IHsgUVRyYWNlciB9IGZyb20gXCIuL3RyYWNlclwiO1xuaW1wb3J0IHR5cGUgeyBGaWVsZFNlbGVjdGlvbiB9IGZyb20gXCIuL3V0aWxzXCI7XG5pbXBvcnQgeyBwYXJzZVNlbGVjdGlvblNldCwgUmVnaXN0cnlNYXAsIHNlbGVjdGlvblRvU3RyaW5nLCB3cmFwIH0gZnJvbSBcIi4vdXRpbHNcIjtcblxuXG5leHBvcnQgdHlwZSBHcmFwaFFMUmVxdWVzdENvbnRleHQgPSB7XG4gICAgY29uZmlnOiBRQ29uZmlnLFxuICAgIGF1dGg6IEF1dGgsXG4gICAgdHJhY2VyOiBUcmFjZXIsXG5cbiAgICByZW1vdGVBZGRyZXNzPzogc3RyaW5nLFxuICAgIGFjY2Vzc0tleTogc3RyaW5nLFxuICAgIHBhcmVudFNwYW46IChTcGFuIHwgU3BhbkNvbnRleHQgfCB0eXBlb2YgdW5kZWZpbmVkKSxcblxuICAgIHNoYXJlZDogTWFwPHN0cmluZywgYW55Pixcbn1cblxudHlwZSBPcmRlckJ5ID0ge1xuICAgIHBhdGg6IHN0cmluZyxcbiAgICBkaXJlY3Rpb246IHN0cmluZyxcbn1cblxudHlwZSBEYXRhYmFzZVF1ZXJ5ID0ge1xuICAgIGZpbHRlcjogYW55LFxuICAgIHNlbGVjdGlvbjogRmllbGRTZWxlY3Rpb25bXSxcbiAgICBvcmRlckJ5OiBPcmRlckJ5W10sXG4gICAgbGltaXQ6IG51bWJlcixcbiAgICB0aW1lb3V0OiBudW1iZXIsXG4gICAgdGV4dDogc3RyaW5nLFxuICAgIHBhcmFtczogeyBbc3RyaW5nXTogYW55IH0sXG4gICAgYWNjZXNzUmlnaHRzOiBBY2Nlc3NSaWdodHMsXG59XG5cbmV4cG9ydCB0eXBlIFF1ZXJ5U3RhdCA9IHtcbiAgICBlc3RpbWF0ZWRDb3N0OiBudW1iZXIsXG4gICAgc2xvdzogYm9vbGVhbixcbiAgICB0aW1lczogbnVtYmVyW10sXG59XG5cbmV4cG9ydCBjbGFzcyBDb2xsZWN0aW9uIHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgZG9jVHlwZTogUVR5cGU7XG5cbiAgICBsb2c6IFFMb2c7XG4gICAgYXV0aDogQXV0aDtcbiAgICB0cmFjZXI6IFRyYWNlcjtcbiAgICBkYjogRGF0YWJhc2U7XG4gICAgc2xvd0RiOiBEYXRhYmFzZTtcblxuICAgIGxpc3RlbmVyczogUmVnaXN0cnlNYXA8Q29sbGVjdGlvbkxpc3RlbmVyPjtcbiAgICBxdWVyeVN0YXRzOiBNYXA8c3RyaW5nLCBRdWVyeVN0YXQ+O1xuXG4gICAgbWF4UXVldWVTaXplOiBudW1iZXI7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgbmFtZTogc3RyaW5nLFxuICAgICAgICBkb2NUeXBlOiBRVHlwZSxcbiAgICAgICAgbG9nczogUUxvZ3MsXG4gICAgICAgIGF1dGg6IEF1dGgsXG4gICAgICAgIHRyYWNlcjogVHJhY2VyLFxuICAgICAgICBkYjogRGF0YWJhc2UsXG4gICAgICAgIHNsb3dEYjogRGF0YWJhc2UsXG4gICAgKSB7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHRoaXMuZG9jVHlwZSA9IGRvY1R5cGU7XG5cbiAgICAgICAgdGhpcy5sb2cgPSBsb2dzLmNyZWF0ZShuYW1lKTtcbiAgICAgICAgdGhpcy5hdXRoID0gYXV0aDtcbiAgICAgICAgdGhpcy50cmFjZXIgPSB0cmFjZXI7XG4gICAgICAgIHRoaXMuZGIgPSBkYjtcbiAgICAgICAgdGhpcy5zbG93RGIgPSBzbG93RGI7XG5cbiAgICAgICAgdGhpcy5saXN0ZW5lcnMgPSBuZXcgUmVnaXN0cnlNYXA8Q29sbGVjdGlvbkxpc3RlbmVyPihgJHtuYW1lfSBsaXN0ZW5lcnNgKTtcbiAgICAgICAgdGhpcy5xdWVyeVN0YXRzID0gbmV3IE1hcDxzdHJpbmcsIFF1ZXJ5U3RhdD4oKTtcbiAgICAgICAgdGhpcy5tYXhRdWV1ZVNpemUgPSAwO1xuICAgIH1cblxuICAgIC8vIFN1YnNjcmlwdGlvbnNcblxuICAgIG9uRG9jdW1lbnRJbnNlcnRPclVwZGF0ZShkb2M6IGFueSkge1xuICAgICAgICBmb3IgKGNvbnN0IGxpc3RlbmVyIG9mIHRoaXMubGlzdGVuZXJzLnZhbHVlcygpKSB7XG4gICAgICAgICAgICBpZiAobGlzdGVuZXIuaXNGaWx0ZXJlZChkb2MpKSB7XG4gICAgICAgICAgICAgICAgbGlzdGVuZXIub25Eb2N1bWVudEluc2VydE9yVXBkYXRlKGRvYyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdWJzY3JpcHRpb25SZXNvbHZlcigpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN1YnNjcmliZTogYXN5bmMgKF86IGFueSwgYXJnczogeyBmaWx0ZXI6IGFueSB9LCBjb250ZXh0OiBhbnksIGluZm86IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFjY2Vzc1JpZ2h0cyA9IGF3YWl0IHRoaXMuYXV0aC5nZXRBY2Nlc3NSaWdodHMoY29udGV4dC5hY2Nlc3NLZXkpO1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgU3Vic2NyaXB0aW9uTGlzdGVuZXIoXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kb2NUeXBlLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxpc3RlbmVycyxcbiAgICAgICAgICAgICAgICAgICAgYWNjZXNzUmlnaHRzLFxuICAgICAgICAgICAgICAgICAgICBhcmdzLmZpbHRlciB8fCB7fSxcbiAgICAgICAgICAgICAgICAgICAgcGFyc2VTZWxlY3Rpb25TZXQoaW5mby5vcGVyYXRpb24uc2VsZWN0aW9uU2V0LCB0aGlzLm5hbWUpLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gUXVlcmllc1xuXG4gICAgZ2V0QWRkaXRpb25hbENvbmRpdGlvbihhY2Nlc3NSaWdodHM6IEFjY2Vzc1JpZ2h0cywgcGFyYW1zOiBRUGFyYW1zKSB7XG4gICAgICAgIGNvbnN0IGFjY291bnRzID0gYWNjZXNzUmlnaHRzLnJlc3RyaWN0VG9BY2NvdW50cztcbiAgICAgICAgaWYgKGFjY291bnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGNvbmRpdGlvbiA9IGFjY291bnRzLmxlbmd0aCA9PT0gMVxuICAgICAgICAgICAgPyBgPT0gQCR7cGFyYW1zLmFkZChhY2NvdW50c1swXSl9YFxuICAgICAgICAgICAgOiBgSU4gWyR7YWNjb3VudHMubWFwKHggPT4gYEAke3BhcmFtcy5hZGQoeCl9YCkuam9pbignLCcpfV1gO1xuICAgICAgICBzd2l0Y2ggKHRoaXMubmFtZSkge1xuICAgICAgICBjYXNlICdhY2NvdW50cyc6XG4gICAgICAgICAgICByZXR1cm4gYGRvYy5fa2V5ICR7Y29uZGl0aW9ufWA7XG4gICAgICAgIGNhc2UgJ3RyYW5zYWN0aW9ucyc6XG4gICAgICAgICAgICByZXR1cm4gYGRvYy5hY2NvdW50X2FkZHIgJHtjb25kaXRpb259YDtcbiAgICAgICAgY2FzZSAnbWVzc2FnZXMnOlxuICAgICAgICAgICAgcmV0dXJuIGAoZG9jLnNyYyAke2NvbmRpdGlvbn0pIE9SIChkb2MuZHN0ICR7Y29uZGl0aW9ufSlgO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgcmV0dXJuICdmYWxzZSc7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjcmVhdGVEYXRhYmFzZVF1ZXJ5KFxuICAgICAgICBhcmdzOiB7XG4gICAgICAgICAgICBmaWx0ZXI/OiBhbnksXG4gICAgICAgICAgICBvcmRlckJ5PzogT3JkZXJCeVtdLFxuICAgICAgICAgICAgbGltaXQ/OiBudW1iZXIsXG4gICAgICAgICAgICB0aW1lb3V0PzogbnVtYmVyLFxuICAgICAgICB9LFxuICAgICAgICBzZWxlY3Rpb25JbmZvOiBhbnksXG4gICAgICAgIGFjY2Vzc1JpZ2h0czogQWNjZXNzUmlnaHRzLFxuICAgICk6ID9EYXRhYmFzZVF1ZXJ5IHtcbiAgICAgICAgY29uc3QgZmlsdGVyID0gYXJncy5maWx0ZXIgfHwge307XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IG5ldyBRUGFyYW1zKCk7XG4gICAgICAgIGNvbnN0IHByaW1hcnlDb25kaXRpb24gPSBPYmplY3Qua2V5cyhmaWx0ZXIpLmxlbmd0aCA+IDAgPyB0aGlzLmRvY1R5cGUucWwocGFyYW1zLCAnZG9jJywgZmlsdGVyKSA6ICcnO1xuICAgICAgICBjb25zdCBhZGRpdGlvbmFsQ29uZGl0aW9uID0gdGhpcy5nZXRBZGRpdGlvbmFsQ29uZGl0aW9uKGFjY2Vzc1JpZ2h0cywgcGFyYW1zKTtcbiAgICAgICAgaWYgKHByaW1hcnlDb25kaXRpb24gPT09ICdmYWxzZScgfHwgYWRkaXRpb25hbENvbmRpdGlvbiA9PT0gJ2ZhbHNlJykge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGNvbmRpdGlvbiA9IChwcmltYXJ5Q29uZGl0aW9uICYmIGFkZGl0aW9uYWxDb25kaXRpb24pXG4gICAgICAgICAgICA/IGAoJHtwcmltYXJ5Q29uZGl0aW9ufSkgQU5EICgke2FkZGl0aW9uYWxDb25kaXRpb259KWBcbiAgICAgICAgICAgIDogKHByaW1hcnlDb25kaXRpb24gfHwgYWRkaXRpb25hbENvbmRpdGlvbik7XG4gICAgICAgIGNvbnN0IGZpbHRlclNlY3Rpb24gPSBjb25kaXRpb24gPyBgRklMVEVSICR7Y29uZGl0aW9ufWAgOiAnJztcbiAgICAgICAgY29uc3Qgc2VsZWN0aW9uID0gcGFyc2VTZWxlY3Rpb25TZXQoc2VsZWN0aW9uSW5mbywgdGhpcy5uYW1lKTtcbiAgICAgICAgY29uc3Qgb3JkZXJCeTogT3JkZXJCeVtdID0gYXJncy5vcmRlckJ5IHx8IFtdO1xuICAgICAgICBjb25zdCBsaW1pdDogbnVtYmVyID0gYXJncy5saW1pdCB8fCA1MDtcbiAgICAgICAgY29uc3QgdGltZW91dCA9IE51bWJlcihhcmdzLnRpbWVvdXQpIHx8IDA7XG4gICAgICAgIGNvbnN0IG9yZGVyQnlUZXh0ID0gb3JkZXJCeVxuICAgICAgICAgICAgLm1hcCgoZmllbGQpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBkaXJlY3Rpb24gPSAoZmllbGQuZGlyZWN0aW9uICYmIGZpZWxkLmRpcmVjdGlvbi50b0xvd2VyQ2FzZSgpID09PSAnZGVzYycpXG4gICAgICAgICAgICAgICAgICAgID8gJyBERVNDJ1xuICAgICAgICAgICAgICAgICAgICA6ICcnO1xuICAgICAgICAgICAgICAgIHJldHVybiBgZG9jLiR7ZmllbGQucGF0aC5yZXBsYWNlKC9cXGJpZFxcYi9naSwgJ19rZXknKX0ke2RpcmVjdGlvbn1gO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5qb2luKCcsICcpO1xuXG4gICAgICAgIGNvbnN0IHNvcnRTZWN0aW9uID0gb3JkZXJCeVRleHQgIT09ICcnID8gYFNPUlQgJHtvcmRlckJ5VGV4dH1gIDogJyc7XG4gICAgICAgIGNvbnN0IGxpbWl0VGV4dCA9IE1hdGgubWluKGxpbWl0LCA1MCk7XG4gICAgICAgIGNvbnN0IGxpbWl0U2VjdGlvbiA9IGBMSU1JVCAke2xpbWl0VGV4dH1gO1xuXG4gICAgICAgIGNvbnN0IHRleHQgPSBgXG4gICAgICAgICAgICBGT1IgZG9jIElOICR7dGhpcy5uYW1lfVxuICAgICAgICAgICAgJHtmaWx0ZXJTZWN0aW9ufVxuICAgICAgICAgICAgJHtzb3J0U2VjdGlvbn1cbiAgICAgICAgICAgICR7bGltaXRTZWN0aW9ufVxuICAgICAgICAgICAgUkVUVVJOIGRvY2A7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGZpbHRlcixcbiAgICAgICAgICAgIHNlbGVjdGlvbixcbiAgICAgICAgICAgIG9yZGVyQnksXG4gICAgICAgICAgICBsaW1pdCxcbiAgICAgICAgICAgIHRpbWVvdXQsXG4gICAgICAgICAgICB0ZXh0LFxuICAgICAgICAgICAgcGFyYW1zOiBwYXJhbXMudmFsdWVzLFxuICAgICAgICAgICAgYWNjZXNzUmlnaHRzLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGFzeW5jIGVuc3VyZVF1ZXJ5U3RhdChxOiBEYXRhYmFzZVF1ZXJ5KTogUHJvbWlzZTxRdWVyeVN0YXQ+IHtcbiAgICAgICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLnF1ZXJ5U3RhdHMuZ2V0KHEudGV4dCk7XG4gICAgICAgIGlmIChleGlzdGluZyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcGxhbiA9IChhd2FpdCB0aGlzLmRiLmV4cGxhaW4ocS50ZXh0LCBxLnBhcmFtcykpLnBsYW47XG4gICAgICAgIGNvbnN0IHN0YXQgPSB7XG4gICAgICAgICAgICBlc3RpbWF0ZWRDb3N0OiBwbGFuLmVzdGltYXRlZENvc3QsXG4gICAgICAgICAgICBzbG93OiBmYWxzZSxcbiAgICAgICAgICAgIHRpbWVzOiBbXSxcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKHBsYW4ubm9kZXMuZmluZChub2RlID0+IG5vZGUudHlwZSA9PT0gJ0VudW1lcmF0ZUNvbGxlY3Rpb25Ob2RlJykpIHtcbiAgICAgICAgICAgIHN0YXQuc2xvdyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5xdWVyeVN0YXRzLnNldChxLnRleHQsIHN0YXQpO1xuICAgICAgICByZXR1cm4gc3RhdDtcbiAgICB9XG5cbiAgICBxdWVyeVJlc29sdmVyKCkge1xuICAgICAgICByZXR1cm4gYXN5bmMgKHBhcmVudDogYW55LCBhcmdzOiBhbnksIGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dCwgaW5mbzogYW55KSA9PiB3cmFwKHRoaXMubG9nLCAnUVVFUlknLCBhcmdzLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBhY2Nlc3NSaWdodHMgPSBhd2FpdCBjb250ZXh0LmF1dGgucmVxdWlyZUdyYW50ZWRBY2Nlc3MoY29udGV4dC5hY2Nlc3NLZXkgfHwgYXJncy5hY2Nlc3NLZXkpO1xuICAgICAgICAgICAgY29uc3QgcSA9IHRoaXMuY3JlYXRlRGF0YWJhc2VRdWVyeShhcmdzLCBpbmZvLm9wZXJhdGlvbi5zZWxlY3Rpb25TZXQsIGFjY2Vzc1JpZ2h0cyk7XG4gICAgICAgICAgICBpZiAoIXEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnUVVFUlknLCBhcmdzLCAwLCAnU0tJUFBFRCcsIGNvbnRleHQucmVtb3RlQWRkcmVzcyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3Qgc3RhdCA9IGF3YWl0IHRoaXMuZW5zdXJlUXVlcnlTdGF0KHEpO1xuICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gcS50aW1lb3V0ID4gMFxuICAgICAgICAgICAgICAgID8gYXdhaXQgdGhpcy5xdWVyeVdhaXRGb3IocSwgc3RhdCwgY29udGV4dC5wYXJlbnRTcGFuKVxuICAgICAgICAgICAgICAgIDogYXdhaXQgdGhpcy5xdWVyeShxLCBzdGF0LCBjb250ZXh0LnBhcmVudFNwYW4pO1xuICAgICAgICAgICAgdGhpcy5sb2cuZGVidWcoJ1FVRVJZJywgYXJncywgKERhdGUubm93KCkgLSBzdGFydCkgLyAxMDAwLCBzdGF0LnNsb3cgPyAnU0xPVycgOiAnRkFTVCcsIGNvbnRleHQucmVtb3RlQWRkcmVzcyk7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgc2V0UXVlcnlUcmFjZVBhcmFtcyhxOiBEYXRhYmFzZVF1ZXJ5LCBzcGFuOiBTcGFuKSB7XG4gICAgICAgIGNvbnN0IHBhcmFtczogYW55ID0ge1xuICAgICAgICAgICAgZmlsdGVyOiBxLmZpbHRlcixcbiAgICAgICAgICAgIHNlbGVjdGlvbjogc2VsZWN0aW9uVG9TdHJpbmcocS5zZWxlY3Rpb24pLFxuICAgICAgICB9O1xuICAgICAgICBpZiAocS5vcmRlckJ5Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHBhcmFtcy5vcmRlckJ5ID0gcS5vcmRlckJ5O1xuICAgICAgICB9XG4gICAgICAgIGlmIChxLmxpbWl0ICE9PSA1MCkge1xuICAgICAgICAgICAgcGFyYW1zLmxpbWl0ID0gcS5saW1pdDtcbiAgICAgICAgfVxuICAgICAgICBpZiAocS50aW1lb3V0ID4gMCkge1xuICAgICAgICAgICAgcGFyYW1zLnRpbWVvdXQgPSBxLnRpbWVvdXQ7XG4gICAgICAgIH1cbiAgICAgICAgc3Bhbi5zZXRUYWcoJ3BhcmFtcycsIHBhcmFtcyk7XG4gICAgfVxuXG4gICAgYXN5bmMgcXVlcnkocTogRGF0YWJhc2VRdWVyeSwgc3RhdDogUXVlcnlTdGF0LCBwYXJlbnRTcGFuPzogKFNwYW4gfCBTcGFuQ29udGV4dCkpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gUVRyYWNlci50cmFjZSh0aGlzLnRyYWNlciwgYCR7dGhpcy5uYW1lfS5xdWVyeWAsIGFzeW5jIChzcGFuOiBTcGFuKSA9PiB7XG4gICAgICAgICAgICBDb2xsZWN0aW9uLnNldFF1ZXJ5VHJhY2VQYXJhbXMocSwgc3Bhbik7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5xdWVyeURhdGFiYXNlKHEsIHN0YXQpO1xuICAgICAgICB9LCBwYXJlbnRTcGFuKTtcbiAgICB9XG5cbiAgICBhc3luYyBxdWVyeURhdGFiYXNlKHE6IERhdGFiYXNlUXVlcnksIHN0YXQ6IFF1ZXJ5U3RhdCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IGRiID0gc3RhdC5zbG93ID8gdGhpcy5zbG93RGIgOiB0aGlzLmRiO1xuICAgICAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7XG4gICAgICAgIGNvbnN0IGN1cnNvciA9IGF3YWl0IGRiLnF1ZXJ5KHEudGV4dCwgcS5wYXJhbXMpO1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjdXJzb3IuYWxsKCk7XG4gICAgICAgIHN0YXQudGltZXMucHVzaChEYXRlLm5vdygpIC0gc3RhcnQpO1xuICAgICAgICBpZiAoc3RhdC50aW1lcy5sZW5ndGggPiAxMDApIHtcbiAgICAgICAgICAgIHN0YXQudGltZXMuc2hpZnQoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuXG4gICAgYXN5bmMgcXVlcnlXYWl0Rm9yKHE6IERhdGFiYXNlUXVlcnksIHN0YXQ6IFF1ZXJ5U3RhdCwgcGFyZW50U3Bhbj86IChTcGFuIHwgU3BhbkNvbnRleHQpKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIFFUcmFjZXIudHJhY2UodGhpcy50cmFjZXIsIGAke3RoaXMubmFtZX0ud2FpdEZvcmAsIGFzeW5jIChzcGFuOiBTcGFuKSA9PiB7XG4gICAgICAgICAgICBDb2xsZWN0aW9uLnNldFF1ZXJ5VHJhY2VQYXJhbXMocSwgc3Bhbik7XG4gICAgICAgICAgICBsZXQgd2FpdEZvcjogP1dhaXRGb3JMaXN0ZW5lciA9IG51bGw7XG4gICAgICAgICAgICBsZXQgZm9yY2VUaW1lcklkOiA/VGltZW91dElEID0gbnVsbDtcbiAgICAgICAgICAgIGxldCByZXNvbHZlZEJ5OiA/c3RyaW5nID0gbnVsbDtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgb25RdWVyeSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hlY2sgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5RGF0YWJhc2UocSwgc3RhdCkudGhlbigoZG9jcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVzb2x2ZWRCeSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG9jcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JjZVRpbWVySWQgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRCeSA9ICdxdWVyeSc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRvY3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yY2VUaW1lcklkID0gc2V0VGltZW91dChjaGVjaywgNV8wMDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSwgcmVqZWN0KTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgY2hlY2soKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCBvbkNoYW5nZXNGZWVkID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgd2FpdEZvciA9IG5ldyBXYWl0Rm9yTGlzdGVuZXIoXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRvY1R5cGUsXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxpc3RlbmVycyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHEuYWNjZXNzUmlnaHRzLFxuICAgICAgICAgICAgICAgICAgICAgICAgcS5maWx0ZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICBxLnNlbGVjdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgIChkb2MpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc29sdmVkQnkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRCeSA9ICdsaXN0ZW5lcic7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoW2RvY10pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGNvbnN0IG9uVGltZW91dCA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXNvbHZlZEJ5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRCeSA9ICd0aW1lb3V0JztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKFtdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSwgcS50aW1lb3V0KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBQcm9taXNlLnJhY2UoW1xuICAgICAgICAgICAgICAgICAgICBvblF1ZXJ5LFxuICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZXNGZWVkLFxuICAgICAgICAgICAgICAgICAgICBvblRpbWVvdXQsXG4gICAgICAgICAgICAgICAgXSk7XG4gICAgICAgICAgICAgICAgc3Bhbi5zZXRUYWcoJ3Jlc29sdmVkJywgcmVzb2x2ZWRCeSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICAgICAgaWYgKHdhaXRGb3IgIT09IG51bGwgJiYgd2FpdEZvciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHdhaXRGb3IuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgd2FpdEZvciA9IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChmb3JjZVRpbWVySWQgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGZvcmNlVGltZXJJZCk7XG4gICAgICAgICAgICAgICAgICAgIGZvcmNlVGltZXJJZCA9IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LCBwYXJlbnRTcGFuKTtcbiAgICB9XG5cblxuICAgIGRiQ29sbGVjdGlvbigpOiBEb2N1bWVudENvbGxlY3Rpb24ge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5jb2xsZWN0aW9uKHRoaXMubmFtZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmV0Y2hEb2NCeUtleShrZXk6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGlmICgha2V5KSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB3cmFwKHRoaXMubG9nLCAnRkVUQ0hfRE9DX0JZX0tFWScsIGtleSwgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGJDb2xsZWN0aW9uKCkuZG9jdW1lbnQoa2V5LCB0cnVlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmV0Y2hEb2NzQnlLZXlzKGtleXM6IHN0cmluZ1tdKTogUHJvbWlzZTxhbnlbXT4ge1xuICAgICAgICBpZiAoIWtleXMgfHwga2V5cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW10pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChrZXlzLm1hcChrZXkgPT4gdGhpcy5mZXRjaERvY0J5S2V5KGtleSkpKTtcbiAgICB9XG59XG5cbiJdfQ==