"use strict";

const {
  Database
} = require('arangojs');

const {
  dataCollectionInfo
} = require('../../server/data/data-provider');

const program = require('commander');

const fetch = require('node-fetch');

function sameFields(a, b) {
  return a.join(',').toLowerCase() === b.join(',').toLowerCase();
}

async function detectRedirect(url) {
  try {
    const response = await fetch(url);
    return new URL(response.url).origin;
  } catch {
    return url;
  }
}

async function updateCollection(collection, arango) {
  const dbCollection = arango.collection(collection.name);
  const existingIndexes = await dbCollection.indexes();

  for (const existing of existingIndexes) {
    if (!collection.indexes.find(x => sameFields(x.fields, existing.fields))) {
      console.log(`${collection.name}: remove index [${existing.id}] on [${existing.fields.join(',')}]`);
      await dbCollection.dropIndex(existing.id);
    }
  }

  for (const required of collection.indexes) {
    if (!existingIndexes.find(x => sameFields(x.fields, required.fields))) {
      console.log(`${collection.name}: create index on [${required.fields.join(',')}]`);
      let indexCreated = false;

      while (!indexCreated) {
        try {
          await dbCollection.createPersistentIndex(required.fields);
          indexCreated = true;
        } catch (error) {
          if (error.message.toLowerCase().indexOf('timeout') >= 0) {
            console.log(`Index creation failed: ${error.message}. Retrying...`);
          } else {
            throw error;
          }
        }
      }
    }
  }
}

async function updateDb(config) {
  const arango = new Database({
    url: await detectRedirect(config.server)
  });

  if (config.auth) {
    const [user, password] = config.auth.split(':');
    arango.useBasicAuth(user, password);
  }

  arango.useDatabase(config.name);

  for (const collection of [...Object.values(dataCollectionInfo)]) {
    await updateCollection(collection, arango);
  }

  await arango.close();
}

function update(servers, options) {
  (async () => {
    let hasErrors = false;

    for (const server of [].concat(servers)) {
      console.log(`Update ${server}`);

      try {
        await updateDb({
          server,
          name: 'blockchain',
          auth: options.auth
        });
      } catch (error) {
        console.error(error);
        hasErrors = true;
      }
    }

    process.exit(hasErrors ? 1 : 0);
  })();
}

program.arguments('[servers...]').option('-a, --auth <user:password>', 'user:password', '').action(update).parse(process.argv);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tYWludGFuYW5jZS9hcmFuZ28tdXBkYXRlL2luZGV4LmpzIl0sIm5hbWVzIjpbIkRhdGFiYXNlIiwicmVxdWlyZSIsImRhdGFDb2xsZWN0aW9uSW5mbyIsInByb2dyYW0iLCJmZXRjaCIsInNhbWVGaWVsZHMiLCJhIiwiYiIsImpvaW4iLCJ0b0xvd2VyQ2FzZSIsImRldGVjdFJlZGlyZWN0IiwidXJsIiwicmVzcG9uc2UiLCJVUkwiLCJvcmlnaW4iLCJ1cGRhdGVDb2xsZWN0aW9uIiwiY29sbGVjdGlvbiIsImFyYW5nbyIsImRiQ29sbGVjdGlvbiIsIm5hbWUiLCJleGlzdGluZ0luZGV4ZXMiLCJpbmRleGVzIiwiZXhpc3RpbmciLCJmaW5kIiwieCIsImZpZWxkcyIsImNvbnNvbGUiLCJsb2ciLCJpZCIsImRyb3BJbmRleCIsInJlcXVpcmVkIiwiaW5kZXhDcmVhdGVkIiwiY3JlYXRlUGVyc2lzdGVudEluZGV4IiwiZXJyb3IiLCJtZXNzYWdlIiwiaW5kZXhPZiIsInVwZGF0ZURiIiwiY29uZmlnIiwic2VydmVyIiwiYXV0aCIsInVzZXIiLCJwYXNzd29yZCIsInNwbGl0IiwidXNlQmFzaWNBdXRoIiwidXNlRGF0YWJhc2UiLCJPYmplY3QiLCJ2YWx1ZXMiLCJjbG9zZSIsInVwZGF0ZSIsInNlcnZlcnMiLCJvcHRpb25zIiwiaGFzRXJyb3JzIiwiY29uY2F0IiwicHJvY2VzcyIsImV4aXQiLCJhcmd1bWVudHMiLCJvcHRpb24iLCJhY3Rpb24iLCJwYXJzZSIsImFyZ3YiXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQWVDLE9BQU8sQ0FBQyxVQUFELENBQTVCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUF5QkQsT0FBTyxDQUFDLGlDQUFELENBQXRDOztBQUNBLE1BQU1FLE9BQU8sR0FBR0YsT0FBTyxDQUFDLFdBQUQsQ0FBdkI7O0FBQ0EsTUFBTUcsS0FBSyxHQUFHSCxPQUFPLENBQUMs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Q2UsY0FEZixFQUVLQyxNQUZMLENBRVksNEJBRlosRUFFMEMsZUFGMUMsRUFFMkQsRUFGM0QsRUFHS0MsTUFITCxDQUdZVCxNQUhaLEVBSUtVLEtBSkwsQ0FJV0wsT0FBTyxDQUFDTSxJQUpuQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgRGF0YWJhc2UgfSA9IHJlcXVpcmUoJ2FyYW5nb2pzJyk7XG5jb25zdCB7IGRhdGFDb2xsZWN0aW9uSW5mbyB9ID0gcmVxdWlyZSgnLi4vLi4vc2VydmVyL2RhdGEvZGF0YS1wcm92aWRlcicpO1xuY29uc3QgcHJvZ3JhbSA9IHJlcXVpcmUoJ2NvbW1hbmRlcicpO1xuY29uc3QgZmV0Y2ggPSByZXF1aXJlKCdub2RlLWZldGNoJyk7XG5cbmZ1bmN0aW9uIHNhbWVGaWVsZHMoYSwgYikge1xuICAgIHJldHVybiBhLmpvaW4oJywnKS50b0xvd2VyQ2FzZSgpID09PSBiLmpvaW4oJywnKS50b0xvd2VyQ2FzZSgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkZXRlY3RSZWRpcmVjdCh1cmwpIHtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCk7XG4gICAgICAgIHJldHVybiBuZXcgVVJMKHJlc3BvbnNlLnVybCkub3JpZ2luO1xuICAgIH0gY2F0Y2gge1xuICAgICAgICByZXR1cm4gdXJsO1xuICAgIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlQ29sbGVjdGlvbihjb2xsZWN0aW9uLCBhcmFuZ28pIHtcbiAgICBjb25zdCBkYkNvbGxlY3Rpb24gPSBhcmFuZ28uY29sbGVjdGlvbihjb2xsZWN0aW9uLm5hbWUpO1xuICAgIGNvbnN0IGV4aXN0aW5nSW5kZXhlcyA9IGF3YWl0IGRiQ29sbGVjdGlvbi5pbmRleGVzKCk7XG4gICAgZm9yIChjb25zdCBleGlzdGluZyBvZiBleGlzdGluZ0luZGV4ZXMpIHtcbiAgICAgICAgaWYgKCFjb2xsZWN0aW9uLmluZGV4ZXMuZmluZCh4ID0+IHNhbWVGaWVsZHMoeC5maWVsZHMsIGV4aXN0aW5nLmZpZWxkcykpKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgJHtjb2xsZWN0aW9uLm5hbWV9OiByZW1vdmUgaW5kZXggWyR7ZXhpc3RpbmcuaWR9XSBvbiBbJHtleGlzdGluZy5maWVsZHMuam9pbignLCcpfV1gKTtcbiAgICAgICAgICAgIGF3YWl0IGRiQ29sbGVjdGlvbi5kcm9wSW5kZXgoZXhpc3RpbmcuaWQpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAoY29uc3QgcmVxdWlyZWQgb2YgY29sbGVjdGlvbi5pbmRleGVzKSB7XG4gICAgICAgIGlmICghZXhpc3RpbmdJbmRleGVzLmZpbmQoeCA9PiBzYW1lRmllbGRzKHguZmllbGRzLCByZXF1aXJlZC5maWVsZHMpKSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYCR7Y29sbGVjdGlvbi5uYW1lfTogY3JlYXRlIGluZGV4IG9uIFske3JlcXVpcmVkLmZpZWxkcy5qb2luKCcsJyl9XWApO1xuICAgICAgICAgICAgbGV0IGluZGV4Q3JlYXRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgd2hpbGUgKCFpbmRleENyZWF0ZWQpIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBkYkNvbGxlY3Rpb24uY3JlYXRlUGVyc2lzdGVudEluZGV4KHJlcXVpcmVkLmZpZWxkcyk7XG4gICAgICAgICAgICAgICAgICAgIGluZGV4Q3JlYXRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSBjYXRjaChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IubWVzc2FnZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJ3RpbWVvdXQnKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgSW5kZXggY3JlYXRpb24gZmFpbGVkOiAke2Vycm9yLm1lc3NhZ2V9LiBSZXRyeWluZy4uLmApO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZURiKGNvbmZpZykge1xuICAgIGNvbnN0IGFyYW5nbyA9IG5ldyBEYXRhYmFzZSh7XG4gICAgICAgIHVybDogYXdhaXQgZGV0ZWN0UmVkaXJlY3QoY29uZmlnLnNlcnZlciksXG5cbiAgICB9KTtcbiAgICBpZiAoY29uZmlnLmF1dGgpIHtcbiAgICAgICAgY29uc3QgW3VzZXIsIHBhc3N3b3JkXSA9IGNvbmZpZy5hdXRoLnNwbGl0KCc6Jyk7XG4gICAgICAgIGFyYW5nby51c2VCYXNpY0F1dGgodXNlciwgcGFzc3dvcmQpO1xuICAgIH1cbiAgICBhcmFuZ28udXNlRGF0YWJhc2UoY29uZmlnLm5hbWUpO1xuICAgIGZvciAoY29uc3QgY29sbGVjdGlvbiBvZiBbLi4uT2JqZWN0LnZhbHVlcyhkYXRhQ29sbGVjdGlvbkluZm8pXSkge1xuICAgICAgICBhd2FpdCB1cGRhdGVDb2xsZWN0aW9uKGNvbGxlY3Rpb24sIGFyYW5nbyk7XG4gICAgfVxuICAgIGF3YWl0IGFyYW5nby5jbG9zZSgpO1xufVxuXG5mdW5jdGlvbiB1cGRhdGUoc2VydmVycywgb3B0aW9ucykge1xuICAgIChhc3luYyAoKSA9PiB7XG4gICAgICAgIGxldCBoYXNFcnJvcnMgPSBmYWxzZTtcbiAgICAgICAgZm9yIChjb25zdCBzZXJ2ZXIgb2YgW10uY29uY2F0KHNlcnZlcnMpKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgVXBkYXRlICR7c2VydmVyfWApO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBhd2FpdCB1cGRhdGVEYih7XG4gICAgICAgICAgICAgICAgICAgIHNlcnZlcixcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogJ2Jsb2NrY2hhaW4nLFxuICAgICAgICAgICAgICAgICAgICBhdXRoOiBvcHRpb25zLmF1dGgsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgIGhhc0Vycm9ycyA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcHJvY2Vzcy5leGl0KGhhc0Vycm9ycyA/IDEgOiAwKTtcbiAgICB9KSgpO1xufVxuXG5wcm9ncmFtXG4gICAgLmFyZ3VtZW50cygnW3NlcnZlcnMuLi5dJylcbiAgICAub3B0aW9uKCctYSwgLS1hdXRoIDx1c2VyOnBhc3N3b3JkPicsICd1c2VyOnBhc3N3b3JkJywgJycpXG4gICAgLmFjdGlvbih1cGRhdGUpXG4gICAgLnBhcnNlKHByb2Nlc3MuYXJndik7XG5cblxuXG4iXX0=