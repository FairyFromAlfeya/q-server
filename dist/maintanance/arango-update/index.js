"use strict";

const {
  Database
} = require('arangojs');

const {
  BLOCKCHAIN_DB
} = require('../../server/config');

const program = require('commander');

const fetch = require('node-fetch');

function sameFields(a, b) {
  return a.join(',').toLowerCase() === b.join(',').toLowerCase();
}

async function detectRedirect(url) {
  try {
    const response = await fetch(url);
    return new URL(response.url).origin;
  } catch {
    return url;
  }
}

async function updateCollection(collection, arango) {
  const dbCollection = arango.collection(collection.name);
  const existingIndexes = await dbCollection.indexes();

  for (const existing of existingIndexes) {
    if (!collection.indexes.find(x => sameFields(x.fields, existing.fields))) {
      console.log(`${collection.name}: remove index [${existing.id}] on [${existing.fields.join(',')}]`);
      await dbCollection.dropIndex(existing.id);
    }
  }

  for (const required of collection.indexes) {
    if (!existingIndexes.find(x => sameFields(x.fields, required.fields))) {
      console.log(`${collection.name}: create index on [${required.fields.join(',')}]`);
      let indexCreated = false;

      while (!indexCreated) {
        try {
          await dbCollection.createPersistentIndex(required.fields);
          indexCreated = true;
        } catch (error) {
          if (error.message.toLowerCase().indexOf('timeout') >= 0) {
            console.log(`Index creation failed: ${error.message}. Retrying...`);
          } else {
            throw error;
          }
        }
      }
    }
  }
}

async function updateDb(config) {
  const arango = new Database({
    url: await detectRedirect(config.server)
  });

  if (config.auth) {
    const [user, password] = config.auth.split(':');
    arango.useBasicAuth(user, password);
  }

  arango.useDatabase(config.name);

  for (const collection of [...Object.values(BLOCKCHAIN_DB.collections)]) {
    await updateCollection(collection, arango);
  }

  await arango.close();
}

function update(servers, options) {
  (async () => {
    let hasErrors = false;

    for (const server of [].concat(servers)) {
      console.log(`Update ${server}`);

      try {
        await updateDb({
          server,
          name: BLOCKCHAIN_DB.name,
          auth: options.auth
        });
      } catch (error) {
        console.error(error.message);
        hasErrors = true;
      }
    }

    process.exit(hasErrors ? 1 : 0);
  })();
}

program.arguments('[servers...]').option('-a, --auth <user:password>', 'user:password', '').action(update).parse(process.argv);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tYWludGFuYW5jZS9hcmFuZ28tdXBkYXRlL2luZGV4LmpzIl0sIm5hbWVzIjpbIkRhdGFiYXNlIiwicmVxdWlyZSIsIkJMT0NLQ0hBSU5fREIiLCJwcm9ncmFtIiwiZmV0Y2giLCJzYW1lRmllbGRzIiwiYSIsImIiLCJqb2luIiwidG9Mb3dlckNhc2UiLCJkZXRlY3RSZWRpcmVjdCIsInVybCIsInJlc3BvbnNlIiwiVVJMIiwib3JpZ2luIiwidXBkYXRlQ29sbGVjdGlvbiIsImNvbGxlY3Rpb24iLCJhcmFuZ28iLCJkYkNvbGxlY3Rpb24iLCJuYW1lIiwiZXhpc3RpbmdJbmRleGVzIiwiaW5kZXhlcyIsImV4aXN0aW5nIiwiZmluZCIsIngiLCJmaWVsZHMiLCJjb25zb2xlIiwibG9nIiwiaWQiLCJkcm9wSW5kZXgiLCJyZXF1aXJlZCIsImluZGV4Q3JlYXRlZCIsImNyZWF0ZVBlcnNpc3RlbnRJbmRleCIsImVycm9yIiwibWVzc2FnZSIsImluZGV4T2YiLCJ1cGRhdGVEYiIsImNvbmZpZyIsInNlcnZlciIsImF1dGgiLCJ1c2VyIiwicGFzc3dvcmQiLCJzcGxpdCIsInVzZUJhc2ljQXV0aCIsInVzZURhdGFiYXNlIiwiT2JqZWN0IiwidmFsdWVzIiwiY29sbGVjdGlvbnMiLCJjbG9zZSIsInVwZGF0ZSIsInNlcnZlcnMiLCJvcHRpb25zIiwiaGFzRXJyb3JzIiwiY29uY2F0IiwicHJvY2VzcyIsImV4aXQiLCJhcmd1bWVudHMiLCJvcHRpb24iLCJhY3Rpb24iLCJwYXJzZSIsImFyZ3YiXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQWVDLE9BQU8sQ0FBQyxVQUFELENBQTVCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFvQkQsT0FBTyxDQUFDLHFCQUFELENBQWpDOztBQUNBLE1BQU1FLE9BQU8sR0FBR0YsT0FBTyxDQUFDLFdBQUQsQ0FBdkI7O0FBQ0EsTUFBTUcsS0FBSyxHQUFHSCxP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QTdCO0FBQ0gsR0FoQkQ7QUFpQkg7O0FBRURqRCxPQUFPLENBQ0ZxRCxTQURMLENBQ2UsY0FEZixFQUVLQyxNQUZMLENBRVksNEJBRlosRUFFMEMsZUFGMUMsRUFFMkQsRUFGM0QsRUFHS0MsTUFITCxDQUdZVCxNQUhaLEVBSUtVLEtBSkwsQ0FJV0wsT0FBTyxDQUFDTSxJQUpuQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgRGF0YWJhc2UgfSA9IHJlcXVpcmUoJ2FyYW5nb2pzJyk7XG5jb25zdCB7IEJMT0NLQ0hBSU5fREIgfSA9IHJlcXVpcmUoJy4uLy4uL3NlcnZlci9jb25maWcnKTtcbmNvbnN0IHByb2dyYW0gPSByZXF1aXJlKCdjb21tYW5kZXInKTtcbmNvbnN0IGZldGNoID0gcmVxdWlyZSgnbm9kZS1mZXRjaCcpO1xuXG5mdW5jdGlvbiBzYW1lRmllbGRzKGEsIGIpIHtcbiAgICByZXR1cm4gYS5qb2luKCcsJykudG9Mb3dlckNhc2UoKSA9PT0gYi5qb2luKCcsJykudG9Mb3dlckNhc2UoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZGV0ZWN0UmVkaXJlY3QodXJsKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwpO1xuICAgICAgICByZXR1cm4gbmV3IFVSTChyZXNwb25zZS51cmwpLm9yaWdpbjtcbiAgICB9IGNhdGNoIHtcbiAgICAgICAgcmV0dXJuIHVybDtcbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUNvbGxlY3Rpb24oY29sbGVjdGlvbiwgYXJhbmdvKSB7XG4gICAgY29uc3QgZGJDb2xsZWN0aW9uID0gYXJhbmdvLmNvbGxlY3Rpb24oY29sbGVjdGlvbi5uYW1lKTtcbiAgICBjb25zdCBleGlzdGluZ0luZGV4ZXMgPSBhd2FpdCBkYkNvbGxlY3Rpb24uaW5kZXhlcygpO1xuICAgIGZvciAoY29uc3QgZXhpc3Rpbmcgb2YgZXhpc3RpbmdJbmRleGVzKSB7XG4gICAgICAgIGlmICghY29sbGVjdGlvbi5pbmRleGVzLmZpbmQoeCA9PiBzYW1lRmllbGRzKHguZmllbGRzLCBleGlzdGluZy5maWVsZHMpKSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYCR7Y29sbGVjdGlvbi5uYW1lfTogcmVtb3ZlIGluZGV4IFske2V4aXN0aW5nLmlkfV0gb24gWyR7ZXhpc3RpbmcuZmllbGRzLmpvaW4oJywnKX1dYCk7XG4gICAgICAgICAgICBhd2FpdCBkYkNvbGxlY3Rpb24uZHJvcEluZGV4KGV4aXN0aW5nLmlkKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGNvbnN0IHJlcXVpcmVkIG9mIGNvbGxlY3Rpb24uaW5kZXhlcykge1xuICAgICAgICBpZiAoIWV4aXN0aW5nSW5kZXhlcy5maW5kKHggPT4gc2FtZUZpZWxkcyh4LmZpZWxkcywgcmVxdWlyZWQuZmllbGRzKSkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke2NvbGxlY3Rpb24ubmFtZX06IGNyZWF0ZSBpbmRleCBvbiBbJHtyZXF1aXJlZC5maWVsZHMuam9pbignLCcpfV1gKTtcbiAgICAgICAgICAgIGxldCBpbmRleENyZWF0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHdoaWxlICghaW5kZXhDcmVhdGVkKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgZGJDb2xsZWN0aW9uLmNyZWF0ZVBlcnNpc3RlbnRJbmRleChyZXF1aXJlZC5maWVsZHMpO1xuICAgICAgICAgICAgICAgICAgICBpbmRleENyZWF0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2goZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UudG9Mb3dlckNhc2UoKS5pbmRleE9mKCd0aW1lb3V0JykgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYEluZGV4IGNyZWF0aW9uIGZhaWxlZDogJHtlcnJvci5tZXNzYWdlfS4gUmV0cnlpbmcuLi5gKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVEYihjb25maWcpIHtcbiAgICBjb25zdCBhcmFuZ28gPSBuZXcgRGF0YWJhc2Uoe1xuICAgICAgICB1cmw6IGF3YWl0IGRldGVjdFJlZGlyZWN0KGNvbmZpZy5zZXJ2ZXIpLFxuXG4gICAgfSk7XG4gICAgaWYgKGNvbmZpZy5hdXRoKSB7XG4gICAgICAgIGNvbnN0IFt1c2VyLCBwYXNzd29yZF0gPSBjb25maWcuYXV0aC5zcGxpdCgnOicpO1xuICAgICAgICBhcmFuZ28udXNlQmFzaWNBdXRoKHVzZXIsIHBhc3N3b3JkKTtcbiAgICB9XG4gICAgYXJhbmdvLnVzZURhdGFiYXNlKGNvbmZpZy5uYW1lKTtcbiAgICBmb3IgKGNvbnN0IGNvbGxlY3Rpb24gb2YgWy4uLk9iamVjdC52YWx1ZXMoQkxPQ0tDSEFJTl9EQi5jb2xsZWN0aW9ucyldKSB7XG4gICAgICAgIGF3YWl0IHVwZGF0ZUNvbGxlY3Rpb24oY29sbGVjdGlvbiwgYXJhbmdvKTtcbiAgICB9XG4gICAgYXdhaXQgYXJhbmdvLmNsb3NlKCk7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZShzZXJ2ZXJzLCBvcHRpb25zKSB7XG4gICAgKGFzeW5jICgpID0+IHtcbiAgICAgICAgbGV0IGhhc0Vycm9ycyA9IGZhbHNlO1xuICAgICAgICBmb3IgKGNvbnN0IHNlcnZlciBvZiBbXS5jb25jYXQoc2VydmVycykpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBVcGRhdGUgJHtzZXJ2ZXJ9YCk7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHVwZGF0ZURiKHtcbiAgICAgICAgICAgICAgICAgICAgc2VydmVyLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBCTE9DS0NIQUlOX0RCLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGF1dGg6IG9wdGlvbnMuYXV0aCxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvci5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICBoYXNFcnJvcnMgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHByb2Nlc3MuZXhpdChoYXNFcnJvcnMgPyAxIDogMCk7XG4gICAgfSkoKTtcbn1cblxucHJvZ3JhbVxuICAgIC5hcmd1bWVudHMoJ1tzZXJ2ZXJzLi4uXScpXG4gICAgLm9wdGlvbignLWEsIC0tYXV0aCA8dXNlcjpwYXNzd29yZD4nLCAndXNlcjpwYXNzd29yZCcsICcnKVxuICAgIC5hY3Rpb24odXBkYXRlKVxuICAgIC5wYXJzZShwcm9jZXNzLmFyZ3YpO1xuXG5cblxuIl19